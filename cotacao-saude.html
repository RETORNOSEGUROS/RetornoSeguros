<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cota√ß√£o Plano de Sa√∫de Empresarial | Retorno Seguros</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- SheetJS para ler Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --secondary: #ef4444;
            --accent: #f97316;
            --dark-bg: #1a1a2e;
            --light-bg: #fef2f2;
            --white: #ffffff;
            --text-dark: #1a2b3c;
            --text-light: #5a6b7c;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            --shadow: 0 4px 20px rgba(220, 38, 38, 0.15);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, var(--light-bg) 0%, #fee2e2 100%);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .header {
            background: var(--white);
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 700px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
        }

        .logo-text-container {
            display: flex;
            flex-direction: column;
        }

        .logo-text {
            font-weight: 800;
            font-size: 1.3rem;
            color: var(--text-dark);
        }

        .logo-sub {
            font-size: 0.7rem;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
        }

        .progress-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .progress-bar-wrapper {
            background: rgba(220, 38, 38, 0.15);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            height: 100%;
            border-radius: 10px;
            transition: width 0.4s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .main-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 0 1.5rem 3rem;
        }

        .step-card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem 1.5rem;
            box-shadow: var(--shadow);
            display: none;
            animation: slideIn 0.4s ease;
        }

        .step-card.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(249, 115, 22, 0.1));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 1.5rem;
        }

        .step-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .step-subtitle {
            text-align: center;
            font-size: 0.95rem;
            color: var(--text-light);
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1);
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-light);
            border: 2px solid #e2e8f0;
            margin-top: 0.75rem;
        }

        .btn-secondary:hover {
            background: var(--light-bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Options Grid */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .options-grid.single {
            grid-template-columns: 1fr;
        }

        .option-card {
            background: var(--light-bg);
            border: 2px solid transparent;
            border-radius: 14px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .option-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .option-card.selected {
            border-color: var(--primary);
            background: rgba(220, 38, 38, 0.1);
        }

        .option-card .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .option-card .title {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .option-card .subtitle {
            font-size: 0.8rem;
            color: var(--text-light);
            line-height: 1.4;
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            border: 2px solid var(--info);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-box .header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            background: transparent;
            padding: 0;
            box-shadow: none;
            position: static;
        }

        .info-box .header span {
            font-weight: 700;
            color: var(--info);
        }

        .info-box p {
            font-size: 0.85rem;
            color: var(--text-dark);
            line-height: 1.5;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 14px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(220, 38, 38, 0.02);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(220, 38, 38, 0.05);
        }

        .upload-area .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-area .text {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .upload-area .subtext {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .upload-area input {
            display: none;
        }

        /* Faixas Et√°rias */
        .faixas-container {
            margin-bottom: 1.5rem;
        }

        .faixas-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .faixa-item {
            text-align: center;
        }

        .faixa-label {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .faixa-input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
        }

        .faixa-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .total-vidas {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            color: white;
        }

        .total-vidas .label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .total-vidas .value {
            font-size: 2rem;
            font-weight: 800;
        }

        /* Tabela de Vidas */
        .vidas-table-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .vidas-table {
            width: 100%;
            border-collapse: collapse;
        }

        .vidas-table th {
            background: var(--light-bg);
            padding: 0.75rem;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-dark);
            position: sticky;
            top: 0;
        }

        .vidas-table td {
            padding: 0.75rem;
            border-top: 1px solid #e2e8f0;
            font-size: 0.85rem;
        }

        .vidas-table .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .vidas-table input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .badge-socio {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Benef√≠cios */
        .beneficios-grid {
            display: grid;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .beneficio-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--light-bg);
            border-radius: 12px;
        }

        .beneficio-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .beneficio-content {
            flex: 1;
        }

        .beneficio-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .beneficio-desc {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* Comparativo */
        .comparativo {
            background: var(--light-bg);
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .comparativo-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        .comparativo-col {
            padding: 1rem;
            text-align: center;
        }

        .comparativo-col.destacado {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .comparativo-col .title {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .comparativo-col .items {
            font-size: 0.8rem;
            line-height: 1.6;
        }

        .comparativo-col .items div {
            padding: 0.25rem 0;
        }

        /* Loading */
        .loading-container {
            text-align: center;
            padding: 2rem 0;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(220, 38, 38, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            color: var(--text-dark);
            font-weight: 600;
        }

        .loading-subtext {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        /* Summary Card */
        .summary-card {
            background: linear-gradient(135deg, var(--primary), #991b1b);
            border-radius: 20px;
            padding: 2rem;
            color: white;
            margin-bottom: 1.5rem;
        }

        .summary-card .title {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .summary-card .vidas {
            font-size: 3rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 0.25rem;
        }

        .summary-card .vidas-label {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 1.5rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .summary-item {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 0.75rem;
            text-align: center;
        }

        .summary-item .label {
            font-size: 0.75rem;
            opacity: 0.85;
            margin-bottom: 0.25rem;
        }

        .summary-item .value {
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* WhatsApp Button */
        .whatsapp-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            padding: 1.25rem;
            background: #25D366;
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            margin-bottom: 0.75rem;
        }

        .whatsapp-btn:hover {
            background: #20bd5a;
            transform: translateY(-2px);
        }

        .whatsapp-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Tip Box */
        .tip-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border: 2px solid var(--success);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .tip-box .tip-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .tip-box .tip-header span {
            font-weight: 700;
            color: var(--success);
        }

        .tip-box p {
            font-size: 0.85rem;
            color: var(--text-dark);
            line-height: 1.5;
        }

        /* Footer */
        .footer-note {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e2e8f0;
        }

        /* File Info */
        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success);
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .file-info .icon {
            font-size: 2rem;
        }

        .file-info .details {
            flex: 1;
        }

        .file-info .name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .file-info .meta {
            font-size: 0.8rem;
            color: var(--success);
        }

        .file-info .remove {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1.2rem;
        }

        @media (max-width: 600px) {
            .faixas-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <div class="logo-icon">üè•</div>
                <div class="logo-text-container">
                    <span class="logo-text">Retorno</span>
                    <span class="logo-sub">Plano de Sa√∫de Empresarial</span>
                </div>
            </a>
        </div>
    </header>

    <div class="progress-container">
        <div class="progress-bar-wrapper">
            <div class="progress-bar-fill" id="progressBar" style="width: 10%"></div>
        </div>
        <div class="progress-text" id="progressText">Etapa 1 de 10</div>
    </div>

    <main class="main-container">
        <!-- Step 1: Nome da Empresa -->
        <div class="step-card active" id="step1">
            <div class="step-icon">üè¢</div>
            <h2 class="step-title">Vamos come√ßar!</h2>
            <p class="step-subtitle">Qual o nome da empresa que deseja cotar o plano de sa√∫de?</p>
            
            <div class="form-group">
                <label class="form-label">Nome da empresa</label>
                <input type="text" class="form-input" id="nomeEmpresa" placeholder="Raz√£o social ou nome fantasia">
            </div>
            
            <button class="btn btn-primary" onclick="nextStep(1)">Continuar ‚Üí</button>
        </div>

        <!-- Step 2: Como informar as vidas -->
        <div class="step-card" id="step2">
            <div class="step-icon">üë•</div>
            <h2 class="step-title">Informa√ß√µes dos Benefici√°rios</h2>
            <p class="step-subtitle">O plano de sa√∫de √© calculado por faixa et√°ria. Como prefere informar os dados?</p>
            
            <div class="options-grid">
                <div class="option-card" onclick="selectMetodoVidas('manual')">
                    <div class="icon">‚úèÔ∏è</div>
                    <div class="title">Informar Manualmente</div>
                    <div class="subtitle">Insira a quantidade de pessoas em cada faixa et√°ria</div>
                </div>
                <div class="option-card" onclick="selectMetodoVidas('planilha')">
                    <div class="icon">üìä</div>
                    <div class="title">Subir Planilha</div>
                    <div class="subtitle">Upload de Excel com datas de nascimento</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="nextStep(2)" id="btnStep2" disabled>Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(2)">‚Üê Voltar</button>
        </div>

        <!-- Step 3A: Faixas Manuais -->
        <div class="step-card" id="step3a">
            <div class="step-icon">üìä</div>
            <h2 class="step-title">Quantidade por Faixa Et√°ria</h2>
            <p class="step-subtitle">Informe quantas pessoas h√° em cada faixa et√°ria.</p>
            
            <div class="faixas-container">
                <div class="faixas-grid">
                    <div class="faixa-item">
                        <div class="faixa-label">0 a 18</div>
                        <input type="number" class="faixa-input" id="faixa0" min="0" value="0" onchange="calcularTotalVidas()">
                    </div>
                    <div class="faixa-item">
                        <div class="faixa-label">19 a 23</div>
                        <input type="number" class="faixa-input" id="faixa1" min="0" value="0" onchange="calcularTotalVidas()">
                    </div>
                    <div class="faixa-item">
                        <div class="faixa-label">24 a 28</div>
                        <input type="number" class="faixa-input" id="faixa2" min="0" value="0" onchange="calcularTotalVidas()">
                    </div>
                    <div class="faixa-item">
                        <div class="faixa-label">29 a 33</div>
                        <input type="number" class="faixa-input" id="faixa3" min="0" value="0" onchange="calcularTotalVidas()">
                    </div>
                    <div class="faixa-item">
                        <div class="faixa-label">34 a 38</div>
                        <input type="number" class="faixa-input" id="faixa4" min="0" value="0" onchange="calcularTotalVidas()">
                    </div>
                </div>
                <div class="faixas-grid">
                    <div class="faixa-item">
                        <div class="faixa-label">39 a 43</div>
                        <input type="number" class="faixa-input" id="faixa5" min="0" value="0" onchange="calcularTotalVidas()">
                    </div>
                    <div class="faixa-item">
                        <div class="faixa-label">44 a 48</div>
                        <input type="number" class="faixa-input" id="faixa6" min="0" value="0" onchange="calcularTotalVidas()">
                    </div>
                    <div class="faixa-item">
                        <div class="faixa-label">49 a 53</div>
                        <input type="number" class="faixa-input" id="faixa7" min="0" value="0" onchange="calcularTotalVidas()">
                    </div>
                    <div class="faixa-item">
                        <div class="faixa-label">54 a 58</div>
                        <input type="number" class="faixa-input" id="faixa8" min="0" value="0" onchange="calcularTotalVidas()">
                    </div>
                    <div class="faixa-item">
                        <div class="faixa-label">59+</div>
                        <input type="number" class="faixa-input" id="faixa9" min="0" value="0" onchange="calcularTotalVidas()">
                    </div>
                </div>
                
                <div class="total-vidas">
                    <div class="label">Total de Vidas</div>
                    <div class="value" id="totalVidasManual">0</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="nextStep('3a')" id="btnStep3a">Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep('3a')">‚Üê Voltar</button>
        </div>

        <!-- Step 3B: Upload Planilha -->
        <div class="step-card" id="step3b">
            <div class="step-icon">üì§</div>
            <h2 class="step-title">Upload da Planilha</h2>
            <p class="step-subtitle">Fa√ßa upload de um arquivo Excel com as datas de nascimento dos benefici√°rios.</p>
            
            <div class="info-box">
                <div class="header">
                    <span>üí°</span>
                    <span>Dica</span>
                </div>
                <p>A planilha deve conter uma coluna com as <strong>datas de nascimento</strong>. Opcionalmente pode ter colunas de <strong>nome</strong> e <strong>cargo</strong> para identificar s√≥cios e diretores.</p>
            </div>
            
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="icon">üìÅ</div>
                <div class="text">Clique ou arraste o arquivo aqui</div>
                <div class="subtext">Excel (.xlsx, .xls) ou CSV</div>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
            </div>
            
            <div class="file-info" id="fileInfo" style="display: none;">
                <div class="icon">‚úÖ</div>
                <div class="details">
                    <div class="name" id="fileName">arquivo.xlsx</div>
                    <div class="meta" id="fileMeta">10 pessoas identificadas</div>
                </div>
                <button class="remove" onclick="removeFile()">‚úï</button>
            </div>
            
            <div class="divider">ou</div>
            
            <a href="#" class="btn btn-secondary" style="text-align: center; display: block; text-decoration: none;" onclick="baixarModelo()">
                üì• Baixar modelo de planilha
            </a>
            
            <button class="btn btn-primary" onclick="nextStep('3b')" id="btnStep3b" disabled style="margin-top: 1rem;">Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep('3b')">‚Üê Voltar</button>
        </div>

        <!-- Step 4: S√≥cios/Diretores (se tiver planilha com nomes) -->
        <div class="step-card" id="step4">
            <div class="step-icon">‚≠ê</div>
            <h2 class="step-title">Plano Diferenciado para S√≥cios?</h2>
            <p class="step-subtitle">S√≥cios e diretores podem ter um plano com benef√≠cios superiores.</p>
            
            <div class="comparativo">
                <div class="comparativo-header">
                    <div class="comparativo-col">
                        <div class="title">Plano Funcion√°rios</div>
                        <div class="items">
                            <div>‚úì Rede credenciada regional</div>
                            <div>‚úì Quarto coletivo</div>
                            <div>‚úì Reembolso padr√£o</div>
                        </div>
                    </div>
                    <div class="comparativo-col destacado">
                        <div class="title">Plano Executivo</div>
                        <div class="items">
                            <div>‚úì Hospitais de ponta</div>
                            <div>‚úì Albert Einstein, S√≠rio-Liban√™s</div>
                            <div>‚úì Quarto privativo</div>
                            <div>‚úì Reembolso diferenciado</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="options-grid">
                <div class="option-card" onclick="selectPlanoDiferenciado('nao')">
                    <div class="icon">üë•</div>
                    <div class="title">Mesmo plano para todos</div>
                    <div class="subtitle">Todos os colaboradores ter√£o o mesmo plano</div>
                </div>
                <div class="option-card" onclick="selectPlanoDiferenciado('sim')">
                    <div class="icon">‚≠ê</div>
                    <div class="title">Plano diferenciado</div>
                    <div class="subtitle">S√≥cios e diretores com plano executivo</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="nextStep(4)" id="btnStep4" disabled>Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(4)">‚Üê Voltar</button>
        </div>

        <!-- Step 4B: Marcar S√≥cios -->
        <div class="step-card" id="step4b">
            <div class="step-icon">‚úÖ</div>
            <h2 class="step-title">Quem s√£o os S√≥cios/Diretores?</h2>
            <p class="step-subtitle">Marque os benefici√°rios que ter√£o o plano executivo.</p>
            
            <div class="vidas-table-container">
                <table class="vidas-table">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">Exec.</th>
                            <th>Nome</th>
                            <th>Idade</th>
                            <th>Cargo</th>
                        </tr>
                    </thead>
                    <tbody id="vidasTableBody">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>
            </div>
            
            <div class="total-vidas" style="margin-top: 1rem;">
                <div class="label">S√≥cios/Diretores selecionados</div>
                <div class="value" id="totalSocios">0</div>
            </div>
            
            <button class="btn btn-primary" onclick="nextStep('4b')">Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep('4b')">‚Üê Voltar</button>
        </div>

        <!-- Step 5: Acomoda√ß√£o -->
        <div class="step-card" id="step5">
            <div class="step-icon">üõèÔ∏è</div>
            <h2 class="step-title">Tipo de Acomoda√ß√£o</h2>
            <p class="step-subtitle">Em caso de interna√ß√£o, qual tipo de acomoda√ß√£o prefere?</p>
            
            <div class="options-grid">
                <div class="option-card" onclick="selectAcomodacao('enfermaria')">
                    <div class="icon">üè•</div>
                    <div class="title">Enfermaria</div>
                    <div class="subtitle">Quarto compartilhado com outros pacientes. Op√ß√£o mais econ√¥mica.</div>
                </div>
                <div class="option-card" onclick="selectAcomodacao('apartamento')">
                    <div class="icon">üõéÔ∏è</div>
                    <div class="title">Apartamento</div>
                    <div class="subtitle">Quarto privativo individual. Mais conforto e privacidade.</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="nextStep(5)" id="btnStep5" disabled>Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(5)">‚Üê Voltar</button>
        </div>

        <!-- Step 6: Cobertura -->
        <div class="step-card" id="step6">
            <div class="step-icon">üõ°Ô∏è</div>
            <h2 class="step-title">Tipo de Cobertura</h2>
            <p class="step-subtitle">Qual abrang√™ncia de cobertura deseja para o plano?</p>
            
            <div class="options-grid single">
                <div class="option-card" onclick="selectCobertura('completa')">
                    <div class="icon">‚úÖ</div>
                    <div class="title">Cobertura Completa (Recomendado)</div>
                    <div class="subtitle">
                        <strong>Ambulatorial + Hospitalar:</strong> Consultas, exames, pronto-socorro, interna√ß√µes, cirurgias e todos os procedimentos m√©dicos.
                    </div>
                </div>
                <div class="option-card" onclick="selectCobertura('hospitalar')">
                    <div class="icon">üè•</div>
                    <div class="title">Apenas Hospitalar</div>
                    <div class="subtitle">
                        <strong>S√≥ interna√ß√µes:</strong> Cobre apenas procedimentos com interna√ß√£o. Consultas e exames de rotina ficam por conta do benefici√°rio.
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="nextStep(6)" id="btnStep6" disabled>Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(6)">‚Üê Voltar</button>
        </div>

        <!-- Step 7: Coparticipa√ß√£o -->
        <div class="step-card" id="step7">
            <div class="step-icon">üí∞</div>
            <h2 class="step-title">Coparticipa√ß√£o</h2>
            <p class="step-subtitle">Deseja plano com coparticipa√ß√£o?</p>
            
            <div class="info-box">
                <div class="header">
                    <span>‚ÑπÔ∏è</span>
                    <span>O que √© coparticipa√ß√£o?</span>
                </div>
                <p>√â quando o benefici√°rio paga uma parte dos procedimentos realizados. Por exemplo: consulta custa R$ 30 para o plano, e o benefici√°rio paga R$ 15. <strong>Reduz o valor da mensalidade</strong>, mas gera custo adicional ao usar.</p>
            </div>
            
            <div class="options-grid">
                <div class="option-card" onclick="selectCoparticipacao('nao')">
                    <div class="icon">üíé</div>
                    <div class="title">Sem Coparticipa√ß√£o</div>
                    <div class="subtitle">Mensalidade fixa, sem custos extras ao usar o plano</div>
                </div>
                <div class="option-card" onclick="selectCoparticipacao('sim')">
                    <div class="icon">üíµ</div>
                    <div class="title">Com Coparticipa√ß√£o</div>
                    <div class="subtitle">Mensalidade menor, paga parte dos procedimentos</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="nextStep(7)" id="btnStep7" disabled>Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(7)">‚Üê Voltar</button>
        </div>

        <!-- Step 8: Quem Paga -->
        <div class="step-card" id="step8">
            <div class="step-icon">üí≥</div>
            <h2 class="step-title">Forma de Pagamento</h2>
            <p class="step-subtitle">Como ser√° o pagamento do plano?</p>
            
            <div class="options-grid">
                <div class="option-card" onclick="selectPagamento('empresa')">
                    <div class="icon">üè¢</div>
                    <div class="title">Empresa Paga Tudo</div>
                    <div class="subtitle">A empresa arca com 100% do custo do plano</div>
                </div>
                <div class="option-card" onclick="selectPagamento('funcionario')">
                    <div class="icon">üë§</div>
                    <div class="title">Desconto em Folha</div>
                    <div class="subtitle">Funcion√°rio paga total ou parcialmente via folha</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="nextStep(8)" id="btnStep8" disabled>Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(8)">‚Üê Voltar</button>
        </div>

        <!-- Step 9: Benef√≠cios e Loading -->
        <div class="step-card" id="step9">
            <div class="step-icon">üéÅ</div>
            <h2 class="step-title">Benef√≠cios Inclusos</h2>
            <p class="step-subtitle">Al√©m da cobertura m√©dica, seu plano inclui:</p>
            
            <div class="beneficios-grid">
                <div class="beneficio-item">
                    <div class="beneficio-icon">üë®‚Äç‚öïÔ∏è</div>
                    <div class="beneficio-content">
                        <div class="beneficio-title">Programa Meu Doutor</div>
                        <div class="beneficio-desc">Acompanhamento personalizado com equipe de sa√∫de</div>
                    </div>
                </div>
                <div class="beneficio-item">
                    <div class="beneficio-icon">üíä</div>
                    <div class="beneficio-content">
                        <div class="beneficio-title">Desconto Farm√°cia</div>
                        <div class="beneficio-desc">At√© 60% de desconto em medicamentos</div>
                    </div>
                </div>
                <div class="beneficio-item">
                    <div class="beneficio-icon">‚úàÔ∏è</div>
                    <div class="beneficio-content">
                        <div class="beneficio-title">Seguro Viagem</div>
                        <div class="beneficio-desc">Cobertura em viagens nacionais e internacionais</div>
                    </div>
                </div>
                <div class="beneficio-item">
                    <div class="beneficio-icon">üí∞</div>
                    <div class="beneficio-content">
                        <div class="beneficio-title">Reembolso</div>
                        <div class="beneficio-desc">Reembolso para consultas fora da rede credenciada</div>
                    </div>
                </div>
            </div>
            
            <div class="loading-container" id="loadingStep9">
                <div class="loading-spinner"></div>
                <div class="loading-text">Preparando sua cota√ß√£o...</div>
                <div class="loading-subtext">Analisando o melhor plano para sua empresa</div>
            </div>
        </div>

        <!-- Step 10: Resultado -->
        <div class="step-card" id="step10">
            <div class="step-icon">üéâ</div>
            <h2 class="step-title">Cota√ß√£o Registrada!</h2>
            <p class="step-subtitle">Recebemos suas informa√ß√µes. Um especialista entrar√° em contato.</p>
            
            <div class="summary-card">
                <div class="title">Resumo da Solicita√ß√£o</div>
                <div class="vidas" id="summaryVidas">0</div>
                <div class="vidas-label">vidas</div>
                
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">Acomoda√ß√£o</div>
                        <div class="value" id="summaryAcomodacao">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Cobertura</div>
                        <div class="value" id="summaryCobertura">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Coparticipa√ß√£o</div>
                        <div class="value" id="summaryCoparticipacao">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Plano Executivo</div>
                        <div class="value" id="summarySocios">-</div>
                    </div>
                </div>
            </div>
            
            <div class="tip-box">
                <div class="tip-header">
                    <span>üìã</span>
                    <span>Pr√≥ximos passos</span>
                </div>
                <p>Complete seus dados de contato para que nossa equipe entre em contato com as melhores op√ß√µes de planos e valores.</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">Seu nome</label>
                <input type="text" class="form-input" id="nome" placeholder="Nome do respons√°vel">
            </div>
            
            <div class="form-group">
                <label class="form-label">CNPJ da Empresa</label>
                <input type="text" class="form-input" id="cnpj" placeholder="00.000.000/0000-00" oninput="formatCNPJ(this)">
            </div>
            
            <div class="form-group">
                <label class="form-label">WhatsApp para contato</label>
                <input type="tel" class="form-input" id="whatsapp" placeholder="(00) 00000-0000" oninput="formatPhone(this)">
            </div>
            
            <button class="btn btn-primary" onclick="enviarCotacao()" id="btnEnviar">Solicitar Cota√ß√£o Detalhada</button>
            
            <a href="#" class="whatsapp-btn" id="whatsappLink" style="display: none;">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
                Falar com Especialista
            </a>
            
            <div class="footer-note">
                Ao continuar, voc√™ concorda com nossa pol√≠tica de privacidade.<br>
                Retorno Seguros - Especialistas em benef√≠cios empresariais
            </div>
        </div>
    </main>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:a59dc2c9edff29a66f5b2f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // State
        let currentStep = 1;
        const totalSteps = 10;
        let formData = {
            nomeEmpresa: '',
            metodoVidas: '',
            faixasEtarias: {},
            totalVidas: 0,
            vidas: [],
            planoDiferenciado: '',
            sociosSelecionados: [],
            acomodacao: '',
            cobertura: '',
            coparticipacao: '',
            formaPagamento: '',
            nome: '',
            cnpj: '',
            whatsapp: ''
        };

        // URL params (indica√ß√£o)
        const urlParams = new URLSearchParams(window.location.search);
        
        // C√≥digo de empresa parceira (?codigo= ou sessionStorage)
        let empresaParceiraCodigo = urlParams.get('codigo') || sessionStorage.getItem('parceiro_codigo') || '';
        if (empresaParceiraCodigo) {
            empresaParceiraCodigo = empresaParceiraCodigo.toUpperCase();
            console.log('ü§ù C√≥digo de parceiro:', empresaParceiraCodigo);
        }
        
        // C√≥digo de indica√ß√£o de cliente (?ref= ou sessionStorage)
        let indicadorCodigo = urlParams.get('ref') || sessionStorage.getItem('indicacao_codigo') || '';
        if (indicadorCodigo) {
            indicadorCodigo = indicadorCodigo.toUpperCase();
            console.log('üéÅ C√≥digo de indica√ß√£o:', indicadorCodigo);
        }
        
        const indicadorNome = urlParams.get('nome') || '';

        // Progress
        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `Etapa ${currentStep} de ${totalSteps}`;
        }

        // Show Step
        function showStep(step) {
            document.querySelectorAll('.step-card').forEach(card => card.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Next Step
        function nextStep(current) {
            if (current === 1) {
                const nomeEmpresa = document.getElementById('nomeEmpresa').value.trim();
                if (!nomeEmpresa) {
                    alert('Por favor, informe o nome da empresa.');
                    return;
                }
                formData.nomeEmpresa = nomeEmpresa;
                currentStep = 2;
                showStep(2);
            }
            else if (current === 2) {
                if (!formData.metodoVidas) {
                    alert('Por favor, selecione como deseja informar as vidas.');
                    return;
                }
                currentStep = 3;
                if (formData.metodoVidas === 'manual') {
                    showStep('3a');
                } else {
                    showStep('3b');
                }
            }
            else if (current === '3a') {
                const total = calcularTotalVidas();
                if (total < 3) {
                    alert('O plano empresarial requer no m√≠nimo 3 vidas.');
                    return;
                }
                formData.totalVidas = total;
                // Coletar faixas
                for (let i = 0; i <= 9; i++) {
                    const val = parseInt(document.getElementById(`faixa${i}`).value) || 0;
                    formData.faixasEtarias[`faixa${i}`] = val;
                }
                currentStep = 5; // Pula s√≥cios se for manual
                showStep(5);
            }
            else if (current === '3b') {
                if (formData.vidas.length < 3) {
                    alert('O plano empresarial requer no m√≠nimo 3 vidas.');
                    return;
                }
                formData.totalVidas = formData.vidas.length;
                currentStep = 4;
                showStep(4);
            }
            else if (current === 4) {
                if (!formData.planoDiferenciado) {
                    alert('Por favor, selecione uma op√ß√£o.');
                    return;
                }
                if (formData.planoDiferenciado === 'sim' && formData.vidas.length > 0) {
                    renderVidasTable();
                    currentStep = '4b';
                    showStep('4b');
                } else {
                    currentStep = 5;
                    showStep(5);
                }
            }
            else if (current === '4b') {
                // Coletar s√≥cios selecionados
                const checkboxes = document.querySelectorAll('#vidasTableBody input[type="checkbox"]:checked');
                formData.sociosSelecionados = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
                currentStep = 5;
                showStep(5);
            }
            else if (current === 5) {
                if (!formData.acomodacao) {
                    alert('Por favor, selecione o tipo de acomoda√ß√£o.');
                    return;
                }
                currentStep = 6;
                showStep(6);
            }
            else if (current === 6) {
                if (!formData.cobertura) {
                    alert('Por favor, selecione o tipo de cobertura.');
                    return;
                }
                currentStep = 7;
                showStep(7);
            }
            else if (current === 7) {
                if (!formData.coparticipacao) {
                    alert('Por favor, selecione uma op√ß√£o de coparticipa√ß√£o.');
                    return;
                }
                currentStep = 8;
                showStep(8);
            }
            else if (current === 8) {
                if (!formData.formaPagamento) {
                    alert('Por favor, selecione a forma de pagamento.');
                    return;
                }
                currentStep = 9;
                showStep(9);
                // Loading e ir para resultado
                setTimeout(() => {
                    preencherResumo();
                    currentStep = 10;
                    showStep(10);
                }, 5000);
            }
            
            updateProgress();
        }

        // Prev Step
        function prevStep(current) {
            if (current === 2) {
                currentStep = 1;
                showStep(1);
            }
            else if (current === '3a' || current === '3b') {
                currentStep = 2;
                showStep(2);
            }
            else if (current === 4) {
                currentStep = 3;
                if (formData.metodoVidas === 'manual') {
                    showStep('3a');
                } else {
                    showStep('3b');
                }
            }
            else if (current === '4b') {
                currentStep = 4;
                showStep(4);
            }
            else if (current === 5) {
                if (formData.metodoVidas === 'planilha') {
                    if (formData.planoDiferenciado === 'sim' && formData.vidas.length > 0) {
                        currentStep = '4b';
                        showStep('4b');
                    } else {
                        currentStep = 4;
                        showStep(4);
                    }
                } else {
                    currentStep = 3;
                    showStep('3a');
                }
            }
            else if (current === 6) {
                currentStep = 5;
                showStep(5);
            }
            else if (current === 7) {
                currentStep = 6;
                showStep(6);
            }
            else if (current === 8) {
                currentStep = 7;
                showStep(7);
            }
            
            updateProgress();
        }

        // Selects
        function selectMetodoVidas(metodo) {
            formData.metodoVidas = metodo;
            document.querySelectorAll('#step2 .option-card').forEach(c => c.classList.remove('selected'));
            event.target.closest('.option-card').classList.add('selected');
            document.getElementById('btnStep2').disabled = false;
        }

        function selectPlanoDiferenciado(opcao) {
            formData.planoDiferenciado = opcao;
            document.querySelectorAll('#step4 .option-card').forEach(c => c.classList.remove('selected'));
            event.target.closest('.option-card').classList.add('selected');
            document.getElementById('btnStep4').disabled = false;
        }

        function selectAcomodacao(tipo) {
            formData.acomodacao = tipo;
            document.querySelectorAll('#step5 .option-card').forEach(c => c.classList.remove('selected'));
            event.target.closest('.option-card').classList.add('selected');
            document.getElementById('btnStep5').disabled = false;
        }

        function selectCobertura(tipo) {
            formData.cobertura = tipo;
            document.querySelectorAll('#step6 .option-card').forEach(c => c.classList.remove('selected'));
            event.target.closest('.option-card').classList.add('selected');
            document.getElementById('btnStep6').disabled = false;
        }

        function selectCoparticipacao(opcao) {
            formData.coparticipacao = opcao;
            document.querySelectorAll('#step7 .option-card').forEach(c => c.classList.remove('selected'));
            event.target.closest('.option-card').classList.add('selected');
            document.getElementById('btnStep7').disabled = false;
        }

        function selectPagamento(forma) {
            formData.formaPagamento = forma;
            document.querySelectorAll('#step8 .option-card').forEach(c => c.classList.remove('selected'));
            event.target.closest('.option-card').classList.add('selected');
            document.getElementById('btnStep8').disabled = false;
        }

        // Calcular Total Vidas Manual
        function calcularTotalVidas() {
            let total = 0;
            for (let i = 0; i <= 9; i++) {
                total += parseInt(document.getElementById(`faixa${i}`).value) || 0;
            }
            document.getElementById('totalVidasManual').textContent = total;
            return total;
        }

        // Upload de arquivo
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    processarPlanilha(jsonData, file.name);
                } catch (error) {
                    console.error('Erro ao ler arquivo:', error);
                    alert('Erro ao ler o arquivo. Verifique se √© um Excel v√°lido.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processarPlanilha(data, fileName) {
            // Encontrar coluna de data de nascimento
            const headers = data[0] || [];
            let colNascimento = -1;
            let colNome = -1;
            let colCargo = -1;
            
            headers.forEach((h, i) => {
                const header = String(h).toLowerCase();
                if (header.includes('nascimento') || header.includes('data') || header.includes('birth')) {
                    colNascimento = i;
                }
                if (header.includes('nome') || header.includes('name')) {
                    colNome = i;
                }
                if (header.includes('cargo') || header.includes('fun√ß√£o') || header.includes('funcao')) {
                    colCargo = i;
                }
            });
            
            // Se n√£o encontrou pelo header, tenta a primeira coluna com datas
            if (colNascimento === -1) {
                for (let i = 0; i < headers.length; i++) {
                    if (isDate(data[1]?.[i])) {
                        colNascimento = i;
                        break;
                    }
                }
            }
            
            if (colNascimento === -1) {
                alert('N√£o foi poss√≠vel identificar a coluna de data de nascimento. Certifique-se que h√° uma coluna com datas.');
                return;
            }
            
            // Processar linhas
            formData.vidas = [];
            formData.faixasEtarias = {
                faixa0: 0, faixa1: 0, faixa2: 0, faixa3: 0, faixa4: 0,
                faixa5: 0, faixa6: 0, faixa7: 0, faixa8: 0, faixa9: 0
            };
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[colNascimento]) continue;
                
                const dataNasc = parseDate(row[colNascimento]);
                if (!dataNasc) continue;
                
                const idade = calcularIdade(dataNasc);
                const faixa = obterFaixa(idade);
                formData.faixasEtarias[`faixa${faixa}`]++;
                
                formData.vidas.push({
                    nome: colNome >= 0 ? row[colNome] || `Pessoa ${i}` : `Pessoa ${i}`,
                    dataNascimento: dataNasc,
                    idade: idade,
                    cargo: colCargo >= 0 ? row[colCargo] || '' : '',
                    faixa: faixa
                });
            }
            
            if (formData.vidas.length === 0) {
                alert('Nenhuma pessoa v√°lida encontrada na planilha.');
                return;
            }
            
            // Mostrar info do arquivo
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('fileInfo').style.display = 'flex';
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileMeta').textContent = `${formData.vidas.length} pessoas identificadas`;
            document.getElementById('btnStep3b').disabled = false;
        }

        function isDate(value) {
            if (!value) return false;
            if (typeof value === 'number') return true; // Excel date
            const date = new Date(value);
            return !isNaN(date.getTime());
        }

        function parseDate(value) {
            if (!value) return null;
            
            // Excel serial date
            if (typeof value === 'number') {
                const date = new Date((value - 25569) * 86400 * 1000);
                return date;
            }
            
            // String date
            const date = new Date(value);
            if (!isNaN(date.getTime())) return date;
            
            // Try DD/MM/YYYY
            const parts = String(value).split(/[\/\-]/);
            if (parts.length === 3) {
                const d = new Date(parts[2], parts[1] - 1, parts[0]);
                if (!isNaN(d.getTime())) return d;
            }
            
            return null;
        }

        function calcularIdade(dataNasc) {
            const hoje = new Date();
            let idade = hoje.getFullYear() - dataNasc.getFullYear();
            const m = hoje.getMonth() - dataNasc.getMonth();
            if (m < 0 || (m === 0 && hoje.getDate() < dataNasc.getDate())) {
                idade--;
            }
            return idade;
        }

        function obterFaixa(idade) {
            if (idade <= 18) return 0;
            if (idade <= 23) return 1;
            if (idade <= 28) return 2;
            if (idade <= 33) return 3;
            if (idade <= 38) return 4;
            if (idade <= 43) return 5;
            if (idade <= 48) return 6;
            if (idade <= 53) return 7;
            if (idade <= 58) return 8;
            return 9;
        }

        function removeFile() {
            formData.vidas = [];
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('btnStep3b').disabled = true;
        }

        function baixarModelo() {
            // Criar modelo de planilha
            const ws_data = [
                ['Nome', 'Data de Nascimento', 'Cargo'],
                ['Jo√£o Silva', '15/03/1985', 'Analista'],
                ['Maria Santos', '22/07/1990', 'Coordenadora'],
                ['Pedro Oliveira', '10/01/1978', 'Diretor']
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Beneficiarios');
            XLSX.writeFile(wb, 'modelo_beneficiarios.xlsx');
        }

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });

        // Render tabela de vidas
        function renderVidasTable() {
            const tbody = document.getElementById('vidasTableBody');
            tbody.innerHTML = formData.vidas.map((v, i) => `
                <tr>
                    <td class="checkbox-cell">
                        <input type="checkbox" data-index="${i}" onchange="atualizarTotalSocios()">
                    </td>
                    <td>${v.nome}</td>
                    <td>${v.idade} anos</td>
                    <td>${v.cargo || '-'}</td>
                </tr>
            `).join('');
        }

        function atualizarTotalSocios() {
            const total = document.querySelectorAll('#vidasTableBody input[type="checkbox"]:checked').length;
            document.getElementById('totalSocios').textContent = total;
        }

        // Preencher resumo
        function preencherResumo() {
            document.getElementById('summaryVidas').textContent = formData.totalVidas;
            document.getElementById('summaryAcomodacao').textContent = formData.acomodacao === 'apartamento' ? 'Apartamento' : 'Enfermaria';
            document.getElementById('summaryCobertura').textContent = formData.cobertura === 'completa' ? 'Completa' : 'Hospitalar';
            document.getElementById('summaryCoparticipacao').textContent = formData.coparticipacao === 'sim' ? 'Sim' : 'N√£o';
            document.getElementById('summarySocios').textContent = formData.sociosSelecionados.length > 0 ? `${formData.sociosSelecionados.length} pessoas` : 'N√£o';
        }

        // Formatters
        function formatCNPJ(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 14) value = value.slice(0, 14);
            if (value.length > 12) {
                value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            } else if (value.length > 8) {
                value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
            } else if (value.length > 5) {
                value = value.replace(/(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d{0,3})/, '$1.$2');
            }
            input.value = value;
        }

        function formatPhone(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            }
            input.value = value;
        }

        // Enviar cota√ß√£o
        async function enviarCotacao() {
            const nome = document.getElementById('nome').value.trim();
            const cnpj = document.getElementById('cnpj').value.trim();
            const whatsapp = document.getElementById('whatsapp').value.trim();
            
            if (!nome) {
                alert('Por favor, informe seu nome.');
                return;
            }
            if (!cnpj || cnpj.length < 18) {
                alert('Por favor, informe o CNPJ completo.');
                return;
            }
            if (!whatsapp || whatsapp.length < 14) {
                alert('Por favor, informe um WhatsApp v√°lido.');
                return;
            }
            
            formData.nome = nome;
            formData.cnpj = cnpj;
            formData.whatsapp = whatsapp;
            
            const btn = document.getElementById('btnEnviar');
            btn.disabled = true;
            btn.textContent = 'Enviando...';
            
            try {
                // Preparar dados dos s√≥cios selecionados
                const sociosData = formData.sociosSelecionados.map(i => formData.vidas[i]);
                
                await db.collection('leads_crm').add({
                    // Dados do contato
                    nome: formData.nome,
                    whatsapp: formData.whatsapp.replace(/\D/g, ''),
                    
                    // Dados da empresa
                    nomeEmpresa: formData.nomeEmpresa,
                    cnpj: formData.cnpj,
                    
                    // Dados do plano
                    totalVidas: formData.totalVidas,
                    faixasEtarias: formData.faixasEtarias,
                    acomodacao: formData.acomodacao,
                    cobertura: formData.cobertura,
                    coparticipacao: formData.coparticipacao,
                    formaPagamento: formData.formaPagamento,
                    planoDiferenciado: formData.planoDiferenciado,
                    sociosSelecionados: sociosData,
                    qtdSocios: formData.sociosSelecionados.length,
                    
                    // Metadados
                    ramo: 'saude',
                    tipo: 'empresarial',
                    status: 'pre_cadastro',
                    origem: 'site',
                    indicadoPorCodigo: indicadorCodigo || null,
                    indicadoPorNome: indicadorNome || null,
                    
                    // Empresa parceira (se houver)
                    empresaParceiraCodigo: empresaParceiraCodigo || null,
                    empresaParceiraNome: null,
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    dataCadastro: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Mostrar WhatsApp
                btn.style.display = 'none';
                const whatsappLink = document.getElementById('whatsappLink');
                whatsappLink.style.display = 'flex';
                
                const whatsNum = '5554997015000';
                const msg = `Ol√°! Sou ${formData.nome} da empresa *${formData.nomeEmpresa}* e acabei de solicitar uma cota√ß√£o de Plano de Sa√∫de Empresarial.%0A%0A` +
                    `üìä *Dados da solicita√ß√£o:*%0A` +
                    `‚Ä¢ Vidas: ${formData.totalVidas}%0A` +
                    `‚Ä¢ Acomoda√ß√£o: ${formData.acomodacao === 'apartamento' ? 'Apartamento' : 'Enfermaria'}%0A` +
                    `‚Ä¢ Cobertura: ${formData.cobertura === 'completa' ? 'Completa' : 'Hospitalar'}%0A` +
                    `‚Ä¢ Coparticipa√ß√£o: ${formData.coparticipacao === 'sim' ? 'Sim' : 'N√£o'}%0A` +
                    `‚Ä¢ CNPJ: ${formData.cnpj}%0A%0A` +
                    `Aguardo contato com as op√ß√µes de planos!`;
                
                whatsappLink.href = `https://wa.me/${whatsNum}?text=${msg}`;
                
                alert('‚úÖ Solicita√ß√£o enviada! Clique no bot√£o do WhatsApp para agilizar o atendimento.');
                
            } catch (error) {
                console.error('Erro:', error);
                btn.disabled = false;
                btn.textContent = 'Solicitar Cota√ß√£o Detalhada';
                alert('Erro ao enviar. Tente novamente.');
            }
        }

        // Init
        updateProgress();
    </script>
</body>
</html>
