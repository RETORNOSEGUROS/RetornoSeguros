<!-- ... mesmo <head> de antes ... -->

<form id="formApoliceSimples">
  <label for="tipo">Tipo de Seguro:</label>
  <select id="tipo" required>
    <option value="">Selecione</option>
    <option value="Auto">Auto</option>
    <option value="Residencial">Residencial</option>
    <option value="Vida">Vida</option>
  </select>

  <label for="seguradora">Seguradora:</label>
  <select id="seguradora" required>
    <option value="">Selecione</option>
    <option value="Porto Seguro">Porto Seguro</option>
    <option value="Tokio Marine">Tokio Marine</option>
    <option value="Bradesco Seguros">Bradesco Seguros</option>
    <option value="Itaú Seguros">Itaú Seguros</option>
    <option value="Suhai Seguradora">Suhai Seguradora</option>
    <option value="Mapfre">Mapfre</option>
    <option value="Azul Seguros">Azul Seguros</option>
    <option value="Alfa Seguradora">Alfa Seguradora</option>
    <option value="HDI Seguros">HDI Seguros</option>
    <option value="Liberty Seguros">Liberty Seguros</option>
    <option value="Zurich">Zurich</option>
    <option value="Allianz">Allianz</option>
    <option value="Sancor Seguros">Sancor Seguros</option>
    <option value="Sompo Seguros">Sompo Seguros</option>
    <option value="Amil">Amil</option>
    <option value="SulAmérica">SulAmérica</option>
    <option value="Unimed Seguros">Unimed Seguros</option>
    <option value="MetLife">MetLife</option>
    <option value="Icatu">Icatu</option>
    <option value="MAG Seguros">MAG Seguros</option>
  </select>

  <label for="valorPago">Valor Pago (R$):</label>
  <input type="text" id="valorPago" placeholder="Ex: R$ 1.200,00" required />

  <label for="dataRenovacao">Data da Renovação:</label>
  <input type="date" id="dataRenovacao" required />

  <button type="submit">Cadastrar Apólice</button>
</form>

<script>
  // Máscara de moeda brasileira
  document.getElementById("valorPago").addEventListener("input", function () {
    let valor = this.value.replace(/\D/g, "");
    valor = (parseInt(valor) / 100).toFixed(2) + "";
    valor = valor.replace(".", ",");
    valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
    this.value = "R$ " + valor;
  });

  // Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    const uid = user.uid;
    const form = document.getElementById("formApoliceSimples");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const tipo = document.getElementById("tipo").value;
      const seguradora = document.getElementById("seguradora").value;
      const valorPago = document.getElementById("valorPago").value;
      const dataRenovacao = document.getElementById("dataRenovacao").value;

      const apoliceData = {
        tipo,
        seguradora,
        valorPago,
        dataRenovacao: firebase.firestore.Timestamp.fromDate(new Date(dataRenovacao)),
        dataCadastro: firebase.firestore.Timestamp.now()
      };

      try {
        await db.collection("usuarios").doc(uid).collection("apolices").add(apoliceData);

        const userRef = db.collection("usuarios").doc(uid);
        const userDoc = await userRef.get();
        const creditosAtual = (userDoc.data().creditos || 0) + 30;
        await userRef.update({ creditos: creditosAtual });

        const indicadorId = userDoc.data().usuarioIndicadorId;
        if (indicadorId) {
          const indRef = db.collection("usuarios").doc(indicadorId);
          const indDoc = await indRef.get();
          const novosCreditos = (indDoc.data().creditos || 0) + 20;
          await indRef.update({ creditos: novosCreditos });
        }

        alert("Apólice registrada com sucesso!");
        form.reset();
      } catch (erro) {
        console.error("Erro ao salvar apólice:", erro);
        alert("Erro ao salvar. Tente novamente.");
      }
    });
  });
</script>
