<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cota√ß√£o Seguro Auto | Retorno Seguros</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #0088aa;
            --primary-dark: #006d88;
            --primary-light: #00b8d4;
            --dark-blue: #004d66;
            --darker-blue: #002a3a;
            --accent: #00e5ff;
            --bg: #f0f6f8;
            --bg-card: #ffffff;
            --text: #1a2e3b;
            --text-light: #5a7a8a;
            --text-muted: #8aa4b0;
            --border: #d0e0e8;
            --success: #00c853;
            --success-bg: #e8f9ef;
            --warning: #ff9100;
            --danger: #ff3d00;
            --shadow-sm: 0 1px 3px rgba(0,77,102,0.08);
            --shadow-md: 0 4px 16px rgba(0,77,102,0.1);
            --shadow-lg: 0 8px 32px rgba(0,77,102,0.15);
            --radius: 14px;
            --radius-sm: 10px;
            --radius-lg: 20px;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* LOADER */
        .page-loader {
            position: fixed; inset: 0;
            background: var(--darker-blue);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .page-loader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .loader-content { text-align: center; }
        .loader-spinner {
            width: 48px; height: 48px;
            border: 3px solid rgba(0,184,212,0.2);
            border-top-color: var(--primary-light);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        .loader-content p { color: rgba(255,255,255,0.7); font-size: 0.9rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* HEADER */
        .header {
            background: white;
            box-shadow: var(--shadow-sm);
            position: sticky; top: 0; z-index: 100;
        }
        .header-inner {
            max-width: 640px;
            margin: 0 auto;
            padding: 14px 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-logo {
            display: flex; align-items: center; gap: 10px;
            text-decoration: none; color: var(--text);
        }
        .header-logo img { height: 36px; }
        .header-logo-text {
            display: flex; flex-direction: column; line-height: 1.15;
        }
        .header-logo-text strong {
            font-size: 1rem; font-weight: 800;
            color: var(--dark-blue); letter-spacing: -0.3px;
        }
        .header-logo-text span {
            font-size: 0.65rem; font-weight: 600;
            color: var(--primary); letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .header-badge {
            font-size: 0.7rem; font-weight: 600;
            color: var(--primary);
            background: rgba(0,136,170,0.08);
            padding: 4px 10px; border-radius: 20px;
        }

        /* PROGRESS */
        .progress-wrap {
            max-width: 640px; margin: 0 auto;
            padding: 16px 20px 0;
        }
        .progress-info {
            display: flex; justify-content: space-between;
            font-size: 0.75rem; font-weight: 600;
            color: var(--text-muted); margin-bottom: 8px;
        }
        .progress-bar {
            height: 5px; background: var(--border); border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
        }

        /* CONTAINER */
        .container {
            max-width: 640px;
            margin: 0 auto;
            padding: 20px;
            min-height: calc(100vh - 140px);
        }

        /* STEP CARDS */
        .step {
            display: none;
            animation: stepIn 0.4s cubic-bezier(0.16,1,0.3,1);
        }
        .step.active { display: block; }
        @keyframes stepIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 32px 28px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(0,136,170,0.06);
        }

        .step-icon { font-size: 2.2rem; margin-bottom: 8px; }
        .step-title {
            font-size: 1.4rem; font-weight: 800;
            color: var(--dark-blue);
            margin-bottom: 6px; letter-spacing: -0.5px; line-height: 1.25;
        }
        .step-subtitle {
            font-size: 0.9rem; color: var(--text-light);
            margin-bottom: 24px; line-height: 1.5;
        }

        /* INPUTS */
        .input-group { margin-bottom: 20px; }
        .input-group label {
            display: block; font-size: 0.8rem; font-weight: 600;
            color: var(--text-light); margin-bottom: 6px;
        }
        .input-field {
            width: 100%; padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem; font-family: inherit;
            color: var(--text); background: white;
            transition: all 0.2s; outline: none;
        }
        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0,136,170,0.1);
        }
        .input-field::placeholder { color: var(--text-muted); }

        /* AUTOCOMPLETE */
        .autocomplete-wrap { position: relative; }
        .autocomplete-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white;
            border: 2px solid var(--primary);
            border-top: none;
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
            max-height: 220px; overflow-y: auto;
            z-index: 50; display: none;
            box-shadow: var(--shadow-lg);
        }
        .autocomplete-dropdown.show { display: block; }
        .autocomplete-item {
            padding: 12px 16px; cursor: pointer;
            font-size: 0.9rem; color: var(--text);
            border-bottom: 1px solid var(--bg);
            transition: background 0.15s;
        }
        .autocomplete-item:hover, .autocomplete-item.highlighted {
            background: rgba(0,136,170,0.06);
            color: var(--primary-dark);
        }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item mark {
            background: rgba(0,184,212,0.2); color: var(--dark-blue);
            font-weight: 700; border-radius: 2px; padding: 0 1px;
        }
        .autocomplete-empty {
            padding: 16px; text-align: center;
            color: var(--text-muted); font-size: 0.85rem;
        }

        /* SELECT */
        .select-field {
            width: 100%; padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem; font-family: inherit;
            color: var(--text); background: white;
            transition: all 0.2s; outline: none;
            cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%235a7a8a' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
        }
        .select-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0,136,170,0.1);
        }

        /* OPTION CARDS */
        .options-grid { display: grid; gap: 12px; margin-bottom: 24px; }
        .options-grid.cols-2 { grid-template-columns: 1fr 1fr; }
        .options-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }

        .option-card {
            background: white; border: 2px solid var(--border);
            border-radius: var(--radius); padding: 18px 16px;
            cursor: pointer; transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
            text-align: center; position: relative;
        }
        .option-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .option-card.selected {
            border-color: var(--primary);
            background: rgba(0,136,170,0.04);
            box-shadow: 0 0 0 4px rgba(0,136,170,0.1);
        }
        .option-card.selected::after {
            content: '‚úì'; position: absolute; top: 8px; right: 10px;
            font-size: 0.7rem; font-weight: 800; color: white;
            background: var(--primary); width: 20px; height: 20px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .option-icon { font-size: 1.6rem; margin-bottom: 8px; }
        .option-title { font-size: 0.9rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 2px; }
        .option-subtitle { font-size: 0.75rem; color: var(--text-muted); }

        .option-card.recommended {
            border-color: var(--primary-light);
            background: rgba(0,184,212,0.04);
        }
        .option-card.recommended::before {
            content: '‚≠ê Recomendado'; position: absolute; top: -10px; left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem; font-weight: 700; color: white;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            padding: 2px 10px; border-radius: 10px; white-space: nowrap;
        }

        /* CHECKBOX CARDS */
        .checkbox-grid { display: grid; gap: 10px; margin-bottom: 24px; }
        .checkbox-card {
            display: flex; align-items: center; gap: 14px;
            background: white; border: 2px solid var(--border);
            border-radius: var(--radius); padding: 16px;
            cursor: pointer; transition: all 0.2s;
        }
        .checkbox-card:hover { border-color: var(--primary); }
        .checkbox-card.checked { border-color: var(--primary); background: rgba(0,136,170,0.04); }
        .checkbox-card .cb-icon { font-size: 1.4rem; flex-shrink: 0; }
        .checkbox-card .cb-info { flex: 1; }
        .checkbox-card .cb-title { font-size: 0.9rem; font-weight: 700; color: var(--dark-blue); }
        .checkbox-card .cb-desc { font-size: 0.78rem; color: var(--text-muted); margin-top: 2px; }
        .checkbox-card .cb-check {
            width: 24px; height: 24px; border: 2px solid var(--border);
            border-radius: 6px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; color: white; transition: all 0.2s;
        }
        .checkbox-card.checked .cb-check { background: var(--primary); border-color: var(--primary); }

        /* FIPE BOX */
        .fipe-box {
            background: linear-gradient(135deg, var(--dark-blue), var(--primary-dark));
            color: white; border-radius: var(--radius);
            padding: 16px 18px; margin-top: 16px; display: none;
        }
        .fipe-box.show { display: block; animation: stepIn 0.3s ease; }
        .fipe-label { font-size: 0.75rem; opacity: 0.8; margin-bottom: 4px; }
        .fipe-value { font-size: 1.3rem; font-weight: 800; }

        /* CONDITIONAL FIELD */
        .conditional-field {
            display: none; margin-top: 20px;
            padding-top: 20px; border-top: 1px solid var(--border);
            animation: stepIn 0.3s ease;
        }
        .conditional-field.show { display: block; }

        /* HINT */
        .hint {
            display: flex; align-items: flex-start; gap: 8px;
            background: rgba(0,136,170,0.05);
            border-radius: var(--radius-sm);
            padding: 12px 14px; margin-top: 16px;
            font-size: 0.8rem; color: var(--text-light); line-height: 1.5;
        }
        .hint-icon { font-size: 1rem; flex-shrink: 0; }

        /* BUTTONS */
        .btn-row { display: flex; gap: 10px; margin-top: 24px; }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 14px 24px; border-radius: var(--radius-sm);
            font-size: 0.95rem; font-weight: 700; font-family: inherit;
            border: none; cursor: pointer; transition: all 0.25s; flex: 1;
        }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: 0 4px 12px rgba(0,136,170,0.3);
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,136,170,0.4);
        }
        .btn-back {
            background: transparent; color: var(--text-light);
            border: 2px solid var(--border); flex: 0 0 auto; padding: 14px 18px;
        }
        .btn-back:hover { border-color: var(--text-light); color: var(--text); }

        /* SUMMARY */
        .summary-section { margin-bottom: 20px; }
        .summary-title {
            font-size: 0.75rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.8px;
            color: var(--primary); margin-bottom: 10px;
            padding-bottom: 6px; border-bottom: 2px solid rgba(0,136,170,0.1);
        }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .summary-item { padding: 10px 12px; background: var(--bg); border-radius: var(--radius-sm); }
        .summary-item.full { grid-column: 1 / -1; }
        .summary-label { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; margin-bottom: 2px; }
        .summary-value { font-size: 0.9rem; font-weight: 700; color: var(--dark-blue); }

        /* CTA */
        .cta-divider { display: flex; align-items: center; gap: 12px; margin: 28px 0 20px; }
        .cta-divider::before, .cta-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .cta-divider span { font-size: 1rem; font-weight: 800; color: var(--dark-blue); white-space: nowrap; }

        .cta-option {
            border: 2px solid var(--border); border-radius: var(--radius);
            padding: 24px; margin-bottom: 14px; transition: all 0.3s; cursor: pointer;
        }
        .cta-option:hover { border-color: var(--primary); box-shadow: var(--shadow-sm); }
        .cta-option.highlight { border-color: var(--primary); background: rgba(0,136,170,0.03); }
        .cta-option-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .cta-option-icon {
            width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem; flex-shrink: 0;
        }
        .cta-option-icon.whatsapp { background: #25d366; color: white; }
        .cta-option-icon.save { background: rgba(0,136,170,0.1); color: var(--primary); }
        .cta-option-title { font-size: 1rem; font-weight: 800; color: var(--dark-blue); }
        .cta-option-desc { font-size: 0.82rem; color: var(--text-light); line-height: 1.5; margin-bottom: 14px; }

        .whatsapp-input-row { display: flex; gap: 8px; }
        .whatsapp-input-row .input-field { flex: 1; }
        .whatsapp-input-row .btn { flex: 0 0 auto; padding: 14px 20px; }

        .cta-btn-whatsapp {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 16px;
            background: #25d366; color: white;
            border: none; border-radius: var(--radius-sm);
            font-size: 1rem; font-weight: 700; font-family: inherit;
            cursor: pointer; transition: all 0.25s; text-decoration: none;
        }
        .cta-btn-whatsapp:hover {
            background: #20bd5a; transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37,211,102,0.35);
        }
        .cta-btn-whatsapp svg { width: 22px; height: 22px; fill: white; }

        .success-msg {
            display: none; text-align: center; padding: 20px;
            background: var(--success-bg); border-radius: var(--radius);
            margin-top: 14px; animation: stepIn 0.3s ease;
        }
        .success-msg.show { display: block; }
        .success-msg .success-icon { font-size: 2.5rem; margin-bottom: 8px; }
        .success-msg .success-title { font-size: 1.1rem; font-weight: 800; color: var(--dark-blue); }
        .success-msg .success-desc { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }

        /* ERROR */
        .error-box {
            background: rgba(255,61,0,0.06); border: 1px solid rgba(255,61,0,0.15);
            border-radius: var(--radius-sm); padding: 14px; margin-bottom: 16px;
            display: none; font-size: 0.85rem; color: var(--danger);
        }
        .error-box.show { display: block; }

        /* RESPONSIVE */
        @media (max-width: 480px) {
            .step-card { padding: 24px 20px; }
            .step-title { font-size: 1.2rem; }
            .options-grid.cols-3 { grid-template-columns: 1fr 1fr; }
            .summary-grid { grid-template-columns: 1fr; }
            .summary-item.full { grid-column: auto; }
            .whatsapp-input-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- LOADER -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <p>Carregando...</p>
        </div>
    </div>

    <!-- HEADER -->
    <div class="header">
        <div class="header-inner">
            <a href="https://www.retornoseguros.com/" class="header-logo">
                <img src="logoretorno.png" alt="Retorno Seguros">
                <div class="header-logo-text">
                    <strong>RETORNO</strong>
                    <span>Seguros e Benef√≠cios</span>
                </div>
            </a>
            <div class="header-badge">Seguro Auto</div>
        </div>
    </div>

    <!-- PROGRESS -->
    <div class="progress-wrap">
        <div class="progress-info">
            <span id="progressLabel">Passo 1 de 15</span>
            <span id="progressPercent">7%</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 7%"></div>
        </div>
    </div>

    <!-- CONTAINER -->
    <div class="container">

        <!-- STEP 1: Nome -->
        <div class="step active" id="step1">
            <div class="step-card">
                <div class="step-icon">üëã</div>
                <h2 class="step-title">Vamos encontrar o melhor seguro pra voc√™!</h2>
                <p class="step-subtitle">Primeiro, como posso te chamar?</p>
                <div class="input-group">
                    <input type="text" class="input-field" id="inputNome" placeholder="Seu nome" autocomplete="given-name">
                </div>
                <div class="btn-row">
                    <button class="btn btn-primary" id="btnStep1" onclick="goToStep(2)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 2: Tem seguro? + M√™s vencimento condicional -->
        <div class="step" id="step2">
            <div class="step-card">
                <div class="step-icon">üìã</div>
                <h2 class="step-title">Legal, <span id="nameDisplay1"></span>!</h2>
                <p class="step-subtitle">Voc√™ j√° tem seguro ou √© a primeira vez?</p>
                <div class="options-grid cols-2">
                    <div class="option-card" onclick="selectSeguro('sim',this)">
                        <div class="option-icon">üîÑ</div>
                        <div class="option-title">Tenho seguro ativo</div>
                        <div class="option-subtitle">Quero renovar ou trocar</div>
                    </div>
                    <div class="option-card" onclick="selectSeguro('nao',this)">
                        <div class="option-icon">üÜï</div>
                        <div class="option-title">Primeiro seguro</div>
                        <div class="option-subtitle">Nunca tive seguro</div>
                    </div>
                </div>

                <!-- M√™s vencimento (aparece s√≥ se tem seguro) -->
                <div class="conditional-field" id="mesVencimentoField">
                    <div class="input-group" style="margin-bottom:0;">
                        <label>üìÖ Em que m√™s vence seu seguro atual?</label>
                        <select class="select-field" id="selectMesVencimento" onchange="formData.mesVencimento=this.value; checkStep2();">
                            <option value="">Selecione o m√™s</option>
                            <option value="Janeiro">Janeiro</option>
                            <option value="Fevereiro">Fevereiro</option>
                            <option value="Mar√ßo">Mar√ßo</option>
                            <option value="Abril">Abril</option>
                            <option value="Maio">Maio</option>
                            <option value="Junho">Junho</option>
                            <option value="Julho">Julho</option>
                            <option value="Agosto">Agosto</option>
                            <option value="Setembro">Setembro</option>
                            <option value="Outubro">Outubro</option>
                            <option value="Novembro">Novembro</option>
                            <option value="Dezembro">Dezembro</option>
                        </select>
                    </div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(1)">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep2" onclick="goToStep(3)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 3: Ve√≠culo (Autocomplete) -->
        <div class="step" id="step3">
            <div class="step-card">
                <div class="step-icon">üöó</div>
                <h2 class="step-title">Me conta sobre seu carro</h2>
                <p class="step-subtitle">Digite o nome da marca e selecione</p>

                <div id="fipeError" class="error-box">N√£o foi poss√≠vel carregar os dados. Tente novamente.</div>

                <div class="input-group">
                    <label>Marca</label>
                    <div class="autocomplete-wrap">
                        <input type="text" class="input-field" id="inputMarca" placeholder="Ex: Ford, Toyota, Volkswagen..." autocomplete="off">
                        <div class="autocomplete-dropdown" id="dropdownMarca"></div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Modelo</label>
                    <div class="autocomplete-wrap">
                        <input type="text" class="input-field" id="inputModelo" placeholder="Selecione a marca primeiro" autocomplete="off" disabled>
                        <div class="autocomplete-dropdown" id="dropdownModelo"></div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Ano</label>
                    <select class="select-field" id="selectAno" disabled>
                        <option value="">Selecione o modelo primeiro</option>
                    </select>
                </div>

                <div class="fipe-box" id="fipeBox">
                    <div class="fipe-label">Valor FIPE</div>
                    <div class="fipe-value" id="fipeValue">--</div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(2)">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep3" onclick="goToStep(4)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 4: Utiliza√ß√£o do ve√≠culo (NOVO) -->
        <div class="step" id="step4">
            <div class="step-card">
                <div class="step-icon">üõû</div>
                <h2 class="step-title">Qual a utiliza√ß√£o do ve√≠culo?</h2>
                <p class="step-subtitle">Isso ajuda a seguradora a calcular o risco corretamente</p>
                <div class="options-grid">
                    <div class="option-card" onclick="selectOption('utilizacao','particular',this)">
                        <div class="option-icon">üè†</div>
                        <div class="option-title">Particular</div>
                        <div class="option-subtitle">Uso pessoal: ir ao trabalho, lazer, dia a dia</div>
                    </div>
                    <div class="option-card" onclick="selectOption('utilizacao','profissional',this)">
                        <div class="option-icon">üíº</div>
                        <div class="option-title">Profissional</div>
                        <div class="option-subtitle">Visita a clientes, uso comercial ou a servi√ßo</div>
                    </div>
                    <div class="option-card" onclick="selectOption('utilizacao','transporte',this)">
                        <div class="option-icon">üì±</div>
                        <div class="option-title">Transporte de passageiros</div>
                        <div class="option-subtitle">App de transporte (Uber, 99) ou t√°xi</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(3)">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep4" onclick="goToStep(5)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 5: Condutor -->
        <div class="step" id="step5">
            <div class="step-card">
                <div class="step-icon">üë§</div>
                <h2 class="step-title">Quem usa o carro?</h2>
                <p class="step-subtitle">Principal condutor do ve√≠culo</p>
                <div class="options-grid cols-2">
                    <div class="option-card" onclick="selectOption('condutor','eu',this)">
                        <div class="option-icon">üôã</div>
                        <div class="option-title">Eu mesmo</div>
                    </div>
                    <div class="option-card" onclick="selectOption('condutor','outro',this)">
                        <div class="option-icon">üë•</div>
                        <div class="option-title">Outra pessoa</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(4)">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep5" onclick="goToStep(6)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 6: Idade -->
        <div class="step" id="step6">
            <div class="step-card">
                <div class="step-icon">üéÇ</div>
                <h2 class="step-title">Qual sua faixa de idade?</h2>
                <p class="step-subtitle">Do principal condutor</p>
                <div class="options-grid">
                    <div class="option-card" onclick="selectOption('idade','18-25',this)">
                        <div class="option-title">18 a 25 anos</div>
                    </div>
                    <div class="option-card" onclick="selectOption('idade','26-35',this)">
                        <div class="option-title">26 a 35 anos</div>
                    </div>
                    <div class="option-card" onclick="selectOption('idade','36-45',this)">
                        <div class="option-title">36 a 45 anos</div>
                    </div>
                    <div class="option-card" onclick="selectOption('idade','46-60',this)">
                        <div class="option-title">46 a 60 anos</div>
                    </div>
                    <div class="option-card" onclick="selectOption('idade','60+',this)">
                        <div class="option-title">Acima de 60</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(5)">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep6" onclick="goToStep(7)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 7: Onde dorme -->
        <div class="step" id="step7">
            <div class="step-card">
                <div class="step-icon">üè†</div>
                <h2 class="step-title">Onde o carro dorme?</h2>
                <p class="step-subtitle">Local habitual de pernoite</p>
                <div class="options-grid cols-3">
                    <div class="option-card" onclick="selectOption('garagem','fechada',this)">
                        <div class="option-icon">üè†</div>
                        <div class="option-title">Garagem fechada</div>
                    </div>
                    <div class="option-card" onclick="selectOption('garagem','aberta',this)">
                        <div class="option-icon">üÖøÔ∏è</div>
                        <div class="option-title">Estac. aberto</div>
                    </div>
                    <div class="option-card" onclick="selectOption('garagem','rua',this)">
                        <div class="option-icon">üõ£Ô∏è</div>
                        <div class="option-title">Na rua</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(6)">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep7" onclick="nextAfterGaragem()" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 8: B√¥nus (S√ì se tem seguro) -->
        <div class="step" id="step8">
            <div class="step-card">
                <div class="step-icon">‚≠ê</div>
                <h2 class="step-title">Qual sua classe de b√¥nus?</h2>
                <p class="step-subtitle">Desconto acumulado por anos sem sinistro</p>
                <div class="input-group">
                    <select class="select-field" id="selectBonus" onchange="formData.bonus=this.value; document.getElementById('btnStep8').disabled=!this.value;">
                        <option value="">Selecione</option>
                        <option value="0">B√¥nus 0 (sem desconto)</option>
                        <option value="1">B√¥nus 1 (10% desconto)</option>
                        <option value="2">B√¥nus 2 (15% desconto)</option>
                        <option value="3">B√¥nus 3 (20% desconto)</option>
                        <option value="4">B√¥nus 4 (25% desconto)</option>
                        <option value="5">B√¥nus 5 (30% desconto)</option>
                        <option value="6">B√¥nus 6 (30% desconto)</option>
                        <option value="7">B√¥nus 7 (30% desconto)</option>
                        <option value="8">B√¥nus 8 (35% desconto)</option>
                        <option value="9">B√¥nus 9 (35% desconto)</option>
                        <option value="10">B√¥nus 10 (35% desconto)</option>
                        <option value="nao-sei">N√£o sei / N√£o lembro</option>
                    </select>
                </div>
                <div class="hint">
                    <span class="hint-icon">üí°</span>
                    <span>A classe de b√¥nus est√° na sua ap√≥lice atual. Se n√£o sabe, tudo bem, n√≥s verificamos!</span>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(7)">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep8" onclick="goToStep(9)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 9: Sinistro (S√ì se tem seguro) -->
        <div class="step" id="step9">
            <div class="step-card">
                <div class="step-icon">üîß</div>
                <h2 class="step-title">Acionou o seguro recentemente?</h2>
                <p class="step-subtitle">Teve algum sinistro na √∫ltima vig√™ncia?</p>
                <div class="options-grid cols-2">
                    <div class="option-card" onclick="selectOption('sinistro','sim',this)">
                        <div class="option-icon">‚ö†Ô∏è</div>
                        <div class="option-title">Sim, tive sinistro</div>
                    </div>
                    <div class="option-card" onclick="selectOption('sinistro','nao',this)">
                        <div class="option-icon">‚úÖ</div>
                        <div class="option-title">N√£o, tudo tranquilo</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(8)">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep9" onclick="goToStep(10)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 10: Reboque -->
        <div class="step" id="step10">
            <div class="step-card">
                <div class="step-icon">üöõ</div>
                <h2 class="step-title">Dist√¢ncia de reboque</h2>
                <p class="step-subtitle">Se precisar de reboque, qual dist√¢ncia te atenderia?</p>
                <div class="options-grid cols-2">
                    <div class="option-card" onclick="selectOption('reboque','200km',this)">
                        <div class="option-icon">üìç</div>
                        <div class="option-title">At√© 200 km</div>
                        <div class="option-subtitle">Uso urbano</div>
                    </div>
                    <div class="option-card" onclick="selectOption('reboque','400km',this)">
                        <div class="option-icon">üõ£Ô∏è</div>
                        <div class="option-title">At√© 400 km</div>
                        <div class="option-subtitle">Viajo √†s vezes</div>
                    </div>
                    <div class="option-card" onclick="selectOption('reboque','600km',this)">
                        <div class="option-icon">‚úàÔ∏è</div>
                        <div class="option-title">At√© 600 km</div>
                        <div class="option-subtitle">Viajo bastante</div>
                    </div>
                    <div class="option-card" onclick="selectOption('reboque','ilimitado',this)">
                        <div class="option-icon">üåé</div>
                        <div class="option-title">Km ilimitado</div>
                        <div class="option-subtitle">Total tranquilidade</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="backToBeforeReboque()">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep10" onclick="goToStep(11)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 11: Prote√ß√£o contra terceiros -->
        <div class="step" id="step11">
            <div class="step-card">
                <div class="step-icon">üõ°Ô∏è</div>
                <h2 class="step-title">Prote√ß√£o contra terceiros</h2>
                <p class="step-subtitle">Se voc√™ bater em outro carro, qual prote√ß√£o faz sentido?</p>
                <div class="options-grid">
                    <div class="option-card" onclick="selectOption('terceiros','100mil',this)">
                        <div class="option-title">R$ 100 mil</div>
                        <div class="option-subtitle">Carros populares</div>
                    </div>
                    <div class="option-card recommended" onclick="selectOption('terceiros','200mil',this)">
                        <div class="option-title">R$ 200 mil</div>
                        <div class="option-subtitle">Carros m√©dios</div>
                    </div>
                    <div class="option-card" onclick="selectOption('terceiros','300mil',this)">
                        <div class="option-title">R$ 300 mil</div>
                        <div class="option-subtitle">Carros premium</div>
                    </div>
                    <div class="option-card" onclick="selectOption('terceiros','500mil',this)">
                        <div class="option-title">R$ 500 mil</div>
                        <div class="option-subtitle">Alta prote√ß√£o</div>
                    </div>
                    <div class="option-card" onclick="selectOption('terceiros','800mil',this)">
                        <div class="option-title">R$ 800 mil</div>
                        <div class="option-subtitle">M√°xima prote√ß√£o</div>
                    </div>
                </div>
                <div class="hint">
                    <span class="hint-icon">‚ÑπÔ∏è</span>
                    <span>Cobre danos materiais e corporais que voc√™ causar em outros ve√≠culos e pessoas.</span>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(10)">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep11" onclick="goToStep(12)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 12: Carro reserva -->
        <div class="step" id="step12">
            <div class="step-card">
                <div class="step-icon">üöï</div>
                <h2 class="step-title">Carro reserva</h2>
                <p class="step-subtitle">Se o carro ficar na oficina, quantos dias seriam ideais?</p>
                <div class="options-grid">
                    <div class="option-card" onclick="selectOption('carroReserva','nao',this)">
                        <div class="option-title">N√£o preciso</div>
                    </div>
                    <div class="option-card" onclick="selectOption('carroReserva','7dias',this)">
                        <div class="option-title">7 dias</div>
                    </div>
                    <div class="option-card" onclick="selectOption('carroReserva','15dias',this)">
                        <div class="option-title">15 dias</div>
                    </div>
                    <div class="option-card" onclick="selectOption('carroReserva','30dias',this)">
                        <div class="option-title">30 dias</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(11)">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep12" onclick="goToStep(13)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 13: Servi√ßos extras -->
        <div class="step" id="step13">
            <div class="step-card">
                <div class="step-icon">üîß</div>
                <h2 class="step-title">Servi√ßos extras</h2>
                <p class="step-subtitle">Quais fazem sentido pra voc√™? (pode marcar v√°rios)</p>
                <div class="checkbox-grid">
                    <div class="checkbox-card" onclick="toggleExtra('vidros',this)">
                        <div class="cb-icon">ü™ü</div>
                        <div class="cb-info">
                            <div class="cb-title">Vidros</div>
                            <div class="cb-desc">Troca de para-brisa, vidros laterais e retrovisores</div>
                        </div>
                        <div class="cb-check">‚úì</div>
                    </div>
                    <div class="checkbox-card" onclick="toggleExtra('martelinho',this)">
                        <div class="cb-icon">üî®</div>
                        <div class="cb-info">
                            <div class="cb-title">Martelinho de Ouro</div>
                            <div class="cb-desc">Remove amassados pequenos sem repintura</div>
                        </div>
                        <div class="cb-check">‚úì</div>
                    </div>
                    <div class="checkbox-card" onclick="toggleExtra('parachoque',this)">
                        <div class="cb-icon">üõ°Ô∏è</div>
                        <div class="cb-info">
                            <div class="cb-title">Para-choque</div>
                            <div class="cb-desc">Reparo ou troca em caso de danos</div>
                        </div>
                        <div class="cb-check">‚úì</div>
                    </div>
                    <div class="checkbox-card" onclick="toggleExtra('pintura',this)">
                        <div class="cb-icon">üé®</div>
                        <div class="cb-info">
                            <div class="cb-title">Pintura e Lataria</div>
                            <div class="cb-desc">Conserto de arranh√µes e pequenos amassados</div>
                        </div>
                        <div class="cb-check">‚úì</div>
                    </div>
                    <div class="checkbox-card" onclick="toggleExtra('pneu',this)">
                        <div class="cb-icon">üõû</div>
                        <div class="cb-info">
                            <div class="cb-title">Pneu, Roda e Suspens√£o</div>
                            <div class="cb-desc">Danos causados por buracos</div>
                        </div>
                        <div class="cb-check">‚úì</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(12)">‚Üê</button>
                    <button class="btn btn-primary" onclick="goToStep(14)">Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 14: Franquia -->
        <div class="step" id="step14">
            <div class="step-card">
                <div class="step-icon">üí∞</div>
                <h2 class="step-title">Tipo de franquia</h2>
                <p class="step-subtitle">Valor que voc√™ paga em caso de reparo</p>
                <div class="options-grid">
                    <div class="option-card" onclick="selectOption('franquia','basica',this)">
                        <div class="option-title">Franquia B√°sica</div>
                        <div class="option-subtitle">Pago menos no seguro, mais se usar</div>
                    </div>
                    <div class="option-card recommended" onclick="selectOption('franquia','reduzida',this)">
                        <div class="option-title">Franquia Reduzida (50%)</div>
                        <div class="option-subtitle">Equil√≠brio custo-benef√≠cio</div>
                    </div>
                    <div class="option-card" onclick="selectOption('franquia','super-reduzida',this)">
                        <div class="option-title">Super Reduzida (25%)</div>
                        <div class="option-subtitle">Pago mais no seguro, menos se usar</div>
                    </div>
                </div>
                <div class="hint">
                    <span class="hint-icon">üí°</span>
                    <span>A franquia √© o valor que voc√™ paga quando aciona o seguro para reparos.</span>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(13)">‚Üê</button>
                    <button class="btn btn-primary" id="btnStep14" onclick="showFinalStep()" disabled>Ver resultado</button>
                </div>
            </div>
        </div>

        <!-- STEP 15: RESULTADO FINAL -->
        <div class="step" id="step15">
            <div class="step-card">
                <div class="step-icon">üéØ</div>
                <h2 class="step-title"><span id="nameDisplay2"></span>, aqui est√° o resumo da sua cota√ß√£o!</h2>
                <p class="step-subtitle">Confira tudo o que voc√™ selecionou:</p>

                <!-- Resumo do Ve√≠culo -->
                <div class="summary-section">
                    <div class="summary-title">üöó Ve√≠culo</div>
                    <div class="summary-grid">
                        <div class="summary-item full">
                            <div class="summary-label">Marca / Modelo</div>
                            <div class="summary-value" id="sumVeiculo">--</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Ano</div>
                            <div class="summary-value" id="sumAno">--</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Valor FIPE</div>
                            <div class="summary-value" id="sumFipe">--</div>
                        </div>
                        <div class="summary-item full">
                            <div class="summary-label">Utiliza√ß√£o</div>
                            <div class="summary-value" id="sumUtilizacao">--</div>
                        </div>
                    </div>
                </div>

                <!-- Resumo do Perfil -->
                <div class="summary-section">
                    <div class="summary-title">üë§ Perfil</div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Seguro atual</div>
                            <div class="summary-value" id="sumSeguro">--</div>
                        </div>
                        <div class="summary-item" id="sumMesWrap" style="display:none;">
                            <div class="summary-label">Vencimento</div>
                            <div class="summary-value" id="sumMesVencimento">--</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Condutor</div>
                            <div class="summary-value" id="sumCondutor">--</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Idade</div>
                            <div class="summary-value" id="sumIdade">--</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Pernoite</div>
                            <div class="summary-value" id="sumGaragem">--</div>
                        </div>
                        <div class="summary-item" id="sumBonusWrap">
                            <div class="summary-label">B√¥nus</div>
                            <div class="summary-value" id="sumBonus">--</div>
                        </div>
                        <div class="summary-item" id="sumSinistroWrap">
                            <div class="summary-label">Sinistro</div>
                            <div class="summary-value" id="sumSinistro">--</div>
                        </div>
                    </div>
                </div>

                <!-- Resumo das Coberturas -->
                <div class="summary-section">
                    <div class="summary-title">üõ°Ô∏è Coberturas Desejadas</div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Reboque</div>
                            <div class="summary-value" id="sumReboque">--</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Terceiros</div>
                            <div class="summary-value" id="sumTerceiros">--</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Carro reserva</div>
                            <div class="summary-value" id="sumCarroReserva">--</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Franquia</div>
                            <div class="summary-value" id="sumFranquia">--</div>
                        </div>
                        <div class="summary-item full">
                            <div class="summary-label">Servi√ßos extras</div>
                            <div class="summary-value" id="sumExtras">Nenhum selecionado</div>
                        </div>
                    </div>
                </div>

                <!-- CTA -->
                <div class="cta-divider">
                    <span>ü§ù Estamos juntos nessa?</span>
                </div>

                <!-- Op√ß√£o 1: WhatsApp -->
                <div class="cta-option highlight" id="ctaWhatsapp">
                    <div class="cta-option-header">
                        <div class="cta-option-icon whatsapp">
                            <svg viewBox="0 0 24 24" fill="white" width="22" height="22"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.263.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        </div>
                        <div class="cta-option-title">Falar agora no WhatsApp</div>
                    </div>
                    <div class="cta-option-desc">Converse direto com nosso especialista e receba sua proposta personalizada agora mesmo.</div>
                    <a class="cta-btn-whatsapp" id="btnWhatsappDirect" href="#" target="_blank">
                        <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.263.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        Estou dentro! Vamos nessa! üí™
                    </a>
                </div>

                <!-- OU -->
                <div style="text-align:center; color: var(--text-muted); font-size: 0.8rem; font-weight: 600; margin: 8px 0;">ou</div>

                <!-- Op√ß√£o 2: Salvar Lead -->
                <div class="cta-option" id="ctaSave">
                    <div class="cta-option-header">
                        <div class="cta-option-icon save">üì±</div>
                        <div class="cta-option-title">Prefere que a gente te chame?</div>
                    </div>
                    <div class="cta-option-desc">Deixa seu WhatsApp e nosso time entra em contato com a melhor proposta. Sem spam! ü§ô</div>
                    <div class="whatsapp-input-row">
                        <input type="tel" class="input-field" id="inputWhatsapp" placeholder="(00) 00000-0000" oninput="formatPhone(this)">
                        <button class="btn btn-primary" onclick="salvarLead()" id="btnSalvarLead">Salvar</button>
                    </div>
                    <div class="success-msg" id="successMsg">
                        <div class="success-icon">‚úÖ</div>
                        <div class="success-title">Pronto! Vamos entrar em contato!</div>
                        <div class="success-desc">Nosso time vai te chamar no WhatsApp com a melhor proposta.</div>
                    </div>
                </div>

                <div class="btn-row" style="margin-top: 16px;">
                    <button class="btn btn-back" onclick="goToStep(14)" style="flex:1;">‚Üê Quero ajustar algo</button>
                </div>
            </div>
        </div>

    </div><!-- /container -->

    <script>
        // ===== FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.appspot.com",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29",
            measurementId: "G-C6E44WXLPW"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ===== FIPE API =====
        const FIPE_API = 'https://parallelum.com.br/fipe/api/v1/carros';
        let marcasFipe = [];
        let modelosFipe = [];
        let anosFipe = [];

        // ===== FORM DATA =====
        let formData = {
            nome: '',
            temSeguro: '',
            mesVencimento: '',
            marcaCodigo: '',
            marcaNome: '',
            modeloCodigo: '',
            modeloNome: '',
            anoCodigo: '',
            anoNome: '',
            valorFipe: '',
            utilizacao: '',
            condutor: '',
            idade: '',
            garagem: '',
            bonus: '',
            sinistro: '',
            reboque: '',
            terceiros: '',
            carroReserva: '',
            extras: [],
            franquia: '',
            whatsapp: ''
        };

        let currentStep = 1;
        const totalSteps = 15;

        // ===== URL PARAMS =====
        const urlParams = new URLSearchParams(window.location.search);
        const indicadorCodigo = urlParams.get('ref') || null;
        const empresaParceiraCodigo = urlParams.get('emp') || null;

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', async () => {
            setTimeout(() => document.getElementById('pageLoader').classList.add('hidden'), 600);

            try {
                const res = await fetch(`${FIPE_API}/marcas`);
                marcasFipe = await res.json();
                document.getElementById('fipeError').classList.remove('show');
            } catch (e) {
                document.getElementById('fipeError').classList.add('show');
                console.error('Erro FIPE:', e);
            }

            const inputNome = document.getElementById('inputNome');
            inputNome.addEventListener('input', () => {
                document.getElementById('btnStep1').disabled = inputNome.value.trim().length < 2;
            });
            inputNome.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && inputNome.value.trim().length >= 2) goToStep(2);
            });

            setupAutocomplete('inputMarca', 'dropdownMarca', () => marcasFipe, 'nome', onMarcaSelected);
            setupAutocomplete('inputModelo', 'dropdownModelo', () => modelosFipe, 'nome', onModeloSelected);
            document.getElementById('selectAno').addEventListener('change', onAnoSelected);
        });

        // ===== STEP 2: TEM SEGURO (com l√≥gica condicional) =====
        function selectSeguro(value, el) {
            formData.temSeguro = value;
            el.parentElement.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');

            const mesField = document.getElementById('mesVencimentoField');
            if (value === 'sim') {
                mesField.classList.add('show');
                // Se primeiro seguro: limpa b√¥nus/sinistro defaults
                checkStep2();
            } else {
                mesField.classList.remove('show');
                formData.mesVencimento = '';
                document.getElementById('selectMesVencimento').value = '';
                // Primeiro seguro: auto-preenche b√¥nus 0 e sem sinistro
                formData.bonus = '0';
                formData.sinistro = 'nao';
                document.getElementById('btnStep2').disabled = false;
            }
        }

        function checkStep2() {
            if (formData.temSeguro === 'sim') {
                document.getElementById('btnStep2').disabled = !formData.mesVencimento;
            } else {
                document.getElementById('btnStep2').disabled = false;
            }
        }

        // ===== SMART NAVIGATION: Skip b√¥nus/sinistro for first insurance =====
        function nextAfterGaragem() {
            if (formData.temSeguro === 'nao') {
                // Primeiro seguro ‚Üí pula b√¥nus e sinistro
                goToStep(10);
            } else {
                goToStep(8);
            }
        }

        function backToBeforeReboque() {
            if (formData.temSeguro === 'nao') {
                goToStep(7); // volta para garagem
            } else {
                goToStep(9); // volta para sinistro
            }
        }

        // ===== AUTOCOMPLETE ENGINE =====
        function setupAutocomplete(inputId, dropdownId, getDataFn, labelKey, onSelectFn) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            let highlightedIdx = -1;

            input.addEventListener('input', () => {
                const val = input.value.trim().toLowerCase();
                const data = getDataFn();
                if (val.length < 1 || data.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                const filtered = data.filter(item =>
                    item[labelKey].toLowerCase().includes(val)
                ).slice(0, 30);

                if (filtered.length === 0) {
                    dropdown.innerHTML = '<div class="autocomplete-empty">Nenhum resultado encontrado</div>';
                    dropdown.classList.add('show');
                    return;
                }

                dropdown.innerHTML = filtered.map((item, idx) => {
                    const name = item[labelKey];
                    const highlighted = highlightMatch(name, val);
                    return `<div class="autocomplete-item" data-index="${idx}" data-codigo="${item.codigo}" data-nome="${name}">${highlighted}</div>`;
                }).join('');

                dropdown.classList.add('show');
                highlightedIdx = -1;

                dropdown.querySelectorAll('.autocomplete-item').forEach(el => {
                    el.addEventListener('click', () => {
                        input.value = el.dataset.nome;
                        dropdown.classList.remove('show');
                        onSelectFn(el.dataset.codigo, el.dataset.nome);
                    });
                });
            });

            input.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                if (!dropdown.classList.contains('show') || items.length === 0) return;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIdx = Math.min(highlightedIdx + 1, items.length - 1);
                    updateHighlight(items, highlightedIdx);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIdx = Math.max(highlightedIdx - 1, 0);
                    updateHighlight(items, highlightedIdx);
                } else if (e.key === 'Enter' && highlightedIdx >= 0) {
                    e.preventDefault();
                    items[highlightedIdx].click();
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }

        function highlightMatch(text, query) {
            const idx = text.toLowerCase().indexOf(query.toLowerCase());
            if (idx === -1) return text;
            return text.substring(0, idx) + '<mark>' + text.substring(idx, idx + query.length) + '</mark>' + text.substring(idx + query.length);
        }

        function updateHighlight(items, idx) {
            items.forEach((el, i) => el.classList.toggle('highlighted', i === idx));
            if (items[idx]) items[idx].scrollIntoView({ block: 'nearest' });
        }

        // ===== FIPE CALLBACKS =====
        async function onMarcaSelected(codigo, nome) {
            formData.marcaCodigo = codigo;
            formData.marcaNome = nome;
            formData.modeloCodigo = '';
            formData.modeloNome = '';
            formData.anoCodigo = '';
            formData.anoNome = '';
            formData.valorFipe = '';

            const inputModelo = document.getElementById('inputModelo');
            const selectAno = document.getElementById('selectAno');
            const fipeBox = document.getElementById('fipeBox');

            inputModelo.value = '';
            inputModelo.disabled = true;
            inputModelo.placeholder = 'Carregando modelos...';
            selectAno.innerHTML = '<option value="">Selecione o modelo primeiro</option>';
            selectAno.disabled = true;
            fipeBox.classList.remove('show');
            document.getElementById('btnStep3').disabled = true;

            try {
                const res = await fetch(`${FIPE_API}/marcas/${codigo}/modelos`);
                const data = await res.json();
                modelosFipe = data.modelos || [];
                inputModelo.disabled = false;
                inputModelo.placeholder = `Ex: Digite o modelo... (${modelosFipe.length} dispon√≠veis)`;
                inputModelo.focus();
            } catch (e) {
                inputModelo.placeholder = 'Erro ao carregar modelos';
                console.error(e);
            }
        }

        async function onModeloSelected(codigo, nome) {
            formData.modeloCodigo = codigo;
            formData.modeloNome = nome;
            formData.anoCodigo = '';
            formData.anoNome = '';
            formData.valorFipe = '';

            const selectAno = document.getElementById('selectAno');
            const fipeBox = document.getElementById('fipeBox');

            selectAno.innerHTML = '<option value="">Carregando anos...</option>';
            selectAno.disabled = true;
            fipeBox.classList.remove('show');
            document.getElementById('btnStep3').disabled = true;

            try {
                const res = await fetch(`${FIPE_API}/marcas/${formData.marcaCodigo}/modelos/${codigo}/anos`);
                anosFipe = await res.json();
                selectAno.innerHTML = '<option value="">Selecione o ano</option>' +
                    anosFipe.map(a => `<option value="${a.codigo}">${a.nome}</option>`).join('');
                selectAno.disabled = false;
            } catch (e) {
                selectAno.innerHTML = '<option value="">Erro ao carregar</option>';
                console.error(e);
            }
        }

        async function onAnoSelected() {
            const selectAno = document.getElementById('selectAno');
            const anoCodigo = selectAno.value;
            if (!anoCodigo) return;

            formData.anoCodigo = anoCodigo;
            formData.anoNome = selectAno.options[selectAno.selectedIndex].text;

            const fipeBox = document.getElementById('fipeBox');
            const fipeValue = document.getElementById('fipeValue');
            fipeValue.textContent = 'Buscando...';
            fipeBox.classList.add('show');

            try {
                const res = await fetch(`${FIPE_API}/marcas/${formData.marcaCodigo}/modelos/${formData.modeloCodigo}/anos/${anoCodigo}`);
                const data = await res.json();
                formData.valorFipe = data.Valor || '';
                fipeValue.textContent = formData.valorFipe;
                document.getElementById('btnStep3').disabled = false;
            } catch (e) {
                fipeValue.textContent = 'N√£o encontrado';
                console.error(e);
            }
        }

        // ===== OPTION SELECTION =====
        function selectOption(field, value, el) {
            formData[field] = value;
            el.parentElement.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            const stepNum = el.closest('.step').id.replace('step', '');
            const btn = document.getElementById('btnStep' + stepNum);
            if (btn) btn.disabled = false;
        }

        // ===== EXTRAS TOGGLE =====
        function toggleExtra(name, el) {
            el.classList.toggle('checked');
            if (el.classList.contains('checked')) {
                if (!formData.extras.includes(name)) formData.extras.push(name);
            } else {
                formData.extras = formData.extras.filter(e => e !== name);
            }
        }

        // ===== NAVIGATION =====
        function goToStep(step) {
            if (currentStep === 1) {
                formData.nome = document.getElementById('inputNome').value.trim();
                document.getElementById('nameDisplay1').textContent = formData.nome.split(' ')[0];
            }

            document.getElementById('step' + currentStep).classList.remove('active');
            currentStep = step;
            document.getElementById('step' + currentStep).classList.add('active');

            // Progress din√¢mico baseado nos steps vis√≠veis
            const visibleSteps = formData.temSeguro === 'nao' ? totalSteps - 2 : totalSteps;
            let effectiveStep = currentStep;
            if (formData.temSeguro === 'nao' && currentStep >= 10) {
                effectiveStep = currentStep - 2; // ajusta contagem sem b√¥nus/sinistro
            }
            const progress = Math.round((effectiveStep / visibleSteps) * 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = progress + '%';
            document.getElementById('progressLabel').textContent = `Passo ${effectiveStep} de ${visibleSteps}`;

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ===== FINAL STEP =====
        function showFinalStep() {
            const labels = {
                temSeguro: { sim: 'Tem seguro ativo', nao: 'Primeiro seguro' },
                condutor: { eu: 'O pr√≥prio', outro: 'Outra pessoa' },
                utilizacao: { particular: 'Particular (dia a dia)', profissional: 'Profissional (visita a clientes)', transporte: 'Transporte de passageiros (app/t√°xi)' },
                garagem: { fechada: 'Garagem fechada', aberta: 'Estac. aberto', rua: 'Na rua' },
                sinistro: { sim: 'Sim, teve sinistro', nao: 'N√£o teve sinistro' },
                reboque: { '200km': 'At√© 200 km', '400km': 'At√© 400 km', '600km': 'At√© 600 km', 'ilimitado': 'Km ilimitado' },
                terceiros: { '100mil': 'R$ 100 mil', '200mil': 'R$ 200 mil', '300mil': 'R$ 300 mil', '500mil': 'R$ 500 mil', '800mil': 'R$ 800 mil' },
                carroReserva: { nao: 'N√£o precisa', '7dias': '7 dias', '15dias': '15 dias', '30dias': '30 dias' },
                franquia: { basica: 'B√°sica', reduzida: 'Reduzida (50%)', 'super-reduzida': 'Super Reduzida (25%)' }
            };

            const extrasLabels = {
                vidros: 'Vidros', martelinho: 'Martelinho de Ouro',
                parachoque: 'Para-choque', pintura: 'Pintura e Lataria',
                pneu: 'Pneu, Roda e Suspens√£o'
            };

            const temApolice = formData.temSeguro === 'sim';
            const bonusLabel = formData.bonus === 'nao-sei' ? 'N√£o sabe' : (formData.bonus === '0' && !temApolice ? 'Primeiro seguro' : `B√¥nus ${formData.bonus}`);

            // Fill summary
            document.getElementById('nameDisplay2').textContent = formData.nome.split(' ')[0];
            document.getElementById('sumVeiculo').textContent = `${formData.marcaNome} ${formData.modeloNome}`;
            document.getElementById('sumAno').textContent = formData.anoNome;
            document.getElementById('sumFipe').textContent = formData.valorFipe || '--';
            document.getElementById('sumUtilizacao').textContent = labels.utilizacao[formData.utilizacao] || '--';
            document.getElementById('sumSeguro').textContent = labels.temSeguro[formData.temSeguro] || '--';
            document.getElementById('sumCondutor').textContent = labels.condutor[formData.condutor] || '--';
            document.getElementById('sumIdade').textContent = formData.idade ? formData.idade + ' anos' : '--';
            document.getElementById('sumGaragem').textContent = labels.garagem[formData.garagem] || '--';
            document.getElementById('sumReboque').textContent = labels.reboque[formData.reboque] || '--';
            document.getElementById('sumTerceiros').textContent = labels.terceiros[formData.terceiros] || '--';
            document.getElementById('sumCarroReserva').textContent = labels.carroReserva[formData.carroReserva] || '--';
            document.getElementById('sumFranquia').textContent = labels.franquia[formData.franquia] || '--';

            // Condicional: m√™s vencimento
            if (temApolice && formData.mesVencimento) {
                document.getElementById('sumMesWrap').style.display = '';
                document.getElementById('sumMesVencimento').textContent = formData.mesVencimento;
            } else {
                document.getElementById('sumMesWrap').style.display = 'none';
            }

            // Condicional: b√¥nus e sinistro
            if (temApolice) {
                document.getElementById('sumBonusWrap').style.display = '';
                document.getElementById('sumSinistroWrap').style.display = '';
                document.getElementById('sumBonus').textContent = bonusLabel;
                document.getElementById('sumSinistro').textContent = labels.sinistro[formData.sinistro] || '--';
            } else {
                document.getElementById('sumBonusWrap').style.display = 'none';
                document.getElementById('sumSinistroWrap').style.display = 'none';
            }

            const extrasText = formData.extras.length > 0
                ? formData.extras.map(e => extrasLabels[e]).join(', ')
                : 'Nenhum selecionado';
            document.getElementById('sumExtras').textContent = extrasText;

            // ===== BUILD WHATSAPP MESSAGE (com encodeURIComponent) =====
            const extrasMsg = formData.extras.length > 0
                ? formData.extras.map(e => extrasLabels[e]).join(', ')
                : 'Nenhum';

            let msgLines = [];
            msgLines.push(`Ol√°! Sou *${formData.nome}* e solicitei cota√ß√£o de Seguro Auto pelo site.`);
            msgLines.push('');
            msgLines.push(`üöó *Ve√≠culo:* ${formData.marcaNome} ${formData.modeloNome} (${formData.anoNome})`);
            msgLines.push(`üí∞ *FIPE:* ${formData.valorFipe}`);
            msgLines.push(`üõû *Utiliza√ß√£o:* ${labels.utilizacao[formData.utilizacao]}`);
            msgLines.push('');
            msgLines.push('üìã *Perfil:*');

            if (temApolice) {
                msgLines.push(`‚Ä¢ Tenho seguro ativo e quero *renovar/trocar*`);
                if (formData.mesVencimento) {
                    msgLines.push(`‚Ä¢ Vencimento: ${formData.mesVencimento}`);
                }
            } else {
                msgLines.push(`‚Ä¢ √â meu *primeiro seguro*`);
            }

            msgLines.push(`‚Ä¢ Condutor: ${labels.condutor[formData.condutor]}`);
            msgLines.push(`‚Ä¢ Idade: ${formData.idade} anos`);
            msgLines.push(`‚Ä¢ Pernoite: ${labels.garagem[formData.garagem]}`);

            if (temApolice) {
                msgLines.push(`‚Ä¢ B√¥nus: ${bonusLabel}`);
                msgLines.push(`‚Ä¢ Sinistro: ${labels.sinistro[formData.sinistro]}`);
            }

            msgLines.push('');
            msgLines.push('üõ°Ô∏è *Coberturas desejadas:*');
            msgLines.push(`‚Ä¢ Reboque: ${labels.reboque[formData.reboque]}`);
            msgLines.push(`‚Ä¢ Terceiros: ${labels.terceiros[formData.terceiros]}`);
            msgLines.push(`‚Ä¢ Carro reserva: ${labels.carroReserva[formData.carroReserva]}`);
            msgLines.push(`‚Ä¢ Franquia: ${labels.franquia[formData.franquia]}`);
            msgLines.push(`‚Ä¢ Extras: ${extrasMsg}`);
            msgLines.push('');

            if (temApolice) {
                msgLines.push('Vou te encaminhar:');
                msgLines.push('üìÑ O pdf da minha ap√≥lice anterior');
            } else {
                msgLines.push('Aguardo a melhor proposta! üôè');
            }

            const fullMsg = msgLines.join('\n');
            const whatsappUrl = `https://wa.me/5554996454300?text=${encodeURIComponent(fullMsg)}`;
            document.getElementById('btnWhatsappDirect').href = whatsappUrl;

            goToStep(15);
        }

        // ===== SAVE LEAD (Firebase) =====
        async function salvarLead() {
            const whatsapp = document.getElementById('inputWhatsapp').value.trim();
            if (!whatsapp || whatsapp.replace(/\D/g, '').length < 10) {
                alert('Informe um WhatsApp v√°lido.');
                return;
            }

            formData.whatsapp = whatsapp;
            const btn = document.getElementById('btnSalvarLead');
            btn.disabled = true;
            btn.textContent = 'Salvando...';

            try {
                await db.collection('leads_crm').add(buildLeadData(whatsapp.replace(/\D/g, ''), 'salvar_lead'));
                btn.style.display = 'none';
                document.getElementById('inputWhatsapp').style.display = 'none';
                document.getElementById('successMsg').classList.add('show');
            } catch (error) {
                console.error('Erro ao salvar lead:', error);
                alert('Erro ao salvar. Tente novamente.');
                btn.disabled = false;
                btn.textContent = 'Salvar';
            }
        }

        // ===== SAVE LEAD on WhatsApp click =====
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnWhatsappDirect').addEventListener('click', async () => {
                try {
                    await db.collection('leads_crm').add(buildLeadData('', 'whatsapp_direto'));
                } catch (e) {
                    console.error('Erro ao salvar lead WhatsApp:', e);
                }
            });
        });

        // ===== BUILD LEAD DATA (reutiliz√°vel) =====
        function buildLeadData(whatsappNum, acao) {
            return {
                nome: formData.nome,
                whatsapp: whatsappNum,
                ramo: 'auto',
                tipo: 'individual',
                status: 'pre_cadastro',
                origem: 'site',
                acao: acao,
                temSeguro: formData.temSeguro,
                mesVencimento: formData.mesVencimento || '',
                veiculo: `${formData.marcaNome} ${formData.modeloNome}`,
                anoVeiculo: formData.anoNome,
                valorFipe: formData.valorFipe,
                utilizacao: formData.utilizacao,
                condutor: formData.condutor,
                idadeCondutor: formData.idade,
                pernoite: formData.garagem,
                bonus: formData.bonus,
                sinistro: formData.sinistro,
                reboque: formData.reboque,
                terceiros: formData.terceiros,
                carroReserva: formData.carroReserva,
                extras: formData.extras,
                franquia: formData.franquia,
                indicadoPorCodigo: indicadorCodigo,
                empresaParceiraCodigo: empresaParceiraCodigo,
                criadoEm: firebase.firestore.FieldValue.serverTimestamp()
            };
        }

        // ===== PHONE MASK =====
        function formatPhone(input) {
            let val = input.value.replace(/\D/g, '');
            if (val.length > 11) val = val.substring(0, 11);
            if (val.length > 6) {
                input.value = `(${val.substring(0,2)}) ${val.substring(2,7)}-${val.substring(7)}`;
            } else if (val.length > 2) {
                input.value = `(${val.substring(0,2)}) ${val.substring(2)}`;
            } else if (val.length > 0) {
                input.value = `(${val}`;
            }
        }
    </script>
</body>
</html>
