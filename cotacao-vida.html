<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cota√ß√£o Seguro de Vida | Retorno Seguros</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #00b8d4;
            --primary-dark: #0088aa;
            --primary-deeper: #006d88;
            --dark-header: #0a0a14;
            --dark-header-border: rgba(0,184,212,0.15);
            --bg-start: #f0f4f8;
            --bg-end: #e8eef3;
            --bg-card: #ffffff;
            --text: #1a2a3a;
            --text-secondary: #546878;
            --text-muted: #8a9ab0;
            --border: #dce4ec;
            --border-light: #e8eef3;
            --success: #10b981;
            --success-bg: #ecfdf5;
            --shadow-card: 0 2px 12px rgba(0,40,80,0.06), 0 1px 3px rgba(0,40,80,0.04);
            --shadow-hover: 0 8px 30px rgba(0,40,80,0.1), 0 2px 8px rgba(0,40,80,0.06);
            --shadow-btn: 0 4px 14px rgba(0,136,170,0.25);
            --gradient-btn: linear-gradient(135deg, #00c4e0 0%, #0090cc 50%, #0070b8 100%);
            --gradient-btn-hover: linear-gradient(135deg, #00d4f0 0%, #00a0dc 50%, #0080c8 100%);
            --radius: 16px;
            --radius-sm: 12px;
            --radius-xs: 8px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(170deg, var(--bg-start) 0%, var(--bg-end) 100%);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse at 20% 0%, rgba(0,184,212,0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(0,102,255,0.03) 0%, transparent 50%);
            pointer-events: none; z-index: 0;
        }

        /* LOADER */
        .page-loader {
            position: fixed; inset: 0;
            background: var(--dark-header);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.4s;
        }
        .page-loader.hide { opacity: 0; pointer-events: none; }
        .loader-content { text-align: center; color: white; }
        .loader-spinner {
            width: 36px; height: 36px; margin: 0 auto 14px;
            border: 3px solid rgba(0,184,212,0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .loader-content p { font-size: 0.85rem; color: rgba(255,255,255,0.6); }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* HEADER */
        .header {
            background: var(--dark-header);
            border-bottom: 1px solid var(--dark-header-border);
            padding: 14px 20px;
            position: sticky; top: 0; z-index: 100;
        }
        .header-inner {
            max-width: 540px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-logo { text-decoration: none; display: flex; align-items: center; }
        .header-logo img {
            height: 34px; max-width: 160px; object-fit: contain;
            filter: brightness(0) invert(1);
        }
        .header-badge {
            font-size: 0.72rem; font-weight: 600;
            background: rgba(0,184,212,0.12);
            color: var(--primary);
            padding: 5px 12px; border-radius: 20px;
            border: 1px solid rgba(0,184,212,0.2);
            letter-spacing: 0.3px;
        }

        /* PROGRESS */
        .progress-wrap {
            max-width: 540px; margin: 0 auto;
            padding: 14px 24px 0;
            position: relative; z-index: 1;
        }
        .progress-info {
            display: flex; justify-content: space-between;
            font-size: 0.72rem; font-weight: 600;
            color: var(--text-muted); margin-bottom: 6px;
        }
        .progress-bar {
            height: 5px; background: #dce4ec;
            border-radius: 10px; overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--gradient-btn);
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* CONTAINER */
        .container {
            max-width: 540px; margin: 0 auto;
            padding: 20px 24px 40px;
            position: relative; z-index: 1;
        }

        /* STEPS */
        .step { display: none; animation: stepIn 0.4s ease; }
        .step.active { display: block; }
        @keyframes stepIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 30px 24px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-light);
        }

        .step-icon { font-size: 2rem; margin-bottom: 10px; text-align: center; }
        .step-title {
            font-size: 1.28rem; font-weight: 800; text-align: center;
            color: var(--text); margin-bottom: 4px; letter-spacing: -0.3px;
        }
        .step-subtitle {
            font-size: 0.85rem; color: var(--text-secondary); text-align: center;
            margin-bottom: 22px; line-height: 1.55;
        }

        /* INPUTS */
        .input-group { margin-bottom: 16px; }
        .input-label {
            display: block; font-size: 0.75rem; font-weight: 600;
            color: var(--text-secondary); margin-bottom: 6px;
            text-transform: uppercase; letter-spacing: 0.4px;
        }
        .input-field {
            width: 100%; padding: 13px 16px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-xs);
            font-size: 0.92rem; font-family: inherit;
            color: var(--text); background: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
        }
        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,184,212,0.1);
        }
        .input-field::placeholder { color: var(--text-muted); }

        select.input-field {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238a9ab0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 36px;
        }

        .input-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }

        /* AGE BADGE */
        .age-badge {
            display: none; text-align: center;
            background: rgba(0,184,212,0.08);
            border: 1px solid rgba(0,184,212,0.15);
            border-radius: var(--radius-xs);
            padding: 10px; margin-top: 8px; margin-bottom: 8px;
        }
        .age-badge.show { display: block; animation: stepIn 0.3s ease; }
        .age-badge .age-value {
            font-size: 1.5rem; font-weight: 800; color: var(--primary-dark);
        }
        .age-badge .age-label {
            font-size: 0.8rem; color: var(--text-secondary); margin-left: 4px;
        }

        /* AUTOCOMPLETE */
        .autocomplete-wrap { position: relative; }
        .autocomplete-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white;
            border: 1.5px solid var(--primary);
            border-top: none;
            border-radius: 0 0 var(--radius-xs) var(--radius-xs);
            max-height: 220px; overflow-y: auto;
            z-index: 50;
            box-shadow: 0 8px 24px rgba(0,40,80,0.12);
            display: none;
        }
        .autocomplete-list.show { display: block; }
        .autocomplete-item {
            padding: 11px 16px;
            font-size: 0.88rem; color: var(--text);
            cursor: pointer; border-bottom: 1px solid var(--border-light);
            transition: background 0.15s;
        }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:hover, .autocomplete-item.highlighted {
            background: rgba(0,184,212,0.08);
        }
        .autocomplete-item .match {
            font-weight: 700; color: var(--primary-dark);
        }
        .autocomplete-selected {
            display: none; align-items: center; gap: 8px;
            background: rgba(0,184,212,0.06);
            border: 1.5px solid rgba(0,184,212,0.2);
            border-radius: var(--radius-xs);
            padding: 12px 16px; margin-top: 8px;
        }
        .autocomplete-selected.show { display: flex; }
        .autocomplete-selected span { font-size: 0.88rem; font-weight: 600; color: var(--text); flex: 1; }
        .autocomplete-selected button {
            background: none; border: none; cursor: pointer;
            color: var(--text-muted); font-size: 1.1rem;
            padding: 2px 6px; border-radius: 6px;
            transition: background 0.2s;
        }
        .autocomplete-selected button:hover { background: rgba(0,0,0,0.06); }

        /* OPTION CARDS */
        .options-grid { display: grid; gap: 10px; }
        .options-grid.cols-2 { grid-template-columns: 1fr 1fr; }

        .option-card {
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px;
            cursor: pointer;
            transition: all 0.25s;
            text-align: center;
            background: #fff;
        }
        .option-card:hover {
            border-color: rgba(0,184,212,0.4);
            box-shadow: 0 4px 12px rgba(0,184,212,0.08);
        }
        .option-card.selected {
            border-color: var(--primary);
            background: rgba(0,184,212,0.04);
            box-shadow: 0 0 0 3px rgba(0,184,212,0.1);
        }
        .option-card .oc-icon { font-size: 1.6rem; margin-bottom: 6px; }
        .option-card .oc-text { font-size: 0.85rem; font-weight: 600; color: var(--text); }
        .option-card .oc-desc {
            font-size: 0.72rem; color: var(--primary-dark); font-weight: 600;
            margin-top: 3px;
        }

        /* CAPITAL SLIDER */
        .capital-section { text-align: center; margin-bottom: 16px; }
        .capital-value {
            font-size: 2rem; font-weight: 800; color: var(--primary-dark);
            margin-bottom: 8px; letter-spacing: -0.5px;
        }
        .capital-slider {
            width: 100%; height: 6px; appearance: none;
            background: #e0e6ec; border-radius: 10px; outline: none;
            margin-bottom: 8px;
        }
        .capital-slider::-webkit-slider-thumb {
            appearance: none; width: 24px; height: 24px;
            background: var(--gradient-btn);
            border-radius: 50%; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,136,170,0.3);
        }
        .capital-slider::-moz-range-thumb {
            width: 24px; height: 24px;
            background: var(--gradient-btn);
            border-radius: 50%; cursor: pointer; border: none;
            box-shadow: 0 2px 8px rgba(0,136,170,0.3);
        }
        .capital-range {
            display: flex; justify-content: space-between;
            font-size: 0.72rem; color: var(--text-muted); font-weight: 600;
            margin-bottom: 12px;
        }
        .capital-tip {
            background: rgba(0,184,212,0.06);
            border: 1px solid rgba(0,184,212,0.12);
            border-radius: var(--radius-xs);
            padding: 12px 14px;
            font-size: 0.82rem; color: var(--text-secondary);
            line-height: 1.5;
        }
        .capital-tip strong { color: var(--primary-dark); }

        /* COVERAGE TOGGLES */
        .coverage-section { margin-bottom: 18px; }
        .coverage-section-title {
            font-size: 0.75rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px;
            color: var(--text-secondary); margin-bottom: 10px;
        }
        .coverage-item {
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px 16px; margin-bottom: 8px;
            transition: all 0.25s;
            background: #fff;
        }
        .coverage-item.active {
            border-color: rgba(0,184,212,0.35);
            background: rgba(0,184,212,0.03);
        }
        .coverage-header {
            display: flex; align-items: center; gap: 12px;
        }

        /* TOGGLE SWITCH */
        .toggle {
            width: 44px; height: 24px; flex-shrink: 0;
            background: #d1d5db; border-radius: 12px;
            position: relative; cursor: pointer;
            transition: background 0.25s;
        }
        .toggle::after {
            content: '';
            position: absolute; top: 2px; left: 2px;
            width: 20px; height: 20px;
            background: white; border-radius: 50%;
            transition: transform 0.25s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .toggle.on { background: var(--primary); }
        .toggle.on::after { transform: translateX(20px); }
        .toggle.locked { opacity: 0.7; cursor: default; }

        .coverage-info { flex: 1; min-width: 0; }
        .coverage-name {
            font-size: 0.85rem; font-weight: 700; color: var(--text);
            display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
        }
        .coverage-desc {
            font-size: 0.76rem; color: var(--text-muted); margin-top: 2px; line-height: 1.4;
        }
        .coverage-badge {
            font-size: 0.62rem; font-weight: 700;
            background: linear-gradient(135deg, rgba(0,184,212,0.15), rgba(0,136,170,0.15));
            color: var(--primary-dark);
            padding: 2px 8px; border-radius: 10px;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .coverage-value-input {
            width: 110px; padding: 7px 10px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-xs);
            font-size: 0.82rem; font-weight: 600;
            font-family: inherit; color: var(--text);
            text-align: center; outline: none;
            flex-shrink: 0;
            transition: border-color 0.2s;
        }
        .coverage-value-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,184,212,0.1);
        }

        .tip-box {
            background: rgba(0,184,212,0.05);
            border: 1px solid rgba(0,184,212,0.12);
            border-radius: var(--radius-xs);
            padding: 12px 14px; margin-top: 14px;
            font-size: 0.8rem; color: var(--text-secondary);
            line-height: 1.5;
        }
        .tip-box strong { color: var(--primary-dark); }

        /* BUTTONS */
        .btn-row {
            display: flex; gap: 10px; margin-top: 22px;
        }
        .btn {
            flex: 1; padding: 13px 20px;
            border-radius: var(--radius-xs);
            font-size: 0.9rem; font-weight: 700;
            font-family: inherit; cursor: pointer;
            transition: all 0.25s; border: none;
        }
        .btn-primary {
            background: var(--gradient-btn); color: white;
            box-shadow: var(--shadow-btn);
        }
        .btn-primary:hover:not(:disabled) {
            background: var(--gradient-btn-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,136,170,0.3);
        }
        .btn-primary:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }
        .btn-back {
            background: var(--bg-start); color: var(--text-secondary);
            border: 1.5px solid var(--border); flex: 0 0 auto;
            padding: 13px 18px;
        }
        .btn-back:hover { background: #e4eaf0; }

        /* SUMMARY */
        .summary-section { margin-bottom: 16px; }
        .summary-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px;
        }
        .summary-title {
            font-size: 0.72rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.8px;
            color: var(--primary-dark);
        }
        .summary-edit {
            font-size: 0.72rem; font-weight: 600;
            color: var(--primary); cursor: pointer;
            text-decoration: underline;
        }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .summary-item {
            padding: 9px 12px;
            background: #f6f8fa;
            border-radius: var(--radius-xs);
        }
        .summary-item.full { grid-column: 1 / -1; }
        .summary-label { font-size: 0.68rem; color: var(--text-muted); font-weight: 600; margin-bottom: 1px; text-transform: uppercase; letter-spacing: 0.3px; }
        .summary-value { font-size: 0.85rem; font-weight: 600; color: var(--text); }

        .summary-coverages {
            display: grid; grid-template-columns: 1fr 1fr; gap: 6px;
            margin-top: 8px;
        }
        .summary-cov-item {
            background: #f6f8fa;
            border-radius: var(--radius-xs);
            padding: 10px; text-align: center;
        }
        .summary-cov-icon { font-size: 1.1rem; margin-bottom: 3px; }
        .summary-cov-name { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 2px; }
        .summary-cov-value { font-size: 0.8rem; font-weight: 700; color: var(--primary-dark); }

        /* CTA */
        .cta-divider { display: flex; align-items: center; gap: 12px; margin: 26px 0 18px; }
        .cta-divider::before, .cta-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .cta-divider span { font-size: 0.95rem; font-weight: 700; color: var(--text); white-space: nowrap; }

        .cta-option {
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            padding: 22px; margin-bottom: 12px;
            transition: all 0.3s; background: #fff;
        }
        .cta-option:hover { border-color: var(--primary); box-shadow: var(--shadow-card); }
        .cta-option.highlight {
            border-color: rgba(37,211,102,0.4);
            background: rgba(37,211,102,0.02);
        }
        .cta-option-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .cta-option-icon {
            width: 42px; height: 42px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; flex-shrink: 0;
        }
        .cta-option-icon.save {
            background: rgba(0,184,212,0.1);
            border: 1px solid rgba(0,184,212,0.15);
            color: var(--primary-dark);
        }
        .cta-option-title { font-size: 0.95rem; font-weight: 700; color: var(--text); }
        .cta-option-desc { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px; }

        .whatsapp-input-row { display: flex; gap: 8px; }
        .whatsapp-input-row .input-field { flex: 1; }
        .whatsapp-input-row .btn { flex: 0 0 auto; padding: 13px 20px; }

        .cta-btn-whatsapp {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 14px;
            background: #25d366; color: white;
            border: none; border-radius: var(--radius-xs);
            font-size: 0.95rem; font-weight: 700; font-family: inherit;
            cursor: pointer; transition: all 0.25s; text-decoration: none;
        }
        .cta-btn-whatsapp:hover {
            background: #20bd5a; transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(37,211,102,0.3);
        }
        .cta-btn-whatsapp svg { width: 20px; height: 20px; fill: white; }

        .success-msg {
            display: none; text-align: center; padding: 18px;
            background: var(--success-bg);
            border: 1px solid rgba(16,185,129,0.2);
            border-radius: var(--radius-sm);
            margin-top: 12px; animation: stepIn 0.3s ease;
        }
        .success-msg.show { display: block; }
        .success-msg .success-icon { font-size: 2.2rem; margin-bottom: 6px; }
        .success-msg .success-title { font-size: 1rem; font-weight: 700; color: var(--text); }
        .success-msg .success-desc { font-size: 0.82rem; color: var(--text-secondary); margin-top: 3px; }

        @media (max-width: 480px) {
            .step-card { padding: 24px 18px; }
            .step-title { font-size: 1.18rem; }
            .options-grid.cols-2 { grid-template-columns: 1fr 1fr; }
            .summary-grid { grid-template-columns: 1fr; }
            .summary-coverages { grid-template-columns: 1fr 1fr; }
            .summary-item.full { grid-column: auto; }
            .whatsapp-input-row { flex-direction: column; }
            .header-logo img { height: 30px; max-width: 140px; }
            .container { padding: 16px 16px 32px; }
            .input-row { grid-template-columns: 1fr 1fr; }
            .coverage-value-input { width: 95px; font-size: 0.78rem; }
        }
    </style>
</head>
<body>
    <div class="page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <p>Carregando cota√ß√£o...</p>
        </div>
    </div>

    <!-- HEADER -->
    <div class="header">
        <div class="header-inner">
            <a href="https://www.retornoseguros.com/" class="header-logo">
                <img src="logo-retorno-completa.png" alt="Retorno Seguros e Benef√≠cios">
            </a>
            <div class="header-badge">‚ù§Ô∏è Seguro de Vida</div>
        </div>
    </div>

    <div class="progress-wrap">
        <div class="progress-info">
            <span id="progressLabel">Passo 1 de 7</span>
            <span id="progressPercent">14%</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 14%"></div>
        </div>
    </div>

    <div class="container">

        <!-- STEP 1: Nome -->
        <div class="step active" id="step1">
            <div class="step-card">
                <div class="step-icon">‚ù§Ô∏è</div>
                <h2 class="step-title">Proteja quem voc√™ ama</h2>
                <p class="step-subtitle">Vamos criar uma prote√ß√£o sob medida para voc√™ e sua fam√≠lia. Como posso te chamar?</p>
                <div class="input-group">
                    <input type="text" class="input-field" id="inputNome" placeholder="Seu nome" autocomplete="given-name">
                </div>
                <div class="btn-row">
                    <button class="btn btn-primary" id="btnStep1" onclick="goToStep(2)" disabled>Come√ßar</button>
                </div>
            </div>
        </div>

        <!-- STEP 2: Data Nascimento + Sexo -->
        <div class="step" id="step2">
            <div class="step-card">
                <div class="step-icon">üéÇ</div>
                <h2 class="step-title">Ol√°, <span id="nameDisplay1"></span>!</h2>
                <p class="step-subtitle">Precisamos de alguns dados para personalizar sua prote√ß√£o</p>
                <div class="input-row">
                    <div class="input-group">
                        <label class="input-label">Data de nascimento</label>
                        <input type="date" class="input-field" id="inputNascimento">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Sexo</label>
                        <select class="input-field" id="inputSexo">
                            <option value="">Selecione</option>
                            <option value="M">Masculino</option>
                            <option value="F">Feminino</option>
                        </select>
                    </div>
                </div>
                <div class="age-badge" id="ageBadge">
                    <span class="age-value" id="ageValue">30</span>
                    <span class="age-label">anos</span>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(1)">Voltar</button>
                    <button class="btn btn-primary" id="btnStep2" onclick="goToStep(3)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 3: Profiss√£o + Renda -->
        <div class="step" id="step3">
            <div class="step-card">
                <div class="step-icon">üíº</div>
                <h2 class="step-title">Sua atividade profissional</h2>
                <p class="step-subtitle">Isso nos ajuda a sugerir as melhores coberturas</p>
                <div class="input-group">
                    <label class="input-label">Profiss√£o</label>
                    <div class="autocomplete-wrap" id="profissaoWrap">
                        <input type="text" class="input-field" id="inputProfissao" placeholder="Digite sua profiss√£o..." autocomplete="off">
                        <div class="autocomplete-list" id="profissaoList"></div>
                    </div>
                    <div class="autocomplete-selected" id="profissaoSelected">
                        <span id="profissaoSelectedText"></span>
                        <button onclick="clearProfissao()" title="Limpar">‚úï</button>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">Renda mensal</label>
                    <select class="input-field" id="inputRenda">
                        <option value="">Selecione sua faixa</option>
                        <option value="2000">At√© R$ 2.000</option>
                        <option value="3000">R$ 2.000 a R$ 3.000</option>
                        <option value="5000">R$ 3.000 a R$ 5.000</option>
                        <option value="7500">R$ 5.000 a R$ 7.500</option>
                        <option value="10000">R$ 7.500 a R$ 10.000</option>
                        <option value="15000">R$ 10.000 a R$ 15.000</option>
                        <option value="20000">R$ 15.000 a R$ 20.000</option>
                        <option value="30000">Acima de R$ 20.000</option>
                    </select>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(2)">Voltar</button>
                    <button class="btn btn-primary" id="btnStep3" onclick="goToStep(4)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 4: Fam√≠lia -->
        <div class="step" id="step4">
            <div class="step-card">
                <div class="step-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                <h2 class="step-title">Sua fam√≠lia</h2>
                <p class="step-subtitle">Quem depende de voc√™ financeiramente?</p>
                <div class="options-grid cols-2">
                    <div class="option-card" onclick="selectFamilia(this, 'solteiro')">
                        <div class="oc-icon">üë§</div>
                        <div class="oc-text">Solteiro(a)</div>
                        <div class="oc-desc">Sem dependentes</div>
                    </div>
                    <div class="option-card" onclick="selectFamilia(this, 'casal')">
                        <div class="oc-icon">üë´</div>
                        <div class="oc-text">Casado(a)</div>
                        <div class="oc-desc">Uni√£o est√°vel</div>
                    </div>
                    <div class="option-card" onclick="selectFamilia(this, 'filhos_pequenos')">
                        <div class="oc-icon">üë∂</div>
                        <div class="oc-text">Filhos menores</div>
                        <div class="oc-desc">Prote√ß√£o essencial!</div>
                    </div>
                    <div class="option-card" onclick="selectFamilia(this, 'filhos_adultos')">
                        <div class="oc-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <div class="oc-text">Filhos adultos</div>
                        <div class="oc-desc">J√° independentes</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(3)">Voltar</button>
                    <button class="btn btn-primary" id="btnStep4" onclick="goToStep(5)" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 5: Capital -->
        <div class="step" id="step5">
            <div class="step-card">
                <div class="step-icon">üõ°Ô∏è</div>
                <h2 class="step-title">Quanto de prote√ß√£o?</h2>
                <p class="step-subtitle">Escolha o valor que sua fam√≠lia receberia em caso de necessidade</p>
                <div class="capital-section">
                    <div class="capital-value" id="capitalDisplay">R$ 100.000</div>
                    <input type="range" class="capital-slider" id="capitalSlider" min="50000" max="2000000" step="50000" value="100000" oninput="updateCapital()">
                    <div class="capital-range">
                        <span>R$ 50 mil</span>
                        <span>R$ 2 milh√µes</span>
                    </div>
                </div>
                <div class="capital-tip" id="capitalTip">
                    <strong>üí° Dica:</strong> Especialistas recomendam de 5 a 10 anos de renda. Para voc√™, sugerimos <strong id="capitalSugerido">R$ 300.000</strong>.
                </div>
                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(4)">Voltar</button>
                    <button class="btn btn-primary" onclick="goToStep(6)">Continuar</button>
                </div>
            </div>
        </div>

        <!-- STEP 6: Coberturas -->
        <div class="step" id="step6">
            <div class="step-card">
                <div class="step-icon">üõ°Ô∏è</div>
                <h2 class="step-title">Monte sua prote√ß√£o</h2>
                <p class="step-subtitle">Selecionamos coberturas para seu perfil. Ajuste como quiser!</p>

                <!-- Sempre inclusos -->
                <div class="coverage-section">
                    <div class="coverage-section-title">‚úÖ Sempre inclusos</div>
                    <div class="coverage-item active">
                        <div class="coverage-header">
                            <div class="toggle on locked"></div>
                            <div class="coverage-info">
                                <div class="coverage-name">üîí Morte (natural ou acidental)</div>
                                <div class="coverage-desc">Sua fam√≠lia recebe o capital se voc√™ falecer por qualquer causa</div>
                            </div>
                            <span class="coverage-value-input" style="border: none; background: #f0f4f8; cursor: default;" id="valMorte">R$ 100k</span>
                        </div>
                    </div>
                    <div class="coverage-item active">
                        <div class="coverage-header">
                            <div class="toggle on locked"></div>
                            <div class="coverage-info">
                                <div class="coverage-name">‚ö° Morte Acidental (dobra o valor)</div>
                                <div class="coverage-desc">Se a causa for acidental, sua fam√≠lia recebe o dobro</div>
                            </div>
                            <span class="coverage-value-input" style="border: none; background: #f0f4f8; cursor: default;" id="valMA">+R$ 100k</span>
                        </div>
                    </div>
                </div>

                <!-- Opcionais -->
                <div class="coverage-section">
                    <div class="coverage-section-title">‚≠ê Coberturas adicionais</div>
                    <div id="optionalCoverages"></div>
                </div>

                <div class="tip-box" id="coverageTip">
                    <strong>üí° Sugest√£o Retorno:</strong> <span id="coverageTipText">Selecionamos as coberturas mais importantes para seu perfil.</span>
                </div>

                <div class="btn-row">
                    <button class="btn btn-back" onclick="goToStep(5)">Voltar</button>
                    <button class="btn btn-primary" onclick="goToStep(7)">Ver resumo</button>
                </div>
            </div>
        </div>

        <!-- STEP 7: Resumo + CTA -->
        <div class="step" id="step7">
            <div class="step-card">
                <div class="step-icon">üéØ</div>
                <h2 class="step-title"><span id="nameDisplay2"></span>, aqui est√° o resumo!</h2>
                <p class="step-subtitle">Confira tudo o que voc√™ selecionou:</p>

                <!-- Dados pessoais -->
                <div class="summary-section">
                    <div class="summary-header">
                        <span class="summary-title">üë§ Seus dados</span>
                        <span class="summary-edit" onclick="goToStep(2)">editar</span>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Idade</div>
                            <div class="summary-value" id="sumIdade">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Sexo</div>
                            <div class="summary-value" id="sumSexo">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Profiss√£o</div>
                            <div class="summary-value" id="sumProfissao">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Fam√≠lia</div>
                            <div class="summary-value" id="sumFamilia">-</div>
                        </div>
                    </div>
                </div>

                <!-- Coberturas -->
                <div class="summary-section">
                    <div class="summary-header">
                        <span class="summary-title">üõ°Ô∏è Coberturas selecionadas</span>
                        <span class="summary-edit" onclick="goToStep(6)">editar</span>
                    </div>
                    <div class="summary-coverages" id="sumCoverages"></div>
                </div>

                <!-- CTA -->
                <div class="cta-divider"><span>ü§ù Estamos juntos nessa?</span></div>

                <div id="ctaFase1">
                    <div class="cta-option">
                        <div class="cta-option-header">
                            <div class="cta-option-icon save">üì±</div>
                            <span class="cta-option-title">Deixe seu WhatsApp</span>
                        </div>
                        <p class="cta-option-desc">Salve seu n√∫mero para receber a melhor proposta. Sem spam, prometemos! ü§û</p>
                        <div class="whatsapp-input-row">
                            <input type="tel" class="input-field" id="inputWhatsapp" placeholder="(54) 99999-9999" maxlength="15" oninput="formatPhone(this)">
                            <button class="btn btn-primary" onclick="salvarLead()">Salvar</button>
                        </div>
                    </div>
                </div>

                <div id="ctaFase2" style="display:none;">
                    <div class="success-msg show">
                        <div class="success-icon">‚úÖ</div>
                        <div class="success-title">N√∫mero salvo com sucesso!</div>
                        <div class="success-desc">Agora √© s√≥ iniciar a conversa no WhatsApp üëá</div>
                    </div>
                    <div style="margin-top: 14px;">
                        <a class="cta-btn-whatsapp" id="whatsappBtn" href="#" target="_blank" onclick="registrarClique()">
                            <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            Estou dentro! Vamos nessa! üí™
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29"
        });
        const db = firebase.firestore();

        // ===========================================================
        // PROFISS√ïES AUTOCOMPLETE
        // ===========================================================
        const profissoes = [
            // Engenharias
            'Engenheiro(a) Civil','Engenheiro(a) Mec√¢nico(a)','Engenheiro(a) El√©trico(a)',
            'Engenheiro(a) de Produ√ß√£o','Engenheiro(a) Qu√≠mico(a)','Engenheiro(a) Ambiental',
            'Engenheiro(a) de Software','Engenheiro(a) de Computa√ß√£o','Engenheiro(a) Agr√¥nomo(a)',
            'Engenheiro(a) de Alimentos','Engenheiro(a) de Minas','Engenheiro(a) de Petr√≥leo',
            'Engenheiro(a) de Telecomunica√ß√µes','Engenheiro(a) de Seguran√ßa do Trabalho',
            // Sa√∫de
            'M√©dico(a)','M√©dico(a) Veterin√°rio(a)','Enfermeiro(a)','Dentista',
            'Fisioterapeuta','Farmac√™utico(a)','Nutricionista','Psic√≥logo(a)',
            'Fonoaudi√≥logo(a)','Terapeuta Ocupacional','Biom√©dico(a)',
            'T√©cnico(a) de Enfermagem','Auxiliar de Enfermagem',
            // Direito
            'Advogado(a)','Juiz(a)','Promotor(a)','Defensor(a) P√∫blico(a)',
            'Delegado(a)','Oficial de Justi√ßa','Escriv√£o(√£)',
            // Educa√ß√£o
            'Professor(a)','Professor(a) Universit√°rio(a)','Pedagogo(a)',
            'Diretor(a) Escolar','Coordenador(a) Pedag√≥gico(a)','Educador(a) F√≠sico(a)',
            // Cont√°beis e Finan√ßas
            'Contador(a)','Auditor(a)','Analista Financeiro(a)','Economista',
            'Analista de Investimentos','Controller','Tesoureiro(a)',
            // TI e Tecnologia
            'Programador(a)','Desenvolvedor(a) de Software','Analista de Sistemas',
            'Cientista de Dados','Analista de TI','DBA - Administrador de Banco de Dados',
            'Designer UX/UI','Web Designer','Suporte T√©cnico de TI',
            'Gerente de TI','Analista de Seguran√ßa da Informa√ß√£o',
            // Administra√ß√£o e Gest√£o
            'Administrador(a)','Administrador(a) de Empresas','Gerente Comercial',
            'Gerente de Projetos','Gerente Administrativo(a)','Gerente de RH',
            'Analista de RH','Consultor(a) Empresarial','Secret√°rio(a) Executivo(a)',
            // Com√©rcio e Vendas
            'Vendedor(a)','Representante Comercial','Corretor(a) de Im√≥veis',
            'Corretor(a) de Seguros','Comprador(a)','Lojista','Comerciante','Balconista',
            // Ind√∫stria e Produ√ß√£o
            'T√©cnico(a) em Mec√¢nica','T√©cnico(a) em Eletricidade','T√©cnico(a) em Eletr√¥nica',
            'T√©cnico(a) em Automa√ß√£o','T√©cnico(a) em Seguran√ßa do Trabalho',
            'Operador(a) de M√°quinas','Soldador(a)','Torneiro(a) Mec√¢nico(a)',
            'Eletricista','Encanador(a)','Caldeireiro(a)',
            // Constru√ß√£o
            'Arquiteto(a)','Pedreiro(a)','Mestre de Obras','Pintor(a)',
            'Carpinteiro(a)','Marceneiro(a)','Vidraceiro(a)','Gesseiro(a)',
            // Transporte e Log√≠stica
            'Motorista','Caminhoneiro(a)','Piloto(a)','Comiss√°rio(a) de Bordo',
            'Maquinista','Marinheiro(a)','Operador(a) de Empilhadeira',
            'Analista de Log√≠stica','Despachante',
            // Agro
            'Agricultor(a)','Produtor(a) Rural','T√©cnico(a) Agr√≠cola',
            'Zootecnista','Agr√¥nomo(a)','Tratorista','Veterin√°rio(a)',
            // Comunica√ß√£o e Marketing
            'Jornalista','Publicit√°rio(a)','Rela√ß√µes P√∫blicas',
            'Analista de Marketing','Social Media','Fot√≥grafo(a)',
            'Cinegrafista','Editor(a) de V√≠deo','Produtor(a) de Conte√∫do',
            'Designer Gr√°fico(a)','Redator(a)',
            // Seguran√ßa
            'Policial Militar','Policial Civil','Bombeiro(a)',
            'Vigilante','Seguran√ßa','Agente Penitenci√°rio(a)',
            // Servi√ßos
            'Cabeleireiro(a)','Barbeiro(a)','Esteticista','Manicure/Pedicure',
            'Cozinheiro(a)','Chef de Cozinha','Gar√ßom/Gar√ßonete','Barman/Barmaid',
            'Padeiro(a)','Confeiteiro(a)','A√ßougueiro(a)',
            // Outros
            'Empres√°rio(a)','Aut√¥nomo(a)','Servidor(a) P√∫blico(a)','Militar',
            'Aposentado(a)','Estudante','Do lar','Dona de casa',
            'Assistente Social','Bibliotec√°rio(a)','Cientista','Pesquisador(a)',
            'Carteiro(a)','Eletrot√©cnico(a)','Mec√¢nico(a)','Funileiro(a)',
            'Tapeceiro(a)','Costureiro(a)','Alfaiate','Sapateiro(a)',
            'Joalheiro(a)','Relojoeiro(a)','Serralheiro(a)','Vidraceiro(a)',
            'T√©cnico(a) em Radiologia','T√©cnico(a) em Laborat√≥rio',
            'T√©cnico(a) em Inform√°tica','T√©cnico(a) em Contabilidade',
            'Auxiliar Administrativo(a)','Recepcionista','Porteiro(a)',
            'Zelador(a)','Faxineiro(a)','Diarista',
            'Taxista','Motorista de Aplicativo','Entregador(a)',
            'Tradutor(a)','Int√©rprete','M√∫sico(a)','Ator/Atriz',
            'Artes√£o(√£)','Personal Trainer','Coach','Corretor(a) de Valores'
        ].sort((a, b) => a.localeCompare(b, 'pt-BR'));

        // ===========================================================
        // STATE
        // ===========================================================
        let currentStep = 1;
        const totalSteps = 7;

        const formData = {
            nome: '', dataNascimento: '', idade: 0, sexo: '',
            profissao: '', ocupacaoTipo: '', renda: 0,
            familia: '', capital: 100000,
            coberturas: {}
        };

        let indicacaoData = { codigo: null, nome: null };
        let empresaParceiraData = { codigo: null, nome: null };
        let leadSalvoId = null;

        // Coverage config
        const coberturasConfig = {
            ipa: {
                nome: 'ü¶æ Invalidez por Acidente (IPA)',
                desc: 'Se um acidente te deixar inv√°lido, voc√™ recebe o capital em vida',
                icon: 'ü¶æ', label: 'IPA',
                valorPadrao: null, // will use capital
                unidade: '', formato: 'money',
                recomendadoPara: ['empregado', 'autonomo', 'empresario']
            },
            ifpd: {
                nome: 'üè• Invalidez por Doen√ßa (IFPD)',
                desc: 'Se uma doen√ßa te deixar totalmente inv√°lido, antecipa o capital',
                icon: 'üè•', label: 'IFPD',
                valorPadrao: null,
                unidade: '', formato: 'money',
                recomendadoPara: ['filhos_pequenos', 'casal']
            },
            doencasGraves: {
                nome: 'üéóÔ∏è Doen√ßas Graves',
                desc: 'Diagn√≥stico de c√¢ncer, infarto, AVC e outras 27 doen√ßas ‚Äî recebe para tratamento',
                icon: 'üéóÔ∏è', label: 'D. Graves',
                valorPadrao: 50000,
                unidade: '', formato: 'mil',
                recomendadoPara: ['filhos_pequenos', 'casal']
            },
            dih: {
                nome: 'üè® Di√°ria de Interna√ß√£o',
                desc: 'Se ficar internado, recebe por dia (at√© 90 dias)',
                icon: 'üè®', label: 'Di√°ria',
                valorPadrao: 200,
                unidade: '/dia', formato: 'dia',
                recomendadoPara: []
            },
            funeral: {
                nome: '‚ö±Ô∏è Assist√™ncia Funeral Familiar',
                desc: 'Cobre despesas de funeral para toda a fam√≠lia',
                icon: '‚ö±Ô∏è', label: 'Funeral',
                valorPadrao: 10000,
                unidade: '', formato: 'mil',
                recomendadoPara: ['casal', 'filhos_pequenos', 'filhos_adultos']
            }
        };

        // ===========================================================
        // PROGRESS
        // ===========================================================
        function updateProgress() {
            const pct = Math.round((currentStep / totalSteps) * 100);
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('progressPercent').textContent = pct + '%';
            document.getElementById('progressLabel').textContent = `Passo ${currentStep} de ${totalSteps}`;
        }

        // ===========================================================
        // NAVIGATION
        // ===========================================================
        function goToStep(step) {
            // Validate before moving forward
            if (step > currentStep) {
                if (currentStep === 1) {
                    formData.nome = document.getElementById('inputNome').value.trim();
                    if (!formData.nome) return;
                    document.getElementById('nameDisplay1').textContent = formData.nome.split(' ')[0];
                    document.getElementById('nameDisplay2').textContent = formData.nome.split(' ')[0];
                }
                if (currentStep === 2) {
                    formData.dataNascimento = document.getElementById('inputNascimento').value;
                    formData.sexo = document.getElementById('inputSexo').value;
                    if (!formData.dataNascimento || !formData.sexo || formData.idade < 16 || formData.idade > 75) return;
                }
                if (currentStep === 3) {
                    formData.renda = parseInt(document.getElementById('inputRenda').value) || 0;
                    if (!formData.profissao || !formData.renda) return;
                }
                if (currentStep === 4) {
                    if (!formData.familia) return;
                }
            }

            // Setup on step enter
            if (step === 5) {
                calcularCapitalSugerido();
            }
            if (step === 6) {
                gerarCoberturas();
            }
            if (step === 7) {
                montarResumo();
            }

            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            currentStep = step;
            updateProgress();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ===========================================================
        // STEP 2: AGE CALC
        // ===========================================================
        function calcularIdade() {
            const val = document.getElementById('inputNascimento').value;
            const sexo = document.getElementById('inputSexo').value;
            if (!val) return;
            const hoje = new Date();
            const nasc = new Date(val);
            let idade = hoje.getFullYear() - nasc.getFullYear();
            const m = hoje.getMonth() - nasc.getMonth();
            if (m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;
            formData.idade = idade;
            document.getElementById('ageValue').textContent = idade;
            document.getElementById('ageBadge').classList.add('show');
            checkStep2();
        }

        function checkStep2() {
            const val = document.getElementById('inputNascimento').value;
            const sexo = document.getElementById('inputSexo').value;
            const btn = document.getElementById('btnStep2');
            btn.disabled = !(val && sexo && formData.idade >= 16 && formData.idade <= 75);
        }

        document.addEventListener('change', function(e) {
            if (e.target.id === 'inputNascimento' || e.target.id === 'inputSexo') {
                calcularIdade();
            }
        });

        // ===========================================================
        // STEP 3: PROFESSION AUTOCOMPLETE
        // ===========================================================
        let highlightedIdx = -1;

        function setupAutocomplete() {
            const input = document.getElementById('inputProfissao');
            const list = document.getElementById('profissaoList');

            input.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                highlightedIdx = -1;
                if (query.length < 2) { list.classList.remove('show'); return; }

                const matches = profissoes.filter(p => p.toLowerCase().includes(query)).slice(0, 12);
                if (matches.length === 0) { list.classList.remove('show'); return; }

                list.innerHTML = matches.map((p, i) => {
                    const idx = p.toLowerCase().indexOf(query);
                    const before = p.slice(0, idx);
                    const match = p.slice(idx, idx + query.length);
                    const after = p.slice(idx + query.length);
                    return `<div class="autocomplete-item" data-index="${i}" onclick="selectProfissao('${p.replace(/'/g, "\\'")}')">
                        ${before}<span class="match">${match}</span>${after}
                    </div>`;
                }).join('');
                list.classList.add('show');
            });

            input.addEventListener('keydown', function(e) {
                const items = list.querySelectorAll('.autocomplete-item');
                if (!items.length) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIdx = Math.min(highlightedIdx + 1, items.length - 1);
                    items.forEach((it, i) => it.classList.toggle('highlighted', i === highlightedIdx));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIdx = Math.max(highlightedIdx - 1, 0);
                    items.forEach((it, i) => it.classList.toggle('highlighted', i === highlightedIdx));
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (highlightedIdx >= 0 && items[highlightedIdx]) {
                        items[highlightedIdx].click();
                    }
                }
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('#profissaoWrap')) list.classList.remove('show');
            });
        }

        function selectProfissao(nome) {
            formData.profissao = nome;
            // Classify occupation type for recommendations
            const lower = nome.toLowerCase();
            if (lower.includes('empres√°rio') || lower.includes('empres√°ria')) formData.ocupacaoTipo = 'empresario';
            else if (lower.includes('aut√¥nomo') || lower.includes('aut√¥noma')) formData.ocupacaoTipo = 'autonomo';
            else if (lower.includes('servidor') || lower.includes('servidora')) formData.ocupacaoTipo = 'servidor';
            else if (lower.includes('aposentado') || lower.includes('aposentada')) formData.ocupacaoTipo = 'aposentado';
            else if (lower.includes('estudante')) formData.ocupacaoTipo = 'estudante';
            else if (lower.includes('do lar') || lower.includes('dona de casa')) formData.ocupacaoTipo = 'do_lar';
            else formData.ocupacaoTipo = 'empregado';

            document.getElementById('inputProfissao').style.display = 'none';
            document.getElementById('profissaoList').classList.remove('show');
            document.getElementById('profissaoSelectedText').textContent = nome;
            document.getElementById('profissaoSelected').classList.add('show');
            checkStep3();
        }

        function clearProfissao() {
            formData.profissao = '';
            formData.ocupacaoTipo = '';
            document.getElementById('inputProfissao').style.display = '';
            document.getElementById('inputProfissao').value = '';
            document.getElementById('inputProfissao').focus();
            document.getElementById('profissaoSelected').classList.remove('show');
            checkStep3();
        }

        function checkStep3() {
            const renda = document.getElementById('inputRenda').value;
            document.getElementById('btnStep3').disabled = !(formData.profissao && renda);
        }

        document.addEventListener('change', function(e) {
            if (e.target.id === 'inputRenda') checkStep3();
        });

        // ===========================================================
        // STEP 4: FAMILIA
        // ===========================================================
        function selectFamilia(el, val) {
            document.querySelectorAll('#step4 .option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            formData.familia = val;
            document.getElementById('btnStep4').disabled = false;
        }

        // ===========================================================
        // STEP 5: CAPITAL
        // ===========================================================
        function updateCapital() {
            const val = parseInt(document.getElementById('capitalSlider').value);
            formData.capital = val;
            document.getElementById('capitalDisplay').textContent = formatMoney(val);
        }

        function calcularCapitalSugerido() {
            let mult = 5;
            if (formData.familia === 'filhos_pequenos') mult = 10;
            else if (formData.familia === 'casal') mult = 7;
            else if (formData.familia === 'solteiro') mult = 3;

            let ideal = formData.renda * 12 * mult;
            ideal = Math.round(ideal / 50000) * 50000;
            ideal = Math.max(50000, Math.min(2000000, ideal));

            document.getElementById('capitalSugerido').textContent = formatMoney(ideal);
            document.getElementById('capitalSlider').value = ideal;
            formData.capital = ideal;
            document.getElementById('capitalDisplay').textContent = formatMoney(ideal);
        }

        // ===========================================================
        // STEP 6: COBERTURAS
        // ===========================================================
        function gerarCoberturas() {
            const capital = formData.capital;
            // Update fixed coverages display
            document.getElementById('valMorte').textContent = formatShort(capital);
            document.getElementById('valMA').textContent = '+' + formatShort(capital);

            const container = document.getElementById('optionalCoverages');
            let html = '';

            Object.entries(coberturasConfig).forEach(([key, cfg]) => {
                const isRec = cfg.recomendadoPara.some(c => formData.familia === c || formData.ocupacaoTipo === c);
                let valor = cfg.valorPadrao !== null ? cfg.valorPadrao : capital;

                formData.coberturas[key] = { ativo: isRec, valor: valor };

                let valorDisplay = '';
                if (cfg.formato === 'money') valorDisplay = formatMoney(valor);
                else if (cfg.formato === 'mil') valorDisplay = 'R$ ' + (valor / 1000).toFixed(0) + ' mil';
                else if (cfg.formato === 'dia') valorDisplay = 'R$ ' + valor + '/dia';

                html += `
                    <div class="coverage-item ${isRec ? 'active' : ''}" id="cov_${key}">
                        <div class="coverage-header">
                            <div class="toggle ${isRec ? 'on' : ''}" onclick="toggleCoverage('${key}')"></div>
                            <div class="coverage-info">
                                <div class="coverage-name">${cfg.nome}${isRec ? '<span class="coverage-badge">Sugest√£o</span>' : ''}</div>
                                <div class="coverage-desc">${cfg.desc}</div>
                            </div>
                            <input type="text" class="coverage-value-input" id="val_${key}" value="${valorDisplay}" onfocus="this.select()" onchange="updateCoverageValue('${key}', this)">
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Tip
            if (formData.familia === 'filhos_pequenos') {
                document.getElementById('coverageTipText').textContent = 'Com filhos pequenos, IFPD e Doen√ßas Graves s√£o essenciais para garantir tratamento e renda.';
            } else if (formData.ocupacaoTipo === 'autonomo' || formData.ocupacaoTipo === 'empresario') {
                document.getElementById('coverageTipText').textContent = 'Como profissional independente, IPA √© fundamental ‚Äî garante renda se voc√™ ficar impossibilitado de trabalhar.';
            } else if (formData.familia === 'casal') {
                document.getElementById('coverageTipText').textContent = 'Casais se beneficiam de IFPD e Funeral Familiar para proteger um ao outro.';
            } else {
                document.getElementById('coverageTipText').textContent = 'Selecionamos as coberturas mais importantes para seu perfil. Ajuste como quiser!';
            }
        }

        function toggleCoverage(key) {
            const item = document.getElementById('cov_' + key);
            const toggle = item.querySelector('.toggle');
            formData.coberturas[key].ativo = !formData.coberturas[key].ativo;
            item.classList.toggle('active');
            toggle.classList.toggle('on');
        }

        function updateCoverageValue(key, input) {
            let val = parseInt(input.value.replace(/\D/g, '')) || 0;
            const cfg = coberturasConfig[key];

            if (cfg.formato === 'mil') {
                if (val < 1000) val = val * 1000;
                val = Math.max(5000, Math.min(200000, val));
                input.value = 'R$ ' + (val / 1000).toFixed(0) + ' mil';
            } else if (cfg.formato === 'dia') {
                val = Math.max(50, Math.min(1000, val));
                input.value = 'R$ ' + val + '/dia';
            } else {
                val = Math.max(50000, Math.min(2000000, val));
                input.value = formatMoney(val);
            }

            formData.coberturas[key].valor = val;
        }

        // ===========================================================
        // STEP 7: RESUMO
        // ===========================================================
        function montarResumo() {
            const familiaLabels = { solteiro: 'Solteiro(a)', casal: 'Casado(a)', filhos_pequenos: 'Filhos menores', filhos_adultos: 'Filhos adultos' };

            document.getElementById('sumIdade').textContent = formData.idade + ' anos';
            document.getElementById('sumSexo').textContent = formData.sexo === 'M' ? 'Masculino' : 'Feminino';
            document.getElementById('sumProfissao').textContent = formData.profissao;
            document.getElementById('sumFamilia').textContent = familiaLabels[formData.familia] || formData.familia;

            // Coverages grid
            let html = `
                <div class="summary-cov-item">
                    <div class="summary-cov-icon">üîí</div>
                    <div class="summary-cov-name">Morte</div>
                    <div class="summary-cov-value">${formatShort(formData.capital)}</div>
                </div>
                <div class="summary-cov-item">
                    <div class="summary-cov-icon">‚ö°</div>
                    <div class="summary-cov-name">+ Acidental</div>
                    <div class="summary-cov-value">${formatShort(formData.capital)}</div>
                </div>
            `;

            Object.entries(formData.coberturas).forEach(([key, cob]) => {
                if (cob.ativo) {
                    const cfg = coberturasConfig[key];
                    let valDisp = '';
                    if (cfg.formato === 'dia') valDisp = 'R$ ' + cob.valor + '/dia';
                    else valDisp = formatShort(cob.valor);

                    html += `
                        <div class="summary-cov-item">
                            <div class="summary-cov-icon">${cfg.icon}</div>
                            <div class="summary-cov-name">${cfg.label}</div>
                            <div class="summary-cov-value">${valDisp}</div>
                        </div>
                    `;
                }
            });

            document.getElementById('sumCoverages').innerHTML = html;

            // Build WhatsApp URL
            buildWhatsappUrl();
        }

        function buildWhatsappUrl() {
            const nome = formData.nome.split(' ')[0];
            const familiaLabels = { solteiro: 'Solteiro(a)', casal: 'Casado(a)', filhos_pequenos: 'Filhos menores', filhos_adultos: 'Filhos adultos' };
            const cobNomes = { ipa: 'Invalidez por Acidente (IPA)', ifpd: 'Invalidez por Doen√ßa (IFPD)', doencasGraves: 'Doen√ßas Graves', dih: 'Di√°ria de Interna√ß√£o', funeral: 'Funeral Familiar' };

            let coberturas = [`Morte: ${formatMoney(formData.capital)}`, `Morte Acidental: +${formatMoney(formData.capital)}`];
            Object.entries(formData.coberturas).forEach(([key, cob]) => {
                if (cob.ativo) {
                    const cfg = coberturasConfig[key];
                    let val = cfg.formato === 'dia' ? `R$ ${cob.valor}/dia` : formatMoney(cob.valor);
                    coberturas.push(`${cobNomes[key]}: ${val}`);
                }
            });

            const msg = `Ol√° Retorno! Sou o(a) ${nome} üëã\n\n` +
                `Acabei de preencher a cota√ß√£o de seguro de vida no site!\n\n` +
                `üë§ Meus dados:\n` +
                `‚Ä¢ ${formData.idade} anos ¬∑ ${formData.sexo === 'M' ? 'Masculino' : 'Feminino'}\n` +
                `‚Ä¢ ${formData.profissao}\n` +
                `‚Ä¢ ${familiaLabels[formData.familia] || formData.familia}\n\n` +
                `üõ°Ô∏è Coberturas que selecionei:\n` +
                coberturas.map(c => `‚Ä¢ ${c}`).join('\n') +
                `\n\nQuero receber a melhor proposta! ü§ù`;

            document.getElementById('whatsappBtn').href = `https://wa.me/5554996454300?text=${encodeURIComponent(msg)}`;
        }

        // ===========================================================
        // LEAD SAVING
        // ===========================================================
        async function salvarLead() {
            const wRaw = document.getElementById('inputWhatsapp').value.replace(/\D/g, '');
            if (wRaw.length < 10) {
                document.getElementById('inputWhatsapp').style.borderColor = '#ef4444';
                return;
            }
            const whatsapp = wRaw;

            // Build coberturas for dadosSite
            let coberturasSite = {};
            Object.entries(formData.coberturas).forEach(([key, cob]) => {
                coberturasSite[key] = { ativo: cob.ativo, valor: cob.valor };
            });

            const dadosCRM = {
                nome: formData.nome,
                whatsapp: whatsapp,
                ramo: 'vida',
                tipo: 'individual',
                status: 'pre_cadastro',
                origem: 'site',
                acao: 'salvar_lead',
                dataNascimento: formData.dataNascimento,
                idade: formData.idade,
                sexo: formData.sexo,
                profissao: formData.profissao,
                ocupacaoTipo: formData.ocupacaoTipo,
                renda: formData.renda,
                familia: formData.familia,
                capital: formData.capital,
                indicadoPorCodigo: indicacaoData.codigo || null,
                indicadoPorNome: indicacaoData.nome || null,
                empresaParceiraCodigo: empresaParceiraData.codigo || null,
                empresaParceiraNome: empresaParceiraData.nome || null,
                dadosSite: {
                    idade: formData.idade,
                    sexo: formData.sexo,
                    dataNascimento: formData.dataNascimento,
                    profissao: formData.profissao,
                    ocupacaoTipo: formData.ocupacaoTipo,
                    renda: formData.renda,
                    familia: formData.familia,
                    capital: formData.capital,
                    coberturas: coberturasSite
                },
                criadoEm: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const docRef = await db.collection('leads_crm').add(dadosCRM);
                leadSalvoId = docRef.id;
                console.log('‚úÖ Lead vida salvo:', leadSalvoId);
            } catch (err) {
                console.error('‚ùå Erro ao salvar lead:', err);
            }

            // Show fase 2
            document.getElementById('ctaFase1').style.display = 'none';
            document.getElementById('ctaFase2').style.display = 'block';
        }

        async function registrarClique() {
            if (leadSalvoId) {
                try {
                    await db.collection('leads_crm').doc(leadSalvoId).update({
                        acao: 'whatsapp_direto',
                        clicouWhatsapp: true,
                        dataCliqueWhatsapp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (err) { console.error(err); }
            }
        }

        // ===========================================================
        // INDICA√á√ÉO / PARCEIRO
        // ===========================================================
        async function capturarIndicacao() {
            const params = new URLSearchParams(window.location.search);

            // Empresa parceira
            let codEmp = params.get('codigo') || sessionStorage.getItem('parceiro_codigo');
            if (codEmp) {
                empresaParceiraData.codigo = codEmp.toUpperCase();
                try {
                    const snap = await db.collection('empresas_parceiras')
                        .where('codigo', '==', empresaParceiraData.codigo)
                        .where('status', '==', 'aprovado').limit(1).get();
                    if (!snap.empty) {
                        empresaParceiraData.nome = snap.docs[0].data().nomeEmpresa || '';
                        await snap.docs[0].ref.update({ totalIndicacoes: firebase.firestore.FieldValue.increment(1) });
                    }
                } catch (e) { console.error(e); }
            }

            // Indicador cliente
            let codRef = params.get('ref') || sessionStorage.getItem('indicacao_codigo');
            if (codRef) {
                indicacaoData.codigo = codRef.toUpperCase();
                try {
                    const snap = await db.collection('indicadores')
                        .where('codigoIndicacao', '==', indicacaoData.codigo).limit(1).get();
                    if (!snap.empty) {
                        indicacaoData.nome = snap.docs[0].data().nome?.split(' ')[0] || '';
                        await snap.docs[0].ref.update({ totalIndicacoes: firebase.firestore.FieldValue.increment(1) });
                    }
                } catch (e) { console.error(e); }
            }
        }

        // ===========================================================
        // HELPERS
        // ===========================================================
        function formatMoney(v) {
            return 'R$ ' + v.toLocaleString('pt-BR');
        }
        function formatShort(v) {
            if (v >= 1000000) return 'R$ ' + (v / 1000000).toFixed(1).replace('.0', '') + 'M';
            if (v >= 1000) return 'R$ ' + (v / 1000).toFixed(0) + 'k';
            return 'R$ ' + v;
        }
        function formatPhone(input) {
            let v = input.value.replace(/\D/g, '');
            if (v.length > 11) v = v.slice(0, 11);
            if (v.length > 7) v = `(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7)}`;
            else if (v.length > 2) v = `(${v.slice(0,2)}) ${v.slice(2)}`;
            else if (v.length > 0) v = `(${v}`;
            input.value = v;
        }

        // ===========================================================
        // INIT
        // ===========================================================
        document.addEventListener('DOMContentLoaded', function() {
            capturarIndicacao();
            setupAutocomplete();

            const nomeInput = document.getElementById('inputNome');
            nomeInput.addEventListener('input', function() {
                document.getElementById('btnStep1').disabled = this.value.trim().length === 0;
            });
            nomeInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && this.value.trim()) goToStep(2);
            });
            document.getElementById('btnStep1').disabled = true;
            nomeInput.focus();
            updateProgress();

            // Loader
            setTimeout(() => {
                document.getElementById('pageLoader').classList.add('hide');
                setTimeout(() => document.getElementById('pageLoader').style.display = 'none', 400);
            }, 600);
        });
    </script>
</body>
</html>
