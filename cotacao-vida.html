<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cota√ß√£o Seguro de Vida | Retorno Seguros</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0088aa;
            --primary-dark: #006680;
            --secondary: #00b8d4;
            --dark-blue: #004d66;
            --light-bg: #f0f9fb;
            --white: #ffffff;
            --text-dark: #1a2b3c;
            --text-light: #5a6b7c;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --purple: #8b5cf6;
            --shadow: 0 4px 20px rgba(0, 136, 170, 0.15);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, var(--light-bg) 0%, #e6f4f7 100%);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .header {
            background: var(--white);
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.2rem;
        }

        .logo-text-container {
            display: flex;
            flex-direction: column;
        }

        .logo-text {
            font-weight: 800;
            font-size: 1.3rem;
            color: var(--text-dark);
            letter-spacing: -0.5px;
        }

        .logo-sub {
            font-size: 0.7rem;
            color: var(--primary);
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .progress-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .progress-bar-wrapper {
            background: rgba(0, 136, 170, 0.15);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%;
            border-radius: 10px;
            transition: width 0.4s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .main-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 1.5rem 3rem;
        }

        .step-card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem 1.5rem;
            box-shadow: var(--shadow);
            display: none;
            animation: slideIn 0.4s ease;
        }

        .step-card.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--light-bg), #e0f2f5);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin: 0 auto 1.25rem;
        }

        .step-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .step-subtitle {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .greeting-name {
            color: var(--primary);
        }

        .input-group {
            margin-bottom: 1.25rem;
        }

        .input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .text-input, .select-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid #e5e9ec;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .text-input:focus, .select-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 136, 170, 0.1);
        }

        .text-input.success {
            border-color: var(--success);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .options-grid.single-col {
            grid-template-columns: 1fr;
        }

        .option-btn {
            background: var(--white);
            border: 2px solid #e5e9ec;
            border-radius: 14px;
            padding: 1.25rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 0.5rem;
        }

        .option-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .option-btn.selected {
            border-color: var(--primary);
            background: rgba(0, 136, 170, 0.05);
        }

        .option-icon {
            font-size: 1.5rem;
        }

        .option-text {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .option-desc {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .btn-container {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn {
            flex: 1;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--light-bg);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: #e0f2f5;
        }

        /* Capital Selector */
        .capital-selector {
            background: var(--light-bg);
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .capital-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .capital-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
            margin-bottom: 0.75rem;
        }

        .capital-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #d0d5dd;
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 0.5rem;
        }

        .capital-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .capital-range {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .capital-tip {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(0, 136, 170, 0.1));
            border: 2px solid var(--purple);
            border-radius: 10px;
            padding: 0.875rem;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .capital-tip strong {
            color: var(--purple);
        }

        /* Coverage Item */
        .coverage-section {
            margin-bottom: 1.5rem;
        }

        .coverage-section-title {
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .coverage-item {
            border: 2px solid #e5e9ec;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .coverage-item.active {
            border-color: var(--primary);
            background: rgba(0, 136, 170, 0.03);
        }

        .coverage-item.recommended {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .coverage-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .coverage-toggle {
            width: 44px;
            height: 24px;
            background: #d0d5dd;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .coverage-toggle.on {
            background: var(--primary);
        }

        .coverage-toggle::after {
            content: '';
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .coverage-toggle.on::after {
            left: 22px;
        }

        .coverage-info {
            flex: 1;
        }

        .coverage-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .coverage-desc {
            font-size: 0.8rem;
            color: var(--text-light);
            line-height: 1.4;
        }

        .coverage-price {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 600;
            white-space: nowrap;
        }

        .coverage-badge {
            background: var(--success);
            color: white;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Result Card */
        .result-card {
            background: linear-gradient(135deg, var(--primary), var(--dark-blue));
            border-radius: 20px;
            padding: 2rem;
            color: white;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .result-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .result-installment {
            font-size: 1rem;
            opacity: 0.9;
        }

        .result-discount {
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            display: inline-block;
            margin-top: 0.75rem;
            font-size: 0.85rem;
        }

        .result-promise {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.95rem;
        }

        .result-promise strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        /* Summary */
        .summary-section {
            background: var(--light-bg);
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .summary-title {
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .summary-edit {
            font-size: 0.8rem;
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: var(--text-light);
        }

        .summary-value {
            font-weight: 600;
            color: var(--text-dark);
            text-align: right;
        }

        /* Coverages Grid */
        .coverages-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .coverage-summary-item {
            background: var(--white);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .coverage-summary-icon {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .coverage-summary-name {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .coverage-summary-value {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Tip Box */
        .tip-box {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(245, 158, 11, 0.1));
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .tip-box.success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }

        .tip-box-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .tip-box-header span {
            font-weight: 700;
            color: var(--warning);
        }

        .tip-box.success .tip-box-header span {
            color: var(--success);
        }

        .tip-box p {
            font-size: 0.85rem;
            color: var(--text-dark);
            line-height: 1.5;
        }

        .whatsapp-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            padding: 1.25rem;
            background: #25D366;
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .whatsapp-btn:hover {
            background: #20bd5a;
            transform: translateY(-2px);
        }

        .info-box {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-box p {
            font-size: 0.9rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        .info-box strong {
            color: var(--primary);
        }

        .info-tooltip {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 0.875rem 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .info-tooltip::before {
            content: '‚ÑπÔ∏è';
        }

        /* Age Display */
        .age-display {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 0.875rem;
            margin-top: 0.75rem;
            text-align: center;
            display: none;
        }

        .age-display.show {
            display: block;
        }

        .age-display .age-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .age-display .age-label {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        @media (max-width: 480px) {
            .step-card {
                padding: 1.5rem 1.25rem;
            }

            .step-title {
                font-size: 1.3rem;
            }

            .result-value {
                font-size: 2rem;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .coverages-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">
                <div class="logo-icon">R</div>
                <div class="logo-text-container">
                    <span class="logo-text">Retorno</span>
                    <span class="logo-sub">Seguros</span>
                </div>
            </a>
        </div>
    </header>

    <!-- Progress -->
    <div class="progress-container">
        <div class="progress-bar-wrapper">
            <div class="progress-bar-fill" id="progressBar" style="width: 12.5%"></div>
        </div>
        <div class="progress-text" id="progressText">Passo 1 de 8</div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        
        <!-- Step 1: Nome -->
        <div class="step-card active" id="step1">
            <div class="step-icon">üíú</div>
            <h2 class="step-title">Proteja quem voc√™ ama</h2>
            <p class="step-subtitle">Vamos criar uma prote√ß√£o sob medida para sua fam√≠lia. Como posso te chamar?</p>
            
            <div class="input-group">
                <input type="text" class="text-input" id="userName" placeholder="Seu nome" autocomplete="off">
            </div>

            <div class="btn-container">
                <button class="btn btn-primary" onclick="nextStep(1)" id="btnStep1">Come√ßar</button>
            </div>
        </div>

        <!-- Step 2: Data Nascimento e Sexo -->
        <div class="step-card" id="step2">
            <div class="step-icon">üéÇ</div>
            <h2 class="step-title">Ol√°, <span class="greeting-name" id="greetingName"></span>!</h2>
            <p class="step-subtitle">Precisamos de alguns dados para calcular sua prote√ß√£o</p>
            
            <div class="input-row">
                <div class="input-group">
                    <label class="input-label">Data de nascimento</label>
                    <input type="date" class="text-input" id="dataNascimento" onchange="calcularIdade()">
                </div>
                <div class="input-group">
                    <label class="input-label">Sexo</label>
                    <select class="select-input" id="sexo">
                        <option value="">Selecione</option>
                        <option value="M">Masculino</option>
                        <option value="F">Feminino</option>
                    </select>
                </div>
            </div>

            <div class="age-display" id="ageDisplay">
                <span class="age-value" id="ageValue">36</span>
                <span class="age-label">anos</span>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(2)">Voltar</button>
                <button class="btn btn-primary" onclick="nextStep(2)" disabled id="btnStep2">Continuar</button>
            </div>
        </div>

        <!-- Step 3: Profiss√£o e Renda -->
        <div class="step-card" id="step3">
            <div class="step-icon">üíº</div>
            <h2 class="step-title">Sua atividade</h2>
            <p class="step-subtitle">Isso ajuda a calcular coberturas como Di√°ria por Incapacidade</p>
            
            <div class="input-group">
                <label class="input-label">Ocupa√ß√£o</label>
                <select class="select-input" id="ocupacao">
                    <option value="">Selecione sua ocupa√ß√£o</option>
                    <option value="empregado">Empregado CLT</option>
                    <option value="servidor">Servidor P√∫blico</option>
                    <option value="autonomo">Aut√¥nomo / Liberal</option>
                    <option value="empresario">Empres√°rio / S√≥cio</option>
                    <option value="aposentado">Aposentado</option>
                    <option value="estudante">Estudante</option>
                    <option value="do_lar">Do lar</option>
                </select>
            </div>

            <div class="input-group">
                <label class="input-label">Renda mensal</label>
                <select class="select-input" id="renda">
                    <option value="">Selecione sua faixa de renda</option>
                    <option value="3000">At√© R$ 3.000</option>
                    <option value="5000">De R$ 3.000 a R$ 5.000</option>
                    <option value="7500">De R$ 5.000 a R$ 7.500</option>
                    <option value="10000">De R$ 7.500 a R$ 10.000</option>
                    <option value="15000">De R$ 10.000 a R$ 15.000</option>
                    <option value="20000">De R$ 15.000 a R$ 20.000</option>
                    <option value="30000">Acima de R$ 20.000</option>
                </select>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(3)">Voltar</button>
                <button class="btn btn-primary" onclick="nextStep(3)" disabled id="btnStep3">Continuar</button>
            </div>
        </div>

        <!-- Step 4: Fam√≠lia -->
        <div class="step-card" id="step4">
            <div class="step-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
            <h2 class="step-title">Sua fam√≠lia</h2>
            <p class="step-subtitle">Quem depende de voc√™ financeiramente?</p>
            
            <div class="options-grid single-col">
                <div class="option-btn" onclick="selectOption(this, 'familia', 'solteiro')">
                    <span class="option-icon">üë§</span>
                    <span class="option-text">Sou solteiro(a), sem dependentes</span>
                </div>
                <div class="option-btn" onclick="selectOption(this, 'familia', 'casal')">
                    <span class="option-icon">üë´</span>
                    <span class="option-text">Casado(a) ou uni√£o est√°vel</span>
                </div>
                <div class="option-btn" onclick="selectOption(this, 'familia', 'filhos_pequenos')">
                    <span class="option-icon">üë®‚Äçüë©‚Äçüëß</span>
                    <span class="option-text">Tenho filhos menores de 18 anos</span>
                    <span class="option-desc">Prote√ß√£o mais importante!</span>
                </div>
                <div class="option-btn" onclick="selectOption(this, 'familia', 'filhos_adultos')">
                    <span class="option-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                    <span class="option-text">Filhos j√° s√£o adultos</span>
                </div>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(4)">Voltar</button>
                <button class="btn btn-primary" onclick="nextStep(4)" disabled id="btnStep4">Continuar</button>
            </div>
        </div>

        <!-- Step 5: Capital -->
        <div class="step-card" id="step5">
            <div class="step-icon">üí∞</div>
            <h2 class="step-title">Quanto de prote√ß√£o?</h2>
            <p class="step-subtitle">Escolha o valor que sua fam√≠lia receberia em caso de falecimento</p>
            
            <div class="capital-selector">
                <div class="capital-label">üíé Capital Segurado</div>
                <div class="capital-value" id="capitalDisplay">R$ 100.000</div>
                <input type="range" class="capital-slider" id="capitalSlider" min="50000" max="500000" step="50000" value="100000" oninput="updateCapital()">
                <div class="capital-range">
                    <span>R$ 50 mil</span>
                    <span>R$ 500 mil</span>
                </div>
                <div class="capital-tip" id="capitalTip">
                    <strong>üí° Recomenda√ß√£o:</strong> Com base na sua renda, sugerimos um capital de <strong id="capitalSugerido">R$ 300.000</strong> (5 a 10 anos de renda).
                </div>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(5)">Voltar</button>
                <button class="btn btn-primary" onclick="nextStep(5)">Continuar</button>
            </div>
        </div>

        <!-- Step 6: Coberturas -->
        <div class="step-card" id="step6">
            <div class="step-icon">üõ°Ô∏è</div>
            <h2 class="step-title">Monte sua prote√ß√£o</h2>
            <p class="step-subtitle">Personalizamos as coberturas para seu perfil. Voc√™ pode ajustar!</p>
            
            <!-- Cobertura B√°sica -->
            <div class="coverage-section">
                <div class="coverage-section-title">‚úÖ Sempre inclusos</div>
                
                <div class="coverage-item active">
                    <div class="coverage-header">
                        <div class="coverage-toggle on" style="pointer-events: none;"></div>
                        <div class="coverage-info">
                            <div class="coverage-name">üíÄ Morte (natural ou acidental)</div>
                            <div class="coverage-desc">Sua fam√≠lia recebe o capital se voc√™ falecer por qualquer causa</div>
                        </div>
                        <span class="coverage-price" id="price_morte">~R$ 27/m√™s</span>
                    </div>
                </div>

                <div class="coverage-item active">
                    <div class="coverage-header">
                        <div class="coverage-toggle on" style="pointer-events: none;"></div>
                        <div class="coverage-info">
                            <div class="coverage-name">‚ö° Morte Acidental (dobra o valor)</div>
                            <div class="coverage-desc">Se a morte for por acidente, sua fam√≠lia recebe o dobro do capital</div>
                        </div>
                        <span class="coverage-price" id="price_ma">~R$ 11/m√™s</span>
                    </div>
                </div>
            </div>

            <!-- Coberturas Opcionais -->
            <div class="coverage-section">
                <div class="coverage-section-title">‚≠ê Coberturas adicionais</div>
                <div id="optionalCoverages">
                    <!-- Preenchido via JS -->
                </div>
            </div>

            <div class="tip-box" id="coverageTip">
                <div class="tip-box-header">
                    <span>üí° Sugest√£o Retorno</span>
                </div>
                <p id="coverageTipText">Selecionamos as coberturas mais importantes para seu perfil. Voc√™ pode ativar ou desativar cada uma.</p>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(6)">Voltar</button>
                <button class="btn btn-primary" onclick="calcularResultado()">Ver minha cota√ß√£o</button>
            </div>
        </div>

        <!-- Step 7: Resultado -->
        <div class="step-card" id="step7">
            <div class="step-icon">üéâ</div>
            <h2 class="step-title">Sua prote√ß√£o est√° pronta!</h2>
            
            <div class="result-card">
                <div class="result-label">Investimento mensal</div>
                <div class="result-value" id="resultValue">R$ 54 - R$ 65</div>
                <div class="result-installment">d√©bito em conta ou boleto</div>
                <div class="result-discount">üí≥ No cart√£o: 10% de desconto!</div>
                <div class="result-promise">
                    <strong>ü§ù Vamos brigar por esse valor!</strong>
                    Se a gente conseguir, voc√™ fecha com a Retorno?
                </div>
            </div>

            <!-- Resumo -->
            <div class="summary-section">
                <div class="summary-title">
                    üë§ Seus dados
                    <span class="summary-edit" onclick="goToStep(2)">Editar</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Idade</span>
                    <span class="summary-value" id="sumIdade">36 anos</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Ocupa√ß√£o</span>
                    <span class="summary-value" id="sumOcupacao">Corretor de seguros</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Capital principal</span>
                    <span class="summary-value" id="sumCapital">R$ 100.000</span>
                </div>
            </div>

            <div class="summary-section">
                <div class="summary-title">
                    üõ°Ô∏è Suas coberturas
                    <span class="summary-edit" onclick="goToStep(6)">Editar</span>
                </div>
                <div class="coverages-grid" id="coveragesGrid">
                    <!-- Preenchido via JS -->
                </div>
            </div>

            <!-- Dica -->
            <div class="tip-box success" id="finalTip">
                <div class="tip-box-header">
                    <span>‚úÖ Excelente prote√ß√£o!</span>
                </div>
                <p id="finalTipText">Sua fam√≠lia estar√° protegida por menos de R$ 2 por dia. √â menos que um cafezinho!</p>
            </div>

            <!-- Campo WhatsApp Opcional -->
            <div style="background: linear-gradient(135deg, rgba(37, 211, 102, 0.1), rgba(0, 136, 170, 0.1)); border: 2px solid #25D366; border-radius: 14px; padding: 1.25rem; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <span style="font-size: 1.25rem;">üì±</span>
                    <span style="font-weight: 700; color: #128C7E;">Garanta o melhor pre√ßo!</span>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.75rem;">
                    Deixa seu WhatsApp que a gente te avisa assim que conseguir uma condi√ß√£o especial. Sem spam! ü§û
                </p>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="tel" id="whatsappInput" class="text-input" placeholder="(54) 99999-9999" 
                           style="flex: 1;" oninput="formatWhatsapp(this)" maxlength="15">
                    <button onclick="salvarWhatsapp()" style="background: #25D366; color: white; border: none; border-radius: 10px; padding: 0 1.25rem; font-weight: 600; cursor: pointer; white-space: nowrap;">
                        Salvar
                    </button>
                </div>
                <p id="whatsappSaved" style="display: none; color: #128C7E; font-size: 0.85rem; margin-top: 0.5rem; font-weight: 600;">
                    ‚úÖ Salvo! Vamos te avisar por l√°.
                </p>
            </div>

            <a href="#" class="whatsapp-btn" id="whatsappBtn" target="_blank" onclick="registrarCliqueWhatsapp()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
                Sim! Quero fechar com a Retorno
            </a>

            <div class="info-tooltip">
                Ao clicar, voc√™ ser√° direcionado para o WhatsApp. J√° vamos receber seu n√∫mero automaticamente!
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ID √∫nico da sess√£o para rastrear o lead
        let leadId = null;
        let leadDocRef = null;

        // Taxas baseadas na cota√ß√£o real Tokio Marine (pessoa 36 anos)
        // Pr√™mio anual / Capital = taxa
        const taxasBase = {
            morte: 0.002,           // R$ 199,71 / R$ 100k = 0.2%
            morteAcidental: 0.0013, // R$ 129,73 / R$ 100k = 0.13%
            ipa: 0.00073,           // R$ 73,48 / R$ 100k = 0.073%
            ifpd: 0.0006,           // R$ 59,87 / R$ 100k = 0.06%
            doencasGraves: 0.0067,  // R$ 133,10 / R$ 20k = 0.67%
            funeral: 22.89,         // Valor fixo por R$ 7k de cobertura
            dih: 61.43,             // Valor fixo por R$ 100/dia
            dihUti: 12.41,          // Valor fixo por R$ 100/dia
            dmho: 29.27             // Valor fixo por R$ 500 de cobertura
        };

        // Multiplicador por idade (base 36 anos = 1.0)
        const multIdade = {
            18: 0.6, 20: 0.65, 25: 0.75, 30: 0.85, 35: 0.95,
            36: 1.0, 40: 1.15, 45: 1.4, 50: 1.8, 55: 2.3, 
            60: 3.0, 65: 4.0, 70: 5.5
        };

        // Form Data
        let currentStep = 1;
        const totalSteps = 7;
        
        const formData = {
            nome: '',
            dataNascimento: '',
            idade: 0,
            sexo: '',
            ocupacao: '',
            renda: 0,
            familia: '',
            capital: 100000,
            coberturas: {},
            whatsapp: '',
            valorEstimadoMin: 0,
            valorEstimadoMax: 0
        };

        // Coberturas dispon√≠veis
        const coberturasConfig = {
            ipa: { 
                nome: '‚ôø Invalidez por Acidente (IPA)', 
                desc: 'Se um acidente te deixar inv√°lido, voc√™ recebe o capital em vida',
                valorPadrao: 100000,
                recomendadoPara: ['empregado', 'autonomo', 'empresario']
            },
            ifpd: { 
                nome: 'üè• Invalidez por Doen√ßa (IFPD)', 
                desc: 'Se uma doen√ßa te deixar totalmente inv√°lido, antecipa o capital',
                valorPadrao: 100000,
                recomendadoPara: ['filhos_pequenos', 'casal']
            },
            doencasGraves: { 
                nome: 'üéóÔ∏è Doen√ßas Graves', 
                desc: 'Diagn√≥stico de c√¢ncer, infarto, AVC e outras 27 doen√ßas - recebe R$ 20 mil para tratamento',
                valorPadrao: 20000,
                recomendadoPara: ['filhos_pequenos', 'casal']
            },
            dih: { 
                nome: 'üè® Di√°ria de Interna√ß√£o', 
                desc: 'Se voc√™ ficar internado, recebe R$ 100 por dia (at√© 90 dias)',
                valorPadrao: 100,
                recomendadoPara: []
            },
            funeral: { 
                nome: '‚ö±Ô∏è Funeral Familiar', 
                desc: 'Cobre funeral de toda a fam√≠lia (voc√™, c√¥njuge, filhos e pais) - R$ 7 mil cada',
                valorPadrao: 7000,
                recomendadoPara: ['casal', 'filhos_pequenos', 'filhos_adultos']
            }
        };

        // Progress
        function updateProgress() {
            const percent = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `Passo ${currentStep} de ${totalSteps}`;
        }
        
        // Salvar lead parcial
        async function salvarLeadParcial() {
            try {
                const dadosLead = {
                    nome: formData.nome || '',
                    dataNascimento: formData.dataNascimento || '',
                    idade: formData.idade || 0,
                    sexo: formData.sexo || '',
                    ocupacao: formData.ocupacao || '',
                    renda: formData.renda || 0,
                    familia: formData.familia || '',
                    capital: formData.capital || 100000,
                    coberturas: formData.coberturas || {},
                    whatsapp: formData.whatsapp || '',
                    ultimoStep: currentStep,
                    status: currentStep >= 7 ? 'completo' : 'parcial',
                    ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                    origem: 'site_cotacao_vida_v3',
                    userAgent: navigator.userAgent,
                    telaLargura: window.innerWidth
                };
                
                if (leadDocRef) {
                    await leadDocRef.update(dadosLead);
                } else {
                    dadosLead.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                    leadDocRef = await db.collection('leads_cotacao_vida').add(dadosLead);
                    leadId = leadDocRef.id;
                }
                
                console.log('Lead salvo:', leadId, 'Step:', currentStep);
            } catch (error) {
                console.error('Erro ao salvar lead:', error);
            }
        }

        function showStep(step) {
            document.querySelectorAll('.step-card').forEach(card => card.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
            updateProgress();
            
            if (step > 1) {
                salvarLeadParcial();
            }
            
            if (step === 5) {
                calcularCapitalSugerido();
            }
            
            if (step === 6) {
                gerarCoberturas();
            }
        }

        function goToStep(step) {
            showStep(step);
        }

        function nextStep(step) {
            if (step === 1) {
                formData.nome = document.getElementById('userName').value.trim();
                document.getElementById('greetingName').textContent = formData.nome.split(' ')[0];
            }
            if (step === 2) {
                formData.dataNascimento = document.getElementById('dataNascimento').value;
                formData.sexo = document.getElementById('sexo').value;
            }
            if (step === 3) {
                formData.ocupacao = document.getElementById('ocupacao').value;
                formData.renda = parseInt(document.getElementById('renda').value) || 0;
            }
            showStep(step + 1);
        }

        function prevStep(step) {
            showStep(step - 1);
        }

        function selectOption(element, field, value) {
            const parent = element.parentElement;
            parent.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            formData[field] = value;
            
            const btnId = `btnStep${currentStep}`;
            const btn = document.getElementById(btnId);
            if (btn) btn.disabled = false;
        }

        // Calcular idade
        function calcularIdade() {
            const dataNasc = document.getElementById('dataNascimento').value;
            const sexo = document.getElementById('sexo').value;
            
            if (dataNasc) {
                const hoje = new Date();
                const nascimento = new Date(dataNasc);
                let idade = hoje.getFullYear() - nascimento.getFullYear();
                const m = hoje.getMonth() - nascimento.getMonth();
                if (m < 0 || (m === 0 && hoje.getDate() < nascimento.getDate())) {
                    idade--;
                }
                
                formData.idade = idade;
                document.getElementById('ageValue').textContent = idade;
                document.getElementById('ageDisplay').classList.add('show');
                
                // Habilitar bot√£o se tudo preenchido
                if (idade >= 18 && idade <= 70 && sexo) {
                    document.getElementById('btnStep2').disabled = false;
                }
            }
        }

        // Verificar step 2
        document.addEventListener('change', function(e) {
            if (e.target.id === 'sexo' || e.target.id === 'dataNascimento') {
                const dataNasc = document.getElementById('dataNascimento').value;
                const sexo = document.getElementById('sexo').value;
                if (dataNasc && sexo && formData.idade >= 18 && formData.idade <= 70) {
                    document.getElementById('btnStep2').disabled = false;
                }
            }
            
            if (e.target.id === 'ocupacao' || e.target.id === 'renda') {
                const ocupacao = document.getElementById('ocupacao').value;
                const renda = document.getElementById('renda').value;
                if (ocupacao && renda) {
                    document.getElementById('btnStep3').disabled = false;
                }
            }
        });

        // Capital slider
        function updateCapital() {
            const value = parseInt(document.getElementById('capitalSlider').value);
            formData.capital = value;
            document.getElementById('capitalDisplay').textContent = `R$ ${value.toLocaleString('pt-BR')}`;
            atualizarPrecosCoberturas();
        }

        function calcularCapitalSugerido() {
            // 5 a 10 anos de renda dependendo da situa√ß√£o familiar
            let multiplicador = 5;
            if (formData.familia === 'filhos_pequenos') multiplicador = 10;
            else if (formData.familia === 'casal') multiplicador = 7;
            else if (formData.familia === 'solteiro') multiplicador = 3;
            
            const capitalIdeal = formData.renda * 12 * multiplicador;
            
            // Arredondar para valores de slider
            let capitalArredondado = Math.round(capitalIdeal / 50000) * 50000;
            capitalArredondado = Math.max(50000, Math.min(500000, capitalArredondado));
            
            document.getElementById('capitalSugerido').textContent = `R$ ${capitalArredondado.toLocaleString('pt-BR')}`;
            
            // Atualizar slider para o valor sugerido
            document.getElementById('capitalSlider').value = capitalArredondado;
            formData.capital = capitalArredondado;
            document.getElementById('capitalDisplay').textContent = `R$ ${capitalArredondado.toLocaleString('pt-BR')}`;
        }

        function getMultiplicadorIdade() {
            const idade = formData.idade;
            
            // Encontrar o multiplicador mais pr√≥ximo
            const idades = Object.keys(multIdade).map(Number).sort((a, b) => a - b);
            let mult = 1.0;
            
            for (let i = 0; i < idades.length; i++) {
                if (idade <= idades[i]) {
                    if (i === 0) {
                        mult = multIdade[idades[i]];
                    } else {
                        // Interpolar entre duas idades
                        const idadeAnterior = idades[i - 1];
                        const idadeAtual = idades[i];
                        const proporcao = (idade - idadeAnterior) / (idadeAtual - idadeAnterior);
                        mult = multIdade[idadeAnterior] + proporcao * (multIdade[idadeAtual] - multIdade[idadeAnterior]);
                    }
                    break;
                }
                mult = multIdade[idades[i]];
            }
            
            return mult;
        }

        function atualizarPrecosCoberturas() {
            const mult = getMultiplicadorIdade();
            const capital = formData.capital;
            
            // Pre√ßos base
            const precoMorte = Math.round((capital * taxasBase.morte * mult) / 12);
            const precoMA = Math.round((capital * taxasBase.morteAcidental * mult) / 12);
            
            document.getElementById('price_morte').textContent = `~R$ ${precoMorte}/m√™s`;
            document.getElementById('price_ma').textContent = `~R$ ${precoMA}/m√™s`;
        }

        function gerarCoberturas() {
            atualizarPrecosCoberturas();
            
            const container = document.getElementById('optionalCoverages');
            const mult = getMultiplicadorIdade();
            
            let html = '';
            
            Object.entries(coberturasConfig).forEach(([key, config]) => {
                // Verificar se √© recomendado
                let isRecomendado = config.recomendadoPara.some(cond => 
                    formData.familia === cond || formData.ocupacao === cond
                );
                
                // Calcular pre√ßo
                let precoAnual = 0;
                if (key === 'ipa') {
                    precoAnual = formData.capital * taxasBase.ipa * mult;
                } else if (key === 'ifpd') {
                    precoAnual = formData.capital * taxasBase.ifpd * mult;
                } else if (key === 'doencasGraves') {
                    precoAnual = config.valorPadrao * taxasBase.doencasGraves * mult;
                } else if (key === 'dih') {
                    precoAnual = (taxasBase.dih + taxasBase.dihUti) * mult;
                } else if (key === 'funeral') {
                    precoAnual = taxasBase.funeral * mult;
                }
                
                const precoMensal = Math.round(precoAnual / 12);
                
                // Inicializar no formData
                formData.coberturas[key] = {
                    valor: config.valorPadrao,
                    precoAnual: precoAnual,
                    precoMensal: precoMensal,
                    ativo: isRecomendado
                };
                
                html += `
                    <div class="coverage-item ${isRecomendado ? 'active recommended' : ''}" id="cov_${key}">
                        <div class="coverage-header">
                            <div class="coverage-toggle ${isRecomendado ? 'on' : ''}" onclick="toggleCoverage('${key}')"></div>
                            <div class="coverage-info">
                                <div class="coverage-name">${config.nome}${isRecomendado ? '<span class="coverage-badge">Sugest√£o</span>' : ''}</div>
                                <div class="coverage-desc">${config.desc}</div>
                            </div>
                            <span class="coverage-price">~R$ ${precoMensal}/m√™s</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Dica personalizada
            if (formData.familia === 'filhos_pequenos') {
                document.getElementById('coverageTipText').textContent = 
                    'Com filhos pequenos, IFPD e Doen√ßas Graves s√£o essenciais - garantem dinheiro para voc√™ se precisar de tratamento.';
            } else if (formData.ocupacao === 'autonomo' || formData.ocupacao === 'empresario') {
                document.getElementById('coverageTipText').textContent = 
                    'Como aut√¥nomo/empres√°rio, IPA √© fundamental - se voc√™ ficar inv√°lido, recebe o capital para se manter.';
            }
        }

        function toggleCoverage(key) {
            const item = document.getElementById(`cov_${key}`);
            const toggle = item.querySelector('.coverage-toggle');
            
            formData.coberturas[key].ativo = !formData.coberturas[key].ativo;
            
            if (formData.coberturas[key].ativo) {
                item.classList.add('active');
                toggle.classList.add('on');
            } else {
                item.classList.remove('active');
                toggle.classList.remove('on');
            }
        }

        function calcularResultado() {
            const mult = getMultiplicadorIdade();
            const capital = formData.capital;
            
            // Coberturas b√°sicas (sempre inclusas)
            let premioAnual = 0;
            premioAnual += capital * taxasBase.morte * mult;
            premioAnual += capital * taxasBase.morteAcidental * mult;
            
            // Coberturas opcionais
            Object.entries(formData.coberturas).forEach(([key, cob]) => {
                if (cob.ativo) {
                    premioAnual += cob.precoAnual;
                }
            });
            
            // IOF
            premioAnual *= 1.0038;
            
            const mensalDebito = Math.round(premioAnual / 12);
            const mensalCartao = Math.round(mensalDebito * 0.9); // 10% desconto
            
            formData.valorEstimadoMin = mensalCartao;
            formData.valorEstimadoMax = mensalDebito;
            
            // Atualizar UI
            document.getElementById('resultValue').textContent = `R$ ${mensalCartao} - R$ ${mensalDebito}`;
            
            // Resumo
            const ocupacaoLabels = {
                'empregado': 'Empregado CLT',
                'servidor': 'Servidor P√∫blico',
                'autonomo': 'Aut√¥nomo',
                'empresario': 'Empres√°rio',
                'aposentado': 'Aposentado',
                'estudante': 'Estudante',
                'do_lar': 'Do lar'
            };
            
            document.getElementById('sumIdade').textContent = `${formData.idade} anos`;
            document.getElementById('sumOcupacao').textContent = ocupacaoLabels[formData.ocupacao] || formData.ocupacao;
            document.getElementById('sumCapital').textContent = `R$ ${capital.toLocaleString('pt-BR')}`;
            
            // Grid de coberturas
            let coveragesHtml = `
                <div class="coverage-summary-item">
                    <div class="coverage-summary-icon">üíÄ</div>
                    <div class="coverage-summary-name">Morte</div>
                    <div class="coverage-summary-value">R$ ${(capital/1000)}k</div>
                </div>
                <div class="coverage-summary-item">
                    <div class="coverage-summary-icon">‚ö°</div>
                    <div class="coverage-summary-name">+ Acidental</div>
                    <div class="coverage-summary-value">R$ ${(capital/1000)}k</div>
                </div>
            `;
            
            const icons = {
                ipa: '‚ôø', ifpd: 'üè•', doencasGraves: 'üéóÔ∏è', dih: 'üè®', funeral: '‚ö±Ô∏è'
            };
            const nomes = {
                ipa: 'IPA', ifpd: 'IFPD', doencasGraves: 'D. Graves', dih: 'Di√°ria', funeral: 'Funeral'
            };
            
            Object.entries(formData.coberturas).forEach(([key, cob]) => {
                if (cob.ativo) {
                    let valorDisplay = key === 'dih' ? 'R$ 100/dia' : 
                                       key === 'doencasGraves' ? 'R$ 20k' :
                                       key === 'funeral' ? 'R$ 7k' :
                                       `R$ ${(cob.valor/1000)}k`;
                    coveragesHtml += `
                        <div class="coverage-summary-item">
                            <div class="coverage-summary-icon">${icons[key]}</div>
                            <div class="coverage-summary-name">${nomes[key]}</div>
                            <div class="coverage-summary-value">${valorDisplay}</div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('coveragesGrid').innerHTML = coveragesHtml;
            
            // Dica final
            const diaria = (mensalDebito / 30).toFixed(2);
            document.getElementById('finalTipText').textContent = 
                `Sua fam√≠lia estar√° protegida por R$ ${diaria} por dia. √â menos que um cafezinho!`;
            
            // WhatsApp
            const primeiroNome = formData.nome.split(' ')[0];
            
            let coberturasTexto = [`Morte: R$ ${capital.toLocaleString('pt-BR')}`, `Morte Acidental: +R$ ${capital.toLocaleString('pt-BR')}`];
            Object.entries(formData.coberturas).forEach(([key, cob]) => {
                if (cob.ativo) {
                    let valor = key === 'dih' ? 'R$ 100/dia' : 
                               key === 'doencasGraves' ? 'R$ 20.000' :
                               key === 'funeral' ? 'R$ 7.000' :
                               `R$ ${cob.valor.toLocaleString('pt-BR')}`;
                    coberturasTexto.push(`${nomes[key]}: ${valor}`);
                }
            });
            
            const mensagem = `Ol√° Retorno! Eu sou o(a) ${primeiroNome} üëã\n\n` +
                `Voc√™s disseram que v√£o brigar para chegar em R$ ${mensalCartao} a R$ ${mensalDebito}/m√™s no meu seguro de vida.\n\n` +
                `üë§ *Meus dados:*\n` +
                `‚Ä¢ ${formData.idade} anos - ${formData.sexo === 'M' ? 'Masculino' : 'Feminino'}\n` +
                `‚Ä¢ ${ocupacaoLabels[formData.ocupacao]}\n\n` +
                `üõ°Ô∏è *Coberturas:*\n` +
                coberturasTexto.map(c => `‚Ä¢ ${c}`).join('\n') +
                `\n\n` +
                `Se conseguirem esse valor, eu fecho! ü§ù\n\n` +
                `J√° vou adiantando meus dados para agilizar:\n` +
                `üìã Nome completo: \n` +
                `üìã CPF: \n` +
                `üìã Data de nascimento: `;
            
            const whatsappUrl = `https://wa.me/5554996454300?text=${encodeURIComponent(mensagem)}`;
            document.getElementById('whatsappBtn').href = whatsappUrl;
            
            salvarLead();
            showStep(7);
        }

        // WhatsApp functions
        function formatWhatsapp(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            
            if (value.length > 7) {
                value = `(${value.substring(0, 2)}) ${value.substring(2, 7)}-${value.substring(7)}`;
            } else if (value.length > 2) {
                value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
            } else if (value.length > 0) {
                value = `(${value}`;
            }
            
            input.value = value;
        }
        
        async function salvarWhatsapp() {
            const input = document.getElementById('whatsappInput');
            const whatsapp = input.value.replace(/\D/g, '');
            
            if (whatsapp.length < 10) {
                input.style.borderColor = '#ef4444';
                return;
            }
            
            formData.whatsapp = whatsapp;
            input.style.borderColor = '#25D366';
            
            if (leadDocRef) {
                try {
                    await leadDocRef.update({
                        whatsapp: whatsapp,
                        whatsappInformado: true,
                        ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    document.getElementById('whatsappSaved').style.display = 'block';
                } catch (error) {
                    console.error('Erro ao salvar WhatsApp:', error);
                }
            }
        }
        
        async function registrarCliqueWhatsapp() {
            if (leadDocRef) {
                try {
                    await leadDocRef.update({
                        clicouWhatsapp: true,
                        dataCliqueWhatsapp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Erro ao registrar clique:', error);
                }
            }
        }

        async function salvarLead() {
            try {
                const dadosFinais = {
                    nome: formData.nome,
                    dataNascimento: formData.dataNascimento,
                    idade: formData.idade,
                    sexo: formData.sexo,
                    ocupacao: formData.ocupacao,
                    renda: formData.renda,
                    familia: formData.familia,
                    capital: formData.capital,
                    coberturas: formData.coberturas,
                    valorEstimado: {
                        min: formData.valorEstimadoMin,
                        max: formData.valorEstimadoMax
                    },
                    status: 'completo',
                    ultimoStep: 7,
                    dataFinalizacao: firebase.firestore.FieldValue.serverTimestamp(),
                    ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                    origem: 'site_cotacao_vida_v3'
                };
                
                if (leadDocRef) {
                    await leadDocRef.update(dadosFinais);
                } else {
                    dadosFinais.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                    leadDocRef = await db.collection('leads_cotacao_vida').add(dadosFinais);
                    leadId = leadDocRef.id;
                }
                
                console.log('Lead finalizado:', leadId);

                // ============================================================
                // TAMB√âM SALVA EM leads_crm PARA O CRM ADMINISTRATIVO
                // ============================================================
                const coberturasTexto = formData.coberturas && formData.coberturas.length > 0 
                    ? formData.coberturas.map(c => c.nome).join(', ')
                    : 'N√£o selecionadas';
                
                const dadosCRM = {
                    nome: formData.nome,
                    email: '',
                    whatsapp: formData.whatsapp || '',
                    cpf: '',
                    dataNascimento: formData.dataNascimento || '',
                    cep: '',
                    cidade: '',
                    estado: '',
                    ramo: 'vida',
                    responsavelId: null,
                    responsavelNome: null,
                    observacoes: `Capital: R$ ${formData.capital?.toLocaleString('pt-BR') || 'N/A'} | Idade: ${formData.idade || 'N/A'} anos | Ocupa√ß√£o: ${formData.ocupacao || 'N/A'} | Coberturas: ${coberturasTexto}`,
                    status: 'pre_cadastro',
                    origem: 'site',
                    dadosSite: dadosFinais,
                    valorCotacao: formData.valorEstimadoMin || null,
                    seguradora: null,
                    valorPremio: null,
                    comissao: null,
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    criadoPor: 'site_cotacao_vida'
                };

                await db.collection('leads_crm').add(dadosCRM);
                console.log('Lead salvo em leads_crm');

            } catch (error) {
                console.error('Erro ao salvar lead:', error);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('userName');
            nameInput.addEventListener('input', function() {
                document.getElementById('btnStep1').disabled = this.value.trim().length === 0;
            });
            document.getElementById('btnStep1').disabled = true;
            nameInput.focus();
            updateProgress();
        });
        
        // Salvar ao sair
        window.addEventListener('beforeunload', function() {
            if (leadDocRef && formData.nome) {
                navigator.sendBeacon && navigator.sendBeacon(
                    `https://firestore.googleapis.com/v1/projects/retorno-seguros/databases/(default)/documents/leads_cotacao_vida/${leadId}`,
                    JSON.stringify({ abandonou: true, ultimoStep: currentStep })
                );
            }
        });
    </script>
</body>
</html>
