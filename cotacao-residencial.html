<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cota√ß√£o Seguro Residencial | Retorno Seguros</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0088aa;
            --primary-dark: #006680;
            --secondary: #00b8d4;
            --dark-blue: #004d66;
            --light-bg: #f0f9fb;
            --white: #ffffff;
            --text-dark: #1a2b3c;
            --text-light: #5a6b7c;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --orange: #f97316;
            --shadow: 0 4px 20px rgba(0, 136, 170, 0.15);
            --shadow-lg: 0 10px 40px rgba(0, 136, 170, 0.2);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, var(--light-bg) 0%, #e6f4f7 100%);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .header {
            background: var(--white);
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.2rem;
        }

        .logo-text-container {
            display: flex;
            flex-direction: column;
        }

        .logo-text {
            font-weight: 800;
            font-size: 1.3rem;
            color: var(--text-dark);
            letter-spacing: -0.5px;
        }

        .logo-sub {
            font-size: 0.7rem;
            color: var(--primary);
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .progress-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .progress-bar-wrapper {
            background: rgba(0, 136, 170, 0.15);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%;
            border-radius: 10px;
            transition: width 0.4s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .main-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 1.5rem 3rem;
        }

        .step-card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem 1.5rem;
            box-shadow: var(--shadow);
            display: none;
            animation: slideIn 0.4s ease;
        }

        .step-card.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--light-bg), #e0f2f5);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin: 0 auto 1.25rem;
        }

        .step-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .step-subtitle {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .greeting-name {
            color: var(--primary);
        }

        .input-group {
            margin-bottom: 1.25rem;
        }

        .input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .text-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid #e5e9ec;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 136, 170, 0.1);
        }

        .text-input.success {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 0.75rem;
        }

        .input-hint {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .location-display {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 0.875rem;
            margin-top: 0.75rem;
            display: none;
        }

        .location-display.show {
            display: block;
        }

        .location-display p {
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .location-display small {
            color: var(--text-light);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .options-grid.single-col {
            grid-template-columns: 1fr;
        }

        .options-grid.three-cols {
            grid-template-columns: repeat(3, 1fr);
        }

        .option-btn {
            background: var(--white);
            border: 2px solid #e5e9ec;
            border-radius: 14px;
            padding: 1.25rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 0.5rem;
        }

        .option-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .option-btn.selected {
            border-color: var(--primary);
            background: rgba(0, 136, 170, 0.05);
        }

        .option-icon {
            font-size: 1.5rem;
        }

        .option-text {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .option-desc {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .btn-container {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn {
            flex: 1;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--light-bg);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: #e0f2f5;
        }

        /* Calculation Card */
        .calc-card {
            background: linear-gradient(135deg, rgba(0, 136, 170, 0.1), rgba(0, 184, 212, 0.1));
            border: 2px solid var(--primary);
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .calc-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .calc-header span {
            font-weight: 700;
            color: var(--primary);
        }

        .calc-value {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .calc-breakdown {
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.6;
        }

        .calc-breakdown strong {
            color: var(--text-dark);
        }

        /* Coverage Editor */
        .coverage-section {
            margin-bottom: 1.5rem;
        }

        .coverage-section-title {
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .coverage-item {
            border: 2px solid #e5e9ec;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .coverage-item.active {
            border-color: var(--primary);
            background: rgba(0, 136, 170, 0.03);
        }

        .coverage-item.recommended {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .coverage-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .coverage-toggle {
            width: 44px;
            height: 24px;
            background: #d0d5dd;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .coverage-toggle.on {
            background: var(--primary);
        }

        .coverage-toggle::after {
            content: '';
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .coverage-toggle.on::after {
            left: 22px;
        }

        .coverage-info {
            flex: 1;
        }

        .coverage-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .coverage-desc {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .coverage-value-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e9ec;
        }

        .coverage-value-label {
            font-size: 0.8rem;
            color: var(--text-light);
            white-space: nowrap;
        }

        .coverage-value-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 2px solid #e5e9ec;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            text-align: right;
            max-width: 140px;
        }

        .coverage-value-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .coverage-price {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 600;
            white-space: nowrap;
        }

        .coverage-badge {
            background: var(--success);
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Items Grid */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .item-chip {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 2px solid #e5e9ec;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .item-chip:hover {
            border-color: var(--primary);
        }

        .item-chip.selected {
            border-color: var(--primary);
            background: rgba(0, 136, 170, 0.05);
        }

        .item-chip-icon {
            font-size: 1.1rem;
        }

        /* Result Styles */
        .result-card {
            background: linear-gradient(135deg, var(--primary), var(--dark-blue));
            border-radius: 20px;
            padding: 2rem;
            color: white;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .result-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .result-installment {
            font-size: 1rem;
            opacity: 0.9;
        }

        .result-promise {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.95rem;
        }

        .result-promise strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        /* Summary */
        .summary-section {
            background: var(--light-bg);
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .summary-title {
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .summary-edit {
            font-size: 0.8rem;
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: var(--text-light);
        }

        .summary-value {
            font-weight: 600;
            color: var(--text-dark);
            text-align: right;
        }

        /* Coverages Summary */
        .coverages-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .coverage-summary-item {
            background: var(--white);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .coverage-summary-icon {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .coverage-summary-name {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .coverage-summary-value {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Tip Box */
        .tip-box {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(245, 158, 11, 0.1));
            border: 2px solid var(--orange);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .tip-box.success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }

        .tip-box-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .tip-box-header span {
            font-weight: 700;
            color: var(--orange);
        }

        .tip-box.success .tip-box-header span {
            color: var(--success);
        }

        .tip-box p {
            font-size: 0.85rem;
            color: var(--text-dark);
            line-height: 1.5;
        }

        .whatsapp-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            padding: 1.25rem;
            background: #25D366;
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .whatsapp-btn:hover {
            background: #20bd5a;
            transform: translateY(-2px);
        }

        .info-box {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-box p {
            font-size: 0.9rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        .info-box strong {
            color: var(--primary);
        }

        .info-tooltip {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 0.875rem 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .info-tooltip::before {
            content: '‚ÑπÔ∏è';
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 136, 170, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .step-card {
                padding: 1.5rem 1.25rem;
            }

            .step-title {
                font-size: 1.3rem;
            }

            .result-value {
                font-size: 2rem;
            }

            .options-grid, .items-grid {
                grid-template-columns: 1fr;
            }

            .options-grid.three-cols {
                grid-template-columns: 1fr 1fr;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .coverages-summary {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">
                <div class="logo-icon">R</div>
                <div class="logo-text-container">
                    <span class="logo-text">Retorno</span>
                    <span class="logo-sub">Seguros</span>
                </div>
            </a>
        </div>
    </header>

    <!-- Progress -->
    <div class="progress-container">
        <div class="progress-bar-wrapper">
            <div class="progress-bar-fill" id="progressBar" style="width: 11%"></div>
        </div>
        <div class="progress-text" id="progressText">Passo 1 de 9</div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        
        <!-- Step 1: Nome -->
        <div class="step-card active" id="step1">
            <div class="step-icon">üè†</div>
            <h2 class="step-title">Proteja seu lar!</h2>
            <p class="step-subtitle">Vamos encontrar a prote√ß√£o ideal para sua casa. Como posso te chamar?</p>
            
            <div class="input-group">
                <input type="text" class="text-input" id="userName" placeholder="Seu nome" autocomplete="off">
            </div>

            <div class="btn-container">
                <button class="btn btn-primary" onclick="nextStep(1)" id="btnStep1">Come√ßar</button>
            </div>
        </div>

        <!-- Step 2: CEP e Localiza√ß√£o -->
        <div class="step-card" id="step2">
            <div class="step-icon">üìç</div>
            <h2 class="step-title">Onde fica seu im√≥vel, <span class="greeting-name" id="greetingName"></span>?</h2>
            <p class="step-subtitle">Precisamos do CEP para calcular o valor de reconstru√ß√£o da sua regi√£o</p>
            
            <div class="input-group">
                <label class="input-label">CEP</label>
                <input type="text" class="text-input" id="cepInput" placeholder="00000-000" maxlength="9" oninput="formatCep(this); buscarCep()">
                <div class="location-display" id="locationDisplay">
                    <p id="locationText"></p>
                </div>
            </div>

            <div class="info-box">
                <p>üí° <strong>Por que pedimos o CEP?</strong> O custo de reconstru√ß√£o varia por regi√£o. Uma casa em S√£o Paulo custa diferente de uma no interior do RS.</p>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(2)">Voltar</button>
                <button class="btn btn-primary" onclick="nextStep(2)" disabled id="btnStep2">Continuar</button>
            </div>
        </div>

        <!-- Step 3: Tipo de Im√≥vel -->
        <div class="step-card" id="step3">
            <div class="step-icon">üèóÔ∏è</div>
            <h2 class="step-title">Tipo do im√≥vel</h2>
            <p class="step-subtitle">Selecione o que melhor descreve sua resid√™ncia</p>
            
            <div class="options-grid">
                <div class="option-btn" onclick="selectOption(this, 'tipoImovel', 'apartamento')">
                    <span class="option-icon">üè¢</span>
                    <span class="option-text">Apartamento</span>
                </div>
                <div class="option-btn" onclick="selectOption(this, 'tipoImovel', 'casa_condominio')">
                    <span class="option-icon">üèòÔ∏è</span>
                    <span class="option-text">Casa em condom√≠nio</span>
                </div>
                <div class="option-btn" onclick="selectOption(this, 'tipoImovel', 'casa')">
                    <span class="option-icon">üè°</span>
                    <span class="option-text">Casa</span>
                </div>
                <div class="option-btn" onclick="selectOption(this, 'tipoImovel', 'sobrado')">
                    <span class="option-icon">üè†</span>
                    <span class="option-text">Sobrado</span>
                </div>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(3)">Voltar</button>
                <button class="btn btn-primary" onclick="nextStep(3)" disabled id="btnStep3">Continuar</button>
            </div>
        </div>

        <!-- Step 4: Tipo de Constru√ß√£o -->
        <div class="step-card" id="step4">
            <div class="step-icon">üß±</div>
            <h2 class="step-title">Tipo de constru√ß√£o</h2>
            <p class="step-subtitle">Qual o material predominante da constru√ß√£o?</p>
            
            <div class="options-grid single-col">
                <div class="option-btn" onclick="selectOption(this, 'tipoConstrucao', 'alvenaria')">
                    <span class="option-icon">üß±</span>
                    <span class="option-text">Alvenaria</span>
                    <span class="option-desc">Tijolo, concreto, bloco</span>
                </div>
                <div class="option-btn" onclick="selectOption(this, 'tipoConstrucao', 'mista')">
                    <span class="option-icon">üèóÔ∏è</span>
                    <span class="option-text">Mista</span>
                    <span class="option-desc">Alvenaria com at√© 25% de madeira</span>
                </div>
                <div class="option-btn" onclick="selectOption(this, 'tipoConstrucao', 'madeira')">
                    <span class="option-icon">ü™µ</span>
                    <span class="option-text">Madeira</span>
                    <span class="option-desc">Mais de 25% de madeira</span>
                </div>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(4)">Voltar</button>
                <button class="btn btn-primary" onclick="nextStep(4)" disabled id="btnStep4">Continuar</button>
            </div>
        </div>

        <!-- Step 5: Uso do Im√≥vel -->
        <div class="step-card" id="step5">
            <div class="step-icon">üîë</div>
            <h2 class="step-title">Como voc√™ usa o im√≥vel?</h2>
            <p class="step-subtitle">Isso influencia no risco e nas coberturas</p>
            
            <div class="options-grid single-col">
                <div class="option-btn" onclick="selectOption(this, 'usoImovel', 'residencia')">
                    <span class="option-icon">üë®‚Äçüë©‚Äçüëß</span>
                    <span class="option-text">Minha resid√™ncia</span>
                    <span class="option-desc">Moro aqui o ano todo</span>
                </div>
                <div class="option-btn" onclick="selectOption(this, 'usoImovel', 'veraneio')">
                    <span class="option-icon">üèñÔ∏è</span>
                    <span class="option-text">Veraneio / Temporada</span>
                    <span class="option-desc">Fica vazio parte do ano</span>
                </div>
                <div class="option-btn" onclick="selectOption(this, 'usoImovel', 'alugado')">
                    <span class="option-icon">üìù</span>
                    <span class="option-text">Est√° alugado</span>
                    <span class="option-desc">Sou propriet√°rio</span>
                </div>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(5)">Voltar</button>
                <button class="btn btn-primary" onclick="nextStep(5)" disabled id="btnStep5">Continuar</button>
            </div>
        </div>

        <!-- Step 6: Metragem e C√°lculo -->
        <div class="step-card" id="step6">
            <div class="step-icon">üìê</div>
            <h2 class="step-title">√Årea constru√≠da</h2>
            <p class="step-subtitle">Quantos m¬≤ tem a √°rea constru√≠da do im√≥vel?</p>
            
            <div class="input-group">
                <label class="input-label">√Årea em m¬≤</label>
                <input type="number" class="text-input" id="metrosInput" placeholder="Ex: 120" min="20" max="2000" oninput="calcularValorImovel()">
                <p class="input-hint">Inclua garagem e √°rea de servi√ßo cobertas</p>
            </div>

            <div class="calc-card" id="calcCard" style="display: none;">
                <div class="calc-header">
                    <span>üí∞ Valor estimado de reconstru√ß√£o</span>
                </div>
                <div class="calc-value" id="calcValue">R$ 240.000</div>
                <div class="calc-breakdown" id="calcBreakdown">
                    <strong>Como calculamos:</strong><br>
                    120 m¬≤ √ó R$ 2.000/m¬≤ (padr√£o m√©dio da sua regi√£o)
                </div>
            </div>

            <div class="info-box">
                <p>‚ö†Ô∏è <strong>Importante:</strong> Este √© o custo para reconstruir o im√≥vel do zero, n√£o o valor de mercado. Um apartamento de R$ 500 mil pode custar R$ 200 mil para reconstruir.</p>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(6)">Voltar</button>
                <button class="btn btn-primary" onclick="nextStep(6)" disabled id="btnStep6">Continuar</button>
            </div>
        </div>

        <!-- Step 7: O que tem em casa (Conte√∫do) -->
        <div class="step-card" id="step7">
            <div class="step-icon">üì∫</div>
            <h2 class="step-title">O que voc√™ tem em casa?</h2>
            <p class="step-subtitle">Isso ajuda a calcular o valor do conte√∫do (m√≥veis, eletr√¥nicos, etc)</p>
            
            <div class="items-grid">
                <div class="item-chip" onclick="toggleItem(this, 'tv')">
                    <span class="item-chip-icon">üì∫</span>
                    <span>TVs</span>
                </div>
                <div class="item-chip" onclick="toggleItem(this, 'computador')">
                    <span class="item-chip-icon">üíª</span>
                    <span>Computadores</span>
                </div>
                <div class="item-chip" onclick="toggleItem(this, 'celular')">
                    <span class="item-chip-icon">üì±</span>
                    <span>Celulares/Tablets</span>
                </div>
                <div class="item-chip" onclick="toggleItem(this, 'geladeira')">
                    <span class="item-chip-icon">üßä</span>
                    <span>Geladeira</span>
                </div>
                <div class="item-chip" onclick="toggleItem(this, 'ar')">
                    <span class="item-chip-icon">‚ùÑÔ∏è</span>
                    <span>Ar-condicionado</span>
                </div>
                <div class="item-chip" onclick="toggleItem(this, 'maquina')">
                    <span class="item-chip-icon">üß∫</span>
                    <span>M√°q. Lavar/Secar</span>
                </div>
                <div class="item-chip" onclick="toggleItem(this, 'moveis')">
                    <span class="item-chip-icon">üõãÔ∏è</span>
                    <span>M√≥veis planejados</span>
                </div>
                <div class="item-chip" onclick="toggleItem(this, 'joias')">
                    <span class="item-chip-icon">üíé</span>
                    <span>Joias/Rel√≥gios</span>
                </div>
                <div class="item-chip" onclick="toggleItem(this, 'bicicleta')">
                    <span class="item-chip-icon">üö¥</span>
                    <span>Bicicletas</span>
                </div>
                <div class="item-chip" onclick="toggleItem(this, 'instrumentos')">
                    <span class="item-chip-icon">üé∏</span>
                    <span>Instrumentos</span>
                </div>
                <div class="item-chip" onclick="toggleItem(this, 'homeoffice')">
                    <span class="item-chip-icon">üñ•Ô∏è</span>
                    <span>Home Office</span>
                </div>
                <div class="item-chip" onclick="toggleItem(this, 'arte')">
                    <span class="item-chip-icon">üñºÔ∏è</span>
                    <span>Obras de arte</span>
                </div>
            </div>

            <div class="calc-card" id="conteudoCard">
                <div class="calc-header">
                    <span>üì¶ Valor estimado do conte√∫do</span>
                </div>
                <div class="calc-value" id="conteudoValue">R$ 30.000</div>
                <div class="calc-breakdown" id="conteudoBreakdown">
                    Base: R$ 30.000 (m√©dia para uma resid√™ncia)
                </div>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(7)">Voltar</button>
                <button class="btn btn-primary" onclick="nextStep(7)">Continuar</button>
            </div>
        </div>

        <!-- Step 8: Coberturas -->
        <div class="step-card" id="step8">
            <div class="step-icon">üõ°Ô∏è</div>
            <h2 class="step-title">Monte sua prote√ß√£o</h2>
            <p class="step-subtitle">Ajustamos as coberturas para seu perfil. Voc√™ pode editar os valores!</p>
            
            <!-- Cobertura B√°sica (sempre inclusa) -->
            <div class="coverage-section">
                <div class="coverage-section-title">‚úÖ Cobertura B√°sica (sempre inclusa)</div>
                
                <div class="coverage-item active">
                    <div class="coverage-header">
                        <div class="coverage-toggle on" style="pointer-events: none;"></div>
                        <div class="coverage-info">
                            <div class="coverage-name">üî• Inc√™ndio, Raio, Explos√£o e Fuma√ßa</div>
                            <div class="coverage-desc">Cobertura obrigat√≥ria - protege a estrutura do im√≥vel</div>
                        </div>
                    </div>
                    <div class="coverage-value-container">
                        <span class="coverage-value-label">Valor segurado:</span>
                        <input type="text" class="coverage-value-input" id="cob_basica" value="R$ 240.000" onchange="updateCoverageValue(this, 'basica')">
                        <span class="coverage-price" id="price_basica">~R$ 480/ano</span>
                    </div>
                </div>
            </div>

            <!-- Coberturas Adicionais -->
            <div class="coverage-section">
                <div class="coverage-section-title">‚≠ê Coberturas Adicionais</div>
                <div id="additionalCoverages">
                    <!-- Preenchido via JS -->
                </div>
            </div>

            <div class="tip-box" id="coverageTip">
                <div class="tip-box-header">
                    <span>üí° Sugest√£o Retorno</span>
                </div>
                <p id="coverageTipText">Selecionamos as coberturas mais importantes para seu perfil. Voc√™ pode ajustar os valores clicando nos campos.</p>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="prevStep(8)">Voltar</button>
                <button class="btn btn-primary" onclick="calcularResultado()">Ver minha cota√ß√£o</button>
            </div>
        </div>

        <!-- Step 9: Resultado -->
        <div class="step-card" id="step9">
            <div class="step-icon">üéâ</div>
            <h2 class="step-title">Sua cota√ß√£o est√° pronta!</h2>
            
            <div class="result-card">
                <div class="result-label">Valor estimado anual</div>
                <div class="result-value" id="resultValue">R$ 850 - R$ 1.050</div>
                <div class="result-installment" id="resultInstallment">ou 12x de ~R$ 79 no cart√£o</div>
                <div class="result-promise">
                    <strong>ü§ù Vamos brigar por esse valor!</strong>
                    Se a gente conseguir, voc√™ fecha com a Retorno?
                </div>
            </div>

            <!-- Resumo do Im√≥vel -->
            <div class="summary-section">
                <div class="summary-title">
                    üè† Seu im√≥vel
                    <span class="summary-edit" onclick="goToStep(2)">Editar</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Localiza√ß√£o</span>
                    <span class="summary-value" id="sumLocation">Passo Fundo/RS</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Tipo</span>
                    <span class="summary-value" id="sumTipo">Casa</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Constru√ß√£o</span>
                    <span class="summary-value" id="sumConstrucao">Alvenaria</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">√Årea</span>
                    <span class="summary-value" id="sumArea">120 m¬≤</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Valor reconstru√ß√£o</span>
                    <span class="summary-value" id="sumValorImovel">R$ 240.000</span>
                </div>
            </div>

            <!-- Resumo das Coberturas -->
            <div class="summary-section">
                <div class="summary-title">
                    üõ°Ô∏è Suas coberturas
                    <span class="summary-edit" onclick="goToStep(8)">Editar</span>
                </div>
                <div class="coverages-summary" id="coveragesSummary">
                    <!-- Preenchido via JS -->
                </div>
            </div>

            <!-- Dica Final -->
            <div class="tip-box success" id="finalTip">
                <div class="tip-box-header">
                    <span>‚úÖ √ìtima prote√ß√£o!</span>
                </div>
                <p id="finalTipText">Seu lar est√° bem protegido. O seguro residencial custa menos de R$ 3 por dia e pode evitar preju√≠zos de dezenas de milhares de reais.</p>
            </div>

            <!-- Campo WhatsApp Opcional -->
            <div class="whatsapp-capture" style="background: linear-gradient(135deg, rgba(37, 211, 102, 0.1), rgba(0, 136, 170, 0.1)); border: 2px solid #25D366; border-radius: 14px; padding: 1.25rem; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <span style="font-size: 1.25rem;">üì±</span>
                    <span style="font-weight: 700; color: #128C7E;">Garanta o melhor pre√ßo!</span>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.75rem;">
                    Deixa seu WhatsApp que a gente te avisa assim que conseguir uma condi√ß√£o especial. Sem spam, prometido! ü§û
                </p>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="tel" id="whatsappInput" class="text-input" placeholder="(54) 99999-9999" 
                           style="flex: 1;" oninput="formatWhatsapp(this)" maxlength="15">
                    <button onclick="salvarWhatsapp()" style="background: #25D366; color: white; border: none; border-radius: 10px; padding: 0 1.25rem; font-weight: 600; cursor: pointer; white-space: nowrap;">
                        Salvar
                    </button>
                </div>
                <p id="whatsappSaved" style="display: none; color: #128C7E; font-size: 0.85rem; margin-top: 0.5rem; font-weight: 600;">
                    ‚úÖ Salvo! Vamos te avisar por l√°.
                </p>
            </div>

            <a href="#" class="whatsapp-btn" id="whatsappBtn" target="_blank" onclick="registrarCliqueWhatsapp()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
                Sim! Quero fechar com a Retorno
            </a>

            <div class="info-tooltip">
                Ao clicar, voc√™ ser√° direcionado para o WhatsApp. J√° vamos receber seu n√∫mero automaticamente!
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB5Q-PbJOH54SnssnFfaVgayXuLOgDCoBc",
            authDomain: "cotador-seguros-aacb6.firebaseapp.com",
            projectId: "cotador-seguros-aacb6",
            storageBucket: "cotador-seguros-aacb6.firebasestorage.app",
            messagingSenderId: "547890075498",
            appId: "1:547890075498:web:7f866448c03ae37d3ac498"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ID √∫nico da sess√£o para rastrear o lead
        let leadId = null;
        let leadDocRef = null;

        // Custo por m¬≤ por estado (padr√£o m√©dio SINAPI/CUB)
        const custoM2PorEstado = {
            'AC': 1800, 'AL': 1750, 'AP': 1850, 'AM': 1900, 'BA': 1800,
            'CE': 1750, 'DF': 2200, 'ES': 1950, 'GO': 1850, 'MA': 1700,
            'MT': 1850, 'MS': 1800, 'MG': 1900, 'PA': 1800, 'PB': 1700,
            'PR': 2000, 'PE': 1800, 'PI': 1650, 'RJ': 2300, 'RN': 1750,
            'RS': 2000, 'RO': 1850, 'RR': 1900, 'SC': 2100, 'SP': 2400,
            'SE': 1750, 'TO': 1800
        };

        // Form Data
        let currentStep = 1;
        const totalSteps = 9;
        
        const formData = {
            nome: '',
            cep: '',
            cidade: '',
            estado: '',
            tipoImovel: '',
            tipoConstrucao: '',
            usoImovel: '',
            metros: 0,
            custoM2: 2000,
            valorImovel: 0,
            itens: [],
            valorConteudo: 30000,
            coberturas: {},
            whatsapp: '',
            valorEstimadoMin: 0,
            valorEstimadoMax: 0
        };

        // Coberturas dispon√≠veis com pre√ßos base
        const coberturasConfig = {
            moradia: { 
                nome: 'üè® Moradia Tempor√°ria', 
                desc: 'Se sua casa ficar inabit√°vel, cobre aluguel tempor√°rio',
                valorSugerido: 60000,
                taxaBase: 0.0009,
                recomendadoPara: ['residencia', 'veraneio']
            },
            vendaval: { 
                nome: 'üå™Ô∏è Vendaval, Granizo e Tornado', 
                desc: 'Danos causados por tempestades e ventos fortes',
                valorSugerido: 100000,
                taxaBase: 0.0055,
                recomendadoPara: ['casa', 'sobrado', 'casa_condominio']
            },
            eletricos: { 
                nome: '‚ö° Danos El√©tricos', 
                desc: 'Queima de equipamentos por raio ou oscila√ß√£o',
                valorSugerido: 15000,
                taxaBase: 0.042,
                recomendadoPara: ['eletronicos']
            },
            roubo: { 
                nome: 'üîê Roubo e Furto Qualificado', 
                desc: 'Roubo de bens dentro do im√≥vel',
                valorSugerido: 20000,
                taxaBase: 0.023,
                recomendadoPara: ['veraneio', 'joias', 'bicicleta']
            },
            vidros: { 
                nome: 'ü™ü Vidros, M√°rmores e Granitos', 
                desc: 'Quebra acidental de vidros, espelhos, bancadas',
                valorSugerido: 10000,
                taxaBase: 0.0098,
                recomendadoPara: ['moveis']
            },
            alagamento: { 
                nome: 'üíß Alagamento e Inunda√ß√£o', 
                desc: 'Danos por enchentes, chuvas fortes',
                valorSugerido: 15000,
                taxaBase: 0.030,
                recomendadoPara: []
            },
            rc: { 
                nome: 'üë®‚Äçüë©‚Äçüëß Responsabilidade Civil Familiar', 
                desc: 'Danos que voc√™ ou fam√≠lia causarem a terceiros',
                valorSugerido: 100000,
                taxaBase: 0.00054,
                recomendadoPara: ['residencia']
            },
            equipamentos: { 
                nome: 'üíª Equipamentos Port√°teis', 
                desc: 'Notebooks, tablets, celulares dentro de casa',
                valorSugerido: 15000,
                taxaBase: 0.0036,
                recomendadoPara: ['homeoffice', 'computador', 'celular']
            },
            tubulacoes: { 
                nome: 'üîß Ruptura de Tubula√ß√µes', 
                desc: 'Vazamentos e danos por rompimento de canos',
                valorSugerido: 15000,
                taxaBase: 0.0049,
                recomendadoPara: ['casa', 'sobrado']
            },
            salvamento: { 
                nome: 'üöí Despesas de Salvamento', 
                desc: 'Custos para minimizar danos em sinistro',
                valorSugerido: 30000,
                taxaBase: 0.0011,
                recomendadoPara: []
            }
        };

        // Progress
        function updateProgress() {
            const percent = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `Passo ${currentStep} de ${totalSteps}`;
        }
        
        // Salvar lead parcial a cada step
        async function salvarLeadParcial() {
            try {
                const dadosLead = {
                    nome: formData.nome || '',
                    cep: formData.cep || '',
                    cidade: formData.cidade || '',
                    estado: formData.estado || '',
                    tipoImovel: formData.tipoImovel || '',
                    tipoConstrucao: formData.tipoConstrucao || '',
                    usoImovel: formData.usoImovel || '',
                    metros: formData.metros || 0,
                    valorImovel: formData.valorImovel || 0,
                    valorConteudo: formData.valorConteudo || 0,
                    itens: formData.itens || [],
                    coberturas: formData.coberturas || {},
                    whatsapp: formData.whatsapp || '',
                    ultimoStep: currentStep,
                    status: currentStep >= 9 ? 'completo' : 'parcial',
                    ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                    origem: 'site_cotacao_residencial_v3',
                    userAgent: navigator.userAgent,
                    telaLargura: window.innerWidth
                };
                
                if (leadDocRef) {
                    // Atualizar lead existente
                    await leadDocRef.update(dadosLead);
                } else {
                    // Criar novo lead
                    dadosLead.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                    leadDocRef = await db.collection('leads_cotacao_residencial').add(dadosLead);
                    leadId = leadDocRef.id;
                }
                
                console.log('Lead salvo/atualizado:', leadId, 'Step:', currentStep);
            } catch (error) {
                console.error('Erro ao salvar lead parcial:', error);
            }
        }

        function showStep(step) {
            document.querySelectorAll('.step-card').forEach(card => card.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
            updateProgress();
            
            // Salvar lead parcial a cada mudan√ßa de step (ap√≥s step 1)
            if (step > 1) {
                salvarLeadParcial();
            }
            
            if (step === 8) {
                gerarCoberturas();
            }
        }

        function goToStep(step) {
            showStep(step);
        }

        function nextStep(step) {
            if (step === 1) {
                formData.nome = document.getElementById('userName').value.trim();
                document.getElementById('greetingName').textContent = formData.nome.split(' ')[0];
            }
            showStep(step + 1);
        }

        function prevStep(step) {
            showStep(step - 1);
        }

        function selectOption(element, field, value) {
            const parent = element.parentElement;
            parent.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            formData[field] = value;
            
            const btnId = `btnStep${currentStep}`;
            const btn = document.getElementById(btnId);
            if (btn) btn.disabled = false;
        }

        // CEP
        function formatCep(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 8);
            }
            input.value = value;
        }

        async function buscarCep() {
            const cep = document.getElementById('cepInput').value.replace(/\D/g, '');
            const locationDisplay = document.getElementById('locationDisplay');
            const btn = document.getElementById('btnStep2');
            
            if (cep.length !== 8) {
                locationDisplay.classList.remove('show');
                btn.disabled = true;
                return;
            }
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                
                if (data.erro) {
                    document.getElementById('locationText').innerHTML = '‚ùå CEP n√£o encontrado';
                    locationDisplay.classList.add('show');
                    btn.disabled = true;
                    return;
                }
                
                formData.cep = cep;
                formData.cidade = data.localidade;
                formData.estado = data.uf;
                formData.custoM2 = custoM2PorEstado[data.uf] || 2000;
                
                document.getElementById('locationText').innerHTML = `
                    üìç <strong>${data.localidade}/${data.uf}</strong><br>
                    <small>Custo m√©dio de constru√ß√£o: R$ ${formData.custoM2.toLocaleString('pt-BR')}/m¬≤</small>
                `;
                locationDisplay.classList.add('show');
                document.getElementById('cepInput').classList.add('success');
                btn.disabled = false;
                
            } catch (error) {
                document.getElementById('locationText').innerHTML = '‚ùå Erro ao buscar CEP';
                locationDisplay.classList.add('show');
                btn.disabled = true;
            }
        }

        // C√°lculo valor im√≥vel
        function calcularValorImovel() {
            const metros = parseInt(document.getElementById('metrosInput').value) || 0;
            const calcCard = document.getElementById('calcCard');
            const btn = document.getElementById('btnStep6');
            
            if (metros < 20) {
                calcCard.style.display = 'none';
                btn.disabled = true;
                return;
            }
            
            formData.metros = metros;
            
            // Ajuste por tipo de constru√ß√£o
            let multiplicador = 1.0;
            if (formData.tipoConstrucao === 'madeira') multiplicador = 0.7;
            if (formData.tipoConstrucao === 'mista') multiplicador = 0.85;
            
            const valorCalculado = Math.round(metros * formData.custoM2 * multiplicador);
            formData.valorImovel = valorCalculado;
            
            document.getElementById('calcValue').textContent = `R$ ${valorCalculado.toLocaleString('pt-BR')}`;
            document.getElementById('calcBreakdown').innerHTML = `
                <strong>Como calculamos:</strong><br>
                ${metros} m¬≤ √ó R$ ${formData.custoM2.toLocaleString('pt-BR')}/m¬≤ 
                ${multiplicador !== 1 ? `√ó ${multiplicador} (${formData.tipoConstrucao})` : '(padr√£o m√©dio ${formData.estado})'}
            `;
            
            calcCard.style.display = 'block';
            btn.disabled = false;
        }

        // Itens da casa
        function toggleItem(element, value) {
            element.classList.toggle('selected');
            
            if (element.classList.contains('selected')) {
                if (!formData.itens.includes(value)) {
                    formData.itens.push(value);
                }
            } else {
                formData.itens = formData.itens.filter(i => i !== value);
            }
            
            calcularValorConteudo();
        }

        function calcularValorConteudo() {
            // Valores estimados por item
            const valoresItens = {
                tv: 3000,
                computador: 4000,
                celular: 3000,
                geladeira: 3500,
                ar: 2500,
                maquina: 3000,
                moveis: 15000,
                joias: 8000,
                bicicleta: 5000,
                instrumentos: 4000,
                homeoffice: 8000,
                arte: 10000
            };
            
            let valorTotal = 20000; // Base m√≠nima
            let descricao = ['Base: R$ 20.000'];
            
            formData.itens.forEach(item => {
                if (valoresItens[item]) {
                    valorTotal += valoresItens[item];
                    descricao.push(`+ ${item}: R$ ${valoresItens[item].toLocaleString('pt-BR')}`);
                }
            });
            
            formData.valorConteudo = valorTotal;
            
            document.getElementById('conteudoValue').textContent = `R$ ${valorTotal.toLocaleString('pt-BR')}`;
            document.getElementById('conteudoBreakdown').innerHTML = descricao.slice(0, 4).join('<br>') + 
                (descricao.length > 4 ? `<br>... e mais ${descricao.length - 4} itens` : '');
        }

        // Gerar coberturas personalizadas
        function gerarCoberturas() {
            const container = document.getElementById('additionalCoverages');
            
            // Atualizar valor da cobertura b√°sica
            document.getElementById('cob_basica').value = `R$ ${formData.valorImovel.toLocaleString('pt-BR')}`;
            const precoBasica = Math.round(formData.valorImovel * 0.0005);
            document.getElementById('price_basica').textContent = `~R$ ${precoBasica.toLocaleString('pt-BR')}/ano`;
            formData.coberturas.basica = { valor: formData.valorImovel, preco: precoBasica, ativo: true };
            
            let html = '';
            
            Object.entries(coberturasConfig).forEach(([key, config]) => {
                // Verificar se √© recomendado
                let isRecomendado = false;
                config.recomendadoPara.forEach(cond => {
                    if (formData.tipoImovel === cond || 
                        formData.usoImovel === cond || 
                        formData.itens.includes(cond)) {
                        isRecomendado = true;
                    }
                });
                
                // Apartamento n√£o precisa tanto de vendaval
                if (key === 'vendaval' && formData.tipoImovel === 'apartamento') {
                    isRecomendado = false;
                }
                
                // Apartamento em condom√≠nio n√£o precisa tanto de roubo
                if (key === 'roubo' && formData.tipoImovel === 'apartamento' && formData.usoImovel === 'residencia') {
                    isRecomendado = false;
                }
                
                // Se tem eletr√¥nicos, danos el√©tricos √© muito recomendado
                if (key === 'eletricos' && formData.itens.some(i => ['tv', 'computador', 'geladeira', 'ar', 'maquina'].includes(i))) {
                    isRecomendado = true;
                }
                
                const preco = Math.round(config.valorSugerido * config.taxaBase);
                
                // Inicializar no formData
                formData.coberturas[key] = {
                    valor: config.valorSugerido,
                    preco: preco,
                    ativo: isRecomendado
                };
                
                html += `
                    <div class="coverage-item ${isRecomendado ? 'active recommended' : ''}" id="cov_${key}">
                        <div class="coverage-header">
                            <div class="coverage-toggle ${isRecomendado ? 'on' : ''}" onclick="toggleCoverage('${key}')"></div>
                            <div class="coverage-info">
                                <div class="coverage-name">${config.nome}${isRecomendado ? '<span class="coverage-badge">Sugest√£o</span>' : ''}</div>
                                <div class="coverage-desc">${config.desc}</div>
                            </div>
                        </div>
                        <div class="coverage-value-container">
                            <span class="coverage-value-label">Valor:</span>
                            <input type="text" class="coverage-value-input" id="val_${key}" 
                                   value="R$ ${config.valorSugerido.toLocaleString('pt-BR')}" 
                                   onchange="updateCoverageValue(this, '${key}')">
                            <span class="coverage-price" id="price_${key}">~R$ ${preco.toLocaleString('pt-BR')}/ano</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Atualizar dica
            let dicas = [];
            if (formData.itens.some(i => ['tv', 'computador', 'geladeira'].includes(i))) {
                dicas.push('Voc√™ tem eletr√¥nicos - Danos El√©tricos √© essencial!');
            }
            if (formData.usoImovel === 'veraneio') {
                dicas.push('Im√≥vel de veraneio - Roubo √© muito importante.');
            }
            if (['casa', 'sobrado'].includes(formData.tipoImovel)) {
                dicas.push('Casas s√£o mais expostas - Vendaval recomendado.');
            }
            
            if (dicas.length > 0) {
                document.getElementById('coverageTipText').textContent = dicas[0];
            }
        }

        function toggleCoverage(key) {
            const item = document.getElementById(`cov_${key}`);
            const toggle = item.querySelector('.coverage-toggle');
            
            formData.coberturas[key].ativo = !formData.coberturas[key].ativo;
            
            if (formData.coberturas[key].ativo) {
                item.classList.add('active');
                toggle.classList.add('on');
            } else {
                item.classList.remove('active');
                toggle.classList.remove('on');
            }
        }

        function updateCoverageValue(input, key) {
            const valorStr = input.value.replace(/\D/g, '');
            const valor = parseInt(valorStr) || 0;
            
            if (key === 'basica') {
                formData.coberturas.basica.valor = valor;
                const preco = Math.round(valor * 0.0005);
                formData.coberturas.basica.preco = preco;
                document.getElementById('price_basica').textContent = `~R$ ${preco.toLocaleString('pt-BR')}/ano`;
            } else {
                formData.coberturas[key].valor = valor;
                const preco = Math.round(valor * coberturasConfig[key].taxaBase);
                formData.coberturas[key].preco = preco;
                document.getElementById(`price_${key}`).textContent = `~R$ ${preco.toLocaleString('pt-BR')}/ano`;
            }
            
            input.value = `R$ ${valor.toLocaleString('pt-BR')}`;
        }

        function calcularResultado() {
            // Somar pre√ßos das coberturas ativas
            let premioTotal = 0;
            
            Object.entries(formData.coberturas).forEach(([key, cob]) => {
                if (cob.ativo) {
                    premioTotal += cob.preco;
                }
            });
            
            // Ajustes
            if (formData.tipoConstrucao === 'madeira') premioTotal *= 1.4;
            if (formData.tipoConstrucao === 'mista') premioTotal *= 1.15;
            if (formData.usoImovel === 'veraneio') premioTotal *= 1.2;
            if (formData.usoImovel === 'alugado') premioTotal *= 0.9;
            
            // IOF
            premioTotal *= 1.0738;
            
            const min = Math.round(premioTotal * 0.85);
            const max = Math.round(premioTotal * 1.15);
            const parcela = Math.round(max / 12);
            
            formData.valorEstimadoMin = min;
            formData.valorEstimadoMax = max;
            
            // Atualizar UI
            document.getElementById('resultValue').textContent = `R$ ${min.toLocaleString('pt-BR')} - R$ ${max.toLocaleString('pt-BR')}`;
            document.getElementById('resultInstallment').textContent = `ou 12x de ~R$ ${parcela} no cart√£o`;
            
            // Resumo im√≥vel
            const tipoLabels = {
                'apartamento': 'Apartamento',
                'casa_condominio': 'Casa em condom√≠nio',
                'casa': 'Casa',
                'sobrado': 'Sobrado'
            };
            const construcaoLabels = {
                'alvenaria': 'Alvenaria',
                'mista': 'Mista',
                'madeira': 'Madeira'
            };
            
            document.getElementById('sumLocation').textContent = `${formData.cidade}/${formData.estado}`;
            document.getElementById('sumTipo').textContent = tipoLabels[formData.tipoImovel] || '';
            document.getElementById('sumConstrucao').textContent = construcaoLabels[formData.tipoConstrucao] || '';
            document.getElementById('sumArea').textContent = `${formData.metros} m¬≤`;
            document.getElementById('sumValorImovel').textContent = `R$ ${formData.valorImovel.toLocaleString('pt-BR')}`;
            
            // Resumo coberturas
            let coveragesHtml = '';
            const icons = {
                basica: 'üî•', moradia: 'üè®', vendaval: 'üå™Ô∏è', eletricos: '‚ö°',
                roubo: 'üîê', vidros: 'ü™ü', alagamento: 'üíß', rc: 'üë®‚Äçüë©‚Äçüëß',
                equipamentos: 'üíª', tubulacoes: 'üîß', salvamento: 'üöí'
            };
            const nomes = {
                basica: 'Inc√™ndio', moradia: 'Moradia', vendaval: 'Vendaval', eletricos: 'El√©tricos',
                roubo: 'Roubo', vidros: 'Vidros', alagamento: 'Alagamento', rc: 'RC Familiar',
                equipamentos: 'Port√°teis', tubulacoes: 'Tubula√ß√µes', salvamento: 'Salvamento'
            };
            
            Object.entries(formData.coberturas).forEach(([key, cob]) => {
                if (cob.ativo) {
                    coveragesHtml += `
                        <div class="coverage-summary-item">
                            <div class="coverage-summary-icon">${icons[key] || 'üõ°Ô∏è'}</div>
                            <div class="coverage-summary-name">${nomes[key] || key}</div>
                            <div class="coverage-summary-value">R$ ${(cob.valor/1000).toFixed(0)}k</div>
                        </div>
                    `;
                }
            });
            document.getElementById('coveragesSummary').innerHTML = coveragesHtml;
            
            // Dica final
            const diaria = (max / 365).toFixed(2);
            document.getElementById('finalTipText').textContent = 
                `Seu lar est√° bem protegido por menos de R$ ${diaria} por dia. Em caso de sinistro, voc√™ pode evitar preju√≠zos de R$ ${(formData.valorImovel/1000).toFixed(0)} mil ou mais.`;
            
            // WhatsApp
            const primeiroNome = formData.nome.split(' ')[0];
            const valorEstimado = `R$ ${min.toLocaleString('pt-BR')} a R$ ${max.toLocaleString('pt-BR')}`;
            
            let coberturasAtivas = [];
            Object.entries(formData.coberturas).forEach(([key, cob]) => {
                if (cob.ativo) {
                    coberturasAtivas.push(`${nomes[key]}: R$ ${cob.valor.toLocaleString('pt-BR')}`);
                }
            });
            
            const mensagem = `Ol√° Retorno! Eu sou o(a) ${primeiroNome} üëã\n\n` +
                `Voc√™s disseram que v√£o brigar para chegar em ${valorEstimado}/ano no meu seguro residencial.\n\n` +
                `üè† *Meu im√≥vel:*\n` +
                `‚Ä¢ ${tipoLabels[formData.tipoImovel]} em ${formData.cidade}/${formData.estado}\n` +
                `‚Ä¢ ${formData.metros} m¬≤ - ${construcaoLabels[formData.tipoConstrucao]}\n` +
                `‚Ä¢ Valor reconstru√ß√£o: R$ ${formData.valorImovel.toLocaleString('pt-BR')}\n\n` +
                `üõ°Ô∏è *Coberturas:*\n` +
                coberturasAtivas.slice(0, 5).map(c => `‚Ä¢ ${c}`).join('\n') +
                (coberturasAtivas.length > 5 ? `\n‚Ä¢ ... e mais ${coberturasAtivas.length - 5}` : '') +
                `\n\n` +
                `Se conseguirem esse valor, eu fecho! ü§ù\n\n` +
                `J√° vou adiantando meus dados para agilizar:\n` +
                `üìã Nome completo: \n` +
                `üìã CPF: \n` +
                `üìã Data de nascimento: `;
            
            const whatsappUrl = `https://wa.me/5554996454300?text=${encodeURIComponent(mensagem)}`;
            document.getElementById('whatsappBtn').href = whatsappUrl;
            
            salvarLead();
            showStep(9);
        }
        
        // Formatar WhatsApp
        function formatWhatsapp(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            
            if (value.length > 7) {
                value = `(${value.substring(0, 2)}) ${value.substring(2, 7)}-${value.substring(7)}`;
            } else if (value.length > 2) {
                value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
            } else if (value.length > 0) {
                value = `(${value}`;
            }
            
            input.value = value;
        }
        
        // Salvar WhatsApp
        async function salvarWhatsapp() {
            const input = document.getElementById('whatsappInput');
            const whatsapp = input.value.replace(/\D/g, '');
            
            if (whatsapp.length < 10) {
                input.style.borderColor = '#ef4444';
                return;
            }
            
            formData.whatsapp = whatsapp;
            input.style.borderColor = '#25D366';
            
            // Atualizar lead com WhatsApp
            if (leadDocRef) {
                try {
                    await leadDocRef.update({
                        whatsapp: whatsapp,
                        whatsappInformado: true,
                        ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    document.getElementById('whatsappSaved').style.display = 'block';
                    console.log('WhatsApp salvo:', whatsapp);
                } catch (error) {
                    console.error('Erro ao salvar WhatsApp:', error);
                }
            }
        }
        
        // Registrar clique no bot√£o WhatsApp
        async function registrarCliqueWhatsapp() {
            if (leadDocRef) {
                try {
                    await leadDocRef.update({
                        clicouWhatsapp: true,
                        dataCliqueWhatsapp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('Clique WhatsApp registrado');
                } catch (error) {
                    console.error('Erro ao registrar clique:', error);
                }
            }
        }

        async function salvarLead() {
            try {
                const dadosFinais = {
                    nome: formData.nome,
                    cep: formData.cep,
                    cidade: formData.cidade,
                    estado: formData.estado,
                    tipoImovel: formData.tipoImovel,
                    tipoConstrucao: formData.tipoConstrucao,
                    usoImovel: formData.usoImovel,
                    metros: formData.metros,
                    valorImovel: formData.valorImovel,
                    valorConteudo: formData.valorConteudo,
                    itens: formData.itens,
                    coberturas: formData.coberturas,
                    valorEstimado: {
                        min: formData.valorEstimadoMin,
                        max: formData.valorEstimadoMax
                    },
                    status: 'completo',
                    ultimoStep: 9,
                    dataFinalizacao: firebase.firestore.FieldValue.serverTimestamp(),
                    ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                    origem: 'site_cotacao_residencial_v3'
                };
                
                if (leadDocRef) {
                    await leadDocRef.update(dadosFinais);
                } else {
                    dadosFinais.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                    leadDocRef = await db.collection('leads_cotacao_residencial').add(dadosFinais);
                    leadId = leadDocRef.id;
                }
                
                console.log('Lead finalizado:', leadId);

                // ============================================================
                // TAMB√âM SALVA EM leads_crm PARA O CRM ADMINISTRATIVO
                // ============================================================
                const tipoImovelTexto = {
                    'casa': 'Casa',
                    'apartamento': 'Apartamento',
                    'sobrado': 'Sobrado',
                    'kitnet': 'Kitnet/Studio'
                };
                
                const dadosCRM = {
                    nome: formData.nome,
                    email: '',
                    whatsapp: formData.whatsapp || '',
                    cpf: '',
                    dataNascimento: '',
                    cep: formData.cep || '',
                    cidade: formData.cidade || '',
                    estado: formData.estado || '',
                    ramo: 'residencial',
                    responsavelId: null,
                    responsavelNome: null,
                    observacoes: `${tipoImovelTexto[formData.tipoImovel] || formData.tipoImovel} | ${formData.metros || 'N/A'}m¬≤ | Valor Im√≥vel: R$ ${formData.valorImovel?.toLocaleString('pt-BR') || 'N/A'} | Conte√∫do: R$ ${formData.valorConteudo?.toLocaleString('pt-BR') || 'N/A'}`,
                    status: 'pre_cadastro',
                    origem: 'site',
                    dadosSite: dadosFinais,
                    valorCotacao: formData.valorEstimadoMin || null,
                    seguradora: null,
                    valorPremio: null,
                    comissao: null,
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    criadoPor: 'site_cotacao_residencial'
                };

                await db.collection('leads_crm').add(dadosCRM);
                console.log('Lead salvo em leads_crm');

            } catch (error) {
                console.error('Erro ao salvar lead:', error);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('userName');
            nameInput.addEventListener('input', function() {
                document.getElementById('btnStep1').disabled = this.value.trim().length === 0;
            });
            document.getElementById('btnStep1').disabled = true;
            nameInput.focus();
            updateProgress();
            calcularValorConteudo();
        });
        
        // Salvar lead ao sair da p√°gina (abandono)
        window.addEventListener('beforeunload', function() {
            if (leadDocRef && formData.nome) {
                // Usar sendBeacon para garantir envio mesmo ao fechar
                const dados = {
                    abandonou: true,
                    dataAbandono: new Date().toISOString(),
                    ultimoStep: currentStep
                };
                // Atualiza√ß√£o s√≠ncrona n√£o √© poss√≠vel, mas o lead parcial j√° foi salvo
                navigator.sendBeacon && navigator.sendBeacon(
                    `https://firestore.googleapis.com/v1/projects/cotador-seguros-aacb6/databases/(default)/documents/leads_cotacao_residencial/${leadId}`,
                    JSON.stringify(dados)
                );
            }
        });
        
        // Detectar inatividade (30 segundos sem intera√ß√£o)
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(async () => {
                if (leadDocRef && currentStep > 1 && currentStep < 9) {
                    try {
                        await leadDocRef.update({
                            inativo: true,
                            ultimaAtividade: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (e) {}
                }
            }, 30000);
        }
        
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
    </script>
</body>
</html>
 
