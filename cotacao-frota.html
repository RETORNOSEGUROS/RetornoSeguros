<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cota√ß√£o Seguro de Frota | Retorno Seguros</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS para ler Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #3b82f6;
            --accent: #60a5fa;
            --dark-bg: #0f172a;
            --light-bg: #eff6ff;
            --white: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow: 0 4px 20px rgba(30, 64, 175, 0.15);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, var(--light-bg) 0%, #dbeafe 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .header {
            background: linear-gradient(135deg, var(--dark-bg), var(--primary-dark));
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; }

        .logo { display: flex; align-items: center; gap: 0.75rem; text-decoration: none; }
        .logo-icon { width: 45px; height: 45px; background: linear-gradient(135deg, var(--secondary), var(--accent)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .logo-text { font-weight: 800; font-size: 1.4rem; color: white; }
        .logo-sub { font-size: 0.7rem; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        .progress-container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        .progress-bar-wrapper { background: rgba(30,64,175,0.15); border-radius: 10px; height: 8px; overflow: hidden; margin-bottom: 0.75rem; }
        .progress-bar-fill { background: linear-gradient(90deg, var(--primary), var(--accent)); height: 100%; border-radius: 10px; transition: width 0.4s ease; }
        .progress-text { text-align: center; font-size: 0.85rem; color: var(--text-light); font-weight: 500; }

        .main-container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem 3rem; }

        .step-card { background: var(--white); border-radius: 20px; padding: 2rem 1.5rem; box-shadow: var(--shadow); display: none; animation: slideIn 0.4s ease; }
        .step-card.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .step-icon { width: 70px; height: 70px; background: linear-gradient(135deg, rgba(30,64,175,0.1), rgba(59,130,246,0.1)); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 1.5rem; }
        .step-title { text-align: center; font-size: 1.5rem; font-weight: 700; color: var(--text-dark); margin-bottom: 0.5rem; }
        .step-subtitle { text-align: center; font-size: 0.95rem; color: var(--text-light); margin-bottom: 2rem; line-height: 1.5; }

        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; font-weight: 600; font-size: 0.9rem; color: var(--text-dark); margin-bottom: 0.5rem; }
        .form-input, .form-select { width: 100%; padding: 1rem 1.25rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; font-family: inherit; transition: all 0.3s ease; background: var(--white); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(30,64,175,0.1); }

        .btn { width: 100%; padding: 1rem; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(30,64,175,0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: transparent; color: var(--text-light); border: 2px solid #e2e8f0; margin-top: 0.75rem; }
        .btn-secondary:hover { background: var(--light-bg); border-color: var(--primary); color: var(--primary); }

        .info-box { background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05)); border: 2px solid var(--secondary); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; }
        .info-box.success { background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05)); border-color: var(--success); }
        .info-box .info-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .info-box .info-header span { font-weight: 700; color: var(--secondary); }
        .info-box.success .info-header span { color: var(--success); }
        .info-box p { font-size: 0.85rem; color: var(--text-dark); line-height: 1.5; }

        .upload-area { border: 3px dashed #cbd5e1; border-radius: 16px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--light-bg); margin-bottom: 1rem; }
        .upload-area:hover { border-color: var(--primary); background: rgba(30,64,175,0.05); }
        .upload-area.dragover { border-color: var(--success); background: rgba(16,185,129,0.1); }
        .upload-area .icon { font-size: 3rem; margin-bottom: 1rem; }
        .upload-area .text { font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; }
        .upload-area .subtext { font-size: 0.85rem; color: var(--text-light); }
        .upload-area input { display: none; }

        .download-modelo { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--primary); font-weight: 600; text-decoration: none; padding: 0.75rem 1.25rem; background: var(--light-bg); border: 2px dashed var(--primary); border-radius: 10px; transition: all 0.3s ease; }
        .download-modelo:hover { background: rgba(30,64,175,0.1); }

        .file-info { display: flex; align-items: center; gap: 1rem; background: var(--success); color: white; padding: 1rem; border-radius: 12px; margin: 1rem 0; }
        .file-info .icon { font-size: 1.5rem; }
        .file-info .details { flex: 1; }
        .file-info .name { font-weight: 700; }
        .file-info .meta { font-size: 0.85rem; opacity: 0.9; }
        .file-info .remove { background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; }

        .vehicles-container { margin-top: 1.5rem; overflow-x: auto; }
        .vehicle-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 1000px; }
        .vehicle-table th { background: var(--dark-bg); color: white; padding: 10px 6px; text-align: center; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.3px; position: sticky; top: 0; }
        .vehicle-table th:first-child { border-radius: 8px 0 0 0; text-align: left; padding-left: 12px; }
        .vehicle-table th:last-child { border-radius: 0 8px 0 0; }
        .vehicle-table td { padding: 8px 6px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; text-align: center; }
        .vehicle-table tr:hover { background: rgba(59,130,246,0.05); }
        .vehicle-table tr.sinistro-row { background: rgba(245,158,11,0.1); }

        .vehicle-table .placa-cell { font-family: monospace; font-weight: 700; background: var(--dark-bg); color: white; padding: 3px 6px; border-radius: 4px; font-size: 0.75rem; }
        .vehicle-table .modelo-cell { font-weight: 600; color: var(--text-dark); text-align: left; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .vehicle-table select, .vehicle-table input[type="number"] { padding: 5px 4px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 0.75rem; font-family: inherit; background: white; cursor: pointer; }
        .vehicle-table select:focus, .vehicle-table input:focus { outline: none; border-color: var(--primary); }
        .vehicle-table select { min-width: 75px; }
        .vehicle-table input[type="number"] { width: 45px; text-align: center; }

        .sinistro-btn { padding: 5px 10px; border: none; border-radius: 5px; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background: #e2e8f0; color: var(--text-light); }
        .sinistro-btn:hover { background: #cbd5e1; }
        .sinistro-btn.active { background: var(--warning); color: white; }

        .remove-btn { padding: 5px 8px; border: none; border-radius: 5px; background: rgba(239,68,68,0.1); color: #dc2626; cursor: pointer; font-size: 0.75rem; }
        .remove-btn:hover { background: rgba(239,68,68,0.2); }

        .summary-card { background: linear-gradient(135deg, var(--primary-dark), var(--dark-bg)); border-radius: 20px; padding: 2rem; color: white; margin-bottom: 1.5rem; }
        .summary-title { font-size: 1rem; opacity: 0.9; text-align: center; margin-bottom: 0.5rem; }
        .summary-empresa { font-size: 1.5rem; font-weight: 800; text-align: center; margin-bottom: 1.5rem; }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; }
        .summary-item { background: rgba(255,255,255,0.15); border-radius: 10px; padding: 0.75rem; text-align: center; }
        .summary-item .label { font-size: 0.7rem; opacity: 0.85; margin-bottom: 0.25rem; }
        .summary-item .value { font-weight: 700; font-size: 1rem; }

        .whatsapp-btn { display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; padding: 1.25rem; background: #25D366; color: white; text-decoration: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; transition: all 0.3s ease; margin-bottom: 0.75rem; }
        .whatsapp-btn:hover { background: #20bd5a; transform: translateY(-2px); }
        .whatsapp-btn svg { width: 24px; height: 24px; }

        .footer-note { text-align: center; font-size: 0.75rem; color: var(--text-light); margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; }

        .veiculos-resumo { background: var(--white); border-radius: 14px; padding: 1rem; margin-bottom: 1.5rem; max-height: 300px; overflow-y: auto; font-size: 0.8rem; }

        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .option-card { background: var(--light-bg); border: 2px solid transparent; border-radius: 14px; padding: 1.25rem; cursor: pointer; transition: all 0.3s ease; text-align: center; }
        .option-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .option-card.selected { border-color: var(--primary); background: rgba(30,64,175,0.1); }
        .option-card .icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .option-card .title { font-weight: 700; font-size: 0.95rem; color: var(--text-dark); }
        .option-card .subtitle { font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem; }

        .legend { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; padding: 0.75rem 1rem; background: var(--light-bg); border-radius: 10px; font-size: 0.75rem; align-items: center; }
        .legend strong { color: var(--primary); }

        .totals-bar { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--dark-bg); color: white; border-radius: 10px; margin-top: 1rem; font-size: 0.85rem; }
        .totals-bar .total-item { text-align: center; }
        .totals-bar .total-value { font-size: 1.2rem; font-weight: 800; }
        .totals-bar .total-label { font-size: 0.7rem; opacity: 0.8; }

        @media (max-width: 768px) {
            .options-grid, .summary-grid { grid-template-columns: 1fr 1fr; }
            .vehicle-table { font-size: 0.7rem; }
            .vehicle-table th, .vehicle-table td { padding: 6px 3px; }
            .legend { font-size: 0.65rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <div class="logo-icon">üöõ</div>
                <div>
                    <div class="logo-text">Retorno</div>
                    <div class="logo-sub">Seguro de Frota</div>
                </div>
            </a>
        </div>
    </header>

    <div class="progress-container">
        <div class="progress-bar-wrapper">
            <div class="progress-bar-fill" id="progressBar" style="width: 20%"></div>
        </div>
        <p class="progress-text" id="progressText">Etapa 1 de 5</p>
    </div>

    <div class="main-container">
        <!-- Step 1: Dados da Empresa -->
        <div class="step-card active" id="step1">
            <div class="step-icon">üè¢</div>
            <h2 class="step-title">Seguro para sua Frota</h2>
            <p class="step-subtitle">Prote√ß√£o completa para todos os ve√≠culos da sua empresa com condi√ß√µes especiais.</p>
            
            <div class="info-box success">
                <div class="info-header"><span>üöõ</span><span>Vantagens do Seguro de Frota</span></div>
                <p>Descontos progressivos, gest√£o simplificada, assist√™ncia 24h, cobertura personalizada por ve√≠culo e muito mais!</p>
            </div>

            <div class="form-group">
                <label class="form-label">Nome da Empresa</label>
                <input type="text" class="form-input" id="nomeEmpresa" placeholder="Ex: Transportadora XYZ Ltda">
            </div>

            <div class="form-group">
                <label class="form-label">CNPJ</label>
                <input type="text" class="form-input" id="cnpj" placeholder="00.000.000/0000-00" oninput="formatCNPJ(this)">
            </div>

            <button class="btn btn-primary" onclick="nextStep(1)">Come√ßar Cota√ß√£o ‚Üí</button>
        </div>

        <!-- Step 2: Upload Planilha -->
        <div class="step-card" id="step2">
            <div class="step-icon">üìã</div>
            <h2 class="step-title">Envie a planilha da frota</h2>
            <p class="step-subtitle">Fa√ßa upload da planilha com os ve√≠culos. Depois voc√™ poder√° configurar cada um.</p>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="icon">üìÅ</div>
                <p class="text">Arraste a planilha ou clique para enviar</p>
                <p class="subtext">Aceita Excel (.xlsx, .xls) ou CSV</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
            </div>

            <div style="text-align: center; margin-bottom: 1.5rem;">
                <a href="modelo-planilha-frota.xlsx" download class="download-modelo">
                    <span>üì•</span> Baixar modelo de planilha
                </a>
            </div>

            <div id="fileInfoContainer" style="display: none;"></div>

            <div class="info-box">
                <div class="info-header"><span>üìã</span><span>Colunas da planilha</span></div>
                <p>Placa | Chassi | Marca/Modelo | Ano | Danos Materiais | Danos Corporais | Danos Morais | APP Morte</p>
            </div>

            <button class="btn btn-primary" id="btnStep2" onclick="nextStep(2)" disabled>Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(2)">‚Üê Voltar</button>
        </div>

        <!-- Step 3: Configurar Ve√≠culos -->
        <div class="step-card" id="step3">
            <div class="step-icon">‚öôÔ∏è</div>
            <h2 class="step-title">Configure os ve√≠culos</h2>
            <p class="step-subtitle">Ajuste as op√ß√µes de cada ve√≠culo. Os valores padr√£o j√° est√£o preenchidos.</p>

            <div class="legend">
                <strong>Padr√µes:</strong>
                <span>üõ°Ô∏è Cobertura: Total</span>
                <span>‚õΩ Combust√≠vel: Flex</span>
                <span>üöô Reserva: 15 dias</span>
                <span>üöó Guincho: Ilimitado</span>
                <span>ü™ü Vidros: Sim</span>
                <span>‚≠ê B√¥nus: 10</span>
            </div>

            <div class="vehicles-container">
                <table class="vehicle-table" id="vehicleTable">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding-left: 10px;">Placa / Ve√≠culo</th>
                            <th>Cobertura</th>
                            <th>Combust√≠vel</th>
                            <th>Reserva</th>
                            <th>Guincho</th>
                            <th>Vidros</th>
                            <th>B√¥nus</th>
                            <th>Sinistro</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="vehicleTableBody"></tbody>
                </table>
            </div>

            <div class="totals-bar">
                <div class="total-item">
                    <div class="total-value" id="totalVeiculos">0</div>
                    <div class="total-label">Ve√≠culos</div>
                </div>
                <div class="total-item">
                    <div class="total-value" id="totalCobertura">0</div>
                    <div class="total-label">Cobertura Total</div>
                </div>
                <div class="total-item">
                    <div class="total-value" id="totalRCF">0</div>
                    <div class="total-label">Apenas RCF</div>
                </div>
                <div class="total-item">
                    <div class="total-value" id="totalSinistros" style="color: #fbbf24;">0</div>
                    <div class="total-label">Com Sinistro</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="nextStep(3)" style="margin-top: 1.5rem;">Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(3)">‚Üê Voltar</button>
        </div>

        <!-- Step 4: Seguro Atual -->
        <div class="step-card" id="step4">
            <div class="step-icon">üìã</div>
            <h2 class="step-title">Situa√ß√£o Atual</h2>
            <p class="step-subtitle">A frota j√° possui seguro?</p>

            <div class="options-grid">
                <div class="option-card" onclick="selectTemSeguro('sim', this)">
                    <div class="icon">‚úÖ</div>
                    <div class="title">Sim, tenho seguro</div>
                    <div class="subtitle">Quero renovar ou trocar</div>
                </div>
                <div class="option-card" onclick="selectTemSeguro('nao', this)">
                    <div class="icon">üÜï</div>
                    <div class="title">N√£o tenho</div>
                    <div class="subtitle">Primeira contrata√ß√£o</div>
                </div>
            </div>

            <div id="dadosSeguroAtual" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Seguradora atual</label>
                    <input type="text" class="form-input" id="seguradoraAtual" placeholder="Ex: Porto Seguro, Bradesco, etc">
                </div>
                <div class="form-group">
                    <label class="form-label">Quando vence a ap√≥lice?</label>
                    <input type="date" class="form-input" id="vencimentoApolice">
                </div>
            </div>

            <button class="btn btn-primary" id="btnStep4" onclick="nextStep(4)" disabled>Ver Resumo ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(4)">‚Üê Voltar</button>
        </div>

        <!-- Step 5: Resumo e Contato -->
        <div class="step-card" id="step5">
            <div class="step-icon">‚úÖ</div>
            <h2 class="step-title">Cota√ß√£o Pronta!</h2>
            <p class="step-subtitle">Confira o resumo e envie para receber sua proposta</p>

            <div class="summary-card">
                <div class="summary-title">Seguro de Frota</div>
                <div class="summary-empresa" id="summaryEmpresa">Empresa XYZ</div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">Total Ve√≠culos</div>
                        <div class="value" id="summaryQtd">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Cobertura Total</div>
                        <div class="value" id="summaryTotal">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Apenas RCF</div>
                        <div class="value" id="summaryRCF">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Com Sinistro</div>
                        <div class="value" id="summarySinistros">0</div>
                    </div>
                </div>
            </div>

            <div class="veiculos-resumo" id="veiculosResumoContainer"></div>

            <div class="info-box success">
                <div class="info-header"><span>üéâ</span><span>Pr√≥ximo passo</span></div>
                <p>Preencha seus dados e fale com nosso especialista para receber a proposta completa com valores.</p>
            </div>

            <div class="form-group">
                <label class="form-label">Seu nome</label>
                <input type="text" class="form-input" id="nome" placeholder="Nome completo">
            </div>

            <div class="form-group">
                <label class="form-label">WhatsApp</label>
                <input type="tel" class="form-input" id="whatsapp" placeholder="(00) 00000-0000" oninput="formatPhone(this)">
            </div>

            <button class="btn btn-primary" id="btnEnviar" onclick="enviarCotacao()">Solicitar Proposta Completa</button>

            <a href="#" class="whatsapp-btn" id="whatsappLink" style="display: none;">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                Falar com Especialista
            </a>

            <button class="btn btn-secondary" onclick="prevStep(5)">‚Üê Voltar e ajustar</button>
            <p class="footer-note">üîí Suas informa√ß√µes est√£o seguras. Trabalhamos com as maiores seguradoras do Brasil.</p>
        </div>
    </div>

    <script>
        // Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD3YZVqRbKExEi5CN9CPwlnY-GSzd4lUMM",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "631323599837",
            appId: "1:631323599837:web:77f20f7c65a12113621856"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const indicadorCodigo = urlParams.get('ref') || urlParams.get('indicador');
        const empresaParceiraCodigo = urlParams.get('empresa') || urlParams.get('parceiro');

        let formData = {
            nomeEmpresa: '',
            cnpj: '',
            veiculos: [],
            temSeguro: '',
            seguradoraAtual: '',
            vencimentoApolice: '',
            nome: '',
            whatsapp: ''
        };

        let currentStep = 1;
        const totalSteps = 5;

        function updateProgress() {
            document.getElementById('progressBar').style.width = (currentStep / totalSteps * 100) + '%';
            document.getElementById('progressText').textContent = `Etapa ${currentStep} de ${totalSteps}`;
        }

        function showStep(step) {
            document.querySelectorAll('.step-card').forEach(c => c.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            currentStep = step;
            updateProgress();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function nextStep(current) {
            if (current === 1) {
                const nome = document.getElementById('nomeEmpresa').value.trim();
                if (!nome) { alert('Informe o nome da empresa.'); return; }
                formData.nomeEmpresa = nome;
                formData.cnpj = document.getElementById('cnpj').value.trim();
                showStep(2);
            } else if (current === 2) {
                if (formData.veiculos.length === 0) { alert('Envie a planilha com os ve√≠culos.'); return; }
                renderVehicleTable();
                showStep(3);
            } else if (current === 3) {
                collectVehicleData();
                showStep(4);
            } else if (current === 4) {
                if (!formData.temSeguro) { alert('Informe se j√° possui seguro.'); return; }
                formData.seguradoraAtual = document.getElementById('seguradoraAtual').value;
                formData.vencimentoApolice = document.getElementById('vencimentoApolice').value;
                generateSummary();
                showStep(5);
            }
        }

        function prevStep(current) {
            if (current === 3) collectVehicleData();
            if (current > 1) showStep(current - 1);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    processImportedData(jsonData);
                    showFileInfo(file.name);
                } catch (error) {
                    alert('Erro ao ler arquivo. Verifique se √© um Excel v√°lido.');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processImportedData(data) {
            formData.veiculos = [];
            
            data.forEach((row, idx) => {
                const placa = row.Placa || row.PLACA || row.placa || '';
                const chassi = row.Chassi || row.CHASSI || row.chassi || '';
                const marcaModelo = row['Marca/Modelo'] || row.MarcaModelo || row['MARCA/MODELO'] || row.Modelo || row.MODELO || '';
                const ano = row.Ano || row.ANO || row.ano || '';
                const dm = parseFloat(String(row['Danos Materiais'] || row.DanosMateriais || row['DANOS MATERIAIS'] || row.DM || 0).replace(/\D/g,'')) || 0;
                const dc = parseFloat(String(row['Danos Corporais'] || row.DanosCorporais || row['DANOS CORPORAIS'] || row.DC || 0).replace(/\D/g,'')) || 0;
                const dmorais = parseFloat(String(row['Danos Morais'] || row.DanosMorais || row['DANOS MORAIS'] || 0).replace(/\D/g,'')) || 0;
                const app = parseFloat(String(row['APP Morte'] || row.APPMorte || row['APP MORTE'] || row.APP || 0).replace(/\D/g,'')) || 0;

                if (marcaModelo || placa || chassi) {
                    formData.veiculos.push({
                        id: Date.now() + idx,
                        placa: placa.toString().toUpperCase().trim(),
                        chassi: chassi.toString().toUpperCase().trim(),
                        marcaModelo: marcaModelo.toString().trim(),
                        ano: ano.toString().trim(),
                        danosMateriais: dm,
                        danosCorporais: dc,
                        danosMorais: dmorais,
                        appMorte: app,
                        cobertura: 'total',
                        combustivel: 'flex',
                        carroReserva: '15',
                        guincho: 'ilimitado',
                        vidros: 'sim',
                        bonus: 10,
                        sinistro: false
                    });
                }
            });

            document.getElementById('btnStep2').disabled = formData.veiculos.length === 0;
        }

        function showFileInfo(fileName) {
            document.getElementById('fileInfoContainer').style.display = 'block';
            document.getElementById('fileInfoContainer').innerHTML = `
                <div class="file-info">
                    <div class="icon">üìä</div>
                    <div class="details">
                        <div class="name">${fileName}</div>
                        <div class="meta">${formData.veiculos.length} ve√≠culos importados</div>
                    </div>
                    <button class="remove" onclick="removeFile()">‚úï Remover</button>
                </div>
            `;
        }

        function removeFile() {
            formData.veiculos = [];
            document.getElementById('fileInfoContainer').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('btnStep2').disabled = true;
        }

        function renderVehicleTable() {
            const tbody = document.getElementById('vehicleTableBody');
            
            tbody.innerHTML = formData.veiculos.map((v, idx) => `
                <tr id="row-${v.id}" class="${v.sinistro ? 'sinistro-row' : ''}">
                    <td style="text-align: left; padding-left: 10px;">
                        <span class="placa-cell">${v.placa || 'S/P'}</span>
                        <div class="modelo-cell" title="${v.marcaModelo}">${v.marcaModelo || 'N/I'}</div>
                        <div style="font-size: 0.65rem; color: #94a3b8;">${v.ano || '-'}</div>
                    </td>
                    <td>
                        <select id="cob-${v.id}" onchange="updateTotals()">
                            <option value="total" ${v.cobertura === 'total' ? 'selected' : ''}>Total</option>
                            <option value="rcf" ${v.cobertura === 'rcf' ? 'selected' : ''}>RCF</option>
                        </select>
                    </td>
                    <td>
                        <select id="comb-${v.id}">
                            <option value="flex" ${v.combustivel === 'flex' ? 'selected' : ''}>Flex</option>
                            <option value="gasolina" ${v.combustivel === 'gasolina' ? 'selected' : ''}>Gasolina</option>
                            <option value="diesel" ${v.combustivel === 'diesel' ? 'selected' : ''}>Diesel</option>
                            <option value="eletrico" ${v.combustivel === 'eletrico' ? 'selected' : ''}>El√©trico</option>
                            <option value="gnv" ${v.combustivel === 'gnv' ? 'selected' : ''}>GNV</option>
                        </select>
                    </td>
                    <td>
                        <select id="reserva-${v.id}">
                            <option value="0" ${v.carroReserva === '0' ? 'selected' : ''}>N√£o</option>
                            <option value="7" ${v.carroReserva === '7' ? 'selected' : ''}>7d</option>
                            <option value="15" ${v.carroReserva === '15' ? 'selected' : ''}>15d</option>
                            <option value="30" ${v.carroReserva === '30' ? 'selected' : ''}>30d</option>
                        </select>
                    </td>
                    <td>
                        <select id="guincho-${v.id}">
                            <option value="ilimitado" ${v.guincho === 'ilimitado' ? 'selected' : ''}>Ilimit.</option>
                            <option value="400" ${v.guincho === '400' ? 'selected' : ''}>400km</option>
                            <option value="200" ${v.guincho === '200' ? 'selected' : ''}>200km</option>
                        </select>
                    </td>
                    <td>
                        <select id="vidros-${v.id}">
                            <option value="sim" ${v.vidros === 'sim' ? 'selected' : ''}>Sim</option>
                            <option value="nao" ${v.vidros === 'nao' ? 'selected' : ''}>N√£o</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" id="bonus-${v.id}" value="${v.bonus}" min="0" max="10">
                    </td>
                    <td>
                        <button class="sinistro-btn ${v.sinistro ? 'active' : ''}" onclick="toggleSinistro(${v.id})">
                            ${v.sinistro ? '‚ö†Ô∏è' : '‚úì'}
                        </button>
                    </td>
                    <td>
                        <button class="remove-btn" onclick="removeVeiculo(${v.id})">‚úï</button>
                    </td>
                </tr>
            `).join('');

            updateTotals();
        }

        function toggleSinistro(id) {
            const v = formData.veiculos.find(v => v.id === id);
            if (v) {
                v.sinistro = !v.sinistro;
                const row = document.getElementById('row-' + id);
                const btn = row.querySelector('.sinistro-btn');
                
                if (v.sinistro) {
                    row.classList.add('sinistro-row');
                    btn.classList.add('active');
                    btn.innerHTML = '‚ö†Ô∏è';
                } else {
                    row.classList.remove('sinistro-row');
                    btn.classList.remove('active');
                    btn.innerHTML = '‚úì';
                }
                updateTotals();
            }
        }

        function removeVeiculo(id) {
            formData.veiculos = formData.veiculos.filter(v => v.id !== id);
            document.getElementById('row-' + id).remove();
            updateTotals();
        }

        function updateTotals() {
            // Atualizar dados dos selects
            formData.veiculos.forEach(v => {
                const cobEl = document.getElementById('cob-' + v.id);
                if (cobEl) v.cobertura = cobEl.value;
            });

            const total = formData.veiculos.length;
            const cobTotal = formData.veiculos.filter(v => v.cobertura === 'total').length;
            const cobRCF = formData.veiculos.filter(v => v.cobertura === 'rcf').length;
            const sinistros = formData.veiculos.filter(v => v.sinistro).length;

            document.getElementById('totalVeiculos').textContent = total;
            document.getElementById('totalCobertura').textContent = cobTotal;
            document.getElementById('totalRCF').textContent = cobRCF;
            document.getElementById('totalSinistros').textContent = sinistros;
        }

        function collectVehicleData() {
            formData.veiculos.forEach(v => {
                const cobEl = document.getElementById('cob-' + v.id);
                const combEl = document.getElementById('comb-' + v.id);
                const reservaEl = document.getElementById('reserva-' + v.id);
                const guinchoEl = document.getElementById('guincho-' + v.id);
                const vidrosEl = document.getElementById('vidros-' + v.id);
                const bonusEl = document.getElementById('bonus-' + v.id);

                if (cobEl) v.cobertura = cobEl.value;
                if (combEl) v.combustivel = combEl.value;
                if (reservaEl) v.carroReserva = reservaEl.value;
                if (guinchoEl) v.guincho = guinchoEl.value;
                if (vidrosEl) v.vidros = vidrosEl.value;
                if (bonusEl) v.bonus = parseInt(bonusEl.value) || 0;
            });
        }

        function selectTemSeguro(opcao, el) {
            formData.temSeguro = opcao;
            document.querySelectorAll('#step4 .option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('dadosSeguroAtual').style.display = opcao === 'sim' ? 'block' : 'none';
            document.getElementById('btnStep4').disabled = false;
        }

        function generateSummary() {
            const qtdTotal = formData.veiculos.filter(v => v.cobertura === 'total').length;
            const qtdRCF = formData.veiculos.filter(v => v.cobertura === 'rcf').length;
            const qtdSinistros = formData.veiculos.filter(v => v.sinistro).length;

            document.getElementById('summaryEmpresa').textContent = formData.nomeEmpresa;
            document.getElementById('summaryQtd').textContent = formData.veiculos.length;
            document.getElementById('summaryTotal').textContent = qtdTotal;
            document.getElementById('summaryRCF').textContent = qtdRCF;
            document.getElementById('summarySinistros').textContent = qtdSinistros;

            const container = document.getElementById('veiculosResumoContainer');
            container.innerHTML = '<table style="width: 100%; font-size: 0.75rem; border-collapse: collapse;">' +
                '<thead><tr style="background: #f1f5f9;">' +
                '<th style="padding: 6px; text-align: left;">Placa</th>' +
                '<th style="padding: 6px; text-align: left;">Ve√≠culo</th>' +
                '<th style="padding: 6px; text-align: center;">Cob.</th>' +
                '<th style="padding: 6px; text-align: center;">Comb.</th>' +
                '<th style="padding: 6px; text-align: center;">Reserva</th>' +
                '<th style="padding: 6px; text-align: center;">Guincho</th>' +
                '<th style="padding: 6px; text-align: center;">Vidros</th>' +
                '<th style="padding: 6px; text-align: center;">B√¥nus</th>' +
                '<th style="padding: 6px; text-align: center;">Sin.</th>' +
                '</tr></thead><tbody>' +
                formData.veiculos.map(v => `
                    <tr style="${v.sinistro ? 'background: rgba(245,158,11,0.1);' : ''}">
                        <td style="padding: 6px; border-bottom: 1px solid #e2e8f0;"><strong>${v.placa || '-'}</strong></td>
                        <td style="padding: 6px; border-bottom: 1px solid #e2e8f0;">${v.marcaModelo}</td>
                        <td style="padding: 6px; text-align: center; border-bottom: 1px solid #e2e8f0;">${v.cobertura === 'total' ? 'üõ°Ô∏è' : 'üöó'}</td>
                        <td style="padding: 6px; text-align: center; border-bottom: 1px solid #e2e8f0;">${v.combustivel}</td>
                        <td style="padding: 6px; text-align: center; border-bottom: 1px solid #e2e8f0;">${v.carroReserva}d</td>
                        <td style="padding: 6px; text-align: center; border-bottom: 1px solid #e2e8f0;">${v.guincho === 'ilimitado' ? '‚àû' : v.guincho}</td>
                        <td style="padding: 6px; text-align: center; border-bottom: 1px solid #e2e8f0;">${v.vidros === 'sim' ? '‚úì' : '‚úó'}</td>
                        <td style="padding: 6px; text-align: center; border-bottom: 1px solid #e2e8f0;">${v.bonus}</td>
                        <td style="padding: 6px; text-align: center; border-bottom: 1px solid #e2e8f0;">${v.sinistro ? '‚ö†Ô∏è' : '‚úì'}</td>
                    </tr>
                `).join('') +
                '</tbody></table>';
        }

        function formatCNPJ(input) {
            let v = input.value.replace(/\D/g, '').slice(0, 14);
            if (v.length > 12) v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            else if (v.length > 8) v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
            else if (v.length > 5) v = v.replace(/(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
            else if (v.length > 2) v = v.replace(/(\d{2})(\d{0,3})/, '$1.$2');
            input.value = v;
        }

        function formatPhone(input) {
            let v = input.value.replace(/\D/g, '').slice(0, 11);
            if (v.length > 6) v = v.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
            else if (v.length > 2) v = v.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            input.value = v;
        }

        async function enviarCotacao() {
            const nome = document.getElementById('nome').value.trim();
            const whatsapp = document.getElementById('whatsapp').value.trim();
            
            if (!nome) { alert('Informe seu nome.'); return; }
            if (!whatsapp || whatsapp.length < 14) { alert('Informe um WhatsApp v√°lido.'); return; }
            
            formData.nome = nome;
            formData.whatsapp = whatsapp;

            const btn = document.getElementById('btnEnviar');
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            try {
                const qtdTotal = formData.veiculos.filter(v => v.cobertura === 'total').length;
                const qtdRCF = formData.veiculos.filter(v => v.cobertura === 'rcf').length;
                const qtdSinistros = formData.veiculos.filter(v => v.sinistro).length;

                await db.collection('leads_crm').add({
                    nome: formData.nome,
                    whatsapp: formData.whatsapp.replace(/\D/g, ''),
                    nomeEmpresa: formData.nomeEmpresa,
                    cnpj: formData.cnpj,
                    
                    veiculos: formData.veiculos,
                    qtdVeiculos: formData.veiculos.length,
                    qtdCoberturaTotal: qtdTotal,
                    qtdCoberturaRCF: qtdRCF,
                    qtdSinistros: qtdSinistros,
                    
                    temSeguro: formData.temSeguro,
                    seguradoraAtual: formData.seguradoraAtual,
                    vencimentoApolice: formData.vencimentoApolice,
                    
                    ramo: 'auto',
                    tipo: 'frota',
                    status: 'pre_cadastro',
                    origem: 'site',
                    
                    indicadoPorCodigo: indicadorCodigo || null,
                    empresaParceiraCodigo: empresaParceiraCodigo || null,
                    
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });

                btn.style.display = 'none';
                document.getElementById('whatsappLink').style.display = 'flex';

                const veiculosMsg = formData.veiculos.slice(0, 5).map(v => 
                    `   ‚Ä¢ ${v.placa || 'S/P'} - ${v.marcaModelo} (${v.cobertura === 'total' ? 'Total' : 'RCF'})${v.sinistro ? ' ‚ö†Ô∏è' : ''}`
                ).join('%0A');
                
                const msg = `Ol√°! Sou *${formData.nome}* da empresa *${formData.nomeEmpresa}* e fiz cota√ß√£o de Seguro de Frota.%0A%0A` +
                    `üöó *${formData.veiculos.length} ve√≠culos*%0A` +
                    `   ‚Ä¢ ${qtdTotal} Cobertura Total%0A` +
                    `   ‚Ä¢ ${qtdRCF} apenas RCF%0A` +
                    `   ‚Ä¢ ${qtdSinistros} com sinistro%0A%0A` +
                    `*Ve√≠culos:*%0A${veiculosMsg}${formData.veiculos.length > 5 ? '%0A   ... +' + (formData.veiculos.length - 5) + ' ve√≠culos' : ''}%0A%0A` +
                    `Aguardo proposta!`;

                document.getElementById('whatsappLink').href = `https://wa.me/5554997015000?text=${msg}`;
                alert('‚úÖ Cota√ß√£o enviada! Clique no WhatsApp para falar conosco.');
            } catch (e) {
                console.error(e);
                btn.disabled = false;
                btn.textContent = 'Solicitar Proposta Completa';
                alert('Erro ao enviar. Tente novamente.');
            }
        }

        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFileUpload({ target: { files: e.dataTransfer.files } });
        });

        updateProgress();
    </script>
</body>
</html>
