<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cota√ß√£o Seguro de Frota | Retorno Seguros</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS para ler Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #3b82f6;
            --accent: #60a5fa;
            --dark-bg: #0f172a;
            --light-bg: #eff6ff;
            --white: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow: 0 4px 20px rgba(30, 64, 175, 0.15);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, var(--light-bg) 0%, #dbeafe 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .header {
            background: linear-gradient(135deg, var(--dark-bg), var(--primary-dark));
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text { font-weight: 800; font-size: 1.4rem; color: white; }
        .logo-sub { font-size: 0.7rem; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        .progress-container { max-width: 800px; margin: 0 auto; padding: 1.5rem; }
        .progress-bar-wrapper { background: rgba(30,64,175,0.15); border-radius: 10px; height: 8px; overflow: hidden; margin-bottom: 0.75rem; }
        .progress-bar-fill { background: linear-gradient(90deg, var(--primary), var(--accent)); height: 100%; border-radius: 10px; transition: width 0.4s ease; }
        .progress-text { text-align: center; font-size: 0.85rem; color: var(--text-light); font-weight: 500; }

        .main-container { max-width: 800px; margin: 0 auto; padding: 0 1.5rem 3rem; }

        .step-card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem 1.5rem;
            box-shadow: var(--shadow);
            display: none;
            animation: slideIn 0.4s ease;
        }
        .step-card.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .step-icon { width: 70px; height: 70px; background: linear-gradient(135deg, rgba(30,64,175,0.1), rgba(59,130,246,0.1)); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 1.5rem; }
        .step-title { text-align: center; font-size: 1.5rem; font-weight: 700; color: var(--text-dark); margin-bottom: 0.5rem; }
        .step-subtitle { text-align: center; font-size: 0.95rem; color: var(--text-light); margin-bottom: 2rem; line-height: 1.5; }

        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; font-weight: 600; font-size: 0.9rem; color: var(--text-dark); margin-bottom: 0.5rem; }
        .form-input, .form-select { width: 100%; padding: 1rem 1.25rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; font-family: inherit; transition: all 0.3s ease; background: var(--white); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(30,64,175,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }

        .btn { width: 100%; padding: 1rem; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(30,64,175,0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: transparent; color: var(--text-light); border: 2px solid #e2e8f0; margin-top: 0.75rem; }
        .btn-secondary:hover { background: var(--light-bg); border-color: var(--primary); color: var(--primary); }

        .info-box { background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05)); border: 2px solid var(--secondary); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; }
        .info-box.success { background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05)); border-color: var(--success); }
        .info-box.warning { background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05)); border-color: var(--warning); }
        .info-box .info-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .info-box .info-header span { font-weight: 700; color: var(--secondary); }
        .info-box.success .info-header span { color: var(--success); }
        .info-box.warning .info-header span { color: var(--warning); }
        .info-box p { font-size: 0.85rem; color: var(--text-dark); line-height: 1.5; }

        /* Upload Area */
        .upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--light-bg);
            margin-bottom: 1rem;
        }
        .upload-area:hover { border-color: var(--primary); background: rgba(30,64,175,0.05); }
        .upload-area.dragover { border-color: var(--success); background: rgba(16,185,129,0.1); }
        .upload-area .icon { font-size: 3rem; margin-bottom: 1rem; }
        .upload-area .text { font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; }
        .upload-area .subtext { font-size: 0.85rem; color: var(--text-light); }
        .upload-area input { display: none; }

        .download-modelo {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
            padding: 0.75rem 1.25rem;
            background: var(--light-bg);
            border: 2px dashed var(--primary);
            border-radius: 10px;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }
        .download-modelo:hover { background: rgba(30,64,175,0.1); }

        .divider { display: flex; align-items: center; gap: 1rem; margin: 1.5rem 0; color: var(--text-light); font-size: 0.85rem; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: #e2e8f0; }

        /* Add Vehicle Form */
        .add-vehicle-form {
            background: linear-gradient(135deg, var(--light-bg), #dbeafe);
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--secondary);
        }
        .add-vehicle-title { font-weight: 700; color: var(--primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }

        /* Vehicle List */
        .vehicle-list { margin-top: 1.5rem; }
        .vehicle-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .vehicle-list-title { font-weight: 700; color: var(--text-dark); display: flex; align-items: center; gap: 0.5rem; }
        .vehicle-count { background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 700; }

        .vehicle-card {
            background: var(--white);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }
        .vehicle-card:hover { border-color: var(--secondary); }
        .vehicle-card.sinistro { border-color: var(--warning); background: rgba(245,158,11,0.05); }

        .vehicle-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .vehicle-info { flex: 1; }
        .vehicle-modelo { font-weight: 700; color: var(--text-dark); font-size: 1rem; }
        .vehicle-placa { font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem; }
        .vehicle-placa strong { background: var(--dark-bg); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-family: monospace; }
        .vehicle-actions { display: flex; gap: 0.5rem; }
        .vehicle-actions button { padding: 0.4rem 0.75rem; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-sinistro { background: rgba(245,158,11,0.15); color: #b45309; }
        .btn-sinistro:hover { background: rgba(245,158,11,0.3); }
        .btn-sinistro.active { background: var(--warning); color: white; }
        .btn-remove { background: rgba(239,68,68,0.15); color: #dc2626; }
        .btn-remove:hover { background: rgba(239,68,68,0.3); }

        .vehicle-details { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
        .vehicle-detail { text-align: center; padding: 0.5rem; background: var(--light-bg); border-radius: 8px; }
        .vehicle-detail-label { font-size: 0.65rem; color: var(--text-light); text-transform: uppercase; }
        .vehicle-detail-value { font-weight: 700; color: var(--text-dark); font-size: 0.85rem; }

        /* Options Grid */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .option-card { background: var(--light-bg); border: 2px solid transparent; border-radius: 14px; padding: 1.25rem; cursor: pointer; transition: all 0.3s ease; text-align: center; }
        .option-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .option-card.selected { border-color: var(--primary); background: rgba(30,64,175,0.1); }
        .option-card .icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .option-card .title { font-weight: 700; font-size: 0.95rem; color: var(--text-dark); }
        .option-card .subtitle { font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem; }

        /* Summary */
        .summary-card {
            background: linear-gradient(135deg, var(--primary-dark), var(--dark-bg));
            border-radius: 20px;
            padding: 2rem;
            color: white;
            margin-bottom: 1.5rem;
        }
        .summary-title { font-size: 1rem; opacity: 0.9; text-align: center; margin-bottom: 0.5rem; }
        .summary-empresa { font-size: 1.5rem; font-weight: 800; text-align: center; margin-bottom: 1.5rem; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
        .summary-item { background: rgba(255,255,255,0.15); border-radius: 10px; padding: 0.75rem; text-align: center; }
        .summary-item.full { grid-column: span 3; }
        .summary-item .label { font-size: 0.7rem; opacity: 0.85; margin-bottom: 0.25rem; }
        .summary-item .value { font-weight: 700; font-size: 1rem; }

        /* Loading */
        .loading-container { text-align: center; padding: 3rem 0; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid rgba(30,64,175,0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 1.1rem; color: var(--text-dark); font-weight: 600; }
        .loading-subtext { font-size: 0.9rem; color: var(--text-light); margin-top: 0.5rem; }

        /* WhatsApp Button */
        .whatsapp-btn { display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; padding: 1.25rem; background: #25D366; color: white; text-decoration: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; transition: all 0.3s ease; margin-bottom: 0.75rem; }
        .whatsapp-btn:hover { background: #20bd5a; transform: translateY(-2px); }
        .whatsapp-btn svg { width: 24px; height: 24px; }

        .footer-note { text-align: center; font-size: 0.75rem; color: var(--text-light); margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; }

        /* File Info */
        .file-info { display: flex; align-items: center; gap: 1rem; background: var(--success); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; }
        .file-info .icon { font-size: 1.5rem; }
        .file-info .details { flex: 1; }
        .file-info .name { font-weight: 700; }
        .file-info .meta { font-size: 0.85rem; opacity: 0.9; }
        .file-info .remove { background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; }

        /* Ve√≠culos Resumo */
        .veiculos-resumo { background: var(--white); border-radius: 14px; padding: 1.25rem; margin-bottom: 1.5rem; max-height: 300px; overflow-y: auto; }
        .veiculos-resumo-title { font-weight: 700; color: var(--text-dark); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }

        @media (max-width: 600px) {
            .options-grid, .form-row, .summary-grid, .form-row-3 { grid-template-columns: 1fr; }
            .summary-item.full { grid-column: span 1; }
            .vehicle-details { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <div class="logo-icon">üöõ</div>
                <div>
                    <div class="logo-text">Retorno</div>
                    <div class="logo-sub">Seguro de Frota</div>
                </div>
            </a>
        </div>
    </header>

    <div class="progress-container">
        <div class="progress-bar-wrapper">
            <div class="progress-bar-fill" id="progressBar" style="width: 14.3%"></div>
        </div>
        <p class="progress-text" id="progressText">Etapa 1 de 7</p>
    </div>

    <div class="main-container">
        <!-- Step 1: Dados da Empresa -->
        <div class="step-card active" id="step1">
            <div class="step-icon">üè¢</div>
            <h2 class="step-title">Seguro para sua Frota</h2>
            <p class="step-subtitle">Prote√ß√£o completa para todos os ve√≠culos da sua empresa com condi√ß√µes especiais.</p>
            
            <div class="info-box success">
                <div class="info-header"><span>üöõ</span><span>Vantagens do Seguro de Frota</span></div>
                <p>Descontos progressivos, gest√£o simplificada, assist√™ncia 24h, cobertura personalizada por ve√≠culo e muito mais!</p>
            </div>

            <div class="form-group">
                <label class="form-label">Nome da Empresa</label>
                <input type="text" class="form-input" id="nomeEmpresa" placeholder="Ex: Transportadora XYZ Ltda">
            </div>

            <div class="form-group">
                <label class="form-label">CNPJ</label>
                <input type="text" class="form-input" id="cnpj" placeholder="00.000.000/0000-00" oninput="formatCNPJ(this)">
            </div>

            <button class="btn btn-primary" onclick="nextStep(1)">Come√ßar Cota√ß√£o ‚Üí</button>
        </div>

        <!-- Step 2: Upload/Adicionar Ve√≠culos -->
        <div class="step-card" id="step2">
            <div class="step-icon">üìã</div>
            <h2 class="step-title">Ve√≠culos da Frota</h2>
            <p class="step-subtitle">Envie uma planilha com os ve√≠culos ou adicione manualmente.</p>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="icon">üìÅ</div>
                <p class="text">Arraste uma planilha ou clique para enviar</p>
                <p class="subtext">Aceita Excel (.xlsx, .xls) ou CSV</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
            </div>

            <div style="text-align: center;">
                <a href="modelo-planilha-frota.xlsx" download class="download-modelo">
                    <span>üì•</span> Baixar modelo de planilha
                </a>
            </div>

            <div id="fileInfoContainer" style="display: none;"></div>

            <div class="divider">ou adicione manualmente</div>

            <div class="add-vehicle-form">
                <div class="add-vehicle-title"><span>‚ûï</span> Adicionar Ve√≠culo</div>
                
                <div class="form-row" style="margin-bottom: 1rem;">
                    <div>
                        <label class="form-label">Tipo</label>
                        <select class="form-select" id="addTipo" onchange="carregarMarcas()">
                            <option value="">Selecione...</option>
                            <option value="carros">üöó Carro</option>
                            <option value="motos">üèçÔ∏è Moto</option>
                            <option value="caminhoes">üöõ Caminh√£o</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Marca</label>
                        <select class="form-select" id="addMarca" onchange="carregarModelos()" disabled>
                            <option value="">Selecione o tipo primeiro</option>
                        </select>
                    </div>
                </div>

                <div class="form-row" style="margin-bottom: 1rem;">
                    <div>
                        <label class="form-label">Modelo</label>
                        <select class="form-select" id="addModelo" onchange="carregarAnos()" disabled>
                            <option value="">Selecione a marca primeiro</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Ano</label>
                        <select class="form-select" id="addAno" onchange="buscarValorFipe()" disabled>
                            <option value="">Selecione o modelo primeiro</option>
                        </select>
                    </div>
                </div>

                <div class="form-row" style="margin-bottom: 1rem;">
                    <div>
                        <label class="form-label">Placa (opcional)</label>
                        <input type="text" class="form-input" id="addPlaca" placeholder="ABC-1234" oninput="formatPlaca(this)" style="text-transform: uppercase;">
                    </div>
                    <div>
                        <label class="form-label">Valor FIPE</label>
                        <input type="text" class="form-input" id="addValor" placeholder="R$ 0,00" readonly style="background: #f1f5f9;">
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label class="form-label">Uso do Ve√≠culo</label>
                        <select class="form-select" id="addUso">
                            <option value="transporte">üöö Transporte de Carga</option>
                            <option value="passeio">üöó Passeio/Particular</option>
                            <option value="comercial">üè™ Comercial/Vendas</option>
                            <option value="app">üì± App (Uber, 99, etc)</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button type="button" onclick="adicionarVeiculo()" class="btn btn-primary" style="margin: 0;">+ Adicionar</button>
                    </div>
                </div>
            </div>

            <!-- Lista de Ve√≠culos -->
            <div class="vehicle-list" id="vehicleList" style="display: none;">
                <div class="vehicle-list-header">
                    <div class="vehicle-list-title"><span>üöó</span> Ve√≠culos Adicionados</div>
                    <div class="vehicle-count" id="vehicleCount">0</div>
                </div>
                <div id="vehicleListContainer"></div>
            </div>

            <button class="btn btn-primary" onclick="nextStep(2)" style="margin-top: 1.5rem;">Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(2)">‚Üê Voltar</button>
        </div>

        <!-- Step 3: Marcar Sinistros -->
        <div class="step-card" id="step3">
            <div class="step-icon">‚ö†Ô∏è</div>
            <h2 class="step-title">Hist√≥rico de Sinistros</h2>
            <p class="step-subtitle">Marque os ve√≠culos que tiveram sinistro nos √∫ltimos 12 meses.</p>

            <div class="info-box warning">
                <div class="info-header"><span>üí°</span><span>Por que informar sinistros?</span></div>
                <p>Informar sinistros anteriores ajuda a seguradora a calcular o pr√™mio correto e evita problemas na hora de acionar a cobertura.</p>
            </div>

            <div id="sinistrosListContainer"></div>

            <button class="btn btn-primary" onclick="nextStep(3)" style="margin-top: 1.5rem;">Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(3)">‚Üê Voltar</button>
        </div>

        <!-- Step 4: Seguro Atual -->
        <div class="step-card" id="step4">
            <div class="step-icon">üìã</div>
            <h2 class="step-title">Situa√ß√£o Atual</h2>
            <p class="step-subtitle">A frota j√° possui seguro?</p>

            <div class="options-grid">
                <div class="option-card" onclick="selectTemSeguro('sim', this)">
                    <div class="icon">‚úÖ</div>
                    <div class="title">Sim, tenho seguro</div>
                    <div class="subtitle">Quero renovar ou trocar</div>
                </div>
                <div class="option-card" onclick="selectTemSeguro('nao', this)">
                    <div class="icon">üÜï</div>
                    <div class="title">N√£o tenho</div>
                    <div class="subtitle">Primeira contrata√ß√£o</div>
                </div>
            </div>

            <div id="dadosSeguroAtual" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Seguradora atual</label>
                    <input type="text" class="form-input" id="seguradoraAtual" placeholder="Ex: Porto Seguro, Bradesco, etc">
                </div>
                <div class="form-group">
                    <label class="form-label">Quando vence a ap√≥lice?</label>
                    <input type="date" class="form-input" id="vencimentoApolice">
                </div>
            </div>

            <button class="btn btn-primary" id="btnStep4" onclick="nextStep(4)" disabled>Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(4)">‚Üê Voltar</button>
        </div>

        <!-- Step 5: Coberturas -->
        <div class="step-card" id="step5">
            <div class="step-icon">üõ°Ô∏è</div>
            <h2 class="step-title">Coberturas Desejadas</h2>
            <p class="step-subtitle">Selecione as coberturas que deseja para sua frota.</p>

            <div class="info-box">
                <div class="info-header"><span>‚ÑπÔ∏è</span><span>Coberturas padr√£o inclusas</span></div>
                <p>Todas as cota√ß√µes incluem: Colis√£o, Inc√™ndio, Roubo/Furto e Assist√™ncia 24h.</p>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--light-bg); border-radius: 10px; cursor: pointer; margin-bottom: 0.75rem;">
                    <input type="checkbox" id="cobRCF" checked style="width: 20px; height: 20px;">
                    <div>
                        <div style="font-weight: 600;">üöó RCF-V (Responsabilidade Civil)</div>
                        <div style="font-size: 0.8rem; color: var(--text-light);">Danos causados a terceiros</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--light-bg); border-radius: 10px; cursor: pointer; margin-bottom: 0.75rem;">
                    <input type="checkbox" id="cobAPP" checked style="width: 20px; height: 20px;">
                    <div>
                        <div style="font-weight: 600;">üë• APP (Acidentes Pessoais)</div>
                        <div style="font-size: 0.8rem; color: var(--text-light);">Prote√ß√£o para ocupantes do ve√≠culo</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--light-bg); border-radius: 10px; cursor: pointer; margin-bottom: 0.75rem;">
                    <input type="checkbox" id="cobVidros" style="width: 20px; height: 20px;">
                    <div>
                        <div style="font-weight: 600;">ü™ü Vidros</div>
                        <div style="font-size: 0.8rem; color: var(--text-light);">Para-brisa, vidros laterais e traseiro</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--light-bg); border-radius: 10px; cursor: pointer; margin-bottom: 0.75rem;">
                    <input type="checkbox" id="cobCarroReserva" style="width: 20px; height: 20px;">
                    <div>
                        <div style="font-weight: 600;">üöô Carro Reserva</div>
                        <div style="font-size: 0.8rem; color: var(--text-light);">Ve√≠culo substituto em caso de sinistro</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--light-bg); border-radius: 10px; cursor: pointer;">
                    <input type="checkbox" id="cobRastreador" style="width: 20px; height: 20px;">
                    <div>
                        <div style="font-weight: 600;">üìç Rastreamento</div>
                        <div style="font-size: 0.8rem; color: var(--text-light);">Monitoramento GPS da frota</div>
                    </div>
                </label>
            </div>

            <button class="btn btn-primary" onclick="nextStep(5)">Ver Resumo ‚Üí</button>
            <button class="btn btn-secondary" onclick="prevStep(5)">‚Üê Voltar</button>
        </div>

        <!-- Step 6: Loading -->
        <div class="step-card" id="step6">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p class="loading-text">Preparando sua cota√ß√£o...</p>
                <p class="loading-subtext">Analisando os melhores planos para sua frota</p>
            </div>
        </div>

        <!-- Step 7: Resumo e Contato -->
        <div class="step-card" id="step7">
            <div class="step-icon">‚úÖ</div>
            <h2 class="step-title">Cota√ß√£o Pronta!</h2>
            <p class="step-subtitle">Confira o resumo da sua cota√ß√£o de Seguro de Frota</p>

            <div class="summary-card">
                <div class="summary-title">Seguro de Frota</div>
                <div class="summary-empresa" id="summaryEmpresa">Empresa XYZ</div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">Total Ve√≠culos</div>
                        <div class="value" id="summaryQtd">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Com Sinistro</div>
                        <div class="value" id="summarySinistros">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Valor Total</div>
                        <div class="value" id="summaryValor">R$ 0</div>
                    </div>
                </div>
            </div>

            <div class="veiculos-resumo">
                <div class="veiculos-resumo-title"><span>üöó</span> Ve√≠culos da Frota</div>
                <div id="veiculosResumoList"></div>
            </div>

            <div class="info-box success">
                <div class="info-header"><span>üéâ</span><span>Pr√≥ximo passo</span></div>
                <p>Preencha seus dados e fale com nosso especialista para receber a proposta completa com valores.</p>
            </div>

            <div class="form-group">
                <label class="form-label">Seu nome</label>
                <input type="text" class="form-input" id="nome" placeholder="Nome completo">
            </div>

            <div class="form-group">
                <label class="form-label">WhatsApp</label>
                <input type="tel" class="form-input" id="whatsapp" placeholder="(00) 00000-0000" oninput="formatPhone(this)">
            </div>

            <button class="btn btn-primary" id="btnEnviar" onclick="enviarCotacao()">Solicitar Proposta Completa</button>

            <a href="#" class="whatsapp-btn" id="whatsappLink" style="display: none;">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                Falar com Especialista
            </a>

            <button class="btn btn-secondary" onclick="prevStep(7)">‚Üê Voltar e ajustar</button>
            <p class="footer-note">üîí Suas informa√ß√µes est√£o seguras. Trabalhamos com as maiores seguradoras do Brasil.</p>
        </div>
    </div>

    <script>
        // Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD3YZVqRbKExEi5CN9CPwlnY-GSzd4lUMM",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "631323599837",
            appId: "1:631323599837:web:77f20f7c65a12113621856"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // URL Params
        const urlParams = new URLSearchParams(window.location.search);
        const indicadorCodigo = urlParams.get('ref') || urlParams.get('indicador');
        const empresaParceiraCodigo = urlParams.get('empresa') || urlParams.get('parceiro');

        // Form Data
        let formData = {
            nomeEmpresa: '',
            cnpj: '',
            veiculos: [],
            temSeguro: '',
            seguradoraAtual: '',
            vencimentoApolice: '',
            coberturas: {
                rcf: true,
                app: true,
                vidros: false,
                carroReserva: false,
                rastreador: false
            },
            nome: '',
            whatsapp: ''
        };

        let currentStep = 1;
        const totalSteps = 7;

        // API FIPE
        const FIPE_API = 'https://parallelum.com.br/fipe/api/v1';

        // Progress
        function updateProgress() {
            document.getElementById('progressBar').style.width = (currentStep / totalSteps * 100) + '%';
            document.getElementById('progressText').textContent = `Etapa ${currentStep} de ${totalSteps}`;
        }

        function showStep(step) {
            document.querySelectorAll('.step-card').forEach(c => c.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            currentStep = step;
            updateProgress();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function nextStep(current) {
            if (current === 1) {
                const nome = document.getElementById('nomeEmpresa').value.trim();
                if (!nome) { alert('Informe o nome da empresa.'); return; }
                formData.nomeEmpresa = nome;
                formData.cnpj = document.getElementById('cnpj').value.trim();
                showStep(2);
            } else if (current === 2) {
                if (formData.veiculos.length === 0) {
                    alert('Adicione pelo menos um ve√≠culo.');
                    return;
                }
                renderSinistrosList();
                showStep(3);
            } else if (current === 3) {
                showStep(4);
            } else if (current === 4) {
                if (!formData.temSeguro) { alert('Informe se j√° possui seguro.'); return; }
                formData.seguradoraAtual = document.getElementById('seguradoraAtual').value;
                formData.vencimentoApolice = document.getElementById('vencimentoApolice').value;
                showStep(5);
            } else if (current === 5) {
                formData.coberturas.rcf = document.getElementById('cobRCF').checked;
                formData.coberturas.app = document.getElementById('cobAPP').checked;
                formData.coberturas.vidros = document.getElementById('cobVidros').checked;
                formData.coberturas.carroReserva = document.getElementById('cobCarroReserva').checked;
                formData.coberturas.rastreador = document.getElementById('cobRastreador').checked;
                showStep(6);
                setTimeout(() => { generateSummary(); showStep(7); }, 2000);
            }
        }

        function prevStep(current) {
            if (current > 1) showStep(current - 1);
        }

        // FIPE API Functions
        async function carregarMarcas() {
            const tipo = document.getElementById('addTipo').value;
            const marcaSelect = document.getElementById('addMarca');
            const modeloSelect = document.getElementById('addModelo');
            const anoSelect = document.getElementById('addAno');
            
            if (!tipo) {
                marcaSelect.disabled = true;
                marcaSelect.innerHTML = '<option value="">Selecione o tipo primeiro</option>';
                return;
            }

            marcaSelect.innerHTML = '<option value="">Carregando...</option>';
            modeloSelect.innerHTML = '<option value="">Selecione a marca primeiro</option>';
            modeloSelect.disabled = true;
            anoSelect.innerHTML = '<option value="">Selecione o modelo primeiro</option>';
            anoSelect.disabled = true;
            document.getElementById('addValor').value = '';

            try {
                const res = await fetch(`${FIPE_API}/${tipo}/marcas`);
                const marcas = await res.json();
                marcaSelect.innerHTML = '<option value="">Selecione a marca</option>' +
                    marcas.map(m => `<option value="${m.codigo}">${m.nome}</option>`).join('');
                marcaSelect.disabled = false;
            } catch (e) {
                marcaSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        async function carregarModelos() {
            const tipo = document.getElementById('addTipo').value;
            const marca = document.getElementById('addMarca').value;
            const modeloSelect = document.getElementById('addModelo');
            const anoSelect = document.getElementById('addAno');

            if (!marca) {
                modeloSelect.disabled = true;
                return;
            }

            modeloSelect.innerHTML = '<option value="">Carregando...</option>';
            anoSelect.innerHTML = '<option value="">Selecione o modelo primeiro</option>';
            anoSelect.disabled = true;
            document.getElementById('addValor').value = '';

            try {
                const res = await fetch(`${FIPE_API}/${tipo}/marcas/${marca}/modelos`);
                const data = await res.json();
                modeloSelect.innerHTML = '<option value="">Selecione o modelo</option>' +
                    data.modelos.map(m => `<option value="${m.codigo}">${m.nome}</option>`).join('');
                modeloSelect.disabled = false;
            } catch (e) {
                modeloSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        async function carregarAnos() {
            const tipo = document.getElementById('addTipo').value;
            const marca = document.getElementById('addMarca').value;
            const modelo = document.getElementById('addModelo').value;
            const anoSelect = document.getElementById('addAno');

            if (!modelo) {
                anoSelect.disabled = true;
                return;
            }

            anoSelect.innerHTML = '<option value="">Carregando...</option>';
            document.getElementById('addValor').value = '';

            try {
                const res = await fetch(`${FIPE_API}/${tipo}/marcas/${marca}/modelos/${modelo}/anos`);
                const anos = await res.json();
                anoSelect.innerHTML = '<option value="">Selecione o ano</option>' +
                    anos.map(a => `<option value="${a.codigo}">${a.nome}</option>`).join('');
                anoSelect.disabled = false;
            } catch (e) {
                anoSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        async function buscarValorFipe() {
            const tipo = document.getElementById('addTipo').value;
            const marca = document.getElementById('addMarca').value;
            const modelo = document.getElementById('addModelo').value;
            const ano = document.getElementById('addAno').value;
            const valorInput = document.getElementById('addValor');

            if (!ano) {
                valorInput.value = '';
                return;
            }

            valorInput.value = 'Buscando...';

            try {
                const res = await fetch(`${FIPE_API}/${tipo}/marcas/${marca}/modelos/${modelo}/anos/${ano}`);
                const data = await res.json();
                valorInput.value = data.Valor;
                valorInput.dataset.valorNumerico = data.Valor.replace(/[^\d]/g, '');
                valorInput.dataset.fipeInfo = JSON.stringify(data);
            } catch (e) {
                valorInput.value = 'N√£o encontrado';
            }
        }

        // Add Vehicle
        function adicionarVeiculo() {
            const tipo = document.getElementById('addTipo');
            const marca = document.getElementById('addMarca');
            const modelo = document.getElementById('addModelo');
            const ano = document.getElementById('addAno');
            const placa = document.getElementById('addPlaca').value.trim().toUpperCase();
            const valorInput = document.getElementById('addValor');
            const uso = document.getElementById('addUso').value;

            if (!tipo.value || !marca.value || !modelo.value || !ano.value) {
                alert('Preencha todos os campos do ve√≠culo.');
                return;
            }

            const tiposNome = { carros: 'üöó Carro', motos: 'üèçÔ∏è Moto', caminhoes: 'üöõ Caminh√£o' };
            
            const veiculo = {
                id: Date.now(),
                tipo: tipo.value,
                tipoNome: tiposNome[tipo.value],
                marca: marca.options[marca.selectedIndex].text,
                marcaCodigo: marca.value,
                modelo: modelo.options[modelo.selectedIndex].text,
                modeloCodigo: modelo.value,
                ano: ano.options[ano.selectedIndex].text,
                anoCodigo: ano.value,
                placa: placa,
                valor: valorInput.value,
                valorNumerico: parseInt(valorInput.dataset.valorNumerico) || 0,
                uso: uso,
                sinistro: false
            };

            formData.veiculos.push(veiculo);
            
            // Limpar campos
            tipo.value = '';
            marca.innerHTML = '<option value="">Selecione o tipo primeiro</option>';
            marca.disabled = true;
            modelo.innerHTML = '<option value="">Selecione a marca primeiro</option>';
            modelo.disabled = true;
            ano.innerHTML = '<option value="">Selecione o modelo primeiro</option>';
            ano.disabled = true;
            document.getElementById('addPlaca').value = '';
            valorInput.value = '';

            renderVehicleList();
        }

        function removerVeiculo(id) {
            formData.veiculos = formData.veiculos.filter(v => v.id !== id);
            renderVehicleList();
        }

        function toggleSinistro(id) {
            const veiculo = formData.veiculos.find(v => v.id === id);
            if (veiculo) {
                veiculo.sinistro = !veiculo.sinistro;
                renderVehicleList();
                if (document.getElementById('step3').classList.contains('active')) {
                    renderSinistrosList();
                }
            }
        }

        function renderVehicleList() {
            const container = document.getElementById('vehicleListContainer');
            const list = document.getElementById('vehicleList');
            const count = document.getElementById('vehicleCount');

            if (formData.veiculos.length === 0) {
                list.style.display = 'none';
                return;
            }

            list.style.display = 'block';
            count.textContent = formData.veiculos.length;

            container.innerHTML = formData.veiculos.map(v => `
                <div class="vehicle-card ${v.sinistro ? 'sinistro' : ''}">
                    <div class="vehicle-card-header">
                        <div class="vehicle-info">
                            <div class="vehicle-modelo">${v.tipoNome} ${v.marca} ${v.modelo}</div>
                            <div class="vehicle-placa">${v.placa ? 'Placa: <strong>' + v.placa + '</strong>' : 'Placa n√£o informada'}</div>
                        </div>
                        <div class="vehicle-actions">
                            <button class="btn-sinistro ${v.sinistro ? 'active' : ''}" onclick="toggleSinistro(${v.id})">
                                ${v.sinistro ? '‚ö†Ô∏è Sinistro' : '‚úì Sem sinistro'}
                            </button>
                            <button class="btn-remove" onclick="removerVeiculo(${v.id})">‚úï</button>
                        </div>
                    </div>
                    <div class="vehicle-details">
                        <div class="vehicle-detail">
                            <div class="vehicle-detail-label">Ano</div>
                            <div class="vehicle-detail-value">${v.ano}</div>
                        </div>
                        <div class="vehicle-detail">
                            <div class="vehicle-detail-label">Valor FIPE</div>
                            <div class="vehicle-detail-value">${v.valor}</div>
                        </div>
                        <div class="vehicle-detail">
                            <div class="vehicle-detail-label">Uso</div>
                            <div class="vehicle-detail-value">${v.uso}</div>
                        </div>
                        <div class="vehicle-detail">
                            <div class="vehicle-detail-label">Status</div>
                            <div class="vehicle-detail-value" style="color: ${v.sinistro ? '#f59e0b' : '#10b981'}">${v.sinistro ? 'Com sinistro' : 'OK'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderSinistrosList() {
            const container = document.getElementById('sinistrosListContainer');
            container.innerHTML = formData.veiculos.map(v => `
                <div class="vehicle-card ${v.sinistro ? 'sinistro' : ''}" style="cursor: pointer;" onclick="toggleSinistro(${v.id})">
                    <div class="vehicle-card-header">
                        <div class="vehicle-info">
                            <div class="vehicle-modelo">${v.tipoNome} ${v.marca} ${v.modelo}</div>
                            <div class="vehicle-placa">${v.placa ? 'Placa: <strong>' + v.placa + '</strong>' : ''} | ${v.ano}</div>
                        </div>
                        <div class="vehicle-actions">
                            <button class="btn-sinistro ${v.sinistro ? 'active' : ''}">
                                ${v.sinistro ? '‚ö†Ô∏è Teve Sinistro' : '‚úì Sem sinistro'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // File Upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    processImportedData(jsonData);
                    showFileInfo(file.name, jsonData.length);
                } catch (error) {
                    alert('Erro ao ler arquivo. Verifique se √© um Excel v√°lido.');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processImportedData(data) {
            data.forEach((row, idx) => {
                const placa = row.Placa || row.PLACA || row.placa || '';
                const marca = row.Marca || row.MARCA || row.marca || '';
                const modelo = row.Modelo || row.MODELO || row.modelo || '';
                const anoFab = row['Ano Fab'] || row['Ano Fabricacao'] || row['ANO FAB'] || row.AnoFab || '';
                const anoMod = row['Ano Mod'] || row['Ano Modelo'] || row['ANO MOD'] || row.AnoMod || anoFab;
                const valor = row.Valor || row.VALOR || row['Valor Estimado'] || 0;
                const uso = row.Uso || row.USO || row.uso || 'transporte';
                const tipo = row.Tipo || row.TIPO || row.tipo || 'carros';

                if (marca || modelo) {
                    const tiposNome = { carros: 'üöó Carro', motos: 'üèçÔ∏è Moto', caminhoes: 'üöõ Caminh√£o' };
                    
                    formData.veiculos.push({
                        id: Date.now() + idx,
                        tipo: tipo.toLowerCase().includes('moto') ? 'motos' : tipo.toLowerCase().includes('caminh') ? 'caminhoes' : 'carros',
                        tipoNome: tiposNome[tipo.toLowerCase().includes('moto') ? 'motos' : tipo.toLowerCase().includes('caminh') ? 'caminhoes' : 'carros'],
                        marca: marca,
                        modelo: modelo,
                        ano: anoMod ? `${anoFab}/${anoMod}` : anoFab,
                        placa: placa.toString().toUpperCase(),
                        valor: typeof valor === 'number' ? 'R$ ' + valor.toLocaleString('pt-BR') : valor,
                        valorNumerico: typeof valor === 'number' ? valor : parseInt(valor.toString().replace(/\D/g, '')) || 0,
                        uso: uso,
                        sinistro: false
                    });
                }
            });
            renderVehicleList();
        }

        function showFileInfo(fileName, count) {
            document.getElementById('fileInfoContainer').style.display = 'block';
            document.getElementById('fileInfoContainer').innerHTML = `
                <div class="file-info">
                    <div class="icon">üìä</div>
                    <div class="details">
                        <div class="name">${fileName}</div>
                        <div class="meta">${formData.veiculos.length} ve√≠culos importados</div>
                    </div>
                    <button class="remove" onclick="removeFile()">‚úï Remover</button>
                </div>
            `;
        }

        function removeFile() {
            formData.veiculos = [];
            document.getElementById('fileInfoContainer').style.display = 'none';
            document.getElementById('fileInput').value = '';
            renderVehicleList();
        }

        // Select tem seguro
        function selectTemSeguro(opcao, el) {
            formData.temSeguro = opcao;
            document.querySelectorAll('#step4 .option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('dadosSeguroAtual').style.display = opcao === 'sim' ? 'block' : 'none';
            document.getElementById('btnStep4').disabled = false;
        }

        // Generate Summary
        function generateSummary() {
            document.getElementById('summaryEmpresa').textContent = formData.nomeEmpresa;
            document.getElementById('summaryQtd').textContent = formData.veiculos.length;
            document.getElementById('summarySinistros').textContent = formData.veiculos.filter(v => v.sinistro).length;
            
            const valorTotal = formData.veiculos.reduce((sum, v) => sum + v.valorNumerico, 0);
            document.getElementById('summaryValor').textContent = 'R$ ' + valorTotal.toLocaleString('pt-BR');

            // Lista de ve√≠culos
            document.getElementById('veiculosResumoList').innerHTML = formData.veiculos.map(v => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                    <div>
                        <div style="font-weight: 600; font-size: 0.9rem;">${v.marca} ${v.modelo}</div>
                        <div style="font-size: 0.75rem; color: var(--text-light);">${v.placa || 'Sem placa'} | ${v.ano}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: var(--primary);">${v.valor}</div>
                        ${v.sinistro ? '<div style="font-size: 0.7rem; color: #f59e0b;">‚ö†Ô∏è Sinistro</div>' : ''}
                    </div>
                </div>
            `).join('');
        }

        // Format Functions
        function formatCNPJ(input) {
            let v = input.value.replace(/\D/g, '').slice(0, 14);
            if (v.length > 12) v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            else if (v.length > 8) v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
            else if (v.length > 5) v = v.replace(/(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
            else if (v.length > 2) v = v.replace(/(\d{2})(\d{0,3})/, '$1.$2');
            input.value = v;
        }

        function formatPhone(input) {
            let v = input.value.replace(/\D/g, '').slice(0, 11);
            if (v.length > 6) v = v.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
            else if (v.length > 2) v = v.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            input.value = v;
        }

        function formatPlaca(input) {
            let v = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 7);
            if (v.length > 3) v = v.slice(0, 3) + '-' + v.slice(3);
            input.value = v;
        }

        // Enviar Cota√ß√£o
        async function enviarCotacao() {
            const nome = document.getElementById('nome').value.trim();
            const whatsapp = document.getElementById('whatsapp').value.trim();
            
            if (!nome) { alert('Informe seu nome.'); return; }
            if (!whatsapp || whatsapp.length < 14) { alert('Informe um WhatsApp v√°lido.'); return; }
            
            formData.nome = nome;
            formData.whatsapp = whatsapp;

            const btn = document.getElementById('btnEnviar');
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            try {
                const valorTotal = formData.veiculos.reduce((sum, v) => sum + v.valorNumerico, 0);
                const qtdSinistros = formData.veiculos.filter(v => v.sinistro).length;

                await db.collection('leads_crm').add({
                    nome: formData.nome,
                    whatsapp: formData.whatsapp.replace(/\D/g, ''),
                    nomeEmpresa: formData.nomeEmpresa,
                    cnpj: formData.cnpj,
                    
                    veiculos: formData.veiculos,
                    qtdVeiculos: formData.veiculos.length,
                    qtdSinistros: qtdSinistros,
                    valorTotal: valorTotal,
                    
                    temSeguro: formData.temSeguro,
                    seguradoraAtual: formData.seguradoraAtual,
                    vencimentoApolice: formData.vencimentoApolice,
                    
                    coberturas: formData.coberturas,
                    
                    ramo: 'auto',
                    tipo: 'frota',
                    status: 'pre_cadastro',
                    origem: 'site',
                    
                    indicadoPorCodigo: indicadorCodigo || null,
                    empresaParceiraCodigo: empresaParceiraCodigo || null,
                    
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });

                btn.style.display = 'none';
                document.getElementById('whatsappLink').style.display = 'flex';

                // WhatsApp message
                const veiculosMsg = formData.veiculos.slice(0, 5).map(v => `   ‚Ä¢ ${v.marca} ${v.modelo} (${v.ano})${v.sinistro ? ' ‚ö†Ô∏è' : ''}`).join('%0A');
                const msg = `Ol√°! Sou *${formData.nome}* da empresa *${formData.nomeEmpresa}* e fiz uma cota√ß√£o de Seguro de Frota.%0A%0A` +
                    `üöó *${formData.veiculos.length} ve√≠culos*%0A${veiculosMsg}${formData.veiculos.length > 5 ? '%0A   ... e mais ' + (formData.veiculos.length - 5) + ' ve√≠culos' : ''}%0A%0A` +
                    `üí∞ Valor total: R$ ${valorTotal.toLocaleString('pt-BR')}%0A` +
                    `‚ö†Ô∏è Sinistros: ${qtdSinistros}%0A%0A` +
                    `Gostaria de receber a proposta completa!`;

                document.getElementById('whatsappLink').href = `https://wa.me/5554997015000?text=${msg}`;
                alert('‚úÖ Cota√ß√£o enviada! Clique no WhatsApp para falar com especialista.');
            } catch (e) {
                console.error(e);
                btn.disabled = false;
                btn.textContent = 'Solicitar Proposta Completa';
                alert('Erro ao enviar. Tente novamente.');
            }
        }

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) handleFileUpload({ target: { files: files } });
        });

        updateProgress();
    </script>
</body>
</html>
