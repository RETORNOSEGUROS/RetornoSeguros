<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhe do Lead - CRM Retorno Seguros</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .lead-header-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }
        .lead-main-info h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .lead-main-info .lead-meta {
            display: flex;
            gap: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .lead-main-info .lead-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .lead-actions {
            display: flex;
            gap: 10px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .info-item {
            background: var(--bg-light);
            padding: 15px;
            border-radius: var(--radius-sm);
        }
        .info-item label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .info-item span {
            font-size: 16px;
            font-weight: 500;
        }
        .timeline-extended .timeline-item::before {
            width: 35px;
            height: 35px;
            left: -41px;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .timeline-extended {
            padding-left: 50px;
        }
        .timeline-extended::before {
            left: 17px;
        }
        .dados-site {
            background: var(--bg-light);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        .dados-site h4 {
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .dados-site pre {
            background: var(--bg-input);
            padding: 15px;
            border-radius: var(--radius-sm);
            overflow-x: auto;
            font-size: 13px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../img/logo-retorno.png" alt="Retorno Seguros" onerror="this.style.display='none'">
                <h2>CRM Seguros</h2>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">Principal</span>
                    <a href="dashboard.html" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="leads.html" class="nav-item active">
                        <i class="fas fa-funnel-dollar"></i>
                        <span>Leads / Pipeline</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Gestão</span>
                    <a href="clientes.html" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </a>
                    <a href="apolices.html" class="nav-item">
                        <i class="fas fa-file-contract"></i>
                        <span>Apólices</span>
                    </a>
                    <a href="renovacoes.html" class="nav-item">
                        <i class="fas fa-sync-alt"></i>
                        <span>Renovações</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Equipe</span>
                    <a href="funcionarios.html" class="nav-item">
                        <i class="fas fa-user-tie"></i>
                        <span>Funcionários</span>
                    </a>
                    <a href="relatorios.html" class="nav-item">
                        <i class="fas fa-chart-bar"></i>
                        <span>Relatórios</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Sistema</span>
                    <a href="configuracoes.html" class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span>Configurações</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">P</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Carregando...</div>
                        <div class="user-role">Administrador</div>
                    </div>
                    <button class="btn-logout" onclick="logout()" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="mobile-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <a href="leads.html" class="btn btn-secondary btn-sm" style="margin-right: 15px;">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                    <h1 class="page-title">Detalhe do Lead</h1>
                </div>
                <div class="header-right">
                    <span class="status-badge" id="leadStatusBadge">Carregando...</span>
                </div>
            </header>

            <!-- Content -->
            <div class="content" id="leadContent">
                <div class="loading" style="padding: 60px;">
                    <div class="spinner"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Alterar Status -->
    <div class="modal-overlay" id="modalStatus">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-exchange-alt"></i> Alterar Status</h2>
                <button class="modal-close" onclick="fecharModal('modalStatus')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Novo Status</label>
                    <select class="form-control" id="novoStatus" onchange="toggleCamposExtras()">
                        <option value="pre_cadastro">Pré-Cadastro</option>
                        <option value="contato_realizado">Contato Realizado</option>
                        <option value="pendente_documentos">Pendente de Documentos</option>
                        <option value="cotacao_enviada">Cotação Enviada</option>
                        <option value="recusada_seguradora">Recusada pela Seguradora</option>
                        <option value="negocio_fechado">Negócio Fechado</option>
                        <option value="negocio_perdido">Negócio Perdido</option>
                    </select>
                </div>
                
                <div id="camposCotacao" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Valor da Cotação (R$)</label>
                            <input type="number" class="form-control" id="valorCotacao" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seguradora</label>
                            <select class="form-control" id="seguradoraCotacao">
                                <option value="">Selecione...</option>
                                <option value="Porto Seguro">Porto Seguro</option>
                                <option value="Bradesco Seguros">Bradesco Seguros</option>
                                <option value="SulAmérica">SulAmérica</option>
                                <option value="Itaú Seguros">Itaú Seguros</option>
                                <option value="Allianz">Allianz</option>
                                <option value="Zurich">Zurich</option>
                                <option value="Liberty">Liberty Seguros</option>
                                <option value="HDI">HDI Seguros</option>
                                <option value="Mapfre">Mapfre</option>
                                <option value="Tokio Marine">Tokio Marine</option>
                                <option value="Outra">Outra</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="camposFechado" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Valor do Prêmio (R$)</label>
                            <input type="number" class="form-control" id="valorPremio" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Comissão (%)</label>
                            <input type="number" class="form-control" id="comissao" step="0.01">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Observação</label>
                    <textarea class="form-control" id="observacaoStatus" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalStatus')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarNovoStatus()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Lead -->
    <div class="modal-overlay" id="modalEditar">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-edit"></i> Editar Lead</h2>
                <button class="modal-close" onclick="fecharModal('modalEditar')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formEditar">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="editNome" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="editEmail">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">WhatsApp *</label>
                            <input type="tel" class="form-control" id="editWhatsapp" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" id="editCpf">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="editNascimento">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="editCep" onblur="buscarCepEdit()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="editCidade">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <input type="text" class="form-control" id="editEstado">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ramo do Seguro *</label>
                            <select class="form-control" id="editRamo" required>
                                <option value="auto">Auto</option>
                                <option value="residencial">Residencial</option>
                                <option value="vida">Vida</option>
                                <option value="empresarial">Empresarial</option>
                                <option value="saude">Saúde</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Responsável</label>
                            <select class="form-control" id="editResponsavel">
                                <option value="">Não atribuído</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" id="editObservacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalEditar')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarEdicao()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Nota -->
    <div class="modal-overlay" id="modalNota">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-sticky-note"></i> Adicionar Nota</h2>
                <button class="modal-close" onclick="fecharModal('modalNota')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nota / Observação</label>
                    <textarea class="form-control" id="novaNota" rows="4" placeholder="Descreva a interação, observação ou informação relevante..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalNota')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarNota()">
                    <i class="fas fa-plus"></i> Adicionar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29",
            measurementId: "G-C6E44WXLPW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const COLECOES = {
            leads: 'leads_crm',
            funcionarios: 'admins_crm',
            atividades: 'atividades_crm',
            notas: 'notas_lead'
        };

        const STATUS_PIPELINE = {
            'pre_cadastro': { label: 'Pré-Cadastro', classe: 'pre-cadastro' },
            'contato_realizado': { label: 'Contato Realizado', classe: 'contato' },
            'pendente_documentos': { label: 'Pendente de Documentos', classe: 'pendente-doc' },
            'cotacao_enviada': { label: 'Cotação Enviada', classe: 'cotacao-enviada' },
            'recusada_seguradora': { label: 'Recusada pela Seguradora', classe: 'recusada' },
            'negocio_fechado': { label: 'Negócio Fechado', classe: 'fechado' },
            'negocio_perdido': { label: 'Negócio Perdido', classe: 'perdido' }
        };

        let usuarioAtual = null;
        let leadAtual = null;
        let leadId = null;

        // Verificar autenticação
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            usuarioAtual = user;
            document.getElementById('userName').textContent = user.email.split('@')[0];
            document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
            
            // Pegar ID do lead da URL
            const params = new URLSearchParams(window.location.search);
            leadId = params.get('id');
            
            if (!leadId) {
                document.getElementById('leadContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Lead não encontrado. <a href="leads.html">Voltar para lista</a>
                    </div>
                `;
                return;
            }
            
            await carregarDados();
        });

        // Carregar dados
        async function carregarDados() {
            await Promise.all([
                carregarLead(),
                carregarFuncionarios()
            ]);
        }

        // Carregar lead
        async function carregarLead() {
            try {
                const doc = await db.collection(COLECOES.leads).doc(leadId).get();
                
                if (!doc.exists) {
                    document.getElementById('leadContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Lead não encontrado. <a href="leads.html">Voltar para lista</a>
                        </div>
                    `;
                    return;
                }
                
                leadAtual = { id: doc.id, ...doc.data() };
                
                // Carregar histórico
                const historico = await carregarHistorico();
                const notas = await carregarNotas();
                
                renderizarLead(historico, notas);
                
            } catch (error) {
                console.error('Erro ao carregar lead:', error);
                mostrarToast('Erro ao carregar lead', 'error');
            }
        }

        // Carregar histórico
        async function carregarHistorico() {
            try {
                const snapshot = await db.collection(COLECOES.atividades)
                    .where('leadId', '==', leadId)
                    .orderBy('dataHora', 'desc')
                    .limit(20)
                    .get();
                
                const historico = [];
                snapshot.forEach(doc => historico.push({ id: doc.id, ...doc.data() }));
                return historico;
                
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                return [];
            }
        }

        // Carregar notas
        async function carregarNotas() {
            try {
                const snapshot = await db.collection(COLECOES.notas)
                    .where('leadId', '==', leadId)
                    .orderBy('criadoEm', 'desc')
                    .get();
                
                const notas = [];
                snapshot.forEach(doc => notas.push({ id: doc.id, ...doc.data() }));
                return notas;
                
            } catch (error) {
                console.error('Erro ao carregar notas:', error);
                return [];
            }
        }

        // Carregar funcionários
        async function carregarFuncionarios() {
            try {
                const snapshot = await db.collection(COLECOES.funcionarios)
                    .where('ativo', '==', true)
                    .get();
                
                const select = document.getElementById('editResponsavel');
                snapshot.forEach(doc => {
                    const func = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${func.nome || func.email}</option>`;
                });
                
            } catch (error) {
                console.error('Erro ao carregar funcionários:', error);
            }
        }

        // Renderizar lead
        function renderizarLead(historico, notas) {
            const lead = leadAtual;
            const status = STATUS_PIPELINE[lead.status] || STATUS_PIPELINE['pre_cadastro'];
            
            // Atualizar badge do header
            document.getElementById('leadStatusBadge').className = `status-badge ${status.classe}`;
            document.getElementById('leadStatusBadge').textContent = status.label;
            
            const criadoEm = lead.criadoEm?.toDate();
            const atualizadoEm = lead.atualizadoEm?.toDate();
            
            document.getElementById('leadContent').innerHTML = `
                <!-- Header do Lead -->
                <div class="lead-header-info">
                    <div class="lead-main-info">
                        <h1>${lead.nome || 'Sem nome'}</h1>
                        <div class="lead-meta">
                            <span><i class="fas fa-folder"></i> ${lead.ramo?.toUpperCase() || '-'}</span>
                            <span><i class="fas fa-calendar"></i> ${formatarData(criadoEm)}</span>
                            <span><i class="fas fa-user-tie"></i> ${lead.responsavelNome || 'Não atribuído'}</span>
                            <span><i class="fas fa-globe"></i> ${lead.origem === 'site' ? 'Site' : 'Manual'}</span>
                        </div>
                    </div>
                    <div class="lead-actions">
                        <button class="btn btn-secondary" onclick="abrirModalEditar()">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-primary" onclick="abrirModalStatus()">
                            <i class="fas fa-exchange-alt"></i> Alterar Status
                        </button>
                        ${lead.whatsapp ? `
                            <button class="btn btn-success" onclick="abrirWhatsApp('${lead.whatsapp}')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                        ` : ''}
                    </div>
                </div>

                <!-- Grid de informações -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <!-- Coluna Principal -->
                    <div>
                        <!-- Informações do Cliente -->
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-user"></i> Informações do Cliente</h2>
                            </div>
                            <div class="card-body">
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>Nome Completo</label>
                                        <span>${lead.nome || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>E-mail</label>
                                        <span>${lead.email || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>WhatsApp</label>
                                        <span>${lead.whatsapp || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>CPF</label>
                                        <span>${lead.cpf || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Data de Nascimento</label>
                                        <span>${lead.dataNascimento || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>CEP</label>
                                        <span>${lead.cep || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Cidade</label>
                                        <span>${lead.cidade || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Estado</label>
                                        <span>${lead.estado || '-'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informações da Cotação (se houver) -->
                        ${lead.valorCotacao || lead.valorPremio ? `
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-dollar-sign"></i> Informações Comerciais</h2>
                            </div>
                            <div class="card-body">
                                <div class="info-grid">
                                    ${lead.valorCotacao ? `
                                    <div class="info-item">
                                        <label>Valor da Cotação</label>
                                        <span>R$ ${parseFloat(lead.valorCotacao).toLocaleString('pt-BR')}</span>
                                    </div>
                                    ` : ''}
                                    ${lead.seguradora ? `
                                    <div class="info-item">
                                        <label>Seguradora</label>
                                        <span>${lead.seguradora}</span>
                                    </div>
                                    ` : ''}
                                    ${lead.valorPremio ? `
                                    <div class="info-item">
                                        <label>Valor do Prêmio</label>
                                        <span style="color: var(--success);">R$ ${parseFloat(lead.valorPremio).toLocaleString('pt-BR')}</span>
                                    </div>
                                    ` : ''}
                                    ${lead.comissao ? `
                                    <div class="info-item">
                                        <label>Comissão</label>
                                        <span>${lead.comissao}%</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Dados do Site (se veio do site) -->
                        ${lead.dadosSite ? `
                        <div class="dados-site">
                            <h4><i class="fas fa-globe"></i> Dados Originais do Site</h4>
                            <pre>${JSON.stringify(lead.dadosSite, null, 2)}</pre>
                        </div>
                        ` : ''}

                        <!-- Observações -->
                        ${lead.observacoes ? `
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-comment"></i> Observações</h2>
                            </div>
                            <div class="card-body">
                                <p style="white-space: pre-wrap;">${lead.observacoes}</p>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Notas -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-sticky-note"></i> Notas</h2>
                                <button class="btn btn-sm btn-primary" onclick="abrirModalNota()">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                            <div class="card-body">
                                ${notas.length === 0 ? `
                                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                                        Nenhuma nota adicionada
                                    </p>
                                ` : notas.map(nota => `
                                    <div style="background: var(--bg-light); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 10px;">
                                        <p style="margin-bottom: 10px;">${nota.texto}</p>
                                        <small style="color: var(--text-muted);">
                                            ${nota.criadoPor || 'Sistema'} - ${formatarDataHora(nota.criadoEm?.toDate())}
                                        </small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Coluna Lateral -->
                    <div>
                        <!-- Status Atual -->
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-info-circle"></i> Status Atual</h2>
                            </div>
                            <div class="card-body" style="text-align: center;">
                                <span class="status-badge ${status.classe}" style="font-size: 16px; padding: 10px 20px;">
                                    ${status.label}
                                </span>
                                <p style="margin-top: 15px; color: var(--text-muted); font-size: 13px;">
                                    Atualizado em: ${formatarDataHora(atualizadoEm)}
                                </p>
                            </div>
                        </div>

                        <!-- Histórico -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-history"></i> Histórico</h2>
                            </div>
                            <div class="card-body">
                                ${historico.length === 0 ? `
                                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                                        Nenhuma atividade registrada
                                    </p>
                                ` : `
                                    <div class="timeline timeline-extended">
                                        ${historico.map(item => `
                                            <div class="timeline-item">
                                                <div class="timeline-content">
                                                    <div class="timeline-date">${formatarDataHora(item.dataHora?.toDate())}</div>
                                                    <div class="timeline-text">${item.descricao || '-'}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Abrir modal de status
        function abrirModalStatus() {
            document.getElementById('novoStatus').value = leadAtual.status || 'pre_cadastro';
            toggleCamposExtras();
            document.getElementById('modalStatus').classList.add('active');
        }

        // Toggle campos extras
        function toggleCamposExtras() {
            const status = document.getElementById('novoStatus').value;
            document.getElementById('camposCotacao').style.display = status === 'cotacao_enviada' ? 'block' : 'none';
            document.getElementById('camposFechado').style.display = status === 'negocio_fechado' ? 'block' : 'none';
        }

        // Salvar novo status
        async function salvarNovoStatus() {
            const novoStatus = document.getElementById('novoStatus').value;
            const observacao = document.getElementById('observacaoStatus').value;
            
            let dadosExtras = {};
            
            if (novoStatus === 'cotacao_enviada') {
                dadosExtras.valorCotacao = document.getElementById('valorCotacao').value || null;
                dadosExtras.seguradora = document.getElementById('seguradoraCotacao').value || null;
            }
            
            if (novoStatus === 'negocio_fechado') {
                dadosExtras.valorPremio = document.getElementById('valorPremio').value || null;
                dadosExtras.comissao = document.getElementById('comissao').value || null;
            }
            
            try {
                const statusAntigo = leadAtual.status;
                
                await db.collection(COLECOES.leads).doc(leadId).update({
                    status: novoStatus,
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    ...dadosExtras
                });
                
                await db.collection(COLECOES.atividades).add({
                    tipo: 'status_alterado',
                    descricao: `${STATUS_PIPELINE[statusAntigo]?.label} → ${STATUS_PIPELINE[novoStatus]?.label}${observacao ? ` | ${observacao}` : ''}`,
                    leadId: leadId,
                    statusAnterior: statusAntigo,
                    statusNovo: novoStatus,
                    usuarioEmail: usuarioAtual.email,
                    dataHora: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                mostrarToast('Status atualizado!', 'success');
                fecharModal('modalStatus');
                
                // Limpar campos
                document.getElementById('observacaoStatus').value = '';
                document.getElementById('valorCotacao').value = '';
                document.getElementById('valorPremio').value = '';
                document.getElementById('comissao').value = '';
                
                await carregarLead();
                
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                mostrarToast('Erro ao atualizar status', 'error');
            }
        }

        // Abrir modal de edição
        function abrirModalEditar() {
            document.getElementById('editNome').value = leadAtual.nome || '';
            document.getElementById('editEmail').value = leadAtual.email || '';
            document.getElementById('editWhatsapp').value = leadAtual.whatsapp || '';
            document.getElementById('editCpf').value = leadAtual.cpf || '';
            document.getElementById('editNascimento').value = leadAtual.dataNascimento || '';
            document.getElementById('editCep').value = leadAtual.cep || '';
            document.getElementById('editCidade').value = leadAtual.cidade || '';
            document.getElementById('editEstado').value = leadAtual.estado || '';
            document.getElementById('editRamo').value = leadAtual.ramo || '';
            document.getElementById('editResponsavel').value = leadAtual.responsavelId || '';
            document.getElementById('editObservacoes').value = leadAtual.observacoes || '';
            
            document.getElementById('modalEditar').classList.add('active');
        }

        // Salvar edição
        async function salvarEdicao() {
            const nome = document.getElementById('editNome').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const whatsapp = document.getElementById('editWhatsapp').value.trim();
            const cpf = document.getElementById('editCpf').value.trim();
            const nascimento = document.getElementById('editNascimento').value;
            const cep = document.getElementById('editCep').value.trim();
            const cidade = document.getElementById('editCidade').value.trim();
            const estado = document.getElementById('editEstado').value.trim();
            const ramo = document.getElementById('editRamo').value;
            const responsavelId = document.getElementById('editResponsavel').value;
            const observacoes = document.getElementById('editObservacoes').value.trim();
            
            if (!nome || !whatsapp || !ramo) {
                mostrarToast('Preencha os campos obrigatórios', 'error');
                return;
            }
            
            try {
                let responsavelNome = 'Não atribuído';
                if (responsavelId) {
                    const respDoc = await db.collection(COLECOES.funcionarios).doc(responsavelId).get();
                    if (respDoc.exists) {
                        responsavelNome = respDoc.data().nome || respDoc.data().email;
                    }
                }
                
                await db.collection(COLECOES.leads).doc(leadId).update({
                    nome,
                    email,
                    whatsapp,
                    cpf,
                    dataNascimento: nascimento || null,
                    cep,
                    cidade,
                    estado,
                    ramo,
                    responsavelId: responsavelId || null,
                    responsavelNome,
                    observacoes,
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection(COLECOES.atividades).add({
                    tipo: 'lead_editado',
                    descricao: `Lead atualizado por ${usuarioAtual.email}`,
                    leadId: leadId,
                    usuarioEmail: usuarioAtual.email,
                    dataHora: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                mostrarToast('Lead atualizado!', 'success');
                fecharModal('modalEditar');
                await carregarLead();
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                mostrarToast('Erro ao salvar', 'error');
            }
        }

        // Abrir modal de nota
        function abrirModalNota() {
            document.getElementById('novaNota').value = '';
            document.getElementById('modalNota').classList.add('active');
        }

        // Salvar nota
        async function salvarNota() {
            const texto = document.getElementById('novaNota').value.trim();
            
            if (!texto) {
                mostrarToast('Digite uma nota', 'error');
                return;
            }
            
            try {
                await db.collection(COLECOES.notas).add({
                    leadId: leadId,
                    texto,
                    criadoPor: usuarioAtual.email,
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                mostrarToast('Nota adicionada!', 'success');
                fecharModal('modalNota');
                await carregarLead();
                
            } catch (error) {
                console.error('Erro ao salvar nota:', error);
                mostrarToast('Erro ao salvar nota', 'error');
            }
        }

        // Buscar CEP
        async function buscarCepEdit() {
            const cep = document.getElementById('editCep').value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                
                if (!data.erro) {
                    document.getElementById('editCidade').value = data.localidade || '';
                    document.getElementById('editEstado').value = data.uf || '';
                }
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
            }
        }

        // Utilitários
        function formatarData(data) {
            if (!data) return '-';
            return data.toLocaleDateString('pt-BR');
        }

        function formatarDataHora(data) {
            if (!data) return '-';
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function abrirWhatsApp(numero) {
            if (!numero) return;
            const limpo = numero.replace(/\D/g, '');
            window.open(`https://wa.me/55${limpo}`, '_blank');
        }

        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function mostrarToast(mensagem, tipo = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'times-circle' : 'info-circle'}"></i>
                <span>${mensagem}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // Fechar modal ao clicar fora
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
