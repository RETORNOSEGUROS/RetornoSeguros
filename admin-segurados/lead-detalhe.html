<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhe do Lead - CRM Retorno Seguros</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .lead-header-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }
        .lead-main-info h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .lead-main-info .lead-meta {
            display: flex;
            gap: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .lead-main-info .lead-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .lead-actions {
            display: flex;
            gap: 10px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .info-item {
            background: var(--bg-light);
            padding: 15px;
            border-radius: var(--radius-sm);
        }
        .info-item label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .info-item span {
            font-size: 16px;
            font-weight: 500;
        }
        .timeline-extended .timeline-item::before {
            width: 35px;
            height: 35px;
            left: -41px;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .timeline-extended {
            padding-left: 50px;
        }
        .timeline-extended::before {
            left: 17px;
        }
        .dados-site {
            background: var(--bg-light);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        .dados-site h4 {
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .dados-site pre {
            background: var(--bg-input);
            padding: 15px;
            border-radius: var(--radius-sm);
            overflow-x: auto;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        /* Formata√ß√£o amig√°vel dos dados do site */
        .dados-site-formatados {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        
        .dados-grupo {
            background: var(--bg-input);
            border-radius: var(--radius-sm);
            padding: 1rem;
        }
        
        .dados-grupo h5 {
            color: var(--text-primary);
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .dados-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .dado-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .dado-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .dado-valor {
            font-size: 0.95rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .dados-lista {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .cobertura-tag {
            background: linear-gradient(135deg, var(--primary-color), #00b8d4);
            color: white;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../img/logo-retorno.png" alt="Retorno Seguros" onerror="this.style.display='none'">
            <h2>CRM Seguros</h2>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <span class="nav-section-title">Principal</span>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="leads.html" class="nav-item active">
                    <i class="fas fa-funnel-dollar"></i>
                    <span>Leads / Pipeline</span>
                    <span class="nav-badge" id="leadsNovos">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Gest√£o</span>
                <a href="clientes.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
                <a href="apolices.html" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Ap√≥lices</span>
                </a>
                <a href="indicacoes.html" class="nav-item">
                    <i class="fas fa-gift"></i>
                    <span>Indica√ß√µes</span>
                </a>
                <a href="renovacoes.html" class="nav-item">
                    <i class="fas fa-sync-alt"></i>
                    <span>Renova√ß√µes</span>
                    <span class="nav-badge" id="renovacoesPendentes">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Benefici√°rios</span>
                <a href="empresas-clientes.html" class="nav-item">
                    <i class="fas fa-building"></i>
                    <span>Empresas Clientes</span>
                </a>
                <a href="movimentacoes.html" class="nav-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Movimenta√ß√µes</span>
                    <span class="nav-badge" id="movimentacoesPendentes">0</span>
                </a>
                <a href="importar-beneficiarios.html" class="nav-item">
                    <i class="fas fa-file-import"></i>
                    <span>Importar Planilha</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Parceiros</span>
                <a href="parceiros.html" class="nav-item">
                    <i class="fas fa-handshake"></i>
                    <span>Empresas Parceiras</span>
                </a>
                <a href="resgates-parceiros.html" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Resgates</span>
                    <span class="nav-badge" id="resgatesPendentes">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Equipe</span>
                <a href="funcionarios.html" class="nav-item">
                    <i class="fas fa-user-tie"></i>
                    <span>Funcion√°rios</span>
                </a>
                <a href="relatorios.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relat√≥rios</span>
                </a>
                <a href="relatorio-desistentes.html" class="nav-item">
                    <i class="fas fa-user-times"></i>
                    <span>Desistentes</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Sistema</span>
                <a href="configuracoes.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configura√ß√µes</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Carregando...</div>
                    <div class="user-role">Administrador</div>
                </div>
                <button class="btn-logout" onclick="fazerLogout()" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="mobile-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <a href="leads.html" class="btn btn-secondary btn-sm" style="margin-right: 15px;">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                    <h1 class="page-title">Detalhe do Lead</h1>
                </div>
                <div class="header-right">
                    <span class="status-badge" id="leadStatusBadge">Carregando...</span>
                </div>
            </header>

            <!-- Content -->
            <div class="content" id="leadContent">
                <div class="loading" style="padding: 60px;">
                    <div class="spinner"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Alterar Status -->
    <div class="modal-overlay" id="modalStatus">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-exchange-alt"></i> Alterar Status</h2>
                <button class="modal-close" onclick="fecharModal('modalStatus')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Novo Status</label>
                    <select class="form-control" id="novoStatus" onchange="toggleCamposExtras()">
                        <option value="pre_cadastro">Pr√©-Cadastro</option>
                        <option value="contato_realizado">Contato Realizado</option>
                        <option value="pendente_documentos">Pendente de Documentos</option>
                        <option value="cotacao_enviada">Cota√ß√£o Enviada</option>
                        <option value="recusada_seguradora">Recusada pela Seguradora</option>
                        <option value="negocio_fechado">Neg√≥cio Fechado</option>
                        <option value="negocio_perdido">Neg√≥cio Perdido</option>
                    </select>
                </div>
                
                <div id="camposCotacao" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Valor da Cota√ß√£o (R$)</label>
                            <input type="number" class="form-control" id="valorCotacao" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seguradora</label>
                            <select class="form-control" id="seguradoraCotacao">
                                <option value="">Selecione...</option>
                                <option value="Porto Seguro">Porto Seguro</option>
                                <option value="Bradesco Seguros">Bradesco Seguros</option>
                                <option value="SulAm√©rica">SulAm√©rica</option>
                                <option value="Ita√∫ Seguros">Ita√∫ Seguros</option>
                                <option value="Allianz">Allianz</option>
                                <option value="Zurich">Zurich</option>
                                <option value="Liberty">Liberty Seguros</option>
                                <option value="HDI">HDI Seguros</option>
                                <option value="Mapfre">Mapfre</option>
                                <option value="Tokio Marine">Tokio Marine</option>
                                <option value="Outra">Outra</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="camposFechado" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Valor do Pr√™mio (R$)</label>
                            <input type="number" class="form-control" id="valorPremio" step="0.01" placeholder="Ex: 3500.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Comiss√£o (%)</label>
                            <input type="number" class="form-control" id="comissao" step="0.01" placeholder="Ex: 10">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">In√≠cio da Vig√™ncia</label>
                            <input type="date" class="form-control" id="dataInicioVigencia">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fim da Vig√™ncia</label>
                            <input type="date" class="form-control" id="dataFimVigencia">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">N√∫mero da Ap√≥lice</label>
                            <input type="text" class="form-control" id="numeroApolice" placeholder="Ex: APO-2024-001">
                        </div>
                    </div>
                    <div style="background: #1a3a4a; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                        <small style="color: #10b981;"><i class="fas fa-info-circle"></i> Ao confirmar, uma ap√≥lice ser√° criada automaticamente na gest√£o de ap√≥lices.</small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Observa√ß√£o</label>
                    <textarea class="form-control" id="observacaoStatus" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalStatus')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarNovoStatus()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Lead -->
    <div class="modal-overlay" id="modalEditar">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-edit"></i> Editar Lead</h2>
                <button class="modal-close" onclick="fecharModal('modalEditar')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formEditar">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="editNome" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="editEmail">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">WhatsApp *</label>
                            <input type="tel" class="form-control" id="editWhatsapp" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" id="editCpf">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="editNascimento">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="editCep" onblur="buscarCepEdit()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="editCidade">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <input type="text" class="form-control" id="editEstado">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ramo do Seguro *</label>
                            <select class="form-control" id="editRamo" required>
                                <option value="auto">Auto</option>
                                <option value="residencial">Residencial</option>
                                <option value="vida">Vida</option>
                                <option value="empresarial">Empresarial</option>
                                <option value="saude">Sa√∫de</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Respons√°vel</label>
                            <select class="form-control" id="editResponsavel">
                                <option value="">N√£o atribu√≠do</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="editObservacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalEditar')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarEdicao()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Nota -->
    <div class="modal-overlay" id="modalNota">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-sticky-note"></i> Adicionar Nota</h2>
                <button class="modal-close" onclick="fecharModal('modalNota')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nota / Observa√ß√£o</label>
                    <textarea class="form-control" id="novaNota" rows="4" placeholder="Descreva a intera√ß√£o, observa√ß√£o ou informa√ß√£o relevante..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalNota')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarNota()">
                    <i class="fas fa-plus"></i> Adicionar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29",
            measurementId: "G-C6E44WXLPW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const COLECOES = {
            leads: 'leads_crm',
            funcionarios: 'admins_crm',
            atividades: 'atividades_crm',
            notas: 'notas_lead'
        };

        const STATUS_PIPELINE = {
            'pre_cadastro': { label: 'Pr√©-Cadastro', classe: 'pre-cadastro' },
            'contato_realizado': { label: 'Contato Realizado', classe: 'contato' },
            'pendente_documentos': { label: 'Pendente de Documentos', classe: 'pendente-doc' },
            'cotacao_enviada': { label: 'Cota√ß√£o Enviada', classe: 'cotacao-enviada' },
            'recusada_seguradora': { label: 'Recusada pela Seguradora', classe: 'recusada' },
            'negocio_fechado': { label: 'Neg√≥cio Fechado', classe: 'fechado' },
            'negocio_perdido': { label: 'Neg√≥cio Perdido', classe: 'perdido' }
        };

        let usuarioAtual = null;
        let leadAtual = null;
        let leadId = null;

        // Verificar autentica√ß√£o
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            usuarioAtual = user;
            document.getElementById('userName').textContent = user.email.split('@')[0];
            document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
            
            // Pegar ID do lead da URL
            const params = new URLSearchParams(window.location.search);
            leadId = params.get('id');
            
            if (!leadId) {
                document.getElementById('leadContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Lead n√£o encontrado. <a href="leads.html">Voltar para lista</a>
                    </div>
                `;
                return;
            }
            
            await carregarDados();
        });

        // Carregar dados
        async function carregarDados() {
            await Promise.all([
                carregarLead(),
                carregarFuncionarios()
            ]);
        }

        // Carregar lead
        async function carregarLead() {
            try {
                const doc = await db.collection(COLECOES.leads).doc(leadId).get();
                
                if (!doc.exists) {
                    document.getElementById('leadContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Lead n√£o encontrado. <a href="leads.html">Voltar para lista</a>
                        </div>
                    `;
                    return;
                }
                
                leadAtual = { id: doc.id, ...doc.data() };
                
                // Carregar hist√≥rico
                const historico = await carregarHistorico();
                const notas = await carregarNotas();
                
                renderizarLead(historico, notas);
                
            } catch (error) {
                console.error('Erro ao carregar lead:', error);
                mostrarToast('Erro ao carregar lead', 'error');
            }
        }

        // Carregar hist√≥rico
        async function carregarHistorico() {
            try {
                const snapshot = await db.collection(COLECOES.atividades)
                    .where('leadId', '==', leadId)
                    .orderBy('dataHora', 'desc')
                    .limit(20)
                    .get();
                
                const historico = [];
                snapshot.forEach(doc => historico.push({ id: doc.id, ...doc.data() }));
                return historico;
                
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                return [];
            }
        }

        // Carregar notas
        async function carregarNotas() {
            try {
                const snapshot = await db.collection(COLECOES.notas)
                    .where('leadId', '==', leadId)
                    .orderBy('criadoEm', 'desc')
                    .get();
                
                const notas = [];
                snapshot.forEach(doc => notas.push({ id: doc.id, ...doc.data() }));
                return notas;
                
            } catch (error) {
                console.error('Erro ao carregar notas:', error);
                return [];
            }
        }

        // Carregar funcion√°rios
        async function carregarFuncionarios() {
            try {
                const snapshot = await db.collection(COLECOES.funcionarios)
                    .where('ativo', '==', true)
                    .get();
                
                const select = document.getElementById('editResponsavel');
                snapshot.forEach(doc => {
                    const func = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${func.nome || func.email}</option>`;
                });
                
            } catch (error) {
                console.error('Erro ao carregar funcion√°rios:', error);
            }
        }

        // Renderizar lead
        function renderizarLead(historico, notas) {
            const lead = leadAtual;
            const status = STATUS_PIPELINE[lead.status] || STATUS_PIPELINE['pre_cadastro'];
            
            // Atualizar badge do header
            document.getElementById('leadStatusBadge').className = `status-badge ${status.classe}`;
            document.getElementById('leadStatusBadge').textContent = status.label;
            
            const criadoEm = lead.criadoEm?.toDate();
            const atualizadoEm = lead.atualizadoEm?.toDate();
            
            document.getElementById('leadContent').innerHTML = `
                <!-- Header do Lead -->
                <div class="lead-header-info">
                    <div class="lead-main-info">
                        <h1>${lead.nomeEmpresa || lead.nome || 'Sem nome'}</h1>
                        <div class="lead-meta">
                            <span><i class="fas fa-folder"></i> ${lead.ramo?.toUpperCase() || '-'}</span>
                            <span><i class="fas fa-calendar"></i> ${formatarData(criadoEm)}</span>
                            <span><i class="fas fa-user-tie"></i> ${lead.responsavelNome || 'N√£o atribu√≠do'}</span>
                            <span><i class="fas fa-globe"></i> ${lead.origem === 'site' ? 'Site' : 'Manual'}</span>
                        </div>
                    </div>
                    <div class="lead-actions">
                        <button class="btn btn-secondary" onclick="abrirModalEditar()">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-primary" onclick="abrirModalStatus()">
                            <i class="fas fa-exchange-alt"></i> Alterar Status
                        </button>
                        ${lead.whatsapp ? `
                            <button class="btn btn-success" onclick="abrirWhatsApp('${lead.whatsapp}')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                        ` : ''}
                        <button class="btn" style="background: #dc3545; color: white;" onclick="confirmarExclusao()">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                </div>

                <!-- Grid de informa√ß√µes -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <!-- Coluna Principal -->
                    <div>
                        <!-- BADGE DE EMPRESA PARCEIRA (se houver) -->
                        ${lead.empresaParceiraCodigo ? `
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                            <div style="width: 45px; height: 45px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem;">
                                ü§ù
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Empresa Parceira</div>
                                <div style="font-size: 1.2rem; font-weight: 700;">
                                    ${lead.empresaParceiraNome || 'Parceiro'} 
                                    <span style="background: rgba(255,255,255,0.3); padding: 3px 10px; border-radius: 20px; font-size: 0.9rem; margin-left: 10px;">${lead.empresaParceiraCodigo}</span>
                                </div>
                            </div>
                            <div style="margin-left: auto;">
                                <a href="parceiros.html" style="color: white; text-decoration: none; font-size: 0.85rem; opacity: 0.9;">
                                    Ver parceiros <i class="fas fa-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- BADGE DE INDICA√á√ÉO CLIENTE (se houver) -->
                        ${lead.indicadoPorCodigo ? `
                        <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                            <div style="width: 45px; height: 45px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem;">
                                üéÅ
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Indicado por</div>
                                <div style="font-size: 1.2rem; font-weight: 700;">
                                    ${lead.indicadoPorNome || 'Indicador'} 
                                    <span style="background: rgba(255,255,255,0.3); padding: 3px 10px; border-radius: 20px; font-size: 0.9rem; margin-left: 10px;">${lead.indicadoPorCodigo}</span>
                                </div>
                            </div>
                            <div style="margin-left: auto;">
                                <a href="indicacoes.html" style="color: white; text-decoration: none; font-size: 0.85rem; opacity: 0.9;">
                                    Ver indica√ß√µes <i class="fas fa-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Informa√ß√µes do Cliente/Contato -->
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-user"></i> ${lead.nomeEmpresa ? 'Contato/Respons√°vel' : 'Informa√ß√µes do Cliente'}</h2>
                            </div>
                            <div class="card-body">
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>${lead.nomeEmpresa ? 'Nome do Respons√°vel' : 'Nome Completo'}</label>
                                        <span>${lead.nome || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>E-mail</label>
                                        <span>${lead.email || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>WhatsApp</label>
                                        <span>${lead.whatsapp || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>CPF</label>
                                        <span>${lead.cpf || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Data de Nascimento</label>
                                        <span>${formatarDataNascimento(lead.dataNascimento)}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>CEP</label>
                                        <span>${lead.cep || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Cidade</label>
                                        <span>${lead.cidade || '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Estado</label>
                                        <span>${lead.estado || '-'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informa√ß√µes Empresariais (se houver CNPJ ou for dental/empresarial) -->
                        ${lead.cnpj || lead.funcionarios || lead.tipo === 'empresarial' || lead.ramo === 'dental' || lead.nomeEmpresa ? `
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-building"></i> Dados da Empresa</h2>
                            </div>
                            <div class="card-body">
                                <div class="info-grid">
                                    ${lead.nomeEmpresa ? `
                                    <div class="info-item">
                                        <label>Nome da Empresa</label>
                                        <span>${lead.nomeEmpresa}</span>
                                    </div>
                                    ` : ''}
                                    ${lead.cnpj ? `
                                    <div class="info-item">
                                        <label>CNPJ</label>
                                        <span>${formatarCNPJ(lead.cnpj)}</span>
                                    </div>
                                    ` : ''}
                                    ${lead.funcionarios ? `
                                    <div class="info-item">
                                        <label>N√∫mero de Funcion√°rios</label>
                                        <span>${lead.funcionarios}</span>
                                    </div>
                                    ` : ''}
                                    ${lead.dependentes ? `
                                    <div class="info-item">
                                        <label>Incluir Dependentes</label>
                                        <span>${lead.dependentes === 'sim' ? 'Sim' : 'N√£o'}</span>
                                    </div>
                                    ` : ''}
                                    ${lead.tipo ? `
                                    <div class="info-item">
                                        <label>Tipo de Plano</label>
                                        <span>${lead.tipo.charAt(0).toUpperCase() + lead.tipo.slice(1)}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Detalhes do Plano de Sa√∫de (se for sa√∫de empresarial) -->
                        ${lead.ramo === 'saude' && lead.totalVidas ? `
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-heartbeat"></i> Detalhes do Plano de Sa√∫de</h2>
                            </div>
                            <div class="card-body">
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>Total de Vidas</label>
                                        <span style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${lead.totalVidas}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Acomoda√ß√£o</label>
                                        <span>${lead.acomodacao === 'apartamento' ? 'üõéÔ∏è Apartamento' : 'üè• Enfermaria'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Cobertura</label>
                                        <span>${lead.cobertura === 'completa' ? '‚úÖ Completa (Amb + Hosp)' : 'üè• Apenas Hospitalar'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Coparticipa√ß√£o</label>
                                        <span>${lead.coparticipacao === 'sim' ? 'üíµ Sim' : 'üíé N√£o'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Forma de Pagamento</label>
                                        <span>${lead.formaPagamento === 'empresa' ? 'üè¢ Empresa paga tudo' : 'üë§ Desconto em folha'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Plano Diferenciado (S√≥cios)</label>
                                        <span>${lead.planoDiferenciado === 'sim' ? '‚≠ê Sim (' + (lead.qtdSocios || 0) + ' pessoas)' : 'üë• Mesmo plano para todos'}</span>
                                    </div>
                                </div>
                                
                                ${lead.faixasEtarias ? `
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                    <label style="display: block; margin-bottom: 15px; font-weight: 600; color: var(--text-secondary);">
                                        <i class="fas fa-users"></i> Distribui√ß√£o por Faixa Et√°ria
                                    </label>
                                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                                        <div style="text-align: center; padding: 10px; background: var(--bg-light); border-radius: 8px;">
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">0 a 18</div>
                                            <div style="font-size: 1.2rem; font-weight: bold;">${lead.faixasEtarias.faixa0 || 0}</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: var(--bg-light); border-radius: 8px;">
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">19 a 23</div>
                                            <div style="font-size: 1.2rem; font-weight: bold;">${lead.faixasEtarias.faixa1 || 0}</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: var(--bg-light); border-radius: 8px;">
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">24 a 28</div>
                                            <div style="font-size: 1.2rem; font-weight: bold;">${lead.faixasEtarias.faixa2 || 0}</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: var(--bg-light); border-radius: 8px;">
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">29 a 33</div>
                                            <div style="font-size: 1.2rem; font-weight: bold;">${lead.faixasEtarias.faixa3 || 0}</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: var(--bg-light); border-radius: 8px;">
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">34 a 38</div>
                                            <div style="font-size: 1.2rem; font-weight: bold;">${lead.faixasEtarias.faixa4 || 0}</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: var(--bg-light); border-radius: 8px;">
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">39 a 43</div>
                                            <div style="font-size: 1.2rem; font-weight: bold;">${lead.faixasEtarias.faixa5 || 0}</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: var(--bg-light); border-radius: 8px;">
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">44 a 48</div>
                                            <div style="font-size: 1.2rem; font-weight: bold;">${lead.faixasEtarias.faixa6 || 0}</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: var(--bg-light); border-radius: 8px;">
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">49 a 53</div>
                                            <div style="font-size: 1.2rem; font-weight: bold;">${lead.faixasEtarias.faixa7 || 0}</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: var(--bg-light); border-radius: 8px;">
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">54 a 58</div>
                                            <div style="font-size: 1.2rem; font-weight: bold;">${lead.faixasEtarias.faixa8 || 0}</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: var(--bg-light); border-radius: 8px;">
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">59+</div>
                                            <div style="font-size: 1.2rem; font-weight: bold;">${lead.faixasEtarias.faixa9 || 0}</div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${lead.sociosSelecionados && lead.sociosSelecionados.length > 0 ? `
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                    <label style="display: block; margin-bottom: 15px; font-weight: 600; color: var(--text-secondary);">
                                        <i class="fas fa-star"></i> S√≥cios/Diretores (Plano Executivo)
                                    </label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${lead.sociosSelecionados.map(s => `
                                            <span style="background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem;">
                                                ‚≠ê ${s.nome || 'S√≥cio'} (${s.idade || '-'} anos)
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Detalhes do Seguro de Vida Empresarial -->
                        ${lead.ramo === 'vida' && lead.tipo === 'empresarial' && lead.totalVidas ? `
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-shield-alt"></i> Detalhes do Seguro de Vida</h2>
                            </div>
                            <div class="card-body">
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>Total de Vidas</label>
                                        <span style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${lead.totalVidas}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Formato</label>
                                        <span>${lead.formato === 'global' ? 'üåê Capital Global' : 'üìä Movimenta√ß√£o'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Tipo de Benefici√°rios</label>
                                        <span>${lead.tipoBeneficiario === 'ambos' ? 'üë• Funcion√°rios + S√≥cios' : 'üë∑ Apenas Funcion√°rios'}</span>
                                    </div>
                                    ${lead.qtdSocios ? '<div class="info-item"><label>S√≥cios/Diretores</label><span style="color: #f59e0b; font-weight: bold;">' + lead.qtdSocios + '</span></div>' : ''}
                                    <div class="info-item">
                                        <label>Funcion√°rios</label>
                                        <span style="color: #3b82f6; font-weight: bold;">${lead.qtdFuncionarios || '-'}</span>
                                    </div>
                                </div>
                                
                                ${lead.coberturas && lead.coberturas.length > 0 ? '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);"><label style="display: block; margin-bottom: 15px; font-weight: 600; color: var(--text-secondary);"><i class="fas fa-shield-alt"></i> Coberturas Selecionadas</label><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">' + formatarCoberturasVida(lead.coberturas) + '</div></div>' : ''}
                                
                                ${lead.colaboradores && lead.colaboradores.length > 0 ? formatarColaboradoresVida(lead.colaboradores) : ''}
                                
                                ${!lead.colaboradores && lead.faixasEtarias ? formatarFaixasVida(lead.faixasEtarias) : ''}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Detalhes do Seguro Empresarial (Patrimonial) -->
                        ${lead.ramo === 'empresarial' && lead.tipo === 'empresarial' ? `
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-building"></i> Detalhes do Seguro Empresarial</h2>
                            </div>
                            <div class="card-body">
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>Tipo de Estabelecimento</label>
                                        <span>${formatarTipoEstabelecimento(lead.tipoEstabelecimento)}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Valor Total em Risco</label>
                                        <span style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">R$ ${(lead.valorTotal || 0).toLocaleString('pt-BR')}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Constru√ß√£o Alvenaria</label>
                                        <span>${lead.alvenaria === 'sim' ? '‚úÖ Sim' : lead.alvenaria === 'nao' ? '‚ùå N√£o' : '-'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Possui Seguro Atual</label>
                                        <span>${lead.temApolice === 'sim' ? '‚úÖ Sim' : lead.temApolice === 'nao' ? 'üÜï N√£o (primeira contrata√ß√£o)' : '-'}</span>
                                    </div>
                                    ${lead.vencimentoApolice ? '<div class="info-item"><label>Vencimento Ap√≥lice Atual</label><span>' + new Date(lead.vencimentoApolice).toLocaleDateString('pt-BR') + '</span></div>' : ''}
                                    ${lead.teveSinistro ? '<div class="info-item"><label>Sinistro na √öltima Vig√™ncia</label><span>' + (lead.teveSinistro === 'sim' ? '‚ö†Ô∏è Sim' : '‚úÖ N√£o') + '</span></div>' : ''}
                                </div>
                                
                                ${lead.objetos ? `
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                    <label style="display: block; margin-bottom: 15px; font-weight: 600; color: var(--text-secondary);">
                                        <i class="fas fa-boxes"></i> Objetos Segurados
                                    </label>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                                        ${lead.objetos.predio ? '<div style="background: linear-gradient(135deg, rgba(8, 145, 178, 0.1), rgba(6, 182, 212, 0.1)); border: 1px solid #0891b2; border-radius: 10px; padding: 12px; text-align: center;"><div style="font-size: 1.5rem;">üèóÔ∏è</div><div style="font-weight: 600; margin: 5px 0;">Pr√©dio/Im√≥vel</div><div style="color: var(--primary); font-weight: bold;">R$ ' + (lead.valores?.predio || 0).toLocaleString('pt-BR') + '</div></div>' : ''}
                                        ${lead.objetos.equipamentos ? '<div style="background: linear-gradient(135deg, rgba(8, 145, 178, 0.1), rgba(6, 182, 212, 0.1)); border: 1px solid #0891b2; border-radius: 10px; padding: 12px; text-align: center;"><div style="font-size: 1.5rem;">üñ•Ô∏è</div><div style="font-weight: 600; margin: 5px 0;">Equipamentos</div><div style="color: var(--primary); font-weight: bold;">R$ ' + (lead.valores?.equipamentos || 0).toLocaleString('pt-BR') + '</div></div>' : ''}
                                        ${lead.objetos.mercadorias ? '<div style="background: linear-gradient(135deg, rgba(8, 145, 178, 0.1), rgba(6, 182, 212, 0.1)); border: 1px solid #0891b2; border-radius: 10px; padding: 12px; text-align: center;"><div style="font-size: 1.5rem;">üì¶</div><div style="font-weight: 600; margin: 5px 0;">Mercadorias</div><div style="color: var(--primary); font-weight: bold;">R$ ' + (lead.valores?.mercadorias || 0).toLocaleString('pt-BR') + '</div></div>' : ''}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${lead.coberturas && lead.coberturas.length > 0 ? `
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                    <label style="display: block; margin-bottom: 15px; font-weight: 600; color: var(--text-secondary);">
                                        <i class="fas fa-shield-alt"></i> Coberturas Selecionadas
                                    </label>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px;">
                                        ${formatarCoberturasEmpresarial(lead.coberturas)}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Informa√ß√µes da Cota√ß√£o (se houver) -->
                        ${lead.valorCotacao || lead.valorPremio ? `
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-dollar-sign"></i> Informa√ß√µes Comerciais</h2>
                            </div>
                            <div class="card-body">
                                <div class="info-grid">
                                    ${lead.valorCotacao ? `
                                    <div class="info-item">
                                        <label>Valor da Cota√ß√£o</label>
                                        <span>R$ ${parseFloat(lead.valorCotacao).toLocaleString('pt-BR')}</span>
                                    </div>
                                    ` : ''}
                                    ${lead.seguradora ? `
                                    <div class="info-item">
                                        <label>Seguradora</label>
                                        <span>${lead.seguradora}</span>
                                    </div>
                                    ` : ''}
                                    ${lead.valorPremio ? `
                                    <div class="info-item">
                                        <label>Valor do Pr√™mio</label>
                                        <span style="color: var(--success);">R$ ${parseFloat(lead.valorPremio).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                                    </div>
                                    ` : ''}
                                    ${lead.comissao ? `
                                    <div class="info-item">
                                        <label>Comiss√£o</label>
                                        <span>${lead.comissao}%</span>
                                    </div>
                                    ` : ''}
                                    ${lead.valorPremio && lead.comissao ? `
                                    <div class="info-item">
                                        <label>Ganho Estimado</label>
                                        <span style="color: var(--success); font-weight: bold;">R$ ${(parseFloat(lead.valorPremio) * parseFloat(lead.comissao) / 100).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Dados do Site (se veio do site) -->
                        ${lead.dadosSite ? `
                        <div class="dados-site">
                            <h4><i class="fas fa-globe"></i> Dados do Question√°rio</h4>
                            ${formatarDadosSite(lead.dadosSite, lead.ramo)}
                        </div>
                        ` : ''}

                        <!-- Observa√ß√µes -->
                        ${lead.observacoes ? `
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-comment"></i> Observa√ß√µes</h2>
                            </div>
                            <div class="card-body">
                                <p style="white-space: pre-wrap;">${lead.observacoes}</p>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Notas -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-sticky-note"></i> Notas</h2>
                                <button class="btn btn-sm btn-primary" onclick="abrirModalNota()">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                            <div class="card-body">
                                ${notas.length === 0 ? `
                                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                                        Nenhuma nota adicionada
                                    </p>
                                ` : notas.map(nota => `
                                    <div style="background: var(--bg-light); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 10px;">
                                        <p style="margin-bottom: 10px;">${nota.texto}</p>
                                        <small style="color: var(--text-muted);">
                                            ${nota.criadoPor || 'Sistema'} - ${formatarDataHora(nota.criadoEm?.toDate())}
                                        </small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Coluna Lateral -->
                    <div>
                        <!-- Status Atual -->
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-info-circle"></i> Status Atual</h2>
                            </div>
                            <div class="card-body" style="text-align: center;">
                                <span class="status-badge ${status.classe}" style="font-size: 16px; padding: 10px 20px;">
                                    ${status.label}
                                </span>
                                <p style="margin-top: 15px; color: var(--text-muted); font-size: 13px;">
                                    Atualizado em: ${formatarDataHora(atualizadoEm)}
                                </p>
                            </div>
                        </div>

                        <!-- Hist√≥rico -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-history"></i> Hist√≥rico</h2>
                            </div>
                            <div class="card-body">
                                ${historico.length === 0 ? `
                                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                                        Nenhuma atividade registrada
                                    </p>
                                ` : `
                                    <div class="timeline timeline-extended">
                                        ${historico.map(item => `
                                            <div class="timeline-item">
                                                <div class="timeline-content">
                                                    <div class="timeline-date">${formatarDataHora(item.dataHora?.toDate())}</div>
                                                    <div class="timeline-text">${item.descricao || '-'}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Abrir modal de status
        function abrirModalStatus() {
            document.getElementById('novoStatus').value = leadAtual.status || 'pre_cadastro';
            toggleCamposExtras();
            document.getElementById('modalStatus').classList.add('active');
        }

        // Toggle campos extras
        function toggleCamposExtras() {
            const status = document.getElementById('novoStatus').value;
            document.getElementById('camposCotacao').style.display = status === 'cotacao_enviada' ? 'block' : 'none';
            document.getElementById('camposFechado').style.display = status === 'negocio_fechado' ? 'block' : 'none';
        }

        // Salvar novo status
        async function salvarNovoStatus() {
            const novoStatus = document.getElementById('novoStatus').value;
            const observacao = document.getElementById('observacaoStatus').value;
            
            let dadosExtras = {};
            
            if (novoStatus === 'cotacao_enviada') {
                dadosExtras.valorCotacao = document.getElementById('valorCotacao').value || null;
                dadosExtras.seguradora = document.getElementById('seguradoraCotacao').value || null;
            }
            
            if (novoStatus === 'negocio_fechado') {
                dadosExtras.valorPremio = document.getElementById('valorPremio').value || null;
                dadosExtras.comissao = document.getElementById('comissao').value || null;
                dadosExtras.dataInicioVigencia = document.getElementById('dataInicioVigencia').value || null;
                dadosExtras.dataFimVigencia = document.getElementById('dataFimVigencia').value || null;
                dadosExtras.numeroApolice = document.getElementById('numeroApolice').value || null;
            }
            
            try {
                const statusAntigo = leadAtual.status;
                
                await db.collection(COLECOES.leads).doc(leadId).update({
                    status: novoStatus,
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    ...dadosExtras
                });
                
                await db.collection(COLECOES.atividades).add({
                    tipo: 'status_alterado',
                    descricao: `${STATUS_PIPELINE[statusAntigo]?.label} ‚Üí ${STATUS_PIPELINE[novoStatus]?.label}${observacao ? ` | ${observacao}` : ''}`,
                    leadId: leadId,
                    statusAnterior: statusAntigo,
                    statusNovo: novoStatus,
                    usuarioEmail: usuarioAtual.email,
                    dataHora: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // CRIAR AP√ìLICE AUTOMATICAMENTE se neg√≥cio foi fechado
                if (novoStatus === 'negocio_fechado' && dadosExtras.valorPremio) {
                    try {
                        const apoliceData = {
                            leadId: leadId,
                            clienteId: leadId,
                            clienteNome: leadAtual.nome || '',
                            clienteEmail: leadAtual.email || '',
                            clienteWhatsapp: leadAtual.whatsapp || '',
                            ramo: leadAtual.ramo || 'auto',
                            seguradora: leadAtual.seguradora || dadosExtras.seguradora || '',
                            numeroApolice: dadosExtras.numeroApolice || `APO-${Date.now()}`,
                            valorPremio: parseFloat(dadosExtras.valorPremio) || 0,
                            comissao: parseFloat(dadosExtras.comissao) || 0,
                            valorComissao: (parseFloat(dadosExtras.valorPremio) * parseFloat(dadosExtras.comissao) / 100) || 0,
                            dataInicioVigencia: dadosExtras.dataInicioVigencia ? new Date(dadosExtras.dataInicioVigencia + 'T00:00:00') : null,
                            dataFimVigencia: dadosExtras.dataFimVigencia ? new Date(dadosExtras.dataFimVigencia + 'T00:00:00') : null,
                            status: 'ativa',
                            criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                            criadoPor: usuarioAtual.email,
                            observacoes: observacao || ''
                        };
                        
                        await db.collection('apolices_cliente').add(apoliceData);
                        console.log('Ap√≥lice criada automaticamente!');
                        mostrarToast('Ap√≥lice criada com sucesso!', 'success');
                    } catch (apoliceError) {
                        console.error('Erro ao criar ap√≥lice:', apoliceError);
                        mostrarToast('Status atualizado, mas erro ao criar ap√≥lice', 'warning');
                    }
                }
                
                mostrarToast('Status atualizado!', 'success');
                fecharModal('modalStatus');
                
                // Limpar campos
                document.getElementById('observacaoStatus').value = '';
                document.getElementById('valorCotacao').value = '';
                document.getElementById('valorPremio').value = '';
                document.getElementById('comissao').value = '';
                document.getElementById('dataInicioVigencia').value = '';
                document.getElementById('dataFimVigencia').value = '';
                document.getElementById('numeroApolice').value = '';
                
                await carregarLead();
                
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                mostrarToast('Erro ao atualizar status', 'error');
            }
        }

        // Abrir modal de edi√ß√£o
        function abrirModalEditar() {
            document.getElementById('editNome').value = leadAtual.nome || '';
            document.getElementById('editEmail').value = leadAtual.email || '';
            document.getElementById('editWhatsapp').value = leadAtual.whatsapp || '';
            document.getElementById('editCpf').value = leadAtual.cpf || '';
            document.getElementById('editNascimento').value = leadAtual.dataNascimento || '';
            document.getElementById('editCep').value = leadAtual.cep || '';
            document.getElementById('editCidade').value = leadAtual.cidade || '';
            document.getElementById('editEstado').value = leadAtual.estado || '';
            document.getElementById('editRamo').value = leadAtual.ramo || '';
            document.getElementById('editResponsavel').value = leadAtual.responsavelId || '';
            document.getElementById('editObservacoes').value = leadAtual.observacoes || '';
            
            document.getElementById('modalEditar').classList.add('active');
        }

        // Salvar edi√ß√£o
        async function salvarEdicao() {
            const nome = document.getElementById('editNome').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const whatsapp = document.getElementById('editWhatsapp').value.trim();
            const cpf = document.getElementById('editCpf').value.trim();
            const nascimento = document.getElementById('editNascimento').value;
            const cep = document.getElementById('editCep').value.trim();
            const cidade = document.getElementById('editCidade').value.trim();
            const estado = document.getElementById('editEstado').value.trim();
            const ramo = document.getElementById('editRamo').value;
            const responsavelId = document.getElementById('editResponsavel').value;
            const observacoes = document.getElementById('editObservacoes').value.trim();
            
            if (!nome || !whatsapp || !ramo) {
                mostrarToast('Preencha os campos obrigat√≥rios', 'error');
                return;
            }
            
            try {
                let responsavelNome = 'N√£o atribu√≠do';
                if (responsavelId) {
                    const respDoc = await db.collection(COLECOES.funcionarios).doc(responsavelId).get();
                    if (respDoc.exists) {
                        responsavelNome = respDoc.data().nome || respDoc.data().email;
                    }
                }
                
                await db.collection(COLECOES.leads).doc(leadId).update({
                    nome,
                    email,
                    whatsapp,
                    cpf,
                    dataNascimento: nascimento || null,
                    cep,
                    cidade,
                    estado,
                    ramo,
                    responsavelId: responsavelId || null,
                    responsavelNome,
                    observacoes,
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection(COLECOES.atividades).add({
                    tipo: 'lead_editado',
                    descricao: `Lead atualizado por ${usuarioAtual.email}`,
                    leadId: leadId,
                    usuarioEmail: usuarioAtual.email,
                    dataHora: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                mostrarToast('Lead atualizado!', 'success');
                fecharModal('modalEditar');
                await carregarLead();
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                mostrarToast('Erro ao salvar', 'error');
            }
        }

        // Abrir modal de nota
        function abrirModalNota() {
            document.getElementById('novaNota').value = '';
            document.getElementById('modalNota').classList.add('active');
        }

        // Salvar nota
        async function salvarNota() {
            const texto = document.getElementById('novaNota').value.trim();
            
            if (!texto) {
                mostrarToast('Digite uma nota', 'error');
                return;
            }
            
            try {
                await db.collection(COLECOES.notas).add({
                    leadId: leadId,
                    texto,
                    criadoPor: usuarioAtual.email,
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                mostrarToast('Nota adicionada!', 'success');
                fecharModal('modalNota');
                await carregarLead();
                
            } catch (error) {
                console.error('Erro ao salvar nota:', error);
                mostrarToast('Erro ao salvar nota', 'error');
            }
        }

        // Buscar CEP
        async function buscarCepEdit() {
            const cep = document.getElementById('editCep').value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                
                if (!data.erro) {
                    document.getElementById('editCidade').value = data.localidade || '';
                    document.getElementById('editEstado').value = data.uf || '';
                }
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
            }
        }

        // Utilit√°rios
        function formatarData(data) {
            if (!data) return '-';
            return data.toLocaleDateString('pt-BR');
        }
        
        function formatarDataNascimento(dataStr) {
            if (!dataStr || dataStr === '-') return '-';
            // Se vier no formato YYYY-MM-DD, converte para DD/MM/YYYY
            if (typeof dataStr === 'string' && dataStr.includes('-')) {
                const partes = dataStr.split('-');
                if (partes.length === 3) {
                    return `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
            }
            return dataStr;
        }

        function formatarDataHora(data) {
            if (!data) return '-';
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatarCNPJ(cnpj) {
            if (!cnpj) return '-';
            const nums = cnpj.toString().replace(/\D/g, '');
            if (nums.length !== 14) return cnpj;
            return nums.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        }

        // Formatar coberturas de Seguro de Vida Empresarial
        function formatarCoberturasVida(coberturas) {
            if (!coberturas || !coberturas.length) return '';
            
            const nomes = {
                morte: '‚ö±Ô∏è Morte',
                morteAcidental: '‚ö° Morte Acidental',
                ipa: 'ü¶Ω Invalidez por Acidente',
                ifpd: 'üè• Invalidez por Doen√ßa',
                doencasGraves: 'ü´Ä Doen√ßas Graves',
                dmho: 'üè® Despesas M√©dicas (DMHO)',
                rescisao: 'üìÑ Rescis√£o Trabalhista',
                assistenciaFuneral: 'üåπ Assist√™ncia Funeral',
                auxilioFuneral: 'üíê Aux√≠lio Funeral'
            };
            
            return coberturas.map(c => {
                const nomeCob = nomes[c.nome] || c.nome;
                const capital = c.capital ? 'R$ ' + c.capital.toLocaleString('pt-BR') : '-';
                return '<div style="background: var(--bg-light); padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">' +
                    '<span style="font-size: 0.85rem;">' + nomeCob + '</span>' +
                    '<span style="font-weight: bold; color: var(--primary);">' + capital + '</span>' +
                '</div>';
            }).join('');
        }

        // Formatar faixas et√°rias de Seguro de Vida Empresarial
        function formatarFaixasVida(faixasEtarias) {
            if (!faixasEtarias) return '';
            
            // Verificar se h√° dados reais
            const temSocios = faixasEtarias.socios && Object.values(faixasEtarias.socios).some(v => v > 0);
            const temFuncionarios = faixasEtarias.funcionarios && Object.values(faixasEtarias.funcionarios).some(v => v > 0);
            
            if (!temSocios && !temFuncionarios) return '';
            
            let html = '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">';
            html += '<label style="display: block; margin-bottom: 15px; font-weight: 600; color: var(--text-secondary);"><i class="fas fa-users"></i> Distribui√ß√£o por Faixa Et√°ria</label>';
            
            const faixas = ['18-29', '30-39', '40-49', '50-59', '60-65'];
            
            // S√≥cios
            if (temSocios) {
                html += '<div style="margin-bottom: 15px;">';
                html += '<span style="font-size: 0.8rem; color: #f59e0b; font-weight: 600;">üëî S√≥cios/Diretores</span>';
                html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 8px;">';
                faixas.forEach(faixa => {
                    html += '<div style="text-align: center; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">';
                    html += '<div style="font-size: 0.65rem; color: var(--text-muted);">' + faixa + '</div>';
                    html += '<div style="font-weight: bold;">' + (faixasEtarias.socios[faixa] || 0) + '</div>';
                    html += '</div>';
                });
                html += '</div></div>';
            }
            
            // Funcion√°rios
            if (temFuncionarios) {
                html += '<div>';
                html += '<span style="font-size: 0.8rem; color: #3b82f6; font-weight: 600;">üë∑ Funcion√°rios</span>';
                html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 8px;">';
                faixas.forEach(faixa => {
                    html += '<div style="text-align: center; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 6px;">';
                    html += '<div style="font-size: 0.65rem; color: var(--text-muted);">' + faixa + '</div>';
                    html += '<div style="font-weight: bold;">' + (faixasEtarias.funcionarios[faixa] || 0) + '</div>';
                    html += '</div>';
                });
                html += '</div></div>';
            }
            
            html += '</div>';
            return html;
        }

        // Formatar tipo de estabelecimento
        function formatarTipoEstabelecimento(tipo) {
            const tipos = {
                'escritorio': 'üèõÔ∏è Escrit√≥rio',
                'consultorio': 'üè• Consult√≥rio',
                'comercial': 'üõí Com√©rcio',
                'industrial': 'üè≠ Ind√∫stria'
            };
            return tipos[tipo] || tipo || '-';
        }

        // Formatar coberturas de Seguro Empresarial
        function formatarCoberturasEmpresarial(coberturas) {
            if (!coberturas || !coberturas.length) return '';
            
            const nomes = {
                basica: 'üî• B√°sica (Inc√™ndio)',
                vendaval: 'üå™Ô∏è Vendaval/Granizo',
                danosEletricos: '‚ö° Danos El√©tricos',
                roubo: 'üîì Roubo/Furto',
                vidros: 'ü™ü Quebra de Vidros',
                alagamento: 'üåä Alagamento',
                rcEmpregador: 'üë∑ RC Empregador',
                rcEstabelecimento: 'üè™ RC Estabelecimento',
                perdaAluguel: 'üè† Perda de Aluguel',
                lucrosCessantes: 'üìâ Lucros Cessantes',
                equipamentosPortateis: 'üì± Equip. Port√°teis',
                fidelidade: 'ü§ù Fidelidade'
            };
            
            return coberturas.map(function(c) {
                const nomeCob = nomes[c.nome] || c.nome;
                const valor = c.valor ? 'R$ ' + c.valor.toLocaleString('pt-BR') : 'A definir';
                return '<div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border: 1px solid #10b981; border-radius: 10px; padding: 12px;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                    '<span style="font-size: 0.85rem; font-weight: 500;">' + nomeCob + '</span>' +
                    '<span style="font-weight: bold; color: #10b981;">' + valor + '</span>' +
                    '</div></div>';
            }).join('');
        }

        // Formatar colaboradores de Seguro de Vida Empresarial (com idades individuais)
        function formatarColaboradoresVida(colaboradores) {
            if (!colaboradores || !colaboradores.length) return '';
            
            // Separar s√≥cios e funcion√°rios
            const socios = colaboradores.filter(c => c.tipo === 'socio').sort((a, b) => a.idade - b.idade);
            const funcionarios = colaboradores.filter(c => c.tipo === 'funcionario').sort((a, b) => a.idade - b.idade);
            
            let html = '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">';
            html += '<label style="display: block; margin-bottom: 15px; font-weight: 600; color: var(--text-secondary);"><i class="fas fa-users"></i> Colaboradores por Idade</label>';
            
            // S√≥cios
            if (socios.length > 0) {
                html += '<div style="margin-bottom: 15px;">';
                html += '<span style="font-size: 0.85rem; color: #f59e0b; font-weight: 600; display: block; margin-bottom: 8px;">üëî S√≥cios/Diretores (' + socios.length + ')</span>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
                socios.forEach(function(c) {
                    html += '<span style="background: rgba(245, 158, 11, 0.15); color: #b45309; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500;">';
                    html += c.nome ? c.nome + ' - ' : '';
                    html += '<strong>' + c.idade + ' anos</strong></span>';
                });
                html += '</div></div>';
            }
            
            // Funcion√°rios
            if (funcionarios.length > 0) {
                html += '<div>';
                html += '<span style="font-size: 0.85rem; color: #3b82f6; font-weight: 600; display: block; margin-bottom: 8px;">üë∑ Funcion√°rios (' + funcionarios.length + ')</span>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
                funcionarios.forEach(function(c) {
                    html += '<span style="background: rgba(59, 130, 246, 0.15); color: #1d4ed8; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500;">';
                    html += c.nome ? c.nome + ' - ' : '';
                    html += '<strong>' + c.idade + ' anos</strong></span>';
                });
                html += '</div></div>';
            }
            
            html += '</div>';
            return html;
        }

        // Formatar dados do site de forma amig√°vel
        function formatarDadosSite(dados, ramo) {
            if (!dados) return '';
            
            let html = '<div class="dados-site-formatados">';
            let formatoReconhecido = false;
            
            // Auto
            if (ramo === 'auto' && dados.veiculo) {
                formatoReconhecido = true;
                html += `
                    <div class="dados-grupo">
                        <h5>üöó Ve√≠culo</h5>
                        <div class="dados-grid">
                            <div class="dado-item"><span class="dado-label">Marca:</span> <span class="dado-valor">${dados.veiculo.marca || '-'}</span></div>
                            <div class="dado-item"><span class="dado-label">Modelo:</span> <span class="dado-valor">${dados.veiculo.modelo || '-'}</span></div>
                            <div class="dado-item"><span class="dado-label">Ano:</span> <span class="dado-valor">${dados.veiculo.ano || '-'}</span></div>
                            <div class="dado-item"><span class="dado-label">Valor FIPE:</span> <span class="dado-valor">${dados.veiculo.valorFipe ? 'R$ ' + dados.veiculo.valorFipe.toLocaleString('pt-BR') : '-'}</span></div>
                        </div>
                    </div>
                `;
                if (dados.perfil) {
                    html += `
                        <div class="dados-grupo">
                            <h5>üë§ Perfil do Condutor</h5>
                            <div class="dados-grid">
                                <div class="dado-item"><span class="dado-label">Condutor:</span> <span class="dado-valor">${dados.perfil.condutor || '-'}</span></div>
                                <div class="dado-item"><span class="dado-label">Idade:</span> <span class="dado-valor">${dados.perfil.idade || '-'}</span></div>
                                <div class="dado-item"><span class="dado-label">Garagem:</span> <span class="dado-valor">${dados.perfil.garagem || '-'}</span></div>
                                <div class="dado-item"><span class="dado-label">B√¥nus:</span> <span class="dado-valor">${dados.perfil.bonus || '-'}</span></div>
                                <div class="dado-item"><span class="dado-label">Sinistro:</span> <span class="dado-valor">${dados.perfil.sinistro || '-'}</span></div>
                            </div>
                        </div>
                    `;
                }
                if (dados.coberturas) {
                    html += `
                        <div class="dados-grupo">
                            <h5>üõ°Ô∏è Coberturas</h5>
                            <div class="dados-grid">
                                <div class="dado-item"><span class="dado-label">Reboque:</span> <span class="dado-valor">${dados.coberturas.reboque || '-'}</span></div>
                                <div class="dado-item"><span class="dado-label">Terceiros:</span> <span class="dado-valor">${dados.coberturas.terceiros || '-'}</span></div>
                                <div class="dado-item"><span class="dado-label">Carro Reserva:</span> <span class="dado-valor">${dados.coberturas.reserva || '-'}</span></div>
                                <div class="dado-item"><span class="dado-label">Franquia:</span> <span class="dado-valor">${dados.coberturas.franquia || '-'}</span></div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Vida
            else if (ramo === 'vida') {
                formatoReconhecido = true;
                html += `
                    <div class="dados-grupo">
                        <h5>‚ù§Ô∏è Dados do Seguro de Vida</h5>
                        <div class="dados-grid">
                            <div class="dado-item"><span class="dado-label">Nome:</span> <span class="dado-valor">${dados.nome || '-'}</span></div>
                            <div class="dado-item"><span class="dado-label">Idade:</span> <span class="dado-valor">${dados.idade || '-'} anos</span></div>
                            <div class="dado-item"><span class="dado-label">Sexo:</span> <span class="dado-valor">${dados.sexo === 'M' ? 'Masculino' : dados.sexo === 'F' ? 'Feminino' : dados.sexo || '-'}</span></div>
                            <div class="dado-item"><span class="dado-label">Ocupa√ß√£o:</span> <span class="dado-valor">${dados.ocupacao || '-'}</span></div>
                            <div class="dado-item"><span class="dado-label">Renda:</span> <span class="dado-valor">${dados.renda ? 'R$ ' + dados.renda.toLocaleString('pt-BR') : '-'}</span></div>
                            <div class="dado-item"><span class="dado-label">Capital Segurado:</span> <span class="dado-valor">${dados.capital ? 'R$ ' + dados.capital.toLocaleString('pt-BR') : '-'}</span></div>
                        </div>
                    </div>
                `;
                if (dados.coberturas && Array.isArray(dados.coberturas)) {
                    html += `
                        <div class="dados-grupo">
                            <h5>üõ°Ô∏è Coberturas Selecionadas</h5>
                            <div class="dados-lista">
                                ${dados.coberturas.map(c => `<span class="cobertura-tag">${c.nome || c}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Residencial
            else if (ramo === 'residencial') {
                formatoReconhecido = true;
                const tipoImovelTexto = { 'casa': 'Casa', 'apartamento': 'Apartamento', 'sobrado': 'Sobrado', 'kitnet': 'Kitnet/Studio' };
                html += `
                    <div class="dados-grupo">
                        <h5>üè† Dados do Im√≥vel</h5>
                        <div class="dados-grid">
                            <div class="dado-item"><span class="dado-label">Tipo:</span> <span class="dado-valor">${tipoImovelTexto[dados.tipoImovel] || dados.tipoImovel || '-'}</span></div>
                            <div class="dado-item"><span class="dado-label">Uso:</span> <span class="dado-valor">${dados.usoImovel || '-'}</span></div>
                            <div class="dado-item"><span class="dado-label">Metragem:</span> <span class="dado-valor">${dados.metros || '-'} m¬≤</span></div>
                            <div class="dado-item"><span class="dado-label">Valor Im√≥vel:</span> <span class="dado-valor">${dados.valorImovel ? 'R$ ' + dados.valorImovel.toLocaleString('pt-BR') : '-'}</span></div>
                            <div class="dado-item"><span class="dado-label">Valor Conte√∫do:</span> <span class="dado-valor">${dados.valorConteudo ? 'R$ ' + dados.valorConteudo.toLocaleString('pt-BR') : '-'}</span></div>
                        </div>
                    </div>
                `;
                if (dados.coberturas) {
                    const coberturasList = [];
                    Object.entries(dados.coberturas).forEach(([nome, info]) => {
                        if (info && info.ativo) {
                            const nomeFormatado = nome.charAt(0).toUpperCase() + nome.slice(1);
                            coberturasList.push(`${nomeFormatado}: R$ ${info.valor?.toLocaleString('pt-BR') || '-'}`);
                        }
                    });
                    if (coberturasList.length > 0) {
                        html += `
                            <div class="dados-grupo">
                                <h5>üõ°Ô∏è Coberturas Selecionadas</h5>
                                <div class="dados-lista">
                                    ${coberturasList.map(c => `<span class="cobertura-tag">${c}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    }
                }
                if (dados.itens && dados.itens.length > 0) {
                    html += `
                        <div class="dados-grupo">
                            <h5>üì¶ Itens Especiais</h5>
                            <div class="dados-lista">
                                ${dados.itens.map(item => `<span class="cobertura-tag">${item}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            // FALLBACK: Se n√£o reconheceu o formato, mostra dados de forma gen√©rica
            if (!formatoReconhecido) {
                html += `<div class="dados-grupo"><h5>üìã Dados do Question√°rio</h5><div class="dados-grid">`;
                
                // Lista de campos a ignorar (s√£o metadados)
                const ignorar = ['ultimaAtualizacao', 'dataFinalizacao', 'dataCriacao', 'nanoseconds', 'seconds'];
                
                // Formatar cada campo de forma amig√°vel
                Object.entries(dados).forEach(([key, value]) => {
                    if (ignorar.some(i => key.includes(i))) return;
                    if (value === null || value === undefined) return;
                    if (typeof value === 'object' && value.seconds) return; // Timestamp
                    
                    // Formatar nome do campo
                    const nomeFormatado = key
                        .replace(/([A-Z])/g, ' $1')
                        .replace(/^./, str => str.toUpperCase())
                        .replace('_', ' ');
                    
                    // Formatar valor
                    let valorFormatado;
                    if (typeof value === 'object' && !Array.isArray(value)) {
                        // Objeto - n√£o mostrar
                        return;
                    } else if (Array.isArray(value)) {
                        valorFormatado = value.join(', ');
                    } else if (typeof value === 'number' && value > 1000) {
                        valorFormatado = 'R$ ' + value.toLocaleString('pt-BR');
                    } else {
                        valorFormatado = String(value);
                    }
                    
                    if (valorFormatado) {
                        html += `<div class="dado-item"><span class="dado-label">${nomeFormatado}:</span> <span class="dado-valor">${valorFormatado}</span></div>`;
                    }
                });
                
                html += `</div></div>`;
            }
            
            // Valor Estimado (comum a todos)
            if (dados.valorEstimado) {
                html += `
                    <div class="dados-grupo">
                        <h5>üí∞ Valor Estimado pelo Sistema</h5>
                        <div class="dados-grid">
                            <div class="dado-item"><span class="dado-label">M√≠nimo:</span> <span class="dado-valor" style="color: #10b981; font-weight: 700;">R$ ${dados.valorEstimado.min?.toLocaleString('pt-BR') || '-'}</span></div>
                            <div class="dado-item"><span class="dado-label">M√°ximo:</span> <span class="dado-valor" style="color: #10b981; font-weight: 700;">R$ ${dados.valorEstimado.max?.toLocaleString('pt-BR') || '-'}</span></div>
                        </div>
                    </div>
                `;
            }
            
            // Status e origem
            html += `
                <div class="dados-grupo">
                    <h5>üìä Informa√ß√µes do Formul√°rio</h5>
                    <div class="dados-grid">
                        <div class="dado-item"><span class="dado-label">Status:</span> <span class="dado-valor">${dados.status || '-'}</span></div>
                        <div class="dado-item"><span class="dado-label">Origem:</span> <span class="dado-valor">${dados.origem || '-'}</span></div>
                        ${dados.ultimoStep ? `<div class="dado-item"><span class="dado-label">√öltima Etapa:</span> <span class="dado-valor">${dados.ultimoStep}</span></div>` : ''}
                    </div>
                </div>
            `;
            
            html += '</div>';
            return html;
        }

        // Excluir lead
        async function confirmarExclusao() {
            const confirmar = confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nTem certeza que deseja EXCLUIR este lead permanentemente?\n\nEsta a√ß√£o n√£o pode ser desfeita!');
            
            if (!confirmar) return;
            
            // Segunda confirma√ß√£o
            const confirmar2 = confirm('√öltima chance!\n\nDigite OK para confirmar a exclus√£o.');
            
            if (!confirmar2) return;
            
            try {
                await db.collection('leads_crm').doc(leadId).delete();
                
                alert('‚úÖ Lead exclu√≠do com sucesso!');
                window.location.href = 'leads.html';
            } catch (error) {
                console.error('Erro ao excluir:', error);
                alert('‚ùå Erro ao excluir lead: ' + error.message);
            }
        }

        function abrirWhatsApp(numero) {
            if (!numero) return;
            const limpo = numero.replace(/\D/g, '');
            window.open(`https://wa.me/55${limpo}`, '_blank');
        }

        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function mostrarToast(mensagem, tipo = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'times-circle' : 'info-circle'}"></i>
                <span>${mensagem}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // Fechar modal ao clicar fora
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
