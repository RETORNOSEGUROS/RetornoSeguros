<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - Retorno Seguros CRM</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .badge-count.badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .text-muted {
            color: var(--text-muted, #6b7280);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../img/logo-retorno.png" alt="Retorno Seguros" onerror="this.style.display='none'">
            <h2>CRM Seguros</h2>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <span class="nav-section-title">Principal</span>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="leads.html" class="nav-item">
                    <i class="fas fa-funnel-dollar"></i>
                    <span>Leads / Pipeline</span>
                    <span class="nav-badge" id="leadsNovos">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Gestão</span>
                <a href="clientes.html" class="nav-item active">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
                <a href="apolices.html" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Apólices</span>
                </a>
                <a href="indicacoes.html" class="nav-item">
                    <i class="fas fa-gift"></i>
                    <span>Indicações</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Equipe</span>
                <a href="funcionarios.html" class="nav-item">
                    <i class="fas fa-user-tie"></i>
                    <span>Funcionários</span>
                </a>
                <a href="relatorios.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relatórios</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Sistema</span>
                <a href="configuracoes.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span id="userEmail">admin@retorno.com</span>
            </div>
            <button class="btn-logout" onclick="fazerLogout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </aside>

    <!-- Mobile Toggle -->
    <button class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <main class="main-content">
        <header class="page-header">
            <div class="header-left">
                <h1><i class="fas fa-users"></i> Clientes</h1>
                <p>Base de clientes da corretora</p>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="campoBusca" placeholder="Buscar cliente..." onkeyup="filtrarClientes()">
                </div>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--primary);">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="statTotal">0</span>
                    <span class="stat-label">Total de Clientes</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--success);">
                    <i class="fas fa-file-contract"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="statComApolice">0</span>
                    <span class="stat-label">Com Apólice Ativa</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--warning);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="statRenovacao">0</span>
                    <span class="stat-label">Renovação em 30 dias</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--info);">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="statNovosMes">0</span>
                    <span class="stat-label">Novos este Mês</span>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card">
            <div class="card-body">
                <div class="filters-row">
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filtroStatus" onchange="filtrarClientes()">
                            <option value="todos">Todos</option>
                            <option value="com_apolice">Com Apólice Ativa</option>
                            <option value="sem_apolice">Sem Apólice</option>
                            <option value="renovacao">Renovação Próxima</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Ramo Principal</label>
                        <select id="filtroRamo" onchange="filtrarClientes()">
                            <option value="todos">Todos</option>
                            <option value="auto">Auto</option>
                            <option value="residencial">Residencial</option>
                            <option value="vida">Vida</option>
                            <option value="empresarial">Empresarial</option>
                            <option value="saude">Saúde</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Ordenar por</label>
                        <select id="ordenacao" onchange="filtrarClientes()">
                            <option value="nome">Nome A-Z</option>
                            <option value="nome_desc">Nome Z-A</option>
                            <option value="recente">Mais Recente</option>
                            <option value="antigo">Mais Antigo</option>
                            <option value="apolices">Mais Apólices</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="limparFiltros()">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabela de Clientes -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-list"></i> Lista de Clientes</h3>
                <span class="card-subtitle" id="contadorResultados">0 clientes</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Contato</th>
                                <th>Cidade/UF</th>
                                <th>Cotações</th>
                                <th>Apólices</th>
                                <th>Próx. Renovação</th>
                                <th>Valor Total</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaClientes">
                            <tr>
                                <td colspan="8" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Detalhes do Cliente -->
    <div class="modal-overlay" id="modalCliente">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3><i class="fas fa-user"></i> <span id="modalClienteNome">Cliente</span></h3>
                <button class="modal-close" onclick="fecharModal('modalCliente')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Dados Pessoais -->
                <div class="detail-section">
                    <h4><i class="fas fa-id-card"></i> Dados Pessoais</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Nome Completo</label>
                            <span id="detalheNome">-</span>
                        </div>
                        <div class="detail-item">
                            <label>CPF</label>
                            <span id="detalheCPF">-</span>
                        </div>
                        <div class="detail-item">
                            <label>Data de Nascimento</label>
                            <span id="detalheNascimento">-</span>
                        </div>
                        <div class="detail-item">
                            <label>E-mail</label>
                            <span id="detalheEmail">-</span>
                        </div>
                        <div class="detail-item">
                            <label>WhatsApp</label>
                            <span id="detalheWhatsapp">-</span>
                        </div>
                        <div class="detail-item">
                            <label>Endereço</label>
                            <span id="detalheEndereco">-</span>
                        </div>
                    </div>
                </div>

                <!-- Apólices -->
                <div class="detail-section">
                    <h4><i class="fas fa-file-contract"></i> Apólices</h4>
                    <div class="table-responsive">
                        <table class="data-table" id="tabelaApolicesCliente">
                            <thead>
                                <tr>
                                    <th>Ramo</th>
                                    <th>Seguradora</th>
                                    <th>Número</th>
                                    <th>Vigência</th>
                                    <th>Prêmio</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="bodyApolicesCliente">
                                <tr><td colspan="6" class="text-center">Nenhuma apólice</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Histórico de Cotações -->
                <div class="detail-section">
                    <h4><i class="fas fa-funnel-dollar"></i> Cotações / Leads</h4>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Ramo</th>
                                    <th>Status</th>
                                    <th>Valor</th>
                                    <th>Ver</th>
                                </tr>
                            </thead>
                            <tbody id="bodyLeadsCliente">
                                <tr><td colspan="5" class="text-center">Nenhuma cotação</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" id="btnWhatsappCliente" class="btn btn-success" target="_blank">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </a>
                <button type="button" class="btn btn-secondary" onclick="fecharModal('modalCliente')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:a59dc2c9edff29a66f5b2f"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variáveis globais
        let clientes = [];
        let clientesFiltrados = [];
        let apolices = [];
        let leads = [];

        // Verificar autenticação
        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            document.getElementById('userEmail').textContent = user.email;
            await carregarDados();
        });

        // Carregar dados
        async function carregarDados() {
            try {
                // Carregar leads do CRM como clientes
                const snapLeads = await db.collection('leads_crm').orderBy('nome').get();
                leads = [];
                snapLeads.forEach(doc => {
                    leads.push({ id: doc.id, ...doc.data() });
                });

                // Carregar apólices
                const snapApolices = await db.collection('apolices_cliente').get();
                apolices = [];
                snapApolices.forEach(doc => {
                    apolices.push({ id: doc.id, ...doc.data() });
                });

                // Badge leads novos (pré-cadastro)
                const leadsNovos = leads.filter(l => l.status === 'pre_cadastro').length;
                const badge = document.getElementById('leadsNovos');
                if (badge) {
                    if (leadsNovos > 0) {
                        badge.textContent = leadsNovos;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                // =============================================
                // AGRUPAR CLIENTES PELO CPF (OU NOME+TELEFONE)
                // =============================================
                const clientesAgrupados = {};
                const hoje = new Date();

                leads.filter(lead => lead.nome || lead.whatsapp).forEach(lead => {
                    // Criar chave única: CPF (prioridade) ou nome+telefone normalizado
                    const cpfLimpo = lead.cpf ? lead.cpf.replace(/\D/g, '') : '';
                    const telLimpo = (lead.whatsapp || lead.telefone || '').replace(/\D/g, '');
                    const nomeLimpo = (lead.nome || '').toLowerCase().trim();
                    
                    // Chave de agrupamento: CPF se tiver, senão nome+telefone
                    let chave = cpfLimpo || `${nomeLimpo}_${telLimpo}`;
                    
                    // Se não tem CPF nem telefone, usar nome + email
                    if (!cpfLimpo && !telLimpo) {
                        const emailLimpo = (lead.email || '').toLowerCase().trim();
                        chave = `${nomeLimpo}_${emailLimpo}`;
                    }

                    if (!clientesAgrupados[chave]) {
                        clientesAgrupados[chave] = {
                            chave,
                            leads: [],
                            apolicesCliente: [],
                            nome: lead.nome,
                            email: lead.email,
                            whatsapp: lead.whatsapp || lead.telefone,
                            cpf: lead.cpf,
                            cidade: lead.cidade,
                            estado: lead.estado,
                            cep: lead.cep,
                            dataNascimento: lead.dataNascimento,
                            criadoEm: lead.criadoEm,
                            ramos: new Set()
                        };
                    }

                    const grupo = clientesAgrupados[chave];
                    
                    // Adicionar este lead ao grupo
                    grupo.leads.push(lead);
                    
                    // Atualizar informações com dados mais completos
                    if (!grupo.nome && lead.nome) grupo.nome = lead.nome;
                    if (!grupo.email && lead.email) grupo.email = lead.email;
                    if (!grupo.whatsapp && (lead.whatsapp || lead.telefone)) grupo.whatsapp = lead.whatsapp || lead.telefone;
                    if (!grupo.cpf && lead.cpf) grupo.cpf = lead.cpf;
                    if (!grupo.cidade && lead.cidade) grupo.cidade = lead.cidade;
                    if (!grupo.estado && lead.estado) grupo.estado = lead.estado;
                    if (!grupo.dataNascimento && lead.dataNascimento) grupo.dataNascimento = lead.dataNascimento;
                    
                    // Manter data mais antiga como criadoEm
                    if (lead.criadoEm) {
                        const dataLead = lead.criadoEm.toDate ? lead.criadoEm.toDate() : new Date(lead.criadoEm);
                        const dataGrupo = grupo.criadoEm?.toDate ? grupo.criadoEm.toDate() : new Date(grupo.criadoEm || Date.now());
                        if (dataLead < dataGrupo) {
                            grupo.criadoEm = lead.criadoEm;
                        }
                    }
                    
                    // Adicionar ramo
                    if (lead.ramo) grupo.ramos.add(lead.ramo);

                    // Buscar apólices deste lead
                    const apolicesLead = apolices.filter(a => 
                        a.leadId === lead.id || 
                        a.clienteId === lead.id ||
                        (a.email && a.email === lead.email) ||
                        (a.clienteNome && a.clienteNome === lead.nome)
                    );
                    
                    apolicesLead.forEach(apolice => {
                        // Evitar duplicatas
                        if (!grupo.apolicesCliente.find(a => a.id === apolice.id)) {
                            grupo.apolicesCliente.push(apolice);
                        }
                    });
                });

                // Transformar grupos em array de clientes
                clientes = Object.values(clientesAgrupados).map(grupo => {
                    const apolicesAtivas = grupo.apolicesCliente.filter(a => {
                        if (!a.dataFimVigencia) return false;
                        const fim = a.dataFimVigencia.toDate ? a.dataFimVigencia.toDate() : new Date(a.dataFimVigencia);
                        return fim >= hoje;
                    });

                    const proximaRenovacao = apolicesAtivas
                        .map(a => a.dataFimVigencia?.toDate ? a.dataFimVigencia.toDate() : new Date(a.dataFimVigencia))
                        .filter(d => d >= hoje)
                        .sort((a, b) => a - b)[0];

                    const valorTotal = apolicesAtivas.reduce((sum, a) => sum + (parseFloat(a.valorPremio) || 0), 0);

                    // Converter Set de ramos para array
                    const ramosArray = Array.from(grupo.ramos);

                    return {
                        id: grupo.leads[0].id, // ID do primeiro lead para navegação
                        chave: grupo.chave,
                        nome: grupo.nome || '-',
                        email: grupo.email || '-',
                        whatsapp: grupo.whatsapp || '-',
                        cpf: grupo.cpf || '',
                        cidade: grupo.cidade || '-',
                        estado: grupo.estado || '-',
                        cep: grupo.cep,
                        dataNascimento: grupo.dataNascimento,
                        criadoEm: grupo.criadoEm,
                        leadsCliente: grupo.leads, // Todos os leads deste cliente
                        apolicesCliente: grupo.apolicesCliente,
                        qtdApolices: apolicesAtivas.length,
                        qtdCotacoes: grupo.leads.length, // Quantidade de cotações
                        proximaRenovacao,
                        valorTotal,
                        ramoPrincipal: ramosArray[0] || '-',
                        ramos: ramosArray
                    };
                });

                console.log(`Total de leads: ${leads.length}, Clientes únicos: ${clientes.length}`);

                atualizarEstatisticas();
                filtrarClientes();

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                mostrarToast('Erro ao carregar dados', 'error');
            }
        }

        // Atualizar estatísticas
        function atualizarEstatisticas() {
            const hoje = new Date();
            const em30dias = new Date();
            em30dias.setDate(em30dias.getDate() + 30);
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);

            const comApolice = clientes.filter(c => c.qtdApolices > 0).length;
            
            const renovacao = clientes.filter(c => {
                if (!c.proximaRenovacao) return false;
                return c.proximaRenovacao >= hoje && c.proximaRenovacao <= em30dias;
            }).length;

            const novosMes = clientes.filter(c => {
                if (!c.criadoEm) return false;
                const data = c.criadoEm.toDate ? c.criadoEm.toDate() : new Date(c.criadoEm);
                return data >= inicioMes;
            }).length;

            document.getElementById('statTotal').textContent = clientes.length;
            document.getElementById('statComApolice').textContent = comApolice;
            document.getElementById('statRenovacao').textContent = renovacao;
            document.getElementById('statNovosMes').textContent = novosMes;
        }

        // Filtrar clientes
        function filtrarClientes() {
            const busca = document.getElementById('campoBusca').value.toLowerCase();
            const status = document.getElementById('filtroStatus').value;
            const ramo = document.getElementById('filtroRamo').value;
            const ordenacao = document.getElementById('ordenacao').value;

            const hoje = new Date();
            const em30dias = new Date();
            em30dias.setDate(em30dias.getDate() + 30);

            clientesFiltrados = clientes.filter(c => {
                // Busca textual
                if (busca) {
                    const texto = `${c.nome} ${c.email} ${c.whatsapp} ${c.cpf} ${c.cidade}`.toLowerCase();
                    if (!texto.includes(busca)) return false;
                }

                // Status
                if (status === 'com_apolice' && c.qtdApolices === 0) return false;
                if (status === 'sem_apolice' && c.qtdApolices > 0) return false;
                if (status === 'renovacao') {
                    if (!c.proximaRenovacao) return false;
                    if (c.proximaRenovacao < hoje || c.proximaRenovacao > em30dias) return false;
                }

                // Ramo
                if (ramo !== 'todos' && c.ramoPrincipal !== ramo) return false;

                return true;
            });

            // Ordenação
            clientesFiltrados.sort((a, b) => {
                switch (ordenacao) {
                    case 'nome':
                        return (a.nome || '').localeCompare(b.nome || '');
                    case 'nome_desc':
                        return (b.nome || '').localeCompare(a.nome || '');
                    case 'recente':
                        const dataA = a.criadoEm?.toDate ? a.criadoEm.toDate() : new Date(a.criadoEm || 0);
                        const dataB = b.criadoEm?.toDate ? b.criadoEm.toDate() : new Date(b.criadoEm || 0);
                        return dataB - dataA;
                    case 'antigo':
                        const dataA2 = a.criadoEm?.toDate ? a.criadoEm.toDate() : new Date(a.criadoEm || 0);
                        const dataB2 = b.criadoEm?.toDate ? b.criadoEm.toDate() : new Date(b.criadoEm || 0);
                        return dataA2 - dataB2;
                    case 'apolices':
                        return b.qtdApolices - a.qtdApolices;
                    default:
                        return 0;
                }
            });

            renderizarTabela();
        }

        // Renderizar tabela
        function renderizarTabela() {
            document.getElementById('contadorResultados').textContent = `${clientesFiltrados.length} cliente${clientesFiltrados.length !== 1 ? 's' : ''}`;

            const tbody = document.getElementById('tabelaClientes');

            if (clientesFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum cliente encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = clientesFiltrados.map(cliente => {
                const whatsapp = cliente.whatsapp ? cliente.whatsapp.replace(/\D/g, '') : '';
                const proximaRen = cliente.proximaRenovacao 
                    ? cliente.proximaRenovacao.toLocaleDateString('pt-BR')
                    : '-';
                
                const hoje = new Date();
                const em30dias = new Date();
                em30dias.setDate(em30dias.getDate() + 30);
                const renovacaoProxima = cliente.proximaRenovacao && 
                    cliente.proximaRenovacao >= hoje && 
                    cliente.proximaRenovacao <= em30dias;

                // Mostrar ramos das cotações
                const ramosTexto = cliente.ramos && cliente.ramos.length > 0 
                    ? cliente.ramos.map(r => formatarRamo(r)).join(', ')
                    : '-';

                return `
                    <tr onclick="abrirDetalheCliente('${cliente.chave}')" style="cursor: pointer;">
                        <td>
                            <strong>${cliente.nome || 'Sem nome'}</strong>
                            ${cliente.cpf ? `<br><small class="text-muted">${formatarCPF(cliente.cpf)}</small>` : ''}
                        </td>
                        <td>
                            ${cliente.email || '-'}
                            ${whatsapp ? `<br><a href="https://wa.me/55${whatsapp}" target="_blank" class="btn-whatsapp-inline" onclick="event.stopPropagation()"><i class="fab fa-whatsapp"></i> ${formatarTelefone(cliente.whatsapp)}</a>` : ''}
                        </td>
                        <td>${cliente.cidade || '-'}${cliente.estado ? '/' + cliente.estado : ''}</td>
                        <td>
                            <span class="badge-count" title="${ramosTexto}">${cliente.qtdCotacoes || cliente.leadsCliente?.length || 0}</span>
                            <small class="text-muted" style="display: block; font-size: 0.7rem;">${ramosTexto}</small>
                        </td>
                        <td>
                            <span class="badge-count ${cliente.qtdApolices > 0 ? 'badge-success' : ''}">${cliente.qtdApolices}</span>
                        </td>
                        <td>
                            ${renovacaoProxima ? `<span class="status-badge status-pendente">${proximaRen}</span>` : proximaRen}
                        </td>
                        <td>R$ ${cliente.valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); abrirDetalheCliente('${cliente.chave}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Abrir detalhe do cliente
        function abrirDetalheCliente(chave) {
            const cliente = clientes.find(c => c.chave === chave);
            if (!cliente) return;

            document.getElementById('modalClienteNome').textContent = cliente.nome || 'Cliente';
            document.getElementById('detalheNome').textContent = cliente.nome || '-';
            document.getElementById('detalheCPF').textContent = cliente.cpf ? formatarCPF(cliente.cpf) : '-';
            document.getElementById('detalheNascimento').textContent = cliente.dataNascimento || '-';
            document.getElementById('detalheEmail').textContent = cliente.email || '-';
            document.getElementById('detalheWhatsapp').textContent = cliente.whatsapp ? formatarTelefone(cliente.whatsapp) : '-';
            
            const endereco = [cliente.cep, cliente.cidade, cliente.estado].filter(Boolean).join(' - ');
            document.getElementById('detalheEndereco').textContent = endereco || '-';

            // WhatsApp button
            const whatsapp = cliente.whatsapp ? cliente.whatsapp.replace(/\D/g, '') : '';
            const btnWhatsapp = document.getElementById('btnWhatsappCliente');
            if (whatsapp) {
                btnWhatsapp.href = `https://wa.me/55${whatsapp}`;
                btnWhatsapp.style.display = 'inline-flex';
            } else {
                btnWhatsapp.style.display = 'none';
            }

            // Apólices do cliente
            const bodyApolices = document.getElementById('bodyApolicesCliente');
            if (cliente.apolicesCliente && cliente.apolicesCliente.length > 0) {
                bodyApolices.innerHTML = cliente.apolicesCliente.map(apolice => {
                    const inicio = apolice.dataInicioVigencia?.toDate 
                        ? apolice.dataInicioVigencia.toDate().toLocaleDateString('pt-BR')
                        : '-';
                    const fim = apolice.dataFimVigencia?.toDate
                        ? apolice.dataFimVigencia.toDate().toLocaleDateString('pt-BR')
                        : '-';
                    
                    const hoje = new Date();
                    const dataFim = apolice.dataFimVigencia?.toDate ? apolice.dataFimVigencia.toDate() : new Date(apolice.dataFimVigencia);
                    const ativa = dataFim >= hoje;

                    return `
                        <tr>
                            <td>${formatarRamo(apolice.ramo)}</td>
                            <td>${apolice.seguradora || '-'}</td>
                            <td>${apolice.numeroApolice || '-'}</td>
                            <td>${inicio} a ${fim}</td>
                            <td>R$ ${(apolice.valorPremio || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                            <td>
                                <span class="status-badge ${ativa ? 'status-fechado' : 'status-perdido'}">
                                    ${ativa ? 'Ativa' : 'Vencida'}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                bodyApolices.innerHTML = '<tr><td colspan="6" class="text-center">Nenhuma apólice cadastrada</td></tr>';
            }

            // Leads/Cotações do cliente (agora mostra TODAS as cotações agrupadas)
            const bodyLeads = document.getElementById('bodyLeadsCliente');
            if (cliente.leadsCliente && cliente.leadsCliente.length > 0) {
                bodyLeads.innerHTML = cliente.leadsCliente.map(lead => {
                    const data = lead.criadoEm?.toDate 
                        ? lead.criadoEm.toDate().toLocaleDateString('pt-BR')
                        : '-';

                    return `
                        <tr onclick="window.location.href='lead-detalhe.html?id=${lead.id}'" style="cursor: pointer;">
                            <td>${data}</td>
                            <td>${formatarRamo(lead.ramo)}</td>
                            <td><span class="status-badge status-${lead.status}">${formatarStatus(lead.status)}</span></td>
                            <td>R$ ${(lead.valorPremio || lead.valorCotacao || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); window.location.href='lead-detalhe.html?id=${lead.id}'">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                bodyLeads.innerHTML = '<tr><td colspan="5" class="text-center">Nenhuma cotação registrada</td></tr>';
            }

            document.getElementById('modalCliente').classList.add('active');
        }

        // Limpar filtros
        function limparFiltros() {
            document.getElementById('campoBusca').value = '';
            document.getElementById('filtroStatus').value = 'todos';
            document.getElementById('filtroRamo').value = 'todos';
            document.getElementById('ordenacao').value = 'nome';
            filtrarClientes();
        }

        // Formatadores
        function formatarCPF(cpf) {
            if (!cpf) return '';
            const nums = cpf.replace(/\D/g, '');
            return nums.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }

        function formatarTelefone(tel) {
            if (!tel) return '';
            const nums = tel.replace(/\D/g, '');
            if (nums.length === 11) {
                return `(${nums.slice(0,2)}) ${nums.slice(2,7)}-${nums.slice(7)}`;
            }
            return tel;
        }

        function formatarRamo(ramo) {
            const ramos = {
                'auto': 'Auto',
                'residencial': 'Residencial',
                'vida': 'Vida',
                'empresarial': 'Empresarial',
                'saude': 'Saúde',
                'outros': 'Outros'
            };
            return ramos[ramo] || ramo || '-';
        }

        function formatarStatus(status) {
            const statuses = {
                'pre_cadastro': 'Pré-Cadastro',
                'contato_realizado': 'Contato Realizado',
                'pendente_documentos': 'Pendente Docs',
                'cotacao_enviada': 'Cotação Enviada',
                'recusada_seguradora': 'Recusada',
                'negocio_fechado': 'Fechado',
                'negocio_perdido': 'Perdido'
            };
            return statuses[status] || status;
        }

        // Fechar modal
        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Mostrar toast
        function mostrarToast(mensagem, tipo = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.className = `toast ${tipo} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Logout
        function fazerLogout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // Mobile toggle
        document.getElementById('mobileToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });

        // Fechar modais com ESC
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
            }
        });

        // Fechar modais clicando fora
        document.querySelectorAll(
