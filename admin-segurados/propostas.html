<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÑ Leitura de Propostas - Retorno Seguros CRM</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script>
        // Inicializa√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.appspot.com",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29",
            measurementId: "G-C6E44WXLPW"
        };
        firebase.initializeApp(firebaseConfig);
        
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <style>
        :root {
            --primary: #1a56db;
            --primary-dark: #1e40af;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }
        
        .btn-secondary:hover {
            background: var(--gray-50);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        /* Container Principal */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .card-header {
            background: var(--gray-50);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            font-size: 1rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(26, 86, 219, 0.05);
        }
        
        .upload-area.processing {
            border-color: var(--warning);
            background: rgba(217, 119, 6, 0.05);
        }
        
        .upload-area.success {
            border-color: var(--success);
            background: rgba(5, 150, 105, 0.05);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .upload-text {
            color: var(--gray-500);
            margin-bottom: 0.5rem;
        }
        
        .upload-hint {
            font-size: 0.75rem;
            color: var(--gray-400);
        }
        
        #fileInput {
            display: none;
        }
        
        /* Seguradora Badge */
        .seguradora-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .seguradora-porto { background: #e3f2fd; color: #1565c0; }
        .seguradora-azul { background: #e8f5e9; color: #2e7d32; }
        .seguradora-hdi { background: #fff3e0; color: #e65100; }
        .seguradora-tokio { background: #fce4ec; color: #c2185b; }
        .seguradora-bradesco { background: #ffebee; color: #c62828; }
        .seguradora-yelum { background: #f3e5f5; color: #7b1fa2; }
        .seguradora-allianz { background: #e3f2fd; color: #0d47a1; }
        .seguradora-mapfre { background: #ffebee; color: #b71c1c; }
        .seguradora-liberty { background: #e8f5e9; color: #1b5e20; }
        .seguradora-suhai { background: #fff8e1; color: #ff6f00; }
        .seguradora-desconhecida { background: var(--gray-200); color: var(--gray-700); }
        
        /* Dados Extra√≠dos */
        .dados-section {
            margin-bottom: 1.5rem;
        }
        
        .dados-section h3 {
            font-size: 0.875rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .dados-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .dados-grid.full {
            grid-template-columns: 1fr;
        }
        
        .dado-item {
            background: var(--gray-50);
            padding: 0.75rem;
            border-radius: 8px;
        }
        
        .dado-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }
        
        .dado-valor {
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .dado-valor.destaque {
            color: var(--primary);
            font-size: 1.125rem;
        }
        
        /* Coberturas Table */
        .coberturas-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .coberturas-table th {
            background: var(--gray-100);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .coberturas-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .coberturas-table tr:last-child td {
            border-bottom: none;
        }
        
        .coberturas-table .valor {
            text-align: right;
            font-weight: 600;
        }
        
        .coberturas-table .premio {
            color: var(--success);
        }
        
        /* Vincular Lead */
        .vincular-section {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .vincular-section label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }
        
        .search-lead {
            position: relative;
        }
        
        .search-lead input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
        }
        
        .search-lead input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        
        .search-results.show {
            display: block;
        }
        
        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .search-result-item:hover {
            background: var(--gray-50);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-name {
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .search-result-info {
            font-size: 0.75rem;
            color: var(--gray-500);
        }
        
        .lead-selecionado {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(5, 150, 105, 0.1);
            border-radius: 8px;
            margin-top: 0.5rem;
        }
        
        .lead-selecionado .icon {
            color: var(--success);
        }
        
        .lead-selecionado .remove {
            margin-left: auto;
            cursor: pointer;
            color: var(--gray-500);
        }
        
        .lead-selecionado .remove:hover {
            color: var(--danger);
        }
        
        /* Status e Loading */
        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-message.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-message.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* A√ß√µes Finais */
        .acoes-finais {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }
        
        .acoes-finais .btn {
            flex: 1;
            justify-content: center;
            padding: 0.875rem;
        }
        
        /* Hist√≥rico */
        .historico-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .historico-item:hover {
            background: var(--gray-50);
        }
        
        .historico-item:last-child {
            border-bottom: none;
        }
        
        .historico-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .historico-info {
            flex: 1;
        }
        
        .historico-nome {
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .historico-detalhes {
            font-size: 0.75rem;
            color: var(--gray-500);
        }
        
        .historico-valor {
            text-align: right;
        }
        
        .historico-premio {
            font-weight: 600;
            color: var(--success);
        }
        
        .historico-data {
            font-size: 0.75rem;
            color: var(--gray-500);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }
        
        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Hide */
        .hidden {
            display: none !important;
        }
        
        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-500);
            transition: all 0.2s;
        }
        
        .tab:hover {
            background: var(--gray-100);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        /* Debug Info */
        .debug-info {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>üìÑ Leitura de Propostas</h1>
        <div class="header-actions">
            <a href="index.html" class="btn btn-secondary">‚Üê Voltar ao CRM</a>
            <span id="userEmail" style="font-size: 0.875rem;"></span>
        </div>
    </header>
    
    <div class="container">
        <div class="grid">
            <!-- Coluna Esquerda - Upload -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <h2>üì§ Upload de Proposta</h2>
                    </div>
                    <div class="card-body">
                        <div id="uploadArea" class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <div class="upload-icon">üìÑ</div>
                            <div class="upload-text">Arraste o PDF da proposta aqui</div>
                            <div class="upload-hint">ou clique para selecionar</div>
                            <div class="upload-hint" style="margin-top: 0.5rem;">
                                Seguradoras: Porto, Azul, HDI, Tokio, Bradesco, Yelum, Allianz, Mapfre, Liberty, Suhai
                            </div>
                        </div>
                        <input type="file" id="fileInput" accept=".pdf" onchange="processarPDF(this.files[0])">
                        
                        <div id="statusContainer" class="hidden" style="margin-top: 1rem;"></div>
                    </div>
                </div>
                
                <!-- Dados Extra√≠dos -->
                <div id="dadosExtraidosCard" class="card hidden" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h2>üìä Dados Extra√≠dos</h2>
                        <div id="seguradoraBadge" class="seguradora-badge"></div>
                    </div>
                    <div class="card-body">
                        <div id="dadosExtraidos"></div>
                        
                        <!-- Vincular a Lead -->
                        <div class="vincular-section">
                            <label>üîó Vincular a Lead/Cliente</label>
                            <div class="search-lead">
                                <input type="text" id="searchLeadInput" placeholder="Buscar por nome, CPF ou placa..." oninput="buscarLeads(this.value)">
                                <div id="searchResults" class="search-results"></div>
                            </div>
                            <div id="leadSelecionado" class="hidden"></div>
                        </div>
                        
                        <!-- A√ß√µes -->
                        <div class="acoes-finais">
                            <button class="btn btn-success" onclick="salvarProposta()">
                                üíæ Salvar Proposta
                            </button>
                            <button class="btn btn-secondary" onclick="limparDados()">
                                üîÑ Nova Leitura
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Coluna Direita - Hist√≥rico -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <h2>üìã Propostas Recentes</h2>
                        <button class="btn btn-secondary" onclick="carregarHistorico()">üîÑ Atualizar</button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="historicoPropostas">
                            <div class="empty-state">
                                <div class="icon">üìÑ</div>
                                <p>Nenhuma proposta processada ainda</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Debug (para desenvolvimento) -->
                <div id="debugCard" class="card hidden" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h2>üîß Debug</h2>
                        <button class="btn btn-secondary" onclick="document.getElementById('debugCard').classList.add('hidden')">‚úï</button>
                    </div>
                    <div class="card-body">
                        <div id="debugInfo" class="debug-info"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ==========================================
        // VARI√ÅVEIS GLOBAIS
        // ==========================================
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        
        let dadosPropostaAtual = null;
        let leadSelecionadoId = null;
        let textoExtraido = '';
        
        // ==========================================
        // AUTENTICA√á√ÉO
        // ==========================================
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('userEmail').textContent = user.email;
                carregarHistorico();
            } else {
                window.location.href = 'login.html';
            }
        });
        
        // ==========================================
        // DRAG AND DROP
        // ==========================================
        const uploadArea = document.getElementById('uploadArea');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'));
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'));
        });
        
        uploadArea.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processarPDF(files[0]);
            }
        });
        
        // ==========================================
        // PROCESSAMENTO PDF
        // ==========================================
        async function processarPDF(file) {
            if (!file || file.type !== 'application/pdf') {
                mostrarStatus('error', 'Por favor, selecione um arquivo PDF v√°lido.');
                return;
            }
            
            mostrarStatus('info', '‚è≥ Processando PDF... Aguarde...');
            uploadArea.classList.add('processing');
            
            try {
                // Carregar PDF com PDF.js
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                console.log(`PDF carregado: ${pdf.numPages} p√°ginas`);
                
                // Extrair texto de todas as p√°ginas
                let textoCompleto = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    textoCompleto += pageText + '\n\n';
                }
                
                textoExtraido = textoCompleto;
                console.log('Texto extra√≠do:', textoCompleto.substring(0, 500));
                
                // Debug
                document.getElementById('debugInfo').textContent = textoCompleto.substring(0, 3000);
                // document.getElementById('debugCard').classList.remove('hidden');
                
                // Identificar seguradora e extrair dados
                const dados = extrairDadosProposta(textoCompleto);
                
                if (dados) {
                    dadosPropostaAtual = dados;
                    dadosPropostaAtual.arquivoNome = file.name;
                    dadosPropostaAtual.dataProcessamento = new Date().toISOString();
                    
                    exibirDadosExtraidos(dados);
                    mostrarStatus('success', `‚úÖ Proposta ${dados.seguradora.toUpperCase()} processada com sucesso!`);
                    uploadArea.classList.remove('processing');
                    uploadArea.classList.add('success');
                } else {
                    mostrarStatus('warning', '‚ö†Ô∏è N√£o foi poss√≠vel identificar a seguradora. Verifique se o PDF est√° correto.');
                    uploadArea.classList.remove('processing');
                }
                
            } catch (error) {
                console.error('Erro ao processar PDF:', error);
                mostrarStatus('error', `‚ùå Erro ao processar PDF: ${error.message}`);
                uploadArea.classList.remove('processing');
            }
        }
        
        // ==========================================
        // IDENTIFICA√á√ÉO DE SEGURADORA
        // ==========================================
        function identificarSeguradora(texto) {
            const textoLower = texto.toLowerCase();
            const textoUpper = texto.toUpperCase();
            
            // Padr√µes de identifica√ß√£o
            if (textoLower.includes('porto seguro') || textoLower.includes('portoseguro')) {
                return 'porto';
            }
            if (textoLower.includes('azul seguros') || textoUpper.includes('AZUL TRADICIONAL')) {
                return 'azul';
            }
            if (textoLower.includes('hdi seguros') || textoLower.includes('hdi auto')) {
                return 'hdi';
            }
            if (textoLower.includes('tokio marine') || textoLower.includes('tokio auto')) {
                return 'tokio';
            }
            if (textoLower.includes('bradesco') || textoLower.includes('bradesco auto')) {
                return 'bradesco';
            }
            if (textoLower.includes('yelum') || textoUpper.includes('YELUMAUTO')) {
                return 'yelum';
            }
            if (textoLower.includes('allianz')) {
                return 'allianz';
            }
            if (textoLower.includes('mapfre')) {
                return 'mapfre';
            }
            if (textoLower.includes('liberty')) {
                return 'liberty';
            }
            if (textoLower.includes('suhai')) {
                return 'suhai';
            }
            
            return null;
        }
        
        // ==========================================
        // EXTRA√á√ÉO DE DADOS
        // ==========================================
        function extrairDadosProposta(texto) {
            const seguradora = identificarSeguradora(texto);
            
            if (!seguradora) {
                return null;
            }
            
            // Extrair dados conforme a seguradora
            let dados = {
                seguradora: seguradora,
                proposta: {},
                segurado: {},
                veiculo: {},
                coberturas: [],
                valores: {}
            };
            
            switch (seguradora) {
                case 'porto':
                    dados = extrairDadosPorto(texto, dados);
                    break;
                case 'azul':
                    dados = extrairDadosAzul(texto, dados);
                    break;
                case 'hdi':
                    dados = extrairDadosHDI(texto, dados);
                    break;
                case 'tokio':
                    dados = extrairDadosTokio(texto, dados);
                    break;
                case 'bradesco':
                    dados = extrairDadosBradesco(texto, dados);
                    break;
                case 'yelum':
                    dados = extrairDadosYelum(texto, dados);
                    break;
                default:
                    dados = extrairDadosGenerico(texto, dados);
            }
            
            return dados;
        }
        
        // ==========================================
        // PARSERS POR SEGURADORA
        // ==========================================
        
        // PORTO SEGURO
        function extrairDadosPorto(texto, dados) {
            // N√∫mero da proposta
            let match = texto.match(/N[¬∫¬∞]\s*da\s*Proposta[:\s]*([A-Z0-9\-]+)/i);
            if (match) dados.proposta.numero = match[1].trim();
            
            // Vig√™ncia
            match = texto.match(/DAS\s*24\s*HORAS\s*DO\s*DIA\s*(\d{2}\/\d{2}\/\d{4})\s*AT[√âE]\s*AS\s*24\s*HORAS\s*DO\s*DIA\s*(\d{2}\/\d{2}\/\d{4})/i);
            if (match) {
                dados.proposta.vigenciaInicio = match[1];
                dados.proposta.vigenciaFim = match[2];
            }
            
            // Segurado
            match = texto.match(/Proponente\s*\/\s*Segurado\(a\)[:\s]*([A-Z√Ä-√ö\s]+?)(?:\s+(?:F√çSICA|JUR√çDICA|PESSOA|F[√çI]SICA))/i);
            if (match) dados.segurado.nome = match[1].trim();
            
            // CPF
            match = texto.match(/CPF[:\s]*(\d{3}\.?\d{3}\.?\d{3}-?\d{2})/i);
            if (match) dados.segurado.cpf = match[1];
            
            // Ve√≠culo
            match = texto.match(/(\d{4})\s*-\s*-?\s*([A-Z0-9\s\.\-\/]+?)\s*(\d{4})\s*\/\s*(\d{4})/i);
            if (match) {
                dados.veiculo.modelo = match[2].trim();
                dados.veiculo.anoFab = match[3];
                dados.veiculo.anoMod = match[4];
            }
            
            // Placa
            match = texto.match(/Placa[:\s]*([A-Z]{3}[\-\s]?\d{1}[A-Z0-9]{1}\d{2})/i);
            if (match) dados.veiculo.placa = match[1].toUpperCase();
            
            // Chassi
            match = texto.match(/Chassi[:\s]*([A-Z0-9]{17})/i);
            if (match) dados.veiculo.chassi = match[1];
            
            // C√≥digo FIPE
            match = texto.match(/Fipe[:\s]*(\d{5,6})/i);
            if (match) dados.veiculo.fipe = match[1];
            
            // Coberturas
            dados.coberturas = [];
            
            // Casco
            match = texto.match(/COMPREENSIVA\s*(\d{1,3}[\.,]?\d{0,2})\s*%\s*R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'Casco - Compreensiva',
                    lmi: match[1] + '%',
                    franquia: 'R$ ' + match[2]
                });
            }
            
            // Pr√™mio Casco
            match = texto.match(/Casco[\s\S]*?Valor\s*do\s*Pr[√™e]mio[\s\S]*?R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.valores.premioCasco = parseFloat(match[1].replace('.', '').replace(',', '.'));
            }
            
            // RCF-V
            match = texto.match(/Danos\s*Materiais[:\s]*R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'RCF-V - Danos Materiais',
                    lmi: 'R$ ' + match[1]
                });
            }
            
            match = texto.match(/Danos\s*Corporais[:\s]*R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'RCF-V - Danos Corporais',
                    lmi: 'R$ ' + match[1]
                });
            }
            
            match = texto.match(/Danos\s*Morais[:\s]*R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'RCF-V - Danos Morais',
                    lmi: 'R$ ' + match[1]
                });
            }
            
            // Pr√™mio Total
            match = texto.match(/Pr[√™e]mio\s*Total[:\s]*R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.valores.premioTotal = parseFloat(match[1].replace('.', '').replace(',', '.'));
            }
            
            return dados;
        }
        
        // AZUL SEGUROS
        function extrairDadosAzul(texto, dados) {
            // N√∫mero da proposta
            let match = texto.match(/N[¬∫¬∞]\s*da\s*Proposta[:\s]*([A-Z0-9\-]+)/i);
            if (match) dados.proposta.numero = match[1].trim();
            
            // Vig√™ncia
            match = texto.match(/DAS\s*24\s*HORAS\s*DO\s*DIA\s*(\d{2}\/\d{2}\/\d{4})\s*AT[√âE]\s*AS\s*24\s*HORAS\s*DO\s*DIA\s*(\d{2}\/\d{2}\/\d{4})/i);
            if (match) {
                dados.proposta.vigenciaInicio = match[1];
                dados.proposta.vigenciaFim = match[2];
            }
            
            // Segurado (pode ser PJ)
            match = texto.match(/Proponente\s*\/\s*Segurado\(a\)[:\s]*([A-Z√Ä-√ö\s]+?)\s+(?:PESSOA|JUR[√çI]DICA|F[√çI]SICA)/i);
            if (match) dados.segurado.nome = match[1].trim();
            
            // CPF ou CNPJ
            match = texto.match(/CPF[:\s]*(\d{3}\.?\d{3}\.?\d{3}-?\d{2})/i);
            if (match) dados.segurado.cpf = match[1];
            
            match = texto.match(/CNPJ[:\s]*(\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2})/i);
            if (match) dados.segurado.cnpj = match[1];
            
            // Email
            match = texto.match(/E-?mail[:\s]*([a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/i);
            if (match) dados.segurado.email = match[1];
            
            // Telefone
            match = texto.match(/CELULAR[:\s]*\((\d{2})\)\s*(\d{4,5}-?\d{4})/i);
            if (match) dados.segurado.telefone = `(${match[1]}) ${match[2]}`;
            
            // Ve√≠culo - padr√£o diferente
            match = texto.match(/Ve[√≠i]culo[\s\S]*?(\d{4})\s*\/\s*(\d{4})/i);
            if (match) {
                dados.veiculo.anoFab = match[1];
                dados.veiculo.anoMod = match[2];
            }
            
            // Placa
            match = texto.match(/Placa[:\s]*([A-Z]{3}[\-\s]?\d{1}[A-Z0-9]{1}\d{2})/i);
            if (match) dados.veiculo.placa = match[1].toUpperCase();
            
            // Chassi
            match = texto.match(/Chassi[:\s]*([A-Z0-9]{17})/i);
            if (match) dados.veiculo.chassi = match[1];
            
            // Coberturas Azul
            dados.coberturas = [];
            
            // Casco
            match = texto.match(/COMPREENSIVA\s*(\d{1,3}[\.,]?\d{0,2})\s*%\s*R\$\s*([\d\.,]+)\s*[\d\.,]+\s*%\s*[\d\.,]+\s*%\s*R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'Casco - Compreensiva',
                    lmi: match[1] + '%',
                    franquia: 'R$ ' + match[2],
                    premio: 'R$ ' + match[3]
                });
                dados.valores.premioCasco = parseFloat(match[3].replace('.', '').replace(',', '.'));
            }
            
            // Vidros
            match = texto.match(/DANOS\s*AOS\s*VIDROS[\s\S]*?R\$\s*([\d\.,]+)[\s\S]*?R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'Vidros e Retrovisores',
                    lmi: 'R$ ' + match[1],
                    premio: 'R$ ' + match[2]
                });
            }
            
            return dados;
        }
        
        // HDI
        function extrairDadosHDI(texto, dados) {
            // N√∫mero da proposta
            let match = texto.match(/Especifica[√ßc][√£a]o\s*da\s*Proposta\s*(\d{2}\.\d{3}\.\d{3}\.\d{10})/i);
            if (match) dados.proposta.numero = match[1];
            
            // Vig√™ncia
            match = texto.match(/Das\s*24\s*h\s*do\s*dia\s*(\d{2}\/\d{2}\/\d{4})\s*[√†a]s\s*24\s*h\s*do\s*dia\s*(\d{2}\/\d{2}\/\d{4})/i);
            if (match) {
                dados.proposta.vigenciaInicio = match[1];
                dados.proposta.vigenciaFim = match[2];
            }
            
            // Segurado
            match = texto.match(/Nome\s*de\s*Registro\s*Segurado\s*[:\s]*([A-Z√Ä-√ö\s]+?)\s+CPF/i);
            if (match) dados.segurado.nome = match[1].trim();
            
            // CPF
            match = texto.match(/CPF\s*[:\s]*(\d{3}\.?\d{3}\.?\d{3}-?\d{2})/i);
            if (match) dados.segurado.cpf = match[1];
            
            // Endere√ßo
            match = texto.match(/Endere[√ßc]o\s*[:\s]*([A-Z√Ä-√ö0-9\s,\/]+?)\s+Celular/i);
            if (match) dados.segurado.endereco = match[1].trim();
            
            // CEP
            match = texto.match(/CEP\s*[:\s]*(\d{5}-?\d{3})/i);
            if (match) dados.segurado.cep = match[1];
            
            // Cidade
            match = texto.match(/Cidade\s*[:\s]*([A-Z√Ä-√ö\s]+?)\s+-\s*([A-Z]{2})/i);
            if (match) {
                dados.segurado.cidade = match[1].trim();
                dados.segurado.uf = match[2];
            }
            
            // Pr√™mio Total
            match = texto.match(/Pr[√™e]mio\s*Total\s*[:\s]*R?\$?\s*([\d\.,]+)/i);
            if (match) {
                dados.valores.premioTotal = parseFloat(match[1].replace('.', '').replace(',', '.'));
            }
            
            // Forma de pagamento
            match = texto.match(/Forma\s*de\s*Pagamento\s*[:\s]*(\d+)\s*x/i);
            if (match) dados.valores.parcelas = parseInt(match[1]);
            
            match = texto.match(/Parcela\s*[:\s]*R?\$?\s*([\d\.,]+)/i);
            if (match) {
                dados.valores.valorParcela = parseFloat(match[1].replace('.', '').replace(',', '.'));
            }
            
            return dados;
        }
        
        // TOKIO MARINE
        function extrairDadosTokio(texto, dados) {
            // N√∫mero da proposta/cota√ß√£o
            let match = texto.match(/N[¬∫¬∞]\s*Cota[√ßc][√£a]o[:\s]*(\d+)/i);
            if (match) dados.proposta.cotacao = match[1];
            
            match = texto.match(/N[¬∫¬∞]\s*Proposta\/Neg[√≥o]cio[:\s]*(\d+)/i);
            if (match) dados.proposta.numero = match[1];
            
            // Vig√™ncia
            match = texto.match(/Vig[√™e]ncia[:\s]*(\d{2}\/\d{2}\/\d{4})\s*-\s*(\d{2}\/\d{2}\/\d{4})/i);
            if (match) {
                dados.proposta.vigenciaInicio = match[1];
                dados.proposta.vigenciaFim = match[2];
            }
            
            // Segurado
            match = texto.match(/Proponente\s+CPF\/CNPJ[:\s]*([A-Z√Ä-√ö\s]+?)\s+(\d{3}\.?\d{3}\.?\d{3}-?\d{2})/i);
            if (match) {
                dados.segurado.nome = match[1].trim();
                dados.segurado.cpf = match[2];
            }
            
            // Email
            match = texto.match(/E-?mail[:\s]*([a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/i);
            if (match) dados.segurado.email = match[1];
            
            // Ve√≠culo
            match = texto.match(/Fabricante\s+Ve[√≠i]culo[:\s]*([A-Z]+)\s+([A-Z0-9\s\.\-\/]+)/i);
            if (match) {
                dados.veiculo.marca = match[1];
                dados.veiculo.modelo = match[2].trim();
            }
            
            // Placa
            match = texto.match(/Placa[:\s]*([A-Z]{3}[\-\s]?\d{1}[A-Z0-9]{1}\d{2})/i);
            if (match) dados.veiculo.placa = match[1].toUpperCase();
            
            // Chassi
            match = texto.match(/Chassi[:\s]*([A-Z0-9]{17})/i);
            if (match) dados.veiculo.chassi = match[1];
            
            // Ano
            match = texto.match(/Ano\s*modelo[:\s]*(\d{4})/i);
            if (match) dados.veiculo.anoMod = match[1];
            
            // FIPE
            match = texto.match(/C[√≥o]digo\s*FIPE[:\s]*(\d{6}-?\d)/i);
            if (match) dados.veiculo.fipe = match[1];
            
            // Coberturas - Tokio tem tabela bem estruturada
            dados.coberturas = [];
            
            // Casco
            match = texto.match(/Colis[√£a]o,\s*Inc[√™e]ndio\s*e\s*Roubo\/Furto[:\s]*Valor\s*Referenciado\s*\(VMR\)[\s\S]*?R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'Casco - Compreensiva',
                    lmi: 'VMR 100%',
                    premio: 'R$ ' + match[1]
                });
                dados.valores.premioCasco = parseFloat(match[1].replace('.', '').replace(',', '.'));
            }
            
            // RCF-V DM
            match = texto.match(/RCF-V\s*-\s*Danos\s*Materiais[:\s]*R\$\s*([\d\.,]+)[\s\S]*?R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'RCF-V - Danos Materiais',
                    lmi: 'R$ ' + match[1],
                    premio: 'R$ ' + match[2]
                });
            }
            
            // RCF-V DC
            match = texto.match(/RCF-V\s*-\s*Danos\s*Corporais[:\s]*R\$\s*([\d\.,]+)[\s\S]*?R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'RCF-V - Danos Corporais',
                    lmi: 'R$ ' + match[1],
                    premio: 'R$ ' + match[2]
                });
            }
            
            // RCF-V Danos Morais
            match = texto.match(/RCF-V\s*-\s*Danos\s*Morais[:\s]*R\$\s*([\d\.,]+)[\s\S]*?R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'RCF-V - Danos Morais',
                    lmi: 'R$ ' + match[1],
                    premio: 'R$ ' + match[2]
                });
            }
            
            // APP
            match = texto.match(/APP\s*-\s*Morte[\s\S]*?R\$\s*([\d\.,]+)[\s\S]*?R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'APP - Morte',
                    lmi: 'R$ ' + match[1],
                    premio: 'R$ ' + match[2]
                });
            }
            
            // Pr√™mio Total
            match = texto.match(/Pr[√™e]mio\s*L[√≠i]quido\s*total[:\s]*R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.valores.premioLiquido = parseFloat(match[1].replace('.', '').replace(',', '.'));
            }
            
            // Franquia
            match = texto.match(/Indeniza[√ßc][√£a]o\s*Parcial\s*do\s*Ve[√≠i]culo[:\s]*R\$\s*([\d\.,]+)/i);
            if (match) {
                dados.valores.franquiaCasco = parseFloat(match[1].replace('.', '').replace(',', '.'));
            }
            
            return dados;
        }
        
        // BRADESCO
        function extrairDadosBradesco(texto, dados) {
            // N√∫mero da proposta
            let match = texto.match(/Proposta[:\s]*(\d+)/i);
            if (match) dados.proposta.numero = match[1];
            
            // Cota√ß√£o
            match = texto.match(/N[¬∫¬∞]\s*Cota[√ßc][√£a]o[:\s]*([\d\/]+)/i);
            if (match) dados.proposta.cotacao = match[1];
            
            // Vig√™ncia
            match = texto.match(/Vig[√™e]ncia[:\s]*das\s*24h\s*de\s*(\d{2}\/\d{2}\/\d{4})\s*[√†a]s\s*24h\s*de\s*(\d{2}\/\d{2}\/\d{4})/i);
            if (match) {
                dados.proposta.vigenciaInicio = match[1];
                dados.proposta.vigenciaFim = match[2];
            }
            
            // Segurado
            match = texto.match(/Nome[:\s]*([A-Z√Ä-√ö\s]+?)\s+CPF\/CNPJ/i);
            if (match) dados.segurado.nome = match[1].trim();
            
            // CPF
            match = texto.match(/CPF\/CNPJ[:\s]*(\d{3}\.?\d{3}\.?\d{3}-?\d{2})/i);
            if (match) dados.segurado.cpf = match[1];
            
            // Email
            match = texto.match(/E-?mail[:\s]*([a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/i);
            if (match) dados.segurado.email = match[1];
            
            // Celular
            match = texto.match(/Tel\.\s*Celular[:\s]*\d{2}\s*\((\d{2})\)\s*(\d{5}-?\d{4})/i);
            if (match) dados.segurado.telefone = `(${match[1]}) ${match[2]}`;
            
            // Ve√≠culo
            match = texto.match(/Tipo\s*do\s*Ve[√≠i]culo[:\s]*([A-Z√Ä-√ö0-9\s\.\-\/]+?)\s+Chassi/i);
            if (match) dados.veiculo.modelo = match[1].trim();
            
            // Placa
            match = texto.match(/Licen[√ßc]a[:\s]*([A-Z]{3}\d{4})/i);
            if (match) dados.veiculo.placa = match[1];
            
            // Chassi
            match = texto.match(/Chassi[:\s]*([A-Z0-9]{17})/i);
            if (match) dados.veiculo.chassi = match[1];
            
            // Ano
            match = texto.match(/Ano\s*Fab\.[:\s]*(\d{4})\s*Ano\s*Mod\.[:\s]*(\d{4})/i);
            if (match) {
                dados.veiculo.anoFab = match[1];
                dados.veiculo.anoMod = match[2];
            }
            
            // FIPE
            match = texto.match(/C[√≥o]digo\s*FIPE[:\s]*(\d{7})/i);
            if (match) dados.veiculo.fipe = match[1];
            
            // Coberturas
            dados.coberturas = [];
            
            // LMIs
            match = texto.match(/D\.M\.[:\s]*R?\$?\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'RCF-V - Danos Materiais',
                    lmi: 'R$ ' + match[1]
                });
            }
            
            match = texto.match(/D\.C\.[:\s]*R?\$?\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'RCF-V - Danos Corporais',
                    lmi: 'R$ ' + match[1]
                });
            }
            
            match = texto.match(/D\.\s*Morais[\.:\s]*R?\$?\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'RCF-V - Danos Morais',
                    lmi: 'R$ ' + match[1]
                });
            }
            
            // Franquia
            match = texto.match(/Ve[√≠i]culo[:\s]*R?\$?\s*([\d\.,]+)\s*\([^)]*obrigat[√≥o]ria/i);
            if (match) {
                dados.valores.franquiaCasco = parseFloat(match[1].replace('.', '').replace(',', '.'));
            }
            
            // APP
            match = texto.match(/Morte\s*p\/\s*Passageiro[:\s]*R?\$?\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'APP - Morte',
                    lmi: 'R$ ' + match[1]
                });
            }
            
            return dados;
        }
        
        // YELUM
        function extrairDadosYelum(texto, dados) {
            // N√∫mero da proposta
            let match = texto.match(/Proposta\s*N[¬∫¬∞][:\s]*(\d+)/i);
            if (match) dados.proposta.numero = match[1];
            
            // Vig√™ncia
            match = texto.match(/Vig[√™e]ncia[:\s]*(\d{2}\/\d{2}\/\d{4})\s*a\s*(\d{2}\/\d{2}\/\d{4})/i);
            if (match) {
                dados.proposta.vigenciaInicio = match[1];
                dados.proposta.vigenciaFim = match[2];
            }
            
            // Segurado
            match = texto.match(/Nome\s*do\(a\)\s*Proponente\/Segurado\(a\)[:\s]*([A-Z√Ä-√ö\s]+?)\s+CPF/i);
            if (match) dados.segurado.nome = match[1].trim();
            
            // CPF
            match = texto.match(/CPF\/CNPJ[:\s]*(\d{3}\.?\d{3}\.?\d{3}-?\d{2})/i);
            if (match) dados.segurado.cpf = match[1];
            
            // Email
            match = texto.match(/E-?Mail[:\s]*([a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/i);
            if (match) dados.segurado.email = match[1];
            
            // Celular
            match = texto.match(/Celular[:\s]*\((\d{2})\)(\d{8,9})/i);
            if (match) dados.segurado.telefone = `(${match[1]}) ${match[2]}`;
            
            // Ve√≠culo
            match = texto.match(/Marca\/Tipo\s*do\s*Ve[√≠i]culo[:\s]*([A-Z√Ä-√ö0-9\s\.\-\/\(\)]+?)\s+Ano/i);
            if (match) dados.veiculo.modelo = match[1].trim();
            
            // FIPE
            match = texto.match(/C[√≥o]digo\s*FIPE[:\s]*(\d{6}-\d)/i);
            if (match) dados.veiculo.fipe = match[1];
            
            // Ano
            match = texto.match(/Ano\s*Fabrica[√ßc][√£a]o\/Modelo[:\s]*(\d{4})\/(\d{4})/i);
            if (match) {
                dados.veiculo.anoFab = match[1];
                dados.veiculo.anoMod = match[2];
            }
            
            // Placa
            match = texto.match(/Placa[:\s]*([A-Z]{3}\d[A-Z0-9]\d{2})/i);
            if (match) dados.veiculo.placa = match[1];
            
            // Chassi
            match = texto.match(/Chassi[:\s]*([A-Z0-9]{17})/i);
            if (match) dados.veiculo.chassi = match[1];
            
            // Coberturas - Yelum tem tabela estruturada
            dados.coberturas = [];
            
            // Casco
            match = texto.match(/BASICA-01-COMPREENSIVA\s*VMR\s*FIPE\s*x\s*(\d+)%\s*([\d\.,]+)\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'Casco - Compreensiva',
                    lmi: 'VMR ' + match[1] + '%',
                    premio: 'R$ ' + match[2],
                    franquia: 'R$ ' + match[3]
                });
                dados.valores.premioCasco = parseFloat(match[2].replace('.', '').replace(',', '.'));
                dados.valores.franquiaCasco = parseFloat(match[3].replace('.', '').replace(',', '.'));
            }
            
            // RCF DM
            match = texto.match(/RESP\s*CIVIL\s*FACULTATIVA[\s\S]*?DANOS\s*MATERIAIS[:\s]*([\d\.,]+)\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'RCF-V - Danos Materiais',
                    lmi: 'R$ ' + match[1],
                    premio: 'R$ ' + match[2]
                });
            }
            
            // RCF DC
            match = texto.match(/RESP\s*CIVIL\s*FACULTATIVA[\s\S]*?DANOS\s*CORPORAIS[:\s]*([\d\.,]+)\s*([\d\.,]+)/i);
            if (match) {
                dados.coberturas.push({
                    nome: 'RCF-V - Danos Corporais',
                    lmi: 'R$ ' + match[1],
                    premio: 'R$ ' + match[2]
                });
            }
            
            // Pr√™mio Total
            match = texto.match(/Pr[√™e]mio\s*Total\s*\(R\$\)[:\s]*([\d\.,]+)/i);
            if (match) {
                dados.valores.premioTotal = parseFloat(match[1].replace('.', '').replace(',', '.'));
            }
            
            // Parcelas
            match = texto.match(/(\d)\+(\d+)\s*\(CC\)/i);
            if (match) dados.valores.parcelas = parseInt(match[1]) + parseInt(match[2]);
            
            match = texto.match(/Valor\s*\(R\$\)[:\s]*([\d\.,]+)/i);
            if (match) {
                dados.valores.valorParcela = parseFloat(match[1].replace('.', '').replace(',', '.'));
            }
            
            return dados;
        }
        
        // GEN√âRICO (fallback)
        function extrairDadosGenerico(texto, dados) {
            // Tentar extrair dados comuns
            let match;
            
            // CPF
            match = texto.match(/(\d{3}\.?\d{3}\.?\d{3}-?\d{2})/);
            if (match) dados.segurado.cpf = match[1];
            
            // Placa
            match = texto.match(/([A-Z]{3}[\-\s]?\d{1}[A-Z0-9]{1}\d{2})/i);
            if (match) dados.veiculo.placa = match[1].toUpperCase();
            
            // Chassi
            match = texto.match(/([A-Z0-9]{17})/);
            if (match) dados.veiculo.chassi = match[1];
            
            // Valores R$
            const valores = texto.match(/R\$\s*([\d\.,]+)/g);
            if (valores && valores.length > 0) {
                // Pegar o maior valor como pr√™mio total aproximado
                const nums = valores.map(v => parseFloat(v.replace('R$', '').replace('.', '').replace(',', '.').trim()));
                dados.valores.premioTotal = Math.max(...nums);
            }
            
            return dados;
        }
        
        // ==========================================
        // EXIBI√á√ÉO DOS DADOS
        // ==========================================
        function exibirDadosExtraidos(dados) {
            const container = document.getElementById('dadosExtraidos');
            const badge = document.getElementById('seguradoraBadge');
            
            // Badge da seguradora
            const nomesSeguradoras = {
                'porto': 'üîµ Porto Seguro',
                'azul': 'üü¢ Azul Seguros',
                'hdi': 'üü† HDI Seguros',
                'tokio': 'üî¥ Tokio Marine',
                'bradesco': 'üî¥ Bradesco',
                'yelum': 'üü£ Yelum',
                'allianz': 'üîµ Allianz',
                'mapfre': 'üî¥ Mapfre',
                'liberty': 'üü¢ Liberty',
                'suhai': 'üü° Suhai'
            };
            
            badge.className = `seguradora-badge seguradora-${dados.seguradora}`;
            badge.textContent = nomesSeguradoras[dados.seguradora] || dados.seguradora.toUpperCase();
            
            let html = '';
            
            // Dados da Proposta
            if (dados.proposta.numero || dados.proposta.vigenciaInicio) {
                html += `
                    <div class="dados-section">
                        <h3>üìã Proposta</h3>
                        <div class="dados-grid">
                            ${dados.proposta.numero ? `
                                <div class="dado-item">
                                    <div class="dado-label">N√∫mero</div>
                                    <div class="dado-valor">${dados.proposta.numero}</div>
                                </div>
                            ` : ''}
                            ${dados.proposta.cotacao ? `
                                <div class="dado-item">
                                    <div class="dado-label">Cota√ß√£o</div>
                                    <div class="dado-valor">${dados.proposta.cotacao}</div>
                                </div>
                            ` : ''}
                            ${dados.proposta.vigenciaInicio ? `
                                <div class="dado-item">
                                    <div class="dado-label">Vig√™ncia</div>
                                    <div class="dado-valor">${dados.proposta.vigenciaInicio} a ${dados.proposta.vigenciaFim}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Dados do Segurado
            if (dados.segurado.nome || dados.segurado.cpf) {
                html += `
                    <div class="dados-section">
                        <h3>üë§ Segurado</h3>
                        <div class="dados-grid">
                            ${dados.segurado.nome ? `
                                <div class="dado-item" style="grid-column: span 2;">
                                    <div class="dado-label">Nome</div>
                                    <div class="dado-valor">${dados.segurado.nome}</div>
                                </div>
                            ` : ''}
                            ${dados.segurado.cpf ? `
                                <div class="dado-item">
                                    <div class="dado-label">CPF</div>
                                    <div class="dado-valor">${dados.segurado.cpf}</div>
                                </div>
                            ` : ''}
                            ${dados.segurado.cnpj ? `
                                <div class="dado-item">
                                    <div class="dado-label">CNPJ</div>
                                    <div class="dado-valor">${dados.segurado.cnpj}</div>
                                </div>
                            ` : ''}
                            ${dados.segurado.email ? `
                                <div class="dado-item">
                                    <div class="dado-label">E-mail</div>
                                    <div class="dado-valor">${dados.segurado.email}</div>
                                </div>
                            ` : ''}
                            ${dados.segurado.telefone ? `
                                <div class="dado-item">
                                    <div class="dado-label">Telefone</div>
                                    <div class="dado-valor">${dados.segurado.telefone}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Dados do Ve√≠culo
            if (dados.veiculo.placa || dados.veiculo.modelo) {
                html += `
                    <div class="dados-section">
                        <h3>üöó Ve√≠culo</h3>
                        <div class="dados-grid">
                            ${dados.veiculo.modelo ? `
                                <div class="dado-item" style="grid-column: span 2;">
                                    <div class="dado-label">Modelo</div>
                                    <div class="dado-valor">${dados.veiculo.marca ? dados.veiculo.marca + ' ' : ''}${dados.veiculo.modelo}</div>
                                </div>
                            ` : ''}
                            ${dados.veiculo.placa ? `
                                <div class="dado-item">
                                    <div class="dado-label">Placa</div>
                                    <div class="dado-valor">${dados.veiculo.placa}</div>
                                </div>
                            ` : ''}
                            ${dados.veiculo.anoFab || dados.veiculo.anoMod ? `
                                <div class="dado-item">
                                    <div class="dado-label">Ano</div>
                                    <div class="dado-valor">${dados.veiculo.anoFab || ''}/${dados.veiculo.anoMod || ''}</div>
                                </div>
                            ` : ''}
                            ${dados.veiculo.chassi ? `
                                <div class="dado-item" style="grid-column: span 2;">
                                    <div class="dado-label">Chassi</div>
                                    <div class="dado-valor" style="font-size: 0.75rem;">${dados.veiculo.chassi}</div>
                                </div>
                            ` : ''}
                            ${dados.veiculo.fipe ? `
                                <div class="dado-item">
                                    <div class="dado-label">C√≥digo FIPE</div>
                                    <div class="dado-valor">${dados.veiculo.fipe}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Coberturas
            if (dados.coberturas && dados.coberturas.length > 0) {
                html += `
                    <div class="dados-section">
                        <h3>üõ°Ô∏è Coberturas</h3>
                        <table class="coberturas-table">
                            <thead>
                                <tr>
                                    <th>Cobertura</th>
                                    <th>LMI</th>
                                    <th>Franquia</th>
                                    <th>Pr√™mio</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dados.coberturas.map(c => `
                                    <tr>
                                        <td>${c.nome}</td>
                                        <td class="valor">${c.lmi || '-'}</td>
                                        <td class="valor">${c.franquia || '-'}</td>
                                        <td class="valor premio">${c.premio || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Valores
            if (dados.valores.premioTotal || dados.valores.premioLiquido || dados.valores.franquiaCasco) {
                html += `
                    <div class="dados-section">
                        <h3>üí∞ Valores</h3>
                        <div class="dados-grid">
                            ${dados.valores.premioTotal ? `
                                <div class="dado-item">
                                    <div class="dado-label">Pr√™mio Total</div>
                                    <div class="dado-valor destaque">R$ ${dados.valores.premioTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                </div>
                            ` : ''}
                            ${dados.valores.premioLiquido ? `
                                <div class="dado-item">
                                    <div class="dado-label">Pr√™mio L√≠quido</div>
                                    <div class="dado-valor">R$ ${dados.valores.premioLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                </div>
                            ` : ''}
                            ${dados.valores.franquiaCasco ? `
                                <div class="dado-item">
                                    <div class="dado-label">Franquia Casco</div>
                                    <div class="dado-valor">R$ ${dados.valores.franquiaCasco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                </div>
                            ` : ''}
                            ${dados.valores.parcelas ? `
                                <div class="dado-item">
                                    <div class="dado-label">Parcelamento</div>
                                    <div class="dado-valor">${dados.valores.parcelas}x ${dados.valores.valorParcela ? 'de R$ ' + dados.valores.valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : ''}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            document.getElementById('dadosExtraidosCard').classList.remove('hidden');
        }
        
        // ==========================================
        // BUSCAR LEADS
        // ==========================================
        let timeoutBusca = null;
        
        async function buscarLeads(termo) {
            clearTimeout(timeoutBusca);
            
            const resultsDiv = document.getElementById('searchResults');
            
            if (termo.length < 2) {
                resultsDiv.classList.remove('show');
                return;
            }
            
            timeoutBusca = setTimeout(async () => {
                try {
                    const termoUpper = termo.toUpperCase();
                    
                    // Buscar leads
                    const snapshot = await db.collection('leads_crm')
                        .orderBy('nome')
                        .limit(50)
                        .get();
                    
                    const resultados = [];
                    
                    snapshot.docs.forEach(doc => {
                        const lead = doc.data();
                        const nome = (lead.nome || '').toUpperCase();
                        const cpf = (lead.cpf || '').replace(/\D/g, '');
                        const placa = (lead.placa || '').toUpperCase();
                        const termoBusca = termo.replace(/\D/g, '');
                        
                        if (nome.includes(termoUpper) || 
                            cpf.includes(termoBusca) ||
                            placa.includes(termoUpper)) {
                            resultados.push({
                                id: doc.id,
                                ...lead
                            });
                        }
                    });
                    
                    if (resultados.length > 0) {
                        resultsDiv.innerHTML = resultados.slice(0, 10).map(lead => `
                            <div class="search-result-item" onclick="selecionarLead('${lead.id}', '${lead.nome}', '${lead.cpf || ''}')">
                                <div class="search-result-name">${lead.nome}</div>
                                <div class="search-result-info">
                                    ${lead.cpf ? 'CPF: ' + lead.cpf : ''} 
                                    ${lead.placa ? '| Placa: ' + lead.placa : ''}
                                    ${lead.telefone ? '| ' + lead.telefone : ''}
                                </div>
                            </div>
                        `).join('');
                        resultsDiv.classList.add('show');
                    } else {
                        resultsDiv.innerHTML = '<div class="search-result-item"><em>Nenhum lead encontrado</em></div>';
                        resultsDiv.classList.add('show');
                    }
                    
                } catch (error) {
                    console.error('Erro na busca:', error);
                }
            }, 300);
        }
        
        function selecionarLead(id, nome, cpf) {
            leadSelecionadoId = id;
            
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('searchLeadInput').value = '';
            
            document.getElementById('leadSelecionado').innerHTML = `
                <span class="icon">‚úÖ</span>
                <span><strong>${nome}</strong> ${cpf ? '(' + cpf + ')' : ''}</span>
                <span class="remove" onclick="removerLeadSelecionado()">‚úï</span>
            `;
            document.getElementById('leadSelecionado').classList.remove('hidden');
        }
        
        function removerLeadSelecionado() {
            leadSelecionadoId = null;
            document.getElementById('leadSelecionado').classList.add('hidden');
        }
        
        // Fechar resultados ao clicar fora
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-lead')) {
                document.getElementById('searchResults').classList.remove('show');
            }
        });
        
        // ==========================================
        // SALVAR PROPOSTA
        // ==========================================
        async function salvarProposta() {
            if (!dadosPropostaAtual) {
                mostrarStatus('error', 'Nenhuma proposta para salvar.');
                return;
            }
            
            mostrarStatus('info', 'üíæ Salvando proposta...');
            
            try {
                const propostaData = {
                    ...dadosPropostaAtual,
                    leadId: leadSelecionadoId || null,
                    usuarioId: auth.currentUser.uid,
                    usuarioEmail: auth.currentUser.email,
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'processada'
                };
                
                // Salvar na cole√ß√£o propostas
                const docRef = await db.collection('propostas').add(propostaData);
                
                // Se vinculado a um lead, atualizar o lead
                if (leadSelecionadoId) {
                    await db.collection('leads_crm').doc(leadSelecionadoId).update({
                        ultimaPropostaId: docRef.id,
                        ultimaProposta: {
                            seguradora: dadosPropostaAtual.seguradora,
                            numero: dadosPropostaAtual.proposta.numero,
                            premioTotal: dadosPropostaAtual.valores.premioTotal,
                            vigenciaInicio: dadosPropostaAtual.proposta.vigenciaInicio,
                            vigenciaFim: dadosPropostaAtual.proposta.vigenciaFim
                        },
                        atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                mostrarStatus('success', '‚úÖ Proposta salva com sucesso!');
                carregarHistorico();
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                mostrarStatus('error', `‚ùå Erro ao salvar: ${error.message}`);
            }
        }
        
        // ==========================================
        // CARREGAR HIST√ìRICO
        // ==========================================
        async function carregarHistorico() {
            const container = document.getElementById('historicoPropostas');
            
            try {
                let snapshot;
                try {
                    snapshot = await db.collection('propostas')
                        .orderBy('criadoEm', 'desc')
                        .limit(20)
                        .get();
                } catch (e) {
                    // Fallback sem ordena√ß√£o
                    snapshot = await db.collection('propostas')
                        .limit(20)
                        .get();
                }
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üìÑ</div>
                            <p>Nenhuma proposta processada ainda</p>
                        </div>
                    `;
                    return;
                }
                
                const iconsSeguradoras = {
                    'porto': 'üîµ',
                    'azul': 'üü¢',
                    'hdi': 'üü†',
                    'tokio': 'üî¥',
                    'bradesco': 'üî¥',
                    'yelum': 'üü£',
                    'allianz': 'üîµ',
                    'mapfre': 'üî¥',
                    'liberty': 'üü¢',
                    'suhai': 'üü°'
                };
                
                container.innerHTML = snapshot.docs.map(doc => {
                    const p = doc.data();
                    const icon = iconsSeguradoras[p.seguradora] || 'üìÑ';
                    const nome = p.segurado?.nome || 'Sem nome';
                    const placa = p.veiculo?.placa || '';
                    const premio = p.valores?.premioTotal || p.valores?.premioLiquido || 0;
                    const data = p.criadoEm?.toDate ? p.criadoEm.toDate().toLocaleDateString('pt-BR') : '';
                    
                    return `
                        <div class="historico-item" onclick="verProposta('${doc.id}')">
                            <div class="historico-icon seguradora-${p.seguradora}">${icon}</div>
                            <div class="historico-info">
                                <div class="historico-nome">${nome}</div>
                                <div class="historico-detalhes">${p.seguradora?.toUpperCase()} ${placa ? '| ' + placa : ''}</div>
                            </div>
                            <div class="historico-valor">
                                <div class="historico-premio">R$ ${premio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                <div class="historico-data">${data}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <p>Erro ao carregar hist√≥rico</p>
                    </div>
                `;
            }
        }
        
        function verProposta(id) {
            // TODO: Implementar visualiza√ß√£o detalhada
            alert('Ver proposta: ' + id);
        }
        
        // ==========================================
        // UTILIT√ÅRIOS
        // ==========================================
        function mostrarStatus(tipo, mensagem) {
            const container = document.getElementById('statusContainer');
            container.innerHTML = `
                <div class="status-message ${tipo}">
                    ${tipo === 'info' ? '<div class="spinner"></div>' : ''}
                    ${mensagem}
                </div>
            `;
            container.classList.remove('hidden');
        }
        
        function limparDados() {
            dadosPropostaAtual = null;
            leadSelecionadoId = null;
            textoExtraido = '';
            
            document.getElementById('dadosExtraidosCard').classList.add('hidden');
            document.getElementById('statusContainer').classList.add('hidden');
            document.getElementById('leadSelecionado').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            
            uploadArea.classList.remove('processing', 'success');
        }
    </script>
</body>
</html>
