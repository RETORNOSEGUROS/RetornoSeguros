<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguidores Instagram - Admin CRM</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .instagram-header {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .instagram-header h1 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            margin: 0;
        }

        .instagram-header .stats {
            display: flex;
            gap: 2rem;
        }

        .instagram-header .stat-item {
            text-align: center;
        }

        .instagram-header .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .instagram-header .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .filters-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters-bar input,
        .filters-bar select {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .filters-bar input {
            min-width: 250px;
        }

        .badge-verificado {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-verificado.sim {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-verificado.nao {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .btn-instagram {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .btn-instagram:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-verificar {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-verificar.confirmar {
            background: var(--success);
            color: white;
        }

        .btn-verificar.remover {
            background: var(--danger);
            color: white;
        }

        .btn-verificar:hover {
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .instagram-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .instagram-link:hover {
            text-decoration: underline;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .telefone-link {
            color: var(--text-primary);
            text-decoration: none;
        }

        .telefone-link:hover {
            color: #25d366;
        }

        @media (max-width: 768px) {
            .instagram-header {
                flex-direction: column;
                text-align: center;
            }

            .instagram-header .stats {
                width: 100%;
                justify-content: center;
            }

            .filters-bar {
                flex-direction: column;
            }

            .filters-bar input {
                width: 100%;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../img/logo-retorno.png" alt="Retorno Seguros" onerror="this.style.display='none'">
            <h2>CRM Seguros</h2>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <span class="nav-section-title">Principal</span>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="leads.html" class="nav-item">
                    <i class="fas fa-funnel-dollar"></i>
                    <span>Leads / Pipeline</span>
                    <span class="nav-badge" id="leadsNovos">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Gest√£o</span>
                <a href="clientes.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
                <a href="apolices.html" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Ap√≥lices</span>
                </a>
                <a href="indicacoes.html" class="nav-item">
                    <i class="fas fa-gift"></i>
                    <span>Indica√ß√µes</span>
                </a>
                <a href="renovacoes.html" class="nav-item">
                    <i class="fas fa-sync-alt"></i>
                    <span>Renova√ß√µes</span>
                    <span class="nav-badge" id="renovacoesPendentes">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Benefici√°rios</span>
                <a href="empresas-clientes.html" class="nav-item">
                    <i class="fas fa-building"></i>
                    <span>Empresas Clientes</span>
                </a>
                <a href="movimentacoes.html" class="nav-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Movimenta√ß√µes</span>
                    <span class="nav-badge" id="movimentacoesPendentes">0</span>
                </a>
                <a href="importar-beneficiarios.html" class="nav-item">
                    <i class="fas fa-file-import"></i>
                    <span>Importar Planilha</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Parceiros</span>
                <a href="parceiros.html" class="nav-item">
                    <i class="fas fa-handshake"></i>
                    <span>Empresas Parceiras</span>
                </a>
                <a href="resgates-parceiros.html" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Resgates</span>
                    <span class="nav-badge" id="resgatesPendentes">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Campanhas</span>
                <a href="seguidores-instagram.html" class="nav-item active">
                    <i class="fab fa-instagram"></i>
                    <span>Seguidores Instagram</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Equipe</span>
                <a href="funcionarios.html" class="nav-item">
                    <i class="fas fa-user-tie"></i>
                    <span>Funcion√°rios</span>
                </a>
                <a href="relatorios.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relat√≥rios</span>
                </a>
                <a href="relatorio-desistentes.html" class="nav-item">
                    <i class="fas fa-user-times"></i>
                    <span>Desistentes</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Sistema</span>
                <a href="configuracoes.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configura√ß√µes</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Carregando...</div>
                    <div class="user-role">Administrador</div>
                </div>
                <button class="btn-logout" onclick="fazerLogout()" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Mobile Toggle -->
    <button class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header Instagram -->
        <div class="instagram-header">
            <h1>
                <i class="fab fa-instagram"></i>
                Seguidores Instagram - Promo√ß√£o 10 Anos
            </h1>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalCadastros">0</div>
                    <div class="stat-label">Cadastros</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalVerificados">0</div>
                    <div class="stat-label">Verificados</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalPendentes">0</div>
                    <div class="stat-label">Pendentes</div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-bar">
            <input type="text" id="filtroNome" placeholder="üîç Buscar por nome ou @instagram..." onkeyup="filtrarLista()">
            <select id="filtroStatus" onchange="filtrarLista()">
                <option value="todos">Todos</option>
                <option value="pendente">Pendentes</option>
                <option value="verificado">Verificados</option>
            </select>
            <button class="btn btn-secondary" onclick="exportarCSV()">
                <i class="fas fa-download"></i> Exportar CSV
            </button>
        </div>

        <!-- Tabela -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Instagram</th>
                                <th>Telefone</th>
                                <th>Data Cadastro</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaSeguidores">
                            <tr>
                                <td colspan="6" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:a59dc2c9edff29a66f5b2f"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Vari√°veis globais
        let seguidores = [];

        // Verificar autentica√ß√£o
        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // Buscar dados do usu√°rio
            try {
                const userDoc = await db.collection('admins_crm').where('email', '==', user.email).get();
                if (!userDoc.empty) {
                    const userData = userDoc.docs[0].data();
                    document.getElementById('userName').textContent = userData.nome || user.email;
                    document.getElementById('userAvatar').textContent = (userData.nome || user.email).charAt(0).toUpperCase();
                } else {
                    document.getElementById('userName').textContent = user.email;
                    document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                }
            } catch (e) {
                document.getElementById('userName').textContent = user.email;
                document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
            }
            
            await carregarDados();
        });

        // Carregar dados
        async function carregarDados() {
            try {
                const snapshot = await db.collection('seguidores_instagram')
                    .orderBy('dataCadastro', 'desc')
                    .get();
                
                seguidores = [];
                snapshot.forEach(doc => {
                    seguidores.push({ id: doc.id, ...doc.data() });
                });

                atualizarEstatisticas();
                renderizarTabela();

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                mostrarToast('Erro ao carregar dados', 'error');
            }
        }

        // Atualizar estat√≠sticas
        function atualizarEstatisticas() {
            const total = seguidores.length;
            const verificados = seguidores.filter(s => s.verificado === true).length;
            const pendentes = total - verificados;

            document.getElementById('totalCadastros').textContent = total;
            document.getElementById('totalVerificados').textContent = verificados;
            document.getElementById('totalPendentes').textContent = pendentes;
        }

        // Renderizar tabela
        function renderizarTabela() {
            const tbody = document.getElementById('tabelaSeguidores');
            const filtroNome = document.getElementById('filtroNome').value.toLowerCase();
            const filtroStatus = document.getElementById('filtroStatus').value;

            let lista = seguidores.filter(s => {
                const matchNome = s.nome.toLowerCase().includes(filtroNome) || 
                                  s.instagram.toLowerCase().includes(filtroNome);
                
                let matchStatus = true;
                if (filtroStatus === 'pendente') matchStatus = !s.verificado;
                if (filtroStatus === 'verificado') matchStatus = s.verificado;

                return matchNome && matchStatus;
            });

            if (lista.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i class="fab fa-instagram"></i>
                                <p>Nenhum seguidor encontrado</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = lista.map(s => {
                const data = s.dataCadastro?.toDate ? s.dataCadastro.toDate() : new Date();
                const dataFormatada = data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                const telefoneFormatado = formatarTelefone(s.telefone);

                return `
                    <tr>
                        <td><strong>${s.nome}</strong></td>
                        <td>
                            <a href="https://instagram.com/${s.instagram}" target="_blank" class="instagram-link">
                                @${s.instagram}
                            </a>
                        </td>
                        <td>
                            <a href="https://wa.me/55${s.telefone}" target="_blank" class="telefone-link" title="Abrir WhatsApp">
                                ${telefoneFormatado}
                            </a>
                        </td>
                        <td>${dataFormatada}</td>
                        <td>
                            <span class="badge-verificado ${s.verificado ? 'sim' : 'nao'}">
                                <i class="fas fa-${s.verificado ? 'check-circle' : 'clock'}"></i>
                                ${s.verificado ? 'Verificado' : 'Pendente'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="https://instagram.com/${s.instagram}" target="_blank" class="btn-instagram" title="Ver perfil no Instagram">
                                    <i class="fab fa-instagram"></i> Ver Perfil
                                </a>
                                ${s.verificado ? `
                                    <button class="btn-verificar remover" onclick="alternarVerificacao('${s.id}', false)" title="Remover verifica√ß√£o">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : `
                                    <button class="btn-verificar confirmar" onclick="alternarVerificacao('${s.id}', true)" title="Confirmar que segue">
                                        <i class="fas fa-check"></i> Verificar
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Formatar telefone
        function formatarTelefone(tel) {
            if (!tel) return '-';
            const numeros = tel.replace(/\D/g, '');
            if (numeros.length === 11) {
                return `(${numeros.slice(0,2)}) ${numeros.slice(2,7)}-${numeros.slice(7)}`;
            } else if (numeros.length === 10) {
                return `(${numeros.slice(0,2)}) ${numeros.slice(2,6)}-${numeros.slice(6)}`;
            }
            return tel;
        }

        // Filtrar lista
        function filtrarLista() {
            renderizarTabela();
        }

        // Alternar verifica√ß√£o
        async function alternarVerificacao(id, verificado) {
            try {
                await db.collection('seguidores_instagram').doc(id).update({
                    verificado: verificado,
                    dataVerificacao: verificado ? firebase.firestore.FieldValue.serverTimestamp() : null
                });

                // Atualiza localmente
                const index = seguidores.findIndex(s => s.id === id);
                if (index !== -1) {
                    seguidores[index].verificado = verificado;
                }

                atualizarEstatisticas();
                renderizarTabela();
                mostrarToast(verificado ? 'Seguidor verificado!' : 'Verifica√ß√£o removida', 'success');

            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao atualizar', 'error');
            }
        }

        // Exportar CSV
        function exportarCSV() {
            const filtroStatus = document.getElementById('filtroStatus').value;
            let lista = seguidores;
            
            if (filtroStatus === 'pendente') lista = seguidores.filter(s => !s.verificado);
            if (filtroStatus === 'verificado') lista = seguidores.filter(s => s.verificado);

            const headers = ['Nome', 'Instagram', 'Telefone', 'Data Cadastro', 'Verificado'];
            const rows = lista.map(s => {
                const data = s.dataCadastro?.toDate ? s.dataCadastro.toDate().toLocaleDateString('pt-BR') : '';
                return [
                    s.nome,
                    '@' + s.instagram,
                    s.telefone,
                    data,
                    s.verificado ? 'Sim' : 'N√£o'
                ];
            });

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `seguidores_instagram_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();

            mostrarToast('CSV exportado!', 'success');
        }

        // Toast
        function mostrarToast(mensagem, tipo = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.className = `toast ${tipo} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Logout
        function fazerLogout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // Mobile toggle
        document.getElementById('mobileToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });
    </script>
</body>
</html>
