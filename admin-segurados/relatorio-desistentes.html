<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads Desistentes | Retorno Seguros CRM</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .stat-card.warning .stat-value { color: #f59e0b; }
        .stat-card.danger .stat-value { color: #ef4444; }
        .stat-card.success .stat-value { color: #10b981; }
        
        .funnel-chart {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .funnel-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .funnel-bar {
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), #00b8d4);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 100px;
        }
        
        .funnel-bar:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 136, 170, 0.3);
        }
        
        .funnel-label {
            width: 120px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-right: 1rem;
        }
        
        .funnel-count {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .filter-section {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .filter-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .table-container {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .lead-desistente {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lead-desistente:hover {
            background: var(--bg-hover);
        }
        
        .etapa-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .etapa-1 { background: #fee2e2; color: #dc2626; }
        .etapa-2 { background: #fef3c7; color: #d97706; }
        .etapa-3 { background: #fef3c7; color: #d97706; }
        .etapa-4 { background: #d1fae5; color: #059669; }
        .etapa-5 { background: #d1fae5; color: #059669; }
        .etapa-6 { background: #dbeafe; color: #2563eb; }
        .etapa-7 { background: #dbeafe; color: #2563eb; }
        
        .ramo-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            background: var(--bg-light);
        }
        
        .tempo-abandono {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .btn-whatsapp {
            background: #25D366;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .btn-whatsapp:hover {
            background: #128C7E;
            transform: translateY(-1px);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../img/logo-retorno.png" alt="Retorno Seguros" onerror="this.style.display='none'">
            <h2>CRM Seguros</h2>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <span class="nav-section-title">Principal</span>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="leads.html" class="nav-item">
                    <i class="fas fa-funnel-dollar"></i>
                    <span>Leads / Pipeline</span>
                    <span class="nav-badge" id="leadsNovos">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Gest√£o</span>
                <a href="clientes.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
                <a href="apolices.html" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Ap√≥lices</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Equipe</span>
                <a href="funcionarios.html" class="nav-item">
                    <i class="fas fa-user-tie"></i>
                    <span>Funcion√°rios</span>
                </a>
                <a href="relatorios.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relat√≥rios</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Sistema</span>
                <a href="configuracoes.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configura√ß√µes</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="main-header">
            <button class="menu-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="header-title">
                <h1><i class="fas fa-user-slash"></i> Leads Desistentes</h1>
                <p>Acompanhe leads que n√£o finalizaram o question√°rio</p>
            </div>
            <div class="header-actions">
                <span id="userEmail"></span>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="content" id="content">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Carregando dados...</p>
            </div>
        </div>
    </main>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Dados
        let leadsDesistentes = [];
        let filtroRamo = 'todos';
        let filtroPeriodo = '30';

        // Auth
        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('userEmail').textContent = user.email;
            await carregarDados();
        });

        async function carregarDados() {
            try {
                // Carregar leads parciais das 3 cole√ß√µes
                const colecoes = [
                    { nome: 'leads_cotacao_auto', ramo: 'auto', icon: 'üöó' },
                    { nome: 'leads_cotacao_vida', ramo: 'vida', icon: '‚ù§Ô∏è' },
                    { nome: 'leads_cotacao_residencial', ramo: 'residencial', icon: 'üè†' }
                ];
                
                leadsDesistentes = [];
                
                for (const col of colecoes) {
                    try {
                        const snap = await db.collection(col.nome)
                            .where('status', '==', 'parcial')
                            .orderBy('ultimaAtualizacao', 'desc')
                            .limit(100)
                            .get();
                        
                        snap.forEach(doc => {
                            const data = doc.data();
                            leadsDesistentes.push({
                                id: doc.id,
                                colecao: col.nome,
                                ramo: col.ramo,
                                icon: col.icon,
                                ...data
                            });
                        });
                    } catch (e) {
                        console.log(`Cole√ß√£o ${col.nome} n√£o existe ou erro:`, e.message);
                    }
                }
                
                // Ordenar por data mais recente
                leadsDesistentes.sort((a, b) => {
                    const dataA = a.ultimaAtualizacao?.toDate?.() || new Date(0);
                    const dataB = b.ultimaAtualizacao?.toDate?.() || new Date(0);
                    return dataB - dataA;
                });
                
                renderizar();
                
            } catch (error) {
                console.error('Erro ao carregar:', error);
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Erro ao carregar dados</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderizar() {
            // Aplicar filtros
            let leadsFiltrados = [...leadsDesistentes];
            
            if (filtroRamo !== 'todos') {
                leadsFiltrados = leadsFiltrados.filter(l => l.ramo === filtroRamo);
            }
            
            const agora = new Date();
            const diasFiltro = parseInt(filtroPeriodo);
            if (diasFiltro > 0) {
                leadsFiltrados = leadsFiltrados.filter(l => {
                    const data = l.ultimaAtualizacao?.toDate?.() || new Date(0);
                    const diffDias = (agora - data) / (1000 * 60 * 60 * 24);
                    return diffDias <= diasFiltro;
                });
            }
            
            // Calcular estat√≠sticas
            const total = leadsFiltrados.length;
            const comWhatsapp = leadsFiltrados.filter(l => l.whatsapp).length;
            const etapas = {};
            leadsFiltrados.forEach(l => {
                const etapa = l.ultimoStep || 1;
                etapas[etapa] = (etapas[etapa] || 0) + 1;
            });
            
            // Encontrar etapa com mais desist√™ncias
            let etapaCritica = 1;
            let maxDesistencias = 0;
            Object.entries(etapas).forEach(([etapa, count]) => {
                if (count > maxDesistencias) {
                    maxDesistencias = count;
                    etapaCritica = parseInt(etapa);
                }
            });
            
            // Calcular taxa de recupera√ß√£o (placeholder - baseado em whatsapp dispon√≠vel)
            const taxaRecuperacao = total > 0 ? Math.round((comWhatsapp / total) * 100) : 0;
            
            document.getElementById('content').innerHTML = `
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card warning">
                        <div class="stat-value">${total}</div>
                        <div class="stat-label">Leads Desistentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${comWhatsapp}</div>
                        <div class="stat-label">Com WhatsApp</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-value">Etapa ${etapaCritica}</div>
                        <div class="stat-label">Maior Abandono</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value">${taxaRecuperacao}%</div>
                        <div class="stat-label">Potencial Recupera√ß√£o</div>
                    </div>
                </div>
                
                <!-- Funil de Abandono -->
                <div class="funnel-chart">
                    <h3 style="margin-bottom: 1rem; color: var(--text-primary);">üìä Funil de Abandono por Etapa</h3>
                    ${renderizarFunil(etapas, total)}
                </div>
                
                <!-- Filtros -->
                <div class="filter-section">
                    <div class="filter-group">
                        <span class="filter-label">Produto</span>
                        <select class="form-control" onchange="filtroRamo = this.value; renderizar()">
                            <option value="todos" ${filtroRamo === 'todos' ? 'selected' : ''}>Todos</option>
                            <option value="auto" ${filtroRamo === 'auto' ? 'selected' : ''}>üöó Auto</option>
                            <option value="vida" ${filtroRamo === 'vida' ? 'selected' : ''}>‚ù§Ô∏è Vida</option>
                            <option value="residencial" ${filtroRamo === 'residencial' ? 'selected' : ''}>üè† Residencial</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Per√≠odo</span>
                        <select class="form-control" onchange="filtroPeriodo = this.value; renderizar()">
                            <option value="7" ${filtroPeriodo === '7' ? 'selected' : ''}>√öltimos 7 dias</option>
                            <option value="30" ${filtroPeriodo === '30' ? 'selected' : ''}>√öltimos 30 dias</option>
                            <option value="90" ${filtroPeriodo === '90' ? 'selected' : ''}>√öltimos 90 dias</option>
                            <option value="0" ${filtroPeriodo === '0' ? 'selected' : ''}>Todo per√≠odo</option>
                        </select>
                    </div>
                    <div style="margin-left: auto;">
                        <button class="btn btn-primary" onclick="exportarCSV()">
                            <i class="fas fa-download"></i> Exportar CSV
                        </button>
                    </div>
                </div>
                
                <!-- Tabela -->
                <div class="table-container">
                    ${leadsFiltrados.length === 0 ? `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <h3>Nenhum lead desistente</h3>
                            <p>√ìtimo! Todos os leads est√£o finalizando o question√°rio.</p>
                        </div>
                    ` : `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Produto</th>
                                    <th>Etapa</th>
                                    <th>Data</th>
                                    <th>WhatsApp</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leadsFiltrados.map(lead => `
                                    <tr class="lead-desistente">
                                        <td>
                                            <strong>${lead.nome || 'Sem nome'}</strong>
                                        </td>
                                        <td>
                                            <span class="ramo-badge">
                                                ${lead.icon} ${lead.ramo.charAt(0).toUpperCase() + lead.ramo.slice(1)}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="etapa-badge etapa-${lead.ultimoStep || 1}">
                                                Etapa ${lead.ultimoStep || 1}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="tempo-abandono">
                                                ${formatarTempoDecorrido(lead.ultimaAtualizacao?.toDate?.())}
                                            </span>
                                        </td>
                                        <td>
                                            ${lead.whatsapp ? `
                                                <span style="color: #25D366;">
                                                    <i class="fab fa-whatsapp"></i> 
                                                    ${formatarWhatsapp(lead.whatsapp)}
                                                </span>
                                            ` : '<span style="color: var(--text-muted);">-</span>'}
                                        </td>
                                        <td>
                                            ${lead.whatsapp ? `
                                                <button class="btn-whatsapp" onclick="enviarWhatsapp('${lead.whatsapp}', '${lead.nome}', '${lead.ramo}')">
                                                    <i class="fab fa-whatsapp"></i> Contatar
                                                </button>
                                            ` : `
                                                <span style="color: var(--text-muted); font-size: 0.85rem;">
                                                    Sem contato
                                                </span>
                                            `}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            `;
        }

        function renderizarFunil(etapas, total) {
            if (total === 0) return '<p style="color: var(--text-muted);">Sem dados para exibir</p>';
            
            const maxEtapa = Math.max(...Object.keys(etapas).map(Number), 7);
            let html = '';
            
            for (let i = 1; i <= maxEtapa; i++) {
                const count = etapas[i] || 0;
                const percent = total > 0 ? Math.round((count / total) * 100) : 0;
                const width = Math.max(10, percent);
                
                html += `
                    <div class="funnel-step">
                        <span class="funnel-label">Etapa ${i}</span>
                        <div class="funnel-bar" style="width: ${width}%; ${count === 0 ? 'opacity: 0.3;' : ''}">
                            <span>${count} leads</span>
                            <span class="funnel-count">${percent}%</span>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }

        function formatarTempoDecorrido(data) {
            if (!data) return '-';
            
            const agora = new Date();
            const diff = agora - data;
            const minutos = Math.floor(diff / 60000);
            const horas = Math.floor(diff / 3600000);
            const dias = Math.floor(diff / 86400000);
            
            if (minutos < 60) return `${minutos} min atr√°s`;
            if (horas < 24) return `${horas}h atr√°s`;
            if (dias === 1) return 'Ontem';
            if (dias < 7) return `${dias} dias atr√°s`;
            if (dias < 30) return `${Math.floor(dias / 7)} semanas atr√°s`;
            return data.toLocaleDateString('pt-BR');
        }

        function formatarWhatsapp(numero) {
            if (!numero) return '';
            const limpo = numero.replace(/\D/g, '');
            if (limpo.length === 11) {
                return `(${limpo.slice(0,2)}) ${limpo.slice(2,7)}-${limpo.slice(7)}`;
            }
            return numero;
        }

        function enviarWhatsapp(numero, nome, ramo) {
            const limpo = numero.replace(/\D/g, '');
            const primeiroNome = (nome || 'Cliente').split(' ')[0];
            
            const mensagens = {
                'auto': `Ol√° ${primeiroNome}! üëã\n\nVi que voc√™ come√ßou a cotar seu seguro auto no nosso site mas n√£o finalizou.\n\nPosso ajudar com alguma d√∫vida? Estamos aqui para encontrar a melhor prote√ß√£o para seu ve√≠culo! üöó`,
                'vida': `Ol√° ${primeiroNome}! üëã\n\nVi que voc√™ come√ßou a cotar seu seguro de vida no nosso site mas n√£o finalizou.\n\nPosso ajudar com alguma d√∫vida? √â muito importante garantir a prote√ß√£o da sua fam√≠lia! ‚ù§Ô∏è`,
                'residencial': `Ol√° ${primeiroNome}! üëã\n\nVi que voc√™ come√ßou a cotar seu seguro residencial no nosso site mas n√£o finalizou.\n\nPosso ajudar com alguma d√∫vida? Proteger seu lar √© fundamental! üè†`
            };
            
            const mensagem = mensagens[ramo] || mensagens['auto'];
            window.open(`https://wa.me/55${limpo}?text=${encodeURIComponent(mensagem)}`, '_blank');
        }

        function exportarCSV() {
            let csv = 'Nome,Produto,Etapa,WhatsApp,Data\n';
            
            leadsDesistentes.forEach(lead => {
                const data = lead.ultimaAtualizacao?.toDate?.()?.toLocaleDateString('pt-BR') || '-';
                csv += `"${lead.nome || 'Sem nome'}","${lead.ramo}","${lead.ultimoStep || 1}","${lead.whatsapp || '-'}","${data}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `leads-desistentes-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }
    </script>
</body>
</html>
