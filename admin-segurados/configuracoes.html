<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações - Retorno Seguros CRM</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../img/logo-retorno.png" alt="Retorno Seguros" onerror="this.style.display='none'">
            <h2>CRM Seguros</h2>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <span class="nav-section-title">Principal</span>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="leads.html" class="nav-item">
                    <i class="fas fa-funnel-dollar"></i>
                    <span>Leads / Pipeline</span>
                    <span class="nav-badge" id="leadsNovos">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Gestão</span>
                <a href="clientes.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
                <a href="apolices.html" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Apólices</span>
                </a>
                <a href="indicacoes.html" class="nav-item">
                    <i class="fas fa-gift"></i>
                    <span>Indicações</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Equipe</span>
                <a href="funcionarios.html" class="nav-item">
                    <i class="fas fa-user-tie"></i>
                    <span>Funcionários</span>
                </a>
                <a href="relatorios.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relatórios</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Sistema</span>
                <a href="configuracoes.html" class="nav-item active">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span id="userEmail">admin@retorno.com</span>
            </div>
            <button class="btn-logout" onclick="fazerLogout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </aside>

    <!-- Mobile Toggle -->
    <button class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <main class="main-content">
        <header class="page-header">
            <div class="header-left">
                <h1><i class="fas fa-cog"></i> Configurações</h1>
                <p>Configurações do sistema CRM</p>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-tab="geral">
                    <i class="fas fa-sliders-h"></i> Geral
                </button>
                <button class="tab" data-tab="notificacoes">
                    <i class="fas fa-bell"></i> Notificações
                </button>
                <button class="tab" data-tab="comissoes">
                    <i class="fas fa-percentage"></i> Comissões
                </button>
                <button class="tab" data-tab="seguradoras">
                    <i class="fas fa-building"></i> Seguradoras
                </button>
                <button class="tab" data-tab="sistema">
                    <i class="fas fa-database"></i> Sistema
                </button>
            </div>
        </div>

        <!-- Tab: Geral -->
        <div class="tab-content active" id="tab-geral">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-building"></i> Dados da Empresa</h3>
                </div>
                <div class="card-body">
                    <form id="formEmpresa">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="empresaNome">Nome da Empresa</label>
                                <input type="text" id="empresaNome" value="Retorno Seguros e Benefícios">
                            </div>
                            <div class="form-group">
                                <label for="empresaCNPJ">CNPJ</label>
                                <input type="text" id="empresaCNPJ" placeholder="00.000.000/0000-00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="empresaEmail">E-mail Principal</label>
                                <input type="email" id="empresaEmail" value="contato@retornoseguros.com.br">
                            </div>
                            <div class="form-group">
                                <label for="empresaTelefone">Telefone</label>
                                <input type="tel" id="empresaTelefone" placeholder="(00) 0000-0000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="whatsappPF">WhatsApp Pessoa Física</label>
                                <input type="tel" id="whatsappPF" placeholder="(00) 00000-0000">
                            </div>
                            <div class="form-group">
                                <label for="whatsappPJ">WhatsApp Pessoa Jurídica</label>
                                <input type="tel" id="whatsappPJ" placeholder="(00) 00000-0000">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="salvarEmpresa()">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-clock"></i> Configurações de Prazo</h3>
                </div>
                <div class="card-body">
                    <form id="formPrazos">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="prazoAlertaLead">Alerta de Lead Parado (dias)</label>
                                <input type="number" id="prazoAlertaLead" value="7" min="1" max="30">
                                <small>Leads sem movimentação por este período serão destacados</small>
                            </div>
                            <div class="form-group">
                                <label for="prazoRenovacao">Alerta de Renovação (dias)</label>
                                <input type="number" id="prazoRenovacao" value="30" min="7" max="90">
                                <small>Apólices vencendo dentro deste período aparecerão nos alertas</small>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="salvarPrazos()">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tab: Notificações -->
        <div class="tab-content" id="tab-notificacoes">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-envelope"></i> Notificações por E-mail</h3>
                </div>
                <div class="card-body">
                    <div class="settings-list">
                        <div class="settings-item">
                            <div class="settings-info">
                                <strong>Novo lead recebido</strong>
                                <p>Receber e-mail quando um novo lead for criado pelo site</p>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="notifNovoLead" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-info">
                                <strong>Lead parado</strong>
                                <p>Receber alerta quando um lead ficar sem movimentação</p>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="notifLeadParado" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-info">
                                <strong>Renovação próxima</strong>
                                <p>Receber lembrete de apólices próximas do vencimento</p>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="notifRenovacao" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-info">
                                <strong>Negócio fechado</strong>
                                <p>Receber notificação quando um negócio for fechado</p>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="notifFechado">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="salvarNotificacoes()">
                        <i class="fas fa-save"></i> Salvar Configurações
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-at"></i> Destinatários de Notificações</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="emailsNotificacao">E-mails para Notificação</label>
                        <textarea id="emailsNotificacao" rows="3" placeholder="Um e-mail por linha"></textarea>
                        <small>Estes e-mails receberão as notificações do sistema</small>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="salvarDestinatarios()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab: Comissões -->
        <div class="tab-content" id="tab-comissoes">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-percentage"></i> Comissões Padrão por Ramo</h3>
                </div>
                <div class="card-body">
                    <form id="formComissoes">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="comissaoAuto">Auto (%)</label>
                                <input type="number" id="comissaoAuto" value="20" min="0" max="100" step="0.5">
                            </div>
                            <div class="form-group">
                                <label for="comissaoResidencial">Residencial (%)</label>
                                <input type="number" id="comissaoResidencial" value="25" min="0" max="100" step="0.5">
                            </div>
                            <div class="form-group">
                                <label for="comissaoVida">Vida (%)</label>
                                <input type="number" id="comissaoVida" value="40" min="0" max="100" step="0.5">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="comissaoEmpresarial">Empresarial (%)</label>
                                <input type="number" id="comissaoEmpresarial" value="15" min="0" max="100" step="0.5">
                            </div>
                            <div class="form-group">
                                <label for="comissaoSaude">Saúde (%)</label>
                                <input type="number" id="comissaoSaude" value="5" min="0" max="100" step="0.5">
                            </div>
                            <div class="form-group">
                                <label for="comissaoOutros">Outros (%)</label>
                                <input type="number" id="comissaoOutros" value="20" min="0" max="100" step="0.5">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="salvarComissoes()">
                            <i class="fas fa-save"></i> Salvar Comissões
                        </button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-hand-holding-usd"></i> Repasse para Corretor</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="repasseCorretor">Percentual de Repasse (%)</label>
                        <input type="number" id="repasseCorretor" value="50" min="0" max="100" step="1">
                        <small>Percentual da comissão que é repassado ao corretor responsável</small>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="salvarRepasse()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab: Seguradoras -->
        <div class="tab-content" id="tab-seguradoras">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-building"></i> Seguradoras Cadastradas</h3>
                    <button class="btn btn-sm btn-primary" onclick="abrirModalSeguradora()">
                        <i class="fas fa-plus"></i> Adicionar
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Seguradora</th>
                                    <th>Código SUSEP</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaSeguradoras">
                                <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Sistema -->
        <div class="tab-content" id="tab-sistema">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-info-circle"></i> Informações do Sistema</h3>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Versão do Sistema</label>
                            <span>1.0.0</span>
                        </div>
                        <div class="info-item">
                            <label>Projeto Firebase</label>
                            <span>retorno-seguros</span>
                        </div>
                        <div class="info-item">
                            <label>Ambiente</label>
                            <span>Produção</span>
                        </div>
                        <div class="info-item">
                            <label>Último Deploy</label>
                            <span id="ultimoDeploy">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-database"></i> Estatísticas do Banco</h3>
                </div>
                <div class="card-body">
                    <div class="stats-mini-grid" id="estatisticasBanco">
                        <div class="stats-mini-item">
                            <i class="fas fa-funnel-dollar"></i>
                            <div>
                                <span class="value" id="totalLeads">0</span>
                                <span class="label">Leads</span>
                            </div>
                        </div>
                        <div class="stats-mini-item">
                            <i class="fas fa-users"></i>
                            <div>
                                <span class="value" id="totalClientes">0</span>
                                <span class="label">Clientes</span>
                            </div>
                        </div>
                        <div class="stats-mini-item">
                            <i class="fas fa-file-contract"></i>
                            <div>
                                <span class="value" id="totalApolices">0</span>
                                <span class="label">Apólices</span>
                            </div>
                        </div>
                        <div class="stats-mini-item">
                            <i class="fas fa-user-tie"></i>
                            <div>
                                <span class="value" id="totalFuncionarios">0</span>
                                <span class="label">Funcionários</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-history"></i> Logs de Acesso Recentes</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaLogs">
                                <tr><td colspan="3" class="text-center">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card card-danger">
                <div class="card-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Zona de Perigo</h3>
                </div>
                <div class="card-body">
                    <p class="text-muted">Ações que podem afetar permanentemente os dados do sistema.</p>
                    <div class="danger-actions">
                        <button class="btn btn-danger" onclick="limparLeadsAntigos()">
                            <i class="fas fa-trash"></i> Limpar Leads Antigos
                        </button>
                        <button class="btn btn-danger" onclick="exportarDados()">
                            <i class="fas fa-download"></i> Exportar Todos os Dados
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Seguradora -->
    <div class="modal-overlay" id="modalSeguradora">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-building"></i> Adicionar Seguradora</h3>
                <button class="modal-close" onclick="fecharModal('modalSeguradora')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formSeguradora">
                    <div class="form-group">
                        <label for="seguradoraNome">Nome da Seguradora *</label>
                        <input type="text" id="seguradoraNome" required>
                    </div>
                    <div class="form-group">
                        <label for="seguradoraCodigo">Código SUSEP</label>
                        <input type="text" id="seguradoraCodigo">
                    </div>
                    <div class="form-group">
                        <label for="seguradoraStatus">Status</label>
                        <select id="seguradoraStatus">
                            <option value="ativa">Ativa</option>
                            <option value="inativa">Inativa</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="fecharModal('modalSeguradora')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarSeguradora()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:a59dc2c9edff29a66f5b2f"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Lista padrão de seguradoras
        const seguradorasPadrao = [
            { nome: 'Porto Seguro', codigo: '61198164000160', ativa: true },
            { nome: 'Bradesco Seguros', codigo: '51014223000171', ativa: true },
            { nome: 'SulAmérica', codigo: '33000118000179', ativa: true },
            { nome: 'Itaú Seguros', codigo: '61557039000107', ativa: true },
            { nome: 'Allianz', codigo: '61573796000166', ativa: true },
            { nome: 'Liberty Seguros', codigo: '61550141000172', ativa: true },
            { nome: 'Tokio Marine', codigo: '33164021000100', ativa: true },
            { nome: 'HDI Seguros', codigo: '29980158000157', ativa: true },
            { nome: 'Zurich', codigo: '33170085000105', ativa: true },
            { nome: 'Mapfre', codigo: '61074175000138', ativa: true },
            { nome: 'Sompo', codigo: '33000188000176', ativa: true },
            { nome: 'Caixa Seguradora', codigo: '34020354000110', ativa: true },
            { nome: 'BB Seguros', codigo: '01522368000182', ativa: true },
            { nome: 'Santander Auto', codigo: '90665000000191', ativa: true },
            { nome: 'Azul Seguros', codigo: '40210128000139', ativa: true }
        ];

        let seguradoras = [];

        // Verificar autenticação
        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            document.getElementById('userEmail').textContent = user.email;
            await carregarDados();
            configurarTabs();
        });

        // Carregar dados
        async function carregarDados() {
            try {
                // Carregar configurações
                const configDoc = await db.collection('configuracoes').doc('geral').get();
                if (configDoc.exists) {
                    const config = configDoc.data();
                    preencherFormularios(config);
                }

                // Carregar seguradoras
                const snapSeg = await db.collection('seguradoras').orderBy('nome').get();
                seguradoras = [];
                snapSeg.forEach(doc => {
                    seguradoras.push({ id: doc.id, ...doc.data() });
                });

                // Se não houver seguradoras, usar padrão
                if (seguradoras.length === 0) {
                    seguradoras = seguradorasPadrao.map((s, i) => ({ id: `temp_${i}`, ...s }));
                }

                renderizarSeguradoras();
                await carregarEstatisticas();
                await carregarLogs();

                // Badge leads
                const snapLeads = await db.collection('leads_crm').where('status', '==', 'pre_cadastro').get();
                const badge = document.getElementById('leadsNovos');
                if (snapLeads.size > 0) {
                    badge.textContent = snapLeads.size;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                mostrarToast('Erro ao carregar configurações', 'error');
            }
        }

        // Preencher formulários com configurações
        function preencherFormularios(config) {
            if (config.empresa) {
                document.getElementById('empresaNome').value = config.empresa.nome || '';
                document.getElementById('empresaCNPJ').value = config.empresa.cnpj || '';
                document.getElementById('empresaEmail').value = config.empresa.email || '';
                document.getElementById('empresaTelefone').value = config.empresa.telefone || '';
                document.getElementById('whatsappPF').value = config.empresa.whatsappPF || '';
                document.getElementById('whatsappPJ').value = config.empresa.whatsappPJ || '';
            }

            if (config.prazos) {
                document.getElementById('prazoAlertaLead').value = config.prazos.alertaLead || 7;
                document.getElementById('prazoRenovacao').value = config.prazos.renovacao || 30;
            }

            if (config.notificacoes) {
                document.getElementById('notifNovoLead').checked = config.notificacoes.novoLead !== false;
                document.getElementById('notifLeadParado').checked = config.notificacoes.leadParado !== false;
                document.getElementById('notifRenovacao').checked = config.notificacoes.renovacao !== false;
                document.getElementById('notifFechado').checked = config.notificacoes.fechado === true;
                document.getElementById('emailsNotificacao').value = (config.notificacoes.emails || []).join('\n');
            }

            if (config.comissoes) {
                document.getElementById('comissaoAuto').value = config.comissoes.auto || 20;
                document.getElementById('comissaoResidencial').value = config.comissoes.residencial || 25;
                document.getElementById('comissaoVida').value = config.comissoes.vida || 40;
                document.getElementById('comissaoEmpresarial').value = config.comissoes.empresarial || 15;
                document.getElementById('comissaoSaude').value = config.comissoes.saude || 5;
                document.getElementById('comissaoOutros').value = config.comissoes.outros || 20;
                document.getElementById('repasseCorretor').value = config.comissoes.repasseCorretor || 50;
            }
        }

        // Configurar tabs
        function configurarTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                });
            });
        }

        // Carregar estatísticas do banco
        async function carregarEstatisticas() {
            try {
                const [leads, clientes, apolices, funcionarios] = await Promise.all([
                    db.collection('leads_crm').get(),
                    db.collection('usuarios').get(),
                    db.collection('apolices_cliente').get(),
                    db.collection('admins_crm').get()
                ]);

                document.getElementById('totalLeads').textContent = leads.size;
                document.getElementById('totalClientes').textContent = clientes.size;
                document.getElementById('totalApolices').textContent = apolices.size;
                document.getElementById('totalFuncionarios').textContent = funcionarios.size;

            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Carregar logs de acesso
        async function carregarLogs() {
            try {
                const snap = await db.collection('logs_acesso')
                    .orderBy('dataHora', 'desc')
                    .limit(10)
                    .get();

                const tbody = document.getElementById('tabelaLogs');

                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhum log registrado</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const log = doc.data();
                    const data = log.dataHora?.toDate 
                        ? log.dataHora.toDate().toLocaleString('pt-BR')
                        : '-';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${data}</td>
                            <td>${log.email || '-'}</td>
                            <td>${log.tipo || 'login'}</td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error('Erro ao carregar logs:', error);
            }
        }

        // Renderizar seguradoras
        function renderizarSeguradoras() {
            const tbody = document.getElementById('tabelaSeguradoras');
            
            tbody.innerHTML = seguradoras.map(seg => `
                <tr>
                    <td><strong>${seg.nome}</strong></td>
                    <td>${seg.codigo || '-'}</td>
                    <td>
                        <span class="status-badge ${seg.ativa !== false ? 'status-fechado' : 'status-perdido'}">
                            ${seg.ativa !== false ? 'Ativa' : 'Inativa'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="toggleSeguradora('${seg.id}', ${seg.ativa !== false})">
                            <i class="fas fa-${seg.ativa !== false ? 'ban' : 'check'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Salvar empresa
        async function salvarEmpresa() {
            const dados = {
                empresa: {
                    nome: document.getElementById('empresaNome').value,
                    cnpj: document.getElementById('empresaCNPJ').value,
                    email: document.getElementById('empresaEmail').value,
                    telefone: document.getElementById('empresaTelefone').value,
                    whatsappPF: document.getElementById('whatsappPF').value,
                    whatsappPJ: document.getElementById('whatsappPJ').value
                }
            };

            try {
                await db.collection('configuracoes').doc('geral').set(dados, { merge: true });
                mostrarToast('Dados da empresa salvos!', 'success');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao salvar', 'error');
            }
        }

        // Salvar prazos
        async function salvarPrazos() {
            const dados = {
                prazos: {
                    alertaLead: parseInt(document.getElementById('prazoAlertaLead').value) || 7,
                    renovacao: parseInt(document.getElementById('prazoRenovacao').value) || 30
                }
            };

            try {
                await db.collection('configuracoes').doc('geral').set(dados, { merge: true });
                mostrarToast('Prazos salvos!', 'success');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao salvar', 'error');
            }
        }

        // Salvar notificações
        async function salvarNotificacoes() {
            const dados = {
                notificacoes: {
                    novoLead: document.getElementById('notifNovoLead').checked,
                    leadParado: document.getElementById('notifLeadParado').checked,
                    renovacao: document.getElementById('notifRenovacao').checked,
                    fechado: document.getElementById('notifFechado').checked
                }
            };

            try {
                await db.collection('configuracoes').doc('geral').set(dados, { merge: true });
                mostrarToast('Notificações salvas!', 'success');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao salvar', 'error');
            }
        }

        // Salvar destinatários
        async function salvarDestinatarios() {
            const emails = document.getElementById('emailsNotificacao').value
                .split('\n')
                .map(e => e.trim())
                .filter(e => e);

            const dados = {
                notificacoes: { emails }
            };

            try {
                await db.collection('configuracoes').doc('geral').set(dados, { merge: true });
                mostrarToast('Destinatários salvos!', 'success');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao salvar', 'error');
            }
        }

        // Salvar comissões
        async function salvarComissoes() {
            const dados = {
                comissoes: {
                    auto: parseFloat(document.getElementById('comissaoAuto').value) || 20,
                    residencial: parseFloat(document.getElementById('comissaoResidencial').value) || 25,
                    vida: parseFloat(document.getElementById('comissaoVida').value) || 40,
                    empresarial: parseFloat(document.getElementById('comissaoEmpresarial').value) || 15,
                    saude: parseFloat(document.getElementById('comissaoSaude').value) || 5,
                    outros: parseFloat(document.getElementById('comissaoOutros').value) || 20
                }
            };

            try {
                await db.collection('configuracoes').doc('geral').set(dados, { merge: true });
                mostrarToast('Comissões salvas!', 'success');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao salvar', 'error');
            }
        }

        // Salvar repasse
        async function salvarRepasse() {
            const dados = {
                comissoes: {
                    repasseCorretor: parseFloat(document.getElementById('repasseCorretor').value) || 50
                }
            };

            try {
                await db.collection('configuracoes').doc('geral').set(dados, { merge: true });
                mostrarToast('Repasse salvo!', 'success');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao salvar', 'error');
            }
        }

        // Abrir modal seguradora
        function abrirModalSeguradora() {
            document.getElementById('formSeguradora').reset();
            document.getElementById('modalSeguradora').classList.add('active');
        }

        // Salvar seguradora
        async function salvarSeguradora() {
            const nome = document.getElementById('seguradoraNome').value.trim();
            const codigo = document.getElementById('seguradoraCodigo').value.trim();
            const ativa = document.getElementById('seguradoraStatus').value === 'ativa';

            if (!nome) {
                mostrarToast('Informe o nome da seguradora', 'error');
                return;
            }

            try {
                await db.collection('seguradoras').add({
                    nome,
                    codigo,
                    ativa,
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });

                fecharModal('modalSeguradora');
                mostrarToast('Seguradora adicionada!', 'success');
                await carregarDados();

            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao salvar', 'error');
            }
        }

        // Toggle status seguradora
        async function toggleSeguradora(id, atualmenteAtiva) {
            if (id.startsWith('temp_')) {
                mostrarToast('Seguradoras padrão não podem ser alteradas', 'warning');
                return;
            }

            try {
                await db.collection('seguradoras').doc(id).update({
                    ativa: !atualmenteAtiva
                });
                mostrarToast('Status alterado!', 'success');
                await carregarDados();
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao alterar status', 'error');
            }
        }

        // Limpar leads antigos
        async function limparLeadsAntigos() {
            if (!confirm('Tem certeza que deseja limpar leads antigos (perdidos há mais de 6 meses)?')) {
                return;
            }

            mostrarToast('Funcionalidade em desenvolvimento', 'warning');
        }

        // Exportar dados
        async function exportarDados() {
            mostrarToast('Exportação em desenvolvimento', 'warning');
        }

        // Fechar modal
        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Mostrar toast
        function mostrarToast(mensagem, tipo = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.className = `toast ${tipo} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Logout
        function fazerLogout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // Mobile toggle
        document.getElementById('mobileToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });

        // Fechar modais com ESC
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
            }
        });

        // Fechar modais clicando fora
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', e => {
                if (e.target === overlay) overlay.classList.remove('active');
            });
        });
    </script>

    <style>
        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            background: var(--dark-lighter);
            padding: 5px;
            border-radius: 8px;
            overflow-x: auto;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.05);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--dark-lighter);
            border-radius: 8px;
        }

        .settings-info strong {
            display: block;
            margin-bottom: 5px;
        }

        .settings-info p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 0;
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--dark);
            transition: 0.3s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle input:checked + .slider {
            background-color: var(--primary);
        }

        .toggle input:checked + .slider:before {
            transform: translateX(22px);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-item label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .info-item span {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .stats-mini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stats-mini-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--dark-lighter);
            border-radius: 8px;
        }

        .stats-mini-item i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .stats-mini-item .value {
            display: block;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .stats-mini-item .label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .card-danger {
            border: 1px solid var(--danger);
        }

        .card-danger .card-header {
            color: var(--danger);
        }

        .danger-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</body>
</html>
