<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Indica√ß√µes | Admin CRM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin-style.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.appspot.com",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29",
            measurementId: "G-C6E44WXLPW"
        };
        
        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
    
    <style>
        /* Estilos espec√≠ficos da p√°gina de indica√ß√µes */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1a3a4a 0%, #0d2331 100%);
            border-radius: 16px;
            padding: 25px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .stat-card:nth-child(1) .stat-icon { background: rgba(59, 130, 246, 0.3); color: #60a5fa; }
        .stat-card:nth-child(2) .stat-icon { background: rgba(16, 185, 129, 0.3); color: #34d399; }
        .stat-card:nth-child(3) .stat-icon { background: rgba(245, 158, 11, 0.3); color: #fbbf24; }
        .stat-card:nth-child(4) .stat-icon { background: rgba(139, 92, 246, 0.3); color: #a78bfa; }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Se√ß√µes */
        .section-card {
            background: #1a3a4a;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .section-title {
            font-size: 1.3rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #00b8d4;
        }
        
        /* Filtros */
        .filtros-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filtro-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
        }
        
        .filtro-select, .filtro-input {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #2d4a5a;
            background: #0d2331;
            color: #fff;
            font-size: 0.9rem;
            min-width: 150px;
        }
        
        .filtro-select:focus, .filtro-input:focus {
            outline: none;
            border-color: #00b8d4;
        }
        
        /* Tabela */
        .table-container {
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: #0d2331;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #94a3b8;
            font-size: 0.85rem;
            text-transform: uppercase;
            border-bottom: 2px solid #2d4a5a;
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #2d4a5a;
            color: #e2e8f0;
        }
        
        .data-table tr:hover {
            background: rgba(0, 184, 212, 0.05);
        }
        
        /* Badge de C√≥digo */
        .codigo-badge {
            background: linear-gradient(135deg, #0088aa, #00b8d4);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: 1px;
            display: inline-block;
        }
        
        /* Status badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-ativo { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .status-pendente { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .status-convertido { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        
        /* Ramo badges */
        .ramo-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .ramo-auto { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .ramo-residencial { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .ramo-vida { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
        .ramo-empresarial { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        
        /* Bot√µes de a√ß√£o */
        .btn-action {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-whatsapp {
            background: #25D366;
            color: white;
        }
        
        .btn-whatsapp:hover {
            background: #1da851;
        }
        
        .btn-gerar {
            background: #0088aa;
            color: white;
        }
        
        .btn-gerar:hover {
            background: #006680;
        }
        
        .btn-ver {
            background: #3b82f6;
            color: white;
        }
        
        .btn-ver:hover {
            background: #2563eb;
        }
        
        .btn-copiar {
            background: #64748b;
            color: white;
        }
        
        .btn-copiar:hover {
            background: #475569;
        }
        
        /* Top Indicadores */
        .top-indicadores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .top-card {
            background: #0d2331;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 4px solid;
        }
        
        .top-card:nth-child(1) { border-color: #fbbf24; }
        .top-card:nth-child(2) { border-color: #94a3b8; }
        .top-card:nth-child(3) { border-color: #cd7f32; }
        
        .top-position {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .top-card:nth-child(1) .top-position { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .top-card:nth-child(2) .top-position { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }
        .top-card:nth-child(3) .top-position { background: rgba(205, 127, 50, 0.2); color: #cd7f32; }
        
        .top-info {
            flex: 1;
        }
        
        .top-nome {
            font-weight: 600;
            color: #fff;
            margin-bottom: 3px;
        }
        
        .top-stats {
            font-size: 0.85rem;
            color: #94a3b8;
        }
        
        .top-valor {
            text-align: right;
        }
        
        .top-valor-numero {
            font-size: 1.3rem;
            font-weight: 700;
            color: #10b981;
        }
        
        .top-valor-label {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: #1a3a4a;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: #fff;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-close:hover {
            color: #fff;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #2d4a5a;
            background: #0d2331;
            color: #fff;
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #00b8d4;
        }
        
        .btn-submit {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #0088aa, #00b8d4);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 136, 170, 0.4);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #1a3a4a;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        
        .toast.show {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.warning { border-left: 4px solid #f59e0b; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #64748b;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #2d4a5a;
            border-top-color: #00b8d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filtros-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filtro-group {
                width: 100%;
            }
            
            .filtro-select, .filtro-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="../img/logo-retorno.png" alt="Retorno Seguros" class="sidebar-logo" onerror="this.style.display='none'">
            <h2>Admin CRM</h2>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-chart-line"></i> Dashboard
            </a>
            <a href="leads.html" class="nav-item">
                <i class="fas fa-users"></i> Leads
                <span class="badge" id="leadsNovos">0</span>
            </a>
            <a href="clientes.html" class="nav-item">
                <i class="fas fa-user-check"></i> Clientes
            </a>
            <a href="apolices.html" class="nav-item">
                <i class="fas fa-file-contract"></i> Ap√≥lices
            </a>
            <a href="indicacoes.html" class="nav-item active">
                <i class="fas fa-gift"></i> Indica√ß√µes
            </a>
            <a href="relatorios.html" class="nav-item">
                <i class="fas fa-chart-bar"></i> Relat√≥rios
            </a>
            <a href="funcionarios.html" class="nav-item">
                <i class="fas fa-user-tie"></i> Funcion√°rios
            </a>
            <a href="configuracoes.html" class="nav-item">
                <i class="fas fa-cog"></i> Configura√ß√µes
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span id="userName">Admin</span>
            </div>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="page-header">
            <div>
                <h1><i class="fas fa-gift"></i> Gest√£o de Indica√ß√µes</h1>
                <p>Gerencie indicadores e acompanhe resultados</p>
            </div>
            <button class="btn btn-primary" onclick="abrirModalNovoIndicador()">
                <i class="fas fa-plus"></i> Novo Indicador
            </button>
        </header>

        <!-- Estat√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-value" id="totalIndicadores">0</div>
                <div class="stat-label">Indicadores Ativos</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-paper-plane"></i></div>
                <div class="stat-value" id="totalIndicacoes">0</div>
                <div class="stat-label">Total de Indica√ß√µes</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-value" id="totalConvertidas">0</div>
                <div class="stat-label">Convertidas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="stat-value" id="valorGerado">R$ 0</div>
                <div class="stat-label">Valor Gerado</div>
            </div>
        </div>

        <!-- Top Indicadores -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-trophy"></i> Top Indicadores
                </div>
            </div>
            <div class="top-indicadores" id="topIndicadores">
                <!-- Preenchido via JS -->
            </div>
        </div>

        <!-- Lista de Indicadores -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-list"></i> Indicadores Cadastrados
                </div>
                <div class="filtros-row">
                    <div class="filtro-group">
                        <span class="filtro-label">Buscar</span>
                        <input type="text" class="filtro-input" id="filtroNome" placeholder="Nome ou c√≥digo..." onkeyup="filtrarIndicadores()">
                    </div>
                    <div class="filtro-group">
                        <span class="filtro-label">Origem</span>
                        <select class="filtro-select" id="filtroOrigem" onchange="filtrarIndicadores()">
                            <option value="">Todas</option>
                            <option value="site">Site</option>
                            <option value="admin">Admin</option>
                            <option value="lead">Lead</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nome</th>
                            <th>Telefone</th>
                            <th>Indica√ß√µes</th>
                            <th>Convertidas</th>
                            <th>Valor</th>
                            <th>Origem</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaIndicadores">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>
            </div>
            
            <div class="empty-state" id="emptyIndicadores" style="display: none;">
                <i class="fas fa-users-slash"></i>
                <p>Nenhum indicador encontrado</p>
            </div>
        </div>

        <!-- Indica√ß√µes Recentes (Leads indicados) -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-clock"></i> Indica√ß√µes Recentes
                </div>
                <div class="filtros-row">
                    <div class="filtro-group">
                        <span class="filtro-label">Per√≠odo</span>
                        <select class="filtro-select" id="filtroPeriodo" onchange="carregarIndicacoesRecentes()">
                            <option value="7">√öltimos 7 dias</option>
                            <option value="30" selected>√öltimos 30 dias</option>
                            <option value="90">√öltimos 90 dias</option>
                            <option value="0">Todos</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <span class="filtro-label">Ramo</span>
                        <select class="filtro-select" id="filtroRamo" onchange="carregarIndicacoesRecentes()">
                            <option value="">Todos</option>
                            <option value="auto">Auto</option>
                            <option value="residencial">Residencial</option>
                            <option value="vida">Vida</option>
                            <option value="empresarial">Empresarial</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Indicador</th>
                            <th>Lead Indicado</th>
                            <th>Ramo</th>
                            <th>Status</th>
                            <th>Valor</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaIndicacoes">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>
            </div>
            
            <div class="empty-state" id="emptyIndicacoes" style="display: none;">
                <i class="fas fa-inbox"></i>
                <p>Nenhuma indica√ß√£o encontrada no per√≠odo</p>
            </div>
        </div>
    </main>

    <!-- Modal Novo Indicador -->
    <div class="modal" id="modalNovoIndicador">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-plus"></i> Novo Indicador</h3>
                <button class="modal-close" onclick="fecharModal('modalNovoIndicador')">&times;</button>
            </div>
            
            <form id="formNovoIndicador" onsubmit="return salvarNovoIndicador(event)">
                <div class="form-group">
                    <label class="form-label">Nome Completo *</label>
                    <input type="text" class="form-control" id="novoNome" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Telefone (WhatsApp) *</label>
                    <input type="tel" class="form-control" id="novoTelefone" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">E-mail (opcional)</label>
                    <input type="email" class="form-control" id="novoEmail">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observa√ß√µes</label>
                    <textarea class="form-control" id="novoObs" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn-submit">
                    <i class="fas fa-magic"></i> Gerar C√≥digo e Salvar
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Enviar WhatsApp -->
    <div class="modal" id="modalWhatsApp">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fab fa-whatsapp"></i> Enviar C√≥digo via WhatsApp</h3>
                <button class="modal-close" onclick="fecharModal('modalWhatsApp')">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">C√≥digo do Indicador</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span class="codigo-badge" id="whatsappCodigo" style="font-size: 1.5rem;">---</span>
                    <button class="btn-action btn-copiar" onclick="copiarCodigoWhatsApp()">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mensagem</label>
                <textarea class="form-control" id="whatsappMensagem" rows="6"></textarea>
            </div>
            
            <button class="btn-submit" style="background: #25D366;" onclick="enviarWhatsAppIndicador()">
                <i class="fab fa-whatsapp"></i> Enviar WhatsApp
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Loading -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>

    <script>
        // ============================================================
        // INICIALIZA√á√ÉO
        // ============================================================
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let indicadoresCache = [];
        let leadsIndicadosCache = [];
        let indicadorSelecionado = null;
        
        // Verifica autentica√ß√£o
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            document.getElementById('userName').textContent = user.email.split('@')[0];
            
            // Carrega dados
            await carregarEstatisticas();
            await carregarIndicadores();
            await carregarIndicacoesRecentes();
            carregarLeadsNovos();
        });
        
        // ============================================================
        // CARREGAR ESTAT√çSTICAS (CALCULADO EM TEMPO REAL)
        // ============================================================
        async function carregarEstatisticas() {
            try {
                // Carregar todos os indicadores
                const indicadoresSnap = await db.collection('indicadores').get();
                
                // Carregar todos os leads indicados (leads_crm com indicadoPorCodigo)
                const leadsSnap = await db.collection('leads_crm').get();
                leadsIndicadosCache = [];
                leadsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.indicadoPorCodigo) {
                        leadsIndicadosCache.push({ id: doc.id, ...data });
                    }
                });
                
                console.log('Leads indicados encontrados:', leadsIndicadosCache.length);
                
                // Filtrar indicadores ativos
                const indicadoresAtivos = indicadoresSnap.docs.filter(doc => {
                    const data = doc.data();
                    return data.ativo !== false;
                });
                
                document.getElementById('totalIndicadores').textContent = indicadoresAtivos.length;
                
                // Calcular totais baseado nos leads reais
                let totalIndicacoes = 0;
                let totalConvertidas = 0;
                let valorTotal = 0;
                
                // Criar mapa de estat√≠sticas por c√≥digo de indicador
                const estatsPorCodigo = {};
                
                leadsIndicadosCache.forEach(lead => {
                    const codigo = lead.indicadoPorCodigo?.toUpperCase();
                    if (!codigo) return;
                    
                    if (!estatsPorCodigo[codigo]) {
                        estatsPorCodigo[codigo] = {
                            totalIndicacoes: 0,
                            indicacoesConvertidas: 0,
                            valorGerado: 0
                        };
                    }
                    
                    estatsPorCodigo[codigo].totalIndicacoes++;
                    totalIndicacoes++;
                    
                    // Verificar se o lead foi convertido (neg√≥cio fechado)
                    if (lead.status === 'negocio_fechado') {
                        estatsPorCodigo[codigo].indicacoesConvertidas++;
                        totalConvertidas++;
                        
                        // Somar valor do pr√™mio
                        const valorPremio = parseFloat(lead.valorPremio) || 0;
                        estatsPorCodigo[codigo].valorGerado += valorPremio;
                        valorTotal += valorPremio;
                    }
                });
                
                console.log('Estat√≠sticas por c√≥digo:', estatsPorCodigo);
                
                document.getElementById('totalIndicacoes').textContent = totalIndicacoes;
                document.getElementById('totalConvertidas').textContent = totalConvertidas;
                document.getElementById('valorGerado').textContent = formatarMoeda(valorTotal);
                
                // Top indicadores com estat√≠sticas calculadas
                const topIndicadores = indicadoresAtivos
                    .map(doc => {
                        const data = doc.data();
                        const codigo = data.codigoIndicacao?.toUpperCase();
                        const stats = estatsPorCodigo[codigo] || { totalIndicacoes: 0, indicacoesConvertidas: 0, valorGerado: 0 };
                        
                        return { 
                            id: doc.id, 
                            ...data,
                            totalIndicacoes: stats.totalIndicacoes,
                            indicacoesConvertidas: stats.indicacoesConvertidas,
                            valorGerado: stats.valorGerado
                        };
                    })
                    .sort((a, b) => (b.valorGerado || 0) - (a.valorGerado || 0) || (b.indicacoesConvertidas || 0) - (a.indicacoesConvertidas || 0))
                    .slice(0, 3);
                
                renderizarTopIndicadores(topIndicadores);
                
                // Salvar estat√≠sticas calculadas para uso em outras fun√ß√µes
                window.estatsPorCodigo = estatsPorCodigo;
                
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }
        
        // ============================================================
        // RENDERIZAR TOP INDICADORES
        // ============================================================
        function renderizarTopIndicadores(top) {
            const container = document.getElementById('topIndicadores');
            
            if (top.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Nenhum indicador com convers√µes ainda</p></div>';
                return;
            }
            
            container.innerHTML = top.map((ind, i) => `
                <div class="top-card">
                    <div class="top-position">${i + 1}¬∞</div>
                    <div class="top-info">
                        <div class="top-nome">${ind.nome || 'Sem nome'}</div>
                        <div class="top-stats">
                            <span class="codigo-badge" style="font-size: 0.75rem; padding: 3px 8px;">${ind.codigoIndicacao}</span>
                            ${ind.totalIndicacoes || 0} indica√ß√µes ‚Ä¢ ${ind.indicacoesConvertidas || 0} convertidas
                        </div>
                    </div>
                    <div class="top-valor">
                        <div class="top-valor-numero">${formatarMoeda(ind.valorGerado || 0)}</div>
                        <div class="top-valor-label">gerado</div>
                    </div>
                </div>
            `).join('');
        }
        
        // ============================================================
        // CARREGAR INDICADORES
        // ============================================================
        async function carregarIndicadores() {
            try {
                let snapshot;
                try {
                    // Tenta com ordena√ß√£o
                    snapshot = await db.collection('indicadores')
                        .orderBy('dataCadastro', 'desc')
                        .get();
                } catch (e) {
                    // Fallback sem ordena√ß√£o
                    console.log('Usando query sem ordena√ß√£o');
                    snapshot = await db.collection('indicadores').get();
                }
                
                // Mapear indicadores com estat√≠sticas calculadas em tempo real
                indicadoresCache = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const codigo = data.codigoIndicacao?.toUpperCase();
                    const stats = window.estatsPorCodigo?.[codigo] || { totalIndicacoes: 0, indicacoesConvertidas: 0, valorGerado: 0 };
                    
                    return { 
                        id: doc.id, 
                        ...data,
                        // Sobrescrever com valores calculados em tempo real
                        totalIndicacoes: stats.totalIndicacoes,
                        indicacoesConvertidas: stats.indicacoesConvertidas,
                        valorGerado: stats.valorGerado
                    };
                });
                
                filtrarIndicadores();
                
            } catch (error) {
                console.error('Erro ao carregar indicadores:', error);
            }
        }
        
        // ============================================================
        // FILTRAR INDICADORES
        // ============================================================
        function filtrarIndicadores() {
            const filtroNome = document.getElementById('filtroNome').value.toLowerCase();
            const filtroOrigem = document.getElementById('filtroOrigem').value;
            
            let filtrados = indicadoresCache.filter(ind => {
                const matchNome = !filtroNome || 
                    (ind.nome || '').toLowerCase().includes(filtroNome) ||
                    (ind.codigoIndicacao || '').toLowerCase().includes(filtroNome);
                const matchOrigem = !filtroOrigem || ind.origem === filtroOrigem;
                
                return matchNome && matchOrigem;
            });
            
            renderizarIndicadores(filtrados);
        }
        
        // ============================================================
        // RENDERIZAR INDICADORES
        // ============================================================
        function renderizarIndicadores(indicadores) {
            const tbody = document.getElementById('tabelaIndicadores');
            const empty = document.getElementById('emptyIndicadores');
            
            if (indicadores.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            
            tbody.innerHTML = indicadores.map(ind => {
                const origem = {
                    'site': '<span class="status-badge status-ativo">Site</span>',
                    'admin': '<span class="status-badge status-pendente">Admin</span>',
                    'lead': '<span class="status-badge status-convertido">Lead</span>'
                }[ind.origem] || '<span class="status-badge">-</span>';
                
                return `
                    <tr>
                        <td><span class="codigo-badge">${ind.codigoIndicacao || '-'}</span></td>
                        <td>${ind.nome || '-'}</td>
                        <td>${ind.telefoneFormatado || formatarTelefone(ind.telefone) || '-'}</td>
                        <td>${ind.totalIndicacoes || 0}</td>
                        <td>${ind.indicacoesConvertidas || 0}</td>
                        <td>${formatarMoeda(ind.valorGerado || 0)}</td>
                        <td>${origem}</td>
                        <td>
                            <button class="btn-action btn-whatsapp" onclick="abrirModalWhatsApp('${ind.id}')" title="Enviar WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button class="btn-action btn-copiar" onclick="copiarCodigo('${ind.codigoIndicacao}')" title="Copiar c√≥digo">
                                <i class="fas fa-copy"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ============================================================
        // CARREGAR INDICA√á√ïES RECENTES (LEADS INDICADOS)
        // ============================================================
        async function carregarIndicacoesRecentes() {
            try {
                const periodo = parseInt(document.getElementById('filtroPeriodo').value);
                const ramo = document.getElementById('filtroRamo').value;
                
                // Usar cache se dispon√≠vel, sen√£o carregar
                let leads = leadsIndicadosCache.length > 0 ? [...leadsIndicadosCache] : [];
                
                if (leads.length === 0) {
                    // Carregar leads indicados do Firebase
                    const snapshot = await db.collection('leads_crm').get();
                    leads = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.indicadoPorCodigo) {
                            leads.push({ id: doc.id, ...data });
                        }
                    });
                    leadsIndicadosCache = leads;
                }
                
                // Ordenar por data (mais recentes primeiro)
                leads.sort((a, b) => {
                    const dataA = a.dataCadastro?.toDate?.() || a.criadoEm?.toDate?.() || new Date(0);
                    const dataB = b.dataCadastro?.toDate?.() || b.criadoEm?.toDate?.() || new Date(0);
                    return dataB - dataA;
                });
                
                // Filtrar por per√≠odo
                if (periodo > 0) {
                    const dataLimite = new Date();
                    dataLimite.setDate(dataLimite.getDate() - periodo);
                    
                    leads = leads.filter(lead => {
                        const dataLead = lead.dataCadastro?.toDate?.() || lead.criadoEm?.toDate?.() || new Date(0);
                        return dataLead >= dataLimite;
                    });
                }
                
                // Filtrar por ramo
                if (ramo) {
                    leads = leads.filter(lead => lead.ramo === ramo);
                }
                
                console.log('Indica√ß√µes recentes encontradas:', leads.length);
                renderizarIndicacoesRecentes(leads.slice(0, 50));
                
            } catch (error) {
                console.error('Erro ao carregar indica√ß√µes:', error);
            }
        }
        
        async function carregarIndicacoesRecentesSimples() {
            // Fallback - chamar a fun√ß√£o principal
            await carregarIndicacoesRecentes();
        }
        
        // ============================================================
        // RENDERIZAR INDICA√á√ïES RECENTES
        // ============================================================
        function renderizarIndicacoesRecentes(leads) {
            const tbody = document.getElementById('tabelaIndicacoes');
            const empty = document.getElementById('emptyIndicacoes');
            
            if (leads.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            
            tbody.innerHTML = leads.map(lead => {
                // Pegar data do lead (pode ser dataCadastro ou criadoEm)
                const dataObj = lead.dataCadastro || lead.criadoEm;
                const data = dataObj?.toDate?.() || (dataObj ? new Date(dataObj) : new Date());
                
                const ramo = lead.ramo || 'auto';
                const ramoClass = `ramo-${ramo}`;
                const ramoLabel = {
                    'auto': 'üöó Auto',
                    'residencial': 'üè† Residencial',
                    'vida': 'üíö Vida',
                    'empresarial': 'üè¢ Empresarial'
                }[ramo] || ramo;
                
                const status = lead.status || 'novo';
                const statusClass = {
                    'novo': 'status-pendente',
                    'pre_cadastro': 'status-pendente',
                    'em_contato': 'status-ativo',
                    'contato_realizado': 'status-ativo',
                    'pendente_documentos': 'status-pendente',
                    'cotacao_enviada': 'status-convertido',
                    'negocio_fechado': 'status-ativo',
                    'perdido': 'status-badge',
                    'negocio_perdido': 'status-badge'
                }[status] || 'status-badge';
                
                const statusLabel = {
                    'novo': 'Novo',
                    'pre_cadastro': 'Pr√©-Cadastro',
                    'em_contato': 'Em Contato',
                    'contato_realizado': 'Contato Realizado',
                    'pendente_documentos': 'Pendente Docs',
                    'cotacao_enviada': 'Cota√ß√£o Enviada',
                    'negocio_fechado': 'Fechado ‚úì',
                    'perdido': 'Perdido',
                    'negocio_perdido': 'Perdido'
                }[status] || status;
                
                // Destacar se foi convertido
                const valorDisplay = lead.status === 'negocio_fechado' && lead.valorPremio 
                    ? `<strong style="color: #10b981;">${formatarMoeda(lead.valorPremio)}</strong>`
                    : (lead.valorPremio ? formatarMoeda(lead.valorPremio) : '-');
                
                return `
                    <tr>
                        <td>${formatarData(data)}</td>
                        <td>
                            <span class="codigo-badge" style="font-size: 0.75rem;">${lead.indicadoPorCodigo || '-'}</span>
                            <br><small style="color: #64748b;">${lead.indicadoPorNome || ''}</small>
                        </td>
                        <td>${lead.nome || '-'}</td>
                        <td><span class="ramo-badge ${ramoClass}">${ramoLabel}</span></td>
                        <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                        <td>${valorDisplay}</td>
                        <td>
                            <button class="btn-action btn-ver" onclick="verLead('${lead.id}')" title="Ver lead">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        }
        
        // ============================================================
        // MODAL NOVO INDICADOR
        // ============================================================
        function abrirModalNovoIndicador() {
            document.getElementById('formNovoIndicador').reset();
            document.getElementById('modalNovoIndicador').classList.add('show');
        }
        
        function fecharModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        // ============================================================
        // ALGORITMO DE GERA√á√ÉO DE C√ìDIGO
        // ============================================================
        function gerarCodigo(nome, telefone) {
            const primeiroNome = nome.trim().split(' ')[0].toUpperCase();
            const letras = primeiroNome.substring(0, 3).padEnd(3, 'X');
            const telLimpo = telefone.replace(/\D/g, '');
            const numeros = telLimpo.slice(-4);
            return letras + numeros;
        }
        
        // ============================================================
        // SALVAR NOVO INDICADOR
        // ============================================================
        async function salvarNovoIndicador(event) {
            event.preventDefault();
            
            const nome = document.getElementById('novoNome').value.trim();
            const telefone = document.getElementById('novoTelefone').value.trim();
            const email = document.getElementById('novoEmail').value.trim();
            const obs = document.getElementById('novoObs').value.trim();
            
            const telefoneLimpo = telefone.replace(/\D/g, '');
            
            if (telefoneLimpo.length < 10) {
                mostrarToast('Digite um telefone v√°lido', 'error');
                return false;
            }
            
            showLoading(true);
            
            try {
                // Verifica se j√° existe
                const queryExiste = await db.collection('indicadores')
                    .where('telefone', '==', telefoneLimpo)
                    .limit(1)
                    .get();
                
                if (!queryExiste.empty) {
                    showLoading(false);
                    mostrarToast('J√° existe um indicador com esse telefone!', 'warning');
                    return false;
                }
                
                // Gera c√≥digo
                let codigo = gerarCodigo(nome, telefoneLimpo);
                
                // Verifica se c√≥digo j√° existe
                const queryCodigo = await db.collection('indicadores')
                    .where('codigoIndicacao', '==', codigo)
                    .limit(1)
                    .get();
                
                if (!queryCodigo.empty) {
                    codigo = codigo + Math.floor(Math.random() * 10);
                }
                
                // Salva
                await db.collection('indicadores').add({
                    nome: nome,
                    telefone: telefoneLimpo,
                    telefoneFormatado: telefone,
                    codigoIndicacao: codigo,
                    email: email,
                    totalIndicacoes: 0,
                    indicacoesConvertidas: 0,
                    valorGerado: 0,
                    dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
                    ativo: true,
                    origem: 'admin',
                    observacoes: obs,
                    criadoPor: auth.currentUser.email
                });
                
                showLoading(false);
                fecharModal('modalNovoIndicador');
                mostrarToast(`Indicador criado! C√≥digo: ${codigo}`, 'success');
                
                // Recarrega dados
                await carregarEstatisticas();
                await carregarIndicadores();
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showLoading(false);
                mostrarToast('Erro ao salvar indicador', 'error');
            }
            
            return false;
        }
        
        // ============================================================
        // MODAL WHATSAPP
        // ============================================================
        function abrirModalWhatsApp(indicadorId) {
            const indicador = indicadoresCache.find(i => i.id === indicadorId);
            if (!indicador) return;
            
            indicadorSelecionado = indicador;
            
            document.getElementById('whatsappCodigo').textContent = indicador.codigoIndicacao;
            
            const mensagem = `Ol√° ${indicador.nome?.split(' ')[0] || ''}! üëã

Voc√™ sabia que pode indicar amigos e familiares para a Retorno Seguros e fazer parte da nossa rede de premia√ß√µes?

üéÅ Seu c√≥digo de indica√ß√£o: *${indicador.codigoIndicacao}*

Compartilhe este link com quem voc√™ quer indicar:
üëâ https://retornoseguros.vercel.app/indique-gerar.html?tel=${indicador.telefone}

Quanto mais indica√ß√µes, mais benef√≠cios voc√™ acumula!`;
            
            document.getElementById('whatsappMensagem').value = mensagem;
            document.getElementById('modalWhatsApp').classList.add('show');
        }
        
        function copiarCodigoWhatsApp() {
            const codigo = document.getElementById('whatsappCodigo').textContent;
            navigator.clipboard.writeText(codigo);
            mostrarToast('C√≥digo copiado!', 'success');
        }
        
        function enviarWhatsAppIndicador() {
            if (!indicadorSelecionado) return;
            
            const mensagem = document.getElementById('whatsappMensagem').value;
            const telefone = indicadorSelecionado.telefone;
            
            const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
            window.open(url, '_blank');
            
            fecharModal('modalWhatsApp');
        }
        
        // ============================================================
        // FUN√á√ïES AUXILIARES
        // ============================================================
        function copiarCodigo(codigo) {
            navigator.clipboard.writeText(codigo);
            mostrarToast('C√≥digo copiado!', 'success');
        }
        
        function verLead(leadId) {
            window.location.href = `lead-detalhe.html?id=${leadId}`;
        }
        
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor || 0);
        }
        
        function formatarData(data) {
            if (!data) return '-';
            return new Intl.DateTimeFormat('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            }).format(data);
        }
        
        function formatarTelefone(tel) {
            if (!tel) return '-';
            const limpo = tel.replace(/\D/g, '');
            if (limpo.length === 11) {
                return limpo.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            return tel;
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
        
        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.getElementById('toast');
            toast.className = `toast ${tipo} show`;
            toast.innerHTML = `<i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i> ${mensagem}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // M√°scara telefone
        document.getElementById('novoTelefone').addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 10) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{4,5})(\d{0,4})/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            }
            
            this.value = value;
        });
        
        // Badge leads novos
        async function carregarLeadsNovos() {
            try {
                const snapshot = await db.collection('leads_crm')
                    .where('status', '==', 'novo')
                    .get();
                document.getElementById('leadsNovos').textContent = snapshot.size;
            } catch (error) {
                console.error('Erro ao carregar leads novos:', error);
            }
        }
        
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }
    </script>
</body>
</html>
