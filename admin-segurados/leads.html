<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads - CRM Retorno Seguros</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos específicos para Pipeline */
        .view-toggle {
            display: flex;
            gap: 5px;
            background: var(--bg-light);
            padding: 4px;
            border-radius: var(--radius-sm);
        }
        .view-toggle button {
            padding: 8px 15px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .view-toggle button.active {
            background: var(--primary);
            color: white;
        }
        
        /* Pipeline View */
        .pipeline-view { display: none; }
        .pipeline-view.active { display: block; }
        
        /* List View */
        .list-view { display: none; }
        .list-view.active { display: block; }
        
        /* Drag and Drop */
        .lead-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }
        .pipeline-body.drag-over {
            background: rgba(0, 136, 170, 0.1);
            border: 2px dashed var(--primary);
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../img/logo-retorno.png" alt="Retorno Seguros" onerror="this.style.display='none'">
                <h2>CRM Seguros</h2>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">Principal</span>
                    <a href="dashboard.html" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="leads.html" class="nav-item active">
                        <i class="fas fa-funnel-dollar"></i>
                        <span>Leads / Pipeline</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Gestão</span>
                    <a href="clientes.html" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </a>
                    <a href="apolices.html" class="nav-item">
                        <i class="fas fa-file-contract"></i>
                        <span>Apólices</span>
                    </a>
                    <a href="renovacoes.html" class="nav-item">
                        <i class="fas fa-sync-alt"></i>
                        <span>Renovações</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Equipe</span>
                    <a href="funcionarios.html" class="nav-item">
                        <i class="fas fa-user-tie"></i>
                        <span>Funcionários</span>
                    </a>
                    <a href="relatorios.html" class="nav-item">
                        <i class="fas fa-chart-bar"></i>
                        <span>Relatórios</span>
                    </a>
                    <a href="relatorio-desistentes.html" class="nav-item">
                        <i class="fas fa-user-times"></i>
                        <span>Desistentes</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Sistema</span>
                    <a href="configuracoes.html" class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span>Configurações</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">P</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Carregando...</div>
                        <div class="user-role">Administrador</div>
                    </div>
                    <button class="btn-logout" onclick="logout()" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="mobile-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Pipeline de Leads</h1>
                </div>
                <div class="header-right">
                    <div class="view-toggle">
                        <button class="active" onclick="setView('pipeline')" id="btnPipeline">
                            <i class="fas fa-columns"></i> Pipeline
                        </button>
                        <button onclick="setView('list')" id="btnList">
                            <i class="fas fa-list"></i> Lista
                        </button>
                    </div>
                    <button class="btn btn-primary" onclick="abrirModalNovoLead()">
                        <i class="fas fa-plus"></i> Novo Lead
                    </button>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <!-- Filtros -->
                <div class="filters-bar">
                    <div class="filter-group">
                        <label>Ramo:</label>
                        <select id="filtroRamo" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="auto">Auto</option>
                            <option value="residencial">Residencial</option>
                            <option value="vida">Vida</option>
                            <option value="empresarial">Empresarial</option>
                            <option value="saude">Saúde</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Responsável:</label>
                        <select id="filtroResponsavel" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="nao_atribuido">Não Atribuído</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Período:</label>
                        <select id="filtroPeriodo" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="hoje">Hoje</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mês</option>
                            <option value="parado">Parado +7 dias</option>
                        </select>
                    </div>
                    <div class="filter-group" style="flex: 1;">
                        <label>Buscar:</label>
                        <input type="text" id="filtroBusca" placeholder="Nome, telefone, e-mail..." onkeyup="aplicarFiltros()">
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="limparFiltros()">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                </div>

                <!-- Pipeline View -->
                <div class="pipeline-view active" id="pipelineView">
                    <div class="pipeline-container" id="pipelineContainer">
                        <!-- Colunas serão geradas via JS -->
                    </div>
                </div>

                <!-- List View -->
                <div class="list-view" id="listView">
                    <div class="card">
                        <div class="card-body" style="padding: 0;">
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Contato</th>
                                            <th>Ramo</th>
                                            <th>Status</th>
                                            <th>Responsável</th>
                                            <th>Tempo Parado</th>
                                            <th>Valor</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leadsTableBody">
                                        <tr>
                                            <td colspan="8" class="loading">
                                                <div class="spinner"></div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Novo Lead -->
    <div class="modal-overlay" id="modalNovoLead">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user-plus"></i> Novo Lead</h2>
                <button class="modal-close" onclick="fecharModal('modalNovoLead')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formNovoLead">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="leadNome" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="leadEmail">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">WhatsApp *</label>
                            <input type="tel" class="form-control" id="leadWhatsapp" placeholder="(54) 99999-9999" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" id="leadCpf" placeholder="000.000.000-00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="leadNascimento">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="leadCep" placeholder="00000-000" onblur="buscarCep()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="leadCidade" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <input type="text" class="form-control" id="leadEstado" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ramo do Seguro *</label>
                            <select class="form-control" id="leadRamo" required>
                                <option value="">Selecione...</option>
                                <option value="auto">Auto</option>
                                <option value="residencial">Residencial</option>
                                <option value="vida">Vida</option>
                                <option value="empresarial">Empresarial</option>
                                <option value="saude">Saúde</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Responsável</label>
                            <select class="form-control" id="leadResponsavel">
                                <option value="">Não atribuído</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" id="leadObservacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalNovoLead')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarNovoLead()">
                    <i class="fas fa-save"></i> Salvar Lead
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Mover Lead -->
    <div class="modal-overlay" id="modalMoverLead">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-exchange-alt"></i> Mover Lead</h2>
                <button class="modal-close" onclick="fecharModal('modalMoverLead')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Mover <strong id="moverLeadNome">Lead</strong> para:</p>
                <div class="form-group">
                    <select class="form-control" id="novoStatus">
                        <option value="pre_cadastro">Pré-Cadastro</option>
                        <option value="contato_realizado">Contato Realizado</option>
                        <option value="pendente_documentos">Pendente de Documentos</option>
                        <option value="cotacao_enviada">Cotação Enviada</option>
                        <option value="recusada_seguradora">Recusada pela Seguradora</option>
                        <option value="negocio_fechado">Negócio Fechado</option>
                        <option value="negocio_perdido">Negócio Perdido</option>
                    </select>
                </div>
                
                <!-- Campos extras para Cotação Enviada -->
                <div id="camposCotacao" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Valor da Cotação (R$)</label>
                        <input type="number" class="form-control" id="valorCotacao" step="0.01" placeholder="0,00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seguradora</label>
                        <select class="form-control" id="seguradoraCotacao">
                            <option value="">Selecione...</option>
                            <option value="Porto Seguro">Porto Seguro</option>
                            <option value="Bradesco Seguros">Bradesco Seguros</option>
                            <option value="SulAmérica">SulAmérica</option>
                            <option value="Itaú Seguros">Itaú Seguros</option>
                            <option value="Allianz">Allianz</option>
                            <option value="Zurich">Zurich</option>
                            <option value="Liberty">Liberty Seguros</option>
                            <option value="HDI">HDI Seguros</option>
                            <option value="Mapfre">Mapfre</option>
                            <option value="Tokio Marine">Tokio Marine</option>
                            <option value="Outra">Outra</option>
                        </select>
                    </div>
                </div>

                <!-- Campos extras para Negócio Fechado -->
                <div id="camposFechado" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Valor do Prêmio (R$)</label>
                        <input type="number" class="form-control" id="valorPremio" step="0.01" placeholder="0,00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comissão (%)</label>
                        <input type="number" class="form-control" id="comissao" step="0.01" placeholder="Ex: 20">
                    </div>
                </div>

                <!-- Campo de observação -->
                <div class="form-group">
                    <label class="form-label">Observação</label>
                    <textarea class="form-control" id="observacaoMover" rows="2" placeholder="Opcional..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalMoverLead')">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarMoverLead()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29",
            measurementId: "G-C6E44WXLPW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Coleções
        const COLECOES = {
            leads: 'leads_crm',
            funcionarios: 'admins_crm',
            atividades: 'atividades_crm'
        };

        // Status do Pipeline
        const STATUS_PIPELINE = {
            'pre_cadastro': { label: 'Pré-Cadastro', classe: 'pre-cadastro', cor: '#6c757d' },
            'contato_realizado': { label: 'Contato Realizado', classe: 'contato', cor: '#17a2b8' },
            'pendente_documentos': { label: 'Pendente Docs', classe: 'pendente-doc', cor: '#ffc107' },
            'cotacao_enviada': { label: 'Cotação Enviada', classe: 'cotacao-enviada', cor: '#6f42c1' },
            'recusada_seguradora': { label: 'Recusada', classe: 'recusada', cor: '#fd7e14' },
            'negocio_fechado': { label: 'Fechado', classe: 'fechado', cor: '#28a745' },
            'negocio_perdido': { label: 'Perdido', classe: 'perdido', cor: '#dc3545' }
        };

        let usuarioAtual = null;
        let todosLeads = [];
        let leadsFiltrados = [];
        let leadParaMover = null;
        let viewAtual = 'pipeline';

        // Verificar autenticação
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            usuarioAtual = user;
            document.getElementById('userName').textContent = user.email.split('@')[0];
            document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
            
            // Verificar busca na URL
            const params = new URLSearchParams(window.location.search);
            const buscaUrl = params.get('busca');
            if (buscaUrl) {
                document.getElementById('filtroBusca').value = buscaUrl;
            }
            
            await carregarDados();
        });

        // Carregar dados
        async function carregarDados() {
            await Promise.all([
                carregarLeads(),
                carregarFuncionarios()
            ]);
        }

        // Carregar leads
        async function carregarLeads() {
            try {
                const snapshot = await db.collection(COLECOES.leads)
                    .orderBy('criadoEm', 'desc')
                    .get();
                
                todosLeads = [];
                snapshot.forEach(doc => {
                    todosLeads.push({ id: doc.id, ...doc.data() });
                });
                
                aplicarFiltros();
                
            } catch (error) {
                console.error('Erro ao carregar leads:', error);
                mostrarToast('Erro ao carregar leads', 'error');
            }
        }

        // Carregar funcionários
        async function carregarFuncionarios() {
            try {
                const snapshot = await db.collection(COLECOES.funcionarios)
                    .where('ativo', '==', true)
                    .get();
                
                const selectFiltro = document.getElementById('filtroResponsavel');
                const selectNovo = document.getElementById('leadResponsavel');
                
                snapshot.forEach(doc => {
                    const func = doc.data();
                    const nome = func.nome || func.email;
                    selectFiltro.innerHTML += `<option value="${doc.id}">${nome}</option>`;
                    selectNovo.innerHTML += `<option value="${doc.id}">${nome}</option>`;
                });
                
            } catch (error) {
                console.error('Erro ao carregar funcionários:', error);
            }
        }

        // Aplicar filtros
        function aplicarFiltros() {
            const ramo = document.getElementById('filtroRamo').value;
            const responsavel = document.getElementById('filtroResponsavel').value;
            const periodo = document.getElementById('filtroPeriodo').value;
            const busca = document.getElementById('filtroBusca').value.toLowerCase();
            
            const agora = new Date();
            const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
            const inicioSemana = new Date(hoje);
            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
            const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
            const seteDiasAtras = new Date(hoje);
            seteDiasAtras.setDate(hoje.getDate() - 7);
            
            leadsFiltrados = todosLeads.filter(lead => {
                // Filtro por ramo
                if (ramo && lead.ramo !== ramo) return false;
                
                // Filtro por responsável
                if (responsavel === 'nao_atribuido' && lead.responsavelId) return false;
                if (responsavel && responsavel !== 'nao_atribuido' && lead.responsavelId !== responsavel) return false;
                
                // Filtro por período
                const criadoEm = lead.criadoEm?.toDate() || new Date();
                const atualizadoEm = lead.atualizadoEm?.toDate() || criadoEm;
                
                if (periodo === 'hoje' && criadoEm < hoje) return false;
                if (periodo === 'semana' && criadoEm < inicioSemana) return false;
                if (periodo === 'mes' && criadoEm < inicioMes) return false;
                if (periodo === 'parado' && atualizadoEm > seteDiasAtras) return false;
                
                // Filtro por busca
                if (busca) {
                    const texto = `${lead.nome} ${lead.email} ${lead.whatsapp} ${lead.cpf}`.toLowerCase();
                    if (!texto.includes(busca)) return false;
                }
                
                return true;
            });
            
            renderizarView();
        }

        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filtroRamo').value = '';
            document.getElementById('filtroResponsavel').value = '';
            document.getElementById('filtroPeriodo').value = '';
            document.getElementById('filtroBusca').value = '';
            aplicarFiltros();
        }

        // Alternar view
        function setView(view) {
            viewAtual = view;
            
            document.getElementById('btnPipeline').classList.toggle('active', view === 'pipeline');
            document.getElementById('btnList').classList.toggle('active', view === 'list');
            
            document.getElementById('pipelineView').classList.toggle('active', view === 'pipeline');
            document.getElementById('listView').classList.toggle('active', view === 'list');
            
            renderizarView();
        }

        // Renderizar view atual
        function renderizarView() {
            if (viewAtual === 'pipeline') {
                renderizarPipeline();
            } else {
                renderizarLista();
            }
        }

        // Renderizar Pipeline (Kanban)
        function renderizarPipeline() {
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';
            
            // Agrupar leads por status
            const leadsPorStatus = {};
            Object.keys(STATUS_PIPELINE).forEach(status => {
                leadsPorStatus[status] = leadsFiltrados.filter(l => l.status === status);
            });
            
            // Criar colunas
            Object.entries(STATUS_PIPELINE).forEach(([status, config]) => {
                const leads = leadsPorStatus[status] || [];
                
                const coluna = document.createElement('div');
                coluna.className = 'pipeline-column';
                coluna.innerHTML = `
                    <div class="pipeline-header">
                        <div class="pipeline-title">
                            <span class="dot" style="background: ${config.cor};"></span>
                            <h3>${config.label}</h3>
                        </div>
                        <span class="pipeline-count">${leads.length}</span>
                    </div>
                    <div class="pipeline-body" data-status="${status}" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        ${leads.length === 0 ? '<p style="text-align: center; color: var(--text-muted); padding: 20px; font-size: 13px;">Nenhum lead</p>' : ''}
                        ${leads.map(lead => renderizarCardLead(lead)).join('')}
                    </div>
                `;
                
                container.appendChild(coluna);
            });
        }

        // Renderizar card do lead
        function renderizarCardLead(lead) {
            const tempo = calcularTempoParado(lead.atualizadoEm?.toDate() || lead.criadoEm?.toDate());
            const tempoAlerta = tempo.dias > 7 ? 'alert' : '';
            
            return `
                <div class="lead-card ${lead.temperatura || ''}" draggable="true" ondragstart="handleDragStart(event, '${lead.id}')" onclick="abrirLead('${lead.id}')">
                    <div class="lead-header">
                        <span class="lead-name">${lead.nome || 'Sem nome'}</span>
                        <span class="lead-ramo ${lead.ramo}">${lead.ramo?.toUpperCase() || '-'}</span>
                    </div>
                    <div class="lead-info">
                        <i class="fab fa-whatsapp"></i> ${lead.whatsapp || '-'}
                    </div>
                    ${lead.valorCotacao ? `<div class="lead-info"><i class="fas fa-dollar-sign"></i> R$ ${parseFloat(lead.valorCotacao).toLocaleString('pt-BR')}</div>` : ''}
                    <div class="lead-footer">
                        <span class="lead-time ${tempoAlerta}">
                            <i class="fas fa-clock"></i> ${tempo.texto}
                        </span>
                        <span class="lead-responsavel">
                            ${lead.responsavelNome || 'Não atribuído'}
                        </span>
                    </div>
                </div>
            `;
        }

        // Renderizar Lista
        function renderizarLista() {
            const tbody = document.getElementById('leadsTableBody');
            
            if (leadsFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state" style="padding: 60px;">
                            <i class="fas fa-inbox"></i>
                            <h3>Nenhum lead encontrado</h3>
                            <p>Tente ajustar os filtros ou adicione um novo lead</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = leadsFiltrados.map(lead => {
                const status = STATUS_PIPELINE[lead.status] || STATUS_PIPELINE['pre_cadastro'];
                const tempo = calcularTempoParado(lead.atualizadoEm?.toDate() || lead.criadoEm?.toDate());
                
                return `
                    <tr onclick="abrirLead('${lead.id}')" style="cursor: pointer;">
                        <td>
                            <strong>${lead.nome || 'Sem nome'}</strong>
                            ${lead.email ? `<br><small style="color: var(--text-muted);">${lead.email}</small>` : ''}
                        </td>
                        <td>
                            ${lead.whatsapp || '-'}
                            ${lead.whatsapp ? `<button class="btn btn-sm btn-icon" onclick="event.stopPropagation(); abrirWhatsApp('${lead.whatsapp}')" title="WhatsApp"><i class="fab fa-whatsapp" style="color: #25D366;"></i></button>` : ''}
                        </td>
                        <td><span class="lead-ramo ${lead.ramo}">${lead.ramo?.toUpperCase() || '-'}</span></td>
                        <td><span class="status-badge ${status.classe}">${status.label}</span></td>
                        <td>${lead.responsavelNome || 'Não atribuído'}</td>
                        <td class="${tempo.dias > 7 ? 'text-danger' : ''}">${tempo.texto}</td>
                        <td>${lead.valorCotacao ? 'R$ ' + parseFloat(lead.valorCotacao).toLocaleString('pt-BR') : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); abrirModalMover('${lead.id}')" title="Mover">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Drag and Drop
        let draggedLeadId = null;

        function handleDragStart(event, leadId) {
            draggedLeadId = leadId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        async function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const novoStatus = event.currentTarget.dataset.status;
            
            if (draggedLeadId && novoStatus) {
                // Se for cotação enviada, fechado ou perdido, abrir modal para informações extras
                if (['cotacao_enviada', 'negocio_fechado', 'negocio_perdido'].includes(novoStatus)) {
                    abrirModalMover(draggedLeadId, novoStatus);
                } else {
                    await moverLead(draggedLeadId, novoStatus);
                }
            }
            
            draggedLeadId = null;
            document.querySelectorAll('.lead-card.dragging').forEach(el => el.classList.remove('dragging'));
        }

        // Abrir modal para mover lead
        function abrirModalMover(leadId, statusPreSelecionado = null) {
            const lead = todosLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            leadParaMover = leadId;
            document.getElementById('moverLeadNome').textContent = lead.nome || 'Lead';
            
            const selectStatus = document.getElementById('novoStatus');
            selectStatus.value = statusPreSelecionado || lead.status;
            
            toggleCamposExtras();
            
            document.getElementById('modalMoverLead').classList.add('active');
        }

        // Alternar campos extras baseado no status
        document.getElementById('novoStatus').addEventListener('change', toggleCamposExtras);

        function toggleCamposExtras() {
            const status = document.getElementById('novoStatus').value;
            document.getElementById('camposCotacao').style.display = status === 'cotacao_enviada' ? 'block' : 'none';
            document.getElementById('camposFechado').style.display = status === 'negocio_fechado' ? 'block' : 'none';
        }

        // Confirmar mover lead
        async function confirmarMoverLead() {
            const novoStatus = document.getElementById('novoStatus').value;
            const observacao = document.getElementById('observacaoMover').value;
            
            let dadosExtras = {};
            
            if (novoStatus === 'cotacao_enviada') {
                dadosExtras.valorCotacao = document.getElementById('valorCotacao').value || null;
                dadosExtras.seguradora = document.getElementById('seguradoraCotacao').value || null;
            }
            
            if (novoStatus === 'negocio_fechado') {
                dadosExtras.valorPremio = document.getElementById('valorPremio').value || null;
                dadosExtras.comissao = document.getElementById('comissao').value || null;
            }
            
            await moverLead(leadParaMover, novoStatus, observacao, dadosExtras);
            
            fecharModal('modalMoverLead');
            document.getElementById('observacaoMover').value = '';
            document.getElementById('valorCotacao').value = '';
            document.getElementById('valorPremio').value = '';
            document.getElementById('comissao').value = '';
        }

        // Mover lead
        async function moverLead(leadId, novoStatus, observacao = '', dadosExtras = {}) {
            try {
                const lead = todosLeads.find(l => l.id === leadId);
                const statusAntigo = lead?.status;
                
                const updateData = {
                    status: novoStatus,
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    ...dadosExtras
                };
                
                await db.collection(COLECOES.leads).doc(leadId).update(updateData);
                
                // Registrar atividade
                await db.collection(COLECOES.atividades).add({
                    tipo: 'status_alterado',
                    descricao: `${lead?.nome || 'Lead'}: ${STATUS_PIPELINE[statusAntigo]?.label} → ${STATUS_PIPELINE[novoStatus]?.label}${observacao ? ` | ${observacao}` : ''}`,
                    leadId: leadId,
                    statusAnterior: statusAntigo,
                    statusNovo: novoStatus,
                    usuarioEmail: usuarioAtual.email,
                    dataHora: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Se fechou negócio, pode criar apólice e cliente
                if (novoStatus === 'negocio_fechado' && lead) {
                    await criarClienteSeNecessario(lead, dadosExtras);
                }
                
                mostrarToast('Lead movido com sucesso!', 'success');
                await carregarLeads();
                
            } catch (error) {
                console.error('Erro ao mover lead:', error);
                mostrarToast('Erro ao mover lead', 'error');
            }
        }

        // Criar cliente quando fecha negócio
        async function criarClienteSeNecessario(lead, dadosExtras) {
            try {
                // Verificar se já existe cliente com mesmo email ou whatsapp
                let clienteExiste = false;
                
                if (lead.email) {
                    const emailQuery = await db.collection('usuarios')
                        .where('email', '==', lead.email)
                        .limit(1)
                        .get();
                    clienteExiste = !emailQuery.empty;
                }
                
                if (!clienteExiste) {
                    // Criar novo cliente
                    await db.collection('usuarios').add({
                        nome: lead.nome,
                        email: lead.email || null,
                        telefone: lead.whatsapp,
                        cpf: lead.cpf || null,
                        dataNascimento: lead.dataNascimento || null,
                        cep: lead.cep || null,
                        cidade: lead.cidade || null,
                        estado: lead.estado || null,
                        origem: 'lead_convertido',
                        leadOriginal: lead.id,
                        dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
                        pontos: 0,
                        ativo: true
                    });
                }
                
            } catch (error) {
                console.error('Erro ao criar cliente:', error);
            }
        }

        // Salvar novo lead
        async function salvarNovoLead() {
            const nome = document.getElementById('leadNome').value.trim();
            const email = document.getElementById('leadEmail').value.trim();
            const whatsapp = document.getElementById('leadWhatsapp').value.trim();
            const cpf = document.getElementById('leadCpf').value.trim();
            const nascimento = document.getElementById('leadNascimento').value;
            const cep = document.getElementById('leadCep').value.trim();
            const cidade = document.getElementById('leadCidade').value.trim();
            const estado = document.getElementById('leadEstado').value.trim();
            const ramo = document.getElementById('leadRamo').value;
            const responsavelId = document.getElementById('leadResponsavel').value;
            const observacoes = document.getElementById('leadObservacoes').value.trim();
            
            if (!nome || !whatsapp || !ramo) {
                mostrarToast('Preencha os campos obrigatórios', 'error');
                return;
            }
            
            try {
                let responsavelNome = 'Não atribuído';
                if (responsavelId) {
                    const respDoc = await db.collection(COLECOES.funcionarios).doc(responsavelId).get();
                    if (respDoc.exists) {
                        responsavelNome = respDoc.data().nome || respDoc.data().email;
                    }
                }
                
                const leadRef = await db.collection(COLECOES.leads).add({
                    nome,
                    email,
                    whatsapp,
                    cpf,
                    dataNascimento: nascimento || null,
                    cep,
                    cidade,
                    estado,
                    ramo,
                    responsavelId: responsavelId || null,
                    responsavelNome,
                    observacoes,
                    status: 'pre_cadastro',
                    origem: 'manual',
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    criadoPor: usuarioAtual.email
                });
                
                await db.collection(COLECOES.atividades).add({
                    tipo: 'lead_criado',
                    descricao: `Novo lead manual: ${nome} (${ramo})`,
                    leadId: leadRef.id,
                    usuarioEmail: usuarioAtual.email,
                    dataHora: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                mostrarToast('Lead criado com sucesso!', 'success');
                fecharModal('modalNovoLead');
                document.getElementById('formNovoLead').reset();
                
                await carregarLeads();
                
            } catch (error) {
                console.error('Erro ao salvar lead:', error);
                mostrarToast('Erro ao criar lead', 'error');
            }
        }

        // Buscar CEP
        async function buscarCep() {
            const cep = document.getElementById('leadCep').value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                
                if (!data.erro) {
                    document.getElementById('leadCidade').value = data.localidade || '';
                    document.getElementById('leadEstado').value = data.uf || '';
                }
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
            }
        }

        // Utilitários
        function calcularTempoParado(data) {
            if (!data) return { dias: 0, texto: '-' };
            
            const agora = new Date();
            const diff = agora - data;
            const minutos = Math.floor(diff / 60000);
            const horas = Math.floor(minutos / 60);
            const dias = Math.floor(horas / 24);
            
            return {
                dias,
                texto: dias > 0 ? `${dias}d` : horas > 0 ? `${horas}h` : `${minutos}min`
            };
        }

        function abrirLead(id) {
            window.location.href = `lead-detalhe.html?id=${id}`;
        }

        function abrirWhatsApp(numero) {
            if (!numero) return;
            const limpo = numero.replace(/\D/g, '');
            window.open(`https://wa.me/55${limpo}`, '_blank');
        }

        function abrirModalNovoLead() {
            document.getElementById('modalNovoLead').classList.add('active');
        }

        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function mostrarToast(mensagem, tipo = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'times-circle' : 'info-circle'}"></i>
                <span>${mensagem}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // Fechar modal ao clicar fora
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
