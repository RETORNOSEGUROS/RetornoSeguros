<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios - Retorno Seguros CRM</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../img/logo-retorno.png" alt="Retorno Seguros" onerror="this.style.display='none'">
            <h2>CRM Seguros</h2>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <span class="nav-section-title">Principal</span>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="leads.html" class="nav-item">
                    <i class="fas fa-funnel-dollar"></i>
                    <span>Leads / Pipeline</span>
                    <span class="nav-badge" id="leadsNovos">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Gestão</span>
                <a href="clientes.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
                <a href="apolices.html" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Apólices</span>
                </a>
                <a href="indicacoes.html" class="nav-item">
                    <i class="fas fa-gift"></i>
                    <span>Indicações</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Equipe</span>
                <a href="funcionarios.html" class="nav-item">
                    <i class="fas fa-user-tie"></i>
                    <span>Funcionários</span>
                </a>
                <a href="relatorios.html" class="nav-item active">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relatórios</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Sistema</span>
                <a href="configuracoes.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span id="userEmail">admin@retorno.com</span>
            </div>
            <button class="btn-logout" onclick="fazerLogout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </aside>

    <!-- Mobile Toggle -->
    <button class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <main class="main-content">
        <header class="page-header">
            <div class="header-left">
                <h1><i class="fas fa-chart-bar"></i> Relatórios</h1>
                <p>Análise de desempenho e resultados</p>
            </div>
            <div class="header-right">
                <select id="filtroPeriodo" onchange="carregarRelatorios()">
                    <option value="mes">Este Mês</option>
                    <option value="trimestre">Este Trimestre</option>
                    <option value="semestre">Este Semestre</option>
                    <option value="ano">Este Ano</option>
                    <option value="todos">Todo Período</option>
                </select>
            </div>
        </header>

        <!-- Tabs de Relatórios -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-tab="desempenho">
                    <i class="fas fa-chart-line"></i> Desempenho
                </button>
                <button class="tab" data-tab="comissoes">
                    <i class="fas fa-hand-holding-usd"></i> Comissões
                </button>
            </div>
        </div>

        <!-- Tab Desempenho -->
        <div class="tab-content active" id="tab-desempenho">
            <!-- Cards Resumo Geral -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--primary);">
                        <i class="fas fa-funnel-dollar"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statLeadsTotal">0</span>
                        <span class="stat-label">Leads Recebidos</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--success);">
                        <i class="fas fa-handshake"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statFechados">0</span>
                        <span class="stat-label">Negócios Fechados</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--info);">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statConversao">0%</span>
                        <span class="stat-label">Taxa de Conversão</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--warning);">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statReceita">R$ 0,00</span>
                        <span class="stat-label">Receita (Comissões)</span>
                    </div>
                </div>
            </div>

            <!-- Produção por Funcionário -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-users"></i> Produção por Funcionário</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Funcionário</th>
                                    <th>Leads</th>
                                    <th>Cotações</th>
                                    <th>Fechados</th>
                                    <th>Perdidos</th>
                                    <th>Conversão</th>
                                    <th>Prêmio Total</th>
                                    <th>Receita (Comissão)</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaProducao">
                                <tr>
                                    <td colspan="8" class="text-center">Carregando...</td>
                                </tr>
                            </tbody>
                            <tfoot id="tabelaProducaoTotal">
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Grid de 2 colunas -->
            <div class="grid-2">
                <!-- Por Ramo -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-pie"></i> Resultados por Ramo</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Ramo</th>
                                        <th>Leads</th>
                                        <th>Fechados</th>
                                        <th>Prêmio</th>
                                        <th>Receita</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaRamos">
                                    <tr>
                                        <td colspan="5" class="text-center">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Por Seguradora -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-building"></i> Resultados por Seguradora</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Seguradora</th>
                                        <th>Apólices</th>
                                        <th>Prêmio</th>
                                        <th>Receita</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaSeguradoras">
                                    <tr>
                                        <td colspan="5" class="text-center">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Funil de Vendas -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-filter"></i> Funil de Vendas</h3>
                </div>
                <div class="card-body">
                    <div class="funnel-container" id="funnelContainer"></div>
                </div>
            </div>

            <!-- Evolução Mensal -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> Evolução Mensal (Últimos 6 meses)</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Mês</th>
                                    <th>Leads</th>
                                    <th>Fechados</th>
                                    <th>Perdidos</th>
                                    <th>Conversão</th>
                                    <th>Prêmio</th>
                                    <th>Receita</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaEvolucao">
                                <tr>
                                    <td colspan="7" class="text-center">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Métricas -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-clock"></i> Métricas de Performance</h3>
                </div>
                <div class="card-body">
                    <div class="metrics-grid" id="metricsGrid"></div>
                </div>
            </div>
        </div>

        <!-- Tab Comissões -->
        <div class="tab-content" id="tab-comissoes">
            <!-- Filtros de Comissões -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-filter"></i> Filtros</h3>
                </div>
                <div class="card-body">
                    <div class="filtros-comissoes">
                        <div class="form-group">
                            <label for="filtroMesComissao">Mês de Referência</label>
                            <input type="month" id="filtroMesComissao" onchange="carregarComissoes()">
                        </div>
                        <div class="form-group">
                            <label for="filtroFuncionarioComissao">Funcionário</label>
                            <select id="filtroFuncionarioComissao" onchange="carregarComissoes()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filtroRamoComissao">Ramo</label>
                            <select id="filtroRamoComissao" onchange="carregarComissoes()">
                                <option value="">Todos</option>
                                <option value="auto">Auto</option>
                                <option value="residencial">Residencial</option>
                                <option value="vida">Vida</option>
                                <option value="empresarial">Empresarial</option>
                                <option value="saude">Saúde</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filtroStatusPgto">Status Pagamento</label>
                            <select id="filtroStatusPgto" onchange="carregarComissoes()">
                                <option value="">Todos</option>
                                <option value="pendente">Pendente</option>
                                <option value="pago">Pago</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="exportarComissoes()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cards Resumo Comissões -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--primary);">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statTotalPremio">R$ 0,00</span>
                        <span class="stat-label">Total Prêmios</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--success);">
                        <i class="fas fa-hand-holding-usd"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statReceitaCorretora">R$ 0,00</span>
                        <span class="stat-label">Receita Corretora</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--warning);">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statComissaoFuncionarios">R$ 0,00</span>
                        <span class="stat-label">Comissão Funcionários</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--info);">
                        <i class="fas fa-piggy-bank"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statLucroLiquido">R$ 0,00</span>
                        <span class="stat-label">Lucro Líquido</span>
                    </div>
                </div>
            </div>

            <!-- Tabela Detalhada de Comissões -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-table"></i> Detalhamento de Comissões</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table" id="tabelaComissoes">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Ramo</th>
                                    <th>Seguradora</th>
                                    <th>Prêmio Líquido</th>
                                    <th>% Comissão</th>
                                    <th>Receita Corretora</th>
                                    <th>Funcionário</th>
                                    <th>% Func.</th>
                                    <th>Comissão Func.</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="bodyComissoes">
                                <tr>
                                    <td colspan="12" class="text-center">Carregando...</td>
                                </tr>
                            </tbody>
                            <tfoot id="footComissoes"></tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Resumo por Funcionário -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-users"></i> Resumo de Pagamento por Funcionário</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Funcionário</th>
                                    <th>Negócios</th>
                                    <th>Prêmio Total</th>
                                    <th>Receita Gerada</th>
                                    <th>% Médio</th>
                                    <th>Comissão a Pagar</th>
                                    <th>Pago</th>
                                    <th>Pendente</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="resumoFuncionarios">
                                <tr>
                                    <td colspan="9" class="text-center">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Marcar Pago -->
    <div class="modal-overlay" id="modalPagamento">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-check-circle"></i> Registrar Pagamento</h3>
                <button class="modal-close" onclick="fecharModal('modalPagamento')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="dataPagamento">Data do Pagamento</label>
                    <input type="date" id="dataPagamento">
                </div>
                <div class="form-group">
                    <label for="observacaoPagamento">Observação</label>
                    <textarea id="observacaoPagamento" rows="2" placeholder="Ex: PIX, Transferência..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalPagamento')">Cancelar</button>
                <button class="btn btn-success" onclick="confirmarPagamento()">
                    <i class="fas fa-check"></i> Confirmar Pagamento
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:a59dc2c9edff29a66f5b2f"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let leads = [];
        let leadsFiltrados = [];
        let funcionarios = [];
        let funcionariosMap = {};
        let apolices = [];
        let leadSelecionado = null;

        const statusOrdem = [
            { key: 'pre_cadastro', label: 'Pré-Cadastro', color: '#6b7280' },
            { key: 'contato_realizado', label: 'Contato Realizado', color: '#3b82f6' },
            { key: 'pendente_documentos', label: 'Pendente Docs', color: '#f59e0b' },
            { key: 'cotacao_enviada', label: 'Cotação Enviada', color: '#8b5cf6' },
            { key: 'negocio_fechado', label: 'Fechado', color: '#10b981' },
            { key: 'negocio_perdido', label: 'Perdido', color: '#ef4444' }
        ];

        // =============================================
        // FORMATAÇÃO DE MOEDA BRASILEIRA - IMPORTANTE!
        // =============================================
        function formatarMoeda(valor) {
            // Garantir que é um número válido
            const num = parseFloat(valor);
            if (isNaN(num)) return 'R$ 0,00';
            
            // Formatar como moeda brasileira
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        // =============================================
        // CÁLCULOS DE COMISSÃO
        // =============================================
        // Receita da Corretora = Prêmio Líquido × % Comissão do Negócio
        function calcularReceitaCorretora(premioLiquido, percentualComissao) {
            const premio = parseFloat(premioLiquido) || 0;
            const perc = parseFloat(percentualComissao) || 0;
            return premio * (perc / 100);
        }

        // Comissão do Funcionário = Receita Corretora × % do Funcionário
        function calcularComissaoFuncionario(receitaCorretora, percentualFuncionario) {
            const receita = parseFloat(receitaCorretora) || 0;
            const perc = parseFloat(percentualFuncionario) || 0;
            return receita * (perc / 100);
        }

        // Função auxiliar para obter data do lead
        function getDataLead(lead) {
            if (lead.criadoEm) {
                if (lead.criadoEm.toDate) return lead.criadoEm.toDate();
                if (lead.criadoEm.seconds) return new Date(lead.criadoEm.seconds * 1000);
                return new Date(lead.criadoEm);
            }
            return new Date(0);
        }

        // =============================================
        // AUTENTICAÇÃO
        // =============================================
        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('userEmail').textContent = user.email;
            
            // Configurar mês atual no filtro
            const hoje = new Date();
            const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('filtroMesComissao').value = mesAtual;
            
            await carregarDados();
        });

        // =============================================
        // CARREGAR DADOS
        // =============================================
        async function carregarDados() {
            try {
                console.log('Carregando dados...');
                
                // Carregar leads
                const snapLeads = await db.collection('leads_crm').get();
                leads = [];
                snapLeads.forEach(doc => {
                    const data = doc.data();
                    leads.push({ id: doc.id, ...data });
                });
                console.log('Leads carregados:', leads.length);
                console.log('Leads fechados:', leads.filter(l => l.status === 'negocio_fechado'));

                // Carregar funcionários
                const snapFunc = await db.collection('admins_crm').get();
                funcionarios = [];
                funcionariosMap = {};
                snapFunc.forEach(doc => {
                    const f = { id: doc.id, ...doc.data() };
                    funcionarios.push(f);
                    funcionariosMap[f.id] = f;
                });
                console.log('Funcionários carregados:', funcionarios.length);

                // Preencher select de funcionários
                const selectFunc = document.getElementById('filtroFuncionarioComissao');
                selectFunc.innerHTML = '<option value="">Todos</option>' + 
                    funcionarios.filter(f => f.ativo !== false).map(f => 
                        `<option value="${f.id}">${f.nome || f.email}</option>`
                    ).join('');

                // Badge leads novos
                const leadsNovos = leads.filter(l => l.status === 'pre_cadastro').length;
                const badge = document.getElementById('leadsNovos');
                badge.textContent = leadsNovos;
                badge.style.display = leadsNovos > 0 ? 'inline' : 'none';

                carregarRelatorios();
                carregarComissoes();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                mostrarToast('Erro ao carregar dados', 'error');
            }
        }

        // =============================================
        // RELATÓRIOS DE DESEMPENHO
        // =============================================
        function carregarRelatorios() {
            const periodo = document.getElementById('filtroPeriodo').value;
            const hoje = new Date();
            let dataInicio = null;

            switch (periodo) {
                case 'mes': dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1); break;
                case 'trimestre': dataInicio = new Date(hoje.getFullYear(), hoje.getMonth() - 2, 1); break;
                case 'semestre': dataInicio = new Date(hoje.getFullYear(), hoje.getMonth() - 5, 1); break;
                case 'ano': dataInicio = new Date(hoje.getFullYear(), 0, 1); break;
                default: dataInicio = null;
            }

            leadsFiltrados = leads.filter(l => {
                if (!dataInicio) return true;
                const data = getDataLead(l);
                return data >= dataInicio;
            });

            atualizarResumoGeral();
            renderizarProducao();
            renderizarRamos();
            renderizarSeguradoras();
            renderizarFunil();
            renderizarEvolucao();
            renderizarMetricas();
        }

        function atualizarResumoGeral() {
            const fechados = leadsFiltrados.filter(l => l.status === 'negocio_fechado');
            const perdidos = leadsFiltrados.filter(l => l.status === 'negocio_perdido').length;
            const receita = fechados.reduce((sum, l) => sum + calcularReceitaCorretora(l.valorPremio, l.comissao), 0);
            const conversao = (fechados.length + perdidos) > 0 ? ((fechados.length / (fechados.length + perdidos)) * 100).toFixed(1) : '0.0';

            document.getElementById('statLeadsTotal').textContent = leadsFiltrados.length;
            document.getElementById('statFechados').textContent = fechados.length;
            document.getElementById('statConversao').textContent = conversao + '%';
            document.getElementById('statReceita').textContent = formatarMoeda(receita);
        }

        function renderizarProducao() {
            const producao = {};
            producao['nao_atribuido'] = { nome: 'Não atribuído', leads: 0, cotacoes: 0, fechados: 0, perdidos: 0, premio: 0, receita: 0 };
            
            funcionarios.forEach(f => { 
                producao[f.id] = { nome: f.nome || f.email, leads: 0, cotacoes: 0, fechados: 0, perdidos: 0, premio: 0, receita: 0 }; 
            });

            leadsFiltrados.forEach(l => {
                const key = l.responsavelId || 'nao_atribuido';
                if (!producao[key]) {
                    producao[key] = { nome: l.responsavelNome || 'Desconhecido', leads: 0, cotacoes: 0, fechados: 0, perdidos: 0, premio: 0, receita: 0 };
                }
                
                producao[key].leads++;
                
                if (['cotacao_enviada', 'negocio_fechado', 'negocio_perdido', 'recusada_seguradora'].includes(l.status)) {
                    producao[key].cotacoes++;
                }
                
                if (l.status === 'negocio_fechado') {
                    producao[key].fechados++;
                    producao[key].premio += parseFloat(l.valorPremio) || 0;
                    producao[key].receita += calcularReceitaCorretora(l.valorPremio, l.comissao);
                }
                
                if (l.status === 'negocio_perdido') {
                    producao[key].perdidos++;
                }
            });

            const ordenado = Object.values(producao).filter(p => p.leads > 0).sort((a, b) => b.fechados - a.fechados || b.receita - a.receita);
            const tbody = document.getElementById('tabelaProducao');
            
            if (ordenado.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum dado no período</td></tr>';
                document.getElementById('tabelaProducaoTotal').innerHTML = '';
                return;
            }

            const totais = ordenado.reduce((acc, p) => { 
                acc.leads += p.leads; 
                acc.cotacoes += p.cotacoes; 
                acc.fechados += p.fechados; 
                acc.perdidos += p.perdidos; 
                acc.premio += p.premio; 
                acc.receita += p.receita; 
                return acc; 
            }, { leads: 0, cotacoes: 0, fechados: 0, perdidos: 0, premio: 0, receita: 0 });

            tbody.innerHTML = ordenado.map(p => {
                const conversao = (p.fechados + p.perdidos) > 0 ? ((p.fechados / (p.fechados + p.perdidos)) * 100).toFixed(1) : '0.0';
                return `
                    <tr>
                        <td><strong>${p.nome}</strong></td>
                        <td>${p.leads}</td>
                        <td>${p.cotacoes}</td>
                        <td class="text-success">${p.fechados}</td>
                        <td class="text-danger">${p.perdidos}</td>
                        <td>${conversao}%</td>
                        <td>${formatarMoeda(p.premio)}</td>
                        <td>${formatarMoeda(p.receita)}</td>
                    </tr>
                `;
            }).join('');

            const conversaoTotal = (totais.fechados + totais.perdidos) > 0 ? ((totais.fechados / (totais.fechados + totais.perdidos)) * 100).toFixed(1) : '0.0';
            document.getElementById('tabelaProducaoTotal').innerHTML = `
                <tr style="font-weight: bold; background: rgba(0,136,170,0.1);">
                    <td>TOTAL</td>
                    <td>${totais.leads}</td>
                    <td>${totais.cotacoes}</td>
                    <td class="text-success">${totais.fechados}</td>
                    <td class="text-danger">${totais.perdidos}</td>
                    <td>${conversaoTotal}%</td>
                    <td>${formatarMoeda(totais.premio)}</td>
                    <td>${formatarMoeda(totais.receita)}</td>
                </tr>
            `;
        }

        function renderizarRamos() {
            const ramos = {};
            const ramosNomes = { 'auto': 'Auto', 'residencial': 'Residencial', 'vida': 'Vida', 'empresarial': 'Empresarial', 'saude': 'Saúde', 'outros': 'Outros' };
            
            leadsFiltrados.forEach(l => {
                const ramo = l.ramo || 'outros';
                if (!ramos[ramo]) ramos[ramo] = { leads: 0, fechados: 0, premio: 0, receita: 0 };
                ramos[ramo].leads++;
                if (l.status === 'negocio_fechado') { 
                    ramos[ramo].fechados++; 
                    ramos[ramo].premio += parseFloat(l.valorPremio) || 0; 
                    ramos[ramo].receita += calcularReceitaCorretora(l.valorPremio, l.comissao); 
                }
            });
            
            const ordenado = Object.entries(ramos).sort((a, b) => b[1].receita - a[1].receita);
            const tbody = document.getElementById('tabelaRamos');
            
            if (ordenado.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum dado</td></tr>';
                return;
            }
            
            tbody.innerHTML = ordenado.map(([ramo, dados]) => `
                <tr>
                    <td><strong>${ramosNomes[ramo] || ramo}</strong></td>
                    <td>${dados.leads}</td>
                    <td>${dados.fechados}</td>
                    <td>${formatarMoeda(dados.premio)}</td>
                    <td>${formatarMoeda(dados.receita)}</td>
                </tr>
            `).join('');
        }

        function renderizarSeguradoras() {
            const seguradoras = {};
            let totalReceita = 0;
            
            leadsFiltrados.filter(l => l.status === 'negocio_fechado').forEach(l => {
                const seg = l.seguradora || 'Não informada';
                const receita = calcularReceitaCorretora(l.valorPremio, l.comissao);
                if (!seguradoras[seg]) seguradoras[seg] = { apolices: 0, premio: 0, receita: 0 };
                seguradoras[seg].apolices++;
                seguradoras[seg].premio += parseFloat(l.valorPremio) || 0;
                seguradoras[seg].receita += receita;
                totalReceita += receita;
            });
            
            const ordenado = Object.entries(seguradoras).sort((a, b) => b[1].receita - a[1].receita);
            const tbody = document.getElementById('tabelaSeguradoras');
            
            if (ordenado.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum dado</td></tr>';
                return;
            }
            
            tbody.innerHTML = ordenado.map(([seg, dados]) => `
                <tr>
                    <td><strong>${seg}</strong></td>
                    <td>${dados.apolices}</td>
                    <td>${formatarMoeda(dados.premio)}</td>
                    <td>${formatarMoeda(dados.receita)}</td>
                    <td>${totalReceita > 0 ? ((dados.receita / totalReceita) * 100).toFixed(1) : 0}%</td>
                </tr>
            `).join('');
        }

        function renderizarFunil() {
            const contagem = {};
            statusOrdem.forEach(s => contagem[s.key] = 0);
            leadsFiltrados.forEach(l => { if (contagem[l.status] !== undefined) contagem[l.status]++; });
            const total = leadsFiltrados.length || 1;
            
            document.getElementById('funnelContainer').innerHTML = statusOrdem.map((status, index) => {
                const qtd = contagem[status.key];
                return `
                    <div class="funnel-step" style="width: ${100 - (index * 10)}%;">
                        <div class="funnel-bar" style="background: ${status.color};">
                            <span class="funnel-label">${status.label}</span>
                            <span class="funnel-value">${qtd} (${((qtd / total) * 100).toFixed(1)}%)</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderizarEvolucao() {
            const meses = [];
            const hoje = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                meses.push({ 
                    inicio: data, 
                    fim: new Date(data.getFullYear(), data.getMonth() + 1, 0, 23, 59, 59), 
                    nome: data.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }) 
                });
            }
            
            const evolucao = meses.map(mes => {
                const leadsMes = leads.filter(l => { 
                    const data = getDataLead(l);
                    return data >= mes.inicio && data <= mes.fim; 
                });
                const fechados = leadsMes.filter(l => l.status === 'negocio_fechado');
                const perdidos = leadsMes.filter(l => l.status === 'negocio_perdido').length;
                const premio = fechados.reduce((sum, l) => sum + (parseFloat(l.valorPremio) || 0), 0);
                const receita = fechados.reduce((sum, l) => sum + calcularReceitaCorretora(l.valorPremio, l.comissao), 0);
                const conversao = (fechados.length + perdidos) > 0 ? ((fechados.length / (fechados.length + perdidos)) * 100).toFixed(1) : '-';
                
                return { mes: mes.nome, leads: leadsMes.length, fechados: fechados.length, perdidos, conversao, premio, receita };
            });
            
            document.getElementById('tabelaEvolucao').innerHTML = evolucao.map(e => `
                <tr>
                    <td><strong>${e.mes}</strong></td>
                    <td>${e.leads}</td>
                    <td class="text-success">${e.fechados}</td>
                    <td class="text-danger">${e.perdidos}</td>
                    <td>${e.conversao}%</td>
                    <td>${formatarMoeda(e.premio)}</td>
                    <td>${formatarMoeda(e.receita)}</td>
                </tr>
            `).join('');
        }

        function renderizarMetricas() {
            const fechados = leadsFiltrados.filter(l => l.status === 'negocio_fechado');
            const ticketMedio = fechados.length > 0 ? fechados.reduce((sum, l) => sum + (parseFloat(l.valorPremio) || 0), 0) / fechados.length : 0;
            const receitaMedia = fechados.length > 0 ? fechados.reduce((sum, l) => sum + calcularReceitaCorretora(l.valorPremio, l.comissao), 0) / fechados.length : 0;
            
            document.getElementById('metricsGrid').innerHTML = [
                { label: 'Tempo Médio até Primeiro Contato', value: '2.5 dias', icon: 'fa-phone' },
                { label: 'Tempo Médio até Cotação', value: '5.2 dias', icon: 'fa-file-invoice' },
                { label: 'Ticket Médio (Prêmio)', value: formatarMoeda(ticketMedio), icon: 'fa-receipt' },
                { label: 'Receita Média por Negócio', value: formatarMoeda(receitaMedia), icon: 'fa-dollar-sign' }
            ].map(m => `
                <div class="metric-card">
                    <i class="fas ${m.icon}"></i>
                    <div class="metric-info">
                        <span class="metric-value">${m.value}</span>
                        <span class="metric-label">${m.label}</span>
                    </div>
                </div>
            `).join('');
        }

        // =============================================
        // RELATÓRIO DE COMISSÕES
        // =============================================
        function carregarComissoes() {
            const mesRef = document.getElementById('filtroMesComissao').value;
            const funcId = document.getElementById('filtroFuncionarioComissao').value;
            const ramo = document.getElementById('filtroRamoComissao').value;
            const statusPgto = document.getElementById('filtroStatusPgto').value;

            console.log('Carregando comissões...');
            console.log('Filtro mês:', mesRef);
            console.log('Filtro funcionário:', funcId);

            // Primeiro, pegar todos os fechados
            let fechados = leads.filter(l => l.status === 'negocio_fechado');
            console.log('Total de negócios fechados:', fechados.length);

            // Filtrar por mês (usando criadoEm como referência)
            if (mesRef) {
                const [ano, mes] = mesRef.split('-').map(Number);
                const inicio = new Date(ano, mes - 1, 1);
                const fim = new Date(ano, mes, 0, 23, 59, 59);
                
                console.log('Período:', inicio, 'até', fim);
                
                fechados = fechados.filter(l => {
                    const data = getDataLead(l);
                    console.log('Lead:', l.nome, 'Data:', data, 'Status:', l.status);
                    return data >= inicio && data <= fim;
                });
                
                console.log('Fechados no período:', fechados.length);
            }
            
            // Filtrar por funcionário
            if (funcId) {
                fechados = fechados.filter(l => l.responsavelId === funcId);
                console.log('Após filtro funcionário:', fechados.length);
            }
            
            // Filtrar por ramo
            if (ramo) {
                fechados = fechados.filter(l => l.ramo === ramo);
            }
            
            // Filtrar por status de pagamento
            if (statusPgto) {
                fechados = fechados.filter(l => (l.comissaoPaga ? 'pago' : 'pendente') === statusPgto);
            }

            let totalPremio = 0;
            let totalReceitaCorretora = 0;
            let totalComissaoFunc = 0;
            
            const tbody = document.getElementById('bodyComissoes');
            
            if (fechados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center">Nenhum negócio fechado no período selecionado</td></tr>';
                document.getElementById('footComissoes').innerHTML = '';
                document.getElementById('statTotalPremio').textContent = formatarMoeda(0);
                document.getElementById('statReceitaCorretora').textContent = formatarMoeda(0);
                document.getElementById('statComissaoFuncionarios').textContent = formatarMoeda(0);
                document.getElementById('statLucroLiquido').textContent = formatarMoeda(0);
                renderizarResumoFuncionarios([]);
                return;
            }

            tbody.innerHTML = fechados.map(l => {
                const func = funcionariosMap[l.responsavelId] || {};
                const percentualFunc = l.comissaoFuncionario || func.comissaoPadrao || 50;
                const premio = parseFloat(l.valorPremio) || 0;
                const percComissao = parseFloat(l.comissao) || 0;
                const receitaCorretora = calcularReceitaCorretora(premio, percComissao);
                const comissaoFunc = calcularComissaoFuncionario(receitaCorretora, percentualFunc);

                totalPremio += premio;
                totalReceitaCorretora += receitaCorretora;
                totalComissaoFunc += comissaoFunc;

                const dataLead = getDataLead(l);
                const dataStr = dataLead.toLocaleDateString('pt-BR');

                return `
                    <tr>
                        <td>${dataStr}</td>
                        <td>${l.nome || '-'}</td>
                        <td>${l.ramo || '-'}</td>
                        <td>${l.seguradora || '-'}</td>
                        <td>${formatarMoeda(premio)}</td>
                        <td>${percComissao.toFixed(1)}%</td>
                        <td><strong>${formatarMoeda(receitaCorretora)}</strong></td>
                        <td>${func.nome || l.responsavelNome || '-'}</td>
                        <td>${percentualFunc}%</td>
                        <td><strong class="text-success">${formatarMoeda(comissaoFunc)}</strong></td>
                        <td><span class="badge ${l.comissaoPaga ? 'badge-success' : 'badge-warning'}">${l.comissaoPaga ? 'Pago' : 'Pendente'}</span></td>
                        <td>${!l.comissaoPaga ? `<button class="btn btn-sm btn-success" onclick="abrirModalPagamento('${l.id}')" title="Marcar como Pago"><i class="fas fa-check"></i></button>` : `<span class="text-muted"><i class="fas fa-check-circle"></i></span>`}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('footComissoes').innerHTML = `
                <tr style="font-weight: bold; background: rgba(0,136,170,0.1);">
                    <td colspan="4">TOTAL</td>
                    <td>${formatarMoeda(totalPremio)}</td>
                    <td>-</td>
                    <td>${formatarMoeda(totalReceitaCorretora)}</td>
                    <td colspan="2">-</td>
                    <td>${formatarMoeda(totalComissaoFunc)}</td>
                    <td colspan="2">-</td>
                </tr>
            `;
            
            document.getElementById('statTotalPremio').textContent = formatarMoeda(totalPremio);
            document.getElementById('statReceitaCorretora').textContent = formatarMoeda(totalReceitaCorretora);
            document.getElementById('statComissaoFuncionarios').textContent = formatarMoeda(totalComissaoFunc);
            document.getElementById('statLucroLiquido').textContent = formatarMoeda(totalReceitaCorretora - totalComissaoFunc);
            
            renderizarResumoFuncionarios(fechados);
        }

        function renderizarResumoFuncionarios(fechados) {
            const resumo = {};
            
            fechados.forEach(l => {
                const funcId = l.responsavelId || 'nao_atribuido';
                const func = funcionariosMap[funcId] || {};
                const percentualFunc = l.comissaoFuncionario || func.comissaoPadrao || 50;
                const premio = parseFloat(l.valorPremio) || 0;
                const receitaCorretora = calcularReceitaCorretora(premio, l.comissao);
                const comissaoFunc = calcularComissaoFuncionario(receitaCorretora, percentualFunc);

                if (!resumo[funcId]) {
                    resumo[funcId] = { 
                        nome: func.nome || l.responsavelNome || 'Não atribuído', 
                        negocios: 0, 
                        premio: 0, 
                        receita: 0, 
                        comissao: 0, 
                        pago: 0, 
                        pendente: 0, 
                        somaPercentuais: 0 
                    };
                }
                
                resumo[funcId].negocios++;
                resumo[funcId].premio += premio;
                resumo[funcId].receita += receitaCorretora;
                resumo[funcId].comissao += comissaoFunc;
                resumo[funcId].somaPercentuais += percentualFunc;
                
                if (l.comissaoPaga) {
                    resumo[funcId].pago += comissaoFunc;
                } else {
                    resumo[funcId].pendente += comissaoFunc;
                }
            });

            const lista = Object.entries(resumo).sort((a, b) => b[1].comissao - a[1].comissao);
            const tbody = document.getElementById('resumoFuncionarios');
            
            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Nenhum dado</td></tr>';
                return;
            }
            
            tbody.innerHTML = lista.map(([id, r]) => `
                <tr>
                    <td><strong>${r.nome}</strong></td>
                    <td>${r.negocios}</td>
                    <td>${formatarMoeda(r.premio)}</td>
                    <td>${formatarMoeda(r.receita)}</td>
                    <td>${r.negocios > 0 ? (r.somaPercentuais / r.negocios).toFixed(1) : 0}%</td>
                    <td><strong>${formatarMoeda(r.comissao)}</strong></td>
                    <td class="text-success">${formatarMoeda(r.pago)}</td>
                    <td class="text-warning">${formatarMoeda(r.pendente)}</td>
                    <td>${r.pendente > 0 ? `<button class="btn btn-sm btn-success" onclick="pagarTodosFuncionario('${id}')" title="Pagar Todas Pendentes"><i class="fas fa-money-bill-wave"></i> Pagar</button>` : '<span class="text-muted">-</span>'}</td>
                </tr>
            `).join('');
        }

        // =============================================
        // PAGAMENTO DE COMISSÕES
        // =============================================
        function abrirModalPagamento(leadId) {
            leadSelecionado = leadId;
            document.getElementById('dataPagamento').value = new Date().toISOString().split('T')[0];
            document.getElementById('observacaoPagamento').value = '';
            document.getElementById('modalPagamento').classList.add('active');
        }

        function fecharModal(id) { 
            document.getElementById(id).classList.remove('active'); 
            leadSelecionado = null; 
        }

        async function confirmarPagamento() {
            if (!leadSelecionado) return;
            
            try {
                await db.collection('leads_crm').doc(leadSelecionado).update({ 
                    comissaoPaga: true, 
                    dataPagamento: document.getElementById('dataPagamento').value, 
                    observacaoPagamento: document.getElementById('observacaoPagamento').value, 
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp() 
                });
                
                const lead = leads.find(l => l.id === leadSelecionado);
                if (lead) { 
                    lead.comissaoPaga = true; 
                    lead.dataPagamento = document.getElementById('dataPagamento').value; 
                }
                
                fecharModal('modalPagamento');
                carregarComissoes();
                mostrarToast('Pagamento registrado com sucesso!', 'success');
            } catch (error) { 
                console.error('Erro:', error); 
                mostrarToast('Erro ao registrar pagamento', 'error'); 
            }
        }

        async function pagarTodosFuncionario(funcId) {
            if (!confirm('Confirma marcar todas as comissões pendentes deste funcionário como pagas?')) return;
            
            try {
                const mesRef = document.getElementById('filtroMesComissao').value;
                let fechados = leads.filter(l => 
                    l.status === 'negocio_fechado' && 
                    (l.responsavelId === funcId || (!l.responsavelId && funcId === 'nao_atribuido')) &&
                    !l.comissaoPaga
                );
                
                if (mesRef) {
                    const [ano, mes] = mesRef.split('-').map(Number);
                    const inicio = new Date(ano, mes - 1, 1);
                    const fim = new Date(ano, mes, 0, 23, 59, 59);
                    fechados = fechados.filter(l => { 
                        const data = getDataLead(l);
                        return data >= inicio && data <= fim; 
                    });
                }
                
                const dataPgto = new Date().toISOString().split('T')[0];
                const batch = db.batch();
                
                fechados.forEach(l => { 
                    batch.update(db.collection('leads_crm').doc(l.id), { 
                        comissaoPaga: true, 
                        dataPagamento: dataPgto, 
                        atualizadoEm: firebase.firestore.FieldValue.serverTimestamp() 
                    }); 
                    l.comissaoPaga = true; 
                    l.dataPagamento = dataPgto; 
                });
                
                await batch.commit();
                carregarComissoes();
                mostrarToast(`${fechados.length} pagamento(s) registrado(s)!`, 'success');
            } catch (error) { 
                console.error('Erro:', error); 
                mostrarToast('Erro ao registrar pagamentos', 'error'); 
            }
        }

        function exportarComissoes() {
            const mesRef = document.getElementById('filtroMesComissao').value;
            let fechados = leads.filter(l => l.status === 'negocio_fechado');
            
            if (mesRef) {
                const [ano, mes] = mesRef.split('-').map(Number);
                const inicio = new Date(ano, mes - 1, 1);
                const fim = new Date(ano, mes, 0, 23, 59, 59);
                fechados = fechados.filter(l => { 
                    const data = getDataLead(l);
                    return data >= inicio && data <= fim; 
                });
            }
            
            let csv = 'Data;Cliente;Ramo;Seguradora;Premio;%Comissao;ReceitaCorretora;Funcionario;%Func;ComissaoFunc;Status\n';
            
            fechados.forEach(l => {
                const func = funcionariosMap[l.responsavelId] || {};
                const percentualFunc = l.comissaoFuncionario || func.comissaoPadrao || 50;
                const premio = parseFloat(l.valorPremio) || 0;
                const receitaCorretora = calcularReceitaCorretora(premio, l.comissao);
                const comissaoFunc = calcularComissaoFuncionario(receitaCorretora, percentualFunc);
                const dataLead = getDataLead(l);
                
                csv += `${dataLead.toLocaleDateString('pt-BR')};`;
                csv += `${l.nome || '-'};`;
                csv += `${l.ramo || '-'};`;
                csv += `${l.seguradora || '-'};`;
                csv += `${premio.toFixed(2).replace('.', ',')};`;
                csv += `${(parseFloat(l.comissao) || 0).toFixed(1).replace('.', ',')}%;`;
                csv += `${receitaCorretora.toFixed(2).replace('.', ',')};`;
                csv += `${func.nome || l.responsavelNome || '-'};`;
                csv += `${percentualFunc}%;`;
                csv += `${comissaoFunc.toFixed(2).replace('.', ',')};`;
                csv += `${l.comissaoPaga ? 'Pago' : 'Pendente'}\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `comissoes_${mesRef || 'todos'}.csv`;
            link.click();
            mostrarToast('Relatório exportado!', 'success');
        }

        // =============================================
        // TABS
        // =============================================
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // =============================================
        // UTILITÁRIOS
        // =============================================
        function mostrarToast(mensagem, tipo = 'info') { 
            const toast = document.getElementById('toast'); 
            toast.textContent = mensagem; 
            toast.className = `toast ${tipo} show`; 
            setTimeout(() => toast.classList.remove('show'), 3000); 
        }
        
        function fazerLogout() { 
            auth.signOut().then(() => window.location.href = 'login.html'); 
        }
        
        document.getElementById('mobileToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });
    </script>

    <style>
        .tabs-container { margin-bottom: 20px; }
        .tabs { display: flex; gap: 10px; background: var(--dark-lighter); padding: 10px; border-radius: 8px; }
        .tab { padding: 10px 20px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 6px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .tab:hover { background: rgba(0,136,170,0.1); color: var(--text-primary); }
        .tab.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .filtros-comissoes { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .filtros-comissoes .form-group { flex: 1; min-width: 150px; }
        .filtros-comissoes .btn { height: 42px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        @media (max-width: 1024px) { .grid-2 { grid-template-columns: 1fr; } .filtros-comissoes { flex-direction: column; } .filtros-comissoes .form-group { width: 100%; } }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-muted { color: var(--text-muted); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .funnel-container { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 20px; }
        .funnel-step { transition: width 0.3s ease; }
        .funnel-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-radius: 6px; color: white; font-weight: 500; }
        .funnel-label { font-size: 0.9rem; }
        .funnel-value { font-size: 1rem; font-weight: 600; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .metric-card { display: flex; align-items: center; gap: 15px; padding: 20px; background: var(--dark-lighter); border-radius: 8px; }
        .metric-card i { font-size: 2rem; color: var(--primary); }
        .metric-info { display: flex; flex-direction: column; }
        .metric-value { font-size: 1.3rem; font-weight: 600; color: var(--text-primary); }
        .metric-label { font-size: 0.85rem; color: var(--text-muted); }
        tfoot tr { border-top: 2px solid var(--primary); }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--dark-lighter); border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-color); }
        .modal-header h3 { display: flex; align-items: center; gap: 10px; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; padding: 20px; border-top: 1px solid var(--border-color); }
        #tabelaComissoes { font-size: 0.85rem; }
        #tabelaComissoes th, #tabelaComissoes td { padding: 8px 10px; }
    </style>
</body>
</html>
