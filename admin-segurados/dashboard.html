<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CRM Retorno Seguros</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../img/logo-retorno.png" alt="Retorno Seguros" onerror="this.style.display='none'">
                <h2>CRM Seguros</h2>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">Principal</span>
                    <a href="dashboard.html" class="nav-item active">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="leads.html" class="nav-item">
                        <i class="fas fa-funnel-dollar"></i>
                        <span>Leads / Pipeline</span>
                        <span class="nav-badge" id="leadsNovos">0</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Gestão</span>
                    <a href="clientes.html" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </a>
                    <a href="apolices.html" class="nav-item">
                        <i class="fas fa-file-contract"></i>
                        <span>Apólices</span>
                    </a>
                    <a href="renovacoes.html" class="nav-item">
                        <i class="fas fa-sync-alt"></i>
                        <span>Renovações</span>
                        <span class="nav-badge" id="renovacoesPendentes">0</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Equipe</span>
                    <a href="funcionarios.html" class="nav-item">
                        <i class="fas fa-user-tie"></i>
                        <span>Funcionários</span>
                    </a>
                    <a href="relatorios.html" class="nav-item">
                        <i class="fas fa-chart-bar"></i>
                        <span>Relatórios</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Sistema</span>
                    <a href="configuracoes.html" class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span>Configurações</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">P</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Carregando...</div>
                        <div class="user-role">Administrador</div>
                    </div>
                    <button class="btn-logout" onclick="logout()" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="mobile-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Dashboard</h1>
                </div>
                <div class="header-right">
                    <div class="header-search">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Buscar lead, cliente..." id="searchGlobal" onkeyup="buscarGlobal(event)">
                    </div>
                    <div class="header-actions">
                        <button class="header-btn" onclick="abrirModalNovoLead()" title="Novo Lead">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="header-btn" id="btnNotificacoes" title="Notificações">
                            <i class="fas fa-bell"></i>
                            <span class="badge" id="notifCount">0</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <!-- Widget de Renovações -->
                <div class="renovacoes-widget" id="renovacoesWidget" style="display: none;">
                    <div class="renovacoes-header">
                        <h3><i class="fas fa-calendar-alt"></i> Renovações Próximas</h3>
                        <a href="renovacoes.html" class="btn btn-sm" style="background: rgba(0,0,0,0.2); color: inherit;">Ver todas</a>
                    </div>
                    <div class="renovacoes-list" id="renovacoesList">
                        <!-- Preenchido via JS -->
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statLeadsNovos">0</h3>
                            <p>Leads Novos</p>
                            <span class="stat-trend up" id="trendNovos">Hoje</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statEmAndamento">0</h3>
                            <p>Em Andamento</p>
                            <span class="stat-trend" id="trendAndamento">Aguardando</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statFechados">0</h3>
                            <p>Negócios Fechados</p>
                            <span class="stat-trend up" id="trendFechados">Este mês</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statPerdidos">0</h3>
                            <p>Perdidos</p>
                            <span class="stat-trend down" id="trendPerdidos">Este mês</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statConversao">0%</h3>
                            <p>Taxa de Conversão</p>
                            <span class="stat-trend" id="trendConversao">Geral</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statReceita">R$ 0</h3>
                            <p>Receita Estimada</p>
                            <span class="stat-trend up" id="trendReceita">Este mês</span>
                        </div>
                    </div>
                </div>

                <!-- Grid de 2 colunas -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <!-- Leads Recentes -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-list"></i> Leads Recentes</h2>
                            <a href="leads.html" class="btn btn-sm btn-secondary">Ver todos</a>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Ramo</th>
                                            <th>Status</th>
                                            <th>Tempo</th>
                                            <th>Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leadsRecentesTable">
                                        <tr>
                                            <td colspan="5" class="loading">
                                                <div class="spinner"></div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Atividades Recentes -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-history"></i> Atividades</h2>
                        </div>
                        <div class="card-body">
                            <div class="timeline" id="atividadesTimeline">
                                <div class="loading">
                                    <div class="spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leads por Responsável -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-users-cog"></i> Leads por Responsável</h2>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Funcionário</th>
                                        <th>Novos</th>
                                        <th>Em Andamento</th>
                                        <th>Fechados</th>
                                        <th>Perdidos</th>
                                        <th>Conversão</th>
                                    </tr>
                                </thead>
                                <tbody id="leadsPorResponsavel">
                                    <tr>
                                        <td colspan="6" class="loading">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Novo Lead -->
    <div class="modal-overlay" id="modalNovoLead">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user-plus"></i> Novo Lead</h2>
                <button class="modal-close" onclick="fecharModal('modalNovoLead')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formNovoLead">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="leadNome" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="leadEmail">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">WhatsApp *</label>
                            <input type="tel" class="form-control" id="leadWhatsapp" placeholder="(54) 99999-9999" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" id="leadCpf" placeholder="000.000.000-00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="leadNascimento">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="leadCep" placeholder="00000-000" onblur="buscarCep()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="leadCidade" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <input type="text" class="form-control" id="leadEstado" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ramo do Seguro *</label>
                            <select class="form-control" id="leadRamo" required>
                                <option value="">Selecione...</option>
                                <option value="auto">Auto</option>
                                <option value="residencial">Residencial</option>
                                <option value="vida">Vida</option>
                                <option value="empresarial">Empresarial</option>
                                <option value="saude">Saúde</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Responsável</label>
                            <select class="form-control" id="leadResponsavel">
                                <option value="">Não atribuído</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" id="leadObservacoes" rows="3" placeholder="Informações adicionais sobre o lead..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalNovoLead')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarNovoLead()">
                    <i class="fas fa-save"></i> Salvar Lead
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29",
            measurementId: "G-C6E44WXLPW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Coleções
        const COLECOES = {
            leads: 'leads_crm',
            clientes: 'usuarios',
            funcionarios: 'admins_crm',
            apolices: 'apolices_cliente',
            atividades: 'atividades_crm',
            cotacoes: 'cotacoes_cliente'
        };

        // Status do Pipeline
        const STATUS_PIPELINE = {
            'pre_cadastro': { label: 'Pré-Cadastro', classe: 'pre-cadastro', ordem: 1 },
            'contato_realizado': { label: 'Contato Realizado', classe: 'contato', ordem: 2 },
            'pendente_documentos': { label: 'Pendente de Documentos', classe: 'pendente-doc', ordem: 3 },
            'cotacao_enviada': { label: 'Cotação Enviada', classe: 'cotacao-enviada', ordem: 4 },
            'recusada_seguradora': { label: 'Recusada pela Seguradora', classe: 'recusada', ordem: 5 },
            'negocio_fechado': { label: 'Negócio Fechado', classe: 'fechado', ordem: 6 },
            'negocio_perdido': { label: 'Negócio Perdido', classe: 'perdido', ordem: 7 }
        };

        let usuarioAtual = null;

        // Verificar autenticação
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            usuarioAtual = user;
            
            // Atualizar UI do usuário
            document.getElementById('userName').textContent = user.email.split('@')[0];
            document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
            
            // Carregar dados
            await carregarDashboard();
        });

        // Carregar Dashboard
        async function carregarDashboard() {
            await Promise.all([
                carregarEstatisticas(),
                carregarLeadsRecentes(),
                carregarRenovacoes(),
                carregarAtividades(),
                carregarLeadsPorResponsavel(),
                carregarFuncionarios()
            ]);
        }

        // Carregar Estatísticas
        async function carregarEstatisticas() {
            try {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                
                // Buscar todos os leads
                const leadsSnapshot = await db.collection(COLECOES.leads).get();
                
                let novos = 0, emAndamento = 0, fechados = 0, perdidos = 0;
                let fechadosMes = 0, receitaMes = 0;
                
                leadsSnapshot.forEach(doc => {
                    const lead = doc.data();
                    const criadoEm = lead.criadoEm?.toDate() || new Date();
                    
                    switch(lead.status) {
                        case 'pre_cadastro':
                            novos++;
                            break;
                        case 'contato_realizado':
                        case 'pendente_documentos':
                        case 'cotacao_enviada':
                            emAndamento++;
                            break;
                        case 'negocio_fechado':
                            fechados++;
                            if (criadoEm >= inicioMes) {
                                fechadosMes++;
                                receitaMes += lead.valorPremio || 0;
                            }
                            break;
                        case 'negocio_perdido':
                        case 'recusada_seguradora':
                            perdidos++;
                            break;
                    }
                });
                
                // Atualizar UI
                document.getElementById('statLeadsNovos').textContent = novos;
                document.getElementById('statEmAndamento').textContent = emAndamento;
                document.getElementById('statFechados').textContent = fechados;
                document.getElementById('statPerdidos').textContent = perdidos;
                
                const total = fechados + perdidos;
                const conversao = total > 0 ? Math.round((fechados / total) * 100) : 0;
                document.getElementById('statConversao').textContent = conversao + '%';
                
                document.getElementById('statReceita').textContent = 'R$ ' + receitaMes.toLocaleString('pt-BR');
                
                // Badge de leads novos na sidebar
                document.getElementById('leadsNovos').textContent = novos;
                
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Carregar Leads Recentes
        async function carregarLeadsRecentes() {
            try {
                const leadsSnapshot = await db.collection(COLECOES.leads)
                    .orderBy('criadoEm', 'desc')
                    .limit(10)
                    .get();
                
                const tbody = document.getElementById('leadsRecentesTable');
                
                if (leadsSnapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state" style="padding: 40px;">
                                <i class="fas fa-inbox"></i>
                                <p>Nenhum lead cadastrado</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = '';
                
                leadsSnapshot.forEach(doc => {
                    const lead = doc.data();
                    const status = STATUS_PIPELINE[lead.status] || STATUS_PIPELINE['pre_cadastro'];
                    const tempo = calcularTempoDecorrido(lead.criadoEm?.toDate());
                    
                    tbody.innerHTML += `
                        <tr onclick="abrirLead('${doc.id}')" style="cursor: pointer;">
                            <td>
                                <strong>${lead.nome || 'Sem nome'}</strong>
                                <br><small style="color: var(--text-muted);">${lead.whatsapp || lead.email || '-'}</small>
                            </td>
                            <td><span class="lead-ramo ${lead.ramo}">${lead.ramo?.toUpperCase() || '-'}</span></td>
                            <td><span class="status-badge ${status.classe}">${status.label}</span></td>
                            <td>${tempo}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); abrirWhatsApp('${lead.whatsapp}')">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
            } catch (error) {
                console.error('Erro ao carregar leads:', error);
                document.getElementById('leadsRecentesTable').innerHTML = `
                    <tr><td colspan="5" style="color: var(--danger);">Erro ao carregar leads</td></tr>
                `;
            }
        }

        // Carregar Renovações
        async function carregarRenovacoes() {
            try {
                const hoje = new Date();
                const em30dias = new Date();
                em30dias.setDate(em30dias.getDate() + 30);
                
                const apolicesSnapshot = await db.collection(COLECOES.apolices)
                    .where('tipo', '==', 'retorno')
                    .where('dataVencimento', '>=', firebase.firestore.Timestamp.fromDate(hoje))
                    .where('dataVencimento', '<=', firebase.firestore.Timestamp.fromDate(em30dias))
                    .orderBy('dataVencimento', 'asc')
                    .limit(5)
                    .get();
                
                const widget = document.getElementById('renovacoesWidget');
                const lista = document.getElementById('renovacoesList');
                
                if (apolicesSnapshot.empty) {
                    widget.style.display = 'none';
                    document.getElementById('renovacoesPendentes').textContent = '0';
                    return;
                }
                
                widget.style.display = 'block';
                lista.innerHTML = '';
                document.getElementById('renovacoesPendentes').textContent = apolicesSnapshot.size;
                
                apolicesSnapshot.forEach(doc => {
                    const apolice = doc.data();
                    const vencimento = apolice.dataVencimento?.toDate();
                    const diasRestantes = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                    
                    lista.innerHTML += `
                        <div class="renovacao-item" onclick="abrirApolice('${doc.id}')">
                            <div class="renovacao-dias">${diasRestantes}d</div>
                            <div class="renovacao-info">
                                <span>${apolice.clienteNome || 'Cliente'}</span>
                                <strong>${apolice.ramo?.toUpperCase() || 'Seguro'} - ${apolice.seguradora || ''}</strong>
                            </div>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error('Erro ao carregar renovações:', error);
                document.getElementById('renovacoesWidget').style.display = 'none';
            }
        }

        // Carregar Atividades
        async function carregarAtividades() {
            try {
                const atividadesSnapshot = await db.collection(COLECOES.atividades)
                    .orderBy('dataHora', 'desc')
                    .limit(10)
                    .get();
                
                const timeline = document.getElementById('atividadesTimeline');
                
                if (atividadesSnapshot.empty) {
                    timeline.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <i class="fas fa-history" style="font-size: 30px;"></i>
                            <p>Nenhuma atividade recente</p>
                        </div>
                    `;
                    return;
                }
                
                timeline.innerHTML = '';
                
                atividadesSnapshot.forEach(doc => {
                    const atividade = doc.data();
                    const data = atividade.dataHora?.toDate();
                    
                    timeline.innerHTML += `
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <div class="timeline-date">${formatarDataHora(data)}</div>
                                <div class="timeline-text">${atividade.descricao || '-'}</div>
                            </div>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error('Erro ao carregar atividades:', error);
            }
        }

        // Carregar Leads por Responsável
        async function carregarLeadsPorResponsavel() {
            try {
                const leadsSnapshot = await db.collection(COLECOES.leads).get();
                
                const porResponsavel = {};
                
                leadsSnapshot.forEach(doc => {
                    const lead = doc.data();
                    const resp = lead.responsavelNome || 'Não atribuído';
                    
                    if (!porResponsavel[resp]) {
                        porResponsavel[resp] = { novos: 0, andamento: 0, fechados: 0, perdidos: 0 };
                    }
                    
                    switch(lead.status) {
                        case 'pre_cadastro':
                            porResponsavel[resp].novos++;
                            break;
                        case 'contato_realizado':
                        case 'pendente_documentos':
                        case 'cotacao_enviada':
                            porResponsavel[resp].andamento++;
                            break;
                        case 'negocio_fechado':
                            porResponsavel[resp].fechados++;
                            break;
                        case 'negocio_perdido':
                        case 'recusada_seguradora':
                            porResponsavel[resp].perdidos++;
                            break;
                    }
                });
                
                const tbody = document.getElementById('leadsPorResponsavel');
                
                if (Object.keys(porResponsavel).length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">Nenhum dado disponível</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = '';
                
                for (const [nome, dados] of Object.entries(porResponsavel)) {
                    const total = dados.fechados + dados.perdidos;
                    const conversao = total > 0 ? Math.round((dados.fechados / total) * 100) : 0;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${nome}</strong></td>
                            <td>${dados.novos}</td>
                            <td>${dados.andamento}</td>
                            <td style="color: var(--success);">${dados.fechados}</td>
                            <td style="color: var(--danger);">${dados.perdidos}</td>
                            <td><span class="status-badge ${conversao >= 50 ? 'fechado' : 'pendente-doc'}">${conversao}%</span></td>
                        </tr>
                    `;
                }
                
            } catch (error) {
                console.error('Erro ao carregar leads por responsável:', error);
            }
        }

        // Carregar Funcionários (para select)
        async function carregarFuncionarios() {
            try {
                const funcionariosSnapshot = await db.collection(COLECOES.funcionarios)
                    .where('ativo', '==', true)
                    .get();
                
                const select = document.getElementById('leadResponsavel');
                
                funcionariosSnapshot.forEach(doc => {
                    const func = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${func.nome || func.email}</option>`;
                });
                
            } catch (error) {
                console.error('Erro ao carregar funcionários:', error);
            }
        }

        // Salvar Novo Lead
        async function salvarNovoLead() {
            const nome = document.getElementById('leadNome').value.trim();
            const email = document.getElementById('leadEmail').value.trim();
            const whatsapp = document.getElementById('leadWhatsapp').value.trim();
            const cpf = document.getElementById('leadCpf').value.trim();
            const nascimento = document.getElementById('leadNascimento').value;
            const cep = document.getElementById('leadCep').value.trim();
            const cidade = document.getElementById('leadCidade').value.trim();
            const estado = document.getElementById('leadEstado').value.trim();
            const ramo = document.getElementById('leadRamo').value;
            const responsavelId = document.getElementById('leadResponsavel').value;
            const observacoes = document.getElementById('leadObservacoes').value.trim();
            
            if (!nome || !whatsapp || !ramo) {
                mostrarToast('Preencha os campos obrigatórios', 'error');
                return;
            }
            
            try {
                // Buscar nome do responsável se tiver
                let responsavelNome = 'Não atribuído';
                if (responsavelId) {
                    const respDoc = await db.collection(COLECOES.funcionarios).doc(responsavelId).get();
                    if (respDoc.exists) {
                        responsavelNome = respDoc.data().nome || respDoc.data().email;
                    }
                }
                
                // Criar lead
                const leadRef = await db.collection(COLECOES.leads).add({
                    nome,
                    email,
                    whatsapp,
                    cpf,
                    dataNascimento: nascimento || null,
                    cep,
                    cidade,
                    estado,
                    ramo,
                    responsavelId: responsavelId || null,
                    responsavelNome,
                    observacoes,
                    status: 'pre_cadastro',
                    origem: 'manual',
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    criadoPor: usuarioAtual.email
                });
                
                // Registrar atividade
                await db.collection(COLECOES.atividades).add({
                    tipo: 'lead_criado',
                    descricao: `Novo lead criado: ${nome} (${ramo})`,
                    leadId: leadRef.id,
                    usuarioEmail: usuarioAtual.email,
                    dataHora: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                mostrarToast('Lead criado com sucesso!', 'success');
                fecharModal('modalNovoLead');
                document.getElementById('formNovoLead').reset();
                
                // Recarregar dados
                await carregarDashboard();
                
            } catch (error) {
                console.error('Erro ao salvar lead:', error);
                mostrarToast('Erro ao criar lead', 'error');
            }
        }

        // Buscar CEP
        async function buscarCep() {
            const cep = document.getElementById('leadCep').value.replace(/\D/g, '');
            
            if (cep.length !== 8) return;
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                
                if (!data.erro) {
                    document.getElementById('leadCidade').value = data.localidade || '';
                    document.getElementById('leadEstado').value = data.uf || '';
                }
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
            }
        }

        // Utilitários
        function calcularTempoDecorrido(data) {
            if (!data) return '-';
            
            const agora = new Date();
            const diff = agora - data;
            const minutos = Math.floor(diff / 60000);
            const horas = Math.floor(minutos / 60);
            const dias = Math.floor(horas / 24);
            
            if (dias > 0) return `${dias}d atrás`;
            if (horas > 0) return `${horas}h atrás`;
            if (minutos > 0) return `${minutos}min atrás`;
            return 'Agora';
        }

        function formatarDataHora(data) {
            if (!data) return '-';
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function abrirLead(id) {
            window.location.href = `lead-detalhe.html?id=${id}`;
        }

        function abrirApolice(id) {
            window.location.href = `apolices.html?id=${id}`;
        }

        function abrirWhatsApp(numero) {
            if (!numero) return;
            const limpo = numero.replace(/\D/g, '');
            window.open(`https://wa.me/55${limpo}`, '_blank');
        }

        function abrirModalNovoLead() {
            document.getElementById('modalNovoLead').classList.add('active');
        }

        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function buscarGlobal(event) {
            if (event.key === 'Enter') {
                const termo = event.target.value.trim();
                if (termo) {
                    window.location.href = `leads.html?busca=${encodeURIComponent(termo)}`;
                }
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function mostrarToast(mensagem, tipo = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'times-circle' : 'info-circle'}"></i>
                <span>${mensagem}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 4000);
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // Fechar modal ao clicar fora
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
