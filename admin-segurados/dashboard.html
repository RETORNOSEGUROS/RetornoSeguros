<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CRM Retorno Seguros</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Filtros */
        .filtros-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--bg-light);
            border-radius: 8px;
            align-items: flex-end;
        }
        
        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filtro-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .filtro-group select,
        .filtro-group input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.9rem;
            min-width: 120px;
        }
        
        .filtro-group input[type="date"] {
            min-width: 140px;
        }
        
        .filtro-group input[type="tel"] {
            min-width: 150px;
        }
        
        .btn-filtrar {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-filtrar:hover {
            background: var(--primary-dark);
        }
        
        .btn-limpar {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-limpar:hover {
            background: var(--bg-light);
        }
        
        /* Badges de origem */
        .origem-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .origem-badge.parceiro {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .origem-badge.indicacao {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .origem-badge.direto {
            background: var(--bg-light);
            color: var(--text-muted);
        }
        
        /* Data/hora na tabela */
        .data-hora {
            font-size: 0.85rem;
        }
        
        .data-hora .data {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .data-hora .hora {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        
        /* Respons√°vel */
        .responsavel-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .responsavel-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .responsavel-nome {
            font-size: 0.85rem;
        }
        
        .nao-atribuido {
            color: var(--text-muted);
            font-style: italic;
        }
        
        /* Pagina√ß√£o */
        .paginacao-container {
            display: flex;
            justify-content: center;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .btn-carregar-mais {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-carregar-mais:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .btn-carregar-mais:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-carregar-mais .spinner-small {
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Contador de resultados */
        .resultados-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--bg-light);
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .resultados-info strong {
            color: var(--primary);
        }
        
        /* Tabela responsiva melhorada */
        .data-table th {
            white-space: nowrap;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            vertical-align: middle;
        }
        
        /* Lead ramo badges */
        .lead-ramo {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .lead-ramo.auto { background: #dbeafe; color: #1e40af; }
        .lead-ramo.residencial { background: #dcfce7; color: #166534; }
        .lead-ramo.vida { background: #fce7f3; color: #9d174d; }
        .lead-ramo.empresarial { background: #fef3c7; color: #92400e; }
        .lead-ramo.saude { background: #e0e7ff; color: #3730a3; }
        .lead-ramo.dental { background: #ccfbf1; color: #0f766e; }
        
        /* A√ß√µes */
        .acoes-cell {
            display: flex;
            gap: 5px;
        }
        
        .acoes-cell .btn {
            padding: 6px 10px;
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../img/logo-retorno.png" alt="Retorno Seguros" onerror="this.style.display='none'">
            <h2>CRM Seguros</h2>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <span class="nav-section-title">Principal</span>
                <a href="dashboard.html" class="nav-item active">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="leads.html" class="nav-item">
                    <i class="fas fa-funnel-dollar"></i>
                    <span>Leads / Pipeline</span>
                    <span class="nav-badge" id="leadsNovos">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Gest√£o</span>
                <a href="clientes.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
                <a href="apolices.html" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Ap√≥lices</span>
                </a>
                <a href="indicacoes.html" class="nav-item">
                    <i class="fas fa-gift"></i>
                    <span>Indica√ß√µes</span>
                </a>
                <a href="renovacoes.html" class="nav-item">
                    <i class="fas fa-sync-alt"></i>
                    <span>Renova√ß√µes</span>
                    <span class="nav-badge" id="renovacoesPendentes">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Benefici√°rios</span>
                <a href="empresas-clientes.html" class="nav-item">
                    <i class="fas fa-building"></i>
                    <span>Empresas Clientes</span>
                </a>
                <a href="movimentacoes.html" class="nav-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Movimenta√ß√µes</span>
                    <span class="nav-badge" id="movimentacoesPendentes">0</span>
                </a>
                <a href="importar-beneficiarios.html" class="nav-item">
                    <i class="fas fa-file-import"></i>
                    <span>Importar Planilha</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Parceiros</span>
                <a href="parceiros.html" class="nav-item">
                    <i class="fas fa-handshake"></i>
                    <span>Empresas Parceiras</span>
                </a>
                <a href="resgates-parceiros.html" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Resgates</span>
                    <span class="nav-badge" id="resgatesPendentes">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Campanhas</span>
                <a href="seguidores-instagram.html" class="nav-item">
                    <i class="fab fa-instagram"></i>
                    <span>Seguidores Instagram</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Equipe</span>
                <a href="funcionarios.html" class="nav-item">
                    <i class="fas fa-user-tie"></i>
                    <span>Funcion√°rios</span>
                </a>
                <a href="relatorios.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relat√≥rios</span>
                </a>
                <a href="relatorio-desistentes.html" class="nav-item">
                    <i class="fas fa-user-times"></i>
                    <span>Desistentes</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Sistema</span>
                <a href="configuracoes.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configura√ß√µes</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Carregando...</div>
                    <div class="user-role">Administrador</div>
                </div>
                <button class="btn-logout" onclick="fazerLogout()" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <h1 class="page-title">Dashboard</h1>
                <div class="header-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Buscar lead, cliente..." id="searchGlobal" onkeyup="buscarGlobal(event)">
                    </div>
                    <button class="btn btn-primary" onclick="abrirModal('modalNovoLead')">
                        <i class="fas fa-plus"></i>
                    </button>
                    <div class="notification-bell" onclick="toggleNotificacoes()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count" id="notificationCount">0</span>
                    </div>
                </div>
            </header>

            <div class="content-body">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="statNovos">0</span>
                            <span class="stat-label">Leads Novos</span>
                            <span class="stat-trend up" id="trendNovos">Hoje</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-spinner"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="statAndamento">0</span>
                            <span class="stat-label">Em Andamento</span>
                            <span class="stat-trend" id="trendAndamento">Aguardando</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="statFechados">0</span>
                            <span class="stat-label">Neg√≥cios Fechados</span>
                            <span class="stat-trend up" id="trendFechados">Este m√™s</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="statPerdidos">0</span>
                            <span class="stat-label">Perdidos</span>
                            <span class="stat-trend down" id="trendPerdidos">Este m√™s</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="statConversao">0%</span>
                            <span class="stat-label">Taxa de Convers√£o</span>
                            <span class="stat-trend" id="trendConversao">Geral</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="statReceita">R$ 0</span>
                            <span class="stat-label">Receita Estimada</span>
                            <span class="stat-trend up" id="trendReceita">Este m√™s</span>
                        </div>
                    </div>
                </div>

                <!-- Grid de 2 colunas -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <!-- Leads Recentes -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-list"></i> Leads Recentes</h2>
                            <a href="leads.html" class="btn btn-sm btn-secondary">Ver todos</a>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <!-- Filtros -->
                            <div class="filtros-container">
                                <div class="filtro-group">
                                    <label>Ramo</label>
                                    <select id="filtroRamo">
                                        <option value="">Todos</option>
                                        <option value="auto">Auto</option>
                                        <option value="residencial">Residencial</option>
                                        <option value="vida">Vida</option>
                                        <option value="empresarial">Empresarial</option>
                                        <option value="saude">Sa√∫de</option>
                                        <option value="dental">Dental</option>
                                    </select>
                                </div>
                                <div class="filtro-group">
                                    <label>Status</label>
                                    <select id="filtroStatus">
                                        <option value="">Todos</option>
                                        <option value="pre_cadastro">Pr√©-Cadastro</option>
                                        <option value="contato_realizado">Contato Realizado</option>
                                        <option value="cotacao_enviada">Cota√ß√£o Enviada</option>
                                        <option value="pendente_documentos">Pendente Docs</option>
                                        <option value="negocio_fechado">Fechado</option>
                                        <option value="negocio_perdido">Perdido</option>
                                    </select>
                                </div>
                                <div class="filtro-group">
                                    <label>Data De</label>
                                    <input type="date" id="filtroDataDe">
                                </div>
                                <div class="filtro-group">
                                    <label>Data At√©</label>
                                    <input type="date" id="filtroDataAte">
                                </div>
                                <div class="filtro-group">
                                    <label>Telefone</label>
                                    <input type="tel" id="filtroTelefone" placeholder="(54) 99999-9999">
                                </div>
                                <button class="btn-filtrar" onclick="aplicarFiltros()">
                                    <i class="fas fa-filter"></i> Filtrar
                                </button>
                                <button class="btn-limpar" onclick="limparFiltros()">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                            
                            <!-- Info de resultados -->
                            <div class="resultados-info" id="resultadosInfo">
                                <span>Mostrando <strong id="qtdExibidos">0</strong> de <strong id="qtdTotal">0</strong> leads</span>
                                <span id="filtrosAtivos" style="color: var(--primary); display: none;">
                                    <i class="fas fa-filter"></i> Filtros ativos
                                </span>
                            </div>
                            
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Cadastro</th>
                                            <th>Ramo</th>
                                            <th>Indica√ß√£o</th>
                                            <th>Respons√°vel</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leadsRecentesTable">
                                        <tr>
                                            <td colspan="7" class="loading">
                                                <div class="spinner"></div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagina√ß√£o -->
                            <div class="paginacao-container" id="paginacaoContainer">
                                <button class="btn-carregar-mais" id="btnCarregarMais" onclick="carregarMaisLeads()">
                                    <i class="fas fa-chevron-down"></i>
                                    <span>Carregar mais leads</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Atividades Recentes -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-history"></i> Atividades</h2>
                        </div>
                        <div class="card-body">
                            <div class="timeline" id="atividadesTimeline">
                                <div class="loading">
                                    <div class="spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leads por Respons√°vel -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-users-cog"></i> Leads por Respons√°vel</h2>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Funcion√°rio</th>
                                        <th>Novos</th>
                                        <th>Em Andamento</th>
                                        <th>Fechados</th>
                                        <th>Perdidos</th>
                                        <th>Convers√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="leadsPorResponsavel">
                                    <tr>
                                        <td colspan="6" class="loading">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Novo Lead -->
    <div class="modal-overlay" id="modalNovoLead">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user-plus"></i> Novo Lead</h2>
                <button class="modal-close" onclick="fecharModal('modalNovoLead')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formNovoLead">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="leadNome" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="leadEmail">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">WhatsApp *</label>
                            <input type="tel" class="form-control" id="leadWhatsapp" placeholder="(54) 99999-9999" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" id="leadCpf" placeholder="000.000.000-00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="leadNascimento">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="leadCep" placeholder="00000-000" onblur="buscarCep()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="leadCidade" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <input type="text" class="form-control" id="leadEstado" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ramo do Seguro *</label>
                            <select class="form-control" id="leadRamo" required>
                                <option value="">Selecione...</option>
                                <option value="auto">Auto</option>
                                <option value="residencial">Residencial</option>
                                <option value="vida">Vida</option>
                                <option value="empresarial">Empresarial</option>
                                <option value="saude">Sa√∫de</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Respons√°vel</label>
                            <select class="form-control" id="leadResponsavel">
                                <option value="">N√£o atribu√≠do</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="leadObservacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalNovoLead')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarNovoLead()">
                    <i class="fas fa-save"></i> Salvar Lead
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29",
            measurementId: "G-C6E44WXLPW"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Cole√ß√µes
        const COLECOES = {
            leads: 'leads_crm',
            clientes: 'usuarios',
            funcionarios: 'admins_crm',
            apolices: 'apolices_cliente',
            atividades: 'atividades_crm',
            cotacoes: 'cotacoes_cliente'
        };

        // Status do Pipeline
        const STATUS_PIPELINE = {
            'pre_cadastro': { label: 'Pr√©-Cadastro', classe: 'pre-cadastro', ordem: 1 },
            'contato_realizado': { label: 'Contato Realizado', classe: 'contato', ordem: 2 },
            'pendente_documentos': { label: 'Pendente de Documentos', classe: 'pendente-doc', ordem: 3 },
            'cotacao_enviada': { label: 'Cota√ß√£o Enviada', classe: 'cotacao-enviada', ordem: 4 },
            'recusada_seguradora': { label: 'Recusada pela Seguradora', classe: 'recusada', ordem: 5 },
            'negocio_fechado': { label: 'Neg√≥cio Fechado', classe: 'fechado', ordem: 6 },
            'negocio_perdido': { label: 'Neg√≥cio Perdido', classe: 'perdido', ordem: 7 }
        };

        // ============================================================
        // VARI√ÅVEIS GLOBAIS PARA PAGINA√á√ÉO
        // ============================================================
        const LEADS_POR_PAGINA = 15;
        let ultimoLeadCarregado = null;
        let todosLeadsCarregados = false;
        let leadsExibidos = [];
        let totalLeads = 0;
        let filtrosAtuais = {
            ramo: '',
            status: '',
            dataDe: null,
            dataAte: null,
            telefone: ''
        };
        
        let usuarioAtual = null;

        // ============================================================
        // INICIALIZA√á√ÉO
        // ============================================================
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            usuarioAtual = user;
            
            // Atualizar UI do usu√°rio
            document.getElementById('userName').textContent = user.email.split('@')[0];
            document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
            
            // Carregar dados
            carregarEstatisticas();
            carregarLeadsRecentes(true);
            carregarAtividades();
            carregarLeadsPorResponsavel();
            carregarFuncionarios();
            carregarBadgesPendentes();
        });

        // ============================================================
        // ESTAT√çSTICAS
        // ============================================================
        async function carregarEstatisticas() {
            try {
                const leadsSnapshot = await db.collection(COLECOES.leads).get();
                
                let novos = 0, andamento = 0, fechados = 0, perdidos = 0, receitaMes = 0;
                const hoje = new Date();
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                
                totalLeads = leadsSnapshot.size;
                
                leadsSnapshot.forEach(doc => {
                    const lead = doc.data();
                    const criadoEm = lead.criadoEm?.toDate();
                    const ehDesteMes = criadoEm && criadoEm >= inicioMes;
                    
                    switch(lead.status) {
                        case 'pre_cadastro':
                            novos++;
                            break;
                        case 'contato_realizado':
                        case 'pendente_documentos':
                        case 'cotacao_enviada':
                            andamento++;
                            break;
                        case 'negocio_fechado':
                            fechados++;
                            if (ehDesteMes && lead.valorPremio) {
                                receitaMes += parseFloat(lead.valorPremio) || 0;
                            }
                            break;
                        case 'negocio_perdido':
                        case 'recusada_seguradora':
                            perdidos++;
                            break;
                    }
                });
                
                const totalFinalizados = fechados + perdidos;
                const conversao = totalFinalizados > 0 ? Math.round((fechados / totalFinalizados) * 100) : 0;
                
                document.getElementById('statNovos').textContent = novos;
                document.getElementById('statAndamento').textContent = andamento;
                document.getElementById('statFechados').textContent = fechados;
                document.getElementById('statPerdidos').textContent = perdidos;
                document.getElementById('statConversao').textContent = conversao + '%';
                document.getElementById('statReceita').textContent = 'R$ ' + receitaMes.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('leadsNovos').textContent = novos;
                
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // Carregar badges de movimenta√ß√µes e resgates pendentes
        async function carregarBadgesPendentes() {
            try {
                // Movimenta√ß√µes pendentes
                const movSnapshot = await db.collection('movimentacoes_beneficiarios').get();
                let movPendentes = 0;
                movSnapshot.forEach(doc => {
                    if (doc.data().status === 'pendente') movPendentes++;
                });
                const badgeMov = document.getElementById('movimentacoesPendentes');
                if (badgeMov) {
                    badgeMov.textContent = movPendentes;
                    badgeMov.style.display = movPendentes > 0 ? 'inline' : 'none';
                }

                // Resgates pendentes
                const resgSnapshot = await db.collection('resgates_parceiros').get();
                let resgPendentes = 0;
                resgSnapshot.forEach(doc => {
                    if (doc.data().status === 'pendente') resgPendentes++;
                });
                const badgeResg = document.getElementById('resgatesPendentes');
                if (badgeResg) {
                    badgeResg.textContent = resgPendentes;
                    badgeResg.style.display = resgPendentes > 0 ? 'inline' : 'none';
                }
            } catch (error) {
                console.error('Erro ao carregar badges:', error);
            }
        }

        // ============================================================
        // CARREGAR LEADS COM PAGINA√á√ÉO (FILTROS CLIENT-SIDE)
        // ============================================================
        let todosLeadsBanco = []; // Cache de todos os leads
        
        async function carregarLeadsRecentes(reset = false) {
            try {
                if (reset) {
                    leadsExibidos = [];
                    document.getElementById('leadsRecentesTable').innerHTML = `
                        <tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr>
                    `;
                }
                
                // Se n√£o tem cache ou √© reset, buscar do banco
                if (todosLeadsBanco.length === 0 || reset) {
                    const leadsSnapshot = await db.collection(COLECOES.leads)
                        .orderBy('criadoEm', 'desc')
                        .get();
                    
                    todosLeadsBanco = [];
                    leadsSnapshot.forEach(doc => {
                        todosLeadsBanco.push({ id: doc.id, ...doc.data() });
                    });
                }
                
                // Aplicar filtros CLIENT-SIDE
                let leadsFiltrados = todosLeadsBanco.filter(lead => {
                    // Filtro de Ramo
                    if (filtrosAtuais.ramo && lead.ramo !== filtrosAtuais.ramo) {
                        return false;
                    }
                    
                    // Filtro de Status
                    if (filtrosAtuais.status && lead.status !== filtrosAtuais.status) {
                        return false;
                    }
                    
                    // Filtro de Data De
                    if (filtrosAtuais.dataDe) {
                        const dataDeInicio = new Date(filtrosAtuais.dataDe + 'T00:00:00');
                        const criadoEm = lead.criadoEm?.toDate();
                        if (!criadoEm || criadoEm < dataDeInicio) {
                            return false;
                        }
                    }
                    
                    // Filtro de Data At√©
                    if (filtrosAtuais.dataAte) {
                        const dataAteFim = new Date(filtrosAtuais.dataAte + 'T23:59:59');
                        const criadoEm = lead.criadoEm?.toDate();
                        if (!criadoEm || criadoEm > dataAteFim) {
                            return false;
                        }
                    }
                    
                    // Filtro de Telefone
                    if (filtrosAtuais.telefone) {
                        const telefoneNormalizado = (lead.whatsapp || '').replace(/\D/g, '');
                        const filtroNormalizado = filtrosAtuais.telefone.replace(/\D/g, '');
                        if (!telefoneNormalizado.includes(filtroNormalizado)) {
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                // Atualizar total para exibi√ß√£o
                totalLeads = todosLeadsBanco.length;
                
                // Pagina√ß√£o client-side
                const inicio = leadsExibidos.length;
                const novosLeads = leadsFiltrados.slice(inicio, inicio + LEADS_POR_PAGINA);
                
                leadsExibidos = [...leadsExibidos, ...novosLeads];
                todosLeadsCarregados = leadsExibidos.length >= leadsFiltrados.length;
                
                if (leadsFiltrados.length === 0) {
                    document.getElementById('leadsRecentesTable').innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state" style="padding: 40px; text-align: center;">
                                <i class="fas fa-inbox" style="font-size: 40px; color: var(--text-muted);"></i>
                                <p style="margin-top: 10px;">Nenhum lead encontrado com os filtros aplicados</p>
                            </td>
                        </tr>
                    `;
                    atualizarInfoResultados(0, leadsFiltrados.length);
                    document.getElementById('paginacaoContainer').style.display = 'none';
                    return;
                }
                
                // Renderizar
                renderizarLeads();
                atualizarInfoResultados(leadsExibidos.length, leadsFiltrados.length);
                atualizarBotaoPaginacao();
                
            } catch (error) {
                console.error('Erro ao carregar leads:', error);
                document.getElementById('leadsRecentesTable').innerHTML = `
                    <tr><td colspan="7" style="color: var(--danger); text-align: center;">Erro ao carregar leads. ${error.message}</td></tr>
                `;
            }
        }

        function renderizarLeads() {
            const tbody = document.getElementById('leadsRecentesTable');
            
            if (leadsExibidos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state" style="padding: 40px; text-align: center;">
                            <i class="fas fa-inbox" style="font-size: 40px; color: var(--text-muted);"></i>
                            <p style="margin-top: 10px;">Nenhum lead encontrado</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = leadsExibidos.map(lead => {
                const status = STATUS_PIPELINE[lead.status] || STATUS_PIPELINE['pre_cadastro'];
                const criadoEm = lead.criadoEm?.toDate();
                
                // Nome do cliente
                const nomeExibir = lead.nomeEmpresa || lead.nome || 'Sem nome';
                const telefone = lead.whatsapp || lead.telefone || '-';
                
                // Data/hora de cadastro
                const dataFormatada = criadoEm ? criadoEm.toLocaleDateString('pt-BR') : '-';
                const horaFormatada = criadoEm ? criadoEm.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
                
                // Badge de indica√ß√£o
                let origemBadge = '<span class="origem-badge direto">Direto</span>';
                if (lead.empresaParceiraCodigo) {
                    origemBadge = `<span class="origem-badge parceiro">ü§ù ${lead.empresaParceiraCodigo}</span>`;
                } else if (lead.indicadoPorCodigo) {
                    origemBadge = `<span class="origem-badge indicacao">üéÅ ${lead.indicadoPorCodigo}</span>`;
                }
                
                // Respons√°vel
                let responsavelHtml = '<span class="nao-atribuido">N√£o atribu√≠do</span>';
                if (lead.responsavelNome) {
                    const iniciais = lead.responsavelNome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    responsavelHtml = `
                        <div class="responsavel-cell">
                            <div class="responsavel-avatar">${iniciais}</div>
                            <span class="responsavel-nome">${lead.responsavelNome}</span>
                        </div>
                    `;
                }
                
                return `
                    <tr onclick="abrirLead('${lead.id}')" style="cursor: pointer;">
                        <td>
                            <strong>${nomeExibir}</strong>
                            <br><small style="color: var(--text-muted);">${telefone}</small>
                        </td>
                        <td>
                            <div class="data-hora">
                                <span class="data">${dataFormatada}</span>
                                <br><span class="hora">${horaFormatada}</span>
                            </div>
                        </td>
                        <td><span class="lead-ramo ${lead.ramo}">${lead.ramo?.toUpperCase() || '-'}</span></td>
                        <td>${origemBadge}</td>
                        <td>${responsavelHtml}</td>
                        <td><span class="status-badge ${status.classe}">${status.label}</span></td>
                        <td class="acoes-cell">
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); abrirWhatsApp('${lead.whatsapp}')" title="WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); abrirLead('${lead.id}')" title="Detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function atualizarInfoResultados(qtdExibidos, qtdFiltrados) {
            document.getElementById('qtdExibidos').textContent = qtdExibidos;
            document.getElementById('qtdTotal').textContent = qtdFiltrados !== undefined ? qtdFiltrados : totalLeads;
            
            const filtrosAtivos = filtrosAtuais.ramo || filtrosAtuais.status || filtrosAtuais.dataDe || filtrosAtuais.dataAte || filtrosAtuais.telefone;
            document.getElementById('filtrosAtivos').style.display = filtrosAtivos ? 'inline' : 'none';
        }

        function atualizarBotaoPaginacao() {
            const btn = document.getElementById('btnCarregarMais');
            const container = document.getElementById('paginacaoContainer');
            
            if (todosLeadsCarregados) {
                container.style.display = 'none';
            } else {
                container.style.display = 'flex';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-chevron-down"></i><span>Carregar mais leads</span>';
            }
        }

        async function carregarMaisLeads() {
            const btn = document.getElementById('btnCarregarMais');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner-small"></div><span>Carregando...</span>';
            
            await carregarLeadsRecentes(false);
        }

        // ============================================================
        // FILTROS
        // ============================================================
        function aplicarFiltros() {
            filtrosAtuais.ramo = document.getElementById('filtroRamo').value;
            filtrosAtuais.status = document.getElementById('filtroStatus').value;
            filtrosAtuais.dataDe = document.getElementById('filtroDataDe').value || null;
            filtrosAtuais.dataAte = document.getElementById('filtroDataAte').value || null;
            filtrosAtuais.telefone = document.getElementById('filtroTelefone').value;
            
            // Resetar pagina√ß√£o e recarregar
            leadsExibidos = [];
            todosLeadsCarregados = false;
            carregarLeadsRecentes(false); // false = usa cache do banco
        }

        function limparFiltros() {
            document.getElementById('filtroRamo').value = '';
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroDataDe').value = '';
            document.getElementById('filtroDataAte').value = '';
            document.getElementById('filtroTelefone').value = '';
            
            filtrosAtuais = {
                ramo: '',
                status: '',
                dataDe: null,
                dataAte: null,
                telefone: ''
            };
            
            // Resetar pagina√ß√£o e recarregar
            leadsExibidos = [];
            todosLeadsCarregados = false;
            carregarLeadsRecentes(false); // false = usa cache do banco
        }

        // ============================================================
        // ATIVIDADES
        // ============================================================
        async function carregarAtividades() {
            try {
                const atividadesSnapshot = await db.collection(COLECOES.atividades)
                    .orderBy('dataHora', 'desc')
                    .limit(10)
                    .get();
                
                const timeline = document.getElementById('atividadesTimeline');
                
                if (atividadesSnapshot.empty) {
                    timeline.innerHTML = `
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <i class="fas fa-history" style="font-size: 30px; color: var(--text-muted);"></i>
                            <p>Nenhuma atividade recente</p>
                        </div>
                    `;
                    return;
                }
                
                timeline.innerHTML = '';
                
                atividadesSnapshot.forEach(doc => {
                    const atividade = doc.data();
                    const data = atividade.dataHora?.toDate();
                    
                    timeline.innerHTML += `
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <div class="timeline-date">${formatarDataHora(data)}</div>
                                <div class="timeline-text">${atividade.descricao || '-'}</div>
                            </div>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error('Erro ao carregar atividades:', error);
            }
        }

        // ============================================================
        // LEADS POR RESPONS√ÅVEL
        // ============================================================
        async function carregarLeadsPorResponsavel() {
            try {
                const leadsSnapshot = await db.collection(COLECOES.leads).get();
                
                const porResponsavel = {};
                
                leadsSnapshot.forEach(doc => {
                    const lead = doc.data();
                    const resp = lead.responsavelNome || 'N√£o atribu√≠do';
                    
                    if (!porResponsavel[resp]) {
                        porResponsavel[resp] = { novos: 0, andamento: 0, fechados: 0, perdidos: 0 };
                    }
                    
                    switch(lead.status) {
                        case 'pre_cadastro':
                            porResponsavel[resp].novos++;
                            break;
                        case 'contato_realizado':
                        case 'pendente_documentos':
                        case 'cotacao_enviada':
                            porResponsavel[resp].andamento++;
                            break;
                        case 'negocio_fechado':
                            porResponsavel[resp].fechados++;
                            break;
                        case 'negocio_perdido':
                        case 'recusada_seguradora':
                            porResponsavel[resp].perdidos++;
                            break;
                    }
                });
                
                const tbody = document.getElementById('leadsPorResponsavel');
                
                if (Object.keys(porResponsavel).length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">Nenhum dado dispon√≠vel</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = '';
                
                for (const [nome, dados] of Object.entries(porResponsavel)) {
                    const total = dados.fechados + dados.perdidos;
                    const conversao = total > 0 ? Math.round((dados.fechados / total) * 100) : 0;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${nome}</strong></td>
                            <td>${dados.novos}</td>
                            <td>${dados.andamento}</td>
                            <td style="color: var(--success);">${dados.fechados}</td>
                            <td style="color: var(--danger);">${dados.perdidos}</td>
                            <td><span class="status-badge ${conversao >= 50 ? 'fechado' : 'pendente-doc'}">${conversao}%</span></td>
                        </tr>
                    `;
                }
                
            } catch (error) {
                console.error('Erro ao carregar leads por respons√°vel:', error);
            }
        }

        // ============================================================
        // FUNCION√ÅRIOS
        // ============================================================
        async function carregarFuncionarios() {
            try {
                const funcionariosSnapshot = await db.collection(COLECOES.funcionarios)
                    .where('ativo', '==', true)
                    .get();
                
                const select = document.getElementById('leadResponsavel');
                
                funcionariosSnapshot.forEach(doc => {
                    const func = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${func.nome || func.email}</option>`;
                });
                
            } catch (error) {
                console.error('Erro ao carregar funcion√°rios:', error);
            }
        }

        // ============================================================
        // SALVAR NOVO LEAD
        // ============================================================
        async function salvarNovoLead() {
            const nome = document.getElementById('leadNome').value.trim();
            const email = document.getElementById('leadEmail').value.trim();
            const whatsapp = document.getElementById('leadWhatsapp').value.trim();
            const cpf = document.getElementById('leadCpf').value.trim();
            const nascimento = document.getElementById('leadNascimento').value;
            const cep = document.getElementById('leadCep').value.trim();
            const cidade = document.getElementById('leadCidade').value.trim();
            const estado = document.getElementById('leadEstado').value.trim();
            const ramo = document.getElementById('leadRamo').value;
            const responsavelId = document.getElementById('leadResponsavel').value;
            const observacoes = document.getElementById('leadObservacoes').value.trim();
            
            if (!nome || !whatsapp || !ramo) {
                alert('Preencha os campos obrigat√≥rios: Nome, WhatsApp e Ramo');
                return;
            }
            
            try {
                let responsavelNome = null;
                if (responsavelId) {
                    const funcDoc = await db.collection(COLECOES.funcionarios).doc(responsavelId).get();
                    if (funcDoc.exists) {
                        responsavelNome = funcDoc.data().nome || funcDoc.data().email;
                    }
                }
                
                await db.collection(COLECOES.leads).add({
                    nome,
                    email,
                    whatsapp,
                    cpf,
                    dataNascimento: nascimento || null,
                    cep,
                    cidade,
                    estado,
                    ramo,
                    responsavelId: responsavelId || null,
                    responsavelNome,
                    observacoes,
                    status: 'pre_cadastro',
                    origem: 'admin',
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection(COLECOES.atividades).add({
                    tipo: 'lead_criado',
                    descricao: `Novo lead criado: ${nome} (${ramo})`,
                    dataHora: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                fecharModal('modalNovoLead');
                document.getElementById('formNovoLead').reset();
                
                carregarEstatisticas();
                carregarLeadsRecentes(true);
                carregarAtividades();
                
                alert('Lead criado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao salvar lead:', error);
                alert('Erro ao salvar lead: ' + error.message);
            }
        }

        // ============================================================
        // UTILIT√ÅRIOS
        // ============================================================
        function formatarDataHora(data) {
            if (!data) return '-';
            return data.toLocaleDateString('pt-BR') + ', ' + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function abrirLead(id) {
            window.location.href = `lead-detalhe.html?id=${id}`;
        }

        function abrirWhatsApp(numero) {
            if (!numero) {
                alert('N√∫mero n√£o dispon√≠vel');
                return;
            }
            const numeroLimpo = numero.replace(/\D/g, '');
            const numeroComCodigo = numeroLimpo.startsWith('55') ? numeroLimpo : '55' + numeroLimpo;
            window.open(`https://wa.me/${numeroComCodigo}`, '_blank');
        }

        function abrirModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        async function buscarCep() {
            const cep = document.getElementById('leadCep').value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                
                if (!data.erro) {
                    document.getElementById('leadCidade').value = data.localidade || '';
                    document.getElementById('leadEstado').value = data.uf || '';
                }
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
            }
        }

        function buscarGlobal(event) {
            if (event.key === 'Enter') {
                const termo = document.getElementById('searchGlobal').value.trim();
                if (termo) {
                    window.location.href = `leads.html?busca=${encodeURIComponent(termo)}`;
                }
            }
        }

        function toggleNotificacoes() {
            alert('Notifica√ß√µes em desenvolvimento');
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }
    </script>
</body>
</html>
