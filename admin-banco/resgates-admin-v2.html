<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Aprova√ß√£o de Resgates - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="js/firebase-config.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--primary:#1e40af;--primary-hover:#1e3a8a;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-600:#4b5563;--gray-700:#374151;--gray-900:#111827;--shadow:0 1px 3px rgba(0,0,0,.1);--shadow-md:0 4px 6px -1px rgba(0,0,0,.1);--shadow-lg:0 10px 15px -3px rgba(0,0,0,.1)}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(135deg,#f97316 0%,#ea580c 100%);min-height:100vh;padding:20px;color:var(--gray-900)}
    .container{max-width:1400px;margin:0 auto}
    .header{background:#fff;border-radius:16px;padding:20px 28px;margin-bottom:20px;box-shadow:var(--shadow-md);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px}
    .header-left{display:flex;align-items:center;gap:16px}
    .btn-back{background:var(--gray-100);border:none;border-radius:10px;padding:10px 16px;cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:600;color:var(--gray-700);transition:all .2s;font-size:14px}
    .btn-back:hover{background:var(--gray-200);transform:translateX(-2px)}
    .header-title h1{font-size:24px;font-weight:700;color:var(--gray-900)}
    .header-title p{font-size:13px;color:var(--gray-600)}
    .card{background:#fff;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:var(--shadow-md)}
    .card-header{margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid var(--gray-100);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .card-header h2{font-size:16px;font-weight:600;color:var(--gray-900)}
    .stats-row{display:flex;gap:12px;flex-wrap:wrap}
    .stat-badge{background:linear-gradient(135deg,var(--primary) 0%,#3b82f6 100%);color:#fff;padding:10px 18px;border-radius:10px;font-weight:700;font-size:14px;box-shadow:var(--shadow)}
    .stat-badge.green{background:linear-gradient(135deg,#10b981 0%,#059669 100%)}
    .stat-badge.orange{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%)}
    .filters-row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-size:12px;font-weight:600;color:var(--gray-700)}
    .form-control{padding:10px 14px;border:2px solid var(--gray-200);border-radius:8px;font-size:14px;transition:all .2s;background:#fff;min-width:160px}
    .form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,64,175,.1)}
    .btn{padding:10px 20px;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-hover);transform:translateY(-1px)}
    .btn-secondary{background:var(--gray-100);color:var(--gray-700)}
    .btn-secondary:hover{background:var(--gray-200)}
    .btn-success{background:var(--success);color:#fff}
    .btn-success:hover{background:#059669}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-danger:hover{background:#dc2626}
    .btn-sm{padding:8px 14px;font-size:13px}
    .table-container{overflow-x:auto;border-radius:10px;border:1px solid var(--gray-200)}
    table{width:100%;border-collapse:collapse;background:#fff}
    thead th{background:var(--gray-50);padding:14px;text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--gray-600);letter-spacing:.05em;border-bottom:2px solid var(--gray-200)}
    tbody td{padding:14px;border-bottom:1px solid var(--gray-100);font-size:13px;color:var(--gray-700);vertical-align:top}
    tbody tr:hover{background:var(--gray-50)}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600}
    .badge-success{background:#d1fae5;color:#065f46}
    .badge-warning{background:#fef3c7;color:#92400e}
    .badge-danger{background:#fee2e2;color:#991b1b}
    .badge-info{background:#dbeafe;color:#1e40af}
    .ellipsis{max-width:280px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .actions-cell{display:flex;gap:8px;flex-wrap:wrap}
    .pagination{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:20px;padding-top:16px;border-top:2px solid var(--gray-100)}
    .pagination-btn{padding:8px 14px;border:2px solid var(--gray-200);background:#fff;border-radius:6px;font-weight:600;cursor:pointer;transition:all .2s;font-size:13px}
    .pagination-btn:hover:not(:disabled){background:var(--primary);color:#fff;border-color:var(--primary)}
    .pagination-btn:disabled{opacity:.4;cursor:not-allowed}
    .pagination-info{padding:8px 14px;font-size:13px;color:var(--gray-600);font-weight:600}
    .toast{position:fixed;bottom:20px;right:20px;background:#fff;padding:14px 20px;border-radius:10px;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px;transform:translateY(100px);opacity:0;transition:all .3s;z-index:2000;font-weight:600;font-size:14px}
    .toast.show{transform:translateY(0);opacity:1}
    .toast-success{border-left:4px solid var(--success)}
    .toast-error{border-left:4px solid var(--danger)}
    .empty-state{text-align:center;padding:40px;color:var(--gray-600)}
    .user-info{display:flex;flex-direction:column;gap:2px}
    .user-name{font-weight:600;color:var(--gray-900)}
    .user-email{font-size:12px;color:var(--gray-600)}
    .date-info{display:flex;flex-direction:column;gap:2px}
    .date-main{font-weight:600}
    .date-sub{font-size:11px;color:var(--gray-600)}
    .valor-cell{font-weight:700;color:var(--primary);font-size:15px}
    @media(max-width:768px){body{padding:12px}.header{padding:16px;flex-direction:column;align-items:stretch}.filters-row{flex-direction:column}.form-control{width:100%}.ellipsis{max-width:160px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="btn-back" onclick="window.location.href='painel.html'">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none"><path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Voltar ao Painel
        </button>
        <div class="header-title">
          <h1>üßæ Aprova√ß√£o de Resgates</h1>
          <p>Gerencie solicita√ß√µes de pagamento dos colaboradores</p>
        </div>
      </div>
      <button class="btn btn-secondary" onclick="location.reload()">üîÑ Atualizar</button>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>üîç Filtros</h2>
        <div class="stats-row">
          <div class="stat-badge" id="countTotal">0 itens</div>
          <div class="stat-badge green" id="somaTotal">R$ 0,00</div>
        </div>
      </div>
      <div class="filters-row">
        <div class="form-group">
          <label>Status</label>
          <select class="form-control" id="fStatus">
            <option value="pendente">Pendentes</option>
            <option value="pago">Pagos</option>
            <option value="negado">Negados</option>
            <option value="">Todos</option>
          </select>
        </div>
        <div class="form-group">
          <label>Usu√°rio (nome ou e-mail)</label>
          <input type="text" class="form-control" id="fUser" placeholder="Digite para filtrar...">
        </div>
        <button class="btn btn-primary" id="btnAplicar">üîç Aplicar</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>üìã Solicita√ß√µes de Resgate</h2>
        <p id="infoQtd" style="font-size:13px;color:var(--gray-600)">Carregando...</p>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Usu√°rio</th>
              <th>M√©todo</th>
              <th>Detalhes do Pagamento</th>
              <th>Valor</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" class="empty-state">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="pagination" style="display:none">
        <button class="pagination-btn" id="btnPrevPage">‚óÄ Anterior</button>
        <div class="pagination-info" id="pageInfo">P√°gina 1 de 1</div>
        <button class="pagination-btn" id="btnNextPage">Pr√≥ximo ‚ñ∂</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
if(!firebase.apps.length&&typeof firebaseConfig!=="undefined")firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore();
const RES=db.collection("resgates_carteira"),USERS=db.collection("usuarios_banco");

const $=id=>document.getElementById(id);
const brl=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
const money=n=>brl.format(Number(n||0));

let isAdmin=false,cache=[],mapUser={},dadosFiltrados=[];
let currentPage=1,totalPages=1;
const ITEMS_PER_PAGE=15;

function showToast(msg,type='success'){const t=$('toast');t.textContent=msg;t.className=`toast toast-${type} show`;setTimeout(()=>t.classList.remove('show'),3000)}

auth.onAuthStateChanged(async u=>{
  if(!u){location.href="login.html";return}
  const prof=(await USERS.doc(u.uid).get()).data()||{};
  isAdmin=(prof.perfil||"").toLowerCase()==="admin"||u.email==="patrick@retornoseguros.com.br";
  if(!isAdmin){alert("Somente admin.");location.href="painel.html";return}
  await carregar();
  $("btnAplicar").onclick=aplicar;
  $("btnPrevPage")?.addEventListener("click",()=>{if(currentPage>1){currentPage--;render(dadosFiltrados)}});
  $("btnNextPage")?.addEventListener("click",()=>{if(currentPage<totalPages){currentPage++;render(dadosFiltrados)}});
});

function asDate(x){try{if(!x)return null;if(typeof x==="string")return new Date(x);if(x instanceof Date)return x;if(x.toDate)return x.toDate()}catch(e){}return null}
function dateBR(x){const d=asDate(x);return d&&!isNaN(+d)?d.toLocaleDateString("pt-BR"):"-"}
function esc(s=""){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]))}

async function carregar(){
  const us=await USERS.get();us.forEach(d=>mapUser[d.id]=d.data()?.nome||d.id);
  const snap=await RES.get();
  cache=snap.docs.map(d=>({id:d.id,...(d.data()||{})}));
  aplicar();
}

function aplicar(){
  const st=($("fStatus").value||"").toLowerCase();
  const q=($("fUser").value||"").toLowerCase();
  dadosFiltrados=[...cache];
  if(st)dadosFiltrados=dadosFiltrados.filter(x=>(x.status||"").toLowerCase()===st);
  if(q)dadosFiltrados=dadosFiltrados.filter(x=>(x.userNome||"").toLowerCase().includes(q)||(x.userEmail||"").toLowerCase().includes(q));
  currentPage=1;
  render(dadosFiltrados);
}

function render(list){
  const tb=$("tbody");tb.innerHTML="";
  if(!list.length){
    tb.innerHTML=`<tr><td colspan="7" class="empty-state"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="margin-bottom:12px;opacity:.3"><path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2"/></svg><div style="font-size:15px;font-weight:600">Nenhuma solicita√ß√£o</div><div style="font-size:13px;margin-top:6px">Ajuste os filtros</div></td></tr>`;
    $("countTotal").textContent="0 itens";$("somaTotal").textContent="R$ 0,00";$("infoQtd").textContent="0 solicita√ß√µes";$("pagination").style.display="none";return;
  }

  // Pagina√ß√£o
  totalPages=Math.ceil(list.length/ITEMS_PER_PAGE);
  const start=(currentPage-1)*ITEMS_PER_PAGE,end=start+ITEMS_PER_PAGE;
  const paginatedList=list.slice(start,end);

  // Totais gerais (toda a lista filtrada)
  const somaGeral=list.reduce((s,r)=>s+Number(r.valor||0),0);
  $("countTotal").textContent=`${list.length} item(s)`;
  $("soma