<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Chat da Cotação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="js/firebase-config.js"></script>

  <style>
    :root{
      --azul:#004080; --azul-esc:#002e5a; --bg:#f4f7fa; --bord:#e6e9ef;
    }
    *{box-sizing:border-box}
    body{font-family:"Segoe UI",system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:20px}
    h2{color:var(--azul);margin:0 0 16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.06);padding:20px;margin:0 auto 18px;max-width:1100px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-weight:600;display:block;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--bord);border-radius:8px;font-size:15px;background:#fff}
    textarea{min-height:110px;resize:vertical}
    .btn{background:var(--azul);color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer}
    .btn:hover{background:var(--azul-esc)}
    .muted{color:#667085;font-size:13px}
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns:1fr 1fr}
    .valor-wrap{display:flex;align-items:center;gap:8px}
    .mensagem{border:1px solid var(--bord);border-radius:10px;padding:10px 12px;margin-bottom:10px;background:#fbfdff}
    .mensagem strong{color:#1f2937}
    @media (max-width:900px){.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <div class="card">
    <h2>Detalhes da Cotação</h2>
    <div class="grid grid-2">
      <div>
        <div><strong>Empresa:</strong> <span id="empresaNome"></span></div>
        <div class="muted">CNPJ: <span id="empresaCNPJ"></span></div>
        <div class="muted">Ramo: <span id="ramo"></span></div>
      </div>
      <div>
        <div class="valor-wrap">
          <strong>Valor desejado:</strong>
          <span id="valorDesejadoTexto"></span>
          <input id="valorDesejadoInput" type="text" style="display:none;max-width:170px" placeholder="R$ 0,00" />
          <button id="btnSalvarValor" class="btn" style="display:none" onclick="salvarNovoValor()">Salvar</button>
        </div>
        <div class="muted" id="vigenciaAtual" style="margin-top:6px;"></div>
        <div style="margin-top:8px"><strong>Status:</strong> <span id="status"></span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Interações</h3>
    <div id="historico">Carregando...</div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Alterar Status</h3>
    <div class="grid grid-2">
      <div>
        <label for="novoStatus">Novo status</label>
        <select id="novoStatus">
          <option value="">Carregando opções...</option>
        </select>
      </div>

      <div id="motivoContainer" style="display:none">
        <label for="motivoRecusa">Motivo</label>
        <select id="motivoRecusa"><option value="">Selecione o motivo</option></select>
      </div>
    </div>

    <!-- Campos de vigência aparecem somente quando escolhe "Negócio Emitido" -->
    <div id="vigenciaContainer" class="grid grid-2" style="display:none;margin-top:10px">
      <div>
        <label for="inicioVigencia">Início da vigência</label>
        <input type="date" id="inicioVigencia" />
      </div>
      <div>
        <label for="fimVigencia">Fim da vigência</label>
        <input type="date" id="fimVigencia" />
      </div>
    </div>

    <div style="margin-top:12px">
      <button class="btn" onclick="atualizarStatus()">Atualizar Status</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Nova Observação</h3>
    <textarea id="novaMensagem" placeholder="Digite uma observação..."></textarea>
    <div style="margin-top:8px">
      <button class="btn" onclick="enviarMensagem()">Enviar</button>
    </div>
  </div>

  <script src="js/chat-cotacao.js" defer></script>

  <!-- Máscara de moeda (mesma usada em cotações) -->
  <script>
    function formatarMoeda(input){
      let v=(input.value||'').replace(/\D/g,'');
      if(!v){ input.value='R$ 0,00'; return; }
      v=(parseInt(v,10)/100).toFixed(2).replace('.',',');
      v=v.replace(/\B(?=(\d{3})+(?!\d))/g,'.');
      input.value='R$ '+v;
    }
    function desformatarMoeda(str){ if(!str) return 0; return parseFloat(str.replace(/[^\d]/g,'')/100); }
  </script>
</body>
</html>
