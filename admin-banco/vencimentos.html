<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>RelatÃ³rio de Vencimentos</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <style>
    body { font-family: Arial; background: #f4f4f8; padding: 20px; }
    h2 { color: #004080; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eaeaea; }
  </style>
</head>
<body>

<h2>ðŸ“… RelatÃ³rio de Vencimentos</h2>
<table id="tabela-vencimentos">
  <thead>
    <tr>
      <th>Empresa</th>
      <th>Ramo</th>
      <th>RM</th>
      <th>Valor</th>
      <th>Data RenovaÃ§Ã£o</th>
      <th>Origem</th>
    </tr>
  </thead>
  <tbody id="corpo-tabela">
    <tr><td colspan="6">Carregando...</td></tr>
  </tbody>
</table>

<script>
  // CONFIG FIREBASE RETORNO
  const firebaseConfig = {
    apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
    authDomain: "retorno-seguros.firebaseapp.com",
    projectId: "retorno-seguros",
    storageBucket: "retorno-seguros.appspot.com",
    messagingSenderId: "495712392972",
    appId: "1:495712392972:web:e1e78aedc48bdeea48db29"
  };
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.firestore();

  async function carregarVencimentos() {
    const tabela = document.getElementById("corpo-tabela");
    tabela.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";
    let linhas = "";

    try {
      const snapshot = await db.collection("visitas").get();
      snapshot.forEach(doc => {
        const data = doc.data();
        const empresa = data.empresaNome || "-";
        const rm = data.rmNome || "-";

        const ramos = data.ramos || {};
        for (const ramo in ramos) {
          const info = ramos[ramo];
          if (info && info.vencimento) {
            const venc = info.vencimento;
            const dia = venc.day || "00";
            const mes = venc.month || "00";
            const dataRenovacao = `${String(dia).padStart(2, '0')}/${String(mes).padStart(2, '0')}`;
            const valor = info.valor || "-";

            linhas += `
              <tr>
                <td>${empresa}</td>
                <td>${ramo}</td>
                <td>${rm}</td>
                <td>${valor}</td>
                <td>${dataRenovacao}</td>
                <td>Mapeado em visita</td>
              </tr>
            `;
          }
        }
      });

      tabela.innerHTML = linhas || "<tr><td colspan='6'>Nenhum dado encontrado.</td></tr>";
    } catch (e) {
      console.error("Erro:", e);
      tabela.innerHTML = `<tr><td colspan='6'>Erro ao carregar dados: ${e.message}</td></tr>`;
    }
  }

  window.onload = carregarVencimentos;
</script>

</body>
</html>
