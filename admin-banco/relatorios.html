<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Relatórios & Insights</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme:{ extend:{ boxShadow:{ soft:'0 10px 30px rgba(0,0,0,0.06)'} } } }
  </script>

  <!-- Chart.js + datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- Firebase app (preencha a config se necessário) -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    const firebaseConfig = {
      /* TODO: se esta página for standalone, cole aqui sua config Firebase */
      // apiKey: "...", authDomain: "...", projectId: "...", appId: "..."
    };
    if (!getApps().length && firebaseConfig.projectId) { initializeApp(firebaseConfig); }
  </script>

  <style>
    .card { background:#fff; border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,.06); padding:1.25rem; }
    .kpi .label{ font-size:.85rem; color:#64748b }
    .kpi .value{ font-size:1.4rem; font-weight:600; color:#334155 }
    .kpi .delta{ font-size:.75rem; }
    .grid-auto-fit{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:1rem }
    .chart-wrap{ background:#fff; border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,.06); padding:1rem; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; border-radius:.75rem; padding:.5rem 1rem; font-weight:500; background:#0f172a; color:#fff }
    .btn:hover{ background:#334155 }
    .btn-ghost{ display:inline-flex; align-items:center; border-radius:.75rem; padding:.45rem .75rem; color:#475569 }
    .btn-ghost:hover{ background:#f1f5f9 }
    .input, select, input[type="date"]{ width:100%; border-radius:.75rem; border:1px solid #e2e8f0; padding:.5rem .75rem; background:#fff; color:#334155; outline:0 }
    .input:focus, select:focus{ box-shadow:0 0 0 2px #cbd5e1 }
    .badge{ font-size:.75rem; padding:.15rem .5rem; border-radius:999px; background:#f1f5f9; color:#475569 }
    .table{ width:100%; font-size:.9rem }
    .table th{ text-align:left; color:#64748b; font-weight:600; border-bottom:1px solid #e2e8f0; padding:.5rem 0 }
    .table td{ border-bottom:1px solid #f1f5f9; padding:.5rem 0 }
    @media (max-width:768px){ .hide-sm{ display:none } }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-20 backdrop-blur bg-white/70 border-b border-slate-100">
    <div class="max-w-7xl mx-auto px-3 py-3 flex flex-col md:flex-row md:items-center gap-3">
      <h1 class="text-xl font-semibold">Relatórios & Insights</h1>
      <div class="md:ml-auto flex items-center gap-2">
        <button id="btn-save-view" class="btn-ghost">Salvar filtros</button>
        <button id="btn-load-view" class="btn-ghost">Carregar filtros</button>
        <button id="btn-export" class="btn">Exportar CSV</button>
      </div>
    </div>
  </header>

  <section class="max-w-7xl mx-auto px-3 mt-4">
    <div class="card">
      <div class="grid md:grid-cols-6 sm:grid-cols-2 gap-3">
        <div><label class="text-sm text-slate-500">Data inicial</label><input type="date" id="f-data-inicio" class="input" /></div>
        <div><label class="text-sm text-slate-500">Data final</label><input type="date" id="f-data-fim" class="input" /></div>
        <div><label class="text-sm text-slate-500">Agência</label><select id="f-agencia" class="input"></select></div>
        <div><label class="text-sm text-slate-500">RM</label><select id="f-rm" class="input"></select></div>
        <div><label class="text-sm text-slate-500">Status</label><select id="f-status" class="input" multiple></select><small class="text-xs text-slate-400">Ctrl/Cmd+clique p/ múltiplos</small></div>
        <div><label class="text-sm text-slate-500">Ramo</label><select id="f-ramo" class="input" multiple></select></div>
        <div><label class="text-sm text-slate-500">Seguradora</label><select id="f-seguradora" class="input" multiple></select></div>
        <div><label class="text-sm text-slate-500">Tipo</label><select id="f-tipo" class="input"><option value="">Todos</option><option value="presencial">Presencial</option><option value="online">Online</option></select></div>
        <div class="md:col-span-2"><label class="text-sm text-slate-500">Empresa (texto)</label><input type="text" id="f-empresa" class="input" placeholder="Digite parte do nome..." /></div>
        <div class="flex items-end gap-2"><button id="btn-aplicar" class="btn w-full">Aplicar filtros</button></div>
        <div class="flex items-end"><button id="btn-limpar" class="btn-ghost w-full">Limpar</button></div>
        <div class="flex items-end"><label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="chk-yoy" />Comparar com ano anterior</label></div>
      </div>
      <div class="mt-3 text-xs text-slate-500">Dica: salve combinações de filtros frequentes.</div>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-3 mt-4">
    <div class="grid-auto-fit">
      <div class="card kpi"><div class="label">Prêmio total</div><div id="kpi-premio" class="value">—</div><div id="kpi-premio-delta" class="delta"></div></div>
      <div class="card kpi"><div class="label">Cotações</div><div id="kpi-qtd" class="value">—</div><div id="kpi-qtd-delta" class="delta"></div></div>
      <div class="card kpi"><div class="label">Negócios emitidos</div><div id="kpi-emitidos" class="value">—</div><div id="kpi-emitidos-delta" class="delta"></div></div>
      <div class="card kpi"><div class="label">Conversão</div><div id="kpi-conversao" class="value">—</div><div id="kpi-conversao-delta" class="delta"></div></div>
      <div class="card kpi"><div class="label">Ticket médio</div><div id="kpi-ticket" class="value">—</div><div id="kpi-ticket-delta" class="delta"></div></div>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-3 mt-4 grid grid-cols-1 lg:grid-cols-6 gap-4">
    <div class="chart-wrap lg:col-span-2">
      <div class="flex items-center justify-between mb-2"><h3 class="font-semibold">Distribuição por Status</h3><span id="legend-status" class="badge">—</span></div>
      <canvas id="chartStatus" height="240"></canvas>
    </div>
    <div class="chart-wrap lg:col-span-4">
      <div class="flex items-center justify-between mb-2"><h3 class="font-semibold">Prêmio por mês — Ano atual vs anterior</h3><span id="legend-linhas" class="badge">—</span></div>
      <canvas id="chartLinhas" height="240"></canvas>
    </div>
    <div class="chart-wrap lg:col-span-3">
      <div class="flex items-center justify-between mb-2"><h3 class="font-semibold">Top Ramos (Prêmio)</h3><span id="legend-ramo" class="badge">—</span></div>
      <canvas id="chartRamo" height="240"></canvas>
    </div>
    <div class="chart-wrap lg:col-span-3">
      <div class="flex items-center justify-between mb-2"><h3 class="font-semibold">Top RMs (Prêmio)</h3><span id="legend-rm" class="badge">—</span></div>
      <canvas id="chartRM" height="240"></canvas>
    </div>
    <div class="chart-wrap lg:col-span-6">
      <div class="flex items-center justify-between mb-2"><h3 class="font-semibold">Mix por Seguradora (Prêmio)</h3><span id="legend-seguradora" class="badge">—</span></div>
      <canvas id="chartSeguradora" height="240"></canvas>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-3 my-6">
    <div class="card">
      <div class="flex items-center justify-between mb-3"><h3 class="font-semibold">Resultados do filtro</h3><div class="text-xs text-slate-500">Mostrando <span id="lbl-count">0</span> registros</div></div>
      <div class="overflow-x-auto">
        <table class="table" id="tabela">
          <thead><tr>
            <th>Data</th><th>Empresa</th><th class="hide-sm">Agência</th><th>RM</th><th>Status</th>
            <th class="hide-sm">Ramo</th><th class="hide-sm">Seguradora</th><th>Prêmio</th><th class="hide-sm">Tipo</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- === JS INLINE (era o relatorios.js) === -->
  <script type="module">
    // -------- CONFIG --------
    const CFG = {
      collections: {
        cotacoes: "cotacoes-gerentes",
        agencias:  "agencias",
        usuarios:  "usuarios_banco",
        empresas:  "empresas",
      },
      fields: {
        createdAt: ["createdAt","dataCriacao","criadoEm","data"],
        updatedAt: ["updatedAt","atualizadoEm"],
        empresaNome: ["empresaNome","empresa","razaoSocial","nomeEmpresa"],
        empresaId: ["empresaId","empresaID"],
        agenciaId: ["agenciaId","agenciaID"],
        agenciaNome: ["agenciaNome","agencia"],
        rmUid: ["rmUid","rmId","rmUID"],
        rmNome: ["rmNome","rm","responsavel"],
        status: ["status"],
        ramo: ["ramo","produto"],
        seguradora: ["seguradora"],
        tipo: ["tipo"],
        premio: ["premio","premio_total","valorPremio","premioNegocio"],
        statusEmitidoMatch: ["Negócio Emitido","Negócio Fechado","Emitido","Em Emissão"]
      },
      statusAliases: {
        "Negócio Fechado":"Negócio Emitido",
        "Pendente Agência":"Pendente","Pendente Corretor":"Pendente","Pendente Seguradora":"Pendente","Pendente Cliente":"Pendente",
        "Emitido Declinado":"Recusado","Recusado Seguradora":"Recusado","Recusado Cliente":"Recusado"
      },
      currency: new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}),
      number: new Intl.NumberFormat("pt-BR"),
      dateFmt(d){ const dd=String(d.getDate()).padStart(2,"0"); const mm=String(d.getMonth()+1).padStart(2,"0"); return `${dd}/${mm}/${d.getFullYear()}`; }
    };

    // Firebase imports
    import { getFirestore, collection, query, where, orderBy, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    const db = getFirestore(getApp());

    // Utils
    const $ = s=>document.querySelector(s);
    const $$= s=>Array.from(document.querySelectorAll(s));
    function pick(o,keys,f=null){ for(const k of keys){ if(o&&o[k]!=null) return o[k]; } return f; }
    function parseMaybeDate(v){ if(!v) return null; if(v instanceof Timestamp) return v.toDate(); if(v.toDate) return v.toDate(); if(v instanceof Date) return v;
      if(typeof v==="string"){ const m=v.trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if(m){ return new Date(Number(m[3]),Number(m[2])-1,Number(m[1]),12,0,0); }
        const d=new Date(v); if(!isNaN(d)) return d; } return null; }
    function normalizeStatus(s){ if(!s) return "Sem status"; return CFG.statusAliases[s] || s; }
    function isEmitido(s){ return CFG.fields.statusEmitidoMatch.includes(normalizeStatus(s)); }
    function toNumberPremio(v){ if(typeof v==="number") return v; if(typeof v==="string"){ const n=parseFloat(v.replace(/[R$\s\.]/g,"").replace(",","."));
      return isNaN(n)?0:n; } return 0; }
    function groupBy(arr,fn){ const m=new Map(); for(const it of arr){ const k=fn(it); m.set(k,(m.get(k)||[]).concat(it)); } return m; }
    function sum(a,fn){ let t=0; for(const it of a){ t+=fn(it)||0; } return t; }
    function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`; }
    function rangeMonths(y){ return Array.from({length:12},(_,i)=>`${y}-${String(i+1).padStart(2,"0")}`); }
    function pctDelta(c,p){ if(p===0) return c>0?100:0; return ((c-p)/p)*100; }
    function setDelta(el,v){ if(!el) return; const s=v; const sign=s>0?"+":(s<0?"":""); el.textContent=`${sign}${s.toFixed(1)}% vs a/a`; el.className="delta "+(s>=0?"text-emerald-600":"text-rose-600"); }
    function multiSelectValues(sel){ return Array.from(sel.selectedOptions).map(o=>o.value).filter(Boolean); }
    function downloadCSV(name,rows){ const esc=v=>`"${String(v??"").replaceAll('"','""')}"`; const csv=rows.map(r=>r.map(esc).join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }

    // Estado
    let state={ raw:[], filtered:[], yoy:false, agenciaMap:new Map(), rmMap:new Map(), statusSet:new Set(), ramoSet:new Set(), seguradoraSet:new Set() };

    // Init
    init().catch(console.error);
    async function init(){
      initEvents();
      await carregarLookups();
      setDefaultDates();
      await aplicarFiltros();
    }
    function initEvents(){
      $("#btn-aplicar").addEventListener("click", aplicarFiltros);
      $("#btn-limpar").addEventListener("click", ()=>{ $$("select").forEach(s=>s.value=""); $("#f-empresa").value=""; $("#f-tipo").value=""; setDefaultDates(true); });
      $("#btn-export").addEventListener("click", exportarCSV);
      $("#btn-save-view").addEventListener("click", saveView);
      $("#btn-load-view").addEventListener("click", loadView);
      $("#chk-yoy").addEventListener("change", e=>{ state.yoy=e.target.checked; desenhar(); });
      $("#f-agencia").addEventListener("change", filtrarRMsPorAgencia);
    }
    function setDefaultDates(keep=false){ const hoje=new Date(); const inicio=new Date(hoje.getFullYear(),hoje.getMonth(),1);
      if(!keep){ $("#f-data-inicio").value=inicio.toISOString().substring(0,10); $("#f-data-fim").value=hoje.toISOString().substring(0,10); } }

    async function carregarLookups(){
      try{
        const snapAg = await getDocs(collection(db, CFG.collections.agencias));
        const selAg = $("#f-agencia"); selAg.innerHTML = `<option value="">Todas</option>`;
        snapAg.forEach(doc=>{ const d=doc.data(); const nome=d.nome||d.descricao||d.titulo||doc.id; state.agenciaMap.set(doc.id,nome);
          const opt=document.createElement("option"); opt.value=doc.id; opt.textContent=nome; selAg.appendChild(opt); });
      }catch(e){ console.warn("Agencias lookup:",e); }
      try{
        const snapU = await getDocs(collection(db, CFG.collections.usuarios));
        const selRM = $("#f-rm"); selRM.innerHTML=`<option value="">Todos</option>`;
        snapU.forEach(doc=>{ const d=doc.data(); const nome=d.nome||d.displayName||d.email||doc.id; state.rmMap.set(doc.id,nome);
          const opt=document.createElement("option"); opt.value=doc.id; opt.textContent=`${nome}${d.agenciaId?` — ${state.agenciaMap.get(d.agenciaId)||d.agenciaId}`:""}`; opt.dataset.agenciaId=d.agenciaId||""; selRM.appendChild(opt); });
      }catch(e){ console.warn("Usuarios lookup:",e); }
    }
    function filtrarRMsPorAgencia(){ const ag=$("#f-agencia").value; const selRM=$("#f-rm"); const all=Array.from(selRM.querySelectorAll("option"));
      all.forEach(o=>{ if(!o.value){ o.hidden=false; return; } const a=o.dataset.agenciaId||""; o.hidden = ag && a && a!==ag; });
      if(ag){ const curr=selRM.value; const currOpt=selRM.querySelector(`option[value="${curr}"]`); if(curr && currOpt && currOpt.hidden) selRM.value=""; } }

    async function aplicarFiltros(){
      const diStr=$("#f-data-inicio").value, dfStr=$("#f-data-fim").value;
      const di=diStr?new Date(diStr+"T00:00:00"):null, df=dfStr?new Date(dfStr+"T23:59:59"):null;

      let snap=null; const colRef=collection(db, CFG.collections.cotacoes);
      for(const key of CFG.fields.createdAt){
        try{
          if(di&&df){
            const qRef=query(colRef, where(key,">=",Timestamp.fromDate(di)), where(key,"<=",Timestamp.fromDate(df)), orderBy(key,"asc"));
            snap=await getDocs(qRef); break;
          }
        }catch(e){ /* ignora, pode ser string */ }
      }
      if(!snap){ snap=await getDocs(colRef); }

      const dados=[];
      snap.forEach(doc=>{
        const d=doc.data();
        const createdRaw=pick(d,CFG.fields.createdAt)||pick(d,CFG.fields.updatedAt);
        const dt=parseMaybeDate(createdRaw);
        if(di&&df&&dt&&(dt<di || dt>df)) return;
        const row={
          id:doc.id,
          data:dt,
          empresa: pick(d,CFG.fields.empresaNome)||"",
          empresaId: pick(d,CFG.fields.empresaId)||"",
          agenciaId: pick(d,CFG.fields.agenciaId)||"",
          agenciaNome: pick(d,CFG.fields.agenciaNome) || (d.agenciaId ? (state.agenciaMap.get(d.agenciaId)||d.agenciaId):""),
          rmUid: pick(d,CFG.fields.rmUid)||"",
          rmNome: pick(d,CFG.fields.rmNome) || "",
          status: normalizeStatus(pick(d,CFG.fields.status)||""),
          ramo: pick(d,CFG.fields.ramo)||"",
          seguradora: pick(d,CFG.fields.seguradora)||"",
          tipo: pick(d,CFG.fields.tipo)||"",
          premio: toNumberPremio(pick(d,CFG.fields.premio)||0)
        };
        // se não veio rmNome, tenta mapear
        if(!row.rmNome && row.rmUid) row.rmNome = state.rmMap.get(row.rmUid)||"";
        dados.push(row);
      });

      state.raw=dados;
      popularFacetas(dados);
      state.filtered = filtrarMemoria(dados);
      state.yoy = $("#chk-yoy").checked;
      desenhar();
    }

    function popularFacetas(dados){
      const sSel=$("#f-status"), rSel=$("#f-ramo"), sgSel=$("#f-seguradora");
      const sts=Array.from(new Set(dados.map(d=>d.status).filter(Boolean))).sort();
      const ramos=Array.from(new Set(dados.map(d=>d.ramo).filter(Boolean))).sort();
      const segs=Array.from(new Set(dados.map(d=>d.seguradora).filter(Boolean))).sort();
      if(!state.statusSet.size){ sSel.innerHTML = sts.map(s=>`<option value="${s}">${s}</option>`).join(""); state.statusSet=new Set(sts); }
      if(!state.ramoSet.size){ rSel.innerHTML = ramos.map(s=>`<option value="${s}">${s}</option>`).join(""); state.ramoSet=new Set(ramos); }
      if(!state.seguradoraSet.size){ sgSel.innerHTML = segs.map(s=>`<option value="${s}">${s}</option>`).join(""); state.seguradoraSet=new Set(segs); }
    }
    function filtrarMemoria(arr){
      const ag=$("#f-agencia").value, rm=$("#f-rm").value;
      const status=new Set(multiSelectValues($("#f-status")));
      const ramo=new Set(multiSelectValues($("#f-ramo")));
      const segur=new Set(multiSelectValues($("#f-seguradora")));
      const tipo=$("#f-tipo").value; const empresa=($("#f-empresa").value||"").toLowerCase().trim();
      return arr.filter(d=>{
        if(ag && d.agenciaId!==ag) return false;
        if(rm && d.rmUid!==rm) return false;
        if(status.size && !status.has(d.status)) return false;
        if(ramo.size && !ramo.has(d.ramo)) return false;
        if(segur.size && !segur.has(d.seguradora)) return false;
        if(tipo && d.tipo!==tipo) return false;
        if(empresa && !(d.empresa||"").toLowerCase().includes(empresa)) return false;
        return true;
      });
    }

    // Desenho
    let charts={};
    function destroyCharts(){ Object.values(charts).forEach(ch=>{ try{ ch.destroy(); }catch{} }); charts={}; }
    function desenhar(){ desenharKPIs(); desenharTabela(); destroyCharts(); desenharChartStatus(); desenharChartLinhasYoY(); desenharChartRamo(); desenharChartRM(); desenharChartSeguradora(); }

    function desenharKPIs(){
      const data=state.filtered;
      const totalPremio=sum(data,d=>d.premio); const qtd=data.length; const emitidos=data.filter(d=>isEmitido(d.status)).length;
      const conv=qtd?(emitidos/qtd):0; const ticket=qtd?(totalPremio/qtd):0;
      $("#kpi-premio").textContent=CFG.currency.format(totalPremio);
      $("#kpi-qtd").textContent=new Intl.NumberFormat("pt-BR").format(qtd);
      $("#kpi-emitidos").textContent=new Intl.NumberFormat("pt-BR").format(emitidos);
      $("#kpi-conversao").textContent=(conv*100).toFixed(1)+"%";
      $("#kpi-ticket").textContent=CFG.currency.format(ticket);

      const yoy=$("#chk-yoy").checked, diStr=$("#f-data-inicio").value, dfStr=$("#f-data-fim").value;
      if(yoy && diStr && dfStr){
        const di=new Date(diStr), df=new Date(dfStr); const diPrev=new Date(di); diPrev.setFullYear(diPrev.getFullYear()-1); const dfPrev=new Date(df); dfPrev.setFullYear(dfPrev.getFullYear()-1);
        const prev = state.raw.filter(d=>d.data && d.data>=diPrev && d.data<=dfPrev);
        const prevFilt = filtrarMemoria(prev);
        const totalPremioPrev=sum(prevFilt,d=>d.premio); const qtdPrev=prevFilt.length; const emitPrev=prevFilt.filter(d=>isEmitido(d.status)).length;
        const convPrev=qtdPrev?(emitPrev/qtdPrev):0; const ticketPrev=qtdPrev?(totalPremioPrev/qtdPrev):0;
        setDelta($("#kpi-premio-delta"), pctDelta(totalPremio,totalPremioPrev));
        setDelta($("#kpi-qtd-delta"), pctDelta(qtd,qtdPrev));
        setDelta($("#kpi-emitidos-delta"), pctDelta(emitidos,emitPrev));
        setDelta($("#kpi-conversao-delta"), pctDelta(conv,convPrev));
        setDelta($("#kpi-ticket-delta"), pctDelta(ticket,ticketPrev));
      } else {
        ["premio","qtd","emitidos","conversao","ticket"].forEach(k=>{ document.querySelector(`#kpi-${k}-delta`).textContent=""; });
      }
    }
    function desenharTabela(){
      const tb=$("#tbody"); tb.innerHTML="";
      const data=state.filtered.slice().sort((a,b)=>(b.data?.getTime()||0)-(a.data?.getTime()||0));
      $("#lbl-count").textContent=data.length;
      const frag=document.createDocumentFragment();
      for(const d of data.slice(0,2000)){
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${d.data?CFG.dateFmt(d.data):"—"}</td>
          <td>${d.empresa||"—"}</td>
          <td class="hide-sm">${d.agenciaNome || d.agenciaId || "—"}</td>
          <td>${d.rmNome || "—"}</td>
          <td><span class="badge">${d.status||"—"}</span></td>
          <td class="hide-sm">${d.ramo||"—"}</td>
          <td class="hide-sm">${d.seguradora||"—"}</td>
          <td>${CFG.currency.format(d.premio||0)}</td>
          <td class="hide-sm">${d.tipo||"—"}</td>`;
        frag.appendChild(tr);
      }
      tb.appendChild(frag);
    }
    function baseChartCfg(){
      return {
        plugins:[ChartDataLabels],
        options:{ responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{position:'bottom'},
            datalabels:{ formatter:(v)=> typeof v==="number"?Math.round(v):"", anchor:'end', align:'top', offset:4, clamp:true },
            tooltip:{ callbacks:{ label:(ctx)=>{ const y=ctx.parsed?.y ?? ctx.parsed; return typeof y==="number"?` ${new Intl.NumberFormat('pt-BR', {style:'currency',currency:'BRL'}).format(y)}`:` ${y}`; } } }
          },
          scales:{ x:{ ticks:{maxRotation:0,autoSkip:true} }, y:{ beginAtZero:true } }
        }
      };
    }
    function desenharChartStatus(){
      const by=groupBy(state.filtered, d=>d.status||"Sem status");
      const labels=Array.from(by.keys()); const counts=labels.map(l=>by.get(l).length);
      $("#legend-status").textContent=`${labels.length} status`;
      const cfg=baseChartCfg(); cfg.data={ labels, datasets:[{ type:'doughnut', data:counts }] };
      cfg.options.plugins.datalabels.formatter=(v)=> new Intl.NumberFormat("pt-BR").format(v);
      cfg.options.plugins.tooltip.callbacks.label=(ctx)=>` ${ctx.label}: ${new Intl.NumberFormat("pt-BR").format(ctx.parsed)}`;
      window.chartStatus = new Chart(document.getElementById("chartStatus"), cfg);
    }
    function desenharChartLinhasYoY(){
      const diStr=$("#f-data-inicio").value, dfStr=$("#f-data-fim").value; if(!diStr||!dfStr) return;
      const di=new Date(diStr); const year=di.getFullYear();
      const months=rangeMonths(year);
      const dataCurr=state.filtered.filter(d=>d.data && d.data.getFullYear()===year);
      const gCurr=new Map(months.map(m=>[m,0])); dataCurr.forEach(d=>{ const k=monthKey(d.data); gCurr.set(k,(gCurr.get(k)||0)+(d.premio||0)); });

      const monthsPrev=rangeMonths(year-1);
      const dataPrevRaw=state.raw.filter(d=>d.data && d.data.getFullYear()===(year-1));
      const dataPrev=filtrarMemoria(dataPrevRaw);
      const gPrev=new Map(monthsPrev.map(m=>[m,0])); dataPrev.forEach(d=>{ const k=monthKey(d.data); gPrev.set(k,(gPrev.get(k)||0)+(d.premio||0)); });

      $("#legend-linhas").textContent=`Ano ${year}${$("#chk-yoy").checked?` vs ${year-1}`:""}`;

      const cfg=baseChartCfg();
      cfg.data={ labels:months.map(m=> m.split("-")[1]+"/"+m.split("-")[0].slice(-2)),
        datasets:[{ label:String(year), type:'line', data:months.map(m=>gCurr.get(m)||0), tension:.3 }] };
      if($("#chk-yoy").checked){ cfg.data.datasets.push({ label:String(year-1), type:'line', data:monthsPrev.map(m=>gPrev.get(m)||0), tension:.3 }); }
      cfg.options.plugins.datalabels.display=false;
      window.chartLinhas=new Chart(document.getElementById("chartLinhas"), cfg);
    }
    function topEntries(obj,limit=10){ const arr=Object.entries(obj); return arr.sort((a,b)=>b[1]-a[1]).slice(0,limit); }
    function desenharChartRamo(){
      const grp={}; state.filtered.forEach(d=>{ const k=d.ramo||"—"; grp[k]=(grp[k]||0)+(d.premio||0); });
      const top=topEntries(grp,10); $("#legend-ramo").textContent=`${top.length} ramos (Top 10)`;
      const cfg=baseChartCfg(); cfg.data={ labels:top.map(t=>t[0]), datasets:[{ type:'bar', data:top.map(t=>t[1]) }] };
      window.chartRamo=new Chart(document.getElementById("chartRamo"), cfg);
    }
    function desenharChartRM(){
      const grp={}; state.filtered.forEach(d=>{ const k=d.rmNome||"—"; grp[k]=(grp[k]||0)+(d.premio||0); });
      const top=topEntries(grp,10); $("#legend-rm").textContent=`${top.length} RMs (Top 10)`;
      const cfg=baseChartCfg(); cfg.data={ labels:top.map(t=>t[0]), datasets:[{ type:'bar', data:top.map(t=>t[1]) }] };
      cfg.options.indexAxis='y'; window.chartRM=new Chart(document.getElementById("chartRM"), cfg);
    }
    function desenharChartSeguradora(){
      const grp={}; state.filtered.forEach(d=>{ const k=d.seguradora||"—"; grp[k]=(grp[k]||0)+(d.premio||0); });
      const arr=Object.entries(grp); $("#legend-seguradora").textContent=`${arr.length} seguradoras`;
      const cfg=baseChartCfg(); cfg.data={ labels:arr.map(t=>t[0]), datasets:[{ type:'bar', data:arr.map(t=>t[1]) }] };
      window.chartSeguradora=new Chart(document.getElementById("chartSeguradora"), cfg);
    }

    // Exportar CSV
    function exportarCSV(){
      const rows=[["Data","Empresa","Agência","RM","Status","Ramo","Seguradora","Prêmio","Tipo"]];
      for(const d of state.filtered){
        rows.push([
          d.data?CFG.dateFmt(d.data):"",
          d.empresa||"",
          d.agenciaNome || d.agenciaId || "",
          d.rmNome||"",
          d.status||"",
          d.ramo||"",
          d.seguradora||"",
          String(d.premio||0).replace(".",","),
          d.tipo||""
        ]);
      }
      downloadCSV(`relatorio_${Date.now()}.csv`, rows);
    }

    // Salvar / Carregar vistas
    function getFilters(){ return {
      di: $("#f-data-inicio").value, df: $("#f-data-fim").value, agencia: $("#f-agencia").value, rm: $("#f-rm").value,
      status: multiSelectValues($("#f-status")), ramo: multiSelectValues($("#f-ramo")), seguradora: multiSelectValues($("#f-seguradora")),
      tipo: $("#f-tipo").value, empresa: $("#f-empresa").value, yoy: $("#chk-yoy").checked
    }; }
    function setFilters(f){ if(!f) return;
      $("#f-data-inicio").value=f.di||""; $("#f-data-fim").value=f.df||""; $("#f-agencia").value=f.agencia||""; filtrarRMsPorAgencia(); $("#f-rm").value=f.rm||"";
      function setMulti(sel,vals){ const set=new Set(vals||[]); Array.from(sel.options).forEach(o=>o.selected=set.has(o.value)); }
      setMulti($("#f-status"), f.status); setMulti($("#f-ramo"), f.ramo); setMulti($("#f-seguradora"), f.seguradora);
      $("#f-tipo").value=f.tipo||""; $("#f-empresa").value=f.empresa||""; $("#chk-yoy").checked=!!f.yoy;
    }
    function saveView(){ const name=prompt("Nome para salvar esta combinação de filtros:"); if(!name) return;
      const key=`relatorios:view:${name}`; localStorage.setItem(key, J
