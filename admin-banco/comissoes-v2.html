<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Comiss√µes - Retorno Seguros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="js/firebase-config.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--primary:#1e40af;--primary-hover:#1e3a8a;--secondary:#3b82f6;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-600:#4b5563;--gray-700:#374151;--gray-900:#111827;--shadow:0 1px 3px rgba(0,0,0,.1);--shadow-md:0 4px 6px -1px rgba(0,0,0,.1);--shadow-lg:0 10px 15px -3px rgba(0,0,0,.1)}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:var(--gray-900)}
    .container{max-width:1400px;margin:0 auto}
    .header{background:#fff;border-radius:16px;padding:20px 28px;margin-bottom:20px;box-shadow:var(--shadow-md);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px}
    .header-left{display:flex;align-items:center;gap:16px}
    .btn-back{background:var(--gray-100);border:none;border-radius:10px;padding:10px 16px;cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:600;color:var(--gray-700);transition:all .2s;font-size:14px}
    .btn-back:hover{background:var(--gray-200);transform:translateX(-2px)}
    .header-title h1{font-size:24px;font-weight:700;color:var(--gray-900)}
    .header-title p{font-size:13px;color:var(--gray-600)}
    .card{background:#fff;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:var(--shadow-md)}
    .card-header{margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid var(--gray-100)}
    .card-header h2{font-size:16px;font-weight:600;color:var(--gray-900)}
    .card-header p{font-size:13px;color:var(--gray-600)}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:20px}
    .stat-card{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);border-radius:14px;padding:20px;color:#fff;box-shadow:var(--shadow-lg);transition:transform .2s}
    .stat-card:hover{transform:translateY(-3px)}
    .stat-card.green{background:linear-gradient(135deg,#10b981 0%,#059669 100%)}
    .stat-card.orange{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%)}
    .stat-label{font-size:13px;opacity:.9;margin-bottom:6px}
    .stat-value{font-size:28px;font-weight:700}
    .stat-sub{font-size:12px;opacity:.8}
    .filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:16px}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-size:12px;font-weight:600;color:var(--gray-700)}
    .form-control{padding:10px 14px;border:2px solid var(--gray-200);border-radius:8px;font-size:14px;transition:all .2s;background:#fff}
    .form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,64,175,.1)}
    .filter-actions{display:flex;gap:10px;align-items:end}
    .btn{padding:10px 20px;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-hover);transform:translateY(-1px)}
    .btn-secondary{background:var(--gray-100);color:var(--gray-700)}
    .btn-secondary:hover{background:var(--gray-200)}
    .btn-success{background:var(--success);color:#fff}
    .btn-success:hover{background:#059669}
    .table-container{overflow-x:auto;border-radius:10px;border:1px solid var(--gray-200)}
    table{width:100%;border-collapse:collapse;background:#fff}
    thead th{background:var(--gray-50);padding:14px;text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--gray-600);letter-spacing:.05em;border-bottom:2px solid var(--gray-200)}
    tbody td{padding:14px;border-bottom:1px solid var(--gray-100);font-size:13px;color:var(--gray-700)}
    tbody tr:hover{background:var(--gray-50)}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600}
    .badge-success{background:#d1fae5;color:#065f46}
    .badge-warning{background:#fef3c7;color:#92400e}
    .badge-info{background:#dbeafe;color:#1e40af}
    .link{color:var(--primary);text-decoration:none;font-weight:600}
    .link:hover{text-decoration:underline}
    .pagination{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:20px;padding-top:16px;border-top:2px solid var(--gray-100)}
    .pagination-btn{padding:8px 14px;border:2px solid var(--gray-200);background:#fff;border-radius:6px;font-weight:600;cursor:pointer;transition:all .2s;font-size:13px}
    .pagination-btn:hover:not(:disabled){background:var(--primary);color:#fff;border-color:var(--primary)}
    .pagination-btn:disabled{opacity:.4;cursor:not-allowed}
    .pagination-info{padding:8px 14px;font-size:13px;color:var(--gray-600);font-weight:600}
    .drawer-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);opacity:0;visibility:hidden;transition:all .3s;z-index:999}
    .drawer-overlay.active{opacity:1;visibility:visible}
    .drawer{position:fixed;top:0;right:-600px;width:600px;height:100%;background:#fff;box-shadow:-4px 0 24px rgba(0,0,0,.15);transition:right .3s cubic-bezier(.4,0,.2,1);z-index:1000;overflow-y:auto}
    .drawer.open{right:0}
    .drawer-header{padding:20px 24px;border-bottom:2px solid var(--gray-100);background:var(--gray-50)}
    .drawer-header h3{font-size:18px;font-weight:700;color:var(--gray-900)}
    .drawer-header p{font-size:13px;color:var(--gray-600);margin-top:4px}
    .drawer-body{padding:24px}
    .drawer-section{margin-bottom:24px}
    .drawer-section h4{font-size:14px;font-weight:600;color:var(--gray-900);margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--gray-100)}
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    .summary-box{background:var(--gray-50);border:2px dashed var(--gray-300);border-radius:10px;padding:16px;margin:20px 0}
    .summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .summary-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#fff;border-radius:6px}
    .summary-item strong{font-size:12px;color:var(--gray-700)}
    .summary-item span{font-size:14px;font-weight:700;color:var(--primary)}
    .table-mini{width:100%;border-collapse:collapse;font-size:12px;margin-top:12px}
    .table-mini th{background:var(--gray-100);padding:8px 10px;text-align:left;font-weight:600;border-bottom:2px solid var(--gray-200)}
    .table-mini td{padding:8px 10px;border-bottom:1px solid var(--gray-100)}
    .table-mini tr:hover{background:var(--gray-50)}
    .toast{position:fixed;bottom:20px;right:20px;background:#fff;padding:14px 20px;border-radius:10px;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px;transform:translateY(100px);opacity:0;transition:all .3s;z-index:2000;font-weight:600;font-size:14px}
    .toast.show{transform:translateY(0);opacity:1}
    .toast-success{border-left:4px solid var(--success)}
    .toast-error{border-left:4px solid var(--danger)}
    .empty-state{text-align:center;padding:40px;color:var(--gray-600)}
    .empty-state svg{margin-bottom:16px;opacity:.3}
    .skeleton{background:linear-gradient(90deg,var(--gray-200) 25%,var(--gray-100) 50%,var(--gray-200) 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:6px;height:50px;margin-bottom:8px}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    @media(max-width:768px){body{padding:12px}.header{padding:16px;flex-direction:column;align-items:stretch}.filters-grid{grid-template-columns:1fr}.drawer{width:100%;right:-100%}.form-grid{grid-template-columns:1fr}.stats-grid{grid-template-columns:1fr}.stat-value{font-size:22px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="btn-back" onclick="window.location.href='painel.html'">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none"><path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Voltar ao Painel
        </button>
        <div class="header-title">
          <h1>üíº Comiss√µes</h1>
          <p>Gest√£o de repasses para gerentes e equipes</p>
        </div>
      </div>
      <button class="btn btn-secondary" onclick="location.reload()">üîÑ Atualizar</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total em Neg√≥cios</div>
        <div class="stat-value" id="totalNegocios">0</div>
        <div class="stat-sub">Neg√≥cios emitidos</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">Pr√™mio Total</div>
        <div class="stat-value" id="totalPremio">R$ 0,00</div>
        <div class="stat-sub">Soma dos pr√™mios</div>
      </div>
      <div class="stat-card orange">
        <div class="stat-label">Comiss√£o Total</div>
        <div class="stat-value" id="totalComissao">R$ 0,00</div>
        <div class="stat-sub">Base configurada</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>üîç Filtros de Pesquisa</h2>
      </div>
      <div class="filters-grid">
        <div class="form-group">
          <label>In√≠cio Vig√™ncia (de)</label>
          <input type="date" class="form-control" id="fDataIni">
        </div>
        <div class="form-group">
          <label>In√≠cio Vig√™ncia (at√©)</label>
          <input type="date" class="form-control" id="fDataFim">
        </div>
        <div class="form-group">
          <label>RM</label>
          <select class="form-control" id="fRm"><option value="">Todos</option></select>
        </div>
        <div class="form-group">
          <label>Ag√™ncia</label>
          <select class="form-control" id="fAgencia"><option value="">Todas</option></select>
        </div>
        <div class="form-group">
          <label>Ramo</label>
          <select class="form-control" id="fRamo"><option value="">Todos</option></select>
        </div>
        <div class="form-group">
          <label>Empresa</label>
          <input type="text" class="form-control" id="fEmpresa" placeholder="Digite o nome...">
        </div>
        <div class="filter-actions">
          <button class="btn btn-primary" id="btnAplicar">üîç Aplicar</button>
          <button class="btn btn-secondary" id="btnLimpar">Limpar</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>üìã Lista de Neg√≥cios</h2>
        <p id="infoQtd">Carregando...</p>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr><th>Empresa</th><th>Ramo</th><th>RM</th><th>Ag√™ncia</th><th>Pr√™mio</th><th>Comiss√£o</th><th>Vig√™ncia</th><th>A√ß√µes</th></tr>
          </thead>
          <tbody id="listaComissoes">
            <tr><td colspan="8"><div class="skeleton"></div></td></tr>
            <tr><td colspan="8"><div class="skeleton"></div></td></tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="pagination" style="display:none">
        <button class="pagination-btn" id="btnPrevPage">‚óÄ Anterior</button>
        <div class="pagination-info" id="pageInfo">P√°gina 1 de 1</div>
        <button class="pagination-btn" id="btnNextPage">Pr√≥ximo ‚ñ∂</button>
      </div>
    </div>
  </div>

  <div class="drawer-overlay" id="drawerOverlay" onclick="fecharDrawer()"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-header">
      <h3 id="dw-empresa">Configurar Comiss√£o</h3>
      <p id="dw-meta">Detalhes do neg√≥cio</p>
    </div>
    <div class="drawer-body">
      <input type="hidden" id="dw-cotacaoId">
      <div class="drawer-section">
        <h4>üí∞ Percentuais</h4>
        <div class="form-grid">
          <div class="form-group"><label>% Comiss√£o</label><input id="dw-comissaoPct" type="number" class="form-control" min="0" step="0.01" oninput="atualizarCalculos()"></div>
          <div class="form-group"><label>% Imposto</label><input id="dw-impostoPct" type="number" class="form-control" min="0" step="0.01" oninput="atualizarCalculos()"></div>
          <div class="form-group"><label>% RM</label><input id="dw-rmPct" type="number" class="form-control" min="0" step="0.01" oninput="atualizarCalculos()"></div>
          <div class="form-group"><label>% GF</label><input id="dw-gfPct" type="number" class="form-control" min="0" step="0.01" oninput="atualizarCalculos()"></div>
          <div class="form-group"><label>Frequ√™ncia</label><select id="dw-frequencia" class="form-control" onchange="atualizarCalculos()"><option value="A">Anual (1x)</option><option value="M">Mensal (12x)</option></select></div>
          <div class="form-group"><label>Observa√ß√µes</label><input id="dw-obs" type="text" class="form-control" placeholder="Opcional"></div>
        </div>
      </div>
      <div class="summary-box" id="boxTotais">
        <div class="summary-grid">
          <div class="summary-item"><strong>Comiss√£o Geral:</strong><span id="sum-geral">R$ 0,00</span></div>
          <div class="summary-item"><strong>Imposto:</strong><span id="sum-imp">R$ 0,00</span></div>
          <div class="summary-item"><strong>L√≠quida:</strong><span id="sum-liq">R$ 0,00</span></div>
          <div class="summary-item"><strong>RM:</strong><span id="sum-rm">R$ 0,00</span></div>
          <div class="summary-item"><strong>GF:</strong><span id="sum-gf">R$ 0,00</span></div>
          <div class="summary-item"><strong>Corretora:</strong><span id="sum-cor">R$ 0,00</span></div>
        </div>
      </div>
      <div class="drawer-section">
        <h4>üìÖ Cronograma de Pagamentos</h4>
        <div class="table-container">
          <table class="table-mini">
            <thead><tr><th>#</th><th>Compet√™ncia</th><th>Base</th><th>Imp.</th><th>RM</th><th>GF</th><th>Corretora</th><th>Pago</th></tr></thead>
            <tbody id="dw-parcelas"><tr><td colspan="8" style="text-align:center;padding:20px;color:var(--gray-600)">Defina os percentuais</td></tr></tbody>
          </table>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:24px">
        <button class="btn btn-success" onclick="salvarComissao()" style="flex:1">‚úÖ Salvar</button>
        <button class="btn btn-secondary" onclick="fecharDrawer()">Cancelar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
// ================= Firebase =================
if (!firebase.apps.length && typeof firebaseConfig !== "undefined") firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore();
const COL_COTACOES = db.collection("cotacoes-gerentes");
const COL_USUARIOS = db.collection("usuarios_banco");
const COL_AGENCIAS = db.collection("agencias_banco");
const COL_COMISSOES = db.collection("comissoes_negocios");

let usuarioAtual = null, isAdmin = false;
let negociosBase = [], comissoesCache = new Map(), mapaRM = new Map(), mapaAgencias = new Map();
let setRamos = new Set(), setAgNomes = new Set();
let currentPage = 1, totalPages = 1, dadosFiltrados = [];
const ITEMS_PER_PAGE = 20;

const $ = id => document.getElementById(id);
const fmtBRL = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
const money = n => fmtBRL.format(Number(n||0));
const norm = s => (s||"").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase();

function parsePremio(val){
  if(val==null)return 0;if(typeof val==="number")return val;
  const n=String(val).replace(/[^\d,.-]/g,"").replace(/\.(?=\d{3}(?:\D|$))/g,"").replace(",",".");
  const f=parseFloat(n);return isNaN(f)?0:f;
}
function toISODate(v){try{if(!v)return"";if(typeof v==="string"){const d=new Date(v);return isNaN(+d)?"":d.toISOString().slice(0,10)}if(v instanceof Date)return v.toISOString().slice(0,10);if(v.toDate)return v.toDate().toISOString().slice(0,10)}catch(_){}return""}
function br(iso){return iso?iso.split("-").reverse().join("/"):"-"}
function addMonths(date,months){const d=new Date(date.getTime());d.setMonth(d.getMonth()+months);if(date.getDate()!==d.getDate())d.setDate(0);return d}
function showToast(msg,type='success'){const t=$('toast');t.textContent=msg;t.className=`toast toast-${type} show`;setTimeout(()=>t.classList.remove('show'),3000)}

window.addEventListener("DOMContentLoaded",()=>{
  auth.onAuthStateChanged(async user=>{
    if(!user)return location.href="login.html";
    usuarioAtual=user;
    isAdmin=user.email==="patrick@retornoseguros.com.br";
    if(!isAdmin){alert("P√°gina exclusiva para Administrador.");return location.href="painel.html"}
    await Promise.all([carregarNegociosEmitidos(),carregarComissoesExistentes()]);
    montarFiltros();aplicarFiltros();
    $("btnAplicar")?.addEventListener("click",aplicarFiltros);
    $("btnLimpar")?.addEventListener("click",()=>{["fDataIni","fDataFim","fRm","fAgencia","fRamo","fEmpresa"].forEach(id=>{const el=$(id);if(el)el.value=""});currentPage=1;aplicarFiltros()});
    $("btnPrevPage")?.addEventListener("click",()=>{if(currentPage>1){currentPage--;renderLista(dadosFiltrados)}});
    $("btnNextPage")?.addEventListener("click",()=>{if(currentPage<totalPages){currentPage++;renderLista(dadosFiltrados)}});
  });
});

async function carregarNegociosEmitidos(){
  negociosBase=[];mapaRM.clear();mapaAgencias.clear();setRamos.clear();setAgNomes.clear();
  const docs=(await COL_COTACOES.where("status","==","Neg√≥cio Emitido").get()).docs;
  const rmUids=new Set();
  docs.forEach(d=>{const c=d.data()||{};
    const item={id:d.id,empresaId:c.empresaId||"",empresaNome:c.empresaNome||"-",ramo:c.ramo||"-",rmNome:c.rmNome||"-",rmUid:c.rmUid||c.rmId||null,agenciaId:c.agenciaId||"",premio:parsePremio(c.premioLiquido??c.valorNegocio??c.valorDesejado??c.valorProposta??c.valor),inicioISO:toISODate(c.inicioVigencia),fimISO:toISODate(c.fimVigencia)};
    negociosBase.push(item);setRamos.add(item.ramo);if(item.rmUid)rmUids.add(item.rmUid);
  });
  await Promise.all(Array.from(rmUids).map(async uid=>{try{const snap=await COL_USUARIOS.doc(uid).get();const u=snap.exists?(snap.data()||{}):{};mapaRM.set(uid,{nome:u.nome||"",agenciaId:u.agenciaId||""})}catch{mapaRM.set(uid,{nome:"",agenciaId:""})}}));
  const agIds=Array.from(new Set([...negociosBase.map(x=>x.agenciaId).filter(Boolean),...Array.from(mapaRM.values()).map(v=>v.agenciaId).filter(Boolean)]));
  await Promise.all(agIds.map(async id=>{if(!id||mapaAgencias.has(id))return;try{const snap=await COL_AGENCIAS.doc(id).get();const a=snap.exists?(snap.data()||{}):{};const nome=a.nome||"(Sem nome)",banco=a.banco?` ‚Äì ${a.banco}`:"",cidade=a.Cidade||a.cidade||"",uf=a.estado||a.UF||"";mapaAgencias.set(id,`${nome}${banco}${cidade?` / ${cidade}`:""}${uf?` - ${uf.toUpperCase()}`:""}`)}catch{mapaAgencias.set(id,id)}}));
  negociosBase.forEach(d=>{const agId=d.agenciaId||(mapaRM.get(d.rmUid)?.agenciaId||"");const nome=agId?(mapaAgencias.get(agId)||agId):"";if(nome)setAgNomes.add(nome)});
}

async function carregarComissoesExistentes(){comissoesCache.clear();const snap=await COL_COMISSOES.get();snap.forEach(doc=>comissoesCache.set(doc.id,{id:doc.id,...(doc.data()||{})}))}

function montarFiltros(){
  const selRm=$("fRm");selRm.innerHTML=`<option value="">Todos</option>`;const vistos=new Set();
  negociosBase.forEach(n=>{const chave=n.rmUid||n.rmNome;if(vistos.has(chave))return;vistos.add(chave);selRm.insertAdjacentHTML("beforeend",`<option value="${chave}">${n.rmNome||n.rmUid||"RM"}</option>`)});
  const selAg=$("fAgencia");selAg.innerHTML=`<option value="">Todas</option>`;Array.from(setAgNomes).sort((a,b)=>a.localeCompare(b,"pt-BR")).forEach(n=>selAg.insertAdjacentHTML("beforeend",`<option value="${n}">${n}</option>`));
  const selRamo=$("fRamo");selRamo.innerHTML=`<option value="">Todos</option>`;Array.from(setRamos).sort((a,b)=>a.localeCompare(b,"pt-BR")).forEach(r=>selRamo.insertAdjacentHTML("beforeend",`<option value="${r}">${r}</option>`));
}

function aplicarFiltros(){
  const ini=$("fDataIni")?.value||"",fim=$("fDataFim")?.value||"",rm=$("fRm")?.value||"",ag=$("fAgencia")?.value||"",ra=$("fRamo")?.value||"",em=norm($("fEmpresa")?.value||"");
  dadosFiltrados=negociosBase.filter(n=>{
    if(ini&&(!n.inicioISO||n.inicioISO<ini))return false;if(fim&&(!n.inicioISO||n.inicioISO>fim))return false;
    if(rm){if(n.rmUid){if(n.rmUid!==rm)return false}else if(norm(n.rmNome)!==norm(rm))return false}
    if(ag){const agId=n.agenciaId||(mapaRM.get(n.rmUid)?.agenciaId||"");const nome=agId?(mapaAgencias.get(agId)||agId):"";if(nome!==ag)return false}
    if(ra&&n.ramo!==ra)return false;if(em&&!norm(n.empresaNome).includes(em))return false;return true;
  });
  currentPage=1;renderLista(dadosFiltrados);atualizarStats();
}

function renderLista(lista){
  const tbody=$("listaComissoes");tbody.innerHTML="";
  if(!lista.length){tbody.innerHTML=`<tr><td colspan="8" class="empty-state"><svg width="48" height="48" viewBox="0 0 24 24" fill="none"><path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.134 17 3 13.866 3 10C3 6.134 6.134 3 10 3C13.866 3 17 6.134 17 10Z" stroke="currentColor" stroke-width="2"/></svg><div style="font-size:15px;font-weight:600">Nenhum resultado</div><div style="font-size:13px;margin-top:6px">Ajuste os filtros</div></td></tr>`;$("infoQtd").textContent="0 neg√≥cios";$("pagination").style.display="none";return}
  totalPages=Math.ceil(lista.length/ITEMS_PER_PAGE);const start=(currentPage-1)*ITEMS_PER_PAGE,end=start+ITEMS_PER_PAGE,paginatedList=lista.slice(start,end);
  paginatedList.forEach(n=>{const agId=n.agenciaId||(mapaRM.get(n.rmUid)?.agenciaId||""),agLabel=agId?(mapaAgencias.get(agId)||agId):"-";const cfg=comissoesCache.get(n.id),base=cfg?Number(cfg.baseComissao||0):0;
    let statusHTML=cfg?`<span class="badge badge-info">${cfg.frequencia==="M"?"Mensal":"Anual"} ‚Ä¢ ${cfg.parcelas?.filter(p=>p.pago).length||0}/${cfg.parcelas?.length||0}</span>`:`<span class="badge badge-warning">N√£o config.</span>`;
    const tr=document.createElement("tr");tr.innerHTML=`<td><strong>${n.empresaNome}</strong></td><td>${n.ramo}</td><td>${n.rmNome||"-"}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${agLabel}</td><td><strong>${money(n.premio)}</strong></td><td>${base?`<strong>${money(base)}</strong>`:`-`}<br>${statusHTML}</td><td>${br(n.inicioISO)} ‚Äì ${br(n.fimISO)}</td><td><a href="#" class="link" onclick="abrirDrawer('${n.id}');return false">Configurar</a></td>`;tbody.appendChild(tr);
  });
  $("infoQtd").textContent=`Exibindo ${start+1}-${Math.min(end,lista.length)} de ${lista.length}`;
  if(totalPages>1){$("pagination").style.display="flex";$("pageInfo").textContent=`P√°gina ${currentPage} de ${totalPages}`;$("btnPrevPage").disabled=currentPage===1;$("btnNextPage").disabled=currentPage===totalPages}else{$("pagination").style.display="none"}
}

function atualizarStats(){const somaPremio=dadosFiltrados.reduce((s,n)=>s+n.premio,0),somaComissao=dadosFiltrados.reduce((s,n)=>{const cfg=comissoesCache.get(n.id);return s+(cfg?Number(cfg.baseComissao||0):0)},0);$("totalNegocios").textContent=dadosFiltrados.length;$("totalPremio").textContent=money(somaPremio);$("totalComissao").textContent=money(somaComissao)}

function abrirDrawer(cotacaoId){
  const n=negociosBase.find(x=>x.id===cotacaoId);if(!n)return;
  $("dw-cotacaoId").value=cotacaoId;$("dw-empresa").textContent=n.empresaNome;
  const agId=n.agenciaId||(mapaRM.get(n.rmUid)?.agenciaId||""),agLabel=agId?(mapaAgencias.get(agId)||agId):"-";
  $("dw-meta").textContent=`${n.ramo} ‚Ä¢ RM ${n.rmNome||"-"} ‚Ä¢ ${agLabel} ‚Ä¢ Pr√™mio ${money(n.premio)}`;
  const cfg=comissoesCache.get(cotacaoId);
  $("dw-comissaoPct").value=cfg?.comissaoPct??"";$("dw-impostoPct").value=cfg?.impostoPct??0;$("dw-rmPct").value=cfg?.rmPct??0;$("dw-gfPct").value=cfg?.gfPct??0;$("dw-frequencia").value=cfg?.frequencia??"A";$("dw-obs").value=cfg?.obs??"";
  atualizarCalculos();$("drawer").classList.add("open");$("drawerOverlay").classList.add("active");
}
function fecharDrawer(){$("drawer").classList.remove("open");$("drawerOverlay").classList.remove("active")}

function atualizarCalculos(){
  const cotacaoId=$("dw-cotacaoId").value,n=negociosBase.find(x=>x.id===cotacaoId);if(!n)return;
  const pct=Number($("dw-comissaoPct").value||0),imp=Number($("dw-impostoPct").value||0),rm=Number($("dw-rmPct").value||0),gf=Number($("dw-gfPct").value||0),freq=$("dw-frequencia").value||"A";
  const baseComissao=n.premio*(pct/100),vImp=baseComissao*(imp/100),comissaoLiquida=baseComissao-vImp,vRM=comissaoLiquida*(rm/100),vGF=comissaoLiquida*(gf/100),vCor=comissaoLiquida-vRM-vGF;
  $("sum-geral").textContent=money(baseComissao);$("sum-imp").textContent=money(vImp);$("sum-liq").textContent=money(comissaoLiquida);$("sum-rm").textContent=money(vRM);$("sum-gf").textContent=money(vGF);$("sum-cor").textContent=money(vCor);
  const nParc=freq==="M"?12:1,linhas=[];
  for(let i=0;i<nParc;i++){const d0=n.inicioISO?new Date(n.inicioISO+"T00:00:00"):new Date(),dt=freq==="M"?addMonths(d0,i):d0;linhas.push({i:i+1,competencia:new Date(dt.getFullYear(),dt.getMonth(),1),base:baseComissao/nParc,imposto:vImp/nParc,liquida:comissaoLiquida/nParc,rm:vRM/nParc,gf:vGF/nParc,cor:vCor/nParc})}
  function ajustar(lista,chave,total){const soma=lista.reduce((a,b)=>a+b[chave],0),delta=Number((total-soma).toFixed(2));if(Math.abs(delta)>=0.01)lista[lista.length-1][chave]+=delta}
  ajustar(linhas,"base",baseComissao);ajustar(linhas,"imposto",vImp);ajustar(linhas,"liquida",comissaoLiquida);ajustar(linhas,"rm",vRM);ajustar(linhas,"gf",vGF);ajustar(linhas,"cor",vCor);
  const tb=$("dw-parcelas");tb.innerHTML="";const cfgExist=comissoesCache.get(cotacaoId);
  linhas.forEach((p,idx)=>{const pago=cfgExist?.parcelas?.[idx]?.pago||false;const tr=document.createElement("tr");tr.innerHTML=`<td><strong>${p.i}</strong></td><td>${("0"+(p.competencia.getMonth()+1)).slice(-2)}/${p.competencia.getFullYear()}</td><td>${money(p.base)}</td><td>${money(p.imposto)}</td><td>${money(p.rm)}</td><td>${money(p.gf)}</td><td>${money(p.cor)}</td><td style="text-align:center"><input type="checkbox" ${pago?"checked":""} onchange="togglePago(${idx},this.checked)" style="width:16px;height:16px;cursor:pointer"></td>`;tb.appendChild(tr)});
  window._draftCalculo={baseComissao,comissaoLiquida,vImp,vRM,vGF,vCor,freq,linhas};
}
function togglePago(index,checked){if(!window._parcelasPagasTemp)window._parcelasPagasTemp={};window._parcelasPagasTemp[index]=!!checked}

async function salvarComissao(){
  if(!isAdmin){showToast("Apenas admin pode salvar","error");return}
  const cotacaoId=$("dw-cotacaoId").value,n=negociosBase.find(x=>x.id===cotacaoId);if(!n)return;
  const pct=Number($("dw-comissaoPct").value||0),imp=Number($("dw-impostoPct").value||0),rm=Number($("dw-rmPct").value||0),gf=Number($("dw-gfPct").value||0),freq=$("dw-frequencia").value||"A",obs=$("dw-obs").value||"";
  const calc=window._draftCalculo;if(!calc){showToast("Defina os percentuais","error");return}
  const parcelas=calc.linhas.map((p,idx)=>({numero:idx+1,competenciaISO:p.competencia.toISOString().slice(0,10),base:Number(p.base.toFixed(2)),imposto:Number(p.imposto.toFixed(2)),liquida:Number(p.liquida.toFixed(2)),rm:Number(p.rm.toFixed(2)),gf:Number(p.gf.toFixed(2)),corretora:Number(p.cor.toFixed(2)),pago:(window._parcelasPagasTemp&&window._parcelasPagasTemp[idx])||false,pagoEm:null}));
  const payload={cotacaoId,empresaId:n.empresaId,empresaNome:n.empresaNome,rmUid:n.rmUid||"",rmNome:n.rmNome||"",agenciaId:n.agenciaId||(mapaRM.get(n.rmUid)?.agenciaId||""),premio:Number(n.premio||0),comissaoPct:pct,impostoPct:imp,rmPct:rm,gfPct:gf,frequencia:freq,baseComissao:Number(calc.baseComissao.toFixed(2)),comissaoLiquida:Number(calc.comissaoLiquida.toFixed(2)),valores:{imposto:Number(calc.vImp.toFixed(2)),rm:Number(calc.vRM.toFixed(2)),gf:Number(calc.vGF.toFixed(2)),corretora:Number(calc.vCor.toFixed(2))},inicioVigenciaISO:n.inicioISO||"",fimVigenciaISO:n.fimISO||"",parcelas,obs,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
  if(!comissoesCache.has(cotacaoId))payload.createdAt=firebase.firestore.FieldValue.serverTimestamp();
  try{await COL_COMISSOES.doc(cotacaoId).set(payload,{merge:true});comissoesCache.set(cotacaoId,payload);showToast("‚úÖ Comiss√£o salva!");fecharDrawer();aplicarFiltros()}catch(e){console.error(e);showToast("‚ùå Erro ao salvar","error")}
}

window.abrirDrawer=abrirDrawer;window.fecharDrawer=fecharDrawer;window.atualizarCalculos=atualizarCalculos;window.salvarComissao=salvarComissao;window.togglePago=togglePago;
</script>
</body>
</html>
