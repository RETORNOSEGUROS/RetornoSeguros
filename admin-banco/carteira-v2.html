<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Carteira de Comiss√µes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="js/firebase-config.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--primary:#1e40af;--primary-hover:#1e3a8a;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-600:#4b5563;--gray-700:#374151;--gray-900:#111827;--shadow:0 1px 3px rgba(0,0,0,.1);--shadow-md:0 4px 6px -1px rgba(0,0,0,.1);--shadow-lg:0 10px 15px -3px rgba(0,0,0,.1)}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(135deg,#10b981 0%,#059669 100%);min-height:100vh;padding:20px;color:var(--gray-900)}
    .container{max-width:1400px;margin:0 auto}
    .header{background:#fff;border-radius:16px;padding:20px 28px;margin-bottom:20px;box-shadow:var(--shadow-md);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px}
    .header-left{display:flex;align-items:center;gap:16px}
    .btn-back{background:var(--gray-100);border:none;border-radius:10px;padding:10px 16px;cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:600;color:var(--gray-700);transition:all .2s;font-size:14px}
    .btn-back:hover{background:var(--gray-200);transform:translateX(-2px)}
    .header-title h1{font-size:24px;font-weight:700;color:var(--gray-900)}
    .header-title p{font-size:13px;color:var(--gray-600)}
    .header-right{display:flex;gap:10px;align-items:center}
    .perfil-badge{background:var(--gray-100);padding:8px 14px;border-radius:8px;font-size:13px;font-weight:600;color:var(--gray-700)}
    .card{background:#fff;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:var(--shadow-md)}
    .card-header{margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid var(--gray-100);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    .card-header h2{font-size:16px;font-weight:600;color:var(--gray-900)}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px}
    .stat-card{border-radius:14px;padding:20px;color:#fff;box-shadow:var(--shadow-lg);transition:transform .2s}
    .stat-card:hover{transform:translateY(-3px)}
    .stat-card.blue{background:linear-gradient(135deg,#1e40af 0%,#3b82f6 100%)}
    .stat-card.green{background:linear-gradient(135deg,#10b981 0%,#059669 100%)}
    .stat-card.orange{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%)}
    .stat-card.purple{background:linear-gradient(135deg,#7c3aed 0%,#5b21b6 100%)}
    .stat-label{font-size:13px;opacity:.9;margin-bottom:6px}
    .stat-value{font-size:26px;font-weight:700}
    .stat-sub{font-size:12px;opacity:.8;margin-top:4px}
    .admin-box{background:var(--gray-50);border:2px solid var(--gray-200);border-radius:12px;padding:16px;margin-bottom:20px}
    .admin-box h3{font-size:14px;font-weight:600;color:var(--gray-700);margin-bottom:12px}
    .admin-row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
    .filters-row{display:flex;gap:12px;flex-wrap:wrap;align-items:end;width:100%}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-size:12px;font-weight:600;color:var(--gray-700)}
    .form-control{padding:10px 14px;border:2px solid var(--gray-200);border-radius:8px;font-size:14px;transition:all .2s;background:#fff;min-width:160px}
    .form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,64,175,.1)}
    textarea.form-control{min-height:80px;resize:vertical}
    .btn{padding:10px 20px;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-hover);transform:translateY(-1px)}
    .btn-secondary{background:var(--gray-100);color:var(--gray-700)}
    .btn-secondary:hover{background:var(--gray-200)}
    .btn-success{background:var(--success);color:#fff}
    .btn-success:hover{background:#059669}
    .table-container{overflow-x:auto;border-radius:10px;border:1px solid var(--gray-200)}
    table{width:100%;border-collapse:collapse;background:#fff}
    thead th{background:var(--gray-50);padding:14px;text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--gray-600);letter-spacing:.05em;border-bottom:2px solid var(--gray-200)}
    tbody td{padding:14px;border-bottom:1px solid var(--gray-100);font-size:13px;color:var(--gray-700)}
    tbody tr:hover{background:var(--gray-50)}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600}
    .badge-success{background:#d1fae5;color:#065f46}
    .badge-warning{background:#fef3c7;color:#92400e}
    .badge-info{background:#dbeafe;color:#1e40af}
    .tag{background:var(--gray-100);color:var(--gray-700);padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600}
    .pagination{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:20px;padding-top:16px;border-top:2px solid var(--gray-100)}
    .pagination-btn{padding:8px 14px;border:2px solid var(--gray-200);background:#fff;border-radius:6px;font-weight:600;cursor:pointer;transition:all .2s;font-size:13px}
    .pagination-btn:hover:not(:disabled){background:var(--primary);color:#fff;border-color:var(--primary)}
    .pagination-btn:disabled{opacity:.4;cursor:not-allowed}
    .pagination-info{padding:8px 14px;font-size:13px;color:var(--gray-600);font-weight:600}
    .drawer-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);opacity:0;visibility:hidden;transition:all .3s;z-index:999}
    .drawer-overlay.active{opacity:1;visibility:visible}
    .drawer{position:fixed;top:0;right:-500px;width:500px;height:100%;background:#fff;box-shadow:-4px 0 24px rgba(0,0,0,.15);transition:right .3s cubic-bezier(.4,0,.2,1);z-index:1000;overflow-y:auto}
    .drawer.open{right:0}
    .drawer-header{padding:20px 24px;border-bottom:2px solid var(--gray-100);background:var(--gray-50)}
    .drawer-header h3{font-size:18px;font-weight:700;color:var(--gray-900)}
    .drawer-header p{font-size:13px;color:var(--gray-600);margin-top:4px}
    .drawer-body{padding:24px}
    .drawer-section{margin-bottom:20px}
    .toast{position:fixed;bottom:20px;right:20px;background:#fff;padding:14px 20px;border-radius:10px;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px;transform:translateY(100px);opacity:0;transition:all .3s;z-index:2000;font-weight:600;font-size:14px}
    .toast.show{transform:translateY(0);opacity:1}
    .toast-success{border-left:4px solid var(--success)}
    .toast-error{border-left:4px solid var(--danger)}
    .empty-state{text-align:center;padding:40px;color:var(--gray-600)}
    .valor-cell{font-weight:700;color:var(--success);font-size:15px}
    .hint{font-size:12px;color:var(--gray-600);margin-top:6px}
    @media(max-width:768px){
  body{padding:10px}
  .container{max-width:100%}
  .header{padding:14px;flex-direction:column;align-items:stretch;gap:12px}
  .header-left{flex-direction:column;align-items:stretch;gap:10px}
  .btn-back{justify-content:center}
  .header-title{text-align:center}
  .header-title h1{font-size:20px}
  .header-right{justify-content:center;flex-wrap:wrap}
  .perfil-badge{font-size:12px;padding:6px 10px}
  .admin-box{padding:12px}
  .admin-row{flex-direction:column}
  .admin-row .form-group{min-width:100%!important}
  .stats-grid{grid-template-columns:1fr 1fr;gap:10px}
  .stat-card{padding:14px;border-radius:12px}
  .stat-label{font-size:11px}
  .stat-value{font-size:18px}
  .stat-sub{font-size:10px}
  .card{padding:14px;border-radius:12px;margin-bottom:14px}
  .card-header{flex-direction:column;align-items:flex-start;gap:8px}
  .card-header h2{font-size:15px}
  /* FILTROS - ALINHADOS √Ä ESQUERDA */
  .filters-row{flex-direction:column;gap:12px;align-items:stretch}
  .form-group{width:100%;text-align:left}
  .form-group label{font-size:12px;text-align:left;display:block}
  .form-control{padding:12px 14px;font-size:14px;width:100%;text-align:left}
  .filters-row .btn{width:100%;justify-content:center}
  /* FIM FILTROS */
  .table-container{border-radius:8px;margin:0 -4px}
  table{font-size:12px}
  thead th{padding:10px 8px;font-size:10px}
  tbody td{padding:10px 8px;font-size:12px}
  .valor-cell{font-size:13px}
  .tag{font-size:11px;padding:4px 8px}
  .badge{font-size:10px;padding:3px 8px}
  .pagination{gap:6px;padding-top:12px;margin-top:12px}
  .pagination-btn{padding:8px 12px;font-size:12px}
  .pagination-info{font-size:12px;padding:8px 10px}
  .drawer{width:100%;right:-100%}
  .drawer-header{padding:16px}
  .drawer-header h3{font-size:16px}
  .drawer-body{padding:16px}
  .drawer-section{margin-bottom:16px}
  textarea.form-control{min-height:70px}
  .hint{font-size:11px}
  .empty-state{padding:30px 16px;font-size:13px}
  .toast{padding:12px 16px;font-size:13px;left:10px;right:10px;transform:translateX(0) translateY(100px);width:auto}
  .toast.show{transform:translateX(0) translateY(0)}
}
@media(max-width:400px){
  .stats-grid{grid-template-columns:1fr}
  .stat-card{padding:12px}
  .stat-value{font-size:20px}
  .header-title h1{font-size:18px}
}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="btn-back" onclick="window.location.href='painel.html'">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none"><path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Voltar ao Painel
        </button>
        <div class="header-title">
          <h1>üí≥ Carteira de Comiss√µes</h1>
          <p>Acompanhe suas comiss√µes e solicite resgates</p>
        </div>
      </div>
      <div class="header-right">
        <span class="perfil-badge" id="labelPerfil">Carregando...</span>
        <button class="btn btn-secondary" onclick="location.reload()">üîÑ</button>
      </div>
    </div>

    <!-- Admin Switch -->
    <div class="admin-box" id="boxAdminSwitch" style="display:none">
      <h3>üëÅÔ∏è Visualizar como (Admin)</h3>
      <div class="admin-row">
        <div class="form-group" style="flex:1;min-width:250px">
          <label>Selecione um usu√°rio</label>
          <select class="form-control" id="adminUserView"><option value="">Carregando...</option></select>
        </div>
        <button class="btn btn-primary" id="btnAdminAplicar">Visualizar</button>
      </div>
    </div>

    <!-- M√©tricas -->
    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="stat-label">üí∞ Total Ganho</div>
        <div class="stat-value" id="mTotalGanho">R$ 0,00</div>
        <div class="stat-sub">Comiss√µes dispon√≠veis</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">‚úì Total Resgatado</div>
        <div class="stat-value" id="mResgatado">R$ 0,00</div>
        <div class="stat-sub">J√° pago</div>
      </div>
      <div class="stat-card orange">
        <div class="stat-label">‚è≥ Em Solicita√ß√£o</div>
        <div class="stat-value" id="mPendente">R$ 0,00</div>
        <div class="stat-sub">Aguardando aprova√ß√£o</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-label">üíé Saldo Dispon√≠vel</div>
        <div class="stat-value" id="mSaldo">R$ 0,00</div>
        <div class="stat-sub">Dispon√≠vel para resgate</div>
      </div>
    </div>

    <!-- A√ß√£o principal -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
        <div>
          <h2 style="font-size:16px;font-weight:600;margin-bottom:4px">Solicitar Resgate</h2>
          <p id="hintSaldo" style="font-size:13px;color:var(--gray-600)">Saldo dispon√≠vel: R$ 0,00</p>
        </div>
        <button class="btn btn-success" id="btnNovoResgate">üí∏ Novo Resgate</button>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card">
      <div class="card-header"><h2>üîç Filtros</h2></div>
      <div class="filters-row">
        <div class="form-group"><label>Compet√™ncia (de)</label><input type="date" class="form-control" id="fIni"></div>
        <div class="form-group"><label>Compet√™ncia (at√©)</label><input type="date" class="form-control" id="fFim"></div>
        <div class="form-group"><label>Empresa</label><input type="text" class="form-control" id="fEmpresa" placeholder="Digite..."></div>
        <div class="form-group"><label>Status Sa√≠das</label><select class="form-control" id="fStatusSaida"><option value="">Todos</option><option value="pendente">Pendentes</option><option value="pago">Pagos</option></select></div>
        <button class="btn btn-primary" id="btnAplicar">üîç Aplicar</button>
        <button class="btn btn-secondary" id="btnLimpar">Limpar</button>
      </div>
    </div>

    <!-- Entradas -->
    <div class="card">
      <div class="card-header">
        <h2>üì• Entradas (Comiss√µes Dispon√≠veis)</h2>
        <span class="tag" id="qtdEntradas">0 itens</span>
      </div>
      <div class="table-container">
        <table>
          <thead><tr><th>Empresa</th><th>Compet√™ncia</th><th>Valor</th></tr></thead>
          <tbody id="tbEntradas"><tr><td colspan="3" class="empty-state">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="pagination" id="paginationEntradas" style="display:none">
        <button class="pagination-btn" id="btnPrevEntradas">‚óÄ</button>
        <div class="pagination-info" id="pageInfoEntradas">1/1</div>
        <button class="pagination-btn" id="btnNextEntradas">‚ñ∂</button>
      </div>
    </div>

    <!-- Sa√≠das -->
    <div class="card">
      <div class="card-header">
        <h2>üì§ Sa√≠das (Solicita√ß√µes)</h2>
        <span class="tag" id="qtdSaidas">0 itens</span>
      </div>
      <div class="table-container">
        <table>
          <thead><tr><th>Data</th><th>M√©todo</th><th>Valor</th><th>Status</th></tr></thead>
          <tbody id="tbSaidas"><tr><td colspan="4" class="empty-state">Carregando...</td></tr></tbody>
        </table>
      </div>
      <div class="pagination" id="paginationSaidas" style="display:none">
        <button class="pagination-btn" id="btnPrevSaidas">‚óÄ</button>
        <div class="pagination-info" id="pageInfoSaidas">1/1</div>
        <button class="pagination-btn" id="btnNextSaidas">‚ñ∂</button>
      </div>
    </div>
  </div>

  <!-- Drawer Resgate -->
  <div class="drawer-overlay" id="drawerOverlay" onclick="fecharDrawer()"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-header">
      <h3>üí∏ Solicitar Resgate</h3>
      <p>Preencha os dados para solicitar seu resgate</p>
    </div>
    <div class="drawer-body">
      <div class="drawer-section">
        <div class="form-group" style="margin-bottom:16px">
          <label>Forma de Pagamento</label>
          <select class="form-control" id="rMetodo">
            <option value="PIX">PIX</option>
            <option value="BOLETO">Boleto</option>
            <option value="DOC/TED">DOC/TED</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:16px">
          <label>Valor</label>
          <input type="number" class="form-control" id="rValor" min="0" step="0.01" placeholder="0,00">
          <div class="hint" id="hintDrawer">Saldo dispon√≠vel: R$ 0,00</div>
        </div>
        <div class="form-group">
          <label>Detalhes do Pagamento</label>
          <textarea class="form-control" id="rDetalhes" placeholder="Ex.: Chave PIX, banco, ag√™ncia/conta, titular..."></textarea>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:24px">
        <button class="btn btn-success" id="btnSalvarResgate" style="flex:1">‚úÖ Enviar Solicita√ß√£o</button>
        <button class="btn btn-secondary" onclick="fecharDrawer()">Cancelar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
if(!firebase.apps.length&&typeof firebaseConfig!=="undefined")firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore();
const COL_USERS=db.collection("usuarios_banco"),COL_COMISSOES=db.collection("comissoes_negocios"),COL_RESGATES=db.collection("resgates_carteira");

const $=id=>document.getElementById(id);
const fmtBRL=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
const money=n=>fmtBRL.format(Number(n||0));
const norm=s=>(s||"").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase();
const todayISO=()=>new Date().toISOString().slice(0,10);

let me=null,viewUid=null;
let entradas=[],saidas=[];
let totais={ganho:0,resgatado:0,pendente:0,saldo:0};

// Pagina√ß√£o
let pageEntradas=1,pageSaidas=1;
const PER_PAGE=15;
let entradasFiltradas=[],saidasFiltradas=[];

function showToast(msg,type='success'){const t=$('toast');t.textContent=msg;t.className=`toast toast-${type} show`;setTimeout(()=>t.classList.remove('show'),3000)}

window.addEventListener("DOMContentLoaded",()=>{
  auth.onAuthStateChanged(async user=>{
    if(!user)return location.href="login.html";
    const profSnap=await COL_USERS.doc(user.uid).get();
    const p=profSnap.exists?(profSnap.data()||{}):{};
    me={uid:user.uid,email:user.email,nome:p.nome||user.email,perfil:(p.perfil||"").toLowerCase(),agenciaId:p.agenciaId||"",isAdmin:user.email==="patrick@retornoseguros.com.br"||(p.perfil||"").toLowerCase()==="admin"};
    $("labelPerfil").textContent=`${me.perfil||"usu√°rio"}${me.isAdmin?" (admin)":""}`;
    if(me.isAdmin){$("boxAdminSwitch").style.display="block";await carregarListaUsuariosParaAdmin();$("btnAdminAplicar").onclick=()=>{viewUid=$("adminUserView").value||me.uid;atualizarTudo()}}
    viewUid=me.uid;
    $("btnAplicar").onclick=aplicarFiltros;
    $("btnLimpar").onclick=()=>{["fIni","fFim","fEmpresa","fStatusSaida"].forEach(id=>{const el=$(id);if(el)el.value=""});aplicarFiltros()};
    $("btnNovoResgate").onclick=abrirDrawer;
    $("btnSalvarResgate").onclick=salvarResgate;
    $("btnPrevEntradas").onclick=()=>{if(pageEntradas>1){pageEntradas--;renderEntradas()}};
    $("btnNextEntradas").onclick=()=>{const total=Math.ceil(entradasFiltradas.length/PER_PAGE);if(pageEntradas<total){pageEntradas++;renderEntradas()}};
    $("btnPrevSaidas").onclick=()=>{if(pageSaidas>1){pageSaidas--;renderSaidas()}};
    $("btnNextSaidas").onclick=()=>{const total=Math.ceil(saidasFiltradas.length/PER_PAGE);if(pageSaidas<total){pageSaidas++;renderSaidas()}};
    await atualizarTudo();
  });
});

async function carregarListaUsuariosParaAdmin(){
  const sel=$("adminUserView");sel.innerHTML=`<option value="${me.uid}">Eu (${me.email})</option>`;
  const snap=await COL_USERS.get();
  snap.forEach(doc=>{const u=doc.data()||{};sel.insertAdjacentHTML("beforeend",`<option value="${doc.id}">${u.nome||doc.id} ‚Äì ${(u.perfil||"-").toLowerCase()}</option>`)});
}

async function atualizarTudo(){await carregarEntradas();await carregarSaidas();calcularTotais();renderMetrica();aplicarFiltros()}

async function carregarEntradas(){
  entradas=[];const hoje=todayISO();
  let perfilView=me.perfil,agenciaView=me.agenciaId,nomeView=me.nome;
  
  // Se admin visualizando outro usu√°rio, busca dados dele
  if(me.isAdmin&&viewUid!==me.uid){
    const vs=await COL_USERS.doc(viewUid).get();
    if(vs.exists){const d=vs.data()||{};perfilView=(d.perfil||"").toLowerCase();agenciaView=d.agenciaId||"";nomeView=d.nome||""}
  }
  
  const perfilNorm=perfilView.toLowerCase().replace(/[_\s]/g,"");
  
  // RM - recebe comiss√£o de RM
  if(perfilNorm==="rm"){
    let snap=await COL_COMISSOES.where("rmUid","==",viewUid).get();
    // fallback por nome se n√£o encontrar por UID
    if(snap.empty&&nomeView){snap=await COL_COMISSOES.where("rmNome","==",nomeView).get()}
    snap.forEach(doc=>{const c=doc.data()||{},nome=c.empresaNome||"-",pars=Array.isArray(c.parcelas)?c.parcelas:[];
      pars.forEach(p=>{const comp=p.competenciaISO||"";if(!comp||comp>hoje)return;const valor=Number(p.rm||0);if(valor>0)entradas.push({empresa:nome,competenciaISO:comp,valor})})});
  }
  // Gerente Chefe - recebe comiss√£o GF dos neg√≥cios da sua ag√™ncia/time
  else if(perfilNorm==="gerentechefe"){
    if(!agenciaView){entradas=[];return}
    const snap=await COL_COMISSOES.where("agenciaId","==",agenciaView).get();
    snap.forEach(doc=>{const c=doc.data()||{},nome=c.empresaNome||"-",pars=Array.isArray(c.parcelas)?c.parcelas:[];
      pars.forEach(p=>{const comp=p.competenciaISO||"";if(!comp||comp>hoje)return;const valor=Number(p.gf||0);if(valor>0)entradas.push({empresa:nome,competenciaISO:comp,valor})})});
  }
  // Outros perfis (usuario, colaborador, etc) - busca por UID ou nome em qualquer campo
  else{
    // Tenta buscar como RM primeiro (caso tenha sido cadastrado assim)
    let snap=await COL_COMISSOES.where("rmUid","==",viewUid).get();
    if(snap.empty&&nomeView){snap=await COL_COMISSOES.where("rmNome","==",nomeView).get()}
    
    snap.forEach(doc=>{const c=doc.data()||{},nome=c.empresaNome||"-",pars=Array.isArray(c.parcelas)?c.parcelas:[];
      pars.forEach(p=>{const comp=p.competenciaISO||"";if(!comp||comp>hoje)return;const valor=Number(p.rm||0);if(valor>0)entradas.push({empresa:nome,competenciaISO:comp,valor})})});
  }
  
  entradas.sort((a,b)=>a.competenciaISO<b.competenciaISO?1:-1);
}

async function carregarSaidas(){
  saidas=[];const snap=await COL_RESGATES.where("userId","==",viewUid).get();
  snap.forEach(doc=>{const r=doc.data()||{};saidas.push({dataISO:r.criadoISO||(r.createdAt?.toDate?.()?.toISOString()?.slice(0,10)||""),metodo:r.metodo||"-",valor:Number(r.valor||0),status:(r.status||"pendente").toLowerCase()})});
  saidas.sort((a,b)=>a.dataISO<b.dataISO?1:-1);
}

function calcularTotais(){
  const ganho=entradas.reduce((s,e)=>s+Number(e.valor||0),0);
  const resgatado=saidas.filter(s=>s.status==="pago").reduce((s,e)=>s+Number(e.valor||0),0);
  const pendente=saidas.filter(s=>s.status==="pendente").reduce((s,e)=>s+Number(e.valor||0),0);
  const saldo=ganho-resgatado;
  totais={ganho,resgatado,pendente,saldo};
}

function renderMetrica(){
  $("mTotalGanho").textContent=money(totais.ganho);
  $("mResgatado").textContent=money(totais.resgatado);
  $("mPendente").textContent=money(totais.pendente);
  $("mSaldo").textContent=money(totais.saldo);
  $("hintSaldo").textContent=`Saldo dispon√≠vel: ${money(totais.saldo)} ‚Ä¢ Em solicita√ß√£o: ${money(totais.pendente)}`;
  $("hintDrawer").textContent=`Saldo dispon√≠vel: ${money(totais.saldo)}`;
}

function aplicarFiltros(){
  const ini=$("fIni")?.value||"",fim=$("fFim")?.value||"",emp=norm($("fEmpresa")?.value||""),st=$("fStatusSaida")?.value||"";
  entradasFiltradas=entradas.filter(e=>{if(ini&&e.competenciaISO<ini)return false;if(fim&&e.competenciaISO>fim)return false;if(emp&&!norm(e.empresa).includes(emp))return false;return true});
  saidasFiltradas=saidas.filter(s=>{if(st&&s.status!==st)return false;return true});
  pageEntradas=1;pageSaidas=1;
  renderEntradas();renderSaidas();calcularTotais();renderMetrica();
}

function renderEntradas(){
  const tb=$("tbEntradas");tb.innerHTML="";
  if(!entradasFiltradas.length){tb.innerHTML=`<tr><td colspan="3" class="empty-state">Sem entradas neste per√≠odo</td></tr>`;$("qtdEntradas").textContent="0 itens";$("paginationEntradas").style.display="none";return}
  const totalPages=Math.ceil(entradasFiltradas.length/PER_PAGE),start=(pageEntradas-1)*PER_PAGE,end=start+PER_PAGE;
  const paginated=entradasFiltradas.slice(start,end);
  const soma=entradasFiltradas.reduce((s,e)=>s+Number(e.valor||0),0);
  paginated.forEach(e=>{const tr=document.createElement("tr");tr.innerHTML=`<td><strong>${e.empresa}</strong></td><td>${e.competenciaISO.split("-").reverse().join("/")}</td><td class="valor-cell">${money(e.valor)}</td>`;tb.appendChild(tr)});
  $("qtdEntradas").textContent=`${entradasFiltradas.length} item(s) ‚Äì ${money(soma)}`;
  if(totalPages>1){$("paginationEntradas").style.display="flex";$("pageInfoEntradas").textContent=`${pageEntradas}/${totalPages}`;$("btnPrevEntradas").disabled=pageEntradas===1;$("btnNextEntradas").disabled=pageEntradas===totalPages}else{$("paginationEntradas").style.display="none"}
}

function renderSaidas(){
  const tb=$("tbSaidas");tb.innerHTML="";
  if(!saidasFiltradas.length){tb.innerHTML=`<tr><td colspan="4" class="empty-state">Sem solicita√ß√µes</td></tr>`;$("qtdSaidas").textContent="0 itens";$("paginationSaidas").style.display="none";return}
  const totalPages=Math.ceil(saidasFiltradas.length/PER_PAGE),start=(pageSaidas-1)*PER_PAGE,end=start+PER_PAGE;
  const paginated=saidasFiltradas.slice(start,end);
  const soma=saidasFiltradas.reduce((s,e)=>s+Number(e.valor||0),0);
  paginated.forEach(s=>{const tr=document.createElement("tr");const stLabel=s.status==="pago"?`<span class="badge badge-success">‚úì Pago</span>`:`<span class="badge badge-warning">‚è≥ Pendente</span>`;tr.innerHTML=`<td>${s.dataISO?s.dataISO.split("-").reverse().join("/"):"-"}</td><td><strong>${s.metodo}</strong></td><td class="valor-cell">${money(s.valor)}</td><td>${stLabel}</td>`;tb.appendChild(tr)});
  $("qtdSaidas").textContent=`${saidasFiltradas.length} item(s) ‚Äì ${money(soma)}`;
  if(totalPages>1){$("paginationSaidas").style.display="flex";$("pageInfoSaidas").textContent=`${pageSaidas}/${totalPages}`;$("btnPrevSaidas").disabled=pageSaidas===1;$("btnNextSaidas").disabled=pageSaidas===totalPages}else{$("paginationSaidas").style.display="none"}
}

function abrirDrawer(){$("drawer").classList.add("open");$("drawerOverlay").classList.add("active")}
function fecharDrawer(){$("drawer").classList.remove("open");$("drawerOverlay").classList.remove("active")}

async function salvarResgate(){
  const metodo=$("rMetodo").value,valorNum=Number($("rValor").value||0),detalhes=$("rDetalhes").value.trim();
  if(!valorNum||valorNum<=0){showToast("Informe um valor v√°lido","error");return}
  if(valorNum>totais.saldo){showToast(`Valor acima do saldo (${money(totais.saldo)})`,"error");return}
  const payload={userId:viewUid,userNome:me.nome,userEmail:me.email,perfil:me.perfil,agenciaId:me.agenciaId||null,metodo,valor:Number(valorNum.toFixed(2)),detalhes,status:"pendente",criadoISO:new Date().toISOString().slice(0,10),createdAt:firebase.firestore.FieldValue.serverTimestamp()};
  try{await COL_RESGATES.add(payload);showToast("‚úÖ Solicita√ß√£o enviada!");fecharDrawer();$("rValor").value="";$("rDetalhes").value="";await carregarSaidas();calcularTotais();renderMetrica();aplicarFiltros()}catch(e){console.error(e);showToast("‚ùå Erro ao enviar","error")}
}

window.abrirDrawer=abrirDrawer;window.fecharDrawer=fecharDrawer;window.aplicarFiltros=aplicarFiltros;
</script>
</body>
</html>
