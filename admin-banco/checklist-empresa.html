<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist de Entendimento | Planos Empresariais</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .empresa-badge {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 25px;
            border-radius: 50px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }
        
        .card-container {
            width: 100%;
            max-width: 500px;
            perspective: 1000px;
        }
        
        .question-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            overflow: hidden;
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
        }
        
        .card-header {
            padding: 25px 30px;
            text-align: center;
            color: white;
        }
        
        .card-header.saude {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .card-header.dental {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
        
        .card-header.pesquisa {
            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
        }
        
        .card-header.intro {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-header.final {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .card-header i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }
        
        .card-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }
        
        .card-header .section-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .card-body {
            padding: 30px;
        }
        
        .progress-container {
            margin-bottom: 25px;
        }
        
        .progress-bar-bg {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.4s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
        }
        
        .question-text {
            font-size: 1.15rem;
            color: #333;
            line-height: 1.6;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
        }
        
        .btn-answer {
            flex: 1;
            padding: 18px 20px;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-yes {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }
        
        .btn-yes:hover {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            transform: scale(1.03);
        }
        
        .btn-no {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
        }
        
        .btn-no:hover {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            transform: scale(1.03);
        }
        
        .btn-answer.selected {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .btn-yes.selected {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }
        
        .btn-no.selected {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        /* Escala 0-10 */
        .scale-container {
            margin-bottom: 20px;
        }
        
        .scale-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 15px;
        }
        
        .scale-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .scale-btn {
            width: 48px;
            height: 48px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .scale-btn:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        
        .scale-btn.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
            transform: scale(1.1);
        }
        
        /* Navega√ß√£o */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .btn-nav {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-prev {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-prev:hover {
            background: #e0e0e0;
        }
        
        .btn-next {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-next:hover {
            opacity: 0.9;
            transform: translateX(3px);
        }
        
        .btn-next:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
        }
        
        .btn-submit:hover {
            opacity: 0.9;
        }
        
        /* Intro e Final */
        .intro-content, .final-content {
            text-align: center;
            padding: 20px 0;
        }
        
        .intro-content h1 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 15px;
        }
        
        .intro-content p {
            color: #666;
            line-height: 1.7;
            margin-bottom: 10px;
        }
        
        .intro-content .highlight {
            background: linear-gradient(135deg, #667eea20, #764ba220);
            padding: 15px 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
            margin-top: 20px;
        }
        
        .final-content i {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 20px;
        }
        
        .final-content h1 {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 15px;
        }
        
        .final-content p {
            color: #666;
            font-size: 1.1rem;
        }
        
        /* Anima√ß√µes */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .animate-in {
            animation: slideIn 0.4s ease forwards;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: white;
        }
        
        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 500px) {
            body {
                padding: 15px;
            }
            
            .card-body {
                padding: 20px;
            }
            
            .question-text {
                font-size: 1.05rem;
            }
            
            .btn-answer {
                padding: 15px;
                font-size: 1rem;
            }
            
            .scale-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="empresa-badge" id="empresaBadge">
        <i class="bi bi-building"></i>
        <span id="nomeEmpresa">Carregando...</span>
    </div>
    
    <div class="card-container">
        <div class="question-card" id="questionCard">
            <div class="loading">
                <i class="bi bi-arrow-repeat"></i>
                <p class="mt-3">Carregando...</p>
            </div>
        </div>
    </div>

    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.appspot.com",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Par√¢metros da URL
        const params = new URLSearchParams(window.location.search);
        const checklistId = params.get('ch');
        const empresaId = params.get('e');
        const campanhaId = params.get('c');
        const participanteId = params.get('p');
        
        // Estado
        let currentQuestion = -1; // -1 = intro
        let respostas = {};
        let empresaNome = '';
        
        // Perguntas
        const perguntas = [
            // SA√öDE (0-10)
            {
                id: 'saude_hotelaria',
                section: 'saude',
                sectionLabel: 'Plano de Sa√∫de',
                texto: 'Ficou claro que o Plano de Sa√∫de dos s√≥cios disponibiliza interna√ß√£o de hotelaria em hospitais de ponta, como S√≠rio Liban√™s e Albert Einstein?',
                tipo: 'sim_nao'
            },
            {
                id: 'saude_exterior',
                section: 'saude',
                sectionLabel: 'Plano de Sa√∫de',
                texto: 'Ficou claro que o Plano de Sa√∫de dos s√≥cios tem cobertura no exterior mediante reembolso e seguro viagem incluso?',
                tipo: 'sim_nao'
            },
            {
                id: 'saude_reembolso_fora_rede',
                section: 'saude',
                sectionLabel: 'Plano de Sa√∫de',
                texto: 'Ficou claro que o Plano de Sa√∫de dos s√≥cios possui reembolso fora da rede credenciada?',
                tipo: 'sim_nao'
            },
            {
                id: 'saude_reembolso_10x',
                section: 'saude',
                sectionLabel: 'Plano de Sa√∫de',
                texto: 'Ficou claro que o Plano de Sa√∫de dos s√≥cios possui reembolso de at√© 10x a tabela da ANS?',
                tipo: 'sim_nao'
            },
            {
                id: 'saude_cobertura_nacional',
                section: 'saude',
                sectionLabel: 'Plano de Sa√∫de',
                texto: 'Ficou claro que o Plano de Sa√∫de tem cobertura Nacional?',
                tipo: 'sim_nao'
            },
            {
                id: 'saude_dependentes',
                section: 'saude',
                sectionLabel: 'Plano de Sa√∫de',
                texto: 'Ficou claro que o Plano de Sa√∫de permite a inclus√£o de dependentes?',
                tipo: 'sim_nao'
            },
            {
                id: 'saude_minimo_vidas',
                section: 'saude',
                sectionLabel: 'Plano de Sa√∫de',
                texto: 'Ficou claro que o m√≠nimo para contrata√ß√£o do Plano de Sa√∫de s√£o 3 pessoas sendo uma delas necessariamente um titular (s√≥cio)?',
                tipo: 'sim_nao'
            },
            {
                id: 'saude_colaborador_paga',
                section: 'saude',
                sectionLabel: 'Plano de Sa√∫de',
                texto: 'Ficou claro que a empresa pode descontar 100% do valor do plano de sa√∫de do colaborador?',
                tipo: 'sim_nao'
            },
            {
                id: 'saude_deducao_dre',
                section: 'saude',
                sectionLabel: 'Plano de Sa√∫de',
                texto: 'Ficou claro que o valor investido com o plano de sa√∫de √© dedut√≠vel da DRE e traz benef√≠cios fiscais para a empresa?',
                tipo: 'sim_nao'
            },
            {
                id: 'saude_pesquisa_colaboradores',
                section: 'saude',
                sectionLabel: 'Plano de Sa√∫de',
                texto: 'Voc√™ j√° fez uma pesquisa com os colaboradores para saber quem teria interesse em um Plano de Sa√∫de Empresarial?',
                tipo: 'sim_nao'
            },
            {
                id: 'saude_probabilidade',
                section: 'saude',
                sectionLabel: 'Plano de Sa√∫de',
                texto: 'Em uma escala de 0 a 10, qual a probabilidade de voc√™ contratar o Plano de Sa√∫de para sua empresa?',
                tipo: 'escala'
            },
            
            // DENTAL (11-20)
            {
                id: 'dental_cobertura_nacional',
                section: 'dental',
                sectionLabel: 'Plano Dental',
                texto: 'Ficou claro que o Plano Dental tem cobertura Nacional?',
                tipo: 'sim_nao'
            },
            {
                id: 'dental_custo_20',
                section: 'dental',
                sectionLabel: 'Plano Dental',
                texto: 'Ficou claro que o Plano Dental custa menos de R$ 20,00 por m√™s por pessoa?',
                tipo: 'sim_nao'
            },
            {
                id: 'dental_reter_talentos',
                section: 'dental',
                sectionLabel: 'Plano Dental',
                texto: 'Ficou claro que o Plano Dental pode ajudar a sua empresa a reter e atrair talentos?',
                tipo: 'sim_nao'
            },
            {
                id: 'dental_colaborador_100',
                section: 'dental',
                sectionLabel: 'Plano Dental',
                texto: 'Ficou claro que a empresa pode descontar 100% do valor do plano dental do colaborador?',
                tipo: 'sim_nao'
            },
            {
                id: 'dental_deducao_dre',
                section: 'dental',
                sectionLabel: 'Plano Dental',
                texto: 'Ficou claro que o valor investido com o plano dental √© dedut√≠vel da DRE e traz benef√≠cios fiscais para a empresa?',
                tipo: 'sim_nao'
            },
            {
                id: 'dental_nao_obrigatorio',
                section: 'dental',
                sectionLabel: 'Plano Dental',
                texto: 'Ficou claro que n√£o √© necess√°rio que todos os colaboradores participem do plano?',
                tipo: 'sim_nao'
            },
            {
                id: 'dental_custo_anual',
                section: 'dental',
                sectionLabel: 'Plano Dental',
                texto: 'Ficou claro que o custo anual do Plano Dental √© menor que o valor de uma limpeza no consult√≥rio particular?',
                tipo: 'sim_nao'
            },
            {
                id: 'dental_coberturas',
                section: 'dental',
                sectionLabel: 'Plano Dental',
                texto: 'Voc√™ entendeu as coberturas dispon√≠veis no Plano Dental?',
                tipo: 'sim_nao'
            },
            {
                id: 'dental_pesquisa_colaboradores',
                section: 'dental',
                sectionLabel: 'Plano Dental',
                texto: 'Voc√™ j√° fez uma pesquisa com os colaboradores para saber quem teria interesse no Plano Dental?',
                tipo: 'sim_nao'
            },
            {
                id: 'dental_probabilidade',
                section: 'dental',
                sectionLabel: 'Plano Dental',
                texto: 'Em uma escala de 0 a 10, qual a probabilidade de voc√™ disponibilizar o Plano Dental para seus colaboradores?',
                tipo: 'escala'
            },
            
            // PESQUISA (21-22)
            {
                id: 'pesquisa_recebeu_link',
                section: 'pesquisa',
                sectionLabel: 'Pesquisa com Colaboradores',
                texto: 'Voc√™ recebeu o link da pesquisa para enviar aos colaboradores verificando o interesse deles nos planos?',
                tipo: 'sim_nao',
                pontuaSeTrue: true
            },
            {
                id: 'pesquisa_compartilhou',
                section: 'pesquisa',
                sectionLabel: 'Pesquisa com Colaboradores',
                texto: 'Voc√™ j√° compartilhou o link da pesquisa com os colaboradores?',
                tipo: 'sim_nao'
            }
        ];
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            if (!checklistId || !empresaId) {
                showError('Link inv√°lido. Par√¢metros ausentes.');
                return;
            }
            
            try {
                // Buscar dados da empresa
                const empresaDoc = await db.collection('empresas').doc(empresaId).get();
                if (empresaDoc.exists) {
                    const emp = empresaDoc.data();
                    empresaNome = emp.razaoSocial || emp.nomeFantasia || emp.nome || 'Empresa';
                    document.getElementById('nomeEmpresa').textContent = empresaNome;
                }
                
                // Verificar se j√° foi respondido
                const checklistDoc = await db.collection('checklists_entendimento').doc(checklistId).get();
                if (checklistDoc.exists && checklistDoc.data().respondido) {
                    showAlreadyAnswered();
                    return;
                }
                
                // Mostrar intro
                showIntro();
                
            } catch (error) {
                console.error('Erro:', error);
                showError('Erro ao carregar dados.');
            }
        });
        
        // Mostrar intro
        function showIntro() {
            currentQuestion = -1;
            const card = document.getElementById('questionCard');
            
            card.innerHTML = `
                <div class="card-header intro">
                    <i class="bi bi-clipboard-check"></i>
                    <h2>Pesquisa de Entendimento</h2>
                    <div class="section-label">Planos de Sa√∫de e Dental</div>
                </div>
                <div class="card-body animate-in">
                    <div class="intro-content">
                        <h1>Ol√°! üëã</h1>
                        <p>Esta pesquisa r√°pida tem como objetivo confirmar que as informa√ß√µes sobre os planos de sa√∫de e dental foram apresentadas de forma clara.</p>
                        
                        <div class="highlight">
                            <strong>N√£o h√° respostas certas ou erradas</strong> - queremos apenas saber se as informa√ß√µes ficaram claras para voc√™.
                        </div>
                        
                        <p><strong>S√£o apenas ${perguntas.length} perguntas r√°pidas!</strong></p>
                        <p class="text-muted">‚è±Ô∏è Tempo estimado: 2-3 minutos</p>
                        
                        <button class="btn-nav btn-start" onclick="startQuestions()">
                            Come√ßar <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Iniciar perguntas
        function startQuestions() {
            currentQuestion = 0;
            showQuestion();
        }
        
        // Mostrar pergunta atual
        function showQuestion() {
            const pergunta = perguntas[currentQuestion];
            const card = document.getElementById('questionCard');
            const progress = Math.round(((currentQuestion + 1) / perguntas.length) * 100);
            
            let buttonsHtml = '';
            
            if (pergunta.tipo === 'sim_nao') {
                const resposta = respostas[pergunta.id];
                buttonsHtml = `
                    <div class="btn-group">
                        <button class="btn-answer btn-yes ${resposta === true ? 'selected' : ''}" onclick="responder('${pergunta.id}', true)">
                            <i class="bi bi-check-lg"></i> Sim
                        </button>
                        <button class="btn-answer btn-no ${resposta === false ? 'selected' : ''}" onclick="responder('${pergunta.id}', false)">
                            <i class="bi bi-x-lg"></i> N√£o
                        </button>
                    </div>
                `;
            } else if (pergunta.tipo === 'escala') {
                const resposta = respostas[pergunta.id];
                buttonsHtml = `
                    <div class="scale-container">
                        <div class="scale-label">
                            <span>Improv√°vel</span>
                            <span>Muito prov√°vel</span>
                        </div>
                        <div class="scale-buttons">
                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                <button class="scale-btn ${resposta === n ? 'selected' : ''}" onclick="responder('${pergunta.id}', ${n})">${n}</button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="card-header ${pergunta.section}">
                    <i class="bi bi-${pergunta.section === 'saude' ? 'heart-pulse' : pergunta.section === 'dental' ? 'emoji-smile' : 'clipboard-check'}"></i>
                    <h2>${pergunta.sectionLabel}</h2>
                    <div class="section-label">Pergunta ${currentQuestion + 1} de ${perguntas.length}</div>
                </div>
                <div class="card-body animate-in">
                    <div class="progress-container">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="progress-text">
                            <span>${progress}% conclu√≠do</span>
                            <span>${currentQuestion + 1}/${perguntas.length}</span>
                        </div>
                    </div>
                    
                    <div class="question-text">${pergunta.texto}</div>
                    
                    ${buttonsHtml}
                    
                    <div class="nav-buttons">
                        <button class="btn-nav btn-prev" onclick="prevQuestion()" ${currentQuestion === 0 ? 'style="visibility:hidden"' : ''}>
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button class="btn-nav btn-next" onclick="nextQuestion()" id="btnNext" disabled>
                            ${currentQuestion === perguntas.length - 1 ? 'Finalizar' : 'Pr√≥xima'} <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Habilitar bot√£o se j√° respondeu
            if (respostas[pergunta.id] !== undefined) {
                document.getElementById('btnNext').disabled = false;
            }
        }
        
        // Responder pergunta
        function responder(id, valor) {
            respostas[id] = valor;
            
            // Atualizar visual
            if (typeof valor === 'boolean') {
                document.querySelectorAll('.btn-answer').forEach(btn => btn.classList.remove('selected'));
                document.querySelector(valor ? '.btn-yes' : '.btn-no').classList.add('selected');
            } else {
                document.querySelectorAll('.scale-btn').forEach(btn => btn.classList.remove('selected'));
                event.target.classList.add('selected');
            }
            
            // Habilitar pr√≥ximo
            document.getElementById('btnNext').disabled = false;
            
            // Auto-avan√ßar ap√≥s pequena pausa (apenas para sim/n√£o)
            if (typeof valor === 'boolean') {
                setTimeout(() => {
                    if (currentQuestion < perguntas.length - 1) {
                        nextQuestion();
                    }
                }, 400);
            }
        }
        
        // Pr√≥xima pergunta
        function nextQuestion() {
            if (currentQuestion < perguntas.length - 1) {
                currentQuestion++;
                showQuestion();
            } else {
                enviarRespostas();
            }
        }
        
        // Pergunta anterior
        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                showQuestion();
            }
        }
        
        // Enviar respostas
        async function enviarRespostas() {
            const card = document.getElementById('questionCard');
            
            card.innerHTML = `
                <div class="card-header intro">
                    <i class="bi bi-hourglass-split"></i>
                    <h2>Enviando respostas...</h2>
                </div>
                <div class="card-body">
                    <div class="loading" style="color: #333;">
                        <i class="bi bi-arrow-repeat"></i>
                        <p class="mt-3">Aguarde um momento...</p>
                    </div>
                </div>
            `;
            
            try {
                // Formatar respostas - garantir que nunca tenha undefined
                const respostasFormatadas = {};
                perguntas.forEach(p => {
                    const valorOriginal = respostas[p.id];
                    let valorFinal;
                    
                    // Garantir valor v√°lido (nunca undefined)
                    if (valorOriginal === undefined || valorOriginal === null) {
                        valorFinal = p.tipo === 'escala' ? 0 : false;
                    } else {
                        valorFinal = valorOriginal;
                    }
                    
                    respostasFormatadas[p.id] = {
                        valor: valorFinal,
                        tipo: p.tipo
                    };
                    if (p.pontuaSeTrue) {
                        respostasFormatadas[p.id].pontuaSeTrue = true;
                    }
                });
                
                console.log('Respostas formatadas:', JSON.stringify(respostasFormatadas));
                
                // Calcular estat√≠sticas
                const estatisticas = calcularEstatisticas();
                
                // Salvar no Firestore
                await db.collection('checklists_entendimento').doc(checklistId).update({
                    respondido: true,
                    respondidoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    respostas: respostasFormatadas,
                    estatisticas: estatisticas
                });
                
                // Atualizar empresa
                await db.collection('empresas').doc(empresaId).update({
                    'campanha.checklist.respondido': true,
                    'campanha.checklist.respondidoEm': firebase.firestore.FieldValue.serverTimestamp(),
                    'campanha.checklist.estatisticas': estatisticas
                });
                
                // Pontuar assistente
                await pontuarAssistente(estatisticas);
                
                // Mostrar sucesso
                showSuccess();
                
            } catch (error) {
                console.error('Erro ao enviar:', error);
                showError('Erro ao enviar respostas. Tente novamente.');
            }
        }
        
        // Calcular estat√≠sticas
        function calcularEstatisticas() {
            const stats = {
                saude: { sim: 0, nao: 0, total: 0, porcentagemSim: 0, probabilidade: null },
                dental: { sim: 0, nao: 0, total: 0, porcentagemSim: 0, probabilidade: null },
                pesquisa: { sim: 0, nao: 0, total: 0 },
                geral: { sim: 0, nao: 0, total: 0, porcentagemSim: 0 }
            };
            
            perguntas.forEach(p => {
                const resp = respostas[p.id];
                
                if (p.tipo === 'escala') {
                    // Garantir que probabilidade seja n√∫mero ou null, nunca undefined
                    stats[p.section].probabilidade = (resp !== undefined && resp !== null) ? resp : null;
                } else {
                    stats[p.section].total++;
                    stats.geral.total++;
                    
                    if (resp === true) {
                        stats[p.section].sim++;
                        stats.geral.sim++;
                    } else {
                        stats[p.section].nao++;
                        stats.geral.nao++;
                    }
                }
            });
            
            // Calcular percentuais
            ['saude', 'dental'].forEach(section => {
                if (stats[section].total > 0) {
                    stats[section].porcentagemSim = Math.round((stats[section].sim / stats[section].total) * 100);
                }
            });
            
            if (stats.geral.total > 0) {
                stats.geral.porcentagemSim = Math.round((stats.geral.sim / stats.geral.total) * 100);
            }
            
            console.log('Estat√≠sticas calculadas:', JSON.stringify(stats));
            return stats;
        }
        
        // Pontuar assistente
        async function pontuarAssistente(estatisticas) {
            if (!campanhaId || !participanteId) return;
            
            try {
                let pontosTotal = 25; // Base: checklist respondido
                
                // +25 pontos por checklist respondido
                await db.collection('campanhas').doc(campanhaId)
                    .collection('acoes').add({
                        tipo: 'checklistRespondido',
                        empresaId: empresaId,
                        empresaNome: empresaNome,
                        participanteId: participanteId,
                        pontos: 25,
                        dataRegistro: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // +12 pontos - Confirmou Entendimento DENTAL
                pontosTotal += 12;
                await db.collection('campanhas').doc(campanhaId)
                    .collection('acoes').add({
                        tipo: 'entendeuDental',
                        empresaId: empresaId,
                        empresaNome: empresaNome,
                        participanteId: participanteId,
                        pontos: 12,
                        confirmadoViaChecklist: true,
                        porcentagemEntendimento: estatisticas.dental?.porcentagemSim || 0,
                        dataRegistro: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // Atualizar empresa - marcar entendeu dental
                await db.collection('empresas').doc(empresaId).update({
                    'campanha.dental.entendeu': true,
                    'campanha.dental.entendeuEm': firebase.firestore.FieldValue.serverTimestamp(),
                    'campanha.dental.entendeuViaChecklist': true,
                    'campanha.dental.porcentagemEntendimento': estatisticas.dental?.porcentagemSim || 0
                });
                
                // +12 pontos - Confirmou Entendimento SA√öDE
                pontosTotal += 12;
                await db.collection('campanhas').doc(campanhaId)
                    .collection('acoes').add({
                        tipo: 'entendeuSaude',
                        empresaId: empresaId,
                        empresaNome: empresaNome,
                        participanteId: participanteId,
                        pontos: 12,
                        confirmadoViaChecklist: true,
                        porcentagemEntendimento: estatisticas.saude?.porcentagemSim || 0,
                        dataRegistro: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // Atualizar empresa - marcar entendeu sa√∫de
                await db.collection('empresas').doc(empresaId).update({
                    'campanha.saude.entendeu': true,
                    'campanha.saude.entendeuEm': firebase.firestore.FieldValue.serverTimestamp(),
                    'campanha.saude.entendeuViaChecklist': true,
                    'campanha.saude.porcentagemEntendimento': estatisticas.saude?.porcentagemSim || 0
                });
                
                // +20 pontos se confirmou receber pesquisa
                if (respostas['pesquisa_recebeu_link'] === true) {
                    pontosTotal += 20;
                    await db.collection('campanhas').doc(campanhaId)
                        .collection('acoes').add({
                            tipo: 'pesquisaConfirmadaEmpresa',
                            empresaId: empresaId,
                            empresaNome: empresaNome,
                            participanteId: participanteId,
                            pontos: 20,
                            dataRegistro: firebase.firestore.FieldValue.serverTimestamp()
                        });
                }
                
                // Atualizar pontos do participante (total de uma vez)
                await db.collection('campanhas').doc(campanhaId)
                    .collection('participantes').doc(participanteId)
                    .update({
                        pontos: firebase.firestore.FieldValue.increment(pontosTotal)
                    });
                
                console.log(`Pontua√ß√£o total: +${pontosTotal} pts`);
                
            } catch (error) {
                console.error('Erro ao pontuar:', error);
            }
        }
        
        // Mostrar sucesso
        function showSuccess() {
            const card = document.getElementById('questionCard');
            
            card.innerHTML = `
                <div class="card-header final">
                    <i class="bi bi-check-circle"></i>
                    <h2>Obrigado!</h2>
                </div>
                <div class="card-body animate-in">
                    <div class="final-content">
                        <i class="bi bi-check-circle-fill"></i>
                        <h1>Respostas enviadas!</h1>
                        <p>Agradecemos por responder o checklist de entendimento.</p>
                        <p class="text-muted mt-3">Suas respostas nos ajudar√£o a melhorar a comunica√ß√£o sobre os benef√≠cios dos planos.</p>
                    </div>
                </div>
            `;
        }
        
        // Mostrar erro
        function showError(msg) {
            const card = document.getElementById('questionCard');
            
            card.innerHTML = `
                <div class="card-header" style="background: #dc3545;">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h2>Erro</h2>
                </div>
                <div class="card-body">
                    <div class="final-content">
                        <i class="bi bi-x-circle-fill" style="color: #dc3545;"></i>
                        <h1>Ops!</h1>
                        <p>${msg}</p>
                    </div>
                </div>
            `;
        }
        
        // J√° respondido
        function showAlreadyAnswered() {
            const card = document.getElementById('questionCard');
            
            card.innerHTML = `
                <div class="card-header final">
                    <i class="bi bi-check-circle"></i>
                    <h2>J√° respondido</h2>
                </div>
                <div class="card-body animate-in">
                    <div class="final-content">
                        <i class="bi bi-check-circle-fill"></i>
                        <h1>Checklist j√° foi respondido!</h1>
                        <p>Este checklist j√° foi preenchido anteriormente.</p>
                        <p class="text-muted mt-3">Obrigado pela sua participa√ß√£o! üôè</p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
