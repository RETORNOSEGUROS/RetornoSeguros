<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel Gerente - Retorno Seguros</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    main.container {
      display: flex;
      min-height: 100vh;
    }

    aside.menu-lateral {
      width: 220px;
      background: #1b2c5c;
      color: white;
      padding: 20px;
    }

    aside.menu-lateral ul {
      list-style: none;
      padding: 0;
    }

    aside.menu-lateral li {
      margin-bottom: 15px;
    }

    aside.menu-lateral a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }

    aside.menu-lateral a:hover {
      text-decoration: underline;
    }

    section#conteudo {
      flex: 1;
      padding: 30px;
      background: #f8f9fa;
      overflow-y: auto;
    }

    .header-top {
      background: #1b2c5c;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-sair {
      background: white;
      color: #1b2c5c;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
    }

    .card {
      background: #1b2c5c;
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .card h3, .card h4 {
      margin-top: 0;
    }
  </style>
</head>
<body>

  <header class="header-top">
    <h2>Painel de Gerente</h2>
    <button class="btn-sair" onclick="logout()">Sair</button>
  </header>

  <main class="container">
    <aside class="menu-lateral">
      <ul>
        <li><a href="#" onclick="exibirSecao('visao')">üìä Vis√£o Geral</a></li>
        <li><a href="#" onclick="exibirSecao('cadastrar')">üè¢ Cadastrar Empresa</a></li>
        <li><a href="#" onclick="exibirSecao('visita')">üìÖ Registrar Visita Simples</a></li>
        <li><a href="#" onclick="exibirSecao('empresas')">üîç Empresas Detalhadas</a></li>
        <li><a href="#" onclick="exibirSecao('visitas-relatorio')">üìÑ Relat√≥rio de Visitas</a></li>
<li id="menuCadastroGerente" style="display:none;"><a href="#" onclick="exibirSecao('cadastrar-usuario')">üë§ Cadastrar Gerente/RM</a></li>
        <li><a href="#" onclick="logout()">üö™ Sair</a></li>
      </ul>
    </aside>

    <section id="conteudo">
      <p>Carregando painel...</p>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- Configura√ß√£o Firebase -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
      authDomain: "retorno-seguros.firebaseapp.com",
      projectId: "retorno-seguros",
      storageBucket: "retorno-seguros.appspot.com",
      messagingSenderId: "495712392972",
      appId: "1:495712392972:web:e1e78aedc48bdeea48db29"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>

  <!-- L√≥gica do Painel -->
  <script>
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "gerentes-login.html";
        return;
      }

      const uid = user.uid;

      db.collection("gerentes").doc(uid).get().then(doc => {
        if (!doc.exists || doc.data().ativo === false) {
          alert("Acesso negado.");
          auth.signOut();
          return;
        }

        window.gerenteLogado = {
        if (window.gerenteLogado.cargo === "master") {
          const menuItem = document.getElementById("menuCadastroGerente");
          if (menuItem) menuItem.style.display = "block";
        }

          id: uid,
          nome: doc.data().nome,
          cargo: doc.data().cargo || "gerente"
        };

        exibirSecao('visao');
      });
    });

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "gerentes-login.html";
      });
    }

    function exibirSecao(secao) {
      const container = document.getElementById('conteudo');
      container.innerHTML = "<p>Carregando...</p>";

      switch (secao) {
        case 'visao':
          carregarIndicadores();
          break;
        case 'cadastrar':
          exibirFormularioEmpresa();
          break;
        case 'visita':
          exibirFormularioVisita();
          break;
        case 'empresas':
          listarEmpresasDetalhadas();
          break;
        case 'cadastrar-usuario': exibirFormularioCadastroUsuario(); break;
        case 'visitas-relatorio':
          listarVisitasDetalhadas();
          break;
      }
    }

    function carregarIndicadores() {
      const uid = window.gerenteLogado.id;
      const container = document.getElementById('conteudo');
      container.innerHTML = "<h3>Vis√£o Geral</h3>";

      const colecoes = ["empresas", "visitas", "cotacoes", "seguros"];
      const textos = ["Empresas", "Visitas", "Cota√ß√µes", "Seguros"];

      colecoes.forEach((col, i) => {
        const ref = db.collection(col);
        const query = ref.where("gerenteId", "==", uid);

        query.get().then(snapshot => {
          const qtd = snapshot.size;
          const bloco = document.createElement("div");
          bloco.className = "card";
          bloco.innerHTML = `<h3>${textos[i]}</h3><p>Total: <strong>${qtd}</strong></p>`;
          container.appendChild(bloco);
        });
      });
    }

    function exibirFormularioEmpresa() {
      const container = document.getElementById('conteudo');
      container.innerHTML = `
        <h3>Cadastrar Empresa</h3>
        <form id="formEmpresa">
          <input placeholder="Nome Fantasia" id="nomeFantasia" required><br><br>
          <input placeholder="CNPJ" id="cnpj" required><br><br>
          <input placeholder="Cidade" id="cidade"><br><br>
          <input placeholder="Estado" id="estado"><br><br>
          <input placeholder="Ramo de Atividade" id="ramo"><br><br>
          <input placeholder="Qtd Funcion√°rios" id="qtd" type="number"><br><br>
          <button type="submit">Salvar</button>
        </form>
      `;

      document.getElementById("formEmpresa").onsubmit = (e) => {
        e.preventDefault();
        const dados = {
          nomeFantasia: document.getElementById("nomeFantasia").value,
          cnpj: document.getElementById("cnpj").value,
          cidade: document.getElementById("cidade").value,
          estado: document.getElementById("estado").value,
          ramoAtividade: document.getElementById("ramo").value,
          qtdFuncionarios: parseInt(document.getElementById("qtd").value || 0),
          cadastradoPor: window.gerenteLogado.id,
          dataCadastro: new Date().toISOString()
        };
        db.collection("empresas").add(dados).then(() => {
          alert("Empresa cadastrada!");
          exibirSecao("empresas");
        });
      };
    }

    function exibirFormularioVisita() {
      const container = document.getElementById('conteudo');
      container.innerHTML = `<h3>Registrar Visita</h3><p>Carregando empresas...</p>`;

      db.collection("empresas").where("cadastradoPor", "==", window.gerenteLogado.id).get().then(snapshot => {
        let html = `
          <form id="formVisita">
            <label>Empresa:</label>
            <select id="empresaId" required>
              ${snapshot.docs.map(doc => `<option value="${doc.id}">${doc.data().nomeFantasia}</option>`).join('')}
            </select><br><br>
            <input type="datetime-local" id="dataVisita" required><br><br>
            <textarea id="observacoes" placeholder="Observa√ß√µes" rows="4" style="width:100%;"></textarea><br><br>
            <button type="submit">Registrar</button>
          </form>
        `;
        container.innerHTML = html;

        document.getElementById("formVisita").onsubmit = (e) => {
          e.preventDefault();
          const dados = {
            empresaId: document.getElementById("empresaId").value,
            dataVisita: new Date(document.getElementById("dataVisita").value).toISOString(),
            observacoes: document.getElementById("observacoes").value,
            gerenteId: window.gerenteLogado.id,
            status: "realizada"
          };
          db.collection("visitas").add(dados).then(() => {
            alert("Visita registrada.");
            exibirSecao("empresas");
          });
        };
      });
    }

    function listarEmpresasDetalhadas() {
      const uid = window.gerenteLogado.id;
      const container = document.getElementById("conteudo");
      container.innerHTML = "<h3>Empresas Detalhadas</h3><p>Carregando...</p>";

      let query = db.collection("empresas").where("cadastradoPor", "==", uid);

      query.get().then(snapshot => {
        container.innerHTML = `<h3>Empresas Detalhadas</h3>`;
        if (snapshot.empty) {
          container.innerHTML += "<p>Nenhuma empresa cadastrada.</p>";
          return;
        }

        snapshot.forEach(doc => {
          const empresa = doc.data();
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <h3>${empresa.nomeFantasia}</h3>
            <p><strong>CNPJ:</strong> ${empresa.cnpj}</p>
            <p><strong>Cidade:</strong> ${empresa.cidade} - ${empresa.estado}</p>
            <p><strong>Funcion√°rios:</strong> ${empresa.qtdFuncionarios}</p>
          `;
          container.appendChild(div);
        });
      });
    }

    function listarVisitasDetalhadas() {
      const uid = window.gerenteLogado.id;
      const container = document.getElementById("conteudo");

      container.innerHTML = "<h3>Relat√≥rio de Visitas</h3><p>Carregando visitas...</p>";

      let query = db.collection("visitas").where("gerenteId", "==", uid).orderBy("dataVisita", "desc");

      query.get().then(snapshot => {
        if (snapshot.empty) {
          container.innerHTML = "<p>Nenhuma visita registrada.</p>";
          return;
        }

        container.innerHTML = "<h3>Relat√≥rio de Visitas</h3>";

        snapshot.forEach(doc => {
          const visita = doc.data();
          const card = document.createElement("div");
          card.className = "card";
          const dataFormatada = new Date(visita.dataVisita).toLocaleString("pt-BR");
          card.innerHTML = `
            <p><strong>Data:</strong> ${dataFormatada}</p>
            <p><strong>Empresa ID:</strong> ${visita.empresaId}</p>
            <p><strong>Observa√ß√µes:</strong><br>${visita.observacoes}</p>
          `;
          container.appendChild(card);
        });
      });
    }
  

    function exibirFormularioCadastroUsuario() {
      const container = document.getElementById("conteudo");
      container.innerHTML = `
        <h3>Cadastrar Gestor ou RM</h3>
        <form id="formCadastroInterno">
          <input type="text" id="nomeNovo" placeholder="Nome completo" required><br><br>
          <input type="email" id="emailNovo" placeholder="E-mail" required><br><br>
          <input type="password" id="senhaNovo" placeholder="Senha" required><br><br>
          <select id="cargoNovo" required>
            <option value="">Selecione o cargo</option>
            <option value="gestor">Gestor (chefe)</option>
            <option value="rm">RM (gerente)</option>
          </select><br><br>
          <input type="text" id="agenciaNova" placeholder="N√∫mero da ag√™ncia (ex: 3495)" required><br><br>
          <button type="submit">Cadastrar</button>
        </form>
        <p id="mensagemCadastro" style="color: green; font-weight: bold;"></p>
      `;

      document.getElementById("formCadastroInterno").onsubmit = (e) => {
        e.preventDefault();
        const nome = document.getElementById("nomeNovo").value.trim();
        const email = document.getElementById("emailNovo").value.trim();
        const senha = document.getElementById("senhaNovo").value;
        const cargo = document.getElementById("cargoNovo").value;
        const agencia = document.getElementById("agenciaNova").value.trim();
        const msg = document.getElementById("mensagemCadastro");

        msg.textContent = "Criando usu√°rio...";

        firebase.auth().createUserWithEmailAndPassword(email, senha)
          .then(userCredential => {
            const uid = userCredential.user.uid;
            return db.collection("gerentes").doc(uid).set({
              nome,
              email,
              cargo,
              agencia,
              ativo: true,
              uid
            });
          })
          .then(() => {
            msg.textContent = "‚úÖ Usu√°rio cadastrado com sucesso!";
            document.getElementById("formCadastroInterno").reset();
          })
          .catch(error => {
            console.error("Erro ao cadastrar:", error);
            msg.style.color = "red";
            msg.textContent = "‚ùå Erro: " + error.message;
          });
      };
    }
</script>
</body>
</html>
