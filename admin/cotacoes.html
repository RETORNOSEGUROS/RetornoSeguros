<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotações - Admin Retorno Seguros</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../img/logo-retorno.png" alt="Retorno Seguros" class="logo">
                <h2>Retorno<small>Painel Admin</small></h2>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">Principal</div>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                
                <div class="nav-section">Gestão</div>
                <a href="usuarios.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Usuários</span>
                </a>
                <a href="indicacoes.html" class="nav-item">
                    <i class="fas fa-user-plus"></i>
                    <span>Indicações</span>
                </a>
                <a href="apolices.html" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Apólices</span>
                </a>
                
                <div class="nav-section">Solicitações</div>
                <a href="cotacoes.html" class="nav-item active">
                    <i class="fas fa-calculator"></i>
                    <span>Cotações</span>
                </a>
                <a href="resgates.html" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Resgates</span>
                </a>
                
                <div class="nav-section">Marketing</div>
                <a href="campanhas.html" class="nav-item">
                    <i class="fas fa-bullhorn"></i>
                    <span>Campanhas</span>
                </a>
                <a href="recompensas.html" class="nav-item">
                    <i class="fas fa-gift"></i>
                    <span>Recompensas</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Cotações</h1>
                </div>
            </header>
            
            <!-- Content -->
            <div class="dashboard-content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="content">
                            <h3>Pendentes</h3>
                            <p class="value" id="cotacoesPendentes">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon info">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="content">
                            <h3>Em Análise</h3>
                            <p class="value" id="cotacoesAnalise">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon success">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="content">
                            <h3>Respondidas</h3>
                            <p class="value" id="cotacoesRespondidas">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon primary">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="content">
                            <h3>Total</h3>
                            <p class="value" id="cotacoesTotal">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div class="card">
                    <div class="card-body" style="padding: 1rem;">
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <select id="statusFilter" onchange="filtrarCotacoes()" style="padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                                <option value="">Todos os status</option>
                                <option value="pendente" selected>Pendentes</option>
                                <option value="em_analise">Em Análise</option>
                                <option value="respondida">Respondidas</option>
                                <option value="aceita">Aceitas</option>
                                <option value="recusada">Recusadas</option>
                            </select>
                            <select id="tipoFilter" onchange="filtrarCotacoes()" style="padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                                <option value="">Todos os tipos</option>
                                <option value="Auto">Auto</option>
                                <option value="Residencial">Residencial</option>
                                <option value="Vida">Vida</option>
                                <option value="Empresarial">Empresarial</option>
                                <option value="Saude">Saúde</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Tabela -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-list"></i> Cotações</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Tipo</th>
                                        <th>Descrição</th>
                                        <th>Data</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="cotacoesTable">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="loading"><i class="fas fa-spinner fa-spin"></i></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Responder Cotação -->
    <div class="modal" id="modalCotacao">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Responder Cotação</h2>
                <button class="modal-close" onclick="fecharModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cotacaoId">
                
                <div id="cotacaoDetalhes" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-100); border-radius: 8px;">
                    <!-- Detalhes da cotação -->
                </div>
                
                <div class="form-group">
                    <label for="valorEstimado">Valor Estimado (R$)</label>
                    <input type="number" id="valorEstimado" step="0.01" placeholder="Ex: 1500.00">
                </div>
                
                <div class="form-group">
                    <label for="observacoesResposta">Observações da Resposta</label>
                    <textarea id="observacoesResposta" rows="4" placeholder="Detalhes da cotação, condições, etc..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="novoStatus">Novo Status</label>
                    <select id="novoStatus">
                        <option value="em_analise">Em Análise</option>
                        <option value="respondida">Respondida</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarResposta()">
                    <i class="fas fa-paper-plane"></i> Enviar Resposta
                </button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29",
            measurementId: "G-C6E44WXLPW"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        const COLECOES = {
            cotacoes: 'cotacoes_cliente',
            usuarios: 'usuarios',
            notificacoes: 'notificacoes_sistema'
        };
        
        const ADMINS_AUTORIZADOS = [
            'patrick@retornoseguros.com.br',
            'admin@retornoseguros.com.br',
            'pchemis@gmail.com'
        ];
        
        let todasCotacoes = [];
        let usuariosCache = {};
        
        // Toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Toggle Sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        // Logout
        async function logout() {
            await auth.signOut();
            window.location.href = 'login.html';
        }
        
        // Verificar auth
        auth.onAuthStateChanged(async (user) => {
            if (!user || !ADMINS_AUTORIZADOS.includes(user.email.toLowerCase())) {
                window.location.href = 'login.html';
                return;
            }
            await carregarCotacoes();
        });
        
        // Carregar cotações
        async function carregarCotacoes() {
            try {
                const snapshot = await db.collection(COLECOES.cotacoes).orderBy('dataCotacao', 'desc').get();
                
                todasCotacoes = [];
                let pendentes = 0, analise = 0, respondidas = 0;
                
                for (const doc of snapshot.docs) {
                    const cotacao = { id: doc.id, ...doc.data() };
                    
                    // Buscar dados do usuário
                    if (cotacao.usuarioId && !usuariosCache[cotacao.usuarioId]) {
                        const userDoc = await db.collection(COLECOES.usuarios).doc(cotacao.usuarioId).get();
                        if (userDoc.exists) {
                            usuariosCache[cotacao.usuarioId] = userDoc.data();
                        }
                    }
                    
                    cotacao.usuario = usuariosCache[cotacao.usuarioId] || {};
                    todasCotacoes.push(cotacao);
                    
                    if (cotacao.status === 'pendente') pendentes++;
                    else if (cotacao.status === 'em_analise') analise++;
                    else if (cotacao.status === 'respondida') respondidas++;
                }
                
                document.getElementById('cotacoesPendentes').textContent = pendentes;
                document.getElementById('cotacoesAnalise').textContent = analise;
                document.getElementById('cotacoesRespondidas').textContent = respondidas;
                document.getElementById('cotacoesTotal').textContent = todasCotacoes.length;
                
                filtrarCotacoes();
                
            } catch (error) {
                console.error('Erro ao carregar cotações:', error);
                showToast('Erro ao carregar cotações', 'error');
            }
        }
        
        // Filtrar cotações
        function filtrarCotacoes() {
            const status = document.getElementById('statusFilter').value;
            const tipo = document.getElementById('tipoFilter').value;
            
            let filtradas = todasCotacoes.filter(c => {
                const matchStatus = !status || c.status === status;
                const matchTipo = !tipo || c.tipo === tipo;
                return matchStatus && matchTipo;
            });
            
            renderizarCotacoes(filtradas);
        }
        
        // Renderizar cotações
        function renderizarCotacoes(cotacoes) {
            const tbody = document.getElementById('cotacoesTable');
            
            if (cotacoes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-calculator"></i>
                                <p>Nenhuma cotação encontrada</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = cotacoes.map(cotacao => {
                const usuario = cotacao.usuario || {};
                const data = cotacao.dataCotacao?.toDate();
                const dataFormatada = data ? data.toLocaleDateString('pt-BR') : '-';
                
                const statusConfig = {
                    'pendente': { class: 'warning', text: 'Pendente' },
                    'em_analise': { class: 'info', text: 'Em Análise' },
                    'respondida': { class: 'success', text: 'Respondida' },
                    'aceita': { class: 'primary', text: 'Aceita' },
                    'recusada': { class: 'danger', text: 'Recusada' }
                };
                
                const status = statusConfig[cotacao.status] || statusConfig['pendente'];
                
                return `
                    <tr>
                        <td>
                            <strong>${usuario.nome || 'N/A'}</strong>
                            <small style="display: block; color: var(--gray-500);">${usuario.email || ''}</small>
                        </td>
                        <td>${cotacao.tipo || 'N/A'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${cotacao.descricao || '-'}
                        </td>
                        <td>${dataFormatada}</td>
                        <td><span class="badge badge-${status.class}">${status.text}</span></td>
                        <td class="actions">
                            <button class="btn-view" onclick="responderCotacao('${cotacao.id}')" title="Responder">
                                <i class="fas fa-reply"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Responder cotação
        function responderCotacao(id) {
            const cotacao = todasCotacoes.find(c => c.id === id);
            if (!cotacao) return;
            
            const usuario = cotacao.usuario || {};
            const data = cotacao.dataCotacao?.toDate();
            
            document.getElementById('cotacaoId').value = id;
            document.getElementById('cotacaoDetalhes').innerHTML = `
                <p><strong>Cliente:</strong> ${usuario.nome || 'N/A'}</p>
                <p><strong>E-mail:</strong> ${usuario.email || 'N/A'}</p>
                <p><strong>Telefone:</strong> ${usuario.telefone || 'N/A'}</p>
                <p><strong>Tipo:</strong> ${cotacao.tipo || 'N/A'}</p>
                <p><strong>Descrição:</strong> ${cotacao.descricao || 'N/A'}</p>
                <p><strong>Data:</strong> ${data ? data.toLocaleString('pt-BR') : 'N/A'}</p>
                ${cotacao.observacoes ? `<p><strong>Observações:</strong> ${cotacao.observacoes}</p>` : ''}
            `;
            
            document.getElementById('valorEstimado').value = cotacao.valorEstimado || '';
            document.getElementById('observacoesResposta').value = cotacao.observacoesResposta || '';
            document.getElementById('novoStatus').value = cotacao.status === 'pendente' ? 'em_analise' : 'respondida';
            
            document.getElementById('modalCotacao').classList.add('active');
        }
        
        // Fechar modal
        function fecharModal() {
            document.getElementById('modalCotacao').classList.remove('active');
        }
        
        // Salvar resposta
        async function salvarResposta() {
            const id = document.getElementById('cotacaoId').value;
            const valorEstimado = parseFloat(document.getElementById('valorEstimado').value) || 0;
            const observacoesResposta = document.getElementById('observacoesResposta').value.trim();
            const novoStatus = document.getElementById('novoStatus').value;
            
            try {
                const cotacao = todasCotacoes.find(c => c.id === id);
                
                await db.collection(COLECOES.cotacoes).doc(id).update({
                    valorEstimado,
                    observacoesResposta,
                    status: novoStatus,
                    respondidoPor: auth.currentUser.uid,
                    dataResposta: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Enviar notificação para o usuário
                if (cotacao && cotacao.usuarioId) {
                    await db.collection(COLECOES.notificacoes).add({
                        usuarioId: cotacao.usuarioId,
                        tipo: 'cotacao',
                        titulo: 'Cotação Atualizada!',
                        mensagem: `Sua cotação de ${cotacao.tipo} foi ${novoStatus === 'respondida' ? 'respondida' : 'atualizada'}`,
                        lida: false,
                        data: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showToast('Resposta enviada com sucesso!', 'success');
                fecharModal();
                await carregarCotacoes();
                
            } catch (error) {
                console.error('Erro ao salvar resposta:', error);
                showToast('Erro ao salvar resposta', 'error');
            }
        }
    </script>
</body>
</html>
