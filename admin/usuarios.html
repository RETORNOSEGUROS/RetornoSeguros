<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuários - Admin Retorno Seguros</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../img/logo-retorno.png" alt="Retorno Seguros" class="logo">
                <h2>Retorno<small>Painel Admin</small></h2>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">Principal</div>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                
                <div class="nav-section">Gestão</div>
                <a href="usuarios.html" class="nav-item active">
                    <i class="fas fa-users"></i>
                    <span>Usuários</span>
                </a>
                <a href="indicacoes.html" class="nav-item">
                    <i class="fas fa-user-plus"></i>
                    <span>Indicações</span>
                </a>
                <a href="apolices.html" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Apólices</span>
                </a>
                
                <div class="nav-section">Solicitações</div>
                <a href="cotacoes.html" class="nav-item">
                    <i class="fas fa-calculator"></i>
                    <span>Cotações</span>
                </a>
                <a href="resgates.html" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Resgates</span>
                </a>
                
                <div class="nav-section">Marketing</div>
                <a href="campanhas.html" class="nav-item">
                    <i class="fas fa-bullhorn"></i>
                    <span>Campanhas</span>
                </a>
                <a href="recompensas.html" class="nav-item">
                    <i class="fas fa-gift"></i>
                    <span>Recompensas</span>
                </a>
                
                <div class="nav-section">Sistema</div>
                <a href="configuracoes.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Usuários</h1>
                </div>
                <div class="top-bar-right">
                    <button class="btn btn-primary" onclick="exportarUsuarios()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </header>
            
            <!-- Content -->
            <div class="dashboard-content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="content">
                            <h3>Total de Usuários</h3>
                            <p class="value" id="totalUsuarios">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon success">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="content">
                            <h3>Clientes Ativos</h3>
                            <p class="value" id="clientesAtivos">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon info">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="content">
                            <h3>Total de Pontos</h3>
                            <p class="value" id="totalPontos">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div class="card">
                    <div class="card-body" style="padding: 1rem;">
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <div class="search-box" style="flex: 1; min-width: 200px;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchInput" placeholder="Buscar por nome, e-mail ou código..." onkeyup="filtrarUsuarios()">
                            </div>
                            <select id="statusFilter" onchange="filtrarUsuarios()" style="padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                                <option value="">Todos</option>
                                <option value="ativo">Ativos</option>
                                <option value="inativo">Inativos</option>
                                <option value="cliente">Clientes</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Tabela de Usuários -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-list"></i> Lista de Usuários</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Usuário</th>
                                        <th>Contato</th>
                                        <th>Código</th>
                                        <th>Pontos</th>
                                        <th>Indicações</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="usuariosTable">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="loading"><i class="fas fa-spinner fa-spin"></i></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Detalhes Usuário -->
    <div class="modal" id="modalUsuario">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Detalhes do Usuário</h2>
                <button class="modal-close" onclick="fecharModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalUsuarioBody">
                <!-- Conteúdo dinâmico -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal()">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Adicionar Pontos -->
    <div class="modal" id="modalPontos">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Adicionar Pontos</h2>
                <button class="modal-close" onclick="fecharModalPontos()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pontosUsuarioId">
                <p id="pontosUsuarioNome" style="margin-bottom: 1rem; font-weight: 500;"></p>
                
                <div class="form-group">
                    <label for="pontosQuantidade">Quantidade de Pontos</label>
                    <input type="number" id="pontosQuantidade" min="1" placeholder="Ex: 100">
                </div>
                
                <div class="form-group">
                    <label for="pontosMotivo">Motivo</label>
                    <input type="text" id="pontosMotivo" placeholder="Ex: Bônus campanha de verão">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModalPontos()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmarAdicionarPontos()">
                    <i class="fas fa-plus"></i> Adicionar
                </button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29",
            measurementId: "G-C6E44WXLPW"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        const ADMINS_AUTORIZADOS = [
            'patrick@retornoseguros.com.br',
            'admin@retornoseguros.com.br',
            'pchemis@gmail.com'
        ];
        
        let todosUsuarios = [];
        
        // Toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Toggle Sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        // Logout
        async function logout() {
            await auth.signOut();
            window.location.href = 'login.html';
        }
        
        // Verificar auth
        auth.onAuthStateChanged(async (user) => {
            if (!user || !ADMINS_AUTORIZADOS.includes(user.email.toLowerCase())) {
                window.location.href = 'login.html';
                return;
            }
            await carregarUsuarios();
        });
        
        // Carregar usuários
        async function carregarUsuarios() {
            try {
                const snapshot = await db.collection('usuarios').orderBy('dataCadastro', 'desc').get();
                
                todosUsuarios = [];
                let totalPontos = 0;
                let clientesAtivos = 0;
                
                snapshot.forEach(doc => {
                    const usuario = { id: doc.id, ...doc.data() };
                    todosUsuarios.push(usuario);
                    totalPontos += usuario.pontosTotais || 0;
                    if (usuario.isCliente) clientesAtivos++;
                });
                
                document.getElementById('totalUsuarios').textContent = todosUsuarios.length;
                document.getElementById('clientesAtivos').textContent = clientesAtivos;
                document.getElementById('totalPontos').textContent = totalPontos.toLocaleString('pt-BR');
                
                renderizarUsuarios(todosUsuarios);
                
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                showToast('Erro ao carregar usuários', 'error');
            }
        }
        
        // Renderizar usuários
        function renderizarUsuarios(usuarios) {
            const tbody = document.getElementById('usuariosTable');
            
            if (usuarios.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <p>Nenhum usuário encontrado</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = usuarios.map(usuario => {
                const statusBadge = usuario.ativo !== false 
                    ? '<span class="badge badge-success">Ativo</span>'
                    : '<span class="badge badge-danger">Inativo</span>';
                
                const clienteBadge = usuario.isCliente 
                    ? '<span class="badge badge-primary" style="margin-left: 4px;">Cliente</span>'
                    : '';
                
                const dataCadastro = usuario.dataCadastro?.toDate();
                const dataFormatada = dataCadastro ? dataCadastro.toLocaleDateString('pt-BR') : '-';
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(usuario.nome || 'U')}&background=0066cc&color=fff&size=40" 
                                     alt="Avatar" style="border-radius: 50%; width: 40px; height: 40px;">
                                <div>
                                    <strong>${usuario.nome || 'N/A'}</strong>
                                    <small style="display: block; color: var(--gray-500);">${dataFormatada}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <small style="display: block;">${usuario.email || 'N/A'}</small>
                            <small style="color: var(--gray-500);">${usuario.telefone || ''}</small>
                        </td>
                        <td><code style="background: var(--gray-100); padding: 2px 6px; border-radius: 4px;">${usuario.codigoIndicacao || '-'}</code></td>
                        <td><strong style="color: var(--primary);">${usuario.pontosTotais || 0}</strong></td>
                        <td>${usuario.totalIndicacoes || 0}</td>
                        <td>${statusBadge}${clienteBadge}</td>
                        <td class="actions">
                            <button class="btn-view" onclick="verUsuario('${usuario.id}')" title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-edit" onclick="adicionarPontos('${usuario.id}', '${usuario.nome}')" title="Adicionar pontos">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn-delete" onclick="toggleStatus('${usuario.id}', ${usuario.ativo !== false})" title="${usuario.ativo !== false ? 'Desativar' : 'Ativar'}">
                                <i class="fas fa-${usuario.ativo !== false ? 'ban' : 'check'}"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Filtrar usuários
        function filtrarUsuarios() {
            const busca = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            
            let filtrados = todosUsuarios.filter(usuario => {
                const matchBusca = !busca || 
                    (usuario.nome || '').toLowerCase().includes(busca) ||
                    (usuario.email || '').toLowerCase().includes(busca) ||
                    (usuario.codigoIndicacao || '').toLowerCase().includes(busca);
                
                let matchStatus = true;
                if (status === 'ativo') matchStatus = usuario.ativo !== false;
                if (status === 'inativo') matchStatus = usuario.ativo === false;
                if (status === 'cliente') matchStatus = usuario.isCliente === true;
                
                return matchBusca && matchStatus;
            });
            
            renderizarUsuarios(filtrados);
        }
        
        // Ver detalhes do usuário
        async function verUsuario(id) {
            const usuario = todosUsuarios.find(u => u.id === id);
            if (!usuario) return;
            
            const dataCadastro = usuario.dataCadastro?.toDate();
            
            document.getElementById('modalUsuarioBody').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                    <div>
                        <h4 style="color: var(--gray-500); font-size: 0.85rem; margin-bottom: 0.5rem;">INFORMAÇÕES PESSOAIS</h4>
                        <p><strong>Nome:</strong> ${usuario.nome || 'N/A'}</p>
                        <p><strong>E-mail:</strong> ${usuario.email || 'N/A'}</p>
                        <p><strong>Telefone:</strong> ${usuario.telefone || 'N/A'}</p>
                        <p><strong>Cidade:</strong> ${usuario.cidade || 'N/A'}</p>
                        <p><strong>Cadastro:</strong> ${dataCadastro ? dataCadastro.toLocaleString('pt-BR') : 'N/A'}</p>
                    </div>
                    <div>
                        <h4 style="color: var(--gray-500); font-size: 0.85rem; margin-bottom: 0.5rem;">GAMIFICAÇÃO</h4>
                        <p><strong>Código de Indicação:</strong> <code>${usuario.codigoIndicacao || 'N/A'}</code></p>
                        <p><strong>Pontos Totais:</strong> ${usuario.pontosTotais || 0}</p>
                        <p><strong>Pontos Resgatáveis:</strong> ${usuario.pontosResgataveis || 0}</p>
                        <p><strong>Pontos Resgatados:</strong> ${usuario.pontosResgatados || 0}</p>
                        <p><strong>Total Indicações:</strong> ${usuario.totalIndicacoes || 0}</p>
                        <p><strong>Indicações Convertidas:</strong> ${usuario.indicacoesConvertidas || 0}</p>
                    </div>
                </div>
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="adicionarPontos('${usuario.id}', '${usuario.nome}'); fecharModal();">
                        <i class="fas fa-plus"></i> Adicionar Pontos
                    </button>
                    <button class="btn btn-${usuario.isCliente ? 'secondary' : 'primary'}" onclick="toggleCliente('${usuario.id}', ${usuario.isCliente || false})">
                        <i class="fas fa-${usuario.isCliente ? 'times' : 'check'}"></i> ${usuario.isCliente ? 'Remover Cliente' : 'Marcar como Cliente'}
                    </button>
                </div>
            `;
            
            document.getElementById('modalUsuario').classList.add('active');
        }
        
        // Fechar modal
        function fecharModal() {
            document.getElementById('modalUsuario').classList.remove('active');
        }
        
        // Adicionar pontos - abrir modal
        function adicionarPontos(id, nome) {
            document.getElementById('pontosUsuarioId').value = id;
            document.getElementById('pontosUsuarioNome').textContent = `Adicionar pontos para: ${nome}`;
            document.getElementById('pontosQuantidade').value = '';
            document.getElementById('pontosMotivo').value = '';
            document.getElementById('modalPontos').classList.add('active');
        }
        
        function fecharModalPontos() {
            document.getElementById('modalPontos').classList.remove('active');
        }
        
        // Confirmar adicionar pontos
        async function confirmarAdicionarPontos() {
            const id = document.getElementById('pontosUsuarioId').value;
            const quantidade = parseInt(document.getElementById('pontosQuantidade').value);
            const motivo = document.getElementById('pontosMotivo').value.trim();
            
            if (!quantidade || quantidade < 1) {
                showToast('Informe uma quantidade válida', 'error');
                return;
            }
            
            try {
                await db.collection('usuarios').doc(id).update({
                    pontosTotais: firebase.firestore.FieldValue.increment(quantidade),
                    pontosResgataveis: firebase.firestore.FieldValue.increment(quantidade)
                });
                
                // Registrar no histórico
                await db.collection('historico_pontos').add({
                    usuarioId: id,
                    pontos: quantidade,
                    tipo: 'bonus',
                    descricao: motivo || 'Pontos adicionados pelo administrador',
                    data: firebase.firestore.FieldValue.serverTimestamp(),
                    adicionadoPor: auth.currentUser.uid
                });
                
                showToast(`${quantidade} pontos adicionados com sucesso!`, 'success');
                fecharModalPontos();
                await carregarUsuarios();
                
            } catch (error) {
                console.error('Erro ao adicionar pontos:', error);
                showToast('Erro ao adicionar pontos', 'error');
            }
        }
        
        // Toggle status
        async function toggleStatus(id, atualmenteAtivo) {
            const acao = atualmenteAtivo ? 'desativar' : 'ativar';
            if (!confirm(`Deseja ${acao} este usuário?`)) return;
            
            try {
                await db.collection('usuarios').doc(id).update({
                    ativo: !atualmenteAtivo
                });
                
                showToast(`Usuário ${atualmenteAtivo ? 'desativado' : 'ativado'} com sucesso!`, 'success');
                await carregarUsuarios();
                
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                showToast('Erro ao alterar status', 'error');
            }
        }
        
        // Toggle cliente
        async function toggleCliente(id, atualmenteCliente) {
            try {
                await db.collection('usuarios').doc(id).update({
                    isCliente: !atualmenteCliente
                });
                
                showToast(`Usuário ${atualmenteCliente ? 'removido de' : 'marcado como'} cliente!`, 'success');
                fecharModal();
                await carregarUsuarios();
                
            } catch (error) {
                console.error('Erro ao alterar status de cliente:', error);
                showToast('Erro ao alterar status', 'error');
            }
        }
        
        // Exportar usuários
        function exportarUsuarios() {
            const csv = [
                ['Nome', 'E-mail', 'Telefone', 'Cidade', 'Código', 'Pontos', 'Indicações', 'Cliente', 'Ativo'].join(','),
                ...todosUsuarios.map(u => [
                    `"${u.nome || ''}"`,
                    u.email || '',
                    u.telefone || '',
                    `"${u.cidade || ''}"`,
                    u.codigoIndicacao || '',
                    u.pontosTotais || 0,
                    u.totalIndicacoes || 0,
                    u.isCliente ? 'Sim' : 'Não',
                    u.ativo !== false ? 'Sim' : 'Não'
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `usuarios_retorno_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Exportação concluída!', 'success');
        }
    </script>
</body>
</html>
