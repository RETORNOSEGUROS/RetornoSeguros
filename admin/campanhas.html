<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campanhas - Admin Retorno Seguros</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../img/logo-retorno.png" alt="Retorno Seguros" class="logo">
                <h2>Retorno<small>Painel Admin</small></h2>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">Principal</div>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                
                <div class="nav-section">Gestão</div>
                <a href="usuarios.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Usuários</span>
                </a>
                <a href="indicacoes.html" class="nav-item">
                    <i class="fas fa-user-plus"></i>
                    <span>Indicações</span>
                </a>
                <a href="apolices.html" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Apólices</span>
                </a>
                
                <div class="nav-section">Solicitações</div>
                <a href="cotacoes.html" class="nav-item">
                    <i class="fas fa-calculator"></i>
                    <span>Cotações</span>
                </a>
                <a href="resgates.html" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Resgates</span>
                </a>
                
                <div class="nav-section">Marketing</div>
                <a href="campanhas.html" class="nav-item active">
                    <i class="fas fa-bullhorn"></i>
                    <span>Campanhas</span>
                </a>
                <a href="recompensas.html" class="nav-item">
                    <i class="fas fa-gift"></i>
                    <span>Recompensas</span>
                </a>
                
                <div class="nav-section">Sistema</div>
                <a href="configuracoes.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Campanhas</h1>
                </div>
                <div class="top-bar-right">
                    <button class="btn btn-primary" onclick="abrirModalNovaCampanha()">
                        <i class="fas fa-plus"></i> Nova Campanha
                    </button>
                </div>
            </header>
            
            <!-- Content -->
            <div class="dashboard-content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon success">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                        <div class="content">
                            <h3>Campanhas Ativas</h3>
                            <p class="value" id="campanhasAtivas">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon info">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="content">
                            <h3>Total de Campanhas</h3>
                            <p class="value" id="totalCampanhas">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Campanhas Ativas -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-fire"></i> Campanhas Ativas</h2>
                    </div>
                    <div class="card-body">
                        <div id="campanhasAtivasList" class="campanhas-grid">
                            <div class="loading"><i class="fas fa-spinner fa-spin"></i></div>
                        </div>
                    </div>
                </div>
                
                <!-- Todas as Campanhas -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-list"></i> Todas as Campanhas</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Título</th>
                                        <th>Período</th>
                                        <th>Pontos Bônus</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="campanhasTable">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="loading"><i class="fas fa-spinner fa-spin"></i></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Nova Campanha -->
    <div class="modal" id="modalCampanha">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="modalTitulo">Nova Campanha</h2>
                <button class="modal-close" onclick="fecharModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="campanhaForm">
                    <input type="hidden" id="campanhaId">
                    
                    <div class="form-group">
                        <label for="titulo">Título da Campanha *</label>
                        <input type="text" id="titulo" placeholder="Ex: Campanha de Verão" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="descricao">Descrição *</label>
                        <textarea id="descricao" placeholder="Descreva a campanha e suas regras..." required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dataInicio">Data Início *</label>
                            <input type="date" id="dataInicio" required>
                        </div>
                        <div class="form-group">
                            <label for="dataFim">Data Fim *</label>
                            <input type="date" id="dataFim" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pontosBonus">Pontos Bônus</label>
                            <input type="number" id="pontosBonus" placeholder="Ex: 100" min="0">
                        </div>
                        <div class="form-group">
                            <label for="meta">Meta (indicações)</label>
                            <input type="number" id="meta" placeholder="Ex: 5" min="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo">Tipo de Campanha</label>
                        <select id="tipo">
                            <option value="indicacao">Indicação</option>
                            <option value="apolice">Apólice</option>
                            <option value="renovacao">Renovação</option>
                            <option value="especial">Especial</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="ativo" checked>
                            Campanha ativa
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarCampanha()">
                    <i class="fas fa-save"></i> Salvar Campanha
                </button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <style>
        .campanhas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .campanha-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .campanha-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: rotate(45deg);
        }
        
        .campanha-card h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        
        .campanha-card p {
            opacity: 0.9;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .campanha-card .meta {
            display: flex;
            justify-content: space-between;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.85rem;
        }
        
        .campanha-card .meta strong {
            display: block;
            font-size: 1.25rem;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29",
            measurementId: "G-C6E44WXLPW"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        const ADMINS_AUTORIZADOS = [
            'patrick@retornoseguros.com.br',
            'admin@retornoseguros.com.br',
            'pchemis@gmail.com'
        ];
        
        // Toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Toggle Sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        // Logout
        async function logout() {
            await auth.signOut();
            window.location.href = 'login.html';
        }
        
        // Verificar auth
        auth.onAuthStateChanged(async (user) => {
            if (!user || !ADMINS_AUTORIZADOS.includes(user.email.toLowerCase())) {
                window.location.href = 'login.html';
                return;
            }
            await carregarCampanhas();
        });
        
        // Carregar campanhas
        async function carregarCampanhas() {
            try {
                const snapshot = await db.collection('campanhas').orderBy('dataFim', 'desc').get();
                
                document.getElementById('totalCampanhas').textContent = snapshot.size;
                
                const hoje = new Date();
                let ativas = 0;
                let campanhasAtivasHTML = '';
                let tabelaHTML = '';
                
                snapshot.forEach(doc => {
                    const campanha = doc.data();
                    const dataFim = campanha.dataFim?.toDate();
                    const dataInicio = campanha.dataInicio?.toDate();
                    
                    const isAtiva = campanha.ativo && dataFim && dataFim >= hoje;
                    
                    if (isAtiva) {
                        ativas++;
                        campanhasAtivasHTML += `
                            <div class="campanha-card">
                                <h3>${campanha.titulo}</h3>
                                <p>${campanha.descricao || ''}</p>
                                <div class="meta">
                                    <div>
                                        <strong>${campanha.pontosBonus || 0}</strong>
                                        Pontos Bônus
                                    </div>
                                    <div>
                                        <strong>${dataFim ? dataFim.toLocaleDateString('pt-BR') : '-'}</strong>
                                        Termina em
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    const statusBadge = isAtiva 
                        ? '<span class="badge badge-success">Ativa</span>'
                        : '<span class="badge badge-danger">Encerrada</span>';
                    
                    const periodo = `${dataInicio ? dataInicio.toLocaleDateString('pt-BR') : '-'} até ${dataFim ? dataFim.toLocaleDateString('pt-BR') : '-'}`;
                    
                    tabelaHTML += `
                        <tr>
                            <td><strong>${campanha.titulo}</strong></td>
                            <td>${periodo}</td>
                            <td>${campanha.pontosBonus || 0} pts</td>
                            <td>${statusBadge}</td>
                            <td class="actions">
                                <button class="btn-view" onclick="editarCampanha('${doc.id}')" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-delete" onclick="excluirCampanha('${doc.id}')" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('campanhasAtivas').textContent = ativas;
                
                document.getElementById('campanhasAtivasList').innerHTML = campanhasAtivasHTML || `
                    <div class="empty-state">
                        <i class="fas fa-bullhorn"></i>
                        <p>Nenhuma campanha ativa no momento</p>
                        <button class="btn btn-primary" onclick="abrirModalNovaCampanha()">
                            <i class="fas fa-plus"></i> Criar Campanha
                        </button>
                    </div>
                `;
                
                document.getElementById('campanhasTable').innerHTML = tabelaHTML || `
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="empty-state">
                                <p>Nenhuma campanha encontrada</p>
                            </div>
                        </td>
                    </tr>
                `;
                
            } catch (error) {
                console.error('Erro ao carregar campanhas:', error);
                showToast('Erro ao carregar campanhas', 'error');
            }
        }
        
        // Abrir modal nova campanha
        function abrirModalNovaCampanha() {
            document.getElementById('modalTitulo').textContent = 'Nova Campanha';
            document.getElementById('campanhaForm').reset();
            document.getElementById('campanhaId').value = '';
            document.getElementById('ativo').checked = true;
            
            // Definir data início como hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataInicio').value = hoje;
            
            // Definir data fim como 30 dias
            const fim = new Date();
            fim.setDate(fim.getDate() + 30);
            document.getElementById('dataFim').value = fim.toISOString().split('T')[0];
            
            document.getElementById('modalCampanha').classList.add('active');
        }
        
        // Fechar modal
        function fecharModal() {
            document.getElementById('modalCampanha').classList.remove('active');
        }
        
        // Salvar campanha
        async function salvarCampanha() {
            const id = document.getElementById('campanhaId').value;
            const titulo = document.getElementById('titulo').value.trim();
            const descricao = document.getElementById('descricao').value.trim();
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const pontosBonus = parseInt(document.getElementById('pontosBonus').value) || 0;
            const meta = parseInt(document.getElementById('meta').value) || 0;
            const tipo = document.getElementById('tipo').value;
            const ativo = document.getElementById('ativo').checked;
            
            if (!titulo || !descricao || !dataInicio || !dataFim) {
                showToast('Preencha todos os campos obrigatórios', 'error');
                return;
            }
            
            try {
                const dados = {
                    titulo,
                    descricao,
                    dataInicio: firebase.firestore.Timestamp.fromDate(new Date(dataInicio)),
                    dataFim: firebase.firestore.Timestamp.fromDate(new Date(dataFim + 'T23:59:59')),
                    pontosBonus,
                    meta,
                    tipo,
                    ativo,
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (id) {
                    await db.collection('campanhas').doc(id).update(dados);
                    showToast('Campanha atualizada com sucesso!', 'success');
                } else {
                    dados.criadoEm = firebase.firestore.FieldValue.serverTimestamp();
                    dados.criadoPor = auth.currentUser.uid;
                    await db.collection('campanhas').add(dados);
                    showToast('Campanha criada com sucesso!', 'success');
                }
                
                fecharModal();
                await carregarCampanhas();
                
            } catch (error) {
                console.error('Erro ao salvar campanha:', error);
                showToast('Erro ao salvar campanha', 'error');
            }
        }
        
        // Editar campanha
        async function editarCampanha(id) {
            try {
                const doc = await db.collection('campanhas').doc(id).get();
                if (!doc.exists) {
                    showToast('Campanha não encontrada', 'error');
                    return;
                }
                
                const campanha = doc.data();
                
                document.getElementById('modalTitulo').textContent = 'Editar Campanha';
                document.getElementById('campanhaId').value = id;
                document.getElementById('titulo').value = campanha.titulo || '';
                document.getElementById('descricao').value = campanha.descricao || '';
                document.getElementById('pontosBonus').value = campanha.pontosBonus || 0;
                document.getElementById('meta').value = campanha.meta || 0;
                document.getElementById('tipo').value = campanha.tipo || 'indicacao';
                document.getElementById('ativo').checked = campanha.ativo !== false;
                
                if (campanha.dataInicio) {
                    document.getElementById('dataInicio').value = campanha.dataInicio.toDate().toISOString().split('T')[0];
                }
                if (campanha.dataFim) {
                    document.getElementById('dataFim').value = campanha.dataFim.toDate().toISOString().split('T')[0];
                }
                
                document.getElementById('modalCampanha').classList.add('active');
                
            } catch (error) {
                console.error('Erro ao carregar campanha:', error);
                showToast('Erro ao carregar campanha', 'error');
            }
        }
        
        // Excluir campanha
        async function excluirCampanha(id) {
            if (!confirm('Tem certeza que deseja excluir esta campanha?')) return;
            
            try {
                await db.collection('campanhas').doc(id).delete();
                showToast('Campanha excluída com sucesso!', 'success');
                await carregarCampanhas();
            } catch (error) {
                console.error('Erro ao excluir campanha:', error);
                showToast('Erro ao excluir campanha', 'error');
            }
        }
        
        // Verificar parâmetro de URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('action') === 'new') {
            setTimeout(abrirModalNovaCampanha, 500);
        }
    </script>
</body>
</html>
