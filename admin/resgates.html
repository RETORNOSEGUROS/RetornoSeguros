<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resgates - Admin Retorno Seguros</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../img/logo-retorno.png" alt="Retorno Seguros" class="logo">
                <h2>Retorno<small>Painel Admin</small></h2>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">Principal</div>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                
                <div class="nav-section">Gestão</div>
                <a href="usuarios.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Usuários</span>
                </a>
                <a href="indicacoes.html" class="nav-item">
                    <i class="fas fa-user-plus"></i>
                    <span>Indicações</span>
                </a>
                <a href="apolices.html" class="nav-item">
                    <i class="fas fa-file-contract"></i>
                    <span>Apólices</span>
                </a>
                
                <div class="nav-section">Solicitações</div>
                <a href="cotacoes.html" class="nav-item">
                    <i class="fas fa-calculator"></i>
                    <span>Cotações</span>
                </a>
                <a href="resgates.html" class="nav-item active">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Resgates</span>
                </a>
                
                <div class="nav-section">Marketing</div>
                <a href="campanhas.html" class="nav-item">
                    <i class="fas fa-bullhorn"></i>
                    <span>Campanhas</span>
                </a>
                <a href="recompensas.html" class="nav-item">
                    <i class="fas fa-gift"></i>
                    <span>Recompensas</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Resgates de Pontos</h1>
                </div>
            </header>
            
            <div class="dashboard-content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="content">
                            <h3>Pendentes</h3>
                            <p class="value" id="resgatesPendentes">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="content">
                            <h3>Aprovados</h3>
                            <p class="value" id="resgatesAprovados">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon primary">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="content">
                            <h3>Pontos Resgatados</h3>
                            <p class="value" id="pontosResgatados">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div class="card">
                    <div class="card-body" style="padding: 1rem;">
                        <select id="statusFilter" onchange="filtrarResgates()" style="padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            <option value="">Todos</option>
                            <option value="pendente" selected>Pendentes</option>
                            <option value="aprovado">Aprovados</option>
                            <option value="concluido">Concluídos</option>
                            <option value="rejeitado">Rejeitados</option>
                        </select>
                    </div>
                </div>
                
                <!-- Tabela -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-list"></i> Solicitações de Resgate</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Usuário</th>
                                        <th>Pontos</th>
                                        <th>Tipo</th>
                                        <th>Valor R$</th>
                                        <th>Data</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="resgatesTable">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="loading"><i class="fas fa-spinner fa-spin"></i></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDlbEZfA_uAR1aoPZIr8T9B6KNcrwfMxm0",
            authDomain: "retorno-seguros.firebaseapp.com",
            projectId: "retorno-seguros",
            storageBucket: "retorno-seguros.firebasestorage.app",
            messagingSenderId: "495712392972",
            appId: "1:495712392972:web:e1e78aedc48bdeea48db29"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        const ADMINS_AUTORIZADOS = ['patrick@retornoseguros.com.br', 'admin@retornoseguros.com.br', 'pchemis@gmail.com'];
        
        let todosResgates = [];
        let usuariosCache = {};
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        async function logout() {
            await auth.signOut();
            window.location.href = 'login.html';
        }
        
        auth.onAuthStateChanged(async (user) => {
            if (!user || !ADMINS_AUTORIZADOS.includes(user.email.toLowerCase())) {
                window.location.href = 'login.html';
                return;
            }
            await carregarResgates();
        });
        
        async function carregarResgates() {
            try {
                const snapshot = await db.collection('resgates').orderBy('dataResgate', 'desc').get();
                
                todosResgates = [];
                let pendentes = 0, aprovados = 0, pontosTotal = 0;
                
                for (const doc of snapshot.docs) {
                    const resgate = { id: doc.id, ...doc.data() };
                    
                    if (resgate.usuarioId && !usuariosCache[resgate.usuarioId]) {
                        const userDoc = await db.collection('usuarios').doc(resgate.usuarioId).get();
                        if (userDoc.exists) usuariosCache[resgate.usuarioId] = userDoc.data();
                    }
                    
                    resgate.usuario = usuariosCache[resgate.usuarioId] || {};
                    todosResgates.push(resgate);
                    
                    if (resgate.status === 'pendente') pendentes++;
                    else if (resgate.status === 'aprovado' || resgate.status === 'concluido') {
                        aprovados++;
                        pontosTotal += resgate.pontos || 0;
                    }
                }
                
                document.getElementById('resgatesPendentes').textContent = pendentes;
                document.getElementById('resgatesAprovados').textContent = aprovados;
                document.getElementById('pontosResgatados').textContent = pontosTotal.toLocaleString('pt-BR');
                
                filtrarResgates();
                
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao carregar resgates', 'error');
            }
        }
        
        function filtrarResgates() {
            const status = document.getElementById('statusFilter').value;
            let filtrados = todosResgates.filter(r => !status || r.status === status);
            renderizarResgates(filtrados);
        }
        
        function renderizarResgates(resgates) {
            const tbody = document.getElementById('resgatesTable');
            
            if (resgates.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center"><div class="empty-state"><i class="fas fa-money-bill-wave"></i><p>Nenhum resgate encontrado</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = resgates.map(resgate => {
                const usuario = resgate.usuario || {};
                const data = resgate.dataResgate?.toDate();
                const dataFormatada = data ? data.toLocaleDateString('pt-BR') : '-';
                
                const statusConfig = {
                    'pendente': { class: 'warning', text: 'Pendente' },
                    'aprovado': { class: 'success', text: 'Aprovado' },
                    'concluido': { class: 'primary', text: 'Concluído' },
                    'rejeitado': { class: 'danger', text: 'Rejeitado' }
                };
                const status = statusConfig[resgate.status] || statusConfig['pendente'];
                
                const acoesPendente = resgate.status === 'pendente' ? `
                    <button class="btn-view" onclick="aprovarResgate('${resgate.id}')" title="Aprovar" style="background: rgba(40,167,69,0.1); color: var(--success);">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn-delete" onclick="rejeitarResgate('${resgate.id}')" title="Rejeitar">
                        <i class="fas fa-times"></i>
                    </button>
                ` : (resgate.status === 'aprovado' ? `
                    <button class="btn-view" onclick="concluirResgate('${resgate.id}')" title="Marcar como Concluído" style="background: rgba(0,102,204,0.1); color: var(--primary);">
                        <i class="fas fa-check-double"></i>
                    </button>
                ` : '-');
                
                return `
                    <tr>
                        <td>
                            <strong>${usuario.nome || 'N/A'}</strong>
                            <small style="display: block; color: var(--gray-500);">${usuario.email || ''}</small>
                        </td>
                        <td><strong style="color: var(--primary);">${resgate.pontos || 0}</strong></td>
                        <td>${resgate.tipo || 'N/A'}</td>
                        <td>R$ ${(resgate.valorReais || 0).toFixed(2)}</td>
                        <td>${dataFormatada}</td>
                        <td><span class="badge badge-${status.class}">${status.text}</span></td>
                        <td class="actions">${acoesPendente}</td>
                    </tr>
                `;
            }).join('');
        }
        
        async function aprovarResgate(id) {
            if (!confirm('Aprovar este resgate?')) return;
            
            try {
                await db.collection('resgates').doc(id).update({
                    status: 'aprovado',
                    dataAprovacao: firebase.firestore.FieldValue.serverTimestamp(),
                    aprovadoPor: auth.currentUser.uid
                });
                
                showToast('Resgate aprovado!', 'success');
                await carregarResgates();
            } catch (error) {
                showToast('Erro ao aprovar', 'error');
            }
        }
        
        async function rejeitarResgate(id) {
            const motivo = prompt('Motivo da rejeição:');
            if (motivo === null) return;
            
            try {
                const resgateDoc = await db.collection('resgates').doc(id).get();
                const resgate = resgateDoc.data();
                
                // Devolver pontos
                if (resgate.usuarioId && resgate.pontos) {
                    await db.collection('usuarios').doc(resgate.usuarioId).update({
                        pontosResgataveis: firebase.firestore.FieldValue.increment(resgate.pontos)
                    });
                }
                
                await db.collection('resgates').doc(id).update({
                    status: 'rejeitado',
                    motivoRejeicao: motivo,
                    dataRejeicao: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Resgate rejeitado e pontos devolvidos', 'success');
                await carregarResgates();
            } catch (error) {
                showToast('Erro ao rejeitar', 'error');
            }
        }
        
        async function concluirResgate(id) {
            if (!confirm('Marcar como concluído?')) return;
            
            try {
                await db.collection('resgates').doc(id).update({
                    status: 'concluido',
                    dataConclusao: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Resgate concluído!', 'success');
                await carregarResgates();
            } catch (error) {
                showToast('Erro ao concluir', 'error');
            }
        }
    </script>
</body>
</html>
